/*XXXXXXXXXXXXXXXXXXXXX*/
/* [dbo].[fw_Drugs] */
Create View [dbo].[fw_Drugs] As
Select D.DrugNo As DrugId, D.DrugName, IsNull(D.DeliveryMethod,'') As DeliveryMethod, IsNull(D.Units,'') As Units , D.DefaultDose, D.DoseIncrement, D.IsReversingAgent From ERS_DrugList D 
GO













/* [dbo].[fw_FailuresERCP] */

Create View [dbo].[fw_FailuresERCP] As Select 'U.2.'+Convert(varchar(10),E.[Episode no])+'.'+Convert(varchar(10),Convert(Int,SubString(E.[Patient No],7,6)))+'.'+Convert(VARCHAR(10),T.[Site No]) As SiteId ,Convert(bit,Case [Procs Papill/sphincterotomy] When -1 Then Case [Papillotomy] When -1 Then 'FALSE' Else Case [Pan Orifice Sphincterotomy] When -1 Then 'FALSE' Else 'TRUE' End End Else 'FALSE' End) | Convert(bit,Case [Procs Stent removal] When -1 Then Case [Stent Removal] When -1 Then 'FALSE' Else 'TRUE' End Else 'FALSE' End) | Convert(bit,Case [Procs Stent insertion] When -1 Then Case [Stent Insertion] When -1 Then Case IsNull([Correct stent placement],1) When 1 Then 'FALSE' Else 'TRUE' End Else 'TRUE' End Else 'FALSE' End) | Convert(bit,Case [Procs stent replacement] When -1 Then Case [Stent insertion] When -1 Then Case [Correct Stent placement] When 1 Then 'FALSE' Else 'TRUE' End Else 'FALSE' End Else 'FALSE' End) | Convert(bit,Case [Procs naso drains] When -1 Then Case [Nasopancreatic Drain] When -1 Then 'FALSE' Else 'TRUE' End Else 'FALSE' End) | Convert(bit,Case [Procs cyst puncture] When -1 Then Case [Endoscopic Cyst Puncture] When -1 Then 'FALSE' Else 'TRUE' End Else 'FALSE' End) | Convert(bit,Case [Procs rendezvous] When -1 Then Case [Rendezvous procedure] When -1 Then 'FALSE' Else 'TRUE' End Else 'FALSE' End) | Convert(bit,Case [Procs stricture dilatation] When -1 Then Case [Correct stent placement] When 2 Then 'TRUE' Else 'FALSE' End Else 'FALSE' End) | Convert(bit,Case [Procs stone removal] When -1 Then Case [Stone removal] When -1 Then Case [Extraction outcome] When 1 Then 'FALSE' When 2 Then 'FALSE' When 3 Then 'TRUE' When 4 Then 'TRUE' Else Case [Balloon Trawl] When -1 Then 'FALSE' Else Case [Balloon Dilation] When -1 Then 'FALSE' Else 'TRUE' End End End Else 'FALSE' End Else 'FALSE' End) As [Fails], Case IsNull(I.[Image obstruction CBD],0) When -1 Then Case IsNull([Stent decompressed],0) When 1 Then 'TRUE' Else 'FALSE' End Else Case IsNull(I.[Clin obstruction cbd],0) When -1 Then 'TRUE' Else 'FALSE' End End As [DecompSuccess], Case IsNull(I.[Image obstruction CBD],0) When -1 Then Case IsNull([Stent decompressed],0) When 2 Then 'TRUE' Else 'FALSE' End Else Case IsNull(I.[Clin obstruction cbd],0) When -1 Then 'TRUE' Else 'FALSE' End End As [DecompUnsuccess], Case IsNull(I.[Image obstruction CBD],0) When -1 Then Case IsNull([Stent decompressed],0) When 1 Then 'FALSE' When 2 Then 'FALSE' Else 'FALSE' End Else Case IsNull(I.[Clin obstruction cbd],0) When -1 Then 'TRUE' Else 'FALSE' End End As [DecompUnknow], Case IsNull(I.[Image obstruction CBD],0) When -1 Then 'TRUE' Else 'FALSE' End As [Decomp], Case [Procs stricture dilatation] When -1 Then 1 Else 0 End As [DecompressionDuctsProcedures], Convert(bit,Case [Procs stricture dilatation] When -1 Then Case [Correct stent placement] When 2 Then 'TRUE' Else 'FALSE' End Else 'FALSE' End) As [StrictureDilatationFails] From [dbo].[ERCP Procedure] PR , [dbo].[Patient] P , [dbo].[Episode] E , [dbo].[ERCP Indications] I , [dbo].[ERCP Therapeutic] T Where P.[Patient No]=convert(int,SubString(PR.[Patient No],7,6)) And E.[Patient No]=PR.[Patient No] And E.[Episode No]=PR.[Episode No] And E.[Patient No]=I.[Patient No] And E.[Episode No]=I.[Episode No] And E.[Patient No]=T.[Patient No] And E.[Episode No]=T.[Episode No] 

GO

/* [dbo].[fw_TherapeuticERCP] */

Create View [dbo].[fw_IndicationsERCP] As
Select
	'U.'+Convert(varchar(3),Case CHARINDEX('1', SUBSTRING(E.[Status], 1, 10)) When '1' Then 1 When '2' Then 2 When '5' Then 6 When '6' Then 7 Else Case IsNull((Select TOP 1 Convert(varchar(1),X.[Procedure type]+3) From [Colon Procedure] X Where X.[Episode No]=E.[Episode No] And X.[Procedure date] Is Not Null),0) When 0 Then (Select TOP 1 Convert(varchar(1),X.[Procedure type]+3) From [Colon Procedure] X Where X.[Episode No]=E.[Episode No] And (X.[Procedure date] Is Not Null) Or X.[Time of procedure] Is Not Null) When 3 Then 3 When 4 Then 4 When 5 Then 5 Else 0 End End)+'.'+Convert(varchar(10),E.[Episode no])+'.'+Convert(varchar(10),Convert(Int,SubString(E.[Patient No],7,6))) As ProcedureId 
	, Replace(Replace(Case When I.[Image normal]=-1 Then '' Else 'Imaging revealed,' 
		+Case When I.[Image chronic pancreatitis]=-1 Then ', chronic pancreatitis' Else '' End
		+Case When I.[Image pancreatic mass]=-1 Then ', pancreatic mass' Else '' End
		+Case When I.[Image hepatic mass]=-1 Then ', hepatic mass' Else '' End
		+Case When I.[Image acute pancreatitis]=-1 Then ', acute pancreatititis' Else '' End
		+Case When I.[Image dilated pancreatic duct]=-1 Then ', dilated pancreatic duct' Else '' End
		+Case When I.[Image dilated bile ducts]=-1 Then ', dilated bile ducts' Else '' End
		+Case When I.[Image stones]=-1 Then ', stones' Else '' End
		+Case When I.[Image dilated extrahepatic ducts]=-1 Then ', dilated extrahepatic ducts' Else '' End
		+Case When I.[Image dilated intrahepatic ducts]=-1 Then ', dilated intrahepatic ducts' Else '' End
		+Case When I.[Image gall stones]=-1 Then ', gall stones' Else '' End
		+Case When I.[Image biliary leak]=-1 Then ', biliary leak' Else '' End
		+Case When I.[Image fluid collection]=-1 Then ', fluid collection' Else '' End
		+Case When I.[Image obstruction CBD]=-1 Then ', obstructed CBD/CHD' Else '' End
		+Case When IsNull(I.[Image other text],'')='' Then '' Else +', '+IsNull(I.[Image other text],'') End
		End,',,',''),'Image revealed,','') As [Image]
		,Replace(Replace('@,'
      +Case When I.[Clin abdominal pain]=-1 Then ', abdominal pain' Else '' End
      +Case When I.[Clin abnormal enzymes]=-1 Then ', abnormal enzimes' Else '' End
      +Case When I.[Clin acute pancreatitis]=-1 Then ', acute pancreatitis' Else '' End
      +Case When I.[Clin cholangitis]=-1 Then ', cholangitis' Else '' End
      +Case When I.[Clin chronic pancreatitis]=-1 Then ', chronic pancreatitis' Else '' End
      +Case When I.[Clin jaundice]=-1 Then ', jaundice' Else '' End
      +Case When I.[Clin open access]=-1 Then ', open access' Else '' End
	  +Case When I.[Clin obstruction CBD]=-1 Then ', obstruction CDB' Else '' End
      +Case When I.[Clin pre-laparoscopic cholecystectomy]=-1 Then ', pre-laparoscopic cholecystectomy' Else '' End
      +Case When I.[Clin recurrent pancreatitis]=-1 Then ', recurrent pancreatitis' Else '' End
      +Case When I.[Clin sphincter of Oddi dysfunction]=-1 Then ', sphincter of Oddi dysfunction' Else '' End
      +Case When I.[Clin stent occlusion]=-1 Then ', stent occlusion' Else '' End
      +Case When I.[Clin papillary stenosis]=-1 Then ', papillary stenosis' Else '' End
      +Case When I.[Clin biliary leak]=-1 Then ', biliary leak' Else '' End
      +Case When IsNull([Clin other text],'')<>'' Then ', '+[Clin other text] Else '' End,'@,, ',''),'@,','')
	  As Indications
	  , Case When I.[Clin obstruction CBD]=-1 Then 1 Else 0 End As ClinObstructionCBD
	  , Case When I.[Image obstruction CBD]=-1 Then 1 Else 0 End As ImageObstructionCBD
	  ,Replace(Replace('@,'
      +Case When I.[Procs papill/sphincterotomy]=-1 Then ', papill/sphincterotomy' Else '' End
      +Case When I.[Procs stent insertion]=-1 Then ', stent insertion' Else '' End
      +Case When I.[Procs stent replacement]=-1 Then ', stent replacement' Else '' End
      +Case When I.[Procs stone removal]=-1 Then ', stone removal' Else '' End
      +Case When I.[Procs naso drains]=-1 Then ', naso drains' Else '' End
      +Case When I.[Procs cyst puncture]=-1 Then ', cyst puncture' Else '' End
      +Case When I.[Procs rendezvous]=-1 Then ', rendezvous' Else '' End
      +Case When I.[Procs stricture dilatation]=-1 Then ', stricture dilatation' Else '' End
      +Case When I.[Procs manometry]=-1 Then ', manometry' Else '' End
      +Case When I.[Procs cannulate and opacify]=-1 Then ', cannulate and opacify' Else '' End
      +Case When I.[Procs stent removal]=-1 Then ', stent removal' Else '' End
	  +Case When I.[Procs other]=-1 Then ', other' Else '' End
	  ,'@,, ',''),'@,','')
	  As Therapy

      , I.[Follow up prev exam]
      , I.[Follow up bile duct stones]
      , I.[Follow up malignancy]
      , I.[Follow up biliary stricture]
      , I.[Follow up stent replacement]
      , I.[Follow up disease/proc]
      , I.[Urgent two week referral]
      , I.[Cancer]
      , I.[cmNone]
      , I.[cmAngina]
      , I.[cmAsthma]
      , I.[cmCOPD]
      , I.[cmDiabetesMellitus]
      , I.[cmEpilepsy]
      , I.[cmHemiPostStroke]
      , I.[cmHT]
      , I.[cmMI]
      , I.[cmObesity]
      , I.[CIC]
      , I.[ASA Status]
      , I.[cmTIA]
      , I.[Potentially damaging drug text]
      , I.[cmOther]
      , I.[cmDiabetesMellitusType]
      , I.[EUS ref guided FNA biopsy]
      , I.[EUS guided cystogastrostomy]
      , I.[EUS guided coeliac plexus neurolysis]
      , I.[WHO status]
From [ERCP Indications] I, Episode E
Where I.[Episode No]=E.[Episode No] And I.[Patient No]=E.[Patient No]
Go

/* [dbo].[fw_TherapeuticERCP] */

Create View [dbo].[fw_TherapeuticERCP] As Select 'U.'+Convert(varchar(3),Case CHARINDEX('1', SUBSTRING(E.[Status], 1, 10)) When '1' Then 1 When '2' Then 2 When '5' Then 6 When '6' Then 7 Else Case IsNull((Select TOP 1 Convert(varchar(1),X.[Procedure type]+3) From [Colon Procedure] X Where X.[Episode No]=E.[Episode No] And X.[Procedure date] Is Not Null),0) When 0 Then (Select TOP 1 Convert(varchar(1),X.[Procedure type]+3) From [Colon Procedure] X Where X.[Episode No]=E.[Episode No] And (X.[Procedure date] Is Not Null) Or X.[Time of procedure] Is Not Null) When 3 Then 3 When 4 Then 4 When 5 Then 5 Else 0 End End)+'.'+Convert(varchar(10),E.[Episode no])+'.'+Convert(varchar(10),Convert(Int,SubString(E.[Patient No],7,6)))+'.'+CONVERT(varchar(10),T.[Site No]) As SiteId ,S.Region ,Case When IsNull(T.[Stricture Decompressed],0)=1 Or IsNull(T.[Stent Decompressed],0)=1 Or IsNull(T.[Balloon Decompressed],0)=1 Or IsNull(T.[Stone decompressed],0)=1 Then 'V' Else Case When IsNull(T.[Stricture Decompressed],0)=2 Or IsNull(T.[Stent Decompressed],0)=2 Or IsNull(T.[Balloon Decompressed],0)=2 Or IsNull(T.[Stone decompressed],0)=2 Then 'X' Else '?' End End As Result ,(Select Count(*) From fw_IndicationsERCP Where ClinObstructionCBD=1 And ProcedureId='U.'+Convert(varchar(3),Case CHARINDEX('1', SUBSTRING(E.[Status], 1, 10)) When '1' Then 1 When '2' Then 2 When '5' Then 6 When '6' Then 7 Else Case IsNull((Select TOP 1 Convert(varchar(1),X.[Procedure type]+3) From [Colon Procedure] X Where X.[Episode No]=E.[Episode No] And X.[Procedure date] Is Not Null),0) When 0 Then (Select TOP 1 Convert(varchar(1),X.[Procedure type]+3) From [Colon Procedure] X Where X.[Episode No]=E.[Episode No] And (X.[Procedure date] Is Not Null) Or X.[Time of procedure] Is Not Null) When 3 Then 3 When 4 Then 4 When 5 Then 5 Else 0 End End)+'.'+Convert(varchar(10),E.[Episode no])+'.'+Convert(varchar(10),Convert(Int,SubString(E.[Patient No],7,6)))) As ObstructedCBD ,Case When IsNull(T.[Stricture Decompressed],0)=1 Or IsNull(T.[Stent Decompressed],0)=1 Or IsNull(T.[Balloon Decompressed],0)=1 Or IsNull(T.[Stone decompressed],0)=1 Then 1 Else 0 End As Decompressed ,Case When IsNull(T.[Stricture Decompressed],0)=2 Or IsNull(T.[Stent Decompressed],0)=2 Or IsNull(T.[Balloon Decompressed],0)=2 Or IsNull(T.[Stone decompressed],0)=2 Then 1 Else 0 End As Failed ,Case When (IsNull(T.[Stricture Decompressed],0)+IsNull(T.[Stent Decompressed],0)+IsNull(T.[Balloon Decompressed],0)+IsNull(T.[Stone decompressed],0)>4 And IsNull(T.[Stricture Decompressed],0)+IsNull(T.[Stent Decompressed],0)+IsNull(T.[Balloon Decompressed],0)+IsNull(T.[Stone decompressed],0)<8) Then 1 Else 0 End As Unknow ,Case When T.[Therapeutic none]=-1 Then '' Else Case When T.[Stone removal]=-1 Then 'Stone removal' Else '' End End As StoneRemoval ,Case When T.[Therapeutic none]=-1 Then '' Else Case When T.[Stricture dilatation]=-1 Then 'Stricture dilatation ' +Case When IsNull(T.[Dilated to],'')<>'' Then Convert(varchar(10), T.[Dilated to])+Case T.[Dilatation units] When 1 Then ' mm' When 2 then ' Fr' Else '' End Else '' End Else '' End End As StrictureDilatation ,Case When T.[Therapeutic none]=-1 Then '' Else Case When T.[Endoscopic cyst puncture]=-1 Then 'Endoscopic cyst puncture' +Case T.[Cyst puncture via] When 1 Then ' using papilla' When 2 Then ' using medial wall of duodenum (cyst duodenostomy)' When 3 Then ' using stomach (cyst gastrostomy)' Else '' End Else '' End End As EndoscopicCystPuncture ,Case When T.[Therapeutic none]=-1 Then '' Else Case When T.[Nasopancreatic drain]=-1 Then 'Nasopancreatic drain' Else '' End End As NasopancreaticDrain ,Case When T.[Therapeutic none]=-1 Then '' Else Case When T.[Stent insertion]=-1 Then 'Stent insertion' Else Case When IsNull(T.[Stent qty],0)<>0 Then Convert(varchar(3),T.[Stent qty])+' stent(s) inserted length '+Convert(varchar(10),T.[Stent insertion length])+' Ø '+Convert(varchar(10),T.[Stent diameter])+' '+Case T.[Stent diameter units] When 1 Then 'cm' When 0 Then 'fr' Else '' End Else 'Stent insertion' End+Case When T.[Radioactive wire placed]=-1 Then ' (Radioactive wire placed)' Else '' End End End As StentInsertion ,Case When T.[Therapeutic none]=-1 Then '' Else Case When T.[Stent removal]=-1 Then 'Stent removal' Else '' End End As StentRemoval From [ERCP Therapeutic] T, Episode E, [ERCP Sites] S Where T.[Episode No]=E.[Episode No] And T.[Patient No]=E.[Patient No] And T.[Episode No]=S.[Episode No] And T.[Patient No]=S.[Patient No] And T.[Site No]=S.[Site No] 

GO

/* [dbo].[fw_OperatingHospitals] */

Create View [dbo].[fw_OperatingHospitals] As Select OperatingHospitalId, HospitalName From ERS_OperatingHospitals Union All Select OperatingHospitalId=0, HospitalName='*** Hospital not defined ***' 

GO

/* [dbo].[fw_Priority] */

Create View [dbo].[fw_Priority] As Select 0 As PriorityId, '(none)' As [Priority] Union All Select 1 As PriorityId, 'Efective' As [Priority] Union All Select 2 As PriorityId, 'Open Access (GP referrals)' As [Priority] Union All Select 3 As PriorityId, 'Schedulled (surveillance/repeats)' As [Priority] Union All Select 4 As PriorityId, 'Emergency (unespecified)' As [Priority] Union All Select 5 As PriorityId, 'Emergency (in hrs)' As [Priority] Union All Select 6 As PriorityId, 'Emergency (out of hours)' As [Priority] Union All Select 7 As PriorityId, 'Urgent' As [Priority] Union All Select 8 As PriorityId, 'Unespecified' As [Priority] Union All Select 9 As PriorityId, '' As [Priority] 

GO






/* [dbo].[fw_UGI_ProceduresInstruments] */

Create View [dbo].[fw_UGI_ProceduresInstruments] As Select 'U.1.'+Convert(varchar(10),E.[Episode no])+'.'+Convert(varchar(10),Convert(Int,SubString(E.[Patient No],7,6))) As ProcedureId , 1 As ScopeId , 'U.1.'+Convert(varchar(10),UP.[Instrument]) As InstrumentId From [Episode] E, [Upper GI Procedure] UP Where SubString(E.[Status],1,1)=1 And E.[Episode No]=Up.[Episode No] And UP.[Instrument] Is Not Null Union All Select 'U.1.'+Convert(varchar(10),E.[Episode no])+'.'+Convert(varchar(10),Convert(Int,SubString(E.[Patient No],7,6))) As ProcedureId , 2 As ScopeId , 'U.1.'+Convert(varchar(10),UP.[Instrument 2]) As InstrumentId From [Episode] E, [Upper GI Procedure] UP Where SubString(E.[Status],1,1)=1 And E.[Episode No]=Up.[Episode No] And (UP.[Instrument 2] Is Not Null Or UP.Instrument<>UP.[Instrument 2]) Union All Select 'U.2.'+Convert(varchar(10),E.[Episode no])+'.'+Convert(varchar(10),Convert(Int,SubString(E.[Patient No],7,6))) As ProcedureId , 1 As ScopeId , 'U.2.'+Convert(varchar(10),EP.[Instrument]) As InstrumentId From [Episode] E, [ERCP Procedure] EP Where SubString(E.[Status],2,1)=1 And EP.[Episode No]=E.[Episode No] And EP.[Instrument] Is Not Null Union All Select 'U.2.'+Convert(varchar(10),E.[Episode no])+'.'+Convert(varchar(10),Convert(Int,SubString(E.[Patient No],7,6))) As ProcedureId , 2 As ScopeId , 'U.2.'+Convert(varchar(10),EP.[Instrument 2]) As InstrumentId From [Episode] E, [ERCP Procedure] EP Where SubString(E.[Status],2,1)=1 And EP.[Episode No]=E.[Episode No] And (EP.[Instrument 2] Is Not Null Or EP.Instrument<>EP.[Instrument 2]) Union All Select 'U.'+Convert(varchar(1),3+IsNull((Select Top 1 [Procedure type] From [Colon procedure] CP Where CP.[Episode No]=E.[Episode No] And [Procedure type]<>2),0))+'.'+Convert(varchar(10),E.[Episode no])+'.'+Convert(varchar(10),Convert(Int,SubString(E.[Patient No],7,6))) As ProcedureId , 1 As ScopeId , 'U.'+Convert(varchar(1),3+IsNull((Select Top 1 [Procedure type] From [Colon procedure] CP Where CP.[Episode No]=E.[Episode No] And [Procedure type]<>2),0))+'.'+Convert(varchar(10),CP.[Instrument 2]) As InstrumentId From [Episode] E, [Colon Procedure] CP Where SubString(E.[Status],3,1)=1 And CP.[Episode No]=E.[Episode No] And CP.[Instrument] Is Not Null Union All Select 'U.'+Convert(varchar(1),3+IsNull((Select Top 1 [Procedure type] From [Colon procedure] CP Where CP.[Episode No]=E.[Episode No] And [Procedure type]<>2),0))+'.'+Convert(varchar(10),E.[Episode no])+'.'+Convert(varchar(10),Convert(Int,SubString(E.[Patient No],7,6))) As ProcedureId , 2 As ScopeId , 'U.'+Convert(varchar(10),CP.[Instrument 2]) As InstrumentId From [Episode] E, [Colon Procedure] CP Where SubString(E.[Status],3,1)=1 And CP.[Episode No]=E.[Episode No] And (CP.[Instrument 2] Is Not Null Or CP.Instrument<>CP.[Instrument 2]) Union All Select 'U.5.'+Convert(varchar(10),E.[Episode no])+'.'+Convert(varchar(10),Convert(Int,SubString(E.[Patient No],7,6))) As ProcedureId , 1 As ScopeId , 'U.5.'+Convert(varchar(10),CP.[Instrument]) As InstrumentId From [Episode] E, [Colon Procedure] CP Where SubString(E.[Status],4,1)=1 And CP.[Episode No]=E.[Episode No] And CP.[Patient No]=E.[Patient No] And CP.[Instrument] Is Not Null Union All Select 'U.5.'+Convert(varchar(10),E.[Episode no])+'.'+Convert(varchar(10),Convert(Int,SubString(E.[Patient No],7,6))) As ProcedureId , 2 As ScopeId , 'U.5.'+Convert(varchar(10),CP.[Instrument 2]) As InstrumentId From [Episode] E, [Colon Procedure] CP Where SubString(E.[Status],4,1)=1 And CP.[Episode No]=E.[Episode No] And CP.[Patient No]=E.[Patient No] And (CP.[Instrument 2] Is Not Null Or CP.Instrument<>CP.[Instrument 2]) Union All Select 'U.6.'+Convert(varchar(10),E.[Episode no])+'.'+Convert(varchar(10),Convert(Int,SubString(E.[Patient No],7,6))) As ProcedureId , 1 As ScopeId , 'U.6.'+Convert(varchar(10),CP.[Instrument]) As InstrumentId From [Episode] E, [Colon Procedure] CP Where SubString(E.[Status],4,1)=1 And CP.[Episode No]=E.[Episode No] And CP.[Patient No]=E.[Patient No] And CP.[Instrument] Is Not Null Union All Select 'U.6.'+Convert(varchar(10),E.[Episode no])+'.'+Convert(varchar(10),Convert(Int,SubString(E.[Patient No],7,6))) As ProcedureId , 2 As ScopeId , 'U.6.'+Convert(varchar(10),CP.[Instrument 2]) As InstrumentId From [Episode] E, [Colon Procedure] CP Where SubString(E.[Status],4,1)=1 And CP.[Episode No]=E.[Episode No] And CP.[Patient No]=E.[Patient No] And (CP.[Instrument 2] Is Not Null Or CP.Instrument<>CP.[Instrument 2]) Union All Select 'U.7.'+Convert(varchar(10),E.[Episode no])+'.'+Convert(varchar(10),Convert(Int,SubString(E.[Patient No],7,6))) As ProcedureId , 1 As ConsultantTypeId , 'U.6.'+Convert(varchar(10),Convert(Int,SubString(CP.Endoscopist2,7,6))) As ConsultantId From [Episode] E, [Colon Procedure] CP Where SubString(E.[Status],6,1)=1 And CP.[Episode No]=E.[Episode No] And CP.[Instrument] Is Not Null Union All Select 'U.7.'+Convert(varchar(10),E.[Episode no])+'.'+Convert(varchar(10),Convert(Int,SubString(E.[Patient No],7,6))) As ProcedureId , 2 As ConsultantTypeId , 'U.6.'+Convert(varchar(10),Convert(Int,SubString(CP.Endoscopist1,7,6))) As ConsultantId From [Episode] E, [Colon Procedure] CP Where SubString(E.[Status],6,1)=1 And CP.[Episode No]=E.[Episode No] And (CP.[Instrument 2] Is Not Null Or CP.Instrument<>CP.[Instrument 2]) 

GO

/* [dbo].[fw_ERS_ProceduresInstruments] */

Create View [dbo].[fw_ERS_ProceduresInstruments] As Select 'E.'+Convert(Varchar(10),PR.ProcedureId) As ProcedureId ,1 As ScopeId , 'E.'+Convert(varchar(10),PR.ProcedureType)+'.'+Convert(varchar(10),PR.Instrument1) As InstrumentId From ERS_Procedures PR, Patient E Where PR.PatientId=E.[Patient No] And PR.Instrument1 Is Not Null Union All Select 'E.'+Convert(Varchar(10),PR.ProcedureId) As ProcedureId ,2 As ScopeId , 'E.'+Convert(varchar(10),PR.ProcedureType)+'.'+Convert(varchar(10),PR.Instrument2) As InstrumentId From ERS_Procedures PR, Patient E Where PR.PatientId=E.[Patient No] And PR.Instrument2 Is Not Null 

GO

/* [dbo].[fw_ProceduresInstruments] */

Create View [dbo].[fw_ProceduresInstruments] As Select * From [dbo].[fw_UGI_ProceduresInstruments] Union All Select * From [dbo].[fw_ERS_ProceduresInstruments] 

GO

/* [dbo].[fw_UGI_BowelPreparationBoston] */

Create View [dbo].[fw_UGI_BowelPreparationBoston] As Select 'U.'+Convert(varchar(3),Case When CHARINDEX('1', SUBSTRING(E.[Status], 1, 10))='3' Then IsNull((Select TOP 1 Convert(varchar(1),X.[Procedure type]+3) From [Colon Procedure] X Where X.[Episode No]=E.[Episode No] And X.[Procedure date] Is Not Null),0) Else CHARINDEX('1', SUBSTRING(E.[Status], 1, 10)) End)+'.'+Convert(varchar(10),E.[Episode no])+'.'+Convert(Varchar(10),Convert(Int,SubString(E.[Patient No],7,6))) As ProcedureId, Convert(BIT,Case When BBPScore Is Null Then 0 Else 1 End) As BowelPrepSettings, Convert(BIT,Case IsNull(I.[Bowel preparation],0) When 0 Then 1 Else 0 End) As OnNoBowelPrep, Lists.[List item text] As Formulation, IsNull(I.[Bowel preparation],0) As OnFormulation, IsNull(I.BBPSRight,0) As OnRight, IsNull(I.BBPSTransverse,0) As OnTransverse, IsNull(I.BBPSLeft,0) As OnLeft, IsNull(I.BBPScore,0) As OnTotalScore, Case IsNull(I.[Bowel preparation],0) When 0 Then 1 Else 0 End As OffNoBowelPrep, IsNull(I.[Bowel preparation],0) As OffFormulation, Case IsNull(I.Quality,0) When 1 Then 1 Else 0 End As OffQualityGood, Case IsNull(I.Quality,0) When 2 Then 1 Else 0 End As OffQualitySatisfactory, Case IsNull(I.Quality,0) When 3 Then 1 Else 0 End As OffQualityPoor From dbo.[Colon Indications] I , dbo.Lists Lists , dbo.Episode E , [Colon Procedure] CP Where I.BBPScore Is Not Null And IsNull(I.[Bowel preparation],0)=Lists.[List item no] And Lists.[List description]='Preparation' And I.[Patient No]=E.[Patient No] And I.[Episode No]=E.[Episode No] And E.[Patient No]=CP.[Patient No] And E.[Episode No]=CP.[Episode No] And UPPER(Lists.[List item text]) <> '(NONE SELECTED)' 

GO

/* [dbo].[fw_ERS_BowelPreparationBoston] */

Create View [dbo].[fw_ERS_BowelPreparationBoston] As Select 'E.'+Convert(varchar(10),BP.ProcedureID) As ProcedureId , BP.BowelPrepSettings , BP.OnNoBowelPrep , L.ListItemText As Formulation , BP.OnFormulation , BP.OnRight, BP.OnTransverse, BP.OnLeft, OnTotalScore, BP.OffNoBowelPrep, BP.OffFormulation, BP.OffQualityGood, BP.OffQualitySatisfactory, BP.OffQualityPoor From ERS_BowelPreparation BP, ERS_Lists L Where L.ListDescription='Bowel_Preparation' And L.ListItemNo=BP.OnFormulation And BP.BowelPrepSettings=1 

GO

/* [dbo].[fw_BowelPreparationBoston] */

Create View [dbo].[fw_BowelPreparationBoston] As Select * From [dbo].[fw_UGI_BowelPreparationBoston] Union All Select * From [dbo].[fw_ERS_BowelPreparationBoston] 

GO

/* [dbo].[fw_UGI_Therapeutic] */

Create View [dbo].[fw_UGI_Therapeutic] As Select UP.SiteId, UP.TherapeuticID, TT.Therapeutic, TT.NedName, NULL As Organ, NULL As [role], Null As polypSize, NULL As Tattoed, NULL As Performed, NULL As Successful, NULL As Retrieved, NULL As Coment From ( Select 'U.'+Convert(varchar(3),Case CHARINDEX('1', SUBSTRING(E.[Status], 1, 10)) When '1' Then 1 When '2' Then 2 When '5' Then 6 When '6' Then 7 Else Case IsNull((Select TOP 1 Convert(varchar(1),X.[Procedure type]+3) From [Colon Procedure] X Where X.[Episode No]=E.[Episode No] And X.[Procedure date] Is Not Null),0) When 0 Then (Select TOP 1 Convert(varchar(1),X.[Procedure type]+3) From [Colon Procedure] X Where X.[Episode No]=E.[Episode No] And (X.[Procedure date] Is Not Null) Or X.[Time of procedure] Is Not Null) When 3 Then 3 When 4 Then 4 When 5 Then 5 Else 0 End End)+'.'+Convert(varchar(10),E.[Episode no])+'.'+Convert(varchar(10),Convert(Int,SubString(E.[Patient No],7,6)))+'.'+CONVERT(varchar(10),T.[Site No]) As SiteId , Case When T.[Argon beam diathermy]=-1 Then 60 End As ArgonBeamDiathermy , Case When T.[Balloon dilatation]=-1 Then 61 End As BalloonDilation , Case When T.[Bicap electro]=-1 Then 4 End As BicapElectrocautery , Case When T.[Heat probe]=-1 Then 66 End As HeaterProbe , Case When T.[Hot biopsy]=-1 Then 67 End As HotBiopsy , Case When T.Injection=-1 Then 68 End As InjectionTherapy , Case When T.EMR=-1 Then 64 End As EMR , Case When T.Diathermy=-1 Then 60 End As Diathermy , Case When T.Dilatation=-1 Then 61 End As Dilatation , Case When T.[Endoloop placement]=-1 Then 72 End As Endoloop , Case When T.[Foreign body]=-1 Then 15 End As ForeignBody , Case When T.Marking=-1 Then 16 End As Marking , Case When T.Polypectomy=-1 Then 70 End As Polypectomy , Case When T.[Polypectomy removal]=-1 Then 70 End As PolypectomyRemoval , Case When T.RFA=-1 Then 71 End As RFA , Case When T.[Stent insertion]=-1 Then 72 End As StentInsertion , Case When T.[Therapeutic none]=-1 Then 1 End As [None] , Case When T.[Variceal banding]=-1 Then 74 End As VaricealBanding , Case When T.[YAG laser]=-1 Then 75 End As YAGlaser , Case When T.Clip=-1 Then 77 End As Clip , Case When IsNull(T.Other,'')<>'' Then 50 End As Other From Episode E LEFT OUTER JOIN [Colon Therapeutic] T ON T.[Episode No]=E.[Episode No] And T.[Patient No]=E.[Patient No] LEFT OUTER JOIN [Colon Sites] S ON T.[Episode No]=S.[Episode No] And T.[Patient No]=S.[Patient No] And T.[Site No]=S.[Site No] ) As PT UNPIVOT ( TherapeuticID FOR Therapies IN (ArgonBeamDiathermy, BalloonDilation, BicapElectrocautery, HeaterProbe, HotBiopsy, InjectionTherapy, EMR, Diathermy, Dilatation, ForeignBody, Marking, Polypectomy, PolypectomyRemoval, RFA, StentInsertion, [None], VaricealBanding, YAGlaser, Clip, Other) ) As UP LEFT OUTER JOIN ERS_TherapeuticTypes TT ON UP.TherapeuticID=TT.TherapeuticID Where SiteId Is Not Null Union All Select UP.SiteId, UP.TherapeuticID, TT.Therapeutic, TT.NedName , NULL As Organ, NULL As [role], Null As polypSize, NULL As Tattoed, NULL As Performed, NULL As Successful, NULL As Retrieved, NULL As Coment From ( Select 'U.'+Convert(varchar(3),Case CHARINDEX('1', SUBSTRING(E.[Status], 1, 10)) When '1' Then 1 When '2' Then 2 When '5' Then 6 When '6' Then 7 Else Case IsNull((Select TOP 1 Convert(varchar(1),X.[Procedure type]+3) From [Colon Procedure] X Where X.[Episode No]=E.[Episode No] And X.[Procedure date] Is Not Null),0) When 0 Then (Select TOP 1 Convert(varchar(1),X.[Procedure type]+3) From [Colon Procedure] X Where X.[Episode No]=E.[Episode No] And (X.[Procedure date] Is Not Null) Or X.[Time of procedure] Is Not Null) When 3 Then 3 When 4 Then 4 When 5 Then 5 Else 0 End End)+'.'+Convert(varchar(10),E.[Episode no])+'.'+Convert(varchar(10),Convert(Int,SubString(E.[Patient No],7,6)))+'.'+CONVERT(varchar(10),T.[Site No]) As SiteId , Case When T.[Argon beam diathermy]=-1 Then 2 End As ArgonBeamDiathermy , Case When T.[Balloon dilatation]=-1 Then 3 End As BalloonDilation , Case When T.[Bicap electro]=-1 Then 4 End As BicapElectrocautery , Case When T.[Heat probe]=-1 Then 7 End As HeaterProbe , Case When T.[Hot biopsy]=-1 Then 8 End As HotBiopsy , Case When T.Injection=-1 Then 9 End As InjectionTherapy , Case When T.EMR=-1 Then 18 End As EMR , Case When T.[Band ligation]=-1 Then 12 End As BandLigation , Case When T.Diathermy=-1 Then 2 End As Diathermy , Case When T.Dilatation=-1 Then 3 End As Dilatation , Case When T.[Endoloop placement]=-1 Then 14 End As Endoloop , Case When T.[Foreign body]=-1 Then 15 End As ForeignBody , Case When T.[Gastrostomy Insertion (PEG)]=-1 Then 24 End As PEGInsertion , Case When T.[Gastrostomy Removal (PEG)]=-1 Then 25 End As PEGRemoval , Case When T.Marking=-1 Then 16 End As Marking , Case When T.[Oesophageal dilatation]=-1 Then 11 End As Oesophagealdilatation , Case When T.Polypectomy=-1 Then 27 End As Polypectomy , Case When T.[Polypectomy removal]=-1 Then 25 End As PolypectomyRemoval , Case When T.RFA=-1 Then 29 End As RFA , Case When T.[Stent insertion]=-1 Then 30 End As StentInsertion , Case When T.[Therapeutic none]=-1 Then 1 End As [None] , Case When T.[Variceal banding]=-1 Then 33 End As VaricealBanding , Case When T.[YAG laser]=-1 Then 34 End As YAGlaser , Case When IsNull(T.Other,'')<>'' Then 50 End As Other From Episode E LEFT OUTER JOIN [Upper GI Therapeutic] T ON T.[Episode No]=E.[Episode No] And T.[Patient No]=E.[Patient No] LEFT OUTER JOIN [ERCP Sites] S ON T.[Episode No]=S.[Episode No] And T.[Patient No]=S.[Patient No] And T.[Site No]=S.[Site No] ) As PT UNPIVOT ( TherapeuticID FOR Therapies IN (ArgonBeamDiathermy, BalloonDilation, BicapElectrocautery, HeaterProbe, HotBiopsy, InjectionTherapy, EMR, BandLigation, Diathermy, Dilatation, ForeignBody, PEGInsertion, PEGRemoval, Marking, Oesophagealdilatation, Polypectomy, PolypectomyRemoval, RFA, StentInsertion, [None], VaricealBanding, YAGlaser, Other) ) As UP LEFT OUTER JOIN ERS_TherapeuticTypes TT ON UP.TherapeuticID=TT.TherapeuticID Where SiteId Is Not Null 

GO

/* [dbo].[fw_ERS_Therapeutic] */

Create View [dbo].[fw_ERS_Therapeutic] As Select UP.SiteId, UP.TherapeuticID, TT.Therapeutic, TT.NedName, Organ, [role], polypSize, Tattooed, Performed, Successful, Retrieved, comment From ( Select 'E.'+Convert(varchar(3),S.SiteId) As SiteId , Organ, NULL [role] , Case When IsNull(L.SessileLargest,0)>IsNull(L.PedunculatedLargest,0) Then IsNull(L.SessileLargest,0) Else Case When IsNull(L.PedunculatedLargest,0)>IsNull(L.SubmucosalLargest,0) Then IsNull(L.PedunculatedLargest,0) Else IsNull(L.SubmucosalLargest,0) End End As polypSize , UT.Marking As Tattooed , Case When S.SiteId Is Null Then 0 Else 1 End Performed , UT.PolypectomyRemoval As Successful, UT.PolypectomyRemoval+UT.GastrostomyRemoval As Retrieved, L.Summary As comment , Case When UT.ArgonBeamDiathermy=1 Then 2 End As ArgonBeamDiathermy , Case When UT.BicapElectro=1 Then 4 End As BicapElectro , Case When UT.BandLigation=1 Then 62 End As BandLigation , Case When UT.BotoxInjection=1 Then 68 End As BotoxInjection , Case When UT.Clip=1 Then 77 End As Clip , Case When UT.CorrectPEGPlacement=1 Then 24 End As CorrectPEGPlacement , Case When UT.CorrectStentPlacement=1 Then 30 End As CorrectStentPlacement , Case When UT.Diathermy=1 Then 60 End As Diathermy , Case When UT.EMR=1 Then 64 End As EMR , Case When UT.EndoloopPlacement=1 Then 72 End As EndoloopPlacement , Case When UT.ForeignBody=1 Then 15 End As ForeignBody , Case When UT.GastrostomyInsertion=1 Then 30 End As GastrostomyInsertion , Case When UT.GastrostomyRemoval=1 Then 31 End As GastrostomyRemoval , Case When UT.HeatProbe=1 Then 7 End As HeatProbe , Case When UT.HotBiopsy=1 Then 67 End As HotBiopsy , Case When UT.Injection=1 Then 68 End As Injection , Case When UT.Marking=1 Then 16 End As Marking , Case When UT.[None]=1 Then 1 End As [None] , Case When UT.OesoDilMedicalReview=1 Then 11 End As OesoDilMedicalReview , Case When UT.Other=1 Then 76 End As Other , Case When UT.Polypectomy=1 Then 70 End As Polypectomy , Case When UT.PyloricDilatation=1 Then 28 End As PyloricDilatation , Case When UT.RFA=1 Then 71 End As RFA , Case When UT.StentInsertion=1 Then 72 End As StentInsertion , Case When UT.StentRemoval=1 Then 73 End As StentRemoval , Case When UT.VaricealBanding=1 Then 74 End As VaricealBanding , Case When UT.VaricealSclerotherapy=1 Then 74 End As VaricealSclerotherapy , Case When UT.YAGLaser=1 Then 75 End As YAGLaser , Case When T.BrushCytology='TRUE' Then 40 End As BrushCytology , Case When T.Polypectomy='TRUE' Then 27 End As Polypectomy2 , Case When T.HotBiopsy='TRUE' Then 67 End As HotBiopsy2 , Case When T.[None]='TRUE' Then 1 End As [None2] From dbo.ERS_Procedures P LEFT OUTER JOIN dbo.ERS_Sites S ON P.ProcedureId = S.ProcedureId LEFT OUTER JOIN dbo.ERS_UpperGITherapeutics UT ON S.SiteId = UT.SiteId LEFT OUTER JOIN dbo.ERS_ColonTherapeutics CT ON S.SiteId = CT.SiteId LEFT OUTER JOIN [dbo].[ERS_Organs] O ON O.RegionId=S.RegionId LEFT OUTER JOIN [dbo].[ERS_ColonAbnoLesions] L ON S.SiteId=L.SiteId LEFT OUTER JOIN [dbo].[ERS_UpperGISpecimens] T ON S.SiteId=T.SiteId ) As PT UNPIVOT ( TherapeuticID FOR Therapies IN (ArgonBeamDiathermy, BicapElectro, BandLigation, BotoxInjection, Clip, CorrectPEGPlacement, CorrectStentPlacement, EMR, EndoloopPlacement, GastrostomyInsertion, GastrostomyRemoval, Marking, [None], OesoDilMedicalReview, Other, Polypectomy, PyloricDilatation, StentInsertion, StentRemoval, VaricealBanding , BrushCytology, Polypectomy2, HotBiopsy2,[None2]) ) As UP LEFT OUTER JOIN ERS_TherapeuticTypes TT ON UP.TherapeuticID=TT.TherapeuticID Where SiteId Is Not Null And Organ Is Not Null 

GO

/* [dbo].[fw_Therapeutic] */

Create View [dbo].[fw_Therapeutic] As
Select * From [dbo].[fw_UGI_Therapeutic] 
Union All 
Select * From [dbo].[fw_ERS_Therapeutic] 

GO

/* [dbo].[fw_UGI_Specimens] */

Create View [dbo].[fw_UGI_Specimens] As Select 'U.'+Convert(varchar(3),Case When CHARINDEX('1', SUBSTRING(E.[Status], 1, 10))='3' Then IsNull((Select TOP 1 Convert(varchar(1),X.[Procedure type]+3) From [Colon Procedure] X Where X.[Episode No]=E.[Episode No] And X.[Procedure date] Is Not Null),0) Else CHARINDEX('1', SUBSTRING(E.[Status], 1, 10)) End)+'.'+Convert(Varchar(10),E.[Episode No])+'.'+Convert(Varchar(10),Convert(Int,SubString(E.[Patient No],7,6)))+'.'+convert(varchar(10),SP.[Site No]) As SiteId , Case When Polypectomy=-1 Then 1 Else 0 End As Polypectomy , SP.[Polypectomy qty] As PolypectomyQty From Episode E, [Colon Specimens] SP Where E.[Episode No]=SP.[Episode No] And E.[Patient No]=SP.[Patient No] And CHARINDEX('1', SUBSTRING(E.[Status], 1, 10))='3' 

GO

/* [dbo].[fw_ERS_Specimens] */

Create View [dbo].[fw_ERS_Specimens] As Select 'E.'+Convert(varchar(10),SP.SiteId) As SiteId , SP.Polypectomy , SP.PolypectomyQty From ERS_UpperGISpecimens SP 

GO

/* [dbo].[fw_Specimens] */

Create View [dbo].[fw_Specimens] As Select * From [dbo].[fw_UGI_Specimens] Union All Select * From [dbo].[fw_ERS_Specimens] 

GO

/* [dbo].[fw_ReportFilter] */

Create View [dbo].[fw_ReportFilter] WITH SCHEMABINDING As Select UserID As UserId, ReportDate, FromDate, ToDate, Anonymise, TypesOfEndoscopists, HideSuppressed From [dbo].[ERS_ReportFilter] 

GO

/* kfw_ReportFilter */

Create UNIQUE CLUSTERED INDEX kfw_ReportFilter ON fw_ReportFilter (UserID)

GO

/* [dbo].[fw_UGI_Placements] */

Create View [dbo].[fw_UGI_Placements] WITH SCHEMABINDING As Select 'U.1.'+Convert(Varchar(10),GISites.[Episode No])+'.'+Convert(Varchar(10),Convert(Int,SubString(GISites.[Patient No],7,6)))+'.'+Convert(varchar(10),GISites.[Site No]) As SiteId, Case When GITherapy.[Gastrostomy Insertion (PEG)]=-1 Then 1 Else 0 End As [Placements], Case When GITherapy.[Gastrostomy Insertion (PEG)]=-1 Then Case GITherapy.[Stent insertion] When -1 Then 0. Else 1. End Else 0. End As [IncorrectPlacement], Case When GITherapy.[Gastrostomy Insertion (PEG)]=-1 Then Case GITherapy.[Stent insertion] When -1 Then 1.0 Else 0. End Else 0. End As [CorrectPlacement] From [dbo].[Upper GI Procedure] Procs , [dbo].[Upper GI sites] GISites , [dbo].[Upper GI therapeutic] GITherapy , [dbo].[Patient] Patients Where GISites.[Patient No]=Procs.[Patient No] And GISites.[Episode No]=Procs.[Episode No] And GITherapy.[Patient No]=GISites.[Patient No] And GITherapy.[Episode No]=GISites.[Episode No] And GITherapy.[Site No]=GISites.[Site No] And Patients.[Patient No]=Convert(int,SubString(IsNull(Procs.[Patient No],'000000'),7,6)) And Procs.Endoscopist1 Is Not Null And Procs.Endoscopist1 <>'' 

GO

/* [dbo].[fw_ERS_Placements] */

Create View [dbo].[fw_ERS_Placements] WITH SCHEMABINDING As Select 'E.'+Convert(varchar(10),GISites.SiteId) As SiteId, 1 As [Placements], Case When GITherapy.[StentInsertion]=1 Then 0 Else 1 End As [IncorrectPlacement], Case When GITherapy.[StentInsertion]=1 Then 1 Else 0 End As [CorrectPlacement] From [dbo].[ERS_Procedures] Procs , [dbo].[Patient] Patients , [dbo].[ERS_Sites] GISites , [dbo].[ERS_UpperGITherapeutics] GITherapy Where GISites.ProcedureId=Procs.ProcedureId And GITherapy.SiteId=GISites.SiteId And Patients.[Patient No]=Procs.PatientId And Procs.[ProcedureType]=1 

GO

/* [dbo].[fw_Placements] */

Create View [dbo].[fw_Placements] As Select * From fw_UGI_Placements Union All Select * From fw_ERS_Placements 

GO

/* [dbo].[fw_PathologyResults] */

Create View [dbo].[fw_PathologyResults] As SELECT 'U.'+Convert(varchar(3),Case CHARINDEX('1', SUBSTRING(E.[Status], 1, 10)) When '1' Then 1 When '2' Then 2 When '5' Then 6 When '6' Then 7 Else Case IsNull((Select TOP 1 Convert(varchar(1),X.[Procedure type]+3) From [Colon Procedure] X Where X.[Episode No]=E.[Episode No] And X.[Procedure date] Is Not Null),0) When 0 Then (Select TOP 1 Convert(varchar(1),X.[Procedure type]+3) From [Colon Procedure] X Where X.[Episode No]=E.[Episode No] And (X.[Procedure date] Is Not Null) Or X.[Time of procedure] Is Not Null) When 3 Then 3 When 4 Then 4 When 5 Then 5 Else 0 End End)+'.'+Convert(varchar(10),E.[Episode no])+'.'+Convert(varchar(10),Convert(Int,SubString(E.[Patient No],7,6))) As ProcedureId ,RE.[Adenoma confirmed] As AdenomaConfirmed ,Convert(Date,Convert(DateTime,'1900-01-01')+Convert(DateTime,RE.[Date of specimen])-2) As DateOfSpecimen ,Convert(Date,Convert(DateTime,'1900-01-01')+Convert(DateTime,RE.[Date recieved])-2) As DateReceived ,Convert(Date,Convert(DateTime,'1900-01-01')+Convert(DateTime,RE.[Date of report])-2) As DateOfReport ,RE.[Lab report no] As ReportNo ,RE.[Report text] As ReportText FROM [Pathology Results] RE, Episode E Where RE.[Episode No]=E.[Episode No] And RE.[Patient No]=E.[Patient No] 

GO


/* [dbo].[fw_UGI_Markings] */

Create View [dbo].[fw_UGI_Markings] WITH SCHEMABINDING As Select 'U.'+Convert(varchar(3),Case When CHARINDEX('1', SUBSTRING(E.[Status], 1, 10))='3' Then IsNull((Select TOP 1 Convert(varchar(1),X.[Procedure type]+3) From [dbo].[Colon Procedure] X Where X.[Episode No]=E.[Episode No] And X.[Procedure date] Is Not Null),0) Else CHARINDEX('1', SUBSTRING(E.[Status], 1, 10)) End)+'.'+Convert(Varchar(10),E.[Episode No])+'.'+Convert(Varchar(10),Convert(Int,SubString(E.[Patient No],7,6)))+'.'+convert(varchar(10),CT.[Site No]) As SiteId ,Case When CT.Marking=-1 Then 1 Else 0 End As Marking ,Case CT.[Marking type] When 1 Then 'tattoo' When 2 Then 'dye spray' When 3 Then 'EMR solution' Else '(none)' End As MarkingType ,CT.[Marking number sites] As MarkingNumberSites From [dbo].[Episode] E , [dbo].[Colon Therapeutic] CT Where E.[Episode No]=CT.[Episode No] And E.[Patient No]=CT.[Patient No] /*And CT.Marking=-1 Needed for List report?*/ 

GO

/* [dbo].[fw_ERS_Markings] */

Create View [dbo].[fw_ERS_Markings] WITH SCHEMABINDING As Select 'E.'+Convert(varchar(10),T.SiteId) As SiteId ,T.Marking ,Case T.MarkingType When 1 Then 'tattoo' When 2 Then 'dye spray' When 3 Then 'EMR solution' Else '(none)' End As MarkingType , Case When T.Marking=0 Then 0 Else 1 End As MarkingNumberSites From [dbo].[ERS_UpperGITherapeutics] T 

GO

/* [dbo].[fw_Markings] */

Create View [dbo].[fw_Markings] As Select * From fw_UGI_Markings Union All Select * From fw_ERS_Markings 

GO

/* [dbo].[fw_UGI_Visualization] */

Create View [dbo].[fw_UGI_Visualization] WITH SCHEMABINDING As SELECT 'U.'+Convert(varchar(3),Case CHARINDEX('1', SUBSTRING(E.[Status], 1, 10)) When '1' Then 1 When '2' Then 2 When '5' Then 6 When '6' Then 7 Else Case IsNull((Select TOP 1 Convert(varchar(1),X.[Procedure type]+3) From [dbo].[Colon Procedure] X Where X.[Episode No]=E.[Episode No] And X.[Procedure date] Is Not Null),0) When 0 Then (Select TOP 1 Convert(varchar(1),X.[Procedure type]+3) From [dbo].[Colon Procedure] X Where X.[Episode No]=E.[Episode No] And (X.[Procedure date] Is Not Null) Or X.[Time of procedure] Is Not Null) When 3 Then 3 When 4 Then 4 When 5 Then 5 Else 0 End End)+'.'+Convert(varchar(10),E.[Episode no])+'.'+Convert(varchar(10),Convert(Int,SubString(E.[Patient No],7,6))) As ProcedureId ,Case V.[Via major to bile duct] When 1 Then 'sucessfull' When 2 Then 'partially successfull' When 3 Then 'not attempted' When 4 Then 'unsuccessfull due to '+Case IsNull([Bile duct unsuccessful due to],0) When 0 Then '(none)' Else '' End Else 'not registered' End As ViaMayorToBileDuct ,Case V.[Via major to pan duct] When 1 Then 'sucessfull' When 2 Then 'partially successfull' When 3 Then 'not attempted' When 4 Then 'unsuccessfull due to '+Case IsNull([Pan duct unsuccessful due to],0) When 0 Then '(none)' Else '' End Else 'not registered' End As ViaMayorToPancreaticDuct ,Case V.[Via minor] When 1 Then 'sucessfull' When 2 Then 'partially successfull' When 3 Then 'not attempted' When 4 Then 'unsuccessfull due to '+Case IsNull([Via minor unsuccessful due to],0) When 0 Then '(none)' Else '' End Else 'not registered' End As ViaMinor ,Case [Access via] When 0 Then 'pylorus' When 1 Then Case [Other access method] When 0 Then '(none)' Else '' End Else '' End As AccessVia ,[Hepatobiliary 1st contrast med vol ml] As Hepatobiliary1stContrastMedVolml ,[Hepatobiliary 2nd contrast med vol ml] As Hepatobiliary2ndContrastMedVolml ,[Pancreatic 1st contrast med vol ml] As Pancreatic1stContrastMedVolml ,[Pancreatic 2nd contrast med vol ml] As Pancreatic2ndContrastMedVolml FROM [dbo].[ERCP Visualisation] V, [dbo].[Episode] E Where V.[Episode No]=E.[Episode No] And V.[Patient No]=E.[Patient No] 

GO

/* [dbo].[fw_Visualization] */

CREATE VIEW [dbo].[fw_Visualization] AS SELECT * FROM fw_UGI_Visualization 

GO

/* [dbo].[fw_Insertions] */

Create View [dbo].[fw_Insertions] As Select 'U.1.'+Convert(varchar(10),E.[Episode no])+'.'+Convert(varchar(10),Convert(Int,SubString(E.[Patient No],7,6)))+'.'+Convert(VARCHAR(10),S.[Site No]) As SiteId, Case Therapy.[Gastrostomy Insertion (PEG)] When -1 Then 'PEG' Else '' End As [InsertionType], Case Therapy.[Correct PEG/PEJ placement] When 1 Then 1 Else 0 End [Correct_Placement], Case Therapy.[Correct PEG/PEJ placement] When 1 Then 0 Else 1 End [Incorrect_Placement] From [dbo].[Upper GI Procedure] PR , Episode E ,[dbo].[Upper GI Sites] S ,[dbo].[Upper GI Therapeutic] Therapy Where E.[Episode No]=PR.[Episode No] And E.[Patient No]=PR.[Patient No] And E.[Episode No]=S.[Episode No] And E.[Patient No]=S.[Patient No] And Therapy.[Episode No]=S.[Episode No] And Therapy.[Patient No]=S.[Patient No] And Therapy.[Site No]=S.[Site No] And [Gastrostomy Insertion (PEG)]=-1 Union All Select 'E.'+Convert(VARCHAR(10),T.SiteId) As SiteId, Case When T.GastrostomyInsertion=1 Then 'PEG' Else '' END As [InsertionType], Case When T.CorrectPEGPlacement=1 Then 1 Else 0 End As [Correct_Placement], Case When T.CorrectPEGPlacement=1 Then 0 Else 1 End As [Incorrect_Placement] From ERS_UpperGITherapeutics T Where T.GastrostomyInsertion=1 

GO

/* [dbo].[fw_InstrumentTypes] */

Create View [dbo].[fw_InstrumentTypes] As Select 'A' IntrumentTypeId, 'Antegrade' As IntrumentType Union Select 'R' IntrumentTypeId, 'Retrograde' As IntrumentType

GO

/* [dbo].[fw_Instruments] */

Create View [dbo].[fw_Instruments] As Select 'U.3.'+Convert(varchar(10),[List item no]) As InstrumendId, [List item text] As Instrument, 'R' As IntrumentTypeId From Lists Where [List description]='Instrument ColonSig' Union All Select 'U.4.'+Convert(varchar(10),[List item no]) As InstrumendId, [List item text] As Instrument, 'R' As IntrumentTypeId From Lists Where [List description]='Instrument ColonSig' Union All Select 'U.2.'+Convert(varchar(10),[List item no]) As InstrumendId, [List item text] As Instrument, 'R' As IntrumentTypeId From Lists Where [List description]='Instrument ERCP' Union All Select 'U.6.'+Convert(varchar(10),[List item no]) As InstrumendId, [List item text] As Instrument, 'R' As IntrumentTypeId From Lists Where [List description]='Instrument EUS' Union All Select 'U.7.'+Convert(varchar(10),[List item no]) As InstrumendId, [List item text] As Instrument, 'R' As IntrumentTypeId From Lists Where [List description]='Instrument HPB' Union All Select 'U.1.'+Convert(varchar(10),[List item no]) As InstrumendId, [List item text] As Instrument, 'A' As IntrumentTypeId From Lists Where [List description]='Instrument Upper GI' Union All Select 'E.1.'+Convert(varchar(10),ListItemNo) As InstrumentId, ListItemText As Instrument, 'A' As InstrumentType From ERS_Lists Where ListDescription='Instrument Upper GI' Union All Select 'E.2.'+Convert(varchar(10),ListItemNo) As InstrumentId, ListItemText As Instrument, 'R' As InstrumentType From ERS_Lists Where ListDescription='Instrument ERCP' Union All Select 'E.3.'+Convert(varchar(10),ListItemNo) As InstrumentId, ListItemText As Instrument, 'R' As InstrumentType From ERS_Lists Where ListDescription='Instrument ColonSig' Union All Select 'E.4.'+Convert(varchar(10),ListItemNo) As InstrumentId, ListItemText As Instrument, 'R' As InstrumentType From ERS_Lists Where ListDescription='Instrument ColonSig' Union All Select 'E.5.'+Convert(varchar(10),ListItemNo) As InstrumentId, ListItemText As Instrument, 'R' As InstrumentType From ERS_Lists Where ListDescription='Instrument ColonSig' 

GO

/* [dbo].[fw_UGI_QA] */

/*Create View [dbo].[fw_UGI_QA] As /*Colon UGI*/ Select 'U.'+Convert(varchar(3),Case CHARINDEX('1', SUBSTRING(E.[Status], 1, 10)) When '1' Then 1 When '2' Then 2 When '4' Then 5 When '5' Then 6 When '6' Then 7 Else Case IsNull((Select TOP 1 Convert(varchar(1),X.[Procedure type]+3) From [Colon Procedure] X Where X.[Episode No]=E.[Episode No] And X.[Procedure date] Is Not Null),0) When 0 Then (Select TOP 1 Convert(varchar(1),X.[Procedure type]+3) From [Colon Procedure] X Where X.[Episode No]=E.[Episode No] And (X.[Procedure date] Is Not Null) Or X.[Time of procedure] Is Not Null) When 3 Then 3 When 4 Then 4 When 5 Then 5 Else 0 End End)+'.'+Convert(varchar(10),E.[Episode no])+'.'+Convert(varchar(10),Convert(Int,SubString(E.[Patient No],7,6))) As ProcedureId ,Case When QA.[Pat sedation]=4 Then Case QA.[Pat sedation asleep but responding] When 1 Then 4 When 2 Then 5 When 3 Then 6 Else QA.[Pat sedation asleep but responding] End Else QA.[Pat sedation] End As NurseAssPatSedationScore , IsNull(QA.[Pat discomfort],0) As NursesAssPatComfortScore , IsNull(QA.[Pat ass discomfort],0) As PatientsSedationScore , IsNull(Case When QA.[Complications none]=-1 Then 'No complications' Else Replace('Complications:,'+Case When QA.[Damage to scope]=-1 Then ',Damage to scope ('+Case When QA.[Mechanical scope damage]=-1 Then 'mechanical' else 'patient initiated' End+')' +Case When QA.[Poorly tolerated]=-1 Then ', poorly tolerated' Else '' End +Case When QA.Hypoxia=-1 Then ', hypoxia' Else '' End +Case When QA.[Respiratory depression]=-1 Then ', respiratory depression' Else '' End +Case When QA.[Patient discomfort]=-1 Then ', patient discomfort' Else '' End +Case When QA.[Respiratory arrest]=-1 Then ', respiratory arrest requiring' Else '' End +Case When QA.[Patient distress]=-1 Then ', patient distress' Else '' End +Case When QA.[Gastric contents aspiration]=-1 Then ', gastric contents aspiration' Else '' End +Case When QA.[Shock/hypotension]=-1 Then ', shock/hypotension' Else '' End +Case When QA.[Cardiac arrest]=-1 Then ', cardiac arrest' Else '' End +Case When QA.[Failed intubation]=-1 Then ', failed intubation' Else '' End +Case When QA.Haemorrhage=-1 Then ', haemorrhage' Else '' End +Case When QA.[Cardiac arrythmia]=-1 Then ', cardiac arrythmia' Else '' End +Case When QA.[Difficult intubation]=-1 Then ', difficult intubation' Else '' End +Case When QA.[Significant haemorrhage]=-1 Then ', significant haemorrhage requiring transfusion' Else '' End +Case When QA.Death=-1 Then ', dead' Else '' End +Case When QA.Perforation=-1 Then ', '+IsNull(QA.[Perforation text],'') Else '' End +Case When IsNull(QA.[Technical failure],'')<>'' Then ', '+QA.[Technical failure] Else '' End End,',,','') End,'') As Complications , Replace(Replace(Replace(Replace(Replace(Case When (Select Count(*) From [Patient Premedication] PM , [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]=-1)>0 Then (Select Top 1 convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name] From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]=-1)+'(,' +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],0) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],1) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],2) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],3) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],4) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],5) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],6) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],7) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],8) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],9) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +')' Else '' End,',, ',''),'()',''),'0 ',''),', , ',''),', )',')') As ReversalAgents From [Colon Procedure] CP, [Episode] E, [Colon QA] QA Where CP.[Episode No]=E.[Episode No] And QA.[Episode No]=CP.[Episode No] And CP.DNA Is Not Null /*OGD*/ Union All Select 'U.'+Convert(varchar(3),Case CHARINDEX('1', SUBSTRING(E.[Status], 1, 10)) When '1' Then 1 When '2' Then 2 When '4' Then 5 When '5' Then 6 When '6' Then 7 Else Case IsNull((Select TOP 1 Convert(varchar(1),X.[Procedure type]+3) From [Colon Procedure] X Where X.[Episode No]=E.[Episode No] And X.[Procedure date] Is Not Null),0) When 0 Then (Select TOP 1 Convert(varchar(1),X.[Procedure type]+3) From [Colon Procedure] X Where X.[Episode No]=E.[Episode No] And (X.[Procedure date] Is Not Null) Or X.[Time of procedure] Is Not Null) When 3 Then 3 When 4 Then 4 When 5 Then 5 Else 0 End End)+'.'+Convert(varchar(10),E.[Episode no])+'.'+Convert(varchar(10),Convert(Int,SubString(E.[Patient No],7,6))) As ProcedureId ,Case When QA.[Pat sedation]=4 Then Case QA.[Pat sedation asleep but responding] When 1 Then 4 When 2 Then 5 When 3 Then 6 Else QA.[Pat sedation asleep but responding] End Else QA.[Pat sedation] End As NurseAssPatSedationScore , IsNull(QA.[Pat discomfort],0) As NursesAssPatComfortScore , IsNull(QA.[Pat ass discomfort],0) As PatientsSedationScore , IsNull(Case When QA.[Complications none]=-1 Then 'No complications' Else Replace('Complications:,'+Case When QA.[Damage to scope]=-1 Then ',Damage to scope ('+Case When QA.[Mechanical scope damage]=-1 Then 'mechanical' else 'patient initiated' End+')' +Case When QA.[Poorly tolerated]=-1 Then ', poorly tolerated' Else '' End +Case When QA.Hypoxia=-1 Then ', hypoxia' Else '' End +Case When QA.[Respiratory depression]=-1 Then ', respiratory depression' Else '' End +Case When QA.[Patient discomfort]=-1 Then ', patient discomfort' Else '' End +Case When QA.[Respiratory arrest]=-1 Then ', respiratory arrest requiring' Else '' End +Case When QA.[Patient distress]=-1 Then ', patient distress' Else '' End +Case When QA.[Gastric contents aspiration]=-1 Then ', gastric contents aspiration' Else '' End +Case When QA.[Shock/hypotension]=-1 Then ', shock/hypotension' Else '' End +Case When QA.[Cardiac arrest]=-1 Then ', cardiac arrest' Else '' End +Case When QA.[Failed intubation]=-1 Then ', failed intubation' Else '' End +Case When QA.Haemorrhage=-1 Then ', haemorrhage' Else '' End +Case When QA.[Cardiac arrythmia]=-1 Then ', cardiac arrythmia' Else '' End +Case When QA.[Difficult intubation]=-1 Then ', difficult intubation' Else '' End +Case When QA.[Significant haemorrhage]=-1 Then ', significant haemorrhage requiring transfusion' Else '' End +Case When QA.Death=-1 Then ', hypoxia' Else '' End +Case When QA.[Complications other]=-1 Then ', '+IsNull(QA.[Complications other text],'') Else '' End +Case When QA.[Injury to mouth/teeth]=-1 Then ', injury to mouth/teeth' Else '' End +Case When QA.Perforation=-1 Then ', '+IsNull(QA.[Perforation text],'') Else '' End +Case When IsNull(QA.[Technical failure],'')<>'' Then ', '+QA.[Technical failure] Else '' End End,',,','') End,'') As Complications , Replace(Replace(Replace(Replace(Replace(Case When (Select Count(*) From [Patient Premedication] PM , [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]=-1)>0 Then (Select Top 1 convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name] From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]=-1)+'(,' +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],0) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],1) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],2) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],3) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],4) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],5) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],6) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],7) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],8) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],9) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +')' Else '' End,',, ',''),'()',''),'0 ',''),', , ',''),', )',')') As ReversalAgents From [Episode] E , [Upper GI QA] QA Where QA.[Episode No]=E.[Episode No] /*ERCP*/ Union All Select 'U.'+Convert(varchar(3),Case CHARINDEX('1', SUBSTRING(E.[Status], 1, 10)) When '1' Then 1 When '2' Then 2 When '4' Then 5 When '5' Then 6 When '6' Then 7 Else Case IsNull((Select TOP 1 Convert(varchar(1),X.[Procedure type]+3) From [Colon Procedure] X Where X.[Episode No]=E.[Episode No] And X.[Procedure date] Is Not Null),0) When 0 Then (Select TOP 1 Convert(varchar(1),X.[Procedure type]+3) From [Colon Procedure] X Where X.[Episode No]=E.[Episode No] And (X.[Procedure date] Is Not Null) Or X.[Time of procedure] Is Not Null) When 3 Then 3 When 4 Then 4 When 5 Then 5 Else 0 End End)+'.'+Convert(varchar(10),E.[Episode no])+'.'+Convert(varchar(10),Convert(Int,SubString(E.[Patient No],7,6))) As ProcedureId ,Case When QA.[Pat sedation]=4 Then Case QA.[Pat sedation asleep but responding] When 1 Then 4 When 2 Then 5 When 3 Then 6 Else QA.[Pat sedation asleep but responding] End Else QA.[Pat sedation] End As NurseAssPatSedationScore , IsNull(QA.[Pat discomfort],0) As NursesAssPatComfortScore , IsNull(QA.[Pat ass discomfort],0) As PatientsSedationScore , IsNull(Case When QA.[Complications none]=-1 Then 'No complications' Else Replace('Complications:,'+Case When QA.[Damage to scope]=-1 Then ',Damage to scope ('+Case When QA.[Mechanical scope damage]=-1 Then 'mechanical' else 'patient initiated' End+')' +Case When QA.[Poorly tolerated]=-1 Then ', poorly tolerated' Else '' End +Case When QA.Hypoxia=-1 Then ', hypoxia' Else '' End +Case When QA.[Respiratory depression]=-1 Then ', respiratory depression' Else '' End +Case When QA.[Patient discomfort]=-1 Then ', patient discomfort' Else '' End +Case When QA.[Respiratory arrest]=-1 Then ', respiratory arrest requiring' Else '' End +Case When QA.[Patient distress]=-1 Then ', patient distress' Else '' End +Case When QA.[Gastric contents aspiration]=-1 Then ', gastric contents aspiration' Else '' End +Case When QA.[Shock/hypotension]=-1 Then ', shock/hypotension' Else '' End +Case When QA.[Cardiac arrest]=-1 Then ', cardiac arrest' Else '' End +Case When QA.Haemorrhage=-1 Then ', haemorrhage' Else '' End +Case When QA.[Cardiac arrythmia]=-1 Then ', cardiac arrythmia' Else '' End +Case When QA.[Difficult intubation]=-1 Then ', difficult intubation' Else '' End +Case When QA.[Significant haemorrhage]=-1 Then ', significant haemorrhage requiring transfusion' Else '' End +Case When QA.Death=-1 Then ', hypoxia' Else '' End +Case When QA.[Complications other]=-1 Then ', '+IsNull(QA.[Complications other text],'') Else '' End +Case When QA.[Injury to mouth/teeth]=-1 Then ', injury to mouth/teeth' Else '' End +Case When QA.Perforation=-1 Then ', '+IsNull(QA.[Perforation text],'') Else '' End +Case When IsNull(QA.[Technical failure],'')<>'' Then ', '+QA.[Technical failure] Else '' End +Case When QA.[Allergy to medium]=-1 Then ', allergy to medium' Else '' End +Case When QA.[Contrast extravasation]=-1 Then ', contrast extravasation' Else '' End +Case When QA.Arcinarisation=-1 Then ', acinirisation of the parenchyma' Else '' End +Case When QA.[Failed ERC/ERP]=-1 Then ', failed ERC/ERP' Else '' End +Case When QA.[Failed cannulation]=-1 Then ', failed cannulation' Else '' End +Case When QA.[Allergy to medium]=-1 Then ', allergy to medium' Else '' End +Case When QA.[Failed stent insertion]=-1 Then ', failed stent insertion' Else '' End End,',,','') End,'') As Complications , Replace(Replace(Replace(Replace(Replace(Case When (Select Count(*) From [Patient Premedication] PM , [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]=-1)>0 Then (Select Top 1 convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name] From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]=-1)+'(,' +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],0) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],1) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],2) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],3) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],4) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],5) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],6) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],7) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],8) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],9) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +')' Else '' End,',, ',''),'()',''),'0 ',''),', , ',''),', )',')') As ReversalAgents From [Episode] E , [ERCP QA] QA Where QA.[Episode No]=E.[Episode No] */

GO

/* [dbo].[fw_ERS_QA] */

/*Create View [dbo].[fw_ERS_QA] As Select 'E.'+Convert(Varchar(10),NP.ProcedureId) As ProcedureId ,Case When QA.PatSedation=4 Then Case QA.PatSedationAsleepResponseState When 1 Then 4 When 2 Then 5 When 3 Then 6 Else QA.PatSedationAsleepResponseState End Else QA.PatSedation End As NurseAssPatSedationScore , IsNull(QA.PatDiscomfort,0) As NursesAssPatComfortScore , IsNull(QA.PatSedation,0) As PatientsSedationScore , Case When QA.ComplicationsNone=1 Then 'No complications' Else Replace('Complications:' +Case When QA.DamageToScope=1 Then ',Damage to scope ('+Case When QA.DamageToScopeType=0 Then 'mechanical' else 'patient initiated' End+')' Else '' End +Case When QA.PoorlyTolerated=1 Then ', poorly tolerated' Else '' End +Case When QA.Hypoxia=1 Then ', hypoxia' Else '' End +Case When QA.RespiratoryDepression=1 Then ', respiratory depression' Else '' End +Case When QA.PatientDiscomfort=1 Then ', patient discomfort' Else '' End +Case When QA.RespiratoryArrest=1 Then ', respiratory arrest requiring' Else '' End +Case When QA.PatientDistress=1 Then ', patient distress' Else '' End +Case When QA.GastricContentsAspiration=1 Then ', gastric contents aspiration' Else '' End +Case When QA.ShockHypotension=1 Then ', shock/hypotension' Else '' End +Case When QA.CardiacArrest=1 Then ', cardiac arrest' Else '' End +Case When QA.FailedIntubation=1 Then ', failed intubation' Else '' End +Case When QA.Haemorrhage=1 Then ', haemorrhage' Else '' End +Case When QA.CardiacArrythmia=1 Then ', cardiac arrythmia' Else '' End +Case When QA.DifficultIntubation=1 Then ', difficult intubation' Else '' End +Case When QA.SignificantHaemorrhage=1 Then ', significant haemorrhage requiring transfusion' Else '' End +Case When QA.Death=1 Then ', dead' Else '' End +Case When QA.ComplicationsOther=1 Then ', '+QA.ComplicationsOtherText Else '' End +Case When QA.TechnicalFailure<>'' Then ', '+QA.TechnicalFailure Else '' End +Case When QA.Perforation=1 Then ', '+QA.PerforationText Else '' End ,':,',':') End As Complications , Replace(Replace(Replace(Replace(Replace(Case When (Select Count(*) From ERS_UpperGIPremedication PM, ERS_DrugList D Where PM.DrugNo=D.DrugNo And PM.ProcedureId=QA.ProcedureId And D.IsReversingAgent=1)>0 Then (Select Top 1 convert(varchar(10),PM.Dose)+' '+PM.Units+' '+PM.DrugName From ERS_UpperGIPremedication PM, ERS_DrugList D Where PM.DrugNo=D.DrugNo And PM.ProcedureId=QA.ProcedureId And D.IsReversingAgent=1)+'(,' +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+PM.Units+' '+D.DrugName,0) Over (Order By PM.ProcedureId) From ERS_UpperGIPremedication PM, ERS_DrugList D Where PM.DrugNo=D.DrugNo And PM.ProcedureId=QA.ProcedureId And D.IsReversingAgent=0),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+PM.Units+' '+D.DrugName,1) Over (Order By PM.ProcedureId) From ERS_UpperGIPremedication PM, ERS_DrugList D Where PM.DrugNo=D.DrugNo And PM.ProcedureId=QA.ProcedureId And D.IsReversingAgent=0),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+PM.Units+' '+D.DrugName,2) Over (Order By PM.ProcedureId) From ERS_UpperGIPremedication PM, ERS_DrugList D Where PM.DrugNo=D.DrugNo And PM.ProcedureId=QA.ProcedureId And D.IsReversingAgent=0),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+PM.Units+' '+D.DrugName,3) Over (Order By PM.ProcedureId) From ERS_UpperGIPremedication PM, ERS_DrugList D Where PM.DrugNo=D.DrugNo And PM.ProcedureId=QA.ProcedureId And D.IsReversingAgent=0),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+PM.Units+' '+D.DrugName,4) Over (Order By PM.ProcedureId) From ERS_UpperGIPremedication PM, ERS_DrugList D Where PM.DrugNo=D.DrugNo And PM.ProcedureId=QA.ProcedureId And D.IsReversingAgent=0),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+PM.Units+' '+D.DrugName,5) Over (Order By PM.ProcedureId) From ERS_UpperGIPremedication PM, ERS_DrugList D Where PM.DrugNo=D.DrugNo And PM.ProcedureId=QA.ProcedureId And D.IsReversingAgent=0),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+PM.Units+' '+D.DrugName,6) Over (Order By PM.ProcedureId) From ERS_UpperGIPremedication PM, ERS_DrugList D Where PM.DrugNo=D.DrugNo And PM.ProcedureId=QA.ProcedureId And D.IsReversingAgent=0),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+PM.Units+' '+D.DrugName,7) Over (Order By PM.ProcedureId) From ERS_UpperGIPremedication PM, ERS_DrugList D Where PM.DrugNo=D.DrugNo And PM.ProcedureId=QA.ProcedureId And D.IsReversingAgent=0),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+PM.Units+' '+D.DrugName,8) Over (Order By PM.ProcedureId) From ERS_UpperGIPremedication PM, ERS_DrugList D Where PM.DrugNo=D.DrugNo And PM.ProcedureId=QA.ProcedureId And D.IsReversingAgent=0),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+PM.Units+' '+D.DrugName,9) Over (Order By PM.ProcedureId) From ERS_UpperGIPremedication PM, ERS_DrugList D Where PM.DrugNo=D.DrugNo And PM.ProcedureId=QA.ProcedureId And D.IsReversingAgent=0),'') +')' Else '' End,',, ',''),'()',''),'0 ',''),', , ',''),', )',')') As ReversalAgents From ERS_Procedures NP, ERS_UpperGIQA QA Where QA.ProcedureId=NP.ProcedureId */

GO

/* [dbo].[fw_QA] */

/*Create View [dbo].[fw_QA] As /*Colon UGI*/ Select 'U.'+Convert(varchar(3),Case CHARINDEX('1', SUBSTRING(E.[Status], 1, 10)) When '1' Then 1 When '2' Then 2 When '4' Then 5 When '5' Then 6 When '6' Then 7 Else Case IsNull((Select TOP 1 Convert(varchar(1),X.[Procedure type]+3) From [Colon Procedure] X Where X.[Episode No]=E.[Episode No] And X.[Procedure date] Is Not Null),0) When 0 Then (Select TOP 1 Convert(varchar(1),X.[Procedure type]+3) From [Colon Procedure] X Where X.[Episode No]=E.[Episode No] And (X.[Procedure date] Is Not Null) Or X.[Time of procedure] Is Not Null) When 3 Then 3 When 4 Then 4 When 5 Then 5 Else 0 End End)+'.'+Convert(varchar(10),E.[Episode no])+'.'+Convert(varchar(10),Convert(Int,SubString(E.[Patient No],7,6))) As ProcedureId ,Case When QA.[Pat sedation]=4 Then Case QA.[Pat sedation asleep but responding] When 1 Then 4 When 2 Then 5 When 3 Then 6 Else QA.[Pat sedation asleep but responding] End Else QA.[Pat sedation] End As NurseAssPatSedationScore , IsNull(QA.[Pat discomfort],0) As NursesAssPatComfortScore , IsNull(QA.[Pat ass discomfort],0) As PatientsSedationScore , IsNull(Case When QA.[Complications none]=-1 Then 'No complications' Else Replace('Complications:,'+Case When QA.[Damage to scope]=-1 Then ',Damage to scope ('+Case When QA.[Mechanical scope damage]=-1 Then 'mechanical' else 'patient initiated' End+')' +Case When QA.[Poorly tolerated]=-1 Then ', poorly tolerated' Else '' End +Case When QA.Hypoxia=-1 Then ', hypoxia' Else '' End +Case When QA.[Respiratory depression]=-1 Then ', respiratory depression' Else '' End +Case When QA.[Patient discomfort]=-1 Then ', patient discomfort' Else '' End +Case When QA.[Respiratory arrest]=-1 Then ', respiratory arrest requiring' Else '' End +Case When QA.[Patient distress]=-1 Then ', patient distress' Else '' End +Case When QA.[Gastric contents aspiration]=-1 Then ', gastric contents aspiration' Else '' End +Case When QA.[Shock/hypotension]=-1 Then ', shock/hypotension' Else '' End +Case When QA.[Cardiac arrest]=-1 Then ', cardiac arrest' Else '' End +Case When QA.[Failed intubation]=-1 Then ', failed intubation' Else '' End +Case When QA.Haemorrhage=-1 Then ', haemorrhage' Else '' End +Case When QA.[Cardiac arrythmia]=-1 Then ', cardiac arrythmia' Else '' End +Case When QA.[Difficult intubation]=-1 Then ', difficult intubation' Else '' End +Case When QA.[Significant haemorrhage]=-1 Then ', significant haemorrhage requiring transfusion' Else '' End +Case When QA.Death=-1 Then ', dead' Else '' End +Case When QA.Perforation=-1 Then ', '+IsNull(QA.[Perforation text],'') Else '' End +Case When IsNull(QA.[Technical failure],'')<>'' Then ', '+QA.[Technical failure] Else '' End End,',,','') End,'') As Complications , Replace(Replace(Replace(Replace(Replace(Case When (Select Count(*) From [Patient Premedication] PM , [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]=-1)>0 Then (Select Top 1 convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name] From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]=-1)+'(,' +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],0) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],1) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],2) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],3) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],4) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],5) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],6) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],7) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],8) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],9) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +')' Else '' End,',, ',''),'()',''),'0 ',''),', , ',''),', )',')') As ReversalAgents From [Colon Procedure] CP, [Episode] E, [Colon QA] QA Where CP.[Episode No]=E.[Episode No] And QA.[Episode No]=CP.[Episode No] And CP.DNA Is Not Null /*OGD*/ Union All Select 'U.'+Convert(varchar(3),Case CHARINDEX('1', SUBSTRING(E.[Status], 1, 10)) When '1' Then 1 When '2' Then 2 When '4' Then 5 When '5' Then 6 When '6' Then 7 Else Case IsNull((Select TOP 1 Convert(varchar(1),X.[Procedure type]+3) From [Colon Procedure] X Where X.[Episode No]=E.[Episode No] And X.[Procedure date] Is Not Null),0) When 0 Then (Select TOP 1 Convert(varchar(1),X.[Procedure type]+3) From [Colon Procedure] X Where X.[Episode No]=E.[Episode No] And (X.[Procedure date] Is Not Null) Or X.[Time of procedure] Is Not Null) When 3 Then 3 When 4 Then 4 When 5 Then 5 Else 0 End End)+'.'+Convert(varchar(10),E.[Episode no])+'.'+Convert(varchar(10),Convert(Int,SubString(E.[Patient No],7,6))) As ProcedureId ,Case When QA.[Pat sedation]=4 Then Case QA.[Pat sedation asleep but responding] When 1 Then 4 When 2 Then 5 When 3 Then 6 Else QA.[Pat sedation asleep but responding] End Else QA.[Pat sedation] End As NurseAssPatSedationScore , IsNull(QA.[Pat discomfort],0) As NursesAssPatComfortScore , IsNull(QA.[Pat ass discomfort],0) As PatientsSedationScore , IsNull(Case When QA.[Complications none]=-1 Then 'No complications' Else Replace('Complications:,'+Case When QA.[Damage to scope]=-1 Then ',Damage to scope ('+Case When QA.[Mechanical scope damage]=-1 Then 'mechanical' else 'patient initiated' End+')' +Case When QA.[Poorly tolerated]=-1 Then ', poorly tolerated' Else '' End +Case When QA.Hypoxia=-1 Then ', hypoxia' Else '' End +Case When QA.[Respiratory depression]=-1 Then ', respiratory depression' Else '' End +Case When QA.[Patient discomfort]=-1 Then ', patient discomfort' Else '' End +Case When QA.[Respiratory arrest]=-1 Then ', respiratory arrest requiring' Else '' End +Case When QA.[Patient distress]=-1 Then ', patient distress' Else '' End +Case When QA.[Gastric contents aspiration]=-1 Then ', gastric contents aspiration' Else '' End +Case When QA.[Shock/hypotension]=-1 Then ', shock/hypotension' Else '' End +Case When QA.[Cardiac arrest]=-1 Then ', cardiac arrest' Else '' End +Case When QA.[Failed intubation]=-1 Then ', failed intubation' Else '' End +Case When QA.Haemorrhage=-1 Then ', haemorrhage' Else '' End +Case When QA.[Cardiac arrythmia]=-1 Then ', cardiac arrythmia' Else '' End +Case When QA.[Difficult intubation]=-1 Then ', difficult intubation' Else '' End +Case When QA.[Significant haemorrhage]=-1 Then ', significant haemorrhage requiring transfusion' Else '' End +Case When QA.Death=-1 Then ', hypoxia' Else '' End +Case When QA.[Complications other]=-1 Then ', '+IsNull(QA.[Complications other text],'') Else '' End +Case When QA.[Injury to mouth/teeth]=-1 Then ', injury to mouth/teeth' Else '' End +Case When QA.Perforation=-1 Then ', '+IsNull(QA.[Perforation text],'') Else '' End +Case When IsNull(QA.[Technical failure],'')<>'' Then ', '+QA.[Technical failure] Else '' End End,',,','') End,'') As Complications , Replace(Replace(Replace(Replace(Replace(Case When (Select Count(*) From [Patient Premedication] PM , [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]=-1)>0 Then (Select Top 1 convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name] From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]=-1)+'(,' +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],0) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],1) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],2) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],3) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],4) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],5) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],6) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],7) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],8) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],9) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +')' Else '' End,',, ',''),'()',''),'0 ',''),', , ',''),', )',')') As ReversalAgents From [Episode] E , [Upper GI QA] QA Where QA.[Episode No]=E.[Episode No] /*ERCP*/ Union All Select 'U.'+Convert(varchar(3),Case CHARINDEX('1', SUBSTRING(E.[Status], 1, 10)) When '1' Then 1 When '2' Then 2 When '4' Then 5 When '5' Then 6 When '6' Then 7 Else Case IsNull((Select TOP 1 Convert(varchar(1),X.[Procedure type]+3) From [Colon Procedure] X Where X.[Episode No]=E.[Episode No] And X.[Procedure date] Is Not Null),0) When 0 Then (Select TOP 1 Convert(varchar(1),X.[Procedure type]+3) From [Colon Procedure] X Where X.[Episode No]=E.[Episode No] And (X.[Procedure date] Is Not Null) Or X.[Time of procedure] Is Not Null) When 3 Then 3 When 4 Then 4 When 5 Then 5 Else 0 End End)+'.'+Convert(varchar(10),E.[Episode no])+'.'+Convert(varchar(10),Convert(Int,SubString(E.[Patient No],7,6))) As ProcedureId ,Case When QA.[Pat sedation]=4 Then Case QA.[Pat sedation asleep but responding] When 1 Then 4 When 2 Then 5 When 3 Then 6 Else QA.[Pat sedation asleep but responding] End Else QA.[Pat sedation] End As NurseAssPatSedationScore , IsNull(QA.[Pat discomfort],0) As NursesAssPatComfortScore , IsNull(QA.[Pat ass discomfort],0) As PatientsSedationScore , IsNull(Case When QA.[Complications none]=-1 Then 'No complications' Else Replace('Complications:,'+Case When QA.[Damage to scope]=-1 Then ',Damage to scope ('+Case When QA.[Mechanical scope damage]=-1 Then 'mechanical' else 'patient initiated' End+')' +Case When QA.[Poorly tolerated]=-1 Then ', poorly tolerated' Else '' End +Case When QA.Hypoxia=-1 Then ', hypoxia' Else '' End +Case When QA.[Respiratory depression]=-1 Then ', respiratory depression' Else '' End +Case When QA.[Patient discomfort]=-1 Then ', patient discomfort' Else '' End +Case When QA.[Respiratory arrest]=-1 Then ', respiratory arrest requiring' Else '' End +Case When QA.[Patient distress]=-1 Then ', patient distress' Else '' End +Case When QA.[Gastric contents aspiration]=-1 Then ', gastric contents aspiration' Else '' End +Case When QA.[Shock/hypotension]=-1 Then ', shock/hypotension' Else '' End +Case When QA.[Cardiac arrest]=-1 Then ', cardiac arrest' Else '' End +Case When QA.Haemorrhage=-1 Then ', haemorrhage' Else '' End +Case When QA.[Cardiac arrythmia]=-1 Then ', cardiac arrythmia' Else '' End +Case When QA.[Difficult intubation]=-1 Then ', difficult intubation' Else '' End +Case When QA.[Significant haemorrhage]=-1 Then ', significant haemorrhage requiring transfusion' Else '' End +Case When QA.Death=-1 Then ', hypoxia' Else '' End +Case When QA.[Complications other]=-1 Then ', '+IsNull(QA.[Complications other text],'') Else '' End +Case When QA.[Injury to mouth/teeth]=-1 Then ', injury to mouth/teeth' Else '' End +Case When QA.Perforation=-1 Then ', '+IsNull(QA.[Perforation text],'') Else '' End +Case When IsNull(QA.[Technical failure],'')<>'' Then ', '+QA.[Technical failure] Else '' End +Case When QA.[Allergy to medium]=-1 Then ', allergy to medium' Else '' End +Case When QA.[Contrast extravasation]=-1 Then ', contrast extravasation' Else '' End +Case When QA.Arcinarisation=-1 Then ', acinirisation of the parenchyma' Else '' End +Case When QA.[Failed ERC/ERP]=-1 Then ', failed ERC/ERP' Else '' End +Case When QA.[Failed cannulation]=-1 Then ', failed cannulation' Else '' End +Case When QA.[Allergy to medium]=-1 Then ', allergy to medium' Else '' End +Case When QA.[Failed stent insertion]=-1 Then ', failed stent insertion' Else '' End End,',,','') End,'') As Complications , Replace(Replace(Replace(Replace(Replace(Case When (Select Count(*) From [Patient Premedication] PM , [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]=-1)>0 Then (Select Top 1 convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name] From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]=-1)+'(,' +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],0) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],1) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],2) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],3) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],4) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],5) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],6) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],7) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],8) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+D.Units+' '+D.[Drug name],9) Over (Order By PM.[Episode No], PM.[Drug no]) From [Patient Premedication] PM, [Drug list] D Where PM.[Drug No]=D.[Drug No] And PM.[Episode No]=QA.[Episode No] And PM.[Patient No]=E.[Patient No] And D.[Is reversing agent]<>-1),'') +')' Else '' End,',, ',''),'()',''),'0 ',''),', , ',''),', )',')') As ReversalAgents From [Episode] E , [ERCP QA] QA Where QA.[Episode No]=E.[Episode No] Union All /*ERS*/ Select 'E.'+Convert(Varchar(10),NP.ProcedureId) As ProcedureId ,Case When QA.PatSedation=4 Then Case QA.PatSedationAsleepResponseState When 1 Then 4 When 2 Then 5 When 3 Then 6 Else QA.PatSedationAsleepResponseState End Else QA.PatSedation End As NurseAssPatSedationScore , IsNull(QA.PatDiscomfort,0) As NursesAssPatComfortScore , IsNull(QA.PatSedation,0) As PatientsSedationScore , Case When QA.ComplicationsNone=1 Then 'No complications' Else Replace('Complications:' +Case When QA.DamageToScope=1 Then ',Damage to scope ('+Case When QA.DamageToScopeType=0 Then 'mechanical' else 'patient initiated' End+')' Else '' End +Case When QA.PoorlyTolerated=1 Then ', poorly tolerated' Else '' End +Case When QA.Hypoxia=1 Then ', hypoxia' Else '' End +Case When QA.RespiratoryDepression=1 Then ', respiratory depression' Else '' End +Case When QA.PatientDiscomfort=1 Then ', patient discomfort' Else '' End +Case When QA.RespiratoryArrest=1 Then ', respiratory arrest requiring' Else '' End +Case When QA.PatientDistress=1 Then ', patient distress' Else '' End +Case When QA.GastricContentsAspiration=1 Then ', gastric contents aspiration' Else '' End +Case When QA.ShockHypotension=1 Then ', shock/hypotension' Else '' End +Case When QA.CardiacArrest=1 Then ', cardiac arrest' Else '' End +Case When QA.FailedIntubation=1 Then ', failed intubation' Else '' End +Case When QA.Haemorrhage=1 Then ', haemorrhage' Else '' End +Case When QA.CardiacArrythmia=1 Then ', cardiac arrythmia' Else '' End +Case When QA.DifficultIntubation=1 Then ', difficult intubation' Else '' End +Case When QA.SignificantHaemorrhage=1 Then ', significant haemorrhage requiring transfusion' Else '' End +Case When QA.Death=1 Then ', dead' Else '' End +Case When QA.ComplicationsOther=1 Then ', '+QA.ComplicationsOtherText Else '' End +Case When QA.TechnicalFailure<>'' Then ', '+QA.TechnicalFailure Else '' End +Case When QA.Perforation=1 Then ', '+QA.PerforationText Else '' End ,':,',':') End As Complications , Replace(Replace(Replace(Replace(Replace(Case When (Select Count(*) From ERS_UpperGIPremedication PM, ERS_DrugList D Where PM.DrugNo=D.DrugNo And PM.ProcedureId=QA.ProcedureId And D.IsReversingAgent=1)>0 Then (Select Top 1 convert(varchar(10),PM.Dose)+' '+PM.Units+' '+PM.DrugName From ERS_UpperGIPremedication PM, ERS_DrugList D Where PM.DrugNo=D.DrugNo And PM.ProcedureId=QA.ProcedureId And D.IsReversingAgent=1)+'(,' +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+PM.Units+' '+D.DrugName,0) Over (Order By PM.ProcedureId) From ERS_UpperGIPremedication PM, ERS_DrugList D Where PM.DrugNo=D.DrugNo And PM.ProcedureId=QA.ProcedureId And D.IsReversingAgent=0),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+PM.Units+' '+D.DrugName,1) Over (Order By PM.ProcedureId) From ERS_UpperGIPremedication PM, ERS_DrugList D Where PM.DrugNo=D.DrugNo And PM.ProcedureId=QA.ProcedureId And D.IsReversingAgent=0),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+PM.Units+' '+D.DrugName,2) Over (Order By PM.ProcedureId) From ERS_UpperGIPremedication PM, ERS_DrugList D Where PM.DrugNo=D.DrugNo And PM.ProcedureId=QA.ProcedureId And D.IsReversingAgent=0),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+PM.Units+' '+D.DrugName,3) Over (Order By PM.ProcedureId) From ERS_UpperGIPremedication PM, ERS_DrugList D Where PM.DrugNo=D.DrugNo And PM.ProcedureId=QA.ProcedureId And D.IsReversingAgent=0),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+PM.Units+' '+D.DrugName,4) Over (Order By PM.ProcedureId) From ERS_UpperGIPremedication PM, ERS_DrugList D Where PM.DrugNo=D.DrugNo And PM.ProcedureId=QA.ProcedureId And D.IsReversingAgent=0),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+PM.Units+' '+D.DrugName,5) Over (Order By PM.ProcedureId) From ERS_UpperGIPremedication PM, ERS_DrugList D Where PM.DrugNo=D.DrugNo And PM.ProcedureId=QA.ProcedureId And D.IsReversingAgent=0),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+PM.Units+' '+D.DrugName,6) Over (Order By PM.ProcedureId) From ERS_UpperGIPremedication PM, ERS_DrugList D Where PM.DrugNo=D.DrugNo And PM.ProcedureId=QA.ProcedureId And D.IsReversingAgent=0),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+PM.Units+' '+D.DrugName,7) Over (Order By PM.ProcedureId) From ERS_UpperGIPremedication PM, ERS_DrugList D Where PM.DrugNo=D.DrugNo And PM.ProcedureId=QA.ProcedureId And D.IsReversingAgent=0),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+PM.Units+' '+D.DrugName,8) Over (Order By PM.ProcedureId) From ERS_UpperGIPremedication PM, ERS_DrugList D Where PM.DrugNo=D.DrugNo And PM.ProcedureId=QA.ProcedureId And D.IsReversingAgent=0),'') +', '+IsNull((Select Top 1 Lead(convert(varchar(10),PM.Dose)+' '+PM.Units+' '+D.DrugName,9) Over (Order By PM.ProcedureId) From ERS_UpperGIPremedication PM, ERS_DrugList D Where PM.DrugNo=D.DrugNo And PM.ProcedureId=QA.ProcedureId And D.IsReversingAgent=0),'') +')' Else '' End,',, ',''),'()',''),'0 ',''),', , ',''),', )',')') As ReversalAgents From ERS_Procedures NP, ERS_UpperGIQA QA Where QA.ProcedureId=NP.ProcedureId */

GO

/* [dbo].[fw_Indications] */

Create View [dbo].[fw_Indications] As Select UP.ProcedureId, UP.IndicationID, TT.Indication, TT.NedName From ( Select 'E.'+Convert(varchar(10),P.ProcedureId) As ProcedureId , Case When UT.AbdominalPain=1 Then 2 End As AbdominalPain , Case When UT.AbnormalityOnBarium=1 Then 3 End As AbnormalityOnBarium , Case When UT.Allergy=1 Then 0 End As Allergy , Case When UT.AllergyDesc=1 Then 0 End As AllergyDesc , Case When UT.Anaemia=1 Then 4 End As Anaemia , Case When UT.Angina=1 Then 1 End As Angina , Case When UT.Asthma=1 Then 1 End As Asthma , Case When UT.BalloonInsertion=1 Then 1 End As BalloonInsertion , Case When UT.BalloonRemoval=1 Then 1 End As BalloonRemoval , Case When UT.BariatricPreAssessment=1 Then 1 End As BariatricPreAssessment , Case When UT.BarrettsOesophagus=1 Then 5 End As BarrettsOesophagus , Case When UT.BiliaryLeak=1 Then 47 End As BiliaryLeak , Case When UT.BreathTest=1 Then 1 End As BreathTest , Case When UT.Cancer=1 Then Case When P.ProcedureType IN (3,4,5) Then 28 End End As Cancer , Case When UT.ChestPain=1 Then 1 End As ChestPain , Case When UT.ChronicLiverDisease=1 Then 1 End As ChronicLiverDisease , Case When UT.CoeliacDisease=1 Then 1 End As CoeliacDisease , Case When UT.CoffeeGroundsVomit=1 Then 12 End As CoffeeGroundsVomit , Case When UT.ColonAbdominalMass=1 Then 25 End As ColonAbdominalMass , Case When UT.ColonAbdominalPain=1 Then 2 End As ColonAbdominalPain , Case When UT.ColonAbnormalBariumEnema=1 Then 1 End As ColonAbnormalBariumEnema , Case When UT.ColonAbnormalCTScan=1 Then 1 End As ColonAbnormalCTScan , Case When UT.ColonAbnormalSigmoidoscopy=1 Then 26 End As ColonAbnormalSigmoidoscopy , Case When UT.ColonAlterBowelHabit=1 Then 1 End As ColonAlterBowelHabit , Case When UT.ColonAnaemia=1 Then 1 End As ColonAnaemia , Case When UT.ColonAssessment=1 Then 1 End As ColonAssessment , Case When UT.ColonBowelCancerScreening=1 Then 1 End As ColonBowelCancerScreening , Case When UT.ColonCarcinoma=1 Then 1 End As ColonCarcinoma , Case When UT.ColonColonicObstruction=1 Then 1 End As ColonColonicObstruction , Case When UT.ColonDysplasia=1 Then 1 End As ColonDysplasia , Case When UT.ColonFamily=1 Then 1 End As ColonFamily , Case When UT.ColonPolyps=1 Then 41 End As ColonPolyps , Case When UT.ColonRectalBleeding=1 Then 40 End As ColonRectalBleeding , Case When UT.ColonSurveillance=1 Then 1 End As ColonSurveillance , Case When UT.ColonSreeningColonoscopy=1 Then 1 End As ColonSreeningColonoscopy , Case When UT.COPD=1 Then 1 End As COPD , Case When UT.DiabetesMellitus=1 Then 1 End As DiabetesMellitus , Case When UT.Dyspepsia=1 Then 7 End As Dyspepsia , Case When UT.Dysphagia=1 Then 8 End As Dysphagia , Case When UT.Epilepsy=1 Then 1 End As Epilepsy From dbo.ERS_Procedures P LEFT OUTER JOIN dbo.ERS_UpperGIIndications UT ON P.ProcedureId = UT.ProcedureId ) As PT UNPIVOT ( IndicationID FOR Therapies IN (AbdominalPain, AbnormalityOnBarium, Allergy, AllergyDesc, Anaemia, Angina, Asthma, BalloonInsertion, BalloonRemoval, BariatricPreAssessment, BarrettsOesophagus , BiliaryLeak, BreathTest, Cancer, ChestPain, ChronicLiverDisease, CoeliacDisease, CoffeeGroundsVomit, ColonAbdominalMass, ColonAbdominalPain, ColonAbnormalBariumEnema, ColonAbnormalCTScan , ColonAbnormalSigmoidoscopy, ColonAlterBowelHabit, ColonAnaemia, ColonAssessment, ColonBowelCancerScreening, ColonCarcinoma, ColonColonicObstruction, ColonDysplasia, ColonFamily , ColonPolyps, ColonRectalBleeding, ColonSurveillance, ColonSreeningColonoscopy, COPD, DiabetesMellitus, Dyspepsia, Dysphagia, Epilepsy) ) As UP LEFT OUTER JOIN ERS_IndicationsTypes TT ON UP.IndicationID=TT.IndicationID Union Select UP.ProcedureId, UP.IndicationID, TT.Indication, TT.NedName From ( Select 'U.'+Convert(varchar(3),Case CHARINDEX('1', SUBSTRING(E.[Status], 1, 10)) When '1' Then 1 When '2' Then 2 When '5' Then 6 When '6' Then 7 Else Case IsNull((Select TOP 1 Convert(varchar(1),X.[Procedure type]+3) From [Colon Procedure] X Where X.[Episode No]=E.[Episode No] And X.[Procedure date] Is Not Null),0) When 0 Then (Select TOP 1 Convert(varchar(1),X.[Procedure type]+3) From [Colon Procedure] X Where X.[Episode No]=E.[Episode No] And (X.[Procedure date] Is Not Null) Or X.[Time of procedure] Is Not Null) When 3 Then 3 When 4 Then 4 When 5 Then 5 Else 0 End End)+'.'+Convert(varchar(10),E.[Episode no])+'.'+Convert(varchar(10),Convert(Int,SubString(E.[Patient No],7,6))) As ProcedureId , Case When T.[Abdominal mass]=-1 Then 25 End As AbdominalMass , Case When T.[Abdominal pain]=-1 Then 2 End As AbdominalPain , Case When T.[Abnormal barium enema]=-1 Then 3 End As AbnormalBariumEnema , Case When T.[Abnormal capsule study]=-1 Then 1 End As AbnormalCapsuleStudy , Case When T.[Abnormal MRI]=-1 Then 1 End As AbnormalMRI , Case When T.[Abnormal sigmoidoscopy]=-1 Then 26 End As AbnormalSigmoidoscopy , Case When T.AbnormalCTScan=-1 Then 1 End As AbnormalCTScan , Case When T.Allergy=-1 Then 1 End As Allergy , Case When T.[Altered bowel habit]=-1 Then 1 End As AlteredBowelHabit , Case When T.[Amsterdam criteria]=-1 Then 1 End As AmsterdamCriteria , Case When T.Anaemia=-1 Then 4 End As Anaemia , Case When T.Cancer=-1 Then 28 End As Cancer , Case When T.[Colitis assessment]=-1 Then 1 End As ColitisAssessment , Case When T.[Colitis surveillance]=-1 Then 1 End As ColitisSurveillance , Case When T.[Colonic obstruction]=-1 Then 1 End As ColonicObstruction , Case When T.FOBT=-1 Then 1 End As FOBT , Case When T.Melaena=-1 Then 11 End As Melaena , Case When T.[Polyposis syndrome]=-1 Then 38 End As PolyposisSindrome , Case When T.[Potentially damaging drug]=-1 Then 1 End As PotentiallyDamageDrug , Case When T.[Rectal bleeding]=-1 Then 40 End As RectalBleeding , Case When T.StentInsertion=-1 Then 19 End As StentInsertion , Case When T.StentRemoval=-1 Then 20 End As StentRemoval , Case When T.StentReplacement=-1 Then 18 End As StentReplacement , Case When T.[Tumour assessment]=-1 Then 42 End As TumourAssessment , Case When T.[Weight loss]=-1 Then 23 End As WeightLoss From Episode E LEFT OUTER JOIN [Colon Indications] T ON T.[Episode No]=E.[Episode No] And T.[Patient No]=E.[Patient No] ) As PT UNPIVOT ( IndicationID FOR Therapies IN (AbdominalMass, AbdominalPain, AbnormalBariumEnema, AbnormalCapsuleStudy, AbnormalMRI, AbnormalSigmoidoscopy, Allergy, AlteredBowelHabit , AmsterdamCriteria, Anaemia, Cancer, ColitisAssessment, ColitisSurveillance, ColonicObstruction, FOBT, Melaena, PolyposisSindrome, PotentiallyDamageDrug, RectalBleeding , StentInsertion, StentRemoval, StentReplacement, TumourAssessment, WeightLoss) ) As UP LEFT OUTER JOIN ERS_IndicationsTypes TT ON UP.IndicationID=TT.IndicationID Union Select UP.ProcedureId, UP.IndicationID, TT.Indication, TT.NedName From ( Select 'U.'+Convert(varchar(3),Case CHARINDEX('1', SUBSTRING(E.[Status], 1, 10)) When '1' Then 1 When '2' Then 2 When '5' Then 6 When '6' Then 7 Else Case IsNull((Select TOP 1 Convert(varchar(1),X.[Procedure type]+3) From [Colon Procedure] X Where X.[Episode No]=E.[Episode No] And X.[Procedure date] Is Not Null),0) When 0 Then (Select TOP 1 Convert(varchar(1),X.[Procedure type]+3) From [Colon Procedure] X Where X.[Episode No]=E.[Episode No] And (X.[Procedure date] Is Not Null) Or X.[Time of procedure] Is Not Null) When 3 Then 3 When 4 Then 4 When 5 Then 5 Else 0 End End)+'.'+Convert(varchar(10),E.[Episode no])+'.'+Convert(varchar(10),Convert(Int,SubString(E.[Patient No],7,6))) As ProcedureId , Case When T.[Abnormal capsule study]=-1 Then 1 End As AbnormalCapsuleStudy , Case When T.[Abdominal pain]=-1 Then 2 End As AbdominalPain , Case When T.[Abnormal MRI]=-1 Then 1 End As AbnormalMRI , Case When T.Allergy=-1 Then 1 End As Allergy , Case When T.Aneamia=-1 Then 4 End As Anaemia , Case When T.Cancer=-1 Then 28 End As Cancer , Case When T.[Chest pain]=-1 Then 1 End As ChestPain , Case When T.[Chronic liver disease]=-1 Then 1 End As ChronicLiverDisease , Case When T.[Coeliac disease]=-1 Then 1 End As CoeliacDisease , Case When T.[Coffee grounds vomit]=-1 Then 12 End As CofeeGroundsVomit , Case When T.Melaena=-1 Then 11 End As Melaena , Case When T.Diarrhoea=-1 Then 6 End As Diarrhoea , Case When T.[Potentially damaging drug]=-1 Then 1 End As PotentiallyDamageDrug , Case When T.[Double balloon enteroscopy]=-1 Then 1 End As DoubleBalloonEnteroscopy , Case When T.StentInsertion=-1 Then 19 End As StentInsertion , Case When T.StentRemoval=-1 Then 20 End As StentRemoval , Case When T.StentReplacement=-1 Then 18 End As StentReplacement , Case When T.[Balloon Insertion]=-1 Then 1 End As BalloonInsertion , Case When T.[Weight loss]=-1 Then 23 End As WeightLoss , Case When T.[Balloon Removal]=-1 Then 1 End As BalloonRemoval , Case When T.[Bariatric pre-assessment]=-1 Then 1 End As BariatricPreAssessment , Case When T.[Barrett's oesophagus]=-1 Then 5 End As BarretsOesophagus , Case When T.[Breath test]=-1 Then 1 End As BreathTest , Case When T.[Drug trial]=-1 Then 1 End As DrugTrial , Case When T.[Previous surgery]=-1 Then 1 End As PreviousSurgery , Case When T.[Previous examination]=-1 Then 1 End As PreviousExamination , Case When T.Haematemesis=-1 Then 9 End As Haematemesis , Case When T.[Insertion of pH probe]=-1 Then 1 End As InsertionOfpHProbe , Case When T.[Jejunostomy insertion]=-1 Then 1 End As JejunostomyInsertion , Case When T.Dysphagia=-1 Then 8 End As Dysphagia , Case When T.Dyspepsia=-1 Then 7 End As Dyspepsia , Case When T.[Nasoduodenal tube]=-1 Then 1 End As NasoduodenalTube , Case When T.[Nausea and or vomiting]=-1 Then 12 End As NauseaAndOrVomiting , Case When T.Odynophagia=-1 Then 13 End As Odynophagia , Case When T.[Oeso dilatation]=-1 Then 1 End As OesoDilatation , Case When T.[Oesophageal varices]=-1 Then 1 End As OesoVarices , Case When T.Oesophagitis=-1 Then 1 End As Oesophagitis , Case When T.[PEG removal]=-1 Then 16 End As PEGRemoval , Case When T.[PEG replacement]=-1 Then 14 End As PEGReplacement , Case When T.[Post bariatric surgery assessment]=-1 Then 1 End As PostBariatricSurgeryAssessment , Case When T.[Potentially damaging drug]=-1 Then 1 End As PotentiallyDamagingDrug , Case When T.[Push enteroscopy]=-1 Then 1 End As PushEnteroscopy , Case When T.[Reflux symptoms]=-1 Then 1 End As RefluxSymptoms , Case When T.[Serology test]=-1 Then 1 End As SerologyTest , Case When T.[Single balloon enteroscopy]=-1 Then 1 End As SingleBalloonEnteroscopy , Case When T.[Small bowel biopsy]=-1 Then 1 End As SmallBowelBiopsy , Case When T.[stool antigen test]=-1 Then 1 End As StoolAntigenTest , Case When T.[Surgery follow up proc]=-1 Then 1 End As SurgeryFollowUpProc , Case When T.[Ulcer exclusion]=-1 Then 1 End As UlcerExclusion , Case When T.[Urease test]=-1 Then 1 End As UreaseTest From Episode E LEFT OUTER JOIN [Upper GI Indications] T ON T.[Episode No]=E.[Episode No] And T.[Patient No]=E.[Patient No] ) As PT UNPIVOT ( IndicationID FOR Therapies IN (AbnormalCapsuleStudy, AbdominalPain, AbnormalMRI, Allergy, Anaemia, Cancer, ChestPain, ChronicLiverDisease, CoeliacDisease, CofeeGroundsVomit , Melaena, Diarrhoea, PotentiallyDamageDrug, DoubleBalloonEnteroscopy, StentInsertion, StentRemoval, StentReplacement, BalloonInsertion, WeightLoss, BalloonRemoval , BariatricPreAssessment, BarretsOesophagus, BreathTest, DrugTrial, PreviousSurgery, PreviousExamination, InsertionOfpHProbe, JejunostomyInsertion, Dysphagia, Dyspepsia , NasoduodenalTube, NauseaAndOrVomiting, Odynophagia, OesoDilatation, OesoVarices, Oesophagitis, PEGRemoval, PEGReplacement, PostBariatricSurgeryAssessment , PotentiallyDamagingDrug, PushEnteroscopy, RefluxSymptoms, SerologyTest, SingleBalloonEnteroscopy, SmallBowelBiopsy, StoolAntigenTest, SurgeryFollowUpProc, UlcerExclusion , UreaseTest) ) As UP LEFT OUTER JOIN ERS_IndicationsTypes TT ON UP.IndicationID=TT.IndicationID 

GO


/* [dbo].[fw_ColonExtentOfIntubation] */

Create View [dbo].[fw_ColonExtentOfIntubation] As Select 'U.'+Convert(varchar(3),CP.[Procedure type]+3)+'.'+Convert(varchar(10),E.[Episode No])+'.'+Convert(Varchar(10),Convert(Int,SubString(E.[Patient No],7,6))) As ProcedureId , 1 As Insertion , Case EL.[Insertion complete] When -1 Then 1 Else 0 End As InsertionComplete , Case EL.[Insertion to caecum] When -1 Then 1 Else 0 End As InsertionToCaecum , Case EL.[Insertion to terminal ilium] When -1 Then 1 Else 0 End As InsertionToTerminalIleum , Case EL.[Insertion to neo-terminal ilium] When -1 Then 1 Else 0 End As InsertionToNeoTerminalIleum , Case EL.[Insertion to anastomosis] When -1 Then 1 Else 0 End As InsertionToAnastomosis , 1-Case EL.[Insertion complete] When -1 Then 1 Else 0 End-Case EL.[Insertion to caecum] When -1 Then 1 Else 0 End-Case EL.[Insertion to terminal ilium] When -1 Then 1 Else 0 End-Case EL.[Insertion to neo-terminal ilium] When -1 Then 1 Else 0 End-Case EL.[Insertion to anastomosis] When -1 Then 1 Else 0 End As InsertionFailed , Case EL.[Insertion via] When 0 Then 'anus' When 1 Then 'colostomy' When 2 Then 'loop colostomy' When 3 Then 'caecostomy' When 4 Then 'ileostomy' Else '' End As InsertionVia , Case EL.[Rectal exam (PR)] When 1 Then 'Not done' Else 'Done' End As RectalExam , Case EL.[Retroflexion in rectum] When 1 then 'Not done' Else 'Done' End As Retroflexion , Case When EL.[Specific distance]=-1 Then 'Specific distance' Else '' End +Case When EL.[Insertion not recorded]=-1 Then 'Not recorded' Else '' End +Case When EL.[Insertion complete]=-1 Then 'Complete' Else '' End +Case When EL.[Insertion to proximal sigmoid]=-1 Then 'Proximal sigmoid' Else '' End +Case When EL.[Insertion to mid transverse]=-1 Then 'Mid transverse' Else '' End +Case When EL.[Insertion to caecum]=-1 Then 'Caecum' Else '' End +Case When EL.[Insertion to distal descending]=-1 Then 'Distal descending' Else '' End +Case When EL.[Insertion to proximal transverse]=-1 Then 'Proximal transverse' Else '' End +Case When EL.[Insertion to terminal ilium]=-1 Then 'Terminal ileum' Else '' End +Case When EL.[Insertion to rectum]=-1 Then 'Rectum' Else '' End +Case When EL.[Insertion to proximal descending]=-1 Then 'Proximal descending' Else '' End +Case When EL.[Insertion to hepatic flexure]=-1 Then 'Hepatic flexure' Else '' End +Case When EL.[Insertion to terminal ilium]=-1 Then 'Neo-terminal ileum' Else '' End +Case When EL.[Insertion to recto sigmoid]=-1 Then 'Recto-sigmoid' Else '' End +Case When EL.[Insertion to splenic flexure]=-1 Then 'Splenic flexure' Else '' End +Case When EL.[Insertion to distal ascending]=-1 Then 'Distal ascending' Else '' End +Case When EL.[Insertion to distal sigmoid]=-1 Then 'Distal sigmoid' Else '' End +Case When EL.[Insertion to distal transverse]=-1 Then 'Distal transverse' Else '' End +Case When EL.[Insertion to proximal ascending]=-1 Then 'Proximal ascending' Else '' End +Case When EL.[Insertion to anastomosis]=-1 Then 'Anastomosis' Else '' End As InsertedTo , EL.[Specific distance] As EspecificDistance , Case EL.[Insertion confirmed by] When 0 Then '(none)' When 1 Then 'Photo' When 2 Then 'Anastamosis' When 3 Then 'Tri radiate fold' When 4 Then 'Ileocaecal valve' Else '' End As ConfirmedBy , Case EL.[Insertion limited by] When 0 Then '(none)' When 1 Then 'patient discomfort' When 2 Then 'inadequate bowel preparation' When 3 Then 'excess looping' When 4 Then 'bowel redundancy' When 5 Then 'instrument inadequacy' When 6 Then 'pathology encountered' When 7 Then 'excess blood' Else '' End As LimitedBy , Case EL.[Difficulties encountered] When 0 Then '(none)' When 1 Then 'Deep seated caecum' When 2 Then 'tortuous colon' Else '' End As DifficultiesEncountered From [Colon Extent/Limiting Factors] EL, Episode E, [Colon Procedure] CP Where EL.[Episode No]=E.[Episode No] And EL.[Patient No]=E.[Patient No] And E.[Episode No]=CP.[Episode No] And E.[Patient No]=CP.[Patient No] And CP.[Procedure date] Is Not Null Union All Select 'E.'+Convert(varchar(10),EI.ProcedureId) As ProcedureId , 1 As Insertion , Case When EI.InsertionTo In (6,5,9,13,15) Then 1 Else 0 End As InsertionComplete , Case When EI.InsertionTo=5 Then 1 Else 0 End As InsertionToCaecum , Case When EI.InsertionTo=9 Then 1 Else 0 End As InsertionToTerminalIleum , Case When EI.InsertionTo=13 Then 1 Else 0 End As InsertionToNeoTerminalIleum , Case When EI.InsertionTo=15 Then 1 Else 0 End As InsertionToAnastomosis , 1-Case When EI.InsertionTo=6 Then 1 Else 0 End-Case When EI.InsertionTo=5 Then 1 Else 0 End-Case When EI.InsertionTo=9 Then 1 Else 0 End-Case When EI.InsertionTo=13 Then 1 Else 0 End-Case When EI.InsertionTo=15 Then 1 Else 0 End As InsertionFailed , Case EI.InsertionVia When 1 Then 'anus' When 2 Then 'colostomy' When 3 Then 'loop colostomy' When 4 Then 'caecostomy' When 5 Then 'ileostomy' Else'' End As InsertionVia , Case EI.RectalExam When 0 Then 'Not done' Else 'Done' End As RectalExam , Case EI.Retroflexion When 0 Then 'Not done' Else 'Done' End As Retroflexion , Case EI.InsertionTo When 1 then 'Specific distance' When 2 then 'Not recorded' When 3 then 'Proximal sigmoid' When 4 then 'Mid transverse ' When 5 then 'Caecum' When 6 then 'Complete' When 7 then 'Distal descending' When 8 then 'Proximal transverse' When 9 then 'Terminal ileum' When 10 then 'Rectum' When 11 then 'Proximal descending' When 12 then 'Hepatic flexure' When 13 then 'Neo-terminal ileum' When 14 then 'Recto-sigmoid' When 15 then 'Splenic flexure' When 16 then 'Distal ascending' When 17 then 'Distal sigmoid' When 18 then 'Distal transverse' When 19 then 'Proximal ascending' When 20 then 'Anastomosis' End As InsertedTo , EI.SpecificDistanceCm As EspecificDistance , Case EI.InsertionConfirmedBy When 0 Then '(none)' Else '' End As ConfirmedBy , Case EI.InsertionLimitedBy When 0 Then '(none)' When 1 Then 'bowel redundancy' When 2 Then 'excess blood' When 3 Then 'excess looping' When 4 Then 'inadequate bowel preparation' When 5 Then 'instrument inadequacy' When 6 Then 'pathology encountered' When 7 Then 'excess blood' Else '' End AS LimitedBy , Case EI.DifficultiesEncountered When 0 Then '(none)' When 1 Then 'Deep seated caecum' When 2 Then 'tortuous colon' Else '' End As DifficultiesEncountered From ERS_ColonExtentOfIntubation EI, ERS_Procedures PR Where EI.ProcedureId=PR.ProcedureId 

GO
