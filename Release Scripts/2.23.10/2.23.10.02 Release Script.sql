------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	
-- TFS#	
-- Description of change
-- 
------------------------------------------------------------------------------------------------------------------------
GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO

---------------------------------------------------------
-- Update script for release 2.23.10.02
---------------------------------------------------------
DECLARE @Version AS VARCHAR(40) = '2.23.10.02'

IF NOT EXISTS(SELECT * FROM DBversion WHERE VersionNum = @Version)
	BEGIN 
		-- First time the script has been run
		INSERT INTO DBVersion VALUES (@Version, GETDATE())
	END 
ELSE
	BEGIN 
		-- script run more than once
		DECLARE @DBVersionCount as INT 

		SELECT @DBVersionCount = COUNT(*) 
		FROM DBVersion WHERE VersionNum = @Version

		INSERT INTO DBVersion VALUES (@Version + ' (' + CONVERT(VARCHAR, @DBVersionCount) + ')', GETDATE())
	END 
GO
---------------------------------------------------------
GO 

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea Johnson 02.10.23
-- TFS#	3452
-- Description of change
-- Required field checks added before making complete
------------------------------------------------------------------------------------------------------------------------
GO



------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Partha Kundu
-- TFS#	3298
-- Description of change: SSO functionality added for Scotland SSO  
-- 
------------------------------------------------------------------------------------------------------------------------
GO
IF  (NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = 'dbo' AND TABLE_NAME = 'ERS_SSOHealthBoardADGroupMap'))
CREATE TABLE [ERS_SSOHealthBoardADGroupMap](
	[RoleGroupMapId] [int] IDENTITY(1,1) NOT NULL,
	[GroupName] [nvarchar](150) NULL,
	[RoleId] [int] NULL,
	[TrustId] [int] NULL,
	[isSupressed] [bit] NULL,
	[GroupDescription] [nvarchar](150) NULL
) ON [PRIMARY]
GO
dbo.DropIfExist
    @ObjectName = 'fnGetTrustByHealthBoardSSO',      -- varchar(100)
    @ObjectTypePrefix = 'F' -- varchar(5)
GO
PRINT 'Creating Procedure dbo.fnGetTrustByHealthBoardSSO'
GO
Create   Function [dbo].[fnGetTrustByHealthBoardSSO]
(
	@groups nvarchar(4000)
)
returns int
As
Begin
declare @TrustId as int
	select distinct @TrustId = TrustId
	from ERS_SSOHealthBoardADGroupMap 
	where  isSupressed=0
	and ','+@groups+',' LIKE '%,'+GroupName+',%'

	return @TrustId

end

GO
dbo.DropIfExist
    @ObjectName = 'ERS_SSOGetTrustFromADGroupName',      -- varchar(100)
    @ObjectTypePrefix = 'S' -- varchar(5)
GO
PRINT 'Creating Procedure dbo.ERS_SSOGetTrustFromADGroupName'
GO

GO 
create   Procedure  [dbo].[ERS_SSOGetTrustFromADGroupName]
(
	@groups nvarchar(4000)
)

As
Begin

  select  * from ERS_Trusts
  where TrustID in(
	select  TrustId
	from ERS_SSORoleADGroupMap
	where  isSupressed=0
	and ','+@groups+',' LIKE '%,'+GroupName+',%')
end

go
dbo.DropIfExist
    @ObjectName = 'ERS_SSOInsertUserForTrust',      -- varchar(100)
    @ObjectTypePrefix = 'S' -- varchar(5)
GO
PRINT 'Creating Procedure dbo.ERS_SSOInsertUserForTrust'
GO

Create   Procedure [dbo].[ERS_SSOInsertUserForTrust]
(
	@Username  nvarchar(200),
	@Forename  nvarchar(200),
	@Surname  nvarchar(200),
	@Fullname  nvarchar(200),
	@OperatingHospitalId int,
	@groups nvarchar(4000)
)

AS
begin 
	declare @Title as  nvarchar(20)='',
	@Initials as  nvarchar(20)='',
	@Qualifications as  nvarchar(20)='',

	@JobTitleId as  nvarchar(20)='',
	@LoggedInUserId as int=999,
	@GMCCode as  nvarchar(20)='',

	@IsGI as  bit=0,
	@CanRunAK as  bit=0,
	@IsListConsultant as  bit=0,
	@IsEndoscopist1 as  bit=0,
	@IsEndoscopist2 as  bit=0,
	@IsAssistantOrTrainee as  bit=0,
	@IsNurse1 as  bit=0,
	@IsNurse2 as  bit=0,
	@Suppressed as  bit=0,
	@ShowTooltips as  bit=0,
	@CanEditDropdowns as  bit=0,
	@CanViewAllUserAudits as  bit=0,
	@newUserId as int,
	@ExistingUserId as int,
	@UserId as int,
	@trustId as int,
	@GroupName as Nvarchar(100),
	@RoleIDs as  Nvarchar(100),
	@ReadOnlyRoleID as  Nvarchar(100),
	@UserRoleIds as Nvarchar(200)


	select @trustId =TrustId  
	from ERS_OperatingHospitals 
	where OperatingHospitalId=@OperatingHospitalId

	select  @ReadOnlyRoleID= RoleId 
	from ERS_Roles
	where TrustId=@trustId
	and RoleName='Read Only'



	select @UserId = userid ,
	     @UserRoleIds=RoleID
	from  ERS_Users
	where  username=@Username



	if @ReadOnlyRoleID is Null 
	begin
		if @UserId is not null
			update ERS_Users
			set ExpiresOn=DateAdd(DAY,-1,GETDATE()),
			LastUpdated=GETDATE()
			where UserId=@UserId

		Return 1
	end
	ELSE
	BEGIN

			if @UserId is null 
				Begin
					INSERT INTO ERS_Users (
						RecordCreated,
						LastUpdated, 
						ExpiresOn,
						Username, 
						[Password], 
						PasswordExpiresOn,
						Title, 
						Forename, 
						Surname,
						Initials,
						[Description],
						Qualifications, 
						IsGIConsultant, 
						JobTitleId, 
						RoleID,
						CanRunAK, 
						IsListConsultant,
						IsEndoscopist1, 
						IsEndoscopist2, 
						IsAssistantOrTrainee, 
						IsNurse1, 
						IsNurse2, 
						ResetPassword, 
						Suppressed, 
						ShowTooltips, 
						GMCCode,
						CanEditDropdowns, 
						CanViewAllUserAudits, 
						WhoCreatedId, 
						WhenCreated) 
				VALUES (
						GETDATE(), 
						GETDATE(), 
						DateAdd(year,50,GETDATE()),
						@Username, 
						@Username,
						DateAdd(day,3,GETDATE()),
						@Title,
						@Forename,
						@Surname,
						@Initials,
						@Fullname,
						@Qualifications,
						@IsGI, 
						@JobTitleId,
						@ReadOnlyRoleID,
						@CanRunAK,
						@IsListConsultant,
						@IsEndoscopist1,
						@IsEndoscopist2,
						@IsAssistantOrTrainee,
						@IsNurse1, 
						@IsNurse2, 
						1,
						@Suppressed,
						@ShowTooltips, 
						@GMCCode, 
						@CanEditDropdowns,
						@CanViewAllUserAudits, 
						@LoggedInUserId, 
						GETDATE()
				)

				Set @UserId = SCOPE_IDENTITY() 
				INSERT INTO ERS_UserOperatingHospitals (UserId, OperatingHospitalId)
				VALUES  (@UserId, @OperatingHospitalId)
				
			end
			else
			begin 
			
				 if isnull(@UserRoleIds,'')=''
						update ERS_Users
						set @RoleIDs=@ReadOnlyRoleID
						where UserId=@UserId
				 else

					 begin
							if (select count(1)
									  from  dbo.splitString(@UserRoleIds,',')
										where item =@ReadOnlyRoleID)=0
							begin
						   
								  set  @UserRoleIds=@UserRoleIds+','+@ReadOnlyRoleID
									update ERS_Users
									set RoleId=@UserRoleIds
									where UserId=@UserId
							end
					end
			
		
				 IF (SELECT COUNT(1)
							FROM ERS_UserOperatingHospitals
							WHERE USERID=@UserId 
							AND OperatingHospitalId= @OperatingHospitalId)=0
				begin
			
					INSERT INTO ERS_UserOperatingHospitals (UserId, OperatingHospitalId)
					VALUES  (@UserId, @OperatingHospitalId)
				end
			end
	
			RETURN @UserId
			
			
			
	end

end





------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO

GO
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Partha Kundu	On 22  August 2023
-- TFS#	
-- Description of change
-- New SP to get access level for all pages
------------------------------------------------------------------------------------------------------------------------
GO

EXEC dbo.DropIfExist @ObjectName = 'GetAllPageAccessLevel',
                     @ObjectTypePrefix = 'S'

GO
CREATE PROCEDURE [dbo].[GetAllPageAccessLevel] (
                @UserId int,
                @TrustId int,
                @IsReadOnlyOverride bit
)
AS 

BEGIN
	DECLARE @RoleID VARCHAR(70),
			@AccessLevel INT = 0,
			@CreateProcureAccessLevel INT
			
	IF @userId = 0 AND @IsReadOnlyOverride = 1
	BEGIN
		SELECT p.AppPageName , MAX(ISNULL(pr.AccessLevel, 0)) --As AccessLevel 
		FROM ERS_PagesByRole pr 
		INNER JOIN ERS_Pages p ON p.PageId = pr.PageId 
		WHERE pr.RoleId IN (SELECT RoleId 
							FROM ERS_Roles 
							WHERE RoleName = 'Read Only' 
							AND TrustId = @TrustId)
		GROUP BY p.AppPageName
	END
	ELSE
	BEGIN
		IF EXISTS(SELECT 1
				  FROM ERS_Roles er, ERS_Users eu                                               
				  WHERE eu.UserID = @UserId
				  AND er.RoleName = 'GlobalAdmin'
				  AND (',' + RTRIM(eu.RoleID) + ',') LIKE '%,' + CAST(er.RoleId AS VARCHAR)+ ',%')
		BEGIN
			SELECT DISTINCT p.AppPageName, 
					9 As AccessLevel 
			FROM ERS_Pages p 
		END
		ELSE
		BEGIN									     
			SELECT @CreateProcureAccessLevel = MAX(epr.AccessLevel) 
			FROM ERS_Pages ep, 
				 ERS_PagesByRole epr, 
				 ERS_Users eu                                               
			WHERE ep.PageId = epr.PageId
			AND ep.AppPageName = 'create_procedure'
			AND eu.UserID = @UserId
			AND (',' + RTRIM(eu.RoleID) + ',') LIKE '%,' + CAST(epr.RoleId AS VARCHAR)+ ',%'

			Select apppagename, max(accesslevel) as accesslevel from (
			SELECT ep.apppagename, MAX( CASE WHEN ep.GroupId in (5, 6) THEN @CreateProcureAccessLevel 
										ELSE  epr.AccessLevel
										END ) AccessLevel
			FROM ERS_Pages ep, 
					ERS_PagesByRole epr, 
					ERS_Users eu                                               
			WHERE ep.PageId = epr.PageId
			AND eu.UserID = @UserId
			AND (',' + RTRIM(eu.RoleID) + ',') LIKE '%,' + CAST(epr.RoleId AS VARCHAR)+ ',%'
			GROUP BY apppagename
			
			union select ep.apppagename, (Select max(pbr.AccessLevel) 
										  from ERS_Pages p 
										  join ERS_PagesByRole pbr on p.PageId = pbr.PageId 
										  where p.AppPageName='create_procedure') AccessLevel
			from ERS_Pages ep, ERS_Users eu    
			where ep.GroupId in (5, 6)
			and eu.UserID = @UserId) as a
			where AccessLevel is not null
			group by AppPageName
		END
	END
END
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	Partha Kundu	On 22  August 2023
------------------------------------------------------------------------------------------------------------------------
GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea Johnson 01.11.23
-- TFS#	
-- Description of change
-- Validation check to ensure all endoscopists on a procedure enter a ja manouver and extent result
------------------------------------------------------------------------------------------------------------------------
GO

ALTER PROCEDURE [dbo].[check_requiredfields]
(
	@ProcedureId INT,
	@PageId INT
)
AS
BEGIN
	DECLARE @ProcedureTypeId INT, @ProcedureDNA INT, @UISectionId INT, @SectionName VARCHAR(50), @SectionPageId INT, @SectionControl VARCHAR(50), @IncompleteSections VARCHAR(MAX) = '', @ProcedureModifiedDate DATETIME, @ProcedureCompleted BIT
	SELECT @ProcedureTypeId = ProcedureType, @ProcedureDNA = ISNULL(DNA,0), @ProcedureModifiedDate = ModifiedOn, @ProcedureCompleted = ISNULL(ProcedureCompleted,0) FROM ERS_Procedures WHERE ProcedureId = @ProcedureId

	DECLARE @ProcedureEndoCount INT
	IF EXISTS (SELECT 1 FROM ERS_Procedures WHERE ProcedureId = @ProcedureId AND Endoscopist2 IS NOT NULL)
		SET @ProcedureEndoCount = 2
	ELSE
		SET @ProcedureEndoCount = 1

	IF NOT @ProcedureCompleted = 1 AND @ProcedureModifiedDate >= (SELECT TOP 1 InstallDate
																FROM DBVersion
																WHERE SUBSTRING(VersionNum,1,1) = '2'
																ORDER BY InstallDate ASC)

	

	BEGIN
	IF @ProcedureTypeId NOT IN (10,11,13) 
		BEGIN
		
	
			DECLARE cur CURSOR FOR (SELECT us.UISectionId, SectionName, PageId, SectionControl
									FROM UI_sections us
										LEFT JOIN UI_SectionProcedureTypes spt ON spt.UISectionId = us.UISectionId
									WHERE NEDRequired = 1 
									AND ISNULL(ProcedureTypeId,0) IN (0,@ProcedureTypeId) 
									AND DNAExempt = CASE WHEN @ProcedureDNA > 0 THEN 0 ELSE DNAExempt END 
									AND (PageId = @PageId OR @PageId = 0))
								
			SET @IncompleteSections = ''
			OPEN cur
			FETCH NEXT FROM cur INTO @UISectionId, @SectionName, @SectionPageId, @SectionControl

			WHILE @@FETCH_STATUS = 0
			BEGIN
				IF NOT EXISTS (SELECT 1 FROM dbo.ERS_ProcedureSummary WHERE ProcedureId = @ProcedureId AND SectionId = @UISectionId)
				BEGIN
					SET @IncompleteSections = @IncompleteSections + '&bull;' + @SectionName + '<br />'
		--			SET @IncompleteSections = @IncompleteSections + '&bull;<a href="/' + CASE @SectionPageId WHEN 1 THEN 'PreProcedure.aspx' WHEN 2 THEN 'Procedure.aspx' WHEN 3 THEN 'PostProcedure.aspx' END  +'#' + REPLACE(@SectionName, ' ','') + '">' + @SectionName + '</a><br />'
				END
		
				
				IF LOWER(@SectionName) = 'jmanoevre' AND CHARINDEX('jmanoevre',@IncompleteSections) = 0 /*no point validating if its not complete*/
				BEGIN
					IF (SELECT COUNT(*) FROM dbo.ERS_ProcedureSummary WHERE ProcedureId = @ProcedureId AND SectionId = @UISectionId) < @ProcedureEndoCount
					BEGIN
						SET @IncompleteSections = @IncompleteSections + '&bull;' + @SectionName + ' is incomplete. Both ensocopists must record their result<br />'
					END
				END

				IF LOWER(@SectionName) = 'procedure timing' AND CHARINDEX('',@IncompleteSections) = 0 /*no point validating if its not complete*/
				BEGIN
					DECLARE @StartTime DATETIME, @EndTime DATETIME
					SELECT @StartTime= StartDateTime, @EndTime = EndDateTime FROM ERS_Procedures WHERE ProcedureId= @ProcedureId
					IF @StartTime > @EndTime
					BEGIN
						SET @IncompleteSections = @IncompleteSections + '&bull;' + @SectionName + ' is incorrect. Check start is not after end date/time<br />'
					END
				END

				IF LOWER(@SectionName) = 'indications'
				BEGIN
					--'check sub indications'
					IF (SELECT COUNT(*) 
					FROM 
						(SELECT CASE WHEN ei.SubIndicationParent = 0 THEN 1 WHEN ei.SubIndicationParent = 1 AND EXISTS (SELECT 1 FROM dbo.ERS_ProcedureSubIndications epsi WHERE epsi.ProcedureId = ep.ProcedureId) THEN 1 ELSE 0 END AS 'Complete'
						FROM dbo.ERS_ProcedureIndications ep
							INNER JOIN dbo.ERS_Indications ei ON ei.UniqueId = ep.IndicationId
						WHERE procedureid = @ProcedureId) inds
						WHERE inds.Complete = 0) > 0
					BEGIN
						SET @IncompleteSections = @IncompleteSections + '&bull;Subindications<br />'
					END
				END

				IF LOWER(@SectionName) = 'rx'
				BEGIN
					--check if anti coag has been marked as yes.. if so perform checks 
					DECLARE @AntiCoagDrugs BIT
					SELECT @AntiCoagDrugs = AntiCoagDrugs FROM ERS_Procedures WHERE ProcedureId = @ProcedureId
					IF @AntiCoagDrugs = 1 
					BEGIN
						IF NOT EXISTS (SELECT 1 FROM ERS_ProcedureSummary WHERE ProcedureId = @ProcedureId AND SectionId = @UISectionId)
						BEGIN
							SET @IncompleteSections = REVERSE(SUBSTRING(REVERSE(@IncompleteSections), CHARINDEX('<br />', REVERSE(@IncompleteSections)) + 7, LEN(@IncompleteSections))) + '<small><em> - RX drugs must be complete for patients that are taking Anti-coag or Anti-platelet Medication</em></small><br />'
							SELECT @IncompleteSections
						END
					END
				END

				FETCH NEXT FROM cur INTO @UISectionId, @SectionName, @SectionPageId, @SectionControl
			END

			CLOSE cur
			DEALLOCATE cur
	
			--check for RX completion if anti coag selected


			--check for any unanswered mandatory pathway plan questions
			IF (SELECT COUNT(*)
				FROM dbo.ERS_PathwayPlanQuestions eppq
					LEFT JOIN ERS_ProcedurePathwayPlanAnswers pa ON pa.QuestionId = eppq.QuestionId AND pa.ProcedureId = @ProcedureId
				WHERE eppq.Mandatory = 1 AND ProcedureQuestionAnswerId IS NULL AND eppq.OrderById <> 99999 AND Suppressed =0) > 0
				AND @PageId IN (0,3)
				AND @ProcedureDNA = 0
			BEGIN
				SET @IncompleteSections = @IncompleteSections + '&bull;Pathway Plan<br />'
			END
		END

		--All required fields entered, update flag ProcedureCompleted
		IF @PageId = 0 AND @IncompleteSections	 = ''
		BEGIN
			IF (SELECT ISNULL(ProcedureCompleted,0) FROM ERS_Procedures WHERE ProcedureId = @ProcedureId)  = 0
			BEGIN
				UPDATE ERS_Procedures SET ProcedureCompleted = 1 WHERE ProcedureId = @ProcedureId
			END
		END
		ELSE IF @IncompleteSections <> ''
		BEGIN
				UPDATE ERS_Procedures SET ProcedureCompleted = 0 WHERE ProcedureId = @ProcedureId
		END

		SELECT @IncompleteSections
	END
END
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea johnson 01.11.23
-- TFS#	
-- Description of change
-- stored procedure to add new procedure type and set default points/minutes to 1/15
------------------------------------------------------------------------------------------------------------------------
GO

EXEC dbo.DropIfExist @ObjectName = 'sys_add_procedure_types',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE sys_add_procedure_types
(
	@ProcedureType VARCHAR(100),
	@SchedulerDiagnostic BIT,
	@SchedulerTherapeutic BIT,
	@OperatingHospitals VARCHAR(2000)
)
AS
BEGIN

	DECLARE @ProcedureTypeId INT = (SELECT MAX(ProcedureTypeId) +1 FROM ERS_ProcedureTypes)

	INSERT INTO dbo.ERS_ProcedureTypes
	(
		ProcedureTypeId,
		ProcedureType,
		ProductTypeId,
		Suppressed,
		ReportHeader,
		NedExportRequired,
		SchedulerProc,
		SchedulerProcName,
		SchedulerDiagnostic,
		SchedulerTherapeutic,
		IsGI,
		OperatingHospitalId,
		HDCKey,
		HL7Code,
		WhoUpdatedId,
		WhoCreatedId,
		WhenCreated,
		WhenUpdated,
		CanExportDocument,
		NEDProcedureName,
		GenderSpecific
	)
	VALUES
	(   @ProcedureTypeId,       -- ProcedureTypeId - int
		@ProcedureType,      -- ProcedureType - varchar(200)
		0,       -- ProductTypeId - int
		0, -- Suppressed - bit
		@ProcedureType,    -- ReportHeader - varchar(500)
		0, -- NedExportRequired - bit
		1, -- SchedulerProc - bit
		@ProcedureType,    -- SchedulerProcName - varchar(50)
		@SchedulerDiagnostic, -- SchedulerDiagnostic - bit
		@SchedulerTherapeutic, -- SchedulerTherapeutic - bit
		1,    -- IsGI - bit
		1, -- OperatingHospitalId - int
		NULL,    -- HDCKey - varchar(10)
		NULL,    -- HL7Code - varchar(50)
		NULL,    -- WhoUpdatedId - int
		DEFAULT, -- WhoCreatedId - int
		DEFAULT, -- WhenCreated - datetime
		NULL,    -- WhenUpdated - datetime
		DEFAULT, -- CanExportDocument - bit
		NULL,    -- NEDProcedureName - varchar(50)
		0  -- GenderSpecific - bit
	)

	INSERT INTO dbo.ERS_SCH_PointMappings
	(
	    Minutes,
	    OperatingHospitalId,
	    ProceduretypeId,
	    Points,
	    Training,
	    NonGI,
	    TherapeuticMinutes,
	    TherapeuticPoints
	)
	SELECT   15,       -- Minutes - int
	    OperatingHospitalId,       -- OperatingHospitalId - int
	    @ProcedureTypeId,       -- ProceduretypeId - int
	    1,    -- Points - decimal(18, 1)
	    0, -- Training - bit
	    0, -- NonGI - bit
	    15, -- TherapeuticMinutes - int
	    1  -- TherapeuticPoints - decimal(18, 1)
	FROM dbo.ERS_OperatingHospitals WHERE OperatingHospitalId IN (SELECT OperatingHospitalId FROM dbo.ERS_OperatingHospitals WHERE HospitalName IN (SELECT Item FROM dbo.fnSplitString(@OperatingHospitals, ',')))
	UNION ALL
	SELECT   15,       -- Minutes - int
	    OperatingHospitalId,       -- OperatingHospitalId - int
	    @ProcedureTypeId,       -- ProceduretypeId - int
	    1,    -- Points - decimal(18, 1)
	    1, -- Training - bit
	    0, -- NonGI - bit
	    15, -- TherapeuticMinutes - int
	    1  -- TherapeuticPoints - decimal(18, 1)
	FROM dbo.ERS_OperatingHospitals WHERE OperatingHospitalId IN (SELECT OperatingHospitalId FROM dbo.ERS_OperatingHospitals WHERE HospitalName IN (SELECT Item FROM dbo.fnSplitString(@OperatingHospitals, ',')))

END
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Muhammad Shahriar 08.11.23
-- TFS#	2065
-- Description of change
-- Mucosal Junction column add in ERS_ProcedureUpperExtent table and corresponding scripts update
------------------------------------------------------------------------------------------------------------------------
GO



--Adding MucosalJunctionDistance column in ERS_ProcedureUpperExtent table
IF Not EXISTS(SELECT * FROM sys.columns WHERE Name = N'MucosalJunctionDistance' AND Object_ID = Object_ID(N'ERS_ProcedureUpperExtent'))
Begin
Print 'Adding Column MucosalJunctionDistance from ERS_ProcedureUpperExtent table'
ALTER TABLE [dbo].[ERS_ProcedureUpperExtent]
   Add MucosalJunctionDistance int null
End
GO

ALTER PROCEDURE [dbo].[procedure_upper_extent_save]
(
	@ProcedureId int,
	@ExtentId int,
	@AdditionalInfo varchar(max),
	@EndoscopistId int,
	@JManoeuvreId int, 
	@LimitedById int, 
	@WithdrawalMins int,
	@MucosalJunctionDistance int,
	@LimitationOther varchar(max),
	@LoggedInUserId int
)
AS
/*
--	Update History
01.			04 Jan 2023		MH added Order Message Send block while saving Extent of Intubation TFS #2475
							No extra parameter required. ProcedureId will have associated OrderId and Extent Limited By value
02.			21 March 2023	AJ j manouver handled if -1 (not specified)
03.			27 March 2023	AJ Set sections as not entered based on the extent reached
04.			08 June 2023	SG Add call to ogd_diagnoses_summary_update to ensure report gets populated with Normal if no abnormalities are added
05.         08 Nov 2023     MS Add MucosalJunctionDistance column and related logic
							
*/
BEGIN
	Declare @bitHasProcedureFailed as bit
	Set @bitHasProcedureFailed = 0

	IF NOT EXISTS (SELECT 1 FROM ERS_ProcedureUpperExtent WHERE ProcedureId = @ProcedureId AND EndoscopistId = @EndoscopistId)
	BEGIN
		INSERT INTO ERS_ProcedureUpperExtent (ProcedureId, ExtentId, AdditionalInfo, EndoscopistId, JManoeuvreId, LimitationId, MucosalJunctionDistance, WhoUpdatedId, WhenUpdated, LimitationOther)
		VALUES (@ProcedureId, NULLIF(@ExtentId,0), NULLIF(@AdditionalInfo,''), @EndoscopistId, NULLIF(@JManoeuvreId,-1), NULLIF(@LimitedById,0), NULLIF(@MucosalJunctionDistance,0), @LoggedInUserId, getdate(), NULLIF(@LimitationOther,''))
	END
	ELSE
	BEGIN

		/*Check if new values been added for limitations */
		IF ISNULL(@LimitationOther,'') <> ''
		BEGIN
			IF NOT EXISTS (SELECT 1 FROM dbo.ERS_Limitations WHERE Description = @LimitationOther)
			BEGIN
				/*get and set the new items order id so it appears 1 above 'other' we always want other to be last*/

				DECLARE @OtherListOrderBy_l int = (SELECT ListOrderBy FROM ERS_Limitations WHERE Description = 'Other')
				INSERT INTO ERS_Limitations (Description, NEDTerm, ListOrderBy) VALUES (@LimitationOther, 'Other', @OtherListOrderBy_l)
			
				UPDATE dbo.ERS_Limitations SET ListOrderBy = @OtherListOrderBy_l + 1 WHERE Description = 'Other'
		

			SELECT @LimitedById = UniqueId FROM ERS_Limitations WHERE Description = @LimitationOther
		
			DECLARE @ProcTypeId int = (SELECT ProcedureType FROM ERS_Procedures WHERE ProcedureId = @ProcedureId)
			INSERT INTO ERS_LimitationProcedureTypes (ProcedureTypeId, LimitationId) VALUES (@ProcTypeId, @LimitedById)
			END
			ELSE
				SELECT @LimitedById = UniqueId FROM ERS_Limitations WHERE Description = @LimitationOther
		END 

		UPDATE ERS_ProcedureUpperExtent
		SET 
			ExtentId = NULLIF(@ExtentId,0),
			AdditionalInfo = NULLIF(@AdditionalInfo,''),
			EndoscopistId = @EndoscopistId,
			JManoeuvreId = NULLIF(@JManoeuvreId,-1),
			LimitationId = NULLIF(@LimitedById,0),
			MucosalJunctionDistance = NULLIF(@MucosalJunctionDistance,0),
			WhoUpdatedId = @LoggedInUserId,
			WhenUpdated = getdate(),
			LimitationOther = NULLIF(@LimitationOther,'')
		WHERE 
			ProcedureId = @ProcedureId AND
			EndoscopistId = @EndoscopistId
	END

	DECLARE @SectionId int, @ProceureTypeId int, @ExtentIsSuccess bit, @ExtentDescription varchar(200), @SummaryText varchar(max) = ''
	SELECT @SectionID = UISectionId FROM UI_Sections WHERE SectionName = 'Extent'

	SELECT @ProceureTypeId = ProcedureType FROM ERS_Procedures WHERE ProcedureId = @ProcedureId
	
	/*Furthest extent*/
	SELECT TOP 1 @ExtentDescription = ee.Description, @AdditionalInfo = epue.AdditionalInfo, @ExtentIsSuccess = ee.IsSuccess
								FROM dbo.ERS_ProcedureUpperExtent epue 
									INNER JOIN dbo.ERS_Extent ee ON epue.ExtentId = ee.UniqueId
								WHERE epue.ProcedureId=@ProcedureId
								ORDER BY ee.ListOrderBy DESC
	
	/*Handle failed procedures*/
	IF @ExtentDescription IN ('intubation failed','abandoned')
	Begin
		EXEC diagnoses_set_procedure_failed @ProcedureId
		Set @bitHasProcedureFailed = 1
	End

	IF ISNULL(@MucosalJunctionDistance,0) > 0
	BEGIN

		SET @SummaryText = 'The apparent mucosal junction: ' + @MucosalJunctionDistance + 'cm'
	END

	IF (SELECT COUNT(*) FROM ERS_ProcedureUpperExtent WHERE ProcedureId = @ProcedureId AND NULLIF(JManoeuvreId,-1) IS NOT NULL) > 0
	BEGIN
		DECLARE @JManouvreResult varchar(100)

		/*Overall JManouvre result regardless of who done it, was it done*/
		IF EXISTS (SELECT 1 FROM ERS_ProcedureUpperExtent WHERE ProcedureId = @ProcedureId AND ISNULL(JManoeuvreId,0) = 1)
			SET @JManouvreResult = 'performed. '
		ELSE
			SET @JManouvreResult = 'not carried out. '

		SET @SummaryText = @SummaryText + 'J manoeuvre ' + @JManouvreResult
	END
		
	SET @SummaryText = @SummaryText +   
						CASE LOWER(@ExtentDescription )
							WHEN 'intubation failed' THEN 'Failed intubation' + CASE WHEN ISNULL(@AdditionalInfo,'') <> '' THEN ': ' + @AdditionalInfo ELSE '' END
							WHEN 'abandoned' THEN 'Procedure failed (abandoned)' + CASE WHEN ISNULL(@AdditionalInfo,'') <> '' THEN ': ' + @AdditionalInfo ELSE '' END
							WHEN 'other' THEN  'Procedure failed' + CASE WHEN ISNULL(@AdditionalInfo,'') <> '' THEN ': ' + @AdditionalInfo ELSE '' END
							ELSE 'The procedure was completed successfully to the ' + @ExtentDescription
						END
	--limited by...?
	IF ISNULL(@LimitedById, 0) > 0
	BEGIN
		SET @SummaryText = @SummaryText + ' but limited by ' + (SELECT LOWER(Description) FROM ERS_Limitations WHERE UniqueId = @LimitedById)
	END

	IF ISNULL(@SummaryText,'') <> ''
	BEGIN
		UPDATE ERS_ProcedureUpperExtent
		SET Summary = @SummaryText
		WHERE ProcedureId = @ProcedureId

		EXEC procedure_summary_update @ProcedureId
	END
	
	DECLARE @Summary VARCHAR(max) = 'Extent:'


	--remove complete section entry incase conditions no longer apply. Will get re-evaluated after
	EXEC UI_update_procedure_summary @ProcedureId, 'Extent', @Summary, 0, @EndoscopistId

	--Check if the Extent has reached or exceeded the planned extent, if so mark as success
	IF @ExtentId > 0 
	BEGIN
		DECLARE @ExtentListOrder int = (SELECT ListOrderBy FROM ERS_Extent WHERE UniqueId = @ExtentId)
		DECLARE @PlannedExtentListOrder int = (SELECT e.ListOrderBy FROM ERS_ProcedurePlannedExtent ppe JOIN ERS_Extent e ON e.UniqueId = ppe.ExtentId WHERE ppe.ProcedureId = @ProcedureId)

		IF (@ExtentListOrder >= @PlannedExtentListOrder AND @ExtentListOrder > 0)
				SET @ExtentIsSuccess = 1
	END

	IF @ExtentId > 0 AND @ExtentIsSuccess = 1
		EXEC UI_update_procedure_summary @ProcedureId, 'Extent', 'Extent:', @ExtentId, @EndoscopistId
	ELSE IF @ExtentIsSuccess = 0 AND @LimitedById > 1
	BEGIN
		IF (SELECT LOWER(NEDTerm) FROM dbo.ERS_Limitations WHERE UniqueId = @LimitedById) = 'other'
		BEGIN
			IF ISNULL(@LimitationOther,'') <> ''
			BEGIN
				EXEC UI_update_procedure_summary @ProcedureId, 'Extent', 'Extent:' , @ExtentId, @EndoscopistId
			END
		END
		ELSE
		BEGIN
			EXEC UI_update_procedure_summary @ProcedureId, 'Extent', 'Extent:', @ExtentId, @EndoscopistId
		END
	END

	IF ISNULL(@WithdrawalMins,0) > 0
	BEGIN
		EXEC UI_update_procedure_summary @ProcedureId, 'Total withdrawal time', 'Total withdrawal time:', 1, @EndoscopistId
	END

	IF @JManoeuvreId > -1
	BEGIN
		EXEC UI_update_procedure_summary @ProcedureId, 'JManoevre', 'JManoevre:', 1, @EndoscopistId
	END
	ELSE
	BEGIN
		EXEC UI_update_procedure_summary @ProcedureId, 'JManoevre', 'JManoevre:', 0 , @EndoscopistId
	END
	
	--MH Added on 04 Jan 2023 
	Exec usp_SendIntubationExtentOrderMessageByProcedureId @ProcedureId, @bitHasProcedureFailed, @LoggedInUserId

	EXEC ogd_diagnoses_summary_update @ProcedureID

	--Handle unentered sections
	DECLARE @MatrixCode VARCHAR(100)

	--based on extent reached
	IF LOWER(@ExtentDescription)= 'oesophagus'
	BEGIN
		--if Oesophagus then Stomach and Duodenum not entered
		EXEC dbo.diagnoses_control_save @SiteID = 0,               -- int
		                                @DiagnosesMatrixCode = 'StomachNotEntered', -- varchar(50)
		                                @Value = 'true'                -- varchar(50)
		
		EXEC dbo.diagnoses_control_save @SiteID = 0,               -- int
		                                @DiagnosesMatrixCode = 'DuodenumNotEntered', -- varchar(50)
		                                @Value = 'true'                -- varchar(50)
	END
	IF LOWER(@ExtentDescription)= 'stomach'
	BEGIN
		--if stomach Duodenum not entered
		EXEC dbo.diagnoses_control_save @SiteID = 0,               -- int
		                                @DiagnosesMatrixCode = 'DuodenumNotEntered', -- varchar(50)
		                                @Value = 'true'                -- varchar(50)
		
	END
END


GO


ALTER PROCEDURE [dbo].[procedure_upper_extent_select]
(
	@ProcedureId int
)
AS
BEGIN
	SELECT ExtentId, Description, pe.AdditionalInfo, EndoscopistId, JManoeuvreId, MucosalJunctionDistance, LimitationId, WithdrawalMins, LimitationOther
	FROM ERS_ProcedureUpperExtent pe
		LEFT JOIN ERS_Extent e  on e.UniqueId = pe.ExtentId
	WHERE 
		ProcedureId = @ProcedureId
END

GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	2065
------------------------------------------------------------------------------------------------------------------------
GO
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Muhammad Shahriar 08.11.23
-- Description of change
-- Update Procedure trigger to prevent changet when user is trying to update Patient ID of existing Procedure 
------------------------------------------------------------------------------------------------------------------------
GO

ALTER TRIGGER [dbo].[trg_ERS_Procedures_Update] ON [dbo].[ERS_Procedures] 
AFTER UPDATE
AS 
SET NOCOUNT ON; 

IF UPDATE([PatientId])
BEGIN
   ;THROW 51000, 'Update the Patient ID is forbidden', 1;  
   Rollback transaction
END

INSERT INTO [ERSAudit].[ERS_Procedures_Audit] (ProcedureId, tbl.[ProcedureType], tbl.[CreatedBy], tbl.[CreatedOn], tbl.[ModifiedOn], tbl.[PatientId], tbl.[PatientType], tbl.[PatientStatus], tbl.[Ward], tbl.[CategoryListId], tbl.[OnWaitingList], tbl.[OpenAccessProc], tbl.[EmergencyProcType], tbl.[OperatingHospitalID], tbl.[ReferralHospitalNo], tbl.[ReferralConsultantNo], tbl.[GPReferralFlag], tbl.[DiagramNumber], tbl.[ListType], tbl.[ListConsultant], tbl.[ConsultantPresent], tbl.[Endoscopist1], tbl.[Endo1Role], tbl.[Endoscopist2], tbl.[Endo2Role], tbl.[Assistant], tbl.[Nurse1], tbl.[Nurse2], tbl.[Nurse3], tbl.[Instrument1], tbl.[Instrument2], tbl.[ResectedColonNo], tbl.[IncludeProcNotes], tbl.[ProcedureNotes], tbl.[Video], tbl.[VideoNotes], tbl.[GPReportText], tbl.[TextEdited], tbl.[DiagramIncluded], tbl.[EndoscribeComments], tbl.[EndoscribePremedication], tbl.[MucosalJunctionAt], tbl.[NewCardia], tbl.[AbnoText], tbl.[PancreasDivisum], tbl.[BiliaryManometry], tbl.[PancreaticManometry], tbl.[FirstERCP], tbl.[ExportedToEPR], tbl.[ForcepType], tbl.[ForcepSerialNo], tbl.[AccountNo], tbl.[DNA], tbl.[DNACombined], tbl.[DNACreatedViaRC], tbl.[ExportFileName], tbl.[ExportProducedOn], tbl.[ReferralConsultantSpeciality], tbl.[PatientConsent], tbl.[SurgicalSafetyCheckListCompleted], tbl.[GPCode], tbl.[GPPracticeCode], tbl.[NEDEnabled], tbl.[NEDExported], tbl.[NEDProcedureId], tbl.[ScopeGuide], tbl.[FormerProcedureId], tbl.[ProcedureCompleted], tbl.[IsDirty], tbl.[IsActive], tbl.[BreathTestResult], tbl.[ImagePortId], tbl.[Transnasal], tbl.[ReportUpdated],  LastActionId, ActionDateTime, ActionUserId)
SELECT tbl.ProcedureId , tbl.[ProcedureType], tbl.[CreatedBy], tbl.[CreatedOn], tbl.[ModifiedOn], tbl.[PatientId], tbl.[PatientType], tbl.[PatientStatus], tbl.[Ward], tbl.[CategoryListId], tbl.[OnWaitingList], tbl.[OpenAccessProc], tbl.[EmergencyProcType], tbl.[OperatingHospitalID], tbl.[ReferralHospitalNo], tbl.[ReferralConsultantNo], tbl.[GPReferralFlag], tbl.[DiagramNumber], tbl.[ListType], tbl.[ListConsultant], tbl.[ConsultantPresent], tbl.[Endoscopist1], tbl.[Endo1Role], tbl.[Endoscopist2], tbl.[Endo2Role], tbl.[Assistant], tbl.[Nurse1], tbl.[Nurse2], tbl.[Nurse3], tbl.[Instrument1], tbl.[Instrument2], tbl.[ResectedColonNo], tbl.[IncludeProcNotes], tbl.[ProcedureNotes], tbl.[Video], tbl.[VideoNotes], tbl.[GPReportText], tbl.[TextEdited], tbl.[DiagramIncluded], tbl.[EndoscribeComments], tbl.[EndoscribePremedication], tbl.[MucosalJunctionAt], tbl.[NewCardia], tbl.[AbnoText], tbl.[PancreasDivisum], tbl.[BiliaryManometry], tbl.[PancreaticManometry], tbl.[FirstERCP], tbl.[ExportedToEPR], tbl.[ForcepType], tbl.[ForcepSerialNo], tbl.[AccountNo], tbl.[DNA], tbl.[DNACombined], tbl.[DNACreatedViaRC], tbl.[ExportFileName], tbl.[ExportProducedOn], tbl.[ReferralConsultantSpeciality], tbl.[PatientConsent], tbl.[SurgicalSafetyCheckListCompleted], tbl.[GPCode], tbl.[GPPracticeCode], tbl.[NEDEnabled], tbl.[NEDExported], tbl.[NEDProcedureId], tbl.[ScopeGuide], tbl.[FormerProcedureId], tbl.[ProcedureCompleted], tbl.[IsDirty], tbl.[IsActive], tbl.[BreathTestResult], tbl.[ImagePortId], tbl.[Transnasal], tbl.[ReportUpdated],  2, GETDATE(), i.WhoUpdatedId
FROM deleted tbl INNER JOIN inserted i ON tbl.ProcedureId = i.ProcedureId

------------------------------------------------------------------------------------------------------------------------
-- END OF ALTER TRIGGER 
------------------------------------------------------------------------------------------------------------------------

GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Steve 23/11/2023
-- TFS#	
-- Description of change
-- Reduce deadlock errors.
------------------------------------------------------------------------------------------------------------------------
GO

PRINT N'Altering [dbo].[get_worklist_patients]...';

GO

EXEC dbo.DropIfExist @ObjectName = 'get_worklist_patients',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)

GO

/****** Object:  StoredProcedure [dbo].[get_worklist_patients]    Script Date: 23/11/2023 11:45:18 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE  [dbo].[get_worklist_patients]
(
	@OperatingHospitalId INT,
	@StartDate DATETIME = NULL,
	@EndDate DATETIME = NULL,
	@EndoscopistId INT = NULL
)
AS
BEGIN
	IF @StartDate IS NULL
	BEGIN
		SET @StartDate = convert(date, convert(varchar(10), GETDATE(), 102))
	END
	IF @EndDate IS NOT NULL
	BEGIN
		SELECT @EndDate = convert(date, convert(varchar(10), DATEADD(Day, 1, @EndDate), 102))
	END

	SELECT DISTINCT
		ea.AppointmentId AS UniqueId, 
		ea.BookingTypeId AS BookingTypeId,
		ep.Surname, 
		ep.Forename1 as Forename, 
		convert(char(10),ep.DateOfBirth,103) AS DOB, 
		isnull(ep.Title,'') as Title,
		UPPER(SUBSTRING(dbo.fnGender(ep.GenderId),1,1)) AS Gender,
		STUFF((SELECT DISTINCT ', '+ HospitalNumber from ERS_PatientTrusts where PatientId = ep.PatientId for xml path('')), 1, 2, '') AS HospitalNumber,
		ep.NHSNo,
		dbo.fnFullAddress(ep.Address1, ep.Address2, ep.Address3, ep.Address4, '') AS Address,
		isnull(ep.Postcode,'') as Postcode, 
		convert(char(10),ea.StartDateTime,103) as [Date], 
		eapt.ProcedureTypeID AS ProcedureTypeId,
		ept.ProcedureType,
		ep.PatientId,
		1 AS ERSPatient,
		ISNULL(dp.OperatingHospitalId, ea.OperationalHospitaId) as HospitalId,
		ea.StartDateTime,
		ea.TimeOfDay,
		CASE WHEN [as].HDCKEY IS NULL THEN 'Booked'
			 WHEN [as].HDCKEY = 'P' THEN 'Booked'
		ELSE [as].[Description]
		END as AppointmentStatus,
		[as].HDCKEY as AppointmentStatusHDCKEY,
		r.RoomName as RoomName, 
		r.RoomId as RoomId,
		ea.Notes as Alerts,
		ea.GeneralInformation as Notes,
		CASE WHEN ISNULL(ea.DiaryId, 0) = 0 THEN ea.EndoscopistId ELSE dp.UserID END EndoscopistId,
		eu.Title + ' ' + eu.Forename + ' ' + eu.Surname AS Endoscopist,
		CASE ISNULL(ea.TimeOfDay,'') WHEN '' THEN 0 WHEN 'AM' THEN 1 WHEN 'PM' THEN 2 WHEN 'Evening' THEN 3 END AS iTOD,
		CASE WHEN ea.BookingTypeId = 2 THEN CONVERT(varchar(5), ea.StartDateTime, 108) ELSE '' END AS AppointmentTime,
		ISNULL(pip.ProcedureCompleted,0) AS ProcedureCompleted,
		CASE WHEN pj.PatientAdmissionTime IS NULL THEN 0 ELSE 1 END PatientArrived,
		CONVERT(varchar(5), pj.PatientAdmissionTime, 108) as ArrivedTime,
		CONVERT(varchar(5), pj.ProcedureStartTime, 108) as InProgressTime,
		CONVERT(varchar(5), pj.ProcedureEndTime, 108) as RecoveryTime,
		CONVERT(varchar(5), pj.PatientDischargeTime, 108) as DischargeTime,
		CONVERT(varchar(5), ea.DueArrivalTime, 108) as CallInTime,
		ss.Description AS Category
	FROM  ERS_Appointments ea  
		LEFT JOIN dbo.ERS_Patients ep (nolock) ON ea.PatientId = ep.PatientId
		LEFT JOIN ERS_AppointmentStatus [as] (nolock) ON EA.AppointmentStatusId = [as].UniqueId 
		LEFT JOIN ERS_AppointmentProcedureTypes eapt (nolock) ON EA.AppointmentId = eapt.AppointmentID
		LEFT JOIN dbo.ERS_ProcedureTypes ept (nolock) ON eapt.ProcedureTypeID = ept.ProcedureTypeId
		LEFT JOIN ERS_SCH_DiaryPages dp (nolock) on ea.DiaryId = dp.DiaryId
		LEFT JOIN dbo.ERS_Users eu (nolock) ON eu.UserID = CASE WHEN ISNULL(ea.DiaryId,0) = 0 THEN ea.EndoscopistId ELSE dp.UserId END 
		LEFT JOIN ERS_SCH_Rooms r (nolock) on dp.RoomId = r.RoomId
		LEFT JOIN (SELECT ep.ProcedureId, ep.ProcedureType, ep.ProcedureCompleted, ep.PatientId, ep.CreatedOn
						FROM dbo.ERS_Procedures ep (nolock)
					WHERE ep.IsActive= 1 
						AND ISNULL(ep.ProcedureCompleted,0) = 0 
						AND ep.OperatingHospitalID = @OperatingHospitalId
				  ) pip ON ea.PatientId = pip.PatientId AND ISNULL(eapt.ProcedureTypeId, pip.ProcedureType) = pip.ProcedureType
		LEFT JOIN ERS_PatientJourney pj (nolock) on pj.PatientId = ep.PatientId AND pj.AppointmentId = ea.AppointmentId
		LEFT JOIN ERS_SCH_SlotStatus ss (nolock) on ss.StatusId = ea.SlotStatusID
	WHERE ea.BookingTypeId IN (1, 2) /*1 = worklist, 2 = scheduler appointment*/
		AND ea.StartDateTime >= @StartDate 
		AND (@EndDate IS NULL OR ea.StartDateTime < @EndDate)
		AND (ea.IsDeleted IS NULL OR ea.IsDeleted = 0)
		AND (@EndoscopistId IS NULL OR CASE WHEN ISNULL(ea.DiaryId,0) = 0 THEN ea.EndoscopistId ELSE dp.UserId END = @EndoscopistId)
	order by ea.StartDateTime  
END

GO


PRINT N'Altering [dbo].[startup_select]...';

GO

EXEC dbo.DropIfExist @ObjectName = 'startup_select',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)

GO

/****** Object:  StoredProcedure [dbo].[startup_select]    Script Date: 23/11/2023 11:48:01 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[startup_select] (
	@SearchString1 VARCHAR(500)			--CaseNoteNo
	,@SearchString2 VARCHAR(500)		--NHSNo
	,@SearchString3 VARCHAR(500)		--Surname
	,@SearchString4 VARCHAR(500)		--Forename
	,@SearchString5 VARCHAR(500)		--DOB
	,@SearchString6 VARCHAR(500)		--Address
	,@SearchString7 VARCHAR(500)		--Postcode
	,@searchGender Varchar(500)			--Gender
	,@SearchTab INT = 0					
	,@Condition VARCHAR(50) = ''		
	,@SearchType VARCHAR(50)
	,@ExcludeDeceased BIT = 0			--ExcludeDeadOption
	,@UserId INT						--UserId
	,@UserName NVARCHAR(500)			--UserName
	,@TrustId int )
AS
/*	Update History		:		07 Sept 2022 MH copied from SE1 - treat single quote in name, fix duplicate NHSNo (Isminor) etc 
						:		18 Nov 2022 MH implemented Soundex (pronounced like) search on Patient Surname and Forename TFS 2446
						:		06 Jun 2023 MH added search with Gender - Parameter value will be M, F, U or T or NULL/ ''
*/
DECLARE @Statement NVARCHAR(max)
DECLARE @Statement2 NVARCHAR(max)
DECLARE @SearchCriteria INT
	,@SearchCriteriaOption INT
	,@SearchCriteriaOptionPatientCount INT
	,@SearchCriteriaOptionDate DATETIME
	,@SearchCriteriaOptionMonths INT
	,@ExcludeDeadOption BIT
	,@ExcludeUGI BIT
	,@AllProcedures BIT
	,@Gastroscopy BIT
	,@ERCP BIT
	,@Colonoscopy BIT
	,@Proctoscopy BIT
	,@OutstandingCLO BIT
	,@OrderListOptions INT


--MH replaces single ' with '' in Surname and Forename variables.
Set @SearchString3 = Replace(@SearchString3,'''','''''')
Set @SearchString4 = Replace(@SearchString4,'''','''''')

IF EXISTS (SELECT 1 FROM ERS_StartupSettings WHERE ISNULL(UserId,0) = @UserId)
	SELECT TOP (1) @SearchCriteria = [SearchCriteria]
		,@SearchCriteriaOption = [SearchCriteriaOption]
		,@SearchCriteriaOptionPatientCount = [SearchCriteriaOptionPatientCount]
		,@SearchCriteriaOptionDate = [SearchCriteriaOptionDate]
		,@SearchCriteriaOptionMonths = [SearchCriteriaOptionMonths]
		,@ExcludeDeadOption = [ExcludeDeadOption]
		,@ExcludeUGI = [ExcludeUGI]
		,@AllProcedures = [AllProcedures]
		,@Gastroscopy = [Gastroscopy]
		,@ERCP = [ERCP]
		,@Colonoscopy = [Colonoscopy]
		,@Proctoscopy = [Proctoscopy]
		,@OutstandingCLO = [OutstandingCLO]
		,@OrderListOptions = [OrderListOptions]
	FROM [ERS_StartupSettings]
	WHERE UserID = @UserId
ELSE
	SELECT TOP (1) @SearchCriteria = [SearchCriteria]
	,@SearchCriteriaOption = [SearchCriteriaOption]
	,@SearchCriteriaOptionPatientCount = [SearchCriteriaOptionPatientCount]
	,@SearchCriteriaOptionDate = [SearchCriteriaOptionDate]
	,@SearchCriteriaOptionMonths = [SearchCriteriaOptionMonths]
	,@ExcludeDeadOption = [ExcludeDeadOption]
	,@ExcludeUGI = [ExcludeUGI]
	,@AllProcedures = [AllProcedures]
	,@Gastroscopy = [Gastroscopy]
	,@ERCP = [ERCP]
	,@Colonoscopy = [Colonoscopy]
	,@Proctoscopy = [Proctoscopy]
	,@OutstandingCLO = [OutstandingCLO]
	,@OrderListOptions = [OrderListOptions]
	FROM [ERS_StartupSettings]

DECLARE @SQLString VARCHAR(max)
	,@SelectStr VARCHAR(max)
	,@FromStr VARCHAR(500)
	,@FromStr2 VARCHAR(500)
	,@WhereStr VARCHAR(1000)
	,@WhereStr2 VARCHAR(1000)
	,@OrderStr VARCHAR(1000)

SET @SelectStr = 'SELECT DISTINCT	p.PatientId, 
									p.Forename1 + '' '' + p.Surname AS PatientName, 
									dbo.fnFullAddress(p.Address1, p.Address2, p.Address3, p.Address4, '''') as Address, 
									p.DateOfBirth AS DOB, 
									UPPER(SUBSTRING(dbo.fnGender(p.GenderId),1,1)) as Gender, 
									dbo.fnEthnicity(p.EthnicId) as Ethnicity, 
									CASE WHEN EXISTS (select TOP 1 HospitalNumber from ERS_PatientTrusts where PatientId = p.PatientId and IsMinor = 0) 
									 THEN STUFF((SELECT DISTINCT '',''+HospitalNumber from ERS_PatientTrusts where PatientId = p.PatientId and IsMinor = 0 for xml path('''')), 1, 1, '''')
									 ELSE STUFF((SELECT DISTINCT '',''+HospitalNumber from ERS_PatientTrusts where PatientId = p.PatientId and IsMinor = 1 for xml path('''')), 1, 1, '''')
								    END AS CaseNoteNo, 
									p.NHSNo, 
									p.DateAdded AS CreatedOn, 
									ISNULL(Deceased,0) AS Deceased,
									--ROW_NUMBER() OVER (ORDER BY p.PatientId) AS PatientRowId,
									p.PatientId AS PatientId, 
									NULL AS UGIPatientId,
									NULL AS ComboId,
									1 AS ERSPatient, 
									p.Title AS Title, 
									p.Forename1 AS Forename1, 
									p.Surname AS Surname, 
									dbo.fnGender(p.GenderId) AS Gender, 
									p.Forename1 + '' '' + p.Surname AS PatientName, 
									dbo.fnFullAddress(p.Address1, p.Address2, p.Address3, p.Address4, '''') AS Address, 
									p.PostCode,
									p.Telephone,
									p.DateOfBirth AS DateOfBirth, 
									CASE WHEN EXISTS (select TOP 1 HospitalNumber from ERS_PatientTrusts where PatientId = p.PatientId and IsMinor = 0) 
									 THEN STUFF((SELECT DISTINCT '',''+HospitalNumber from ERS_PatientTrusts where PatientId = p.PatientId and IsMinor = 0 for xml path('''')), 1, 1, '''')
									 ELSE STUFF((SELECT DISTINCT '',''+HospitalNumber from ERS_PatientTrusts where PatientId = p.PatientId and IsMinor = 1 for xml path('''')), 1, 1, '''')
								    END AS HospitalNumber,
									p.NHSNo AS NHSNo, 
									p.DateAdded AS DateAdded,
									p.DateUpdated AS DateUpdated,
									p.EthnicId AS EthnicId,
									p.DateOfDeath AS DateOfDeath,
									ISNULL(p.Deceased,0)  AS Deceased,
									p.CreateUpdateMethod'
SET @FromStr = ' FROM ERS_Patients p (nolock) inner join  ERS_PatientTrusts pt on  p.PatientId = pt.PatientId Left join ERS_GenderTypes gt on p.GenderId = gt.GenderId'
SET @FromStr2 = ' FROM ERS_Patients p (nolock) JOIN ERS_MergeJournal mj on p.PatientId = mj.MasterPatientId  Left join ERS_GenderTypes gt on p.GenderId = gt.GenderId'
SET @WhereStr = ''
SET @WhereStr2 = ''
SET @OrderStr = ' ORDER BY p.DateAdded DESC, p.PatientId  DESC'

IF @SearchCriteria = 1 OR @SearchTab IN (1, 2) --(@SearchCriteria=2 AND @SearchTab <> 0)
BEGIN
print 'searchtab = ' + convert(varchar, @SearchTab)
	IF @SearchTab = 1
	BEGIN
		IF @searchString1 IS NOT NULL AND @searchString1 <> ''
		BEGIN
			SET @WhereStr = (
					SELECT CASE @Condition
							WHEN 'ALL'
								THEN ' WHERE pt.HospitalNumber = ISNULL(''' + @SearchString1 + ''','''') OR NHSNo = ISNULL(''' + @SearchString1 + ''','''') OR Surname LIKE ''%'' + ISNULL(''' + @SearchString1 + ''','''') + ''%'' OR Forename1 LIKE ''%'' + ISNULL(''' + @SearchString1 + ''','''') + ''%'' '
							WHEN 'Case note no.'
								THEN ' WHERE pt.HospitalNumber LIKE ''%'' + ISNULL(''' + @SearchString1 + ''','''') + ''%'' '
							WHEN 'NHS No'
								THEN ' WHERE REPLACE(NHSNo, '' '','''') LIKE ''%'' + ISNULL(''' + REPLACE(@SearchString1,' ', '') + ''','''') + ''%'' '
							WHEN 'Surname'
								THEN ' WHERE Surname LIKE ''%'' + ISNULL(''' + @SearchString1 + ''','''') + ''%'' '
							WHEN 'Forenames'
								THEN ' WHERE Forename1 LIKE ''%'' + ISNULL(''' + @SearchString1 + ''','''') + ''%'' '
							END
					)
			SET @WhereStr2 = (
					SELECT CASE @Condition
							WHEN 'ALL'
								THEN ' WHERE mj.SlaveExt LIKE ''%'' + ISNULL(''' + @SearchString1 + ''','''') + ''%'' OR NHSNo = ISNULL(''' + @SearchString1 + ''','''') OR Surname LIKE ''%'' + ISNULL(''' + @SearchString1 + ''','''') + ''%'' OR Forename1 LIKE ''%'' + ISNULL(''' + @SearchString1 + ''','''') + ''%'' '
							WHEN 'Case note no.'
								THEN ' WHERE mj.SlaveExt LIKE ''%'' + ISNULL(''' + @SearchString1 + ''','''') + ''%'' '
							WHEN 'NHS No'
								THEN ' WHERE REPLACE(NHSNo, '' '','''') = ISNULL(''' + REPLACE(@SearchString1,' ', '') + ''','''') '
							WHEN 'Surname'
								THEN ' WHERE Surname LIKE ''%'' + ISNULL(''' + @SearchString1 + ''','''') + ''%'' '
							WHEN 'Forenames'
								THEN ' WHERE Forename1 LIKE ''%'' + ISNULL(''' + @SearchString1 + ''','''') + ''%'' '
							END
					)
			
		END
	END
	ELSE
	BEGIN
		IF @SearchString1 IS NOT NULL AND @SearchString1 <> ''
		BEGIN
			SET @WhereStr = @WhereStr + (
					SELECT CASE @WhereStr
							WHEN ''	THEN ' WHERE ' ELSE @Condition END
					) + ' pt.HospitalNumber = ISNULL(''' + @SearchString1 + ''','''') '
			SET @WhereStr2 = @WhereStr2 + (
					SELECT CASE @WhereStr2
							WHEN ''	THEN ' WHERE ' ELSE @Condition END
					) + ' mj.SlaveExt LIKE ''%'' + ISNULL(''' + @SearchString1 + ''','''') + ''%'' '
			print @WhereStr2
		END

		IF @SearchString2 IS NOT NULL AND @SearchString2 <> ''
		BEGIN
			SET @WhereStr = @WhereStr + (
					SELECT CASE @WhereStr
							WHEN ''	THEN ' WHERE ' ELSE @Condition END
					) + ' REPLACE(NHSNo,'' '', '''') = ISNULL(''' + REPLACE(@SearchString2, ' ', '') + ''','''') '
		END

		IF @SearchString3 IS NOT NULL AND @SearchString3 <> ''
		BEGIN
			SET @WhereStr = @WhereStr + (
					SELECT CASE @WhereStr
							WHEN ''	THEN ' WHERE ' ELSE @Condition END
					) + ' ((Surname LIKE ''%'' + ISNULL(''' + @SearchString3 + ''','''') + ''%'') Or Soundex(Surname) = Soundex(''' + @SearchString3 + '%'')) '
		END

		IF @SearchString4 IS NOT NULL AND @SearchString4 <> ''
		BEGIN
			SET @WhereStr = @WhereStr + (
					SELECT CASE @WhereStr
							WHEN ''	THEN ' WHERE ' ELSE @Condition END
					) + ' ((Forename1 LIKE ''%'' + ISNULL(''' + @SearchString4 + ''','''') + ''%'') Or Soundex(Forename1) = Soundex(''' + @SearchString4 + '%'')) '
		END

		IF @SearchString5 IS NOT NULL AND @SearchString5 <> ''
		BEGIN
			SET @WhereStr = @WhereStr + (
					SELECT CASE @WhereStr
							WHEN ''	THEN ' WHERE ' ELSE @Condition END
					) + ' DateOfBirth = '''' + ISNULL(''' + @SearchString5 + ''','''') + '''' '
		END

		IF @SearchString6 IS NOT NULL AND @SearchString6 <> ''
		BEGIN
			SET @WhereStr = @WhereStr + (
					SELECT CASE @WhereStr
							WHEN ''	THEN ' WHERE ' ELSE @Condition END
					) + ' LTRIM(RTRIM(Address)) LIKE ''%'' + ISNULL(''' + LTRIM(RTRIM(@SearchString6)) + ''','''') + ''%'' '
		END

		IF @SearchString7 IS NOT NULL AND @SearchString7 <> ''
		BEGIN
			SET @WhereStr = @WhereStr + (
					SELECT CASE @WhereStr
							WHEN ''	THEN ' WHERE ' ELSE @Condition	END
					) + ' REPLACE(Postcode, '' '', '''') LIKE ''%'' + ISNULL(''' + REPLACE(@SearchString7, ' ', '') + ''','''') + ''%'' '
		END

		IF @searchGender IS NOT NULL AND @searchGender <> ''
		BEGIN
			if @searchGender = 'N'
			begin
				SET @WhereStr = @WhereStr + (
					SELECT CASE @WhereStr
							WHEN ''	THEN ' WHERE ' ELSE @Condition	END
					) + ' (REPLACE(gt.Code, '' '', '''') = ISNULL(''' + REPLACE(@searchGender, ' ', '') + ''','''') Or gt.Code Is Null)'
			end
			else
			begin
				SET @WhereStr = @WhereStr + (
					SELECT CASE @WhereStr
							WHEN ''	THEN ' WHERE ' ELSE @Condition	END
					) + ' REPLACE(gt.Code, '' '', '''') = ISNULL(''' + REPLACE(@searchGender, ' ', '') + ''','''') '
			end

			
		END

	END
	--Added For Trust Requirement
	SET @WhereStr = @WhereStr + ' AND pt.TrustId= ' + cast(@TrustId as varchar)
	
	IF @ExcludeDeceased = 1
		BEGIN
			IF @WhereStr <> ''
				SET @WhereStr = @WhereStr + ' AND ISNULL([Deceased],0) = 0'
			ELSE
				SET @WhereStr = 'WHERE ISNULL([Deceased],0) = 0'
		END

	--SET @SelectStr = @SelectStr + @FromStr
END
ELSE IF @SearchCriteria = 2
BEGIN
	--IF @AllProcedures = 1
	--BEGIN
		--IF @SearchCriteriaOption =1 SET @SelectStr = 'SELECT DISTINCT p.[Patient No] AS PatientId, p.Forename + '' '' + p.Surname AS PatientName, p.[Case note no] AS CaseNoteNo, p.[NHS No] AS NHSNo, p.[Record created] AS CreatedOn,p.[Surname] ,p.[Case note no] ,p.[Product ID] ,p.[Location ID] ,p.[Patient No] ,  p.[Has Images] ,p.[Just downloaded] ,p.[Forename] ,p.[Record created] ,p.[Combo ID] ,p.[NHS No] ,p.[Date of death]  FROM Patient p'
		IF @SearchCriteriaOption = 2 AND @SearchCriteriaOptionPatientCount > 0
			SET @SelectStr = 'SELECT TOP(' + CAST(@SearchCriteriaOptionPatientCount AS VARCHAR(50)) + ')  p.PatientId, p.Forename1 + '' '' + p.Surname AS PatientName, p.Address1 as Address, p.DateOfBirth AS DOB, UPPER(SUBSTRING(p.Gender,1,1)) as Gender, dbo.fnEthnicity(p.EthnicId) as Ethnicity, p.HospitalNumber AS CaseNoteNo, p.NHSNo, p.DateAdded AS CreatedOn, ISNULL(Deceased,0) AS Deceased (**) '
		ELSE IF @SearchCriteriaOption = 3 AND @SearchCriteriaOptionDate IS NOT NULL
			SET @WhereStr = 'WHERE DateAdded >= ''' + cast(@SearchCriteriaOptionDate AS VARCHAR(50)) + ''' '
		ELSE IF @SearchCriteriaOption = 4 AND @SearchCriteriaOptionMonths > 0
			SET @WhereStr = 'WHERE DateAdded >= DATEADD(MM,-' + CAST(@SearchCriteriaOptionMonths AS VARCHAR(50)) + ', GETDATE())'

		IF @ExcludeDeceased = 1
		BEGIN
			IF @WhereStr <> ''
				SET @WhereStr = @WhereStr + ' AND ISNULL([Deceased],0) = 0'
			ELSE
				SET @WhereStr = 'WHERE ISNULL([Deceased],0) = 0'
		END

		--SET @SelectStr = @SelectStr + @FromStr

END

IF @OrderListOptions = 2
	SET @OrderStr = ' ORDER BY [Surname], p.PatientId  DESC'

SET @Statement = @SelectStr + @FromStr + @WhereStr + @OrderStr
SET @Statement2 = @SelectStr + @FromStr + @WhereStr + ' union ' + @SelectStr + @FromStr2 + @WhereStr2 + @OrderStr

SET @Statement = (
					SELECT CASE @SearchType
							WHEN 'EQUALTO'
								THEN REPLACE(REPLACE(REPLACE(@Statement,'LIKE','='),'''%'' +',''),'+ ''%''','')
							WHEN 'STARTSWITH'
								THEN REPLACE(@Statement,'''%'' +','')
							WHEN 'ENDSWITH'
								THEN REPLACE(@Statement,'+ ''%''','')
							WHEN 'CONTAINS'
								THEN @Statement	
							END
					)
SET @Statement2 = (
					SELECT CASE @SearchType
							WHEN 'EQUALTO'
								THEN REPLACE(REPLACE(REPLACE(@Statement2,'LIKE','='),'''%'' +',''),'+ ''%''','')
							WHEN 'STARTSWITH'
								THEN REPLACE(@Statement2,'''%'' +','')
							WHEN 'ENDSWITH'
								THEN REPLACE(@Statement2,'+ ''%''','')
							WHEN 'CONTAINS'
								THEN @Statement2	
							END
					)

print @Statement

print @Statement2
IF ISNULL(@SearchString1, '') = ''
BEGIN
	EXEC sp_executesql @Statement
END
else
BEGIN
	EXEC sp_executesql @Statement2
END


DECLARE
	@sqlStringAudit NVARCHAR(MAX) = 'Searched: '

BEGIN

	IF @Condition <> '' 
	BEGIN
		SET @sqlStringAudit = @sqlStringAudit + 'Search Condition: ' + ISNULL(@Condition, '') + '. '
	END

	IF @SearchString1 <> '' 
	BEGIN
		SET @sqlStringAudit = @sqlStringAudit + 'Case Note No: ' + ISNULL(@SearchString1, '') + '. '
	END
	
	IF ISNULL(@SearchString2, '') <> ''
	BEGIN
		SET @sqlStringAudit = @sqlStringAudit + 'NHS No: ' + ISNULL(@SearchString2, '') + '. '
	END	

	IF ISNULL(@SearchString3, '') <> ''
	BEGIN
		SET @sqlStringAudit = @sqlStringAudit + 'Surname: ' + ISNULL(@SearchString3, '') + '. '
	END

	IF ISNULL(@SearchString4, '') <> ''
	BEGIN
		SET @sqlStringAudit = @sqlStringAudit + 'Forename: ' + ISNULL(@SearchString4, '') + '. '
	END

	IF ISNULL(@SearchString5, '') <> ''
	BEGIN	
		SET @sqlStringAudit = @sqlStringAudit + 'Date of Birth: ' + ISNULL(@SearchString5, '') + '. '
	END

	IF ISNULL(@SearchString6, '') <> ''
	BEGIN
		SET @sqlStringAudit = @sqlStringAudit + 'Address: ' + ISNULL(@SearchString6, '') + '. '
	END

	IF ISNULL(@SearchString7, '') <> ''
	BEGIN
		SET @sqlStringAudit = @sqlStringAudit + 'Postcode: ' + ISNULL(@SearchString7, '') + '. '
	END

	IF ISNULL(@searchGender, '') <> ''
	BEGIN
		SET @sqlStringAudit = @sqlStringAudit + 'Gender: ' + ISNULL(@searchGender, '') + '. '
	END

	IF @ExcludeDeceased = 1
	BEGIN
		SET @sqlStringAudit = @sqlStringAudit + 'Exclude Deceased: True. '
	END
	ELSE
	BEGIN
		SET @sqlStringAudit = @sqlStringAudit + 'Exclude Deceased: False. '
	END

	BEGIN
	INSERT INTO ERS_UserActivityAudit
	(
		[UserID],
		[UserName],
		[Action],
		[ActionDetails],
		[PatientId],	
		[When]	
	)
	VALUES
	(
		@UserId,
		UPPER(@UserName),
		'SEARCH',
		@sqlStringAudit,
		NULL,
		GETDATE()
	)
	END
END
GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	(Reduce deadlock errors)
------------------------------------------------------------------------------------------------------------------------
GO


 ------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Partha Kundu
-- TFS#	3640
-- Description of change: Update/Insert Patient from Spine Search 
-- 
------------------------------------------------------------------------------------------------------------------------

GO
PRINT N'Altering [dbo].[stp_InsertUpdatePatientFromSPINEAPI]...';

GO

EXEC dbo.DropIfExist @ObjectName = 'stp_InsertUpdatePatientFromSPINEAPI',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)

GO
Create PROCEDURE [dbo].[stp_InsertUpdatePatientFromSPINEAPI]
(
	@PatientId INT=NULL,
	@CaseNoteNo VARCHAR(100),
	@Title VARCHAR(20),
	@Forename VARCHAR(100),
	@Surname NVARCHAR(100),
	@DateOfBirth DATETIME2,
	@NHSNo VARCHAR(20),
	@Address1 NVARCHAR(500),
	@Address2 NVARCHAR(500),
	@Town NVARCHAR(500),
	@County NVARCHAR(500),
	@PostCode VARCHAR(10),
	@PhoneNo VARCHAR(20),
	@Gender VARCHAR(1),
	@EthnicOrigin VARCHAR(100)=NULL,
	@District VARCHAR(50)=NULL,
	@GPGMCCode NVARCHAR(20)=NULL,
	@GPPracticeCode NVARCHAR(20)=NULL,
	@DateOfDeath DATETIME2=NULL,
	@Hospitals INT=NULL,
	@UniqueHospitalId INT=NULL,
	@LoggedInUserId INT,
	@MaritalStatus varchar(100)=null,
	@SearchedNHSNo varchar(100)=null,
	@TrustId INT=NULL
)
AS

SET NOCOUNT ON

BEGIN TRANSACTION

BEGIN TRY
       declare @intOurPatientID as int
	   declare @intMaritalStatusId as int

	   declare @GPId as int
	   declare @PracticeId as int

	   
	   If IsNull(@TrustId,0) = 0 or not exists(Select * from ERS_Trusts where TrustID = @TrustId)
	   begin
		Select top 1 @TrustId = TrustID from ERS_Trusts
	   end


	    IF @GPGMCCode is not null 
	   begin
		Select  @GPId = GPId from ERS_GPS where [Code] = @GPGMCCode
	   end
	   IF ISNULL(@GPId,0) = 0 
	      SELECT @GPId = GPId  FROM dbo.ERS_GPS WHERE [Code] = 'G9999998'

	IF @GPPracticeCode is not null 
	   begin
		Select  @PracticeId = PracticeID from ERS_Practices where [Code] = @GPPracticeCode
	   end
	 

	 

	   Select top 1 @intMaritalStatusId = IsNull(MaritalId,0) from dbo.ERS_Marital_Status where [Status] = @MaritalStatus 
	   if IsNull(@intMaritalStatusId,0) = 0
	   begin
		Select top 1 @intMaritalStatusId = IsNull(MaritalId,0) from dbo.ERS_Marital_Status where [Status] Like Convert(varchar(max),@MaritalStatus + '%')
	   end
	   if IsNull(@intMaritalStatusId,0) = 0
	   begin
		Select top 1 @intMaritalStatusId = IsNull(MaritalId,0) from dbo.ERS_Marital_Status where [Status] = 'Unknown'
	   end
	   if IsNull(@intMaritalStatusId,0) = 0
	   begin
		Select top 1 @intMaritalStatusId = IsNull(MaritalId,0) from dbo.ERS_Marital_Status where [Status] = 'Not disclosed'
	   end

     

	   --1. First check with CHI no (our NHSNo) and Full Name and Date Of Birth
	   SELECT @intOurPatientID = PatientId FROM ERS_Patients WHERE Forename1 = @Forename and Surname = @Surname and NHSNo = @NHSNo and DateOfBirth=@DateOfBirth

	   
	   --2. Secondly check with CHI no and Date of Birth
	   IF ISNULL(@intOurPatientID,0)= 0
	   begin
	   SELECT @intOurPatientID = PatientId FROM ERS_Patients WHERE NHSNo = @NHSNo and DateOfBirth=@DateOfBirth
	   end

	   --3. Thirdly check with CHI no
	   IF ISNULL(@intOurPatientID,0)= 0
	   begin
	   SELECT @intOurPatientID = PatientId FROM ERS_Patients WHERE NHSNo = @NHSNo
	   end


	 

      

	IF ISNULL(@intOurPatientID,0)= 0
	BEGIN
		INSERT INTO ERS_Patients (
			HospitalNumber
			,[Title]
			,[Forename1]
			,[Surname]
			,[Dateofbirth]
			,[NHSNo]
			,[Address1]
			,[Address2]
			,[Address3]
			,[Address4]
			,[Postcode]
			,[Telephone]
			,[GenderId]
			,[EthnicId]
			,[MaritalId]
			,[RegGpId]
			,[RegGpPracticeId]
			,[Dateofdeath]
			,[WhoCreatedId]
			,[WhenCreated]
			,[CreateUpdateMethod]
			,[AccountNumber])
		VALUES (
			@CaseNoteNo,
			@Title,
			@Forename,
			@Surname,
			@DateOfBirth,
			@NHSNo,
			@Address1,
			@Address2,
			@Town,
			@County,
			@PostCode,
			@PhoneNo,
			(SELECT GenderId FROM ERS_GenderTypes WHERE Code = @Gender),
			(SELECT EthnicOriginId FROM ERS_EthnicOrigins WHERE EthnicOrigin = @EthnicOrigin),
			@intMaritalStatusId,
			@GPId,
			@PracticeId,
			@DateOfDeath,
			@LoggedInUserId,
			GETDATE(),
			'SPINEAPI',
			Cast(@PatientId as varchar(max)))
		SET @intOurPatientID = SCOPE_IDENTITY()

		
		Insert into ERS_PatientTrusts(PatientId,TrustId,HospitalNumber)
		Values(@intOurPatientID,@TrustId,@NHSNo)
	END
	ELSE
	BEGIN
		UPDATE 
			ERS_Patients
		SET 
			Title = @Title,
			Forename1 = @Forename,
			Surname = @Surname,
			[Dateofbirth] = @DateOfBirth,
			[NHSNo] = @NHSNo,
			[Address1] = @Address1,
			[Address2] = @Address2,
			[Address3] = @Town,
			[Address4] = @County,
			[Postcode] = @PostCode,
			[Telephone] = @PhoneNo,
			GenderId = (SELECT top 1 GenderId FROM ERS_GenderTypes WHERE Code = @Gender),
			[EthnicId] = (SELECT top 1 EthnicOriginId FROM ERS_EthnicOrigins WHERE EthnicOrigin = @EthnicOrigin),
			MaritalId = @intMaritalStatusId,
			RegGPId = @GPId,
			RegGpPracticeId = @PracticeId,
			[Dateofdeath] = @DateOfDeath,
			WhoUpdatedId = @LoggedInUserId,
			WhenUpdated = GETDATE(),
			CreateUpdateMethod = 'SPINEAPI'
		WHERE 
			[PatientId] = @intOurPatientID

		
			if exists(Select * from ERS_PatientTrusts where PatientId = @intOurPatientID) 
			Begin
				Update ERS_PatientTrusts
				Set HospitalNumber = @NHSNo,
				TrustId = @TrustId
				Where PatientId = @intOurPatientID
			End
			else
			Begin
				Insert into ERS_PatientTrusts(PatientId,TrustId,HospitalNumber)
				Values(@intOurPatientID,@TrustId,@NHSNo)
			End

			

	END

	if ((@SearchedNHSNo is not null) and  @SearchedNHSNo != @NHSNo )
	begin
		Insert into ERS_PatientTrusts(PatientId,TrustId,HospitalNumber,IsMinor)
				Values(@intOurPatientID,@TrustId,@SearchedNHSNo,1)
	end 

	If IsNull(@GPId,0) > 0 and IsNull(@PracticeId,0) > 0 
	Begin
		If Not Exists(Select * from ERS_Practices_Link Where GPId = @GPId and PracticeId = @PracticeId) 
		Begin
			Insert into ERS_Practices_Link(GPId,PracticeId,IsPrimary,WhoCreatedId,WhenCreated)
			Values(@GPId,@PracticeId,1,@LoggedInUserId,getdate())
		End
	End

	SELECT @intOurPatientID
END TRY

BEGIN CATCH
       DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;
    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);
       IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH
IF @@TRANCOUNT > 0 COMMIT TRANSACTION;
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#3640 	(Update/Insert Patient from Spine API )
------------------------------------------------------------------------------------------------------------------------
GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 28.11.23
-- TFS#	
-- Description of change
-- Changed Point mappings page role configuration to Admin Utilities section in system settings
------------------------------------------------------------------------------------------------------------------------
GO

UPDATE dbo.ERS_Pages 
SET GroupId = (SELECT GroupId FROM dbo.ERS_PageGroups WHERE GroupName = 'Admin Utilities') 
WHERE AppPageName = 'products_options_scheduler_pointmappings_aspx'
AND PageName = 'Points'
GO

--remove the duplicated page.
UPDATE dbo.ERS_Pages 
SET GroupId = NULL
WHERE AppPageName = 'products_options_scheduler_pointmappings_aspx'
AND PageName = 'PointMappings'
GO

UPDATE ERS_MenuMap SET ParentID = (SELECT MapId FROM ERS_MenuMap WHERE NodeName = 'Admin Utilities'), Suppressed = 0 WHERE NodeName = 'Points'
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea Johnson
-- TFS#	
-- Description of change
-- Corrected location of where addition text is taken from then indication other is selected
------------------------------------------------------------------------------------------------------------------------
GO

/****** Object:  UserDefinedFunction [dbo].[tvfNED_ProcedureIndication]    Script Date: 04/12/2023 10:09:37 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER FUNCTION [dbo].[tvfNED_ProcedureIndication]
(
	@ProcedureId AS INT
)
-- =============================================
-- Description:	This will return the list of 'Indication' for each Procedure- required for NED Export!
-- =============================================
RETURNS TABLE 
AS
RETURN 
(
  Select procedureindicationid,ISNULL(NULLIF(dbo.HTMLDecode(EI.NEDTerm),''), 'Other') NEDTerm --any entry that does not have a NED term in the lookup table is to be treated as other
		, CASE WHEN EI.NEDTerm = 'Other' then EI.[Description] ELSE NULL END AS Comment --where the NED term is blank, the description should be included in the other field
		, CASE WHEN EI.NEDTerm = 'FIT Positive' then CONVERT(decimal(18,2), EPI.AdditionalInformation) ELSE NULL END AS fitPositiveValue
		, CASE WHEN EI.NEDTerm = 'Elevated calprotectin' then EPI.AdditionalInformation ELSE NULL END AS elevatedCalprotectinValue
  from ERS_ProcedureIndications EPI
  join ERS_Indications EI on ISNULL(NULLIF(EPI.ChildIndicationId,0), EPI.IndicationId) = EI.UniqueId
  WHERE EPI.ProcedureId = @ProcedureId
);
GO


------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea
-- TFS#	
-- Description of change
-- Changes to j manouvre and extent retrieval 
------------------------------------------------------------------------------------------------------------------------
GO

ALTER FUNCTION [dbo].[tvfNED_ProcedureConsultants]
(
	@ProcedureId AS INT
	, @ProcedureType AS INT
)
-- =============================================
-- Description:	This will return the list of 'Consultants' for each Procedure- required for NED Export!
-- =============================================
RETURNS TABLE 
AS
RETURN 
(
	WITH EndoscopistSummary AS(
		select top 1 ProcedureId AS ProcedureId, ProcedureType, End1_GMCCode, Endoscopist1, Endo1Role, RoleTypeEnd1, End2_GMCCode, Endoscopist2, Endo2Role, RoleTypeEnd2, ListType from tvfEndoscopistSelectByProcedureSite(@ProcedureId,0)	
	)
	Select DISTINCT E.ProcedureId
	--, C.GMCCode AS professionalBodyCode
	--, 'UNITrainer' AS professionalBodyCode	 --## Change it for LIVE. In TEST- we need this dummy data to pass the NED Validation check!
	, LTRIM(RTRIM(E.End1_GMCCode)) AS professionalBodyCode
	, E.Endoscopist1 AS EndosId 
	, E.Endo1Role AS EndRole, E.ListType
	, E.RoleTypeEnd1 AS procedureRole
	, (Case E.Endo1Role When 1 Then 'Independent' Else 'Trainer' END) As endoscopistRole
	, 1 AS ConsultantTypeId
	,(SELECT
		CASE 
			WHEN E.ProcedureType IN (1) THEN
				CASE WHEN E.Endoscopist2 IS NULL THEN UEX.NedTerm
					 WHEN E.Endo1Role <> 1 AND NOT EXISTS (SELECT 1 FROM dbo.ERS_ProcedureUpperExtent epue WHERE epue.EndoscopistId = E.Endoscopist1 AND epue.JManoeuvreId IS NOT NULL AND epue.ProcedureId = @ProcedureId) /*Trainee has an entry*/
										 THEN (SELECT UEX.NedTerm FROM dbo.ERS_ProcedureUpperExtent epue WHERE epue.EndoscopistId = E.Endoscopist2 AND epue.ProcedureId = @ProcedureId) /*TrainEE did it so TrainER gets it too*/
					/*WHEN Endo1Role = 1 THEN*/ ELSE (SELECT UEX.NedTerm FROM dbo.ERS_ProcedureUpperExtent epue WHERE epue.EndoscopistId = E.Endoscopist1 AND epue.ProcedureId = @ProcedureId) /*Endo is independant or TrainER did it alone */
				END
			WHEN E.ProcedureType IN (3,4) THEN
				CASE WHEN E.Endoscopist2 IS NULL THEN LEX.NEDTerm
					 WHEN E.Endo1Role <> 1 AND NOT EXISTS (SELECT 1 FROM dbo.ERS_ProcedureLowerExtent epue WHERE epue.EndoscopistId = E.Endoscopist1 AND epue.RetroflectionPerformed IS NOT NULL AND epue.ProcedureId = @ProcedureId) 
										 THEN (SELECT LEX.NEDTerm FROM dbo.ERS_ProcedureLowerExtent epue WHERE epue.EndoscopistId = E.Endoscopist2 AND epue.ProcedureId = @ProcedureId) /*TrainEE did it so TrainER gets it too*/
					/*WHEN E.Endo1Role = 1 THEN*/ ELSE (SELECT LEX.NEDTerm FROM dbo.ERS_ProcedureLowerExtent epue WHERE epue.EndoscopistId = E.Endoscopist1 AND epue.ProcedureId = @ProcedureId) /*Endo is independant or TrainER did it alone */

				END
	 END) AS Extent
	,(SELECT
		CASE 
			WHEN E.ProcedureType IN (1) THEN
				CASE WHEN E.Endoscopist2 IS NULL THEN PUE.JManoeuvreId
					 WHEN E.Endo1Role <> 1 AND NOT EXISTS (SELECT 1 FROM dbo.ERS_ProcedureUpperExtent epue WHERE epue.EndoscopistId = E.Endoscopist1 AND epue.JManoeuvreId IS NOT NULL AND epue.ProcedureId = @ProcedureId) /*Trainee has an entry*/
										 THEN (SELECT CONVERT(BIT, epue.JManoeuvreId) FROM dbo.ERS_ProcedureUpperExtent epue WHERE epue.EndoscopistId = E.Endoscopist2 AND epue.ProcedureId = @ProcedureId) /*TrainEE did it so TrainER gets it too*/
					/*WHEN Endo1Role = 1 THEN*/ ELSE (SELECT CONVERT(BIT, epue.JManoeuvreId) FROM dbo.ERS_ProcedureUpperExtent epue WHERE epue.EndoscopistId = E.Endoscopist1 AND epue.ProcedureId = @ProcedureId) /*Endo is independant or TrainER did it alone */
				END
			WHEN E.ProcedureType IN (3,4) THEN
				CASE WHEN E.Endoscopist2 IS NULL THEN PLE.RetroflectionPerformed
					 WHEN E.Endo1Role <> 1 AND NOT EXISTS (SELECT 1 FROM dbo.ERS_ProcedureLowerExtent epue WHERE epue.EndoscopistId = E.Endoscopist1 AND epue.RetroflectionPerformed IS NOT NULL AND epue.ProcedureId = @ProcedureId) 
										 THEN (SELECT epue.RetroflectionPerformed FROM dbo.ERS_ProcedureLowerExtent epue WHERE epue.EndoscopistId = E.Endoscopist2 AND epue.ProcedureId = @ProcedureId) /*TrainEE did it so TrainER gets it too*/
					/*WHEN E.Endo1Role = 1 THEN*/ ELSE (SELECT epue.RetroflectionPerformed FROM dbo.ERS_ProcedureLowerExtent epue WHERE epue.EndoscopistId = E.Endoscopist1 AND epue.ProcedureId = @ProcedureId) /*Endo is independant or TrainER did it alone */

				END
		END) AS jManoeuvre
	 FROM EndoscopistSummary AS E
	 LEFT JOIN ERS_ProcedureLowerExtent				AS PLE ON PLE.ProcedureId = E.ProcedureId AND PLE.EndoscopistId = E.Endoscopist1
	 LEFT JOIN ERS_Extent							AS LEX  ON LEX.UniqueId = PLE.ExtentId
	 LEFT JOIN ERS_ProcedureUpperExtent				AS PUE ON PUE.ProcedureId = E.ProcedureId AND PUE.EndoscopistId = E.Endoscopist1
	 LEFT JOIN ERS_Extent							AS UEX  ON UEX.UniqueId = PUE.ExtentId
	 LEFT JOIN dbo.ERS_Users						AS U   ON E.Endoscopist1 = U.UserId

	UNION ALL --## Now Combine the TrainEE Record!
	
	Select DISTINCT E.ProcedureId
	--, C.GMCCode AS professionalBodyCode
	--, 'UNITrainee' AS professionalBodyCode --## Change it for LIVE. In TEST- we need this dummy data to pass the NED Validation check!
	, LTRIM(RTRIM(E.End2_GMCCode)) AS professionalBodyCode
	, E.Endoscopist2 AS EndosId, E.Endo2Role  AS EndRole, E.listType
	, E.RoleTypeEnd2 AS procedureRole
	, (Case E.Endo2Role When 1 Then 'Independent' Else 'Trainee' END) As endoscopistRole
	, 2 AS ConsultantTypeId
	, (SELECT 
		CASE 
			WHEN E.ProcedureType IN (1) THEN
				CASE WHEN E.Endo2Role = 1 THEN (SELECT UEX.NEDTerm FROM dbo.ERS_ProcedureUpperExtent epue WHERE epue.EndoscopistId = E.Endoscopist2 AND epue.ProcedureId = @ProcedureId)
					 WHEN E.Endo2Role <> 1 AND EXISTS (SELECT 1 FROM dbo.ERS_ProcedureUpperExtent epue WHERE epue.EndoscopistId = E.Endoscopist2 AND epue.JManoeuvreId IS NOT NULL AND epue.ProcedureId = @ProcedureId) 
												THEN (SELECT UEX.NEDTerm FROM dbo.ERS_ProcedureUpperExtent epue WHERE epue.EndoscopistId = E.Endoscopist2 AND epue.ProcedureId = @ProcedureId)  /*TrainEEs outcome*/
				END
			WHEN E.ProcedureType IN (3,4) THEN 
				CASE WHEN E.Endo2Role = 1 THEN  (SELECT LEX.NEDTerm FROM dbo.ERS_ProcedureLowerExtent epue WHERE epue.EndoscopistId = E.Endoscopist2 AND epue.ProcedureId = @ProcedureId)
					 WHEN E.Endo2Role <> 1 AND EXISTS (SELECT 1 FROM dbo.ERS_ProcedureLowerExtent epue WHERE epue.EndoscopistId = E.Endoscopist2 AND epue.RetroflectionPerformed IS NOT NULL AND epue.ProcedureId = @ProcedureId) 
											THEN (SELECT LEX.NEDTerm FROM dbo.ERS_ProcedureLowerExtent epue WHERE epue.EndoscopistId = E.Endoscopist2 AND epue.ProcedureId = @ProcedureId) /*TrainEEs outcome*/
				END
		END) AS Extent
	, (SELECT 
		CASE 
			WHEN E.ProcedureType IN (1) THEN
				CASE WHEN E.Endo2Role = 1 THEN (SELECT epue.JManoeuvreId FROM dbo.ERS_ProcedureUpperExtent epue WHERE epue.EndoscopistId = E.Endoscopist2 AND epue.ProcedureId = @ProcedureId)
					 WHEN E.Endo2Role <> 1 AND EXISTS (SELECT 1 FROM dbo.ERS_ProcedureUpperExtent epue WHERE epue.EndoscopistId = E.Endoscopist2 AND epue.JManoeuvreId IS NOT NULL AND epue.ProcedureId = @ProcedureId) 
												THEN (SELECT CONVERT(BIT, epue.JManoeuvreId) FROM dbo.ERS_ProcedureUpperExtent epue WHERE epue.EndoscopistId = E.Endoscopist2 AND epue.ProcedureId = @ProcedureId)  /*TrainEEs outcome*/
				END
			WHEN E.ProcedureType IN (3,4) THEN 
				CASE WHEN E.Endo2Role = 1 THEN  (SELECT epue.RetroflectionPerformed FROM dbo.ERS_ProcedureLowerExtent epue WHERE epue.EndoscopistId = E.Endoscopist2 AND epue.ProcedureId = @ProcedureId)
					 WHEN E.Endo2Role <> 1 AND EXISTS (SELECT 1 FROM dbo.ERS_ProcedureLowerExtent epue WHERE epue.EndoscopistId = E.Endoscopist2 AND epue.RetroflectionPerformed IS NOT NULL AND epue.ProcedureId = @ProcedureId) 
											THEN (SELECT epue.RetroflectionPerformed FROM dbo.ERS_ProcedureLowerExtent epue WHERE epue.EndoscopistId = E.Endoscopist2 AND epue.ProcedureId = @ProcedureId) /*TrainEEs outcome*/
				END
		END) AS jManoeuvre	
	from EndoscopistSummary AS E 
		LEFT JOIN ERS_ProcedureLowerExtent				AS PLE ON PLE.ProcedureId = E.ProcedureId AND PLE.EndoscopistId = E.Endoscopist2
		 LEFT JOIN ERS_Extent							AS LEX  ON LEX.UniqueId = PLE.ExtentId
		 LEFT JOIN ERS_ProcedureUpperExtent				AS PUE ON PUE.ProcedureId = E.ProcedureId AND PUE.EndoscopistId = E.Endoscopist2
		 LEFT JOIN ERS_Extent							AS UEX  ON UEX.UniqueId = PUE.ExtentId
		LEFT JOIN dbo.ERS_Users							AS U   ON E.Endoscopist2 = U.UserId
	Where E.Endoscopist2 IS NOT NULL
	);



------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO



------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 08.12.23
-- TFS#	n/a
-- Description of change
-- scheduler transformation 
------------------------------------------------------------------------------------------------------------------------
GO

SET QUOTED_IDENTIFIER ON
SET ANSI_NULLS ON
GO

ALTER procedure [dbo].[sys_get_list_slots]
(
	@ListRulesId INT
)    
as
select * from ERS_SCH_ListSlots
where ListRulesId = @ListRulesId AND Active = 1
GO

SET QUOTED_IDENTIFIER ON
SET ANSI_NULLS ON
GO
ALTER PROCEDURE [dbo].[sys_transformed_diary_add]
(
	@DiaryId INT,
	@Subject VARCHAR(500), 
	@DiaryStart DATETIME, 
	@DiaryEnd DATETIME, 
	@RoomID INT, 
	@UserID INT, 
	@RecurrenceFrequency VARCHAR(500), 
	@RecurrenceCount INT, 
	@RecurrenceParentID int, 
	@ListRulesId int,
	@Description varchar(500),
	@OperatingHospitalId INT,
	@Training bit,
	@ListConsultant int,
	@ListGenderId int,
	@IsGI BIT,
	@ListNotes VARCHAR(max),
	@Add BIT
)
AS
SET NOCOUNT ON

BEGIN TRANSACTION

BEGIN TRY

	--create copy of list rules
	INSERT INTO dbo.ERS_SCH_ListRules
	(
	    Points,
	    PointMins,
	    Endoscopist,
	    ListName,
	    GIProcedure,
	    Training,
	    StartTime,
	    Suppressed,
	    OperatingHospitalId,
	    NonGIProcedureTypeId,
	    NonGIProcedureMinutesPerPoint,
	    NonGIDiagnosticCallInTime,
	    NonGIDiagnosticProcedurePoints,
	    NonGITherapeuticCallInTime,
	    NonGITherapeuticProcedurePoints,
	    WhoUpdatedId,
	    WhoCreatedId,
	    WhenCreated,
	    WhenUpdated,
	    ListConsultantId,
	    TotalMins,
	    IsTemplate,
	    GenderId
	)
	SELECT 
		Points,
	    PointMins,
	    Endoscopist,
	    ListName,
	    GIProcedure,
	    Training,
	    StartTime,
	    Suppressed,
	    OperatingHospitalId,
	    NonGIProcedureTypeId,
	    NonGIProcedureMinutesPerPoint,
	    NonGIDiagnosticCallInTime,
	    NonGIDiagnosticProcedurePoints,
	    NonGITherapeuticCallInTime,
	    NonGITherapeuticProcedurePoints,
	    WhoUpdatedId,
	    WhoCreatedId,
	    WhenCreated,
	    WhenUpdated,
	    ListConsultantId,
	    TotalMins,
	    IsTemplate,
	    GenderId
	FROM dbo.ERS_SCH_ListRules WHERE ListRulesId = @ListRulesId

	--retrieve list rules id
	DECLARE @NewListRulesId INT = SCOPE_IDENTITY()

	--create copy of list slots
	INSERT INTO dbo.ERS_SCH_ListSlots
	(
	    ListRulesId,
	    SlotId,
	    ProcedureTypeId,
	    StartTime,
	    EndTime,
	    Suppressed,
	    OperatingHospitalId,
	    WhoUpdatedId,
	    WhoCreatedId,
	    WhenCreated,
	    WhenUpdated,
	    ParentListSlotId,
	    SlotMinutes,
	    Active,
	    DeactivatedDateTime,
	    Points,
	    Locked,
	    IsOverBookedSlot
	)
	SELECT 
		@NewListRulesId,
	    SlotId,
	    ProcedureTypeId,
	    StartTime,
	    EndTime,
	    Suppressed,
	    OperatingHospitalId,
	    WhoUpdatedId,
	    WhoCreatedId,
	    WhenCreated,
	    WhenUpdated,
	    ParentListSlotId,
	    SlotMinutes,
	    Active,
	    DeactivatedDateTime,
	    Points,
	    Locked,
	    IsOverBookedSlot
	FROM dbo.ERS_SCH_ListSlots
	WHERE ListRulesId = @ListRulesId AND Active = 1 AND Suppressed = 0

	IF @Add = 1 
	BEGIN
		
		
		INSERT INTO [ERS_SCH_DiaryPages] 
		([Subject], [DiaryStart], [DiaryEnd], [RoomID], [UserID], [ListRulesId], [OperatingHospitalId], [RecurrenceFrequency], [RecurrenceCount], [RecurrenceParentID], [WhenCreated], [Training], [ListConsultantId], ListGenderId, IsGI, Notes) 
		SELECT ListName, @DiaryStart, @DiaryEnd, @RoomId, @UserID, @NewListRulesId, @OperatingHospitalId, @RecurrenceFrequency, @RecurrenceCount, @RecurrenceParentID, GETDATE(), Training, @ListConsultant, @ListGenderId, @IsGI, @ListNotes  
		FROM dbo.ERS_SCH_ListRules WHERE ListRulesId = @ListRulesId
		
		DECLARE @NewDiaryId INT = (SELECT SCOPE_IDENTITY ())

		UPDATE ERS_SCH_DiaryPages
		SET DiaryStart = dateadd(year,-100, DiaryStart),
			DiaryEnd = DATEADD(year, -100, DiaryEnd)
		WHERE DiaryId = @DiaryId and datediff(year, diarystart, getdate())< 50

		SELECT @NewDiaryId DiaryId, @NewListRulesId ListRulesId
	END
	ELSE
	BEGIN
		UPDATE ERS_SCH_DiaryPages
		SET ListGenderId = @ListGenderId,
			Notes = @ListNotes,
			IsGI = @IsGI,
			ListRulesId = @NewListRulesId,
			Suppressed = 0,
			SuppressedFromDate = NULL
		WHERE DiaryId = @DiaryId

		SELECT @DiaryId DiaryId, @NewListRulesId ListRulesId
	END
END TRY

BEGIN CATCH
       DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

       IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH

IF @@TRANCOUNT > 0 COMMIT TRANSACTION;
GO

EXEC dbo.DropIfExist @ObjectName = 'sys_get_all_diaries',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

EXEC dbo.DropIfExist @ObjectName = 'sys_get_all_diaries',      -- varchar(100)
                     @ObjectTypePrefix = '' -- varchar(5)
GO

CREATE procedure sys_get_all_diaries
as
begin
	select * from ERS_SCH_DiaryPages WHERE DiaryStart > dateadd(year,-50, GETDATE())
end
GO



EXEC dbo.DropIfExist @ObjectName = 'sys_get_diary',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[sys_get_diary]
(
	@DiaryId int
)
AS
BEGIN
	SELECT * FROM ERS_SCH_DiaryPages WHERE DiaryId = @DiaryId
END
GO



ALTER PROCEDURE [dbo].[sch_add_overbook_slot]
(		
	@DiaryId INT,
	@Points DECIMAL(18,2),
	@AppointmentId INT
)
AS
BEGIN
	DECLARE @OperatingHospitalId INT, @ListRulesId INT, @ListSlotId INT

	--get the list rules id for the diary 
	SELECT @OperatingHospitalId = OperatingHospitalId, @ListRulesId = ListRulesId FROM dbo.ERS_SCH_DiaryPages WHERE DiaryId = @DiaryId

	--insert new list slot
	INSERT INTO ERS_SCH_ListSlots (ListRulesId, SlotId, ProcedureTypeId, OperatingHospitalId, SlotMinutes, Points, IsOverBookedSlot)
	SELECT  @ListRulesId, PriorityiD, 0, @OperatingHospitalId, CONVERT(INT, a.AppointmentDuration), @Points, 1
	FROM dbo.ERS_Appointments a WHERE a.AppointmentId = @AppointmentId

	SELECT @ListSlotId = SCOPE_IDENTITY()

	--Update Appointment
	UPDATE dbo.ERS_Appointments SET ListSlotId = @ListSlotId, @DiaryId = @DiaryId WHERE AppointmentId = @AppointmentId
END
GO


SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



ALTER PROCEDURE [dbo].[sch_add_overbook_slot]
(		
	@DiaryId INT,
	@Points DECIMAL(18,2),
	@AppointmentId INT
)
AS
BEGIN
	DECLARE @OperatingHospitalId INT, @ListRulesId INT, @ListSlotId INT

	--get the list rules id for the diary 
	SELECT @OperatingHospitalId = OperatingHospitalId, @ListRulesId = ListRulesId FROM dbo.ERS_SCH_DiaryPages WHERE DiaryId = @DiaryId

	--insert new list slot
	INSERT INTO ERS_SCH_ListSlots (ListRulesId, SlotId, ProcedureTypeId, OperatingHospitalId, SlotMinutes, Points, IsOverBookedSlot)
	SELECT  @ListRulesId, PriorityiD, 0, @OperatingHospitalId, CONVERT(INT, a.AppointmentDuration), @Points, 1
	FROM dbo.ERS_Appointments a WHERE a.AppointmentId = @AppointmentId

	SELECT @ListSlotId = SCOPE_IDENTITY()

	--Update Appointment
	UPDATE dbo.ERS_Appointments SET ListSlotId = @ListSlotId, @DiaryId = @DiaryId WHERE AppointmentId = @AppointmentId
END






GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------

GO
	------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Chris Gammage 11/12/2023
-- TFS#	3674
-- Description of change; update to Anticoag menu
-- 
------------------------------------------------------------------------------------------------------------------------
GO
	INSERT INTO ERS_PotentialDamagingDrugs (Description, AntiCoag) --NEW--
	SELECT 'Therapeutic LMWH', 1
	WHERE NOT EXISTS (
	SELECT 1
	FROM ERS_PotentialDamagingDrugs
	Where Description = 'Therapeutic LMWH'
	AND AntiCoag = 1
	);

		INSERT INTO ERS_PotentialDamagingDrugs (Description, AntiCoag) --NEW--
	SELECT 'Prophylactic  LMWH', 1
	WHERE NOT EXISTS (
	SELECT 1
	FROM ERS_PotentialDamagingDrugs
	Where Description = 'Prophylactic  LMWH'
	AND AntiCoag = 1
	);

	    Update ERS_PotentialDamagingDrugs
  SET Description = 'Aspirin' 
  WHERE Description = 'aspirin';

     Update ERS_PotentialDamagingDrugs --MOVE--
  SET Description = 'Warfarin and Aspirin', AntiCoag = 1
  Where Description = 'Warfarin and Aspirin';
Go

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Shahriar 14.12.23
-- TFS#	3567
-- Description of change : Eosinophilic value not assign from table 
-- scheduler transformation 
------------------------------------------------------------------------------------------------------------------------
GO
ALTER PROCEDURE [dbo].[abnormalities_oesophagitis_summary_update]
(
	@SiteId INT
)
AS
	SET NOCOUNT ON
	
		DECLARE
		@summary VARCHAR(8000),
		@temp VARCHAR(50),
		@None BIT,
		@MucosalAppearance TINYINT,
		@Reflux BIT,
		@ActiveBleeding BIT,
		@MSMGrade1 BIT,
		@MSMGrade2a BIT,
		@MSMGrade2b BIT,
		@MSMGrade3 BIT,
		@MSMGrade4 BIT,
		@MSMGrade5 BIT,
		@ShortOesophagus BIT,
		@Ulcer BIT,
		@Stricture BIT,
		@LAClassification TINYINT,
		@Other BIT,
		@SuspectedCandida BIT,
		@CausticIngestion BIT,
		@SuspectedHerpes BIT,
		@CorrosiveBurns BIT,
		@Eosinophilic BIT,
		@OtherTypeOther BIT,
		@OtherTypeOtherDesc VARCHAR(200),
		@SuspectedCandidaSeverity TINYINT,
		@CausticIngestionSeverity TINYINT,
		@SuspectedHerpesSeverity TINYINT,
		@CorrosiveBurnsSeverity TINYINT,
		@EosinophilicSeverity TINYINT

		DECLARE @nonGrade5MSMText VARCHAR(200) = '',
				--@mMSM VARCHAR(50) = '',
				@sg2common VARCHAR(50) = '',
				@sg2common1 VARCHAR(50) = '',
				@Grade VARCHAR(50) = 'grade ',
				@sg1 VARCHAR(220) = '',
				@sg2 VARCHAR(220) = '',
				@sg2a VARCHAR(320) = '',
				@sg2b VARCHAR(320) = '',
				@sg3 VARCHAR(320) = '',
				@plus VARCHAR(10) = '',
				@Grade5BarrattsText VARCHAR(200) = '',
				@RefluxBleedingOnly VARCHAR(200) = ''

	SELECT 
		@None=[None],
		@MucosalAppearance = MucosalAppearance,
		@Reflux = ISNULL(Reflux,0),
		@ActiveBleeding = ISNULL(ActiveBleeding,0),
		@MSMGrade1 = ISNULL(MSMGrade1,0),
		@MSMGrade2a = ISNULL(MSMGrade2a,0),
		@MSMGrade2b = ISNULL(MSMGrade2b,0),
		@MSMGrade3 = ISNULL(MSMGrade3,0),
		@MSMGrade4 = ISNULL(MSMGrade4,0),
		@MSMGrade5 = ISNULL(MSMGrade5,0),
		@ShortOesophagus = ISNULL(ShortOesophagus,0),
		@Ulcer = ISNULL(Ulcer,0),
		@Stricture = ISNULL(Stricture,0),
		@LAClassification = LAClassification,
		@Other = Other,
		@SuspectedCandida = SuspectedCandida,
		@CausticIngestion = CausticIngestion,
		@SuspectedHerpes = SuspectedHerpes,
		@CorrosiveBurns = CorrosiveBurns,
		@Eosinophilic = Eosinophilic,
		@OtherTypeOther = OtherTypeOther,
		@OtherTypeOtherDesc = (SELECT ISNULL(OtherTypeOtherDesc,'') as [text()] FOR XML PATH('')),
		@SuspectedCandidaSeverity = SuspectedCandidaSeverity,
		@CausticIngestionSeverity = CausticIngestionSeverity,
		@SuspectedHerpesSeverity = SuspectedHerpesSeverity,
		@CorrosiveBurnsSeverity = CorrosiveBurnsSeverity,
		@EosinophilicSeverity = EosinophilicSeverity
	FROM
		ERS_UpperGIAbnoOesophagitis
	WHERE
		SiteId = @SiteId

	SET @Summary = ''
	SET @temp = ''
	--If 'No oesophagitis' then ...
	IF @None = 1
		SET @summary = @summary + 'No oesophagitis'
	
	ELSE IF @MucosalAppearance > 0 OR @Reflux = 1 OR @Other = 1
	BEGIN
        -- There IS Oesophagitis or Barrett's so ...
        -- nonMSMOesoText contains the non-MSM oesophagitis text
		DECLARE @tmpOeso TABLE(Val VARCHAR(MAX))

		DECLARE @tmpVal VARCHAR(500) = '',
				@LAClassText VARCHAR(300) = ''
		DECLARE @SC VARCHAR(50) = '',
				@SH VARCHAR(50) = '',
				@nonMSMOesoText VARCHAR(500) = '',
				@withText VARCHAR(20) = '',
				--@MA VARCHAR(50) = '',
				@Oeso VARCHAR(150) = '',
				@mMSM VARCHAR(150) = 'Modified Savary Miller '
		DECLARE @XMLlist XML
				
		IF @Other = 1
		BEGIN
			-- Suspected candida
			IF @SuspectedCandida = 1
			BEGIN
				SET @SC = CASE @SuspectedCandidaSeverity
							WHEN 1 THEN 'mild '
							WHEN 2 THEN 'moderate '
							WHEN 3 THEN 'severe '
							ELSE ''
						END
				SET @SC = @SC + 'candida'
				INSERT INTO @tmpOeso (Val) VALUES(@SC)
			END
			--Suspected herpes
			IF @SuspectedHerpes = 1
			BEGIN
				SET @SH = ''
				SET @SH = CASE @SuspectedHerpesSeverity
							WHEN 1 THEN 'mild '
							WHEN 2 THEN 'moderate '
							WHEN 3 THEN 'severe '
							ELSE ''
						END
				SET @SH = @SH + 'herpes'
				INSERT INTO @tmpOeso (Val) VALUES(@SH)
			END

			--'If either candida or herpes then add 'suspected'
			IF @SuspectedHerpes = 1 UPDATE @tmpOeso SET VAL = VAL + ' suspected' WHERE VAL LIKE '%herpes' --  SET @SH = @SH + ' suspected'
			ELSE IF @SuspectedCandida = 1  UPDATE @tmpOeso SET VAL = VAL + ' suspected' WHERE VAL LIKE '%candida' -- SET @SC = @SC + ' suspected'

			--IF @SuspectedHerpes = 1 INSERT INTO @tmpOeso (Val) VALUES(@SH)
			--IF @SuspectedCandida = 1 INSERT INTO @tmpOeso (Val) VALUES(@SC)

			--Caustic ingestion
			IF @CausticIngestion = 1
			BEGIN
				SET @tmpVal = ''
				SET @tmpVal = CASE @CausticIngestionSeverity
							WHEN 1 THEN 'mild '
							WHEN 2 THEN 'moderate '
							WHEN 3 THEN 'severe '
							ELSE ''
						END
				SET @tmpVal = @tmpVal + 'caustic ingestion'
				INSERT INTO @tmpOeso (Val) VALUES(@tmpVal)
			END

			--Corrosive ingestion burns
			IF @CorrosiveBurns = 1
			BEGIN
				SET @tmpVal = ''
				SET @tmpVal = CASE @CorrosiveBurnsSeverity
							WHEN 1 THEN 'mild '
							WHEN 2 THEN 'moderate '
							WHEN 3 THEN 'severe '
							ELSE ''
						END
				SET @tmpVal = @tmpVal + 'corrosice ingestion burns'
				INSERT INTO @tmpOeso (Val) VALUES(@tmpVal)
				print(11)
			END
			
			--Eosinophilic
			IF @Eosinophilic = 1
			BEGIN
				SET @tmpVal = ''
				SET @tmpVal = CASE @EosinophilicSeverity
							WHEN 1 THEN 'mild '
							WHEN 2 THEN 'moderate '
							WHEN 3 THEN 'severe '
							ELSE ''
						END
				SET @tmpVal = @tmpVal + 'eosinophilia'
				INSERT INTO @tmpOeso (Val) VALUES(@tmpVal)
			END
			
			--Other
			If @OtherTypeOther = 1 AND LTRIM(RTRIM(@OtherTypeOtherDesc)) <> ''
			BEGIN
				SET @tmpVal = ''
				SET @tmpVal = LTRIM(RTRIM(@OtherTypeOtherDesc))
				SET @tmpVal = dbo.fnFirstLetterUpper(@tmpVal)
				INSERT INTO @tmpOeso (Val) VALUES(@tmpVal)
			END
		END  --'Of Oesophagitis other

		--Mucosal appearance
		IF @MucosalAppearance > 0
		BEGIN
			SET @tmpVal = ''
			SET @tmpVal = CASE @MucosalAppearance
						WHEN 1 THEN 'normal mucosa'
						WHEN 2 THEN 'discrete erosion '
						WHEN 3 THEN 'discrete pseudomembranes '
						WHEN 4 THEN 'confluent ulceration '
						WHEN 5 THEN 'confluent pseudomembranes '
						ELSE ''
					END
			INSERT INTO @tmpOeso (Val) VALUES(@tmpVal)
			--IF @Reflux = 1 SET @temp = @temp + 'with '
		END

		SET @XMLlist = (SELECT Val FROM @tmpOeso FOR XML  RAW, ELEMENTS, TYPE)
		SET @nonMSMOesoText = dbo.fnBuildString(@XMLlist)

		--If there's only one of the above then the sentence will be concatenated with any others using the 'with' conjunction, else it will read 'together with'
		IF ISNULL((SELECT COUNT(Val) FROM @tmpOeso WHERE NOT VAL IS NULL),0) = 1
			SET @withText = ' with '
		ELSE IF ISNULL((SELECT COUNT(Val) FROM @tmpOeso WHERE NOT VAL IS NULL),0) <> 0
			SET @withText = ' together with '

		DECLARE @OesophagitisClassification BIT
		SELECT @OesophagitisClassification = ISNULL(OesophagitisClassification,0) FROM ERS_SystemConfig 
		WHERE OperatingHospitalID = 
			(SELECT OperatingHospitalID FROM ERS_Procedures WHERE ProcedureId = 
				(SELECT ProcedureId FROM ERS_Sites WHERE SiteId = @SiteId))

		--Which Oeso Classification?
		IF @LAClassification > 0 OR @OesophagitisClassification > 0
		BEGIN
			SET @tmpVal = ''
			SET @tmpVal = CASE @LAClassification
						WHEN 1 THEN 'grade A oesophagitis (mucosal breaks confined to the mucosal fold each no longer than 5mm'
						WHEN 2 THEN 'grade B oesophagitis (at least one mucosal break longer than 5mm confined to the mucosal fold but not continuous between two folds'
						WHEN 3 THEN 'grade C oesophagitis (mucosal breaks that are continuous between the tops of mucosal folds but not circumferential'
						WHEN 4 THEN 'grade D oesophagitis (extensive mucosal breaks engaging at least 75% of the oesophageal circumference'
						ELSE ''
					END
				
			IF @ActiveBleeding = 1 SET @tmpVal = @tmpVal + ' with active bleeding'
			IF @tmpVal > '' SET @tmpVal = @tmpVal + ')'

			DELETE @tmpOeso

			--If there's Short oesophagus
			IF @ShortOesophagus = 1 INSERT INTO @tmpOeso (Val) VALUES('short oesophagus')

			--If there's Ulceration
			IF @Ulcer = 1 INSERT INTO @tmpOeso (Val) VALUES('ulcer')

			IF @Stricture = 1 INSERT INTO @tmpOeso (Val) VALUES('stricture')
				
			SET @XMLlist = (SELECT Val FROM @tmpOeso FOR XML  RAW, ELEMENTS, TYPE)

			IF (SELECT COUNT(Val) FROM @tmpOeso) > 0 SET @tmpVal = @tmpVal + ' and ' + dbo.fnBuildString(@XMLlist)

			IF @tmpVal <> '' SET @LAClassText = dbo.fnFirstLetterUpper(@tmpVal)
		END
		ELSE
		BEGIN
			SET @tmpVal = ''

			DELETE FROM @tmpOeso

			If @MSMGrade5=1 SET @nonGrade5MSMText = @mMSM + 'grade 5. '

			--If the site has both reflux grade 5 and grade 4
			If @MSMGrade5=1 AND (@MSMGrade4=1 OR @MSMGrade3=1 OR @MSMGrade2b=1 OR @MSMGrade2a=1 OR @MSMGrade1=1) 
			BEGIN
				SET @nonGrade5MSMText = @nonGrade5MSMText + 'This is associated with '
				SET @mMSM = 'grade 4 '
			END

			--If the site is not 5 but is 4 or less
			If @MSMGrade5=0 AND (@MSMGrade4=1 OR @MSMGrade3=1 OR @MSMGrade2b=1 OR @MSMGrade2a=1 OR @MSMGrade1=1) 
			BEGIN
				SET @nonGrade5MSMText = @nonGrade5MSMText + @mMSM

				IF @MSMGrade4=1
				BEGIN
					SET @nonGrade5MSMText = @nonGrade5MSMText + 'grade 4 '
					SET @Grade = ''
					SET @mMSM = ''
				END
			END

			IF @MSMGrade4=1
			BEGIN
				SET @plus = ' plus '
				IF @ShortOesophagus=0 AND @Ulcer=0 AND @Stricture=0 
					SET @nonGrade5MSMText = @nonGrade5MSMText + @mMSM + 'chronic lesions'
			END

			--If there's Grade 4 Short oesophagus
			IF @ShortOesophagus=1 INSERT INTO @tmpOeso (Val) VALUES('short oesophagus')

			--If there's Grade 4 Ulceration
			IF @Ulcer=1  INSERT INTO @tmpOeso (Val) VALUES('ulcer')

			IF @Stricture=1  INSERT INTO @tmpOeso (Val) VALUES('stricture')

			IF (SELECT COUNT(Val) FROM @tmpOeso) > 0
			BEGIN
				SET @XMLlist = (SELECT Val FROM @tmpOeso FOR XML  RAW, ELEMENTS, TYPE)
				SET @nonGrade5MSMText = RTRIM(@nonGrade5MSMText) + ' ' + @mMSM + dbo.fnBuildString(@XMLlist)
			END 

			SET @sg2common = 'multiple erosions, non-circumferential, '
			SET @sg2common1 = 'affecting more than one longitudinal fold '

			IF @Grade <> ''
			BEGIN
				SET @sg1 = @Grade + '1 '
				SET @sg2 = @Grade + '2 '
				SET @sg2a = @Grade + '2a '
				SET @sg2b = @Grade + '2b '
				SET @sg3 = @Grade + '3 '
			END

			SET @sg1 = @sg1 + 'single or isolated erosion(s), oval or linear, but affecting only one longitudinal fold '
			SET @sg2 = @sg2 + @sg2common + @sg2common1
			SET @sg2a = @sg2a + @sg2common + 'without confluence, ' + @sg2common1
			SET @sg2b = @sg2b + @sg2common + 'with confluence, ' + @sg2common1
			SET @sg3 = @sg3 + 'circumferential erosion' 
				
			--If reflux grade 3, 2b, 2a or 1 then just report the grade description.
			If @MSMGrade3=1 SET @nonGrade5MSMText = @nonGrade5MSMText + @plus + @sg3
			If @MSMGrade2b=1 SET @nonGrade5MSMText = @nonGrade5MSMText + @plus + @sg2b
			If @MSMGrade2a=1 SET @nonGrade5MSMText = @nonGrade5MSMText + @plus + @sg2a
			If @MSMGrade1=1 SET @nonGrade5MSMText = @nonGrade5MSMText + @plus + @sg1

			IF LTRIM(RTRIM(@nonGrade5MSMText)) <> ''
			BEGIN
				IF @ActiveBleeding=1 SET @nonGrade5MSMText = @nonGrade5MSMText + ' and active bleeding'
			END
		END

        --'-----------------------------------------------------------------------------------------
        --' if any non Grade 5 has been reported then "active bleeding" has been already included,
        --' if any Grade 5 has been reported then now is the time to add "active bleeding",
        --' but if neither has been reported then it's just "reflux oesophagitis"
        --' (with or without active bleeding)
        --'-----------------------------------------------------------------------------------------
			
		IF LTRIM(RTRIM(@nonGrade5MSMText)) <> ''
		BEGIN
			IF LTRIM(RTRIM(@LAClassText)) = ''
			BEGIN
				IF @Reflux=1 SET @RefluxBleedingOnly = 'Reflux oesophagitis'  --'unspecified type of reflux (no MSM grade)

				IF @ActiveBleeding=1
				BEGIN
					IF @RefluxBleedingOnly <> '' SET @RefluxBleedingOnly = @RefluxBleedingOnly + ' with active bleeding'
					ELSE SET @RefluxBleedingOnly = 'Active bleeding'
				END
			END
		END

        --'If stricture has been reported check to see if scope could pass. Note stricture can
        --'only occur on MSM Grade 4 therefore text is added to nonGrade5MSMText
		--VB6 Code - StrictureReported variable will always be false


		--'complete the unspecified reflux sentence
		SET @RefluxBleedingOnly = dbo.fnAddFullStop(@RefluxBleedingOnly)
		
		IF @nonGrade5MSMText <> ''
		BEGIN
			--If there's non-MSM Oeso text to begin with then we need to combine sentences with the conjuction
			IF @nonMSMOesoText <> ''
				SET @summary = @nonMSMOesoText + @withText + @nonGrade5MSMText
			ELSE
				SET @summary = @nonGrade5MSMText

			IF  @ActiveBleeding=1 SET @Grade5BarrattsText =  ' and active bleeding'
		END
		ELSE
		BEGIN
			--'If there's LA Classification then ...
			IF @LAClassText <> '' 
			BEGIN
				SET @summary = @nonMSMOesoText + @withText + @LAClassText
				SET @LAClassText=''
			END
			ELSE
			BEGIN
				--'But if there's only Oesophagitis other
				SET @summary = @nonMSMOesoText
			END

		END
	END

	SET @Summary = LTRIM(RTRIM(@Summary))
	IF RIGHT(@Summary,1) = '.' SET @Summary = LEFT(@Summary, LEN(@Summary) - 1)
	-- Finally update the summary in abnormalities table
	UPDATE ERS_UpperGIAbnoOesophagitis
	SET Summary = @Summary 
	WHERE SiteId = @siteId

GO
 ------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	: Andrea 18.12.23	
-- TFS#	
-- Description of change
-- Exclude suppressed templates 
------------------------------------------------------------------------------------------------------------------------
GO


ALTER procedure [dbo].[sch_get_templates]
(
	@OperatingHospitalId int,
	@ShowCustom bit
)
as
begin
	SELECT * FROM ERS_SCH_ListRules WHERE Suppressed = 0 AND GIProcedure = 1 AND OperatingHospitalId = @OperatingHospitalId AND ISNULL(IsTemplate,0) = CASE WHEN @ShowCustom = 1 THEN ISNULL(IsTemplate,0) ELSE 1 END
end
GO


------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO
------------------------------------------------------------------------------------------------------------------------
-- Quick fix to make sure lower extent save doesn't error when there is no additional info
------------------------------------------------------------------------------------------------------------------------
GO
ALTER PROCEDURE [dbo].[ogd_premedication_select]
(
	@ProcedureId INT
)
AS

SET NOCOUNT ON

SELECT	PremedicationId, 
		ProcedureId, 
		DrugNo, 
		DrugName, 
		Dose, 
		isnull(Units, '(none)') as Units, 
		DeliveryMethod, 
		WhoUpdatedId, 
		WhoCreatedId, 
		WhenCreated, 
		WhenUpdated 
FROM ERS_UpperGIPremedication
WHERE ProcedureId = @ProcedureId
GO 

ALTER PROCEDURE [dbo].[procedure_lower_extent_save]
(
	@ProcedureId int,
	@ExtentId int,
	@AdditionalInfo varchar(max),
	@EndoscopistId int,
	@ConfirmedById int,
	@ConfirmedByOther varchar(200),
	@CaecumIdentifiedById int,
	@LimitationId int,
	@DifficultyEncounteredId int,
	@DifficultyOther varchar(200),
	@PR int,
	@Retroflexion int,
	@InsertionVia int,
	@LimitationOther varchar(max),
	@ProcedureAbandoned bit, 
	@IntubationFailed bit,
	@LoggedInUserId INT
)
AS
BEGIN TRANSACTION

BEGIN TRY
	/*Check if new values been for confirmed by*/
	IF ISNULL(@ConfirmedByOther,'') <> ''
	BEGIN
		IF NOT EXISTS (SELECT 1 FROM dbo.ERS_ExtentConfirmedByList WHERE Description = @ConfirmedByOther)
		BEGIN
			/*get and set the new items order id so it appears 1 above 'other' we always want other to be last*/

			DECLARE @OtherListOrderBy int = (SELECT ListOrderBy FROM ERS_ExtentConfirmedByList WHERE Description = 'Other')
			INSERT INTO ERS_ExtentConfirmedByList (Description, NEDTerm, ListOrderBy, LimitationReason) VALUES (@ConfirmedByOther, 'Other', @OtherListOrderBy, 1)
			
			UPDATE dbo.ERS_ExtentConfirmedByList SET ListOrderBy = @OtherListOrderBy + 1 WHERE Description = 'Other'
		END

		SELECT @ConfirmedById = UniqueId FROM ERS_ExtentConfirmedByList WHERE Description = @ConfirmedByOther
	END

	/*Check if new values been added for limitations */
	IF ISNULL(@LimitationOther,'') <> ''
	BEGIN
		IF NOT EXISTS (SELECT 1 FROM dbo.ERS_Limitations WHERE Description = @LimitationOther)
		BEGIN
			/*get and set the new items order id so it appears 1 above 'other' we always want other to be last*/

			DECLARE @OtherListOrderBy_l int = (SELECT ListOrderBy FROM ERS_Limitations WHERE Description = 'Other')
			INSERT INTO ERS_Limitations (Description, NEDTerm, ListOrderBy) VALUES (@LimitationOther, 'Other', @OtherListOrderBy_l)
			
			UPDATE dbo.ERS_Limitations SET ListOrderBy = @OtherListOrderBy_l + 1 WHERE Description = 'Other'
		

		SELECT @LimitationId = UniqueId FROM ERS_Limitations WHERE Description = @LimitationOther
		
		DECLARE @ProcTypeId int = (SELECT ProcedureType FROM ERS_Procedures WHERE ProcedureId = @ProcedureId)
		INSERT INTO ERS_LimitationProcedureTypes (ProcedureTypeId, LimitationId) VALUES (@ProcTypeId, @LimitationId)
		END
		ELSE
			SELECT @LimitationId = UniqueId FROM ERS_Limitations WHERE Description = @LimitationOther
	END 

	/*Check if new values been added for limitations */
	IF ISNULL(@DifficultyOther,'') <> ''
	BEGIN
		IF NOT EXISTS (SELECT 1 FROM dbo.ERS_ExtentDifficultiesEncountered WHERE Description = @DifficultyOther)
		BEGIN
			/*get and set the new items order id so it appears 1 above 'other' we always want other to be last*/

			DECLARE @OtherListOrderBy_d int = (SELECT ListOrderBy FROM ERS_ExtentDifficultiesEncountered WHERE Description = 'Other')
			INSERT INTO ERS_ExtentDifficultiesEncountered (Description, NEDTerm, AdditionalInfo, ListOrderBy) VALUES (@DifficultyOther, 'Other', 1, @OtherListOrderBy_d)
			
			UPDATE dbo.ERS_ExtentDifficultiesEncountered SET ListOrderBy = @OtherListOrderBy_d + 1 WHERE Description = 'Other'
			

			SELECT @DifficultyEncounteredId = UniqueId FROM ERS_ExtentDifficultiesEncountered WHERE Description = @DifficultyOther
		END
		ELSE
		BEGIN
			SELECT @DifficultyEncounteredId = UniqueId FROM ERS_ExtentDifficultiesEncountered WHERE Description = @DifficultyOther
		END

	END

	IF NOT EXISTS (SELECT 1 FROM ERS_ProcedureLowerExtent WHERE ProcedureId = @ProcedureId AND EndoscopistId = @EndoscopistId)
	BEGIN
		INSERT INTO ERS_ProcedureLowerExtent (ProcedureId, ExtentId, AdditionalInfo, EndoscopistId, ConfirmedById, CaecumIdentifiedById, LimitationId, LimitationOther,
											  DifficultiesEncounteredId,RectalExamPerformed, RetroflectionPerformed, InsertionAccessViaId, Abandoned, IntubationFailed,
											  WhoUpdatedId, WhenUpdated)
		VALUES (@ProcedureId, NULLIF(@ExtentId, 0), ISNULL(@AdditionalInfo, ''), @EndoscopistId, NULLIF(@ConfirmedById,0), NULLIF(@CaecumIdentifiedById,0), NULLIF(@LimitationId,0), @LimitationOther,
				NULLIF(@DifficultyEncounteredId,0), NULLIF(@PR, -1), NULLIF(@Retroflexion, -1), NULLIF(@InsertionVia,0), ISNULL(@ProcedureAbandoned,CONVERT(bit,0)), ISNULL(@IntubationFailed,CONVERT(bit,0)), @LoggedInUserId, getdate())
	END
	ELSE
	BEGIN
		UPDATE ERS_ProcedureLowerExtent
		SET 
			ExtentId = NULLIF(@ExtentId,0),
			AdditionalInfo = ISNULL(@AdditionalInfo, ''),
			EndoscopistId = @EndoscopistId,
			ConfirmedById = NULLIF(@ConfirmedById,0),
			CaecumIdentifiedById = NULLIF(@CaecumIdentifiedById,0),
			LimitationId = NULLIF(@LimitationId,0),
			LimitationOther = @LimitationOther,
			DifficultiesEncounteredId = NULLIF(@DifficultyEncounteredId,0),
			RectalExamPerformed = NULLIF(@PR, -1),
			RetroflectionPerformed = NULLIF(@Retroflexion, -1),
			InsertionAccessViaId = NULLIF(@InsertionVia,0),
			Abandoned = ISNULL(@ProcedureAbandoned,CONVERT(bit,0)),
			IntubationFailed = ISNULL(@IntubationFailed,CONVERT(bit,0)),
			WhoUpdatedId = @LoggedInUserId,
			WhenUpdated = getdate()
		WHERE 
			ProcedureId = @ProcedureId AND
			EndoscopistId = @EndoscopistId
	END

	EXEC procedure_lower_extent_summary_update @ProcedureId

END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;
GO
ALTER PROCEDURE [dbo].[add_new_reference_item]
(
	@SectionName varchar(200), 
	@NewItem varchar(200), 
	@LoggedInUserId int
)
AS
BEGIN
	DECLARE @TableName varchar(200)

	SELECT @TableName = ReferenceTableName FROM UI_Sections WHERE SectionName = @SectionName
	IF ISNULL(@TableName,'') <> ''
	BEGIN
		DECLARE @NewId int, @SQL nvarchar(max)

		IF (SELECT count(1)
			FROM INFORMATION_SCHEMA.COLUMNS
			WHERE TABLE_NAME = @TableName
			AND COLUMN_NAME = 'Suppressed') > 0
		BEGIN
			SET @SQL = 
				'INSERT INTO ' + @TableName + ' ([Description], WhoCreatedId, WhenCreated, Suppressed) 
				VALUES (''' + @NewItem + ''', ' + CONVERT(VARCHAR(10), @LoggedInUserId) +', getdate(), 0)
				
				SELECT @NewId = Scope_Identity()'
		END
		ELSE
		BEGIN
			SET @SQL = 
				'INSERT INTO ' + @TableName + ' ([Description], WhoCreatedId, WhenCreated) 
				VALUES (''' + @NewItem + ''', ' + CONVERT(VARCHAR(10), @LoggedInUserId) +', getdate())
				
				SELECT @NewId = Scope_Identity()'
		END
		EXECUTE sp_executesql @SQL, N'@NewId int out', @NewId out

		SELECT @NewId

	
	END
END
GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Steve 25/09/23
-- TFS#	3168
-- Description of change
-- Letters should be saved to file system rather than database
------------------------------------------------------------------------------------------------------------------------
GO
PRINT N'Starting updates for TFS# 3168...';

GO
PRINT N'  Altering [dbo].[letCheckIfLetterExists]...';

GO

EXEC dbo.DropIfExist @ObjectName = 'letCheckIfLetterExists',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)

GO

CREATE PROCEDURE [dbo].[letCheckIfLetterExists]
(
	@LetterQueueId int
)
AS
BEGIN
	SELECT EditedLetterContent
	FROM ERS_LetterQueue (nolock)
	WHERE LetterQueueId = @LetterQueueId
END

GO
PRINT N'  Altering [dbo].[letGetLetterContent]...';

GO

EXEC dbo.DropIfExist @ObjectName = 'letGetLetterContent',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)

GO

CREATE PROCEDURE [dbo].[letGetLetterContent]
(
	@LetterQueueId int
)
AS
BEGIN
	SELECT  EditedLetterContent
	FROM ERS_LetterQueue (nolock)
	WHERE LetterQueueId = @LetterQueueId
END

GO
PRINT N'  Altering [dbo].[letGetLetterForLetterQueueId]...';

GO

EXEC dbo.DropIfExist @ObjectName = 'letGetLetterForLetterQueueId',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)

GO

CREATE PROCEDURE [dbo].[letGetLetterForLetterQueueId]
(
	@LetterQueueId int
)
AS
BEGIN
	SELECT TOP 1 AppointmentId, AppointmentStatusId, OperationalHospitalId
	FROM ERS_LetterQueue (nolock)
	WHERE LetterQueueId = @LetterQueueId
	ORDER BY WhenCreated DESC
END

GO
PRINT N'  Altering [dbo].[letGetLetterQueueIdForAppointmentId]...';

GO

EXEC dbo.DropIfExist @ObjectName = 'letGetLetterQueueIdForAppointmentId',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)

GO

CREATE PROCEDURE [dbo].[letGetLetterQueueIdForAppointmentId]
(
	@AppointmentId int
)
AS
BEGIN
	SELECT TOP 1 LetterQueueId
	FROM ERS_LetterQueue (nolock)
	WHERE AppointmentId = @AppointmentId
	ORDER BY WhenCreated DESC
END

GO
PRINT N'  Altering [dbo].[letGetTemplateData]...';

GO

EXEC dbo.DropIfExist @ObjectName = 'letGetTemplateData',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)

GO

CREATE PROCEDURE [dbo].[letGetTemplateData]
(
	@TemplateId int
)
AS
BEGIN
	SELECT LetterTypeId, OperationalHospitalId, LetterContent
	FROM ERS_LetterType (nolock)
	WHERE LetterTypeId = @TemplateId
END

GO
PRINT N'  Altering [dbo].[letGetAdditionalDocumentData]...';

GO

EXEC dbo.DropIfExist @ObjectName = 'letGetAdditionalDocumentData',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)

GO

CREATE PROCEDURE [dbo].[letGetAdditionalDocumentData]
(
	@AdditionalDocumentId int
)
AS
BEGIN
	SELECT ProcedureType, DocumentContent
	FROM ERS_LetterAdditionalDocument (nolock)
	WHERE AdditionalDocumentId = @AdditionalDocumentId
END

GO
PRINT N'  Altering [dbo].[letGetTemplateIdForAppointmentStatusAndHospital]...';

GO

EXEC dbo.DropIfExist @ObjectName = 'letGetTemplateIdForAppointmentStatusAndHospital',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)

GO

CREATE PROCEDURE [dbo].[letGetTemplateIdForAppointmentStatusAndHospital]
(
	@AppointmentStatusId int,
	@OperationalHospitalId int
)
AS
BEGIN
	SELECT LetterTypeId
	FROM ERS_LetterType (nolock)
	WHERE isActive = 1
	AND AppointmentStatusId = @AppointmentStatusId
	AND OperationalHospitalId = @OperationalHospitalId
END

GO
PRINT N'  Altering [dbo].[letLetterEdited]...';

GO

EXEC dbo.DropIfExist @ObjectName = 'letLetterEdited',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)

GO

CREATE PROCEDURE [dbo].[letLetterEdited]
(
	@LetterQueueId int,
	@UserId int,
	@PrintOnly int,
	@EditLetterReasonId INT,
	@EditLetterReasonExtraInfo VARCHAR(MAX)
)
AS
BEGIN
	IF @PrintOnly = 1
		UPDATE [ERS_LetterQueue] 
		SET Printed = 1,
			PrintedDate = Getdate(),
			WhoPrinted = @UserId,
			PrintCount = PrintCount + 1
		WHERE LetterQueueId = @LetterQueueId
	ELSE
		UPDATE ERS_LetterQueue 
		SET	Edited = 1,  
			PrintedDate = Getdate(),
			EditedLetterDate = Getdate(),
			WhoEdited = @UserId,
			WhoPrinted = @UserId,
		--If Edited after print
			EditedAfterPrint = CASE WHEN @EditLetterReasonId > 0 THEN 1 ELSE 0 END,
			EditAfterPrintReasonId = CASE WHEN @EditLetterReasonId > 0 THEN @EditLetterReasonId ELSE 0 END,
			EditAfterPrintReasonExtraInfo = ISNULL(@EditLetterReasonExtraInfo, EditAfterPrintReasonExtraInfo),
			EditedDateAfterPrint = Getdate() 
	WHERE LetterQueueId = @LetterQueueId
END

GO

PRINT N'  Altering [dbo].[letSaveLetter]...';

GO

EXEC dbo.DropIfExist @ObjectName = 'letSaveLetter',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)

GO

CREATE PROCEDURE [dbo].[letSaveLetter]
(
	@LetterQueueId int,
	@UserId int,
	@EditLetterReasonId INT,
	@EditLetterReasonExtraInfo VARCHAR(MAX)
)
AS
BEGIN

	UPDATE ERS_LetterQueue 
	SET	Edited = 1, 
		EditedLetterDate = Getdate(),
		WhoEdited = @UserId,
		WhoPrinted = @UserId,
	--If Edited after print
		EditedAfterPrint = CASE WHEN @EditLetterReasonId > 0 THEN 1 ELSE 0 END,
		EditAfterPrintReasonId = CASE WHEN @EditLetterReasonId > 0 THEN @EditLetterReasonId ELSE 0 END,
		EditAfterPrintReasonExtraInfo = ISNULL(@EditLetterReasonExtraInfo, EditAfterPrintReasonExtraInfo),
		EditedDateAfterPrint = Getdate() 
	WHERE LetterQueueId = @LetterQueueId
END

GO

Print '  Checking and creating Foreign Key Constraint on ERS_LetterAdditionalDocument on OperationalHospitalId if required'
IF EXISTS (
	SELECT 1
	FROM ERS_LetterAdditionalDocument
	WHERE OperationalHospitalId NOT IN (SELECT OperatingHospitalId FROM ERS_OperatingHospitals)
)
BEGIN
	DELETE FROM ERS_LetterAdditionalDocument
	WHERE OperationalHospitalId NOT IN (SELECT OperatingHospitalId FROM ERS_OperatingHospitals)
END

IF (OBJECT_ID('dbo.FK_ERS_LetterAdditionalDocumentOperationalHospitalId', 'F') IS NULL)
BEGIN
	ALTER TABLE [dbo].[ERS_LetterAdditionalDocument]     
		ADD CONSTRAINT FK_ERS_LetterAdditionalDocumentOperationalHospitalId FOREIGN KEY (OperationalHospitalId)     
			REFERENCES [dbo].[ERS_OperatingHospitals] (OperatingHospitalId)
END


Print '  Checking and creating Foreign Key Constraint on ERS_LetterQueue on AppointmentID if required'
IF EXISTS (
	SELECT 1
	FROM ERS_LetterQueue
	WHERE AppointmentID NOT IN (SELECT AppointmentID FROM ERS_Appointments)
)
BEGIN
	DELETE FROM ERS_LetterQueue
	WHERE AppointmentID NOT IN (SELECT AppointmentID FROM ERS_Appointments)
END

IF (OBJECT_ID('dbo.FK_ERS_LetterQueueAppointmentID', 'F') IS NULL)
BEGIN
	ALTER TABLE [dbo].[ERS_LetterQueue]     
		ADD CONSTRAINT FK_ERS_LetterQueueAppointmentID FOREIGN KEY (AppointmentID)     
			REFERENCES [dbo].[ERS_Appointments] (AppointmentID)
END


Print '  Checking and creating Foreign Key Constraint on ERS_LetterQueue on AppointmentStatusID if required'
IF EXISTS (
	SELECT 1
	FROM ERS_LetterQueue
	WHERE AppointmentStatusID NOT IN (SELECT UniqueId FROM ERS_AppointmentStatus)
)
BEGIN
DELETE FROM ERS_LetterQueue
	WHERE AppointmentStatusID NOT IN (SELECT UniqueId FROM ERS_AppointmentStatus)
END

IF (OBJECT_ID('dbo.FK_ERS_LetterQueueAppointmentStatusID', 'F') IS NULL)
BEGIN
	ALTER TABLE [dbo].[ERS_LetterQueue]     
		ADD CONSTRAINT FK_ERS_LetterQueueAppointmentStatusID FOREIGN KEY (AppointmentStatusID)     
			REFERENCES [dbo].[ERS_AppointmentStatus] (UniqueId)
END


Print '  Checking and creating Foreign Key Constraint on ERS_LetterType on OperationalHospitalId if required'
IF EXISTS (
	SELECT 1
	FROM ERS_LetterType
	WHERE OperationalHospitalId NOT IN (SELECT OperatingHospitalId FROM ERS_OperatingHospitals)
)
BEGIN
	DELETE FROM ERS_LetterType
	WHERE OperationalHospitalId NOT IN (SELECT OperatingHospitalId FROM ERS_OperatingHospitals)
END

IF (OBJECT_ID('dbo.FK_ERS_LetterTypeOperationalHospitalId', 'F') IS NULL)
BEGIN
	ALTER TABLE [dbo].[ERS_LetterType]     
		ADD CONSTRAINT FK_ERS_LetterTypeOperationalHospitalId FOREIGN KEY (OperationalHospitalId)     
			REFERENCES [dbo].[ERS_OperatingHospitals] (OperatingHospitalId)
END

GO
PRINT N'Finished updates for TFS# 3168.';

GO



------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 05.01.24
-- TFS#	3481
-- Description of change
-- Removal of summary update procedure during saving of procedure data
------------------------------------------------------------------------------------------------------------------------
GO

PRINT N'Altering Procedure [dbo].[procedure_bowel_prep_save]...';


GO

ALTER procedure [dbo].[procedure_bowel_prep_save]
(
	@ProcedureId int,
	@BowelPrepId int,
	@LeftScore int,
	@RightScore int,
	@TransverseScore int,
	@Quantity decimal(18,2),
	@EnemaId int,
	@EnemaOther varchar(200),
	@AdditionalInfo varchar(max),
	@LoggedInUserId int
)
AS
BEGIN
	/*Check if new values been */
	IF ISNULL(@AdditionalInfo,'') <> ''
	BEGIN
		IF NOT EXISTS (SELECT 1 FROM ERS_BowelPrep WHERE Description = @AdditionalInfo)
		BEGIN
			/*get and set the new items order id so it appears 1 above 'other' we always want other to be last*/

			DECLARE @OtherListOrderBy int = (SELECT ListOrderBy FROM ERS_BowelPrep WHERE Description = 'Other')
			INSERT INTO ERS_BowelPrep (Description, NEDTerm, ListOrderBy) VALUES (@AdditionalInfo, 'Other', @OtherListOrderBy)
			
			UPDATE dbo.ERS_BowelPrep SET ListOrderBy = @OtherListOrderBy + 1 WHERE Description = 'Other'
		END

		SELECT @BowelPrepId = UniqueId FROM ERS_BowelPrep WHERE Description = @AdditionalInfo
	END

	/*Check if new values been */
	IF ISNULL(@EnemaOther,'') <> ''
	BEGIN
		IF NOT EXISTS (SELECT 1 FROM ERS_BowelPrepEnemas WHERE Description = @EnemaOther)
		BEGIN
			/*get and set the new items order id so it appears 1 above 'other' we always want other to be last*/

			DECLARE @EOtherListOrderBy int = (SELECT ListOrderBy FROM ERS_BowelPrepEnemas WHERE Description = 'Other')
			INSERT INTO ERS_BowelPrepEnemas (Description, NEDTerm, ListOrderBy) VALUES (@EnemaOther, 'Other', @EOtherListOrderBy)
			
			UPDATE dbo.ERS_BowelPrepEnemas SET ListOrderBy = @EOtherListOrderBy + 1 WHERE Description = 'Other'
		END

		SELECT @EnemaId = UniqueId FROM ERS_BowelPrepEnemas WHERE Description = @EnemaOther
	END

	IF NOT EXISTS (SELECT 1 FROM ERS_ProcedureBowelPrep WHERE ProcedureId = @ProcedureId)
	BEGIN
		INSERT INTO ERS_ProcedureBowelPrep (ProcedureId, BowelPrepId, Quantity, LeftPrepScore, RightPrepScore, TransversePrepScore, TotalPrepScore, AdditionalInfo, EnemaId, WhoCreatedId, WhenCreated)
		VALUES (@ProcedureId, @BowelPrepId, @Quantity, @LeftScore, @RightScore, @TransverseScore, (@LeftScore + @RightScore + @TransverseScore), '', @EnemaId, @LoggedInUserId, getdate())
	END
	ELSE
	BEGIN
		UPDATE ERS_ProcedureBowelPrep
		SET BowelPrepId = @BowelPrepId,
			Quantity = @Quantity,
			LeftPrepScore = @LeftScore,
			RightPrepScore = @RightScore,
			TransversePrepScore = @TransverseScore,
			TotalPrepScore = (@LeftScore + @RightScore + @TransverseScore),
			AdditionalInfo = @AdditionalInfo,
			EnemaId = @EnemaId,
			WhoUpdatedId = @LoggedInUserId,
			WhenUpdated = getdate()
		WHERE ProcedureId = @ProcedureId
	END

	DECLARE @Summary VARCHAR(max), 
			@TotalScore int = (@LeftScore + @RightScore + @TransverseScore), 
			@BowelPrepFormula varchar(max) = (SELECT [Description] FROM ERS_BowelPrep WHERE UniqueId = @BowelPrepId) + 
				CASE WHEN ISNULL(@EnemaId,0) > 0 THEN ' + ' + (SELECT [Description] FROM dbo.ERS_BowelPrepEnemas WHERE UniqueId = @EnemaId) ELSE '' END +
				CASE WHEN ISNULL(@Quantity,0) > 0 THEN ' (Volume ' + CONVERT(varchar(10), convert(int, @Quantity))  + ')' ELSE '' END

	
	SET @Summary = @BowelPrepFormula + '. '
	
	IF @TotalScore > 0 
	BEGIN
		SET @Summary = @Summary + ' Boston Bowel Prep Total Score ' +  cast( @TotalScore as varchar(10))
	END 

	--UPDATE  [ERS_BowelPreparation] SET Summary = @Summary WHERE ProcedureID=@ProcedureId
	UPDATE [ERS_ProceduresReporting] SET [PP_Bowel_Prep] = @Summary WHERE ProcedureID=@ProcedureId

	DECLARE @SectionId int = (SELECT UISectionId FROM UI_Sections WHERE SectionName = 'Bowel Prep')

	DELETE FROM ERS_ProcedureSummary WHERE ProcedureId = @ProcedureId AND SectionId = @SectionId
	
	exec UI_update_procedure_summary   @ProcedureId, 'Bowel Prep', @Summary, 1



	
END
GO
PRINT N'Altering Procedure [dbo].[procedure_discomfort_save]...';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER OFF;


GO
ALTER PROCEDURE [dbo].[procedure_discomfort_save]
(
	@DiscomfortScoreId int,
	@ProcedureId int,
	@LoggedInUserId int
)
AS
BEGIN
	IF NOT EXISTS (SELECT 1 FROM ERS_ProcedureDiscomfortScore WHERE ProcedureId = @ProcedureId)
	BEGIN
		INSERT INTO ERS_ProcedureDiscomfortScore (ProcedureId, DiscomfortScoreId, WhoCreatedId, WhenCreated)
		VALUES (@ProcedureId, @DiscomfortScoreId, @LoggedInUserId, getdate())
	END
	ELSE
	BEGIN
		UPDATE ERS_ProcedureDiscomfortScore
		SET DiscomfortScoreId = @DiscomfortScoreId,
			WhoUpdatedId = @LoggedInUserId,
			WhenUpdated = getdate()
		WHERE ProcedureId = @ProcedureId
	END	

	/*-- summary report --*/
	DECLARE @DiscomfortDescription varchar(200), @SectionId int
	
	SELECT @SectionId = UISectionId FROM UI_Sections WHERE SectionName = 'Procedure discomfort'

	SELECT @DiscomfortDescription = Description
	FROM ERS_ProcedureDiscomfortScore pd
		INNER JOIN ERS_DiscomfortScores ds on ds.uniqueid = pd.discomfortscoreid
	WHERE ProcedureId = @ProcedureId

	DECLARE @Summary VARCHAR(max) = 'Procedure discomfort - ' + @DiscomfortDescription
	
	exec UI_update_procedure_summary   @ProcedureId, 'Procedure discomfort', '', 1


	UPDATE ERS_ProcedureDiscomfortScore
	SET Summary = @Summary
	WHERE ProcedureId = @ProcedureId

END
GO
SET ANSI_NULLS, QUOTED_IDENTIFIER ON;


GO
PRINT N'Altering Procedure [dbo].[procedure_sedation_score_save]...';


GO
ALTER PROCEDURE [dbo].[procedure_sedation_score_save]
(
	@ProcedureId int,
	@SedationScoreId int,
	@ChildId int,
	@LoggedInUserId int
)
AS
BEGIN
	DECLARE @Summary VARCHAR(max) = 'Patient Sedation - ' + (SELECT Description FROM ERS_SedationScores WHERE UniqueId = @SedationScoreId) + CASE WHEN ISNULL(@ChildId,0) > 0 THEN (SELECT ' ' + Description FROM ERS_SedationScores WHERE UniqueId = @ChildId) ELSE '' END

	IF NOT EXISTS (SELECT 1 FROM ERS_ProcedureSedationScore WHERE ProcedureId = @ProcedureId)
	BEGIN
		INSERT INTO ERS_ProcedureSedationScore (ProcedureId, SedationScoreId, ChildId, WhoCreatedId, WhenCreated, Summary)
		VALUES (@ProcedureId, @SedationScoreId, @ChildId, @LoggedInUserId, getdate(), @Summary)
	END
	ELSE IF EXISTS (SELECT 1 FROM ERS_ProcedureSedationScore WHERE ProcedureId = @ProcedureId AND SedationScoreId = @SedationScoreId AND ChildId <> @ChildId)
	BEGIN
		UPDATE ERS_ProcedureSedationScore
		SET ChildId = @ChildId, 
			Summary = @Summary
		WHERE ProcedureId = @ProcedureId AND
			  SedationScoreId = @SedationScoreId
	END
	ELSE
	BEGIN
		UPDATE ERS_ProcedureSedationScore
		SET SedationScoreId = @SedationScoreId,
			ChildId = @ChildId, 
			Summary = @Summary
		WHERE ProcedureId = @ProcedureId 
	END	
     
END
GO
PRINT N'Altering Procedure [dbo].[procedure_vocal_cord_paralysis_save]...';


GO
ALTER PROCEDURE [dbo].[procedure_vocal_cord_paralysis_save]
(
	@ProcedureId int, 
	@VocalCordParalysisId int, 
	@LoggedInUserId int
)
AS
BEGIN
		IF NOT EXISTS (SELECT 1 FROM ERS_ProcedureVocalCordParalysis WHERE ProcedureId = @ProcedureId)
		BEGIN
			INSERT INTO [dbo].[ERS_ProcedureVocalCordParalysis] (ProcedureId, VocalCordParalysisId, WhoCreatedId, WhenCreated)
			VALUES (@ProcedureId, @VocalCordParalysisId, @LoggedInUserId, getdate())
		END
		ELSE
		BEGIN
			UPDATE 
				ERS_ProcedureVocalCordParalysis 
			SET 
				VocalCordParalysisId = @VocalCordParalysisId,
				WhenUpdated = getdate(),
				WhoUpdatedId = @LoggedInUserId
			WHERE 
				ProcedureId = @ProcedureId 
		END
	
	


END
GO
PRINT N'Altering Procedure [dbo].[patient_asa_status_save]...';


GO

ALTER PROCEDURE [dbo].[patient_asa_status_save]
(
	@PatientId int,
	@ASAStatusId int,
	@ProcedureId int,
	@LoggedInUserId int
)
AS
BEGIN
	IF NOT EXISTS (SELECT 1 FROM ERS_PatientASAStatus WHERE PatientId = @PatientID AND ProcedureCreatedId = @ProcedureId)
	BEGIN
		INSERT INTO ERS_PatientASAStatus (PatientId, ASAStatusId, ProcedureCreatedId, WhoCreatedId, WhenCreated)
		VALUES (@PatientId, @ASAStatusId, @ProcedureId, @LoggedInUserId, GETDATE())
	END
	ELSE
	BEGIN
		UPDATE ERS_PatientASAStatus
		SET ASAStatusId = @ASAStatusId,
			ProcedureCreatedId = @ProcedureId,
			WhoUpdatedId = @LoggedInUserId,
			WhenUpdated = GETDATE()
		WHERE PatientId = @PatientId
	END

	UPDATE ERS_ProceduresReporting
	SET PP_Indic = dbo.ProcedureIndicationsSummary(@ProcedureId)
	WHERE ProcedureId = @ProcedureId

	DECLARE @Summary VARCHAR(max) = 'ASA Status'
	EXEC UI_update_procedure_summary @ProcedureId, 'ASA Status', @Summary, @ASAStatusId


END
GO
PRINT N'Altering Procedure [dbo].[letSaveLetter]...';


GO

ALTER PROCEDURE [dbo].[letSaveLetter]
(
	@LetterQueueId int,
	@UserId int,
	@LetterContent varbinary(max),
	@PrintOnly int,
	@EditLetterReasonId INT,
	@EditLetterReasonExtraInfo VARCHAR(MAX)
)
AS
BEGIN
	IF @PrintOnly = 1
		UPDATE [ERS_LetterQueue] 
		SET Printed = 1,
			PrintedDate = Getdate(),
			EditedLetterContent = @LetterContent,
			WhoPrinted = @UserId,
			PrintCount = PrintCount + 1
		WHERE LetterQueueId = @LetterQueueId
	ELSE
		UPDATE ERS_LetterQueue 
		set	Edited = 1, 
			Printed = 1 , 
			PrintedDate = Getdate(),
			EditedLetterDate = Getdate(),
			EditedLetterContent = @LetterContent,
			WhoEdited = @UserId,
			WhoPrinted = @UserId,
			PrintCount = PrintCount + 1,
		--If Edited after print
			EditedAfterPrint = CASE WHEN @EditLetterReasonId > 0 THEN 1 ELSE 0 END,
			EditAfterPrintReasonId = CASE WHEN @EditLetterReasonId > 0 THEN @EditLetterReasonId ELSE 0 END,
			EditAfterPrintReasonExtraInfo = ISNULL(@EditLetterReasonExtraInfo, EditAfterPrintReasonExtraInfo),
			EditedDateAfterPrint = Getdate() 
	WHERE LetterQueueId = @LetterQueueId
END
GO
PRINT N'Altering Procedure [dbo].[patient_anti_coag_drugs_save]...';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER OFF;


GO


ALTER PROCEDURE [dbo].[patient_anti_coag_drugs_save]
(
	@ProcedureId int,
	@AntiCoagDrugs bit
)
AS
BEGIN
	BEGIN
	    UPDATE ERS_Procedures SET AntiCoagDrugs = @AntiCoagDrugs WHERE ProcedureId = @ProcedureId
	    	DECLARE  @SectionId int = (SELECT UISectionId FROM UI_Sections WHERE SectionName = 'Anti-coag drugs')
	    
	    	DELETE FROM ERS_ProcedureSummary WHERE ProcedureId = @ProcedureId AND SectionId = @SectionId
	    	IF @AntiCoagDrugs = 1 AND 
	    			(SELECT count(*) FROM ERS_ProcedureDamagingDrugs WHERE ProcedureId = @ProcedureId AND DamagingDrugId IN (SELECT UniqueId FROM ERS_PotentialDamagingDrugs WHERE AntiCoag = 1)) > 0 
	    	BEGIN
	    		exec UI_update_procedure_summary @ProcedureId, 'Anti-coag drugs', 'Anti-coag drugs', 1
				--check RX status incase this was an update
				IF (SELECT count(*) FROM ERS_UpperGIRx WHERE ProcedureId = @ProcedureId AND Summary <> '') = 0
				BEGIN
					exec UI_update_procedure_summary @ProcedureId, 'RX', 'RX', 0
				END
	    	END
	    	ELSE IF @AntiCoagDrugs = 1 AND 
	    			(SELECT count(*) FROM ERS_ProcedureDamagingDrugs WHERE ProcedureId = @ProcedureId AND DamagingDrugId IN (SELECT UniqueId FROM ERS_PotentialDamagingDrugs WHERE AntiCoag = 1)) = 0 
	    	BEGIN
	    		exec UI_update_procedure_summary @ProcedureId, 'Anti-coag drugs', 'Anti-coag drugs', 0
				--check RX status incase this was an update
				IF (SELECT count(*) FROM ERS_UpperGIRx WHERE ProcedureId = @ProcedureId AND Summary <> '') = 0
				BEGIN
					exec UI_update_procedure_summary @ProcedureId, 'RX', 'RX', 0
				END
	    	END
	    	ELSE IF @AntiCoagDrugs = 0
	    	BEGIN
	    		exec UI_update_procedure_summary @ProcedureId, 'Anti-coag drugs', 'Anti-coag drugs', 1
				exec UI_update_procedure_summary @ProcedureId, 'RX', 'RX', 1
	    	END
	END

END
GO
SET ANSI_NULLS, QUOTED_IDENTIFIER ON;


GO
PRINT N'Altering Procedure [dbo].[procedure_instruments_save]...';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER OFF;


GO


ALTER PROCEDURE [dbo].[procedure_instruments_save]
(
	@ProcedureId int,
	@Instrument1Id int,
	@Instrument2Id int,
	@ScopeGuideUsed bit
)
AS
BEGIN
	UPDATE ERS_Procedures 
	SET 
		Instrument1 = NULLIF(@Instrument1Id,0), 
		Instrument2 = NULLIF(@Instrument2Id, 0), 
		ScopeGuide = @ScopeGuideUsed
	WHERE ProcedureId = @ProcedureId

	DECLARE @SectionId int, @Summary varchar(max)

	
	/*Scope*/
	SET @Summary = 'Scopes:'
	IF @Instrument1Id > 0 
	BEGIN
		EXEC UI_update_procedure_summary @ProcedureId, 'Scopes', @Summary, @Instrument1Id
	END
	ELSE IF @Instrument2Id > 0 
		EXEC UI_update_procedure_summary @ProcedureId, 'Scopes', @Summary, @Instrument2Id
	ELSE
		EXEC UI_update_procedure_summary @ProcedureId, 'Scopes', @Summary, 0

	--update reporting field for summary report
	DECLARE @InstrumentTxt varchar(200) = '', @Instru1Text varchar(200) = '', @Instru2Text varchar(200) = ''

	IF ISNULL(@Instrument1Id,0) > 0
		SELECT @Instru1Text = ScopeName FROM ERS_Scopes WHERE ScopeId = @Instrument1Id
	
	IF ISNULL(@Instrument2Id,0) > 0
		SELECT @Instru2Text = ScopeName FROM ERS_Scopes WHERE ScopeId = @Instrument2Id
		
	--accessVia Part

	IF @ProcedureId IN (SELECT @ProcedureId  FROM ERS_Procedures WHERE ProcedureType IN (10, 11))
	BEGIN
		Select @Instru2Text = 'Access Via : ' + ListItemText
	FROM ers_lists WHERE ListItemNo=@Instrument2Id And ListDescription='AccessMethod Thoracic'
	END
	
	If @Instru1Text <> '' 
		SET @InstrumentTxt = @Instru1Text
	
	If @Instru2Text <> '' 
		SET @InstrumentTxt = @InstrumentTxt + '<br /> ' + @Instru2Text

	IF @Instru1Text <> '' OR @Instru2Text <> ''
	BEGIN
		--transnasal check
		IF EXISTS (SELECT 1 FROM dbo.ERS_Procedures WHERE ProcedureId = @ProcedureId AND Transnasal = 1)
		BEGIN	
			SET @InstrumentTxt = @InstrumentTxt + ' (transnasal) '
		END

		UPDATE ERS_ProceduresReporting SET PP_Instrument = @InstrumentTxt WHERE ProcedureId = @ProcedureId
	END
END
GO
SET ANSI_NULLS, QUOTED_IDENTIFIER ON;


GO
PRINT N'Altering Procedure [dbo].[procedure_lower_extent_summary_update]...';


GO

ALTER PROCEDURE [dbo].[procedure_lower_extent_summary_update]
(
	@ProcedureId INT
)
AS
BEGIN
	
	DECLARE 
	@ExtentId INT,
	@AdditionalInfo VARCHAR(MAX),
	@EndoscopistId INT,
	@ConfirmedById INT,
	@ConfirmedByOther VARCHAR(200),
	@CaecumIdentifiedById INT,
	@LimitationId INT,
	@DifficultyEncounteredId INT,
	@DifficultyOther VARCHAR(200),
	@PR INT,
	@Retroflexion INT,
	@InsertionVia INT,
	@LimitationOther VARCHAR(MAX),
	@ProcedureAbandoned BIT, 
	@IntubationFailed BIT,
	@LoggedInUserId INT


	DECLARE @SectionId INT, @ProceureTypeId INT, @ExtentDescription VARCHAR(200), @IsSuccess BIT, @ScopeType VARCHAR(200), @SummaryText VARCHAR(MAX), @RetroflexionDone BIT, @PRDone BIT
	SELECT @SectionID = UISectionId FROM UI_Sections WHERE SectionName = 'Extent'

	SELECT @ProceureTypeId = ProcedureType FROM ERS_Procedures WHERE ProcedureId = @ProcedureId
	--SELECT @ExtentDescription = LOWER(Description) FROM ERS_Extent WHERE UniqueId = @ExtentId

	/*Furthest extent*/
	SELECT TOP 1 @ExtentDescription = ee.Description, 
				 @EndoscopistId = epue.EndoscopistId, 
				 @DifficultyEncounteredId = epue.DifficultiesEncounteredId,
				 @LimitationId = epue.LimitationId,
				 @LimitationOther= epue.LimitationOther,
				 @Retroflexion = epue.RetroflectionPerformed,
				 @ExtentId = epue.ExtentId,
				 @ConfirmedById = epue.ConfirmedById,
				 @InsertionVia = epue.InsertionAccessViaId,
				 @IsSuccess = ee.IsSuccess,
				 @ProcedureAbandoned = epue.Abandoned,
				 @IntubationFailed = epue.IntubationFailed
								FROM dbo.ERS_ProcedureLowerExtent epue 
									INNER JOIN dbo.ERS_Extent ee ON epue.ExtentId = ee.UniqueId
								WHERE epue.ProcedureId=@ProcedureId
								ORDER BY ee.ListOrderBy
	


	/*PR Exam*/
	IF (SELECT COUNT(*) FROM ERS_ProcedureLowerExtent eple WHERE ProcedureId = @ProcedureId AND eple.RectalExamPerformed IS NOT NULL) > 0
	BEGIN
		/*Overall PR result regardless of who done it, was it done*/
		IF EXISTS (SELECT 1 FROM ERS_ProcedureLowerExtent WHERE ProcedureId = @ProcedureId AND ISNULL(RectalExamPerformed,0) = 1)
			SET @PRDone = 1
		ELSE
			SET @PRDone = 0
	END
	
	/*Retroflexion*/
	IF (SELECT COUNT(*) FROM ERS_ProcedureLowerExtent eple WHERE ProcedureId = @ProcedureId AND eple.RetroflectionPerformed IS NOT NULL) > 0
	BEGIN
		/*Overall PR result regardless of who done it, was it done*/
		IF EXISTS (SELECT 1 FROM ERS_ProcedureLowerExtent WHERE ProcedureId = @ProcedureId AND ISNULL(RetroflectionPerformed,0) = 1)
			SET @RetroflexionDone = 1
		ELSE
			SET @RetroflexionDone = 0
	END


	DECLARE @A varchar(5000), @B VARCHAR(5000), @Rectal varchar(500), @Retro varchar(500), @ProcType int

	SET @SummaryText = ''

	IF @ProceureTypeId = 4 
	BEGIN
		SET @ScopeType = 'sigmoidoscope'
	END
	ELSE 
	BEGIN 
		SET @ScopeType = 'colonoscope'
	END

	IF @PRDone IS NOT NULL 
	BEGIN
		IF @PR = 1 
		BEGIN
			SET @SummaryText = @SummaryText + 'A digital rectal examination was performed. '
		END
	END

	ELSE 
	BEGIN
		SET @SummaryText = @SummaryText + 'A digital rectal examination was not performed. '
	END

	DECLARE @InsertionSummaryText varchar(4000) = '', @ExtentSummaryText varchar(4000) = ''

	IF ISNULL(@InsertionVia,0) > 0 
	BEGIN
		SET @InsertionSummaryText = 'The ' + @ScopeType +  ' was inserted via ' + 
		(SELECT LOWER(CASE WHEN Description = 'anus' THEN 'the ' + Description ELSE Description END) FROM ERS_ExtentInsertionRoutes WHERE UniqueId = @InsertionVia)
	END
	
	IF ISNULL(@ExtentId,0) > 0 
	BEGIN
		SET @ExtentSummaryText = CASE WHEN @InsertionSummaryText = '' THEN 'The ' + @ScopeType +  ' was inserted ' ELSE '' END + ' to the ' + @ExtentDescription + ''
	END

	SET @SummaryText = @SummaryText + @InsertionSummaryText + @ExtentSummaryText
	
	IF @ProcedureAbandoned = 1
	BEGIN
		SET @SummaryText = @SummaryText + CASE WHEN @ExtentSummaryText <> '' OR @InsertionSummaryText <> '' THEN ' but the procedure was abandoned' ELSE ' The procedure was abandoned' END
	END
	
	IF @IntubationFailed = 1
	BEGIN
		SET @SummaryText = @SummaryText + ' intubation failed '
	END

	IF EXISTS (SELECT 1 FROM ERS_ProcedureCaecumIdentifiedBy WHERE ProcedureId = @ProcedureId)
	BEGIN
		--DECLARE @IdentifiedByConfidence varchar(max) = (SELECT [Description]
		--												FROM ERS_ProcedureCaecumIdentifiedBy epi 
		--													INNER JOIN ERS_ExtentConfirmedByList i on i.UniqueId = epi.ExtentIdentifiedById
		--												WHERE ProcedureId=@ProcedureId AND EndoscopistId = @EndoscopistId)
		
		DECLARE @IdentifiedByText varchar(max) = '. The caecum was identified by '

		SET @IdentifiedByText = @IdentifiedByText + LTRIM(STUFF((SELECT ', ' + CASE WHEN ISNULL(ChildId, 0) > 0 THEN (SELECT [Description] FROM ERS_ExtentConfirmedByList WHERE UniqueId = epi.ChildId) ELSE LOWER([Description]) END AS [text()] 
		FROM ERS_ProcedureCaecumIdentifiedBy epi 
			INNER JOIN ERS_ExtentConfirmedByList i on i.UniqueId = epi.ExtentIdentifiedById
		WHERE ProcedureId=@ProcedureId and EndoscopistId = @EndoscopistId and ISNULL(ChildId, 0) = 0
		ORDER BY ISNULL(i.ListOrderBy, 0)
		FOR XML PATH('')),1,1,''))

		SELECT @IdentifiedByText = dbo.fnAddFullStop(@IdentifiedByText)

		IF LEN(@IdentifiedByText) > 0
		BEGIN
			IF charindex(',', reverse(@IdentifiedByText)) > 0
				SET @SummaryText = @SummaryText + STUFF(@IdentifiedByText, len(@IdentifiedByText) - charindex(' ,', reverse(@IdentifiedByText)), 2, ' and ')
			ELSE
				SET @SummaryText = @SummaryText +  @IdentifiedByText
		END
	END

	IF ISNULL(@ConfirmedById, 0) > 0
	BEGIN
		SET @SummaryText = @SummaryText + ', insertion confirmed by ' + (SELECT LOWER(Description) FROM ERS_ExtentConfirmedByList WHERE UniqueId = @ConfirmedById)
	END
	
	IF ISNULL(@LimitationId, 0) > 0
	BEGIN
		SET @SummaryText = @SummaryText + CASE WHEN ISNULL(@ConfirmedById, 0) > 0 THEN ' and  ' ELSE ', ' END + 'insertion limited by ' + (SELECT LOWER(Description) FROM ERS_Limitations WHERE UniqueId = @LimitationId) + '.<br />'
	END

	IF ISNULL(@DifficultyEncounteredId, 0) > 0 
	BEGIN
		SET @SummaryText = @SummaryText + ' Difficulties encountered: ' + (SELECT LOWER(Description) FROM ERS_ExtentDifficultiesEncountered WHERE UniqueId = @DifficultyEncounteredId) + '.'
	END

	IF @RetroflexionDone = 1 SET @SummaryText = @SummaryText + ' The scope was retroflexed in the rectum.'

	
	UPDATE ERS_ProcedureLowerExtent
	SET Summary = @SummaryText
	WHERE ProcedureId = @ProcedureId

	--remove complete section entry incase conditions no longer apply
	EXEC UI_update_procedure_summary @ProcedureId, 'Extent', 'Extent:', 0, @EndoscopistId
	
	--set extent id to whatever necessary only for completion purposes as no extent has reached 
	IF ISNULL(@ExtentId,0) = 0 AND (@ProcedureAbandoned = 1 OR @IntubationFailed = 1)
	BEGIN
		--set record in database??????
		IF @ProcedureAbandoned = 1
		BEGIN
			SELECT @ExtentId = UniqueId, @IsSuccess = IsSuccess
			FROM ERS_Extent
			WHERE NEDTerm = 'Abandoned'
		END
		ELSE IF @IntubationFailed = 1
		BEGIN
			SELECT @ExtentId = UniqueId, @IsSuccess = IsSuccess
			FROM ERS_Extent
			WHERE NEDTerm = 'Intubation failed'
		END
	END

	--if extent is > 0 and extent.issuccess = 1 or (limitation id > 0 and (limitation id <> other or (limitationid = other and other text filled in)))
	--If Sigmoid, check if the Extent has reached or exceeded the planned extent
	IF @ExtentId > 0 AND @ProceureTypeId = 4
	BEGIN
		DECLARE @ExtentListOrder int = (SELECT ListOrderBy FROM ERS_Extent WHERE UniqueId = @ExtentId)
		DECLARE @PlannedExtentListOrder int = (SELECT e.ListOrderBy FROM ERS_ProcedurePlannedExtent ppe JOIN ERS_Extent e ON e.UniqueId = ppe.ExtentId WHERE ppe.ProcedureId = @ProcedureId)

		IF (@ExtentListOrder <= @PlannedExtentListOrder AND @ExtentListOrder > 0)
				SET @IsSuccess = 1
			ELSE
				SET @IsSuccess = 0
	END

	IF @ExtentId > 0 AND @IsSuccess = 1
		EXEC UI_update_procedure_summary @ProcedureId, 'Extent', 'Extent:', @ExtentId, @EndoscopistId
	ELSE IF @IsSuccess = 0 AND @LimitationId > 1
	BEGIN
		IF (SELECT LOWER(NEDTerm) FROM dbo.ERS_Limitations WHERE UniqueId = @LimitationId) = 'other'
		BEGIN
			SELECT @LimitationOther = Description FROM dbo.ERS_Limitations WHERE UniqueId = @LimitationId AND LOWER(Description) <> 'other' -- meaning they've entered their own description
			IF ISNULL(@LimitationOther,'') <> ''
			BEGIN
				EXEC UI_update_procedure_summary @ProcedureId, 'Extent', 'Extent:' , @ExtentId, @EndoscopistId
			END
		END
		ELSE
		BEGIN
			EXEC UI_update_procedure_summary @ProcedureId, 'Extent', 'Extent:', @ExtentId, @EndoscopistId
		END
	END

	--retroflexion
	IF @Retroflexion > -1
	BEGIN
		EXEC UI_update_procedure_summary @ProcedureId, 'Retroflexion', 'Retroflexion:', 1, @EndoscopistId
	END
	ELSE
	BEGIN
		EXEC UI_update_procedure_summary @ProcedureId, 'Retroflexion', 'Retroflexion:', 0, @EndoscopistId
	END




END
GO
PRINT N'Altering Procedure [dbo].[procedure_lower_extent_save]...';


GO




ALTER PROCEDURE [dbo].[procedure_lower_extent_save]
(
	@ProcedureId int,
	@ExtentId int,
	@AdditionalInfo varchar(max),
	@EndoscopistId int,
	@ConfirmedById int,
	@ConfirmedByOther varchar(200),
	@CaecumIdentifiedById int,
	@LimitationId int,
	@DifficultyEncounteredId int,
	@DifficultyOther varchar(200),
	@PR int,
	@Retroflexion int,
	@InsertionVia int,
	@LimitationOther varchar(max),
	@ProcedureAbandoned bit, 
	@IntubationFailed bit,
	@LoggedInUserId INT
)
AS
BEGIN TRANSACTION

BEGIN TRY
	/*Check if new values been for confirmed by*/
	IF ISNULL(@ConfirmedByOther,'') <> ''
	BEGIN
		IF NOT EXISTS (SELECT 1 FROM dbo.ERS_ExtentConfirmedByList WHERE Description = @ConfirmedByOther)
		BEGIN
			/*get and set the new items order id so it appears 1 above 'other' we always want other to be last*/

			DECLARE @OtherListOrderBy int = (SELECT ListOrderBy FROM ERS_ExtentConfirmedByList WHERE Description = 'Other')
			INSERT INTO ERS_ExtentConfirmedByList (Description, NEDTerm, ListOrderBy, LimitationReason) VALUES (@ConfirmedByOther, 'Other', @OtherListOrderBy, 1)
			
			UPDATE dbo.ERS_ExtentConfirmedByList SET ListOrderBy = @OtherListOrderBy + 1 WHERE Description = 'Other'
		END

		SELECT @ConfirmedById = UniqueId FROM ERS_ExtentConfirmedByList WHERE Description = @ConfirmedByOther
	END

	/*Check if new values been added for limitations */
	IF ISNULL(@LimitationOther,'') <> ''
	BEGIN
		IF NOT EXISTS (SELECT 1 FROM dbo.ERS_Limitations WHERE Description = @LimitationOther)
		BEGIN
			/*get and set the new items order id so it appears 1 above 'other' we always want other to be last*/

			DECLARE @OtherListOrderBy_l int = (SELECT ListOrderBy FROM ERS_Limitations WHERE Description = 'Other')
			INSERT INTO ERS_Limitations (Description, NEDTerm, ListOrderBy) VALUES (@LimitationOther, 'Other', @OtherListOrderBy_l)
			
			UPDATE dbo.ERS_Limitations SET ListOrderBy = @OtherListOrderBy_l + 1 WHERE Description = 'Other'
		

		SELECT @LimitationId = UniqueId FROM ERS_Limitations WHERE Description = @LimitationOther
		
		DECLARE @ProcTypeId int = (SELECT ProcedureType FROM ERS_Procedures WHERE ProcedureId = @ProcedureId)
		INSERT INTO ERS_LimitationProcedureTypes (ProcedureTypeId, LimitationId) VALUES (@ProcTypeId, @LimitationId)
		END
		ELSE
			SELECT @LimitationId = UniqueId FROM ERS_Limitations WHERE Description = @LimitationOther
	END 

	/*Check if new values been added for limitations */
	IF ISNULL(@DifficultyOther,'') <> ''
	BEGIN
		IF NOT EXISTS (SELECT 1 FROM dbo.ERS_ExtentDifficultiesEncountered WHERE Description = @DifficultyOther)
		BEGIN
			/*get and set the new items order id so it appears 1 above 'other' we always want other to be last*/

			DECLARE @OtherListOrderBy_d int = (SELECT ListOrderBy FROM ERS_ExtentDifficultiesEncountered WHERE Description = 'Other')
			INSERT INTO ERS_ExtentDifficultiesEncountered (Description, NEDTerm, ListOrderBy) VALUES (@DifficultyOther, 'Other', @OtherListOrderBy_d)
			
			UPDATE dbo.ERS_ExtentDifficultiesEncountered SET ListOrderBy = @OtherListOrderBy_d + 1 WHERE Description = 'Other'
			

			SELECT @DifficultyEncounteredId = UniqueId FROM ERS_ExtentDifficultiesEncountered WHERE Description = @DifficultyOther
		END
		ELSE
		BEGIN
			SELECT @DifficultyEncounteredId = UniqueId FROM ERS_ExtentDifficultiesEncountered WHERE Description = @DifficultyOther
		END

	END

	IF NOT EXISTS (SELECT 1 FROM ERS_ProcedureLowerExtent WHERE ProcedureId = @ProcedureId AND EndoscopistId = @EndoscopistId)
	BEGIN
		INSERT INTO ERS_ProcedureLowerExtent (ProcedureId, ExtentId, AdditionalInfo, EndoscopistId, ConfirmedById, CaecumIdentifiedById, LimitationId, LimitationOther,
											  DifficultiesEncounteredId,RectalExamPerformed, RetroflectionPerformed, InsertionAccessViaId, Abandoned, IntubationFailed,
											  WhoUpdatedId, WhenUpdated)
		VALUES (@ProcedureId, NULLIF(@ExtentId, 0), @AdditionalInfo, @EndoscopistId, NULLIF(@ConfirmedById,0), NULLIF(@CaecumIdentifiedById,0), NULLIF(@LimitationId,0), @LimitationOther,
				NULLIF(@DifficultyEncounteredId,0), NULLIF(@PR, -1), NULLIF(@Retroflexion, -1), NULLIF(@InsertionVia,0), ISNULL(@ProcedureAbandoned,CONVERT(bit,0)), ISNULL(@IntubationFailed,CONVERT(bit,0)), @LoggedInUserId, getdate())
	END
	ELSE
	BEGIN
		UPDATE ERS_ProcedureLowerExtent
		SET 
			ExtentId = NULLIF(@ExtentId,0),
			AdditionalInfo = @AdditionalInfo,
			EndoscopistId = @EndoscopistId,
			ConfirmedById = NULLIF(@ConfirmedById,0),
			CaecumIdentifiedById = NULLIF(@CaecumIdentifiedById,0),
			LimitationId = NULLIF(@LimitationId,0),
			LimitationOther = @LimitationOther,
			DifficultiesEncounteredId = NULLIF(@DifficultyEncounteredId,0),
			RectalExamPerformed = NULLIF(@PR, -1),
			RetroflectionPerformed = NULLIF(@Retroflexion, -1),
			InsertionAccessViaId = NULLIF(@InsertionVia,0),
			Abandoned = ISNULL(@ProcedureAbandoned,CONVERT(bit,0)),
			IntubationFailed = ISNULL(@IntubationFailed,CONVERT(bit,0)),
			WhoUpdatedId = @LoggedInUserId,
			WhenUpdated = getdate()
		WHERE 
			ProcedureId = @ProcedureId AND
			EndoscopistId = @EndoscopistId
	END

	EXEC procedure_lower_extent_summary_update @ProcedureId

END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;
GO
PRINT N'Altering Procedure [dbo].[procedure_upper_extent_save]...';


GO

ALTER PROCEDURE [dbo].[procedure_upper_extent_save]
(
	@ProcedureId int,
	@ExtentId int,
	@AdditionalInfo varchar(max),
	@EndoscopistId int,
	@JManoeuvreId int, 
	@LimitedById int, 
	@WithdrawalMins int,
	@MucosalJunctionDistance int,
	@LimitationOther varchar(max),
	@LoggedInUserId int
)
AS
/*
--	Update History
01.			04 Jan 2023		MH added Order Message Send block while saving Extent of Intubation TFS #2475
							No extra parameter required. ProcedureId will have associated OrderId and Extent Limited By value
02.			21 March 2023	AJ j manouver handled if -1 (not specified)
03.			27 March 2023	AJ Set sections as not entered based on the extent reached
04.			08 June 2023	SG Add call to ogd_diagnoses_summary_update to ensure report gets populated with Normal if no abnormalities are added
05.         08 Nov 2023     MS Add MucosalJunctionDistance column and related logic
							
*/
BEGIN
	Declare @bitHasProcedureFailed as bit
	Set @bitHasProcedureFailed = 0

	IF NOT EXISTS (SELECT 1 FROM ERS_ProcedureUpperExtent WHERE ProcedureId = @ProcedureId AND EndoscopistId = @EndoscopistId)
	BEGIN
		INSERT INTO ERS_ProcedureUpperExtent (ProcedureId, ExtentId, AdditionalInfo, EndoscopistId, JManoeuvreId, LimitationId, MucosalJunctionDistance, WhoUpdatedId, WhenUpdated, LimitationOther)
		VALUES (@ProcedureId, NULLIF(@ExtentId,0), NULLIF(@AdditionalInfo,''), @EndoscopistId, NULLIF(@JManoeuvreId,-1), NULLIF(@LimitedById,0), NULLIF(@MucosalJunctionDistance,0), @LoggedInUserId, getdate(), NULLIF(@LimitationOther,''))
	END
	ELSE
	BEGIN

		/*Check if new values been added for limitations */
		IF ISNULL(@LimitationOther,'') <> ''
		BEGIN
			IF NOT EXISTS (SELECT 1 FROM dbo.ERS_Limitations WHERE Description = @LimitationOther)
			BEGIN
				/*get and set the new items order id so it appears 1 above 'other' we always want other to be last*/

				DECLARE @OtherListOrderBy_l int = (SELECT ListOrderBy FROM ERS_Limitations WHERE Description = 'Other')
				INSERT INTO ERS_Limitations (Description, NEDTerm, ListOrderBy) VALUES (@LimitationOther, 'Other', @OtherListOrderBy_l)
			
				UPDATE dbo.ERS_Limitations SET ListOrderBy = @OtherListOrderBy_l + 1 WHERE Description = 'Other'
		

			SELECT @LimitedById = UniqueId FROM ERS_Limitations WHERE Description = @LimitationOther
		
			DECLARE @ProcTypeId int = (SELECT ProcedureType FROM ERS_Procedures WHERE ProcedureId = @ProcedureId)
			INSERT INTO ERS_LimitationProcedureTypes (ProcedureTypeId, LimitationId) VALUES (@ProcTypeId, @LimitedById)
			END
			ELSE
				SELECT @LimitedById = UniqueId FROM ERS_Limitations WHERE Description = @LimitationOther
		END 

		UPDATE ERS_ProcedureUpperExtent
		SET 
			ExtentId = NULLIF(@ExtentId,0),
			AdditionalInfo = NULLIF(@AdditionalInfo,''),
			EndoscopistId = @EndoscopistId,
			JManoeuvreId = NULLIF(@JManoeuvreId,-1),
			LimitationId = NULLIF(@LimitedById,0),
			MucosalJunctionDistance = NULLIF(@MucosalJunctionDistance,0),
			WhoUpdatedId = @LoggedInUserId,
			WhenUpdated = getdate(),
			LimitationOther = NULLIF(@LimitationOther,'')
		WHERE 
			ProcedureId = @ProcedureId AND
			EndoscopistId = @EndoscopistId
	END

	DECLARE @SectionId int, @ProceureTypeId int, @ExtentIsSuccess bit, @ExtentDescription varchar(200), @SummaryText varchar(max) = ''
	SELECT @SectionID = UISectionId FROM UI_Sections WHERE SectionName = 'Extent'

	SELECT @ProceureTypeId = ProcedureType FROM ERS_Procedures WHERE ProcedureId = @ProcedureId
	
	/*Furthest extent*/
	SELECT TOP 1 @ExtentDescription = ee.Description, @AdditionalInfo = epue.AdditionalInfo, @ExtentIsSuccess = ee.IsSuccess
								FROM dbo.ERS_ProcedureUpperExtent epue 
									INNER JOIN dbo.ERS_Extent ee ON epue.ExtentId = ee.UniqueId
								WHERE epue.ProcedureId=@ProcedureId
								ORDER BY ee.ListOrderBy DESC
	
	/*Handle failed procedures*/
	IF @ExtentDescription IN ('intubation failed','abandoned')
	Begin
		EXEC diagnoses_set_procedure_failed @ProcedureId
		Set @bitHasProcedureFailed = 1
	End

	IF ISNULL(@MucosalJunctionDistance,0) > 0
	BEGIN

		SET @SummaryText = 'The apparent mucosal junction: ' + @MucosalJunctionDistance + 'cm'
	END

	IF (SELECT COUNT(*) FROM ERS_ProcedureUpperExtent WHERE ProcedureId = @ProcedureId AND NULLIF(JManoeuvreId,-1) IS NOT NULL) > 0
	BEGIN
		DECLARE @JManouvreResult varchar(100)

		/*Overall JManouvre result regardless of who done it, was it done*/
		IF EXISTS (SELECT 1 FROM ERS_ProcedureUpperExtent WHERE ProcedureId = @ProcedureId AND ISNULL(JManoeuvreId,0) = 1)
			SET @JManouvreResult = 'performed. '
		ELSE
			SET @JManouvreResult = 'not carried out. '

		SET @SummaryText = @SummaryText + 'J manoeuvre ' + @JManouvreResult
	END
		
	SET @SummaryText = @SummaryText +   
						CASE LOWER(@ExtentDescription )
							WHEN 'intubation failed' THEN 'Failed intubation' + CASE WHEN ISNULL(@AdditionalInfo,'') <> '' THEN ': ' + @AdditionalInfo ELSE '' END
							WHEN 'abandoned' THEN 'Procedure failed (abandoned)' + CASE WHEN ISNULL(@AdditionalInfo,'') <> '' THEN ': ' + @AdditionalInfo ELSE '' END
							WHEN 'other' THEN  'Procedure failed' + CASE WHEN ISNULL(@AdditionalInfo,'') <> '' THEN ': ' + @AdditionalInfo ELSE '' END
							ELSE 'The procedure was completed successfully to the ' + @ExtentDescription
						END
	--limited by...?
	IF ISNULL(@LimitedById, 0) > 0
	BEGIN
		SET @SummaryText = @SummaryText + ' but limited by ' + (SELECT LOWER(Description) FROM ERS_Limitations WHERE UniqueId = @LimitedById)
	END

	IF ISNULL(@SummaryText,'') <> ''
	BEGIN
		UPDATE ERS_ProcedureUpperExtent
		SET Summary = @SummaryText
		WHERE ProcedureId = @ProcedureId

	END
	
	DECLARE @Summary VARCHAR(max) = 'Extent:'


	--remove complete section entry incase conditions no longer apply. Will get re-evaluated after
	EXEC UI_update_procedure_summary @ProcedureId, 'Extent', @Summary, 0, @EndoscopistId

	--Check if the Extent has reached or exceeded the planned extent, if so mark as success
	IF @ExtentId > 0 
	BEGIN
		DECLARE @ExtentListOrder int = (SELECT ListOrderBy FROM ERS_Extent WHERE UniqueId = @ExtentId)
		DECLARE @PlannedExtentListOrder int = (SELECT e.ListOrderBy FROM ERS_ProcedurePlannedExtent ppe JOIN ERS_Extent e ON e.UniqueId = ppe.ExtentId WHERE ppe.ProcedureId = @ProcedureId)

		IF (@ExtentListOrder >= @PlannedExtentListOrder AND @ExtentListOrder > 0)
				SET @ExtentIsSuccess = 1
	END

	IF @ExtentId > 0 AND @ExtentIsSuccess = 1
		EXEC UI_update_procedure_summary @ProcedureId, 'Extent', 'Extent:', @ExtentId, @EndoscopistId
	ELSE IF @ExtentIsSuccess = 0 AND @LimitedById > 1
	BEGIN
		IF (SELECT LOWER(NEDTerm) FROM dbo.ERS_Limitations WHERE UniqueId = @LimitedById) = 'other'
		BEGIN
			IF ISNULL(@LimitationOther,'') <> ''
			BEGIN
				EXEC UI_update_procedure_summary @ProcedureId, 'Extent', 'Extent:' , @ExtentId, @EndoscopistId
			END
		END
		ELSE
		BEGIN
			EXEC UI_update_procedure_summary @ProcedureId, 'Extent', 'Extent:', @ExtentId, @EndoscopistId
		END
	END

	IF ISNULL(@WithdrawalMins,0) > 0
	BEGIN
		EXEC UI_update_procedure_summary @ProcedureId, 'Total withdrawal time', 'Total withdrawal time:', 1, @EndoscopistId
	END

	IF @JManoeuvreId > -1
	BEGIN
		EXEC UI_update_procedure_summary @ProcedureId, 'JManoevre', 'JManoevre:', 1, @EndoscopistId
	END
	ELSE
	BEGIN
		EXEC UI_update_procedure_summary @ProcedureId, 'JManoevre', 'JManoevre:', 0 , @EndoscopistId
	END
	
	--MH Added on 04 Jan 2023 
	Exec usp_SendIntubationExtentOrderMessageByProcedureId @ProcedureId, @bitHasProcedureFailed, @LoggedInUserId

	EXEC ogd_diagnoses_summary_update @ProcedureID

	--Handle unentered sections
	DECLARE @MatrixCode VARCHAR(100)

	--based on extent reached
	IF LOWER(@ExtentDescription)= 'oesophagus'
	BEGIN
		--if Oesophagus then Stomach and Duodenum not entered
		EXEC dbo.diagnoses_control_save @SiteID = 0,               -- int
		                                @DiagnosesMatrixCode = 'StomachNotEntered', -- varchar(50)
		                                @Value = 'true'                -- varchar(50)
		
		EXEC dbo.diagnoses_control_save @SiteID = 0,               -- int
		                                @DiagnosesMatrixCode = 'DuodenumNotEntered', -- varchar(50)
		                                @Value = 'true'                -- varchar(50)
	END
	IF LOWER(@ExtentDescription)= 'stomach'
	BEGIN
		--if stomach Duodenum not entered
		EXEC dbo.diagnoses_control_save @SiteID = 0,               -- int
		                                @DiagnosesMatrixCode = 'DuodenumNotEntered', -- varchar(50)
		                                @Value = 'true'                -- varchar(50)
		
	END
END
GO


UPDATE dbo.UI_Sections SET NEDRequired = 0 WHERE SectionName IN ('Distal attachments','AI software','Chromendoscopies')
GO


ALTER PROCEDURE [dbo].[usp_NED_Generate_Report]
(
	@ProcedureId AS INT
)
AS
BEGIN
	SET NOCOUNT ON;

/*
	<xs:schema xmlns="https://www.jets.nhs.uk/schema/hospital.sendbatchmessage-version2.xsd" 
	xmlns:mstns="https://www.jets.nhs.uk/schema/hospital.sendbatchmessage-version2.xsd" 
	xmlns:xs="http://www.w3.org/2001/XMLSchema" 
	targetNamespace="https://www.jets.nhs.uk/schema/hospital.sendbatchmessage-version2.xsd" 
	elementFormDefault="qualified" id="SendBatchMessageFile">		

*/
Declare @site AS VARCHAR(50);
DECLARE 
		@description	AS VARCHAR(1000),
		@uniqueid		AS VARCHAR(15),
		@previousLocalProcedureId AS VARCHAR(15),
		@PatientId		AS INT,
		@sessionType	AS VARCHAR(50),
		@operatingHospitalId AS INT,
		@ProcedureTypeId AS INT,
		@ExportFolderPath AS VARCHAR(100);	--## XML Export Folder path.. Set by Admin in the [ERS_SystemConfig] Table

DECLARE @returnXML XML;

	Set @description = 'NED List';
	SELECT @operatingHospitalId = OperatingHospitalId FROM ERS_Procedures WHERE ProcedureId = @ProcedureId;
	SELECT @site = [NED_HospitalSiteCode], @ExportFolderPath=[NED_ExportPath] FROM [dbo].[ERS_SystemConfig] WHERE OperatingHospitalId = @operatingHospitalId;

	SELECT @ProcedureTypeId = ProcedureType,
		   @uniqueid = RIGHT(('00000' + CAST(@ProcedureId AS VARCHAR(6))),6) --## Procedure Id
							+ RIGHT(('0' + CAST(ProcedureType AS VARCHAR(2))),2)  --## Procedure Type; ie: OGD=1/ERCP=2/COLON=3/FLEXI=13
								+ (CASE ProcedureType	WHEN  1 THEN 'o' 
														WHEN  2 THEN 'e'
														WHEN  4 THEN 's' 
														WHEN  3 THEN 'c'
														WHEN  6 THEN 'u'
														WHEN  7 THEN 'u'
														WHEN  8 THEN 'n'
														WHEN  9 THEN 't'
									END)	--## Procedure Letter
		 , @sessionType=Case ListType	When 1 Then 'Service List' 
										When 2 Then 'Adhoc Training List' 
											   Else 'Dedicated Training List' End 
		, @PatientId = PatientId
	From dbo.ERS_Procedures Where ProcedureId=@ProcedureId;


	--## UniqueId is generated- so UPDATE this new value now in the ERS_Procedures Table
	UPDATE dbo.ERS_Procedures
	SET [NEDProcedureId] = @uniqueid
	WHERE ProcedureId=@ProcedureId;

	--## Now get the Previous NED Unique Id- of the same Patient... We know the Patient Id already! Use it!!
	SELECT @previousLocalProcedureId = IsNull([NEDProcedureId], '') 
			 FROM dbo.ERS_Procedures 
			WHERE PatientId = @PatientId AND ProcedureId<@ProcedureId
		 ORDER BY ProcedureID DESC;

	print '@uniqueid: ' + @uniqueid;

SET @returnXML=(
SELECT 
	  @uniqueid											AS '@uniqueId'
	, @description										AS '@description'
	, REPLACE(CONVERT(VARCHAR, p.CreatedOn, 106), ' ', '/')	AS '@date'	--### '10 Oct 2020' ==> '10/Oct/2020'
	, P.ProcedureTime AS '@time'
	, @sessionType										AS '@type'	-- SessionTypeEnum
	, @site												AS '@site'	--## Hospital Code

	/*	##### Procedure info	*/
	, (
	SELECT 
		  @uniqueid										AS '@localProcedureId'
		, @previousLocalProcedureId						AS '@previousLocalProcedureId'
		, (CASE P.ProcedureType WHEN 1 THEN 'OGD' 
								WHEN 2 THEN 'ERCP' 
								WHEN 3 THEN 'COLON' 
								WHEN 4 THEN 'FLEXI' 
								WHEN 6 THEN 'EUS' 
								WHEN 7 THEN 'EUS' 
								WHEN 8 THEN 'ENT' 
								WHEN 9 THEN 'ENT' 
		   END) AS '@procedureName'
		, Dis.NEDTerm AS '@procedureDiscomfort'	
		, PPDD.NEDTerm AS '@postProcedureDiscomfort' -- **************************** TO DO *********************************
		, dbo.fnNED_ProcedureExtent(@ProcedureId, 0) AS '@extent'	--## OverAll Extent info - EE/ER- whoever has gone Furthest distance!!
		, (CASE WHEN Drug.entonox IS NULL THEN 'No' ELSE 'Yes' END) AS '@entonox'
		, CASE WHEN ISNULL((SELECT DrugNo FROM ERS_UpperGIPremedication WHERE ProcedureId = @ProcedureID AND DrugNo = -2), 0) = -2 THEN 'Yes' ELSE 'No' END AS '@generalAnaes'
		, CONVERT(VARCHAR, P.StartDateTime, 126) AS '@procedureStartTime'
		, CONVERT(VARCHAR, P.EndDateTime, 126) AS '@procedureEndTime'
		, Ins.NEDTerm AS '@insufflation' 
		, PS.NEDTerm AS '@providerSector'
		, RT.NEDTerm AS '@referrer'
		, CASE WHEN ISNULL(P.ReferrerTypeOther, '') = '' THEN NULL ELSE P.ReferrerTypeOther END AS '@referrerOther' -- ***************** Only if referrer is 'Other' *******************************
		, PO.NEDTerm AS '@providerOrganisation' 
		, CASE WHEN ISNULL(P.ProviderOther, '') = '' THEN NULL ELSE P.ProviderOther END AS '@providerOrganisationOther' -- **************** Only if providerOrganisation is 'Other' *************************
		, CASE WHEN P.ChecklistComplete = 0 THEN 'No' ELSE 'Yes' END AS '@checklist' 
		, CASE WHEN PatStat.ListItemText = 'Day patient' THEN 'Inpatient' ELSE PatStat.ListItemText END AS '@admissionType'
		, Urgency.Description AS '@urgencyType' 
		, Ext.NEDTerm AS '@plannedExtent'
		, ISNULL(AIS.NEDTerm, 'None')  AS '@artificialintelligence'
		, CASE WHEN AIS.NEDTerm = 'Other' THEN PAIS.AISoftwareOther ELSE NULL END AS '@artificialintelligenceOther' -- **************** Only if artificialintelligence is 'Other' *************************
		, CASE WHEN PAIS.AISoftwareName IS NULL OR AIS.NEDTerm = 'None' THEN NULL ELSE PAIS.AISoftwareName END AS '@nameOfAISoftware' -- **************** Only if artificialintelligence is NOT 'None' *************************
		, CASE WHEN CHARINDEX('.00',P.Points,0) > 0 THEN CONVERT(VARCHAR(10), CONVERT(INT, P.Points)) ELSE CONVERT(VARCHAR(10), P.Points) END AS '@procedurePoints'


		/*	##### Patient Info	*/		
		, (CASE Pat.Gender WHEN 'Not Known' THEN 'Other' WHEN 'Not Specif' THEN 'Other' ELSE Pat.Gender END)		AS 'patient/@gender'
		, (0+ FORMAT(GETDATE(),'yyyyMMdd') - FORMAT(Pat.DateOfBirth,'yyyyMMdd') ) /10000 AS 'patient/@age'


		/*	##### Drugs	*/
		, CASE WHEN CHARINDEX('.00',ISNULL(Drug.pethidine,0),0) > 0 THEN CONVERT(VARCHAR(10), CONVERT(INT,ISNULL(Drug.pethidine,0))) ELSE CONVERT(VARCHAR(10),ISNULL(Drug.pethidine,0)) END	AS 'drugs/@pethidine'	--## Required
		, CASE WHEN CHARINDEX('.00',ISNULL(Drug.midazolam,0),0) > 0 THEN CONVERT(VARCHAR(10), CONVERT(INT,ISNULL(Drug.midazolam,0))) ELSE CONVERT(VARCHAR(10),ISNULL(Drug.midazolam,0)) END	AS 'drugs/@midazolam'	--## Required
		, CASE WHEN CHARINDEX('.00',ISNULL(Drug.fentanyl,0),0) > 0 THEN CONVERT(VARCHAR(10), CONVERT(INT,ISNULL(Drug.fentanyl,0))) ELSE CONVERT(VARCHAR(10),ISNULL(Drug.fentanyl,0))	END AS 'drugs/@fentanyl'	--## Required
		, CASE WHEN CHARINDEX('.00',ISNULL(Drug.buscopan,0),0) > 0 THEN CONVERT(VARCHAR(10), CONVERT(INT,ISNULL(Drug.buscopan,0))) ELSE CONVERT(VARCHAR(10),ISNULL(Drug.buscopan,0))	END AS 'drugs/@buscopan'	--## Required
		, CASE WHEN ISNULL(Drug.propofol, 0) = 0 THEN 'No' ELSE	'Yes' END			AS 'drugs/@propofol'	--## YesNo
		, ISNULL(Drug.noDrugsAdministered, 'Yes')	AS 'drugs/@noDrugsAdministered'


		/*	##### Staff.Members: 1 Procedure to MANY staff.. So - need a SQL Subquery- to return a RecordSet		*/
		,(
			SELECT 
			  Staff.professionalBodyCode AS '@professionalBodyCode'
			, Staff.EndoscopistRole		AS '@endoscopistRole'
			, Staff.ProcedureRole		AS '@procedureRole'	-- ProcedureRoleTypeEnum
			, Staff.Extent				AS '@extent'
			, CASE Staff.[jManoeuvre] WHEN 1 THEN 'Yes' WHEN 0 THEN 'No' ELSE NULL END 	AS '@jManoeuvre'	-- Opt -- Mandatory for OGD, Colon and Flexi procedures (Rectal retroversion)
			/*	##### Therapeutic = Sesion->Procedure-> Staff.members-> Staff-> Therapeutic; 1 [Staff] to Many [Therapeutic sessions]	*/
			, (
				SELECT * FROM (SELECT 
					   T.NedName	AS '@type'	-- M	--## The type of therapeutic procedure.
					 , CASE WHEN rc.RegionId IS NULL THEN T.[Site] ELSE 'Ileo-colon anastomosis' END		AS '@site'	-- O -- BiopsyEnum  --## The location where the therapeutic procedure was performed.
					 , ISNULL(T.EndoRole, Staff.ProcedureRole) AS '@role' -- O	-- ProcedureRoleTypeEnum
					 , T.polypSize	AS '@polypSize' -- O	-- PolypSizeEnum --## The size of polyp (if found) -> is ONLY for COLON/FLEXI
					 , T.PolypSizeInt AS '@polypSizeInteger'  
					 , T.Detected AS '@observed' 
					 , T.Tattooed	AS '@tattooed'	-- O	-- TattooEnum
					 , SUM(T.Performed)	AS '@performed'	-- M	-- REQUIRED; INT	-- ## Number performed
					 , SUM(T.Successful)	AS '@successful' -- M	-- REQUIRED; INT -- Number of successful
					 , SUM(T.Retrieved)	AS '@retrieved'	-- O	-- INT	-- ## Number of Polyp retrieved -> is ONLY for COLON/FLEXI
					 , T.comment 	AS '@comment'	-- O	--## Use this field to define what Other is when selected.
					 , T.Morphology AS '@morphology' -- **************************** TO DO *********************************

				FROM dbo.tvfNED_ProcedureTherapeutic(P.ProcedureType, @ProcedureId, Staff.ConsultantTypeId) AS T --## Which Consultant's Record in the Procedure?
					LEFT JOIN dbo.ERS_Sites ES ON es.SiteId = T.SiteId
					LEFT JOIN tvfProcedureResectedColon(@ProcedureId) RC ON RC.RegionId = ES.RegionId
				GROUP BY T.SiteId,T.NedName, 
						CASE WHEN rc.RegionId IS NULL THEN T.[Site] ELSE 'Ileo-colon anastomosis' END,
						T.EndoRole,
						T.polypSize,
						T.PolypSizeInt,
						T.Detected,
						T.Tattooed, 
						T.comment,
						T.Morphology) AS a
				FOR XML PATH('therapeutic'), ROOT('therapeutics'), TYPE
			)/* End of: Therapeutic List- for a Staff Member		*/
			FROM dbo.tvfNED_ProcedureConsultants(@ProcedureId, P.ProcedureType) AS Staff
			WHERE Staff.EndosId > 0
			FOR XML PATH('Staff'), ROOT('staff.members'), TYPE
		)
			/*	##### Indications: -- 1 or Many	*/		
			, (
				SELECT 
					  dbo.HTMLDecode(I.NedTerm) AS '@indication'
					, I.Comment AS '@comment'
					, I.fitPositiveValue AS '@fitPositiveValue' -- When indication is FIT Positive then specify the FIT value in (micrograms/gram)
					, I.elevatedCalprotectinValue AS '@elevatedCalprotectinValue' -- When indication is Elevated calprotectin then specify the value in (micrograms/gram)
					FROM dbo.tvfNED_ProcedureIndication(@ProcedureId) AS I
					FOR XML PATH('indication'), ROOT('indications'), TYPE
			)
			/*	##### subIndications: -- 0 or Many	*/	
			, (
				SELECT 
					  I.NedTerm AS '@type'
					, I.Comment AS '@comment'
					FROM dbo.tvfNED_ProcedureSubIndication(@ProcedureId) AS I
					FOR XML PATH('subIndication'), ROOT('subIndications'), TYPE
			)
			
			/*	##### Limitations: */
			,(
				SELECT 	
					  L.Limitation AS '@limitation'
					, L.Comment AS '@comment'
				FROM [dbo].[tvfNED_ProcedureLimitation](P.ProcedureType, @ProcedureId) AS L
					FOR XML PATH('limitation'), ROOT('limitations'), TYPE
			)	

			/*	##### Biopsy: 0 or Many		*/ --## For Colon/Flexi/OGD
			, (	SELECT 
						  B.BiopsySite		AS '@biopsySite'
						, B.NumberPerformed AS '@numberPerformed'
					FROM [dbo].[tvfNED_ProcedureBiopsy](p.ProcedureType, @ProcedureId) AS B				
					 FOR XML PATH('biopsy'), ROOT('biopsies'), TYPE
			)
			/*	##### Diagnoses: 1 or Many		*/ 
			, (	SELECT 
						  D.Ned_Name	AS '@diagnosis'
						, D.tattooed	AS '@tattooed'
						, CASE WHEN RIGHT(D.Site,2) = ', '
							THEN (LEFT(D.Site, LEN(D.Site)-1))
							ELSE  D.Site END		AS '@site'
						, CASE WHEN RIGHT(D.Comment,2)=', ' 
							THEN (LEFT(D.Comment, LEN(D.Comment)-1)) 
							ELSE D.Comment END
									AS '@comment'	--## Remove the extra ',' at the end!
						,D.barrettsLengthCircumferential AS '@barrettsLengthCircumferential' --Required for diagnosis of Barretts
						,D.barrettsLengthMaximum AS '@barrettsLengthMaximum'--, barrettsLengthMaximum --Required for diagnosis of Barretts
						,D.barretsInspectionTime AS '@barretsInspectionTime'--, barretsInspectionTime --Required for diagnosis of Barretts
						,D.gastricInspectiontime AS '@gastricInspectionTime'--, gastricInspectiontime --Required if diagnosis of gastric atrophy OR gastric intestinal metaplasia
						,D.oesophagitisLaClassification AS '@oesophagitisLAClassification'--, oesophagitisLaClassification --Required if diagnosis of Oesophagitis - reflux
						,D.DICAScore AS '@DICAScore'--, DICAScore --required if diagnosis of Diverticulosis
						,D.UCEIS AS '@UCEIS'--, UCEIS --If diagnosis is Ulcerative Colitis either UCEIS or Mayo scores must be provided
						,D.mayoScore AS '@mayoScore'--, mayoScore --If diagnosis is Ulcerative Colitis either UCEIS or Mayo scores must be provided
						--, site --If diagnosis is Crohns Colitis or Crohn`s- terminal ileum and [ExtentLookup]= Neo-terminal ileum
						,NULLIF(RutgeertsScore,'') AS '@rutgeertsScore' --If diagnosis is Crohns Colitis or Crohn`s- terminal ileum and [ExtentLookup]= Neo-terminal ileum
						, CDEIS AS '@CDEIS' --If diagnosis is Crohns Colitis or Crohn`s- terminal ileum
					FROM [dbo].[tvfNED_Diagnoses](p.ProcedureType, @ProcedureId) AS D
					 FOR XML PATH('diagnose'), ROOT('diagnoses'), TYPE
			)
			/*	##### Adverse events: -- 1 or Many	*/
			,(	SELECT 
					  ISNULL(AD.adverseEvent,'None')	AS '@adverseEvent'
					, (CASE WHEN AD.adverseEvent = 'Other' THEN AD.Comment END) 						AS '@comment'
				FROM dbo.tvfNED_ProcedureAdverseEvents(@ProcedureId)		AS AD
				FOR XML PATH('adverse.event'), ROOT('adverse.events'), TYPE			
			)
			, ( SELECT * FROM (SELECT ISNULL(scog.NEDTerm, 'other') AS '@manufacturerGeneration'
						, CASE WHEN scog.NEDTerm IS NULL THEN scog.Description ELSE NULL END AS '@other'
				FROM ERS_Scopes sco
				JOIN ERS_Procedures p ON p.Instrument1 = sco.ScopeId
				JOIN ERS_ScopeGenerations scog ON sco.ScopeGenerationId = scog.UniqueId
				WHERE p.ProcedureId = @ProcedureId
				UNION
				SELECT ISNULL(scog.NEDTerm, 'other') AS '@manufacturerGeneration'
						, CASE WHEN scog.NEDTerm IS NULL THEN scog.Description ELSE NULL END AS '@other'
				FROM ERS_Scopes sco
				JOIN ERS_Procedures p ON p.Instrument2 = sco.ScopeId
				JOIN ERS_ScopeGenerations scog ON sco.ScopeGenerationId = scog.UniqueId
				WHERE p.ProcedureId = @ProcedureId) AS a
				FOR XML PATH('scopes'), ROOT('scopes'), TYPE
			   )
			 , (
				SELECT ISNULL(C.NEDTerm, 'None') AS '@type', 
				(CASE WHEN C.NEDTerm = 'Other' THEN PC.AdditionalInfo END) 						AS '@comment'

				 FROM ERS_Procedures p
				 LEFT JOIN ERS_ProcedureChromendosopy PC ON p.ProcedureId= PC.ProcedureId
				 LEFT JOIN ERS_Chromendoscopies C ON C.UniqueId = PC.ChromendoscopyId
				 WHERE P.ProcedureId = @ProcedureId 
				 FOR XML PATH('chromendoscopy'), ROOT('chromendoscopies'), TYPE
				) 
				 ,( 
					SELECT CASE 
						WHEN @ProcedureTypeId = 1 THEN
							(SELECT DISTINCT * FROM (SELECT 
								CASE WHEN (SELECT COUNT(*) FROM ERS_UpperGIPremedication WHERE DrugName = 'Pharyngeal Anaesthesia' AND ProcedureId = @ProcedureId) = 1 THEN 'Yes' ELSE 'No' END AS '@pharyngealAnaes'
								,pe.WithdrawalMins AS '@scopeWithdrawalTime'
								,ISNULL(DA.NEDTerm,'None') AS '@distalAttachment'
								,CASE WHEN LOWER(DA.NEDTerm) = 'other' THEN PD.AdditionalInfo ELSE NULL END AS '@distalAttachmentOther'
								,CASE WHEN p.Transnasal = 1 THEN 'Nasal' ELSE 'Oral' END AS '@OGDRoute'
								,V.NEDTerm AS '@OGDMucosalVisualisation'
								,CASE WHEN (SELECT COUNT(*) FROM ERS_ProcedureMucosalCleaning WHERE ProcedureId = @ProcedureId) > 1 THEN 'Other' ELSE ISNULL(C.NEDTerm, 'None') END AS '@OGDMucosalCleaning'
								,CASE WHEN (SELECT COUNT(*) FROM ERS_ProcedureMucosalCleaning WHERE ProcedureId = @ProcedureId) > 1 THEN dbo.fnNED_MucosalCleaning(@ProcedureId) WHEN LOWER(C.NEDTerm) = 'other' THEN C.Description ELSE NULL END AS '@OGDMucosalCleaningOther'
								,CASE WHEN P.FormerProcedureId IS NOT NULL THEN 'Yes' WHEN (SELECT COUNT(*) FROM ERS_Procedures pq WHERE pq.FormerProcedureId = p.ProcedureId) > 0 THEN 'Yes' ELSE 'No' END AS '@dualProcedure'
								,CASE WHEN dbo.fnNED_GetOGDPhotoDocumentation(@ProcedureId) = 1 THEN 'Yes' ELSE 'No' END '@photoDocumentation'
								FROM ERS_Procedures AS P 
									LEFT JOIN ERS_ProcedureMucosalVisualisation PV ON PV.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_MucosalVisualisation V ON V.UniqueId = PV.MucosalVisualisationId
									LEFT JOIN ERS_ProcedureUpperExtent PE ON PE.ProcedureId = P.ProcedureId AND PE.WithdrawalMins IS NOT NULL /*there may be more than 1 record in the table where there's 2 endos on a procedure*/
									LEFT JOIN ERS_ProcedureDistalAttachment PD ON PD.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_DistalAttachments DA ON DA.UniqueId = PD.DistalAttachmentId
									LEFT JOIN ERS_ProcedureMucosalCleaning PC ON PC.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_MucosalCleaning C ON C.UniqueId = PC.MucosalCleaningId
								WHERE P.ProcedureId=@ProcedureId) ogd
							FOR XML PATH('OGD'),TYPE)
						WHEN @ProcedureTypeId = 2 THEN
							(SELECT * FROM (SELECT DISTINCT 
								CASE WHEN (SELECT COUNT(*) FROM ERS_UpperGIPremedication WHERE DrugName = 'Pharyngeal Anaesthesia' AND ProcedureId = @ProcedureId) = 1 THEN 'Yes' ELSE 'No' END AS '@pharyngealAnaes'
								,CASE WHEN (SELECT COUNT(*) FROM ERS_UpperGIPremedication WHERE DrugName = 'Prophylactic Antibiotics' AND ProcedureId = @ProcedureId) = 1 THEN 'Yes' ELSE 'No' END AS '@antibioticGiven'
								,NULLIF(CASE WHEN ((ev.IntendedBileDuct = 1 AND ev.MajorPapillaBile = 1) OR (ev.IntendedBileDuct_ER = 1 AND ev.MajorPapillaBile_ER = 1)) OR
												  ((ev.IntendedPancreaticDuct = 1 AND ev.MajorPapillaPancreatic = 1) OR (ev.IntendedPancreaticDuct_ER = 1 AND ev.MajorPapillaPancreatic_ER = 1)) THEN 'Yes' 
											 WHEN ((ev.IntendedBileDuct = 1 AND ev.MajorPapillaBile <> 1) OR (ev.IntendedBileDuct_ER = 1 AND ev.MajorPapillaBile_ER <> 1)) OR
												  ((ev.IntendedPancreaticDuct = 1 AND ev.MajorPapillaPancreatic <> 1) OR (ev.IntendedPancreaticDuct_ER = 1 AND ev.MajorPapillaPancreatic_ER <> 1)) THEN 'No'
											ELSE 'Not Applicable' END,'') AS '@successfulCannulation'
								,ISNULL((SELECT MAX(ISNULL(CONVERT(INT, d.StonesSize),0)) FROM ERS_ERCPAbnoDuct d INNER JOIN ERS_Sites s ON S.SiteId = d.SiteId WHERE S.ProcedureId = @ProcedureId),0) AS '@sizeLargestStone'
								--,ISNULL(CASE WHEN ExtractionOutcome = 1 THEN CONVERT(varchar(max),'Yes') 
								--       WHEN ExtractionOutcome <> 0 THEN CONVERT(varchar(max),'No') END,'Not Applicable') AS '@completeStoneClearance'
								,ISNULL((SELECT TOP 1 CASE WHEN ISNULL(ExtractionOutcome,0) = 1 THEN CONVERT(VARCHAR(MAX),'Yes') 
											  WHEN StoneRemoval = 0 OR ExtractionOutcome <> 1 THEN 'No' END 
								 FROM dbo.ERS_ERCPTherapeutics ET WHERE SiteId IN (SELECT SiteId FROM ERS_Sites WHERE ProcedureId = @ProcedureId)),'Not Applicable') AS '@completeStoneClearance'
								,ISNULL((SELECT CASE WHEN LOWER(Region) LIKE '%hepatic%' THEN CONVERT(VARCHAR(MAX), 'Yes') ELSE CONVERT(VARCHAR(MAX), 'No') END
											FROM ERS_ERCPAbnoDuct eed 
											INNER JOIN dbo.ERS_Sites es ON eed.SiteId = es.SiteId
												INNER JOIN dbo.ERS_Regions er ON es.RegionId = er.RegionId
											WHERE es.ProcedureId = @ProcedureId AND Stricture = 1),CONVERT(VARCHAR(MAX), 'Not Applicable')) AS '@extraHepaticStricture'
								,ISNULL((SELECT CASE WHEN eed.Stricture = 1 AND eug.BrushCytology = 1 THEN CONVERT(VARCHAR(MAX),'Yes') WHEN eed.Stricture = 1 AND eug.BrushCytology = 0 THEN CONVERT(VARCHAR(MAX),'No') WHEN eed.Stricture = 0 THEN 'Not Applicable' END 
										 FROM ERS_ERCPAbnoDuct eed 
												INNER JOIN dbo.ERS_Sites es ON eed.SiteId = es.SiteId
												INNER JOIN dbo.ERS_Regions er ON es.RegionId = er.RegionId
												INNER JOIN dbo.ERS_UpperGISpecimens eug ON es.SiteId = eug.SiteId
											WHERE es.ProcedureId = @ProcedureId AND
												LOWER(Region) LIKE '%hepatic%'),CONVERT(VARCHAR(MAX),'Not Applicable')) AS '@extrahepaticStrictureCytologyHistologyTaken'
								,ISNULL((SELECT CASE WHEN eug.CorrectStentPlacement = 1 OR ert.CorrectStentPlacement = 1 THEN CONVERT(VARCHAR(MAX),'Yes') ELSE CONVERT(VARCHAR(MAX),'No') END
											FROM ERS_ERCPAbnoDuct eed 
												INNER JOIN dbo.ERS_Sites es ON eed.SiteId = es.SiteId
												INNER JOIN dbo.ERS_Regions er ON es.RegionId = er.RegionId
												LEFT JOIN dbo.ERS_UpperGITherapeutics eug ON es.SiteId = eug.SiteId
												LEFT JOIN dbo.ERS_ERCPTherapeutics ert ON es.SiteId = ert.SiteId
											WHERE es.ProcedureId = @ProcedureId AND eed.Stricture = 1 AND eug.StentInsertion = 1 AND
												LOWER(Region) LIKE '%hepatic%'),CONVERT(VARCHAR(MAX),'Not Applicable')) AS '@extrahepaticStrictureStentSuccessfullyPlaced'
								,CASE WHEN ISNULL(eea.MajorBilrothRoux,0) = 1 THEN 'Yes' ELSE 'No' END AS '@previousSurgeryBilrothRoux'
								,NULLIF(lc.NEDTerm,0) AS '@levelOfComplexity'
								,CASE WHEN (SELECT COUNT(*) FROM ERS_UpperGIPremedication WHERE DrugName = 'Prophylactic Rectal NSAIDS' AND ProcedureId = @ProcedureId) = 1 THEN 'Yes' ELSE 'No' END AS '@prophylacticRectalNSAIDS'
								,CASE WHEN eea.MinorSiteLocation IN (1,2) THEN 'No' ELSE 'Yes' END AS '@nativePapilla'
								FROM ERS_Procedures AS P 
									LEFT JOIN (SELECT eed.AbnoDuctId, es.ProcedureId, eed.Stricture, er.Region 
												FROM ERS_ERCPAbnoDuct eed 
													INNER JOIN dbo.ERS_Sites es ON eed.SiteId = es.SiteId
													INNER JOIN dbo.ERS_Regions er ON es.RegionId = er.RegionId
											WHERE es.ProcedureId = @ProcedureId AND
												LOWER(Region) LIKE '%hepatic%')  ercs ON ercs.ProcedureId = P.ProcedureId
									LEFT JOIN (SELECT Stones, ISNULL(t.ExtractionOutcome,0) ExtractionOutcome, es.ProcedureId 
												FROM ERS_ERCPAbnoDuct a
													 INNER JOIN dbo.ERS_Sites es ON a.SiteId = es.SiteId
													 LEFT JOIN ERS_ERCPTherapeutics t ON t.siteId = a.SiteId
												 WHERE a.Stones = 1) estones ON estones.ProcedureId = P.ProcedureId
									LEFT JOIN dbo.ERS_ERCPPapillaryAnatomy eea ON P.ProcedureId = eea.ProcedureId
									LEFT JOIN dbo.ERS_Visualisation ev ON P.ProcedureId = ev.ProcedureID
									LEFT JOIN dbo.ERS_ProcedureLevelOfComplexity cl ON cl.ProcedureId = P.ProcedureId
									LEFT JOIN dbo.ERS_LevelOfComplexity lc ON lc.UniqueId = cl.ComplexityId
								WHERE P.ProcedureId=@ProcedureId) ercp
							FOR XML PATH('ERCP'),TYPE) 
						WHEN @ProcedureTypeId = 3 THEN
							(SELECT TOP 1 * FROM (SELECT 
								(SELECT ISNULL(SUM(Detected),0) FROM tvfNED_PolypsDetailsView(@ProcedureTypeId, @ProcedureId)) AS '@polypsDetected'
								,CASE WHEN p.ScopeGuide = 1 THEN 'Yes' ELSE 'No' END AS '@magneticEndoscopeImagerUsed'
								,LE.WithdrawalMins AS '@scopeWithdrawalTime'
								,CASE WHEN LE.RectalExamPerformed = 1 THEN 'Yes' ELSE 'No' END AS '@digitalRectalExamination'
								,CONVERT(VARCHAR(19),LE.CaecumIntubationStart, 126) AS '@caecumTime'
								,ISNULL(DA.NEDTerm,'None') AS '@distalAttachment'
								,NULLIF(CASE WHEN LOWER(DA.NEDTerm) = 'other' THEN PD.AdditionalInfo ELSE '' END,'') AS '@distalAttachmentOther'
								,IT.NEDTerm AS '@insertionTechnique'
								,PB.LeftPrepScore AS '@bowelPrepLeft'
								,PB.RightPrepScore AS '@bowelPrepRight'
								,PB.TransversePrepScore AS '@bowelPrepTransverse'
								,PB.TotalPrepScore AS '@bowelPrepTotal'
								,ISNULL(B.NEDTerm,'None') AS '@bowelPrep'
								,NULLIF(CASE WHEN LOWER(B.NEDTerm) = 'other' THEN B.[Description] ELSE '' END,'') AS '@bowelPrepOther'
								,CASE WHEN P.FormerProcedureId IS NOT NULL THEN 'Yes' WHEN (SELECT COUNT(*) FROM ERS_Procedures pq WHERE pq.FormerProcedureId = p.ProcedureId) > 0 THEN 'Yes' ELSE 'No' END AS '@dualProcedure'
								FROM ERS_Procedures AS P 
									LEFT JOIN ERS_ProcedureLowerExtent LE ON LE.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_ProcedureDistalAttachment PD ON PD.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_DistalAttachments DA ON DA.UniqueId = PD.DistalAttachmentId
									LEFT JOIN ERS_ProcedureInsertionTechnique PIT ON PIT.ProcedureId = p.ProcedureId
									LEFT JOIN ERS_InsertionTechniques IT ON IT.UniqueId = PIT.InsertionTechniqueId
									LEFT JOIN ERS_ProcedureBowelPrep PB ON PB.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_BowelPrep B ON B.UniqueId = PB.BowelPrepId
								WHERE P.ProcedureId=@ProcedureId) col
							FOR XML PATH('Colon'),TYPE)
						WHEN @ProcedureTypeId = 4 THEN
							(SELECT * FROM (SELECT 
								(SELECT ISNULL(SUM(Detected),0) FROM tvfNED_PolypsDetailsView(@ProcedureTypeId, @ProcedureId)) AS '@polypsDetected'
								,CASE WHEN LE.RectalExamPerformed = 1 THEN 'Yes' ELSE 'No' END AS '@digitalRectalExamination'
								,CASE WHEN p.ScopeGuide = 1 THEN 'Yes' ELSE 'No' END AS '@magneticEndoscopeImagerUsed'
								,ISNULL(DA.NEDTerm,'None') AS '@distalAttachment'
								,CASE WHEN LOWER(DA.NEDTerm) = 'other' THEN PD.AdditionalInfo ELSE NULL END AS '@distalAttachmentOther'
								,IT.NEDTerm AS '@insertionTechnique'
								,PB.LeftPrepScore AS '@bowelPrepLeft'
								,PB.TransversePrepScore AS '@bowelPrepTransverse'
								,PB.RightPrepScore AS '@bowelPrepRight'
								,PB.TotalPrepScore AS '@bowelPrepTotal'
								,ISNULL(B.NEDTerm,'None') AS '@bowelPrep'
								,CASE WHEN LOWER(B.NEDTerm) = 'other' THEN B.[Description] ELSE NULL END AS '@bowelPrepOther'
								FROM ERS_Procedures AS P 
									LEFT JOIN (SELECT ProcedureId, MAX(CONVERT(INT,RectalExamPerformed)) AS RectalExamPerformed FROM ERS_ProcedureLowerExtent GROUP BY ProcedureId) LE ON LE.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_ProcedureDistalAttachment PD ON PD.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_DistalAttachments DA ON DA.UniqueId = PD.DistalAttachmentId
									LEFT JOIN ERS_ProcedureInsertionTechnique PIT ON PIT.ProcedureId = p.ProcedureId
									LEFT JOIN ERS_InsertionTechniques IT ON IT.UniqueId = PIT.InsertionTechniqueId
									LEFT JOIN ERS_ProcedureBowelPrep PB ON PB.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_BowelPrep B ON B.UniqueId = PB.BowelPrepId
								WHERE P.ProcedureId=@ProcedureId) flexi
							FOR XML PATH('Flexi'),TYPE)  
						WHEN @ProcedureTypeId IN (6,7) THEN
							(SELECT * FROM (SELECT DISTINCT CASE WHEN pm.DrugName = '' THEN 'Yes' ELSE 'No' END AS '@prophylacticAntibioticsBeforeEUS',
												ISNULL(dbo.fnNED_FNAFNBSolidLesions(@ProcedureId, P.ProcedureType),'Not applicable') AS '@FNAorFNBSolidLesions',
												ISNULL(dbo.fnNED_FNAFNBTissueAdequacy(@ProcedureId),'Not Applicable') AS '@FNAorFNBTissueAdequacy'
											FROM ERS_UpperGIPremedication pm
												LEFT JOIN ERS_Sites s ON s.ProcedureId = pm.ProcedureId
												LEFT JOIN ERS_UpperGITherapeutics T ON S.SiteId = T.SiteId
												LEFT JOIN ERS_UpperGISpecimens AS SP  ON SP.SiteId = S.SiteId
												LEFT JOIN ERS_ERCPTherapeutics ET ON ET.SiteId = S.SiteId
											WHERE pm.ProcedureId = @ProcedureId) eushpb
								FOR XML PATH('EUS'),TYPE)  
						WHEN @ProcedureTypeId IN (8,9) THEN
							 (SELECT * FROM (SELECT DISTINCT 
								 (SELECT ISNULL(SUM(Detected),0) FROM tvfNED_PolypsTotalsView(@ProcedureId)) AS '@polypsDetected'
								 ,ISNULL(DA.NEDTerm,'None') AS '@distalAttachment'
								 ,CASE WHEN LOWER(DA.NEDTerm) = 'other' THEN PDA.AdditionalInfo ELSE NULL END AS '@distalAttachmentOther'
								 ,ISNULL(ET.NEDTerm,'None') AS '@enteroscopyTechnique'
								 ,CASE WHEN LOWER(ET.NEDTerm) = 'other' THEN PET.AdditionalInfo ELSE NULL END AS '@enteroscopyTechniqueOther'
								 ,PID.InsertionLength AS '@depthOfInsertion'
								 ,CASE PID.Tattooed WHEN 1 THEN 'Yes' WHEN 0 THEN 'No' ELSE 'Not Applicable' END AS '@tattooMaxDepthInsertion'
								 ,CASE WHEN PE.RectalExamPerformed = 1 AND ET.NEDTerm IN ('Single balloon anal','Double balloon anal') THEN 'Yes' ELSE 'No' END AS '@digitalRectalExamination'
									FROM ERS_Procedures AS P 
										LEFT JOIN ERS_ProcedureDistalAttachment PDA ON PDA.ProcedureId = P.ProcedureId
										LEFT JOIN ERS_DistalAttachments DA ON DA.UniqueId = PDA.DistalAttachmentId
										LEFT JOIN ERS_ProcedureEnteroscopyTechniques PET ON PET.ProcedureId = P.ProcedureId
										LEFT JOIN ERS_EnteroscopyTechniques ET ON ET.UniqueId = PET.TechniqueId
										LEFT JOIN ERS_ProcedureInsertionDepth PID ON PID.ProcedureId = P.ProcedureId
										LEFT JOIN ERS_ProcedureLowerExtent PE ON PE.ProcedureId = P.ProcedureId
									WHERE P.ProcedureId=@ProcedureId) ent
								FOR XML PATH('ENT'),TYPE)
					END
				  )
		FROM ERS_Procedures AS P 
		WHERE P.ProcedureId=@ProcedureId
		FOR XML PATH('procedure'), ROOT('procedures'), TYPE
		)	

    FROM dbo.ERS_Procedures AS P
    LEFT JOIN dbo.ERS_ProcedureDiscomfortScore AS DisNo ON P.ProcedureId = DisNo.ProcedureId
    LEFT JOIN dbo.ERS_DiscomfortScores AS Dis ON DisNo.DiscomfortScoreId = Dis.UniqueId
	LEFT JOIN dbo.ERS_PostProcedureDiscomfortScore PPD ON PPD.ProcedureId = P.ProcedureId 
	LEFT JOIN dbo.ERS_DiscomfortScores AS PPDD ON PPD.DiscomfortScoreId = PPDD.UniqueId
	LEFT JOIN dbo.ers_lists AS PatStat ON PatStat.ListDescription = 'Patient Status' AND PatStat.ListItemNo = P.PatientStatus 
	LEFT JOIN dbo.ERS_UrgencyTypes AS Urgency ON P.CategoryListId = Urgency.UniqueId
	LEFT JOIN dbo.ERS_ProcedurePlannedExtent AS PPE ON P.ProcedureId = PPE.ProcedureId 
	LEFT JOIN dbo.ERS_Extent AS Ext ON PPE.ExtentId = Ext.UniqueId 
	LEFT JOIN dbo.ERS_ProcedureInsufflation AS PIns ON P.ProcedureId = PIns.ProcedureId
	LEFT JOIN dbo.ERS_Insufflation AS Ins ON PIns.InsufflationId = Ins.UniqueId 
	LEFT JOIN dbo.ERS_ProviderSectors AS PS ON P.PatientType = PS.UniqueId 
	LEFT JOIN dbo.ERS_ReferrerTypes AS RT ON P.ReferrerType = RT.UniqueId 
	LEFT JOIN dbo.ERS_ProviderOrganisation AS PO ON P.ProviderTypeId = PO.UniqueId 
	LEFT JOIN dbo.ERS_ProcedureAISoftware AS PAIS ON P.ProcedureId = PAIS.ProcedureId 
	LEFT JOIN dbo.ERS_AISoftware AS AIS ON PAIS.AISoftwareId = AIS.UniqueId 
	LEFT JOIN dbo.ERS_ProcedureChromendosopy AS PCHR ON PCHR.ProcedureId = p.ProcedureId


  INNER JOIN dbo.ERS_VW_Patients			AS Pat  ON P.PatientId=Pat.[PatientId]
   LEFT JOIN dbo.tvfNED_ProcedureDrugList(@ProcedureId)	AS Drug		ON P.ProcedureId = Drug.ProcedureId	
   --LEFT JOIN dbo.ERS_UpperGIQA				AS QA   ON P.ProcedureId = QA.ProcedureId	-- Patient DIscomfort
   LEFT JOIN dbo.ERS_BowelPreparation		AS BP   ON P.ProcedureId=BP.ProcedureID	-- DIscomfort for Nurse
   LEFT JOIN dbo.ERS_ColonExtentOfIntubation   EL	ON P.ProcedureId = EL.ProcedureId
	   WHERE P.ProcedureId= @ProcedureId
		 FOR XML PATH ('session'), ROOT('hospital.SendBatchMessage'), ELEMENTS
);

DECLARE   @xmlFileName AS VARCHAR(100)
		, @ReportDate AS VARCHAR(10)
		, @ReportTime AS VARCHAR(8)
		, @xmlPreviousExportFileName AS VARCHAR(100);

SELECT    @ReportDate = CONVERT(VARCHAR(10), CreatedOn, 103)
		, @ReportTime = CONVERT(VARCHAR(8), ModifiedOn, 108) 
FROM dbo.ERS_Procedures WHERE ProcedureId=@ProcedureId;

--== Check whether Admin has added/removed the '\' at the end of the Path.. 
SET @ExportFolderPath = (CASE WHEN RIGHT(@ExportFolderPath, 1)='\' THEN @ExportFolderPath ELSE (@ExportFolderPath + '\') END);

SELECT TOP 1 @xmlPreviousExportFileName = xmlFileName FROM [dbo].[ERS_NedFilesLog] WHERE ProcedureId=@ProcedureId ORDER BY [LogId] DESC;

--### File Path and Name example: 'NED_xml_output\74_22-09-2017_09-32-53_00831101o.xml' vs '99_19-10-2017_16-24-16_00205602e.xml'
SET @xmlFileName =    @ExportFolderPath 
					+ @site + '_' 
					+ REPLACE(@ReportDate, '/', '-') + '_' 
					+ REPLACE(@ReportTime, ':', '-') + '_' 
					+ @uniqueid	
					+ '.xml';					

SELECT @returnXML AS returnXML
				 , '<hospital.SendBatchMessage xmlns:xsd="http://www.w3.org/2001/XMLSchema"'
				  + 
				 ' xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"'
				  +
				 ' xmlns="https://www.jets.nhs.uk/schema/hospital.sendbatchmessage-version2.xsd"'
				  +
				 ' softwareVersion="2"' AS NS_Info		--## These extra info will be added to the Actual XML file in .NET while exporting;
				 , @xmlFileName AS xmlFileName
				 , ISNULL(@xmlPreviousExportFileName, 'x') AS PreviousFileName;

END
GO


------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO



------------------------------------------------------------------------------------------------------------------------
-- Script to insert missing comorbidities '
------------------------------------------------------------------------------------------------------------------------
Create table #tmpComorb (comorb varchar(100))
insert into #tmpComorb
Values
('TIA/Stroke'),
('AF'),
('Pacemaker'),
('Atrial Fibrillation'),
('Chronic Kidney Disease'),
('Enlarged Lymph Nodes'),
('Essential HyperTension'),
('Heart Failure'),
('Interstitial Lung Disease'),
('Pleural Effusion'),
('Pneumonia'),
('Rheumatoid Arthritis'),
('Secondary Cancer')

Declare @tmpComorb Varchar(100)
Declare @CoMorbidityId int
Declare @Count int = 1

WHILE (Select count(*) from #tmpComorb) > 0
BEGIN
	Select TOP 1 @tmpComorb = comorb from #tmpComorb
	If not exists (Select 1 from ERS_Comorbidity where Description = @tmpComorb) 
	BEGIN
		INSERT INTO ERS_Comorbidity (Description, NEDTerm, AdditionalInfo, Suppressed)
		Values (@tmpComorb, '', 0, 0)
	END

	Select @CoMorbidityId = UniqueId from ERS_Comorbidity where Description = @tmpComorb
	PRINT @tmpComorb + ' - ' + convert(varchar, @CoMorbidityId)
	WHILE @Count < 10
	BEGIN
		IF NOT EXISTS (SELECT 1 FROM ERS_ComorbidityProcedureTypes where ComorbidityId = @CoMorbidityId AND ProcedureTypeId = @Count)
		BEGIN
			PRINT '    Inserting for ProcedureType ' + convert(varchar, @Count)
			INSERT INTO ERS_ComorbidityProcedureTypes (ComorbidityId, ProcedureTypeId)
			VALUES (@CoMorbidityId, @Count)
		END
		Set @Count = @Count + 1
	END
	Set @Count = 1
	--last thing to do is delete the one we've just done
	delete from #tmpComorb where @tmpComorb = comorb
END

drop table #tmpComorb

GO


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 11.01.24
-- TFS#	
-- Description of change
-- Changes so NED sender only gets V2 reports
------------------------------------------------------------------------------------------------------------------------
GO


ALTER PROCEDURE [dbo].[usp_NEDI2_Get_Unsent_Procedures]
AS
BEGIN
	select prc.ProcedureId, prc.operatingHospitalId, ISNULL((SELECT TOP 1 ISNULL(ServiceId,'') FROM dbo.ERS_NedI2FilesLog enil WHERE enil.ProcedureID = prc.ProcedureId AND [Status] = 5),'') AS ServiceId
	From dbo.ERS_Procedures prc 
	INNER JOIN ERS_ProcedureTypes pt ON pt.ProcedureTypeId = prc.ProcedureType, ERS_SystemConfig cnfg 
		--LEFT JOIN (SELECT enil.ProcedureId, ServiceId FROM dbo.ERS_NedI2FilesLog enil WHERE [STATUS] = 5) fp ON fp.ProcedureId = ProcedureId
	WHERE prc.CreatedOn !< (SELECT TOP 1 v.InstallDate FROM dbo.DBVersion v WHERE v.VersionNum LIKE '2.%') AND (ProcedureCompleted = 1 and cnfg.NEDEnabled = 1 and prc.operatingHospitalId = cnfg.operatingHospitalId AND pt.NedExportRequired = 1 AND ISNULL(prc.NEDExported,0) = 0)

END

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 15.01.24
-- TFS#	2921
-- Description of change
-- Fungal culture added to for bronchs and ebus specimens list
------------------------------------------------------------------------------------------------------------------------
GO



IF NOT EXISTS (SELECT 1 FROM sys.columns WHERE Name = 'FungalCultureMycology' AND OBJECT_ID = OBJECT_ID('ERS_BRTSpecimens'))
BEGIN
    ALTER TABLE ERS_BRTSpecimens ADD FungalCultureMycology INT
END
GO


ALTER PROCEDURE [dbo].[specimens_brt_select]
(
	@SiteId INT	
)
AS

SET NOCOUNT ON

SELECT 
	sp.SiteID,
	[None],
	EBUSTB,
	EBUSHistology,
	EBUSCytology,
	EBUSBacteriology,
	EndobronchialTB,
	EndobronchialHistology,
	EndobronchialBacteriology,
	EndobronchialVirology,
	EndobronchialMycology,
	BrushCytology,
	BrushBacteriology,
	BrushVirology,
	BrushMycology,
	DistalBlindTB,
	DistalBlindHistology,
	DistalBlindBacteriology,
	DistalBlindVirology,
	DistalBlindMycology,
	TransbronchialTB,
	TransbronchialHistology,
	TransbronchialBacteriology,
	TransbronchialVirology,
	TransbronchialMycology,
	TranstrachealHistology,
	TranstrachealBacteriology,
	TranstrachealVirology,
	TranstrachealMycology,
	TrapPCP,
	TrapTB,
	TrapCytology,
	TrapBacteriology,
	TrapVirology,
	TrapMycology,
	BALPCP,
	BALTB,
	BALCytology,
	BALBacteriology,
	BALVirology,
	BALMycology,
	BALVolInfused,
	BALVolRecovered,
	FNATB,
	FNACytology,
	FNABacteriology,
	FNAVirology,
	FNAMycology,
	FNAHistology,
	CryoHistology,
	FungalCultureMycology
FROM 
	[ERS_BRTSpecimens] sp
JOIN
	ERS_Sites s ON sp.SiteId = s.SiteId
JOIN
	ERS_Procedures p ON s.ProcedureId = p.ProcedureId
WHERE 
	sp.SiteId = @SiteId
	
GO



ALTER PROCEDURE [dbo].[specimens_brt_save]
(
	@SiteID INT,
	@None BIT,
	@EBUSTB INT,
	@EBUSHistology INT,
	@EBUSCytology INT,
	@EBUSBacteriology INT,
	@EndobronchialTB INT,
	@EndobronchialHistology INT,
	@EndobronchialBacteriology INT,
	@EndobronchialVirology INT,
	@EndobronchialMycology INT,
	@BrushCytology INT,
	@BrushBacteriology INT,
	@BrushVirology INT,
	@BrushMycology INT,
	@DistalBlindTB INT,
	@DistalBlindHistology INT,
	@DistalBlindBacteriology INT,
	@DistalBlindVirology INT,
	@DistalBlindMycology INT,
	@TransbronchialTB INT,
	@TransbronchialHistology INT,
	@TransbronchialBacteriology INT,
	@TransbronchialVirology INT,
	@TransbronchialMycology INT,
	@TranstrachealHistology INT,
	@TranstrachealBacteriology INT,
	@TranstrachealVirology INT,
	@TranstrachealMycology INT,
	@TrapPCP INT,
	@TrapTB INT,
	@TrapCytology INT,
	@TrapBacteriology INT,
	@TrapVirology INT,
	@TrapMycology INT,
	@BALPCP INT,
	@BALTB INT,
	@BALCytology INT,
	@BALBacteriology INT,
	@BALVirology INT,
	@BALMycology INT,
	@BALVolInfused DECIMAL(6,2),
	@BALVolRecovered DECIMAL(6,2),
	@FNATB INT,
	@FNACytology INT,
	@FNABacteriology INT,
	@FNAVirology INT,
	@FNAMycology INT,
	@FNAHistology INT,
	@CryoHistology INT,
	@FungalCultureMycology INT,
	@LoggedInUserId INT

)
AS

SET NOCOUNT ON

DECLARE @proc_id INT
DECLARE @proc_type INT

BEGIN TRANSACTION

BEGIN TRY
	SELECT 
		@proc_id = p.ProcedureId,
		@proc_type = p.ProcedureType
	FROM 
		ERS_Sites s
	JOIN 
		ERS_Procedures p ON s.ProcedureId = p.ProcedureId
	WHERE 
		SiteId = @SiteId

	IF NOT EXISTS (SELECT 1 FROM ERS_BRTSpecimens WHERE SiteId = @SiteId)
	BEGIN
		INSERT INTO ERS_BRTSpecimens (
			SiteID,
			[None],
			EBUSTB,
			EBUSHistology,
			EBUSCytology,
			EBUSBacteriology,
			EndobronchialTB,
			EndobronchialHistology,
			EndobronchialBacteriology,
			EndobronchialVirology,
			EndobronchialMycology,
			BrushCytology,
			BrushBacteriology,
			BrushVirology,
			BrushMycology,
			DistalBlindTB,
			DistalBlindHistology,
			DistalBlindBacteriology,
			DistalBlindVirology,
			DistalBlindMycology,
			TransbronchialTB,
			TransbronchialHistology,
			TransbronchialBacteriology,
			TransbronchialVirology,
			TransbronchialMycology,
			TranstrachealHistology,
			TranstrachealBacteriology,
			TranstrachealVirology,
			TranstrachealMycology,
			TrapPCP,
			TrapTB,
			TrapCytology,
			TrapBacteriology,
			TrapVirology,
			TrapMycology,
			BALPCP,
			BALTB,
			BALCytology,
			BALBacteriology,
			BALVirology,
			BALMycology,
			BALVolInfused,
			BALVolRecovered,
			FNATB,
			FNACytology,
			FNABacteriology,
			FNAVirology,
			FNAMycology,
			FNAHistology,
			CryoHistology,
			FungalCultureMycology,
			WhoCreatedId,
			WhenCreated)
		VALUES (
			@SiteID,
			@None,
			@EBUSTB,
			@EBUSHistology,
			@EBUSCytology,
			@EBUSBacteriology,
			@EndobronchialTB,
			@EndobronchialHistology,
			@EndobronchialBacteriology,
			@EndobronchialVirology,
			@EndobronchialMycology,
			@BrushCytology,
			@BrushBacteriology,
			@BrushVirology,
			@BrushMycology,
			@DistalBlindTB,
			@DistalBlindHistology,
			@DistalBlindBacteriology,
			@DistalBlindVirology,
			@DistalBlindMycology,
			@TransbronchialTB,
			@TransbronchialHistology,
			@TransbronchialBacteriology,
			@TransbronchialVirology,
			@TransbronchialMycology,
			@TranstrachealHistology,
			@TranstrachealBacteriology,
			@TranstrachealVirology,
			@TranstrachealMycology,
			@TrapPCP,
			@TrapTB,
			@TrapCytology,
			@TrapBacteriology,
			@TrapVirology,
			@TrapMycology,
			@BALPCP,
			@BALTB,
			@BALCytology,
			@BALBacteriology,
			@BALVirology,
			@BALMycology,
			@BALVolInfused,
			@BALVolRecovered,
			@FNATB,
			@FNACytology,
			@FNABacteriology,
			@FNAVirology,
			@FNAMycology,
			@FNAHistology,
			@CryoHistology,
			@FungalCultureMycology,
			@LoggedInUserId,
			GETDATE())

		INSERT INTO ERS_RecordCount (
			[ProcedureId],
			[SiteId],
			[Identifier],
			[RecordCount]
		)
		VALUES (
			@proc_id,
			@SiteId,
			'Specimens Taken',
			1)
	END

	ELSE
	BEGIN
		UPDATE 
			ERS_BRTSpecimens
		SET 
			[None] = @None,
			EBUSTB = @EBUSTB,
			EBUSHistology = @EBUSHistology,
			EBUSCytology = @EBUSCytology,
			EBUSBacteriology = @EBUSBacteriology,
			EndobronchialTB = @EndobronchialTB,
			EndobronchialHistology = @EndobronchialHistology,
			EndobronchialBacteriology = @EndobronchialBacteriology,
			EndobronchialVirology = @EndobronchialVirology,
			EndobronchialMycology = @EndobronchialMycology,
			BrushCytology = @BrushCytology,
			BrushBacteriology = @BrushBacteriology,
			BrushVirology = @BrushVirology,
			BrushMycology = @BrushMycology,
			DistalBlindTB = @DistalBlindTB,
			DistalBlindHistology = @DistalBlindHistology,
			DistalBlindBacteriology = @DistalBlindBacteriology,
			DistalBlindVirology = @DistalBlindVirology,
			DistalBlindMycology = @DistalBlindMycology,
			TransbronchialTB = @TransbronchialTB,
			TransbronchialHistology = @TransbronchialHistology,
			TransbronchialBacteriology = @TransbronchialBacteriology,
			TransbronchialVirology = @TransbronchialVirology,
			TransbronchialMycology = @TransbronchialMycology,
			TranstrachealHistology = @TranstrachealHistology,
			TranstrachealBacteriology = @TranstrachealBacteriology,
			TranstrachealVirology = @TranstrachealVirology,
			TranstrachealMycology = @TranstrachealMycology,
			TrapPCP = @TrapPCP,
			TrapTB = @TrapTB,
			TrapCytology = @TrapCytology,
			TrapBacteriology = @TrapBacteriology,
			TrapVirology = @TrapVirology,
			TrapMycology = @TrapMycology,
			BALPCP = @BALPCP,
			BALTB = @BALTB,
			BALCytology = @BALCytology,
			BALBacteriology = @BALBacteriology,
			BALVirology = @BALVirology,
			BALMycology = @BALMycology,
			BALVolInfused = @BALVolInfused,
			BALVolRecovered = @BALVolRecovered,
			FNATB = @FNATB,
			FNACytology = @FNACytology,
			FNABacteriology = @FNABacteriology,
			FNAVirology = @FNAVirology,
			FNAMycology = @FNAMycology,
			FNAHistology = @FNAHistology,
			CryoHistology = @CryoHistology,
			FungalCultureMycology = @FungalCultureMycology,
			WhoUpdatedId = @LoggedInUserId,
			WhenUpdated = GETDATE()
		WHERE 
			SiteId = @SiteId
	END


	IF @None = 0
	BEGIN
		IF NOT EXISTS (SELECT 1 FROM ERS_UpperGIFollowUp WHERE ProcedureId = @proc_id)
		BEGIN
			INSERT INTO ERS_UpperGIFollowUp (ProcedureId, AwaitingPathologyResults) 
			VALUES (@proc_id, 1)

			EXEC UI_update_procedure_summary @proc_id, 'Follow up', 'Follow up:', 1
		END
		ELSE
		BEGIN
			UPDATE ERS_UpperGIFollowUp
			SET AwaitingPathologyResults = 1
			WHERE ProcedureId = @proc_id
		END

		--Will set follow up section as complete
		EXEC UI_update_procedure_summary @proc_id, 'Follow up', 'Follow up:', 1
	END
	ELSE
	BEGIN
		BEGIN
			UPDATE ERS_UpperGIFollowUp
			SET AwaitingPathologyResults = 0
			WHERE ProcedureId = @proc_id
		END

		--Will set follow up section as complete
		EXEC UI_update_procedure_summary @proc_id, 'Follow up', 'Follow up:', 0
	END

END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;
GO


ALTER PROCEDURE [dbo].[specimens_brt_summary_update]
(
	@SiteId INT
)
AS
	SET NOCOUNT ON

	DECLARE 
		@summary VARCHAR (8000),
		@RegionId INT,
		@None BIT,
		@EBUSTB INT = NULL,
		@EBUSHistology INT = NULL,
		@EBUSCytology INT = NULL,
		@EBUSBacteriology INT = NULL,
		@EndobronchialTB INT = NULL,
		@EndobronchialHistology INT = NULL,
		@EndobronchialBacteriology INT = NULL,
		@EndobronchialVirology INT = NULL,
		@EndobronchialMycology INT = NULL,
		@BrushCytology INT = NULL,
		@BrushBacteriology INT = NULL,
		@BrushVirology INT = NULL,
		@BrushMycology INT = NULL,
		@DistalBlindTB INT = NULL,
		@DistalBlindHistology INT = NULL,
		@DistalBlindBacteriology INT = NULL,
		@DistalBlindVirology INT = NULL,
		@DistalBlindMycology INT = NULL,
		@TransbronchialTB INT = NULL,
		@TransbronchialHistology INT = NULL,
		@TransbronchialBacteriology INT = NULL,
		@TransbronchialVirology INT = NULL,
		@TransbronchialMycology INT = NULL,
		@TranstrachealHistology INT = NULL,
		@TranstrachealBacteriology INT = NULL,
		@TranstrachealVirology INT = NULL,
		@TranstrachealMycology INT = NULL,
		@TrapPCP INT = NULL,
		@TrapTB INT = NULL,
		@TrapCytology INT = NULL,
		@TrapBacteriology INT = NULL,
		@TrapVirology INT = NULL,
		@TrapMycology INT = NULL,
		@BALPCP INT = NULL,
		@BALTB INT = NULL,
		@BALCytology INT = NULL,
		@BALBacteriology INT = NULL,
		@BALVirology INT = NULL,
		@BALMycology INT = NULL,
		@BALVolInfused DECIMAL(6,2),
		@BALVolRecovered DECIMAL(6,2),
		@FNATB INT = NULL,
		@FNACytology INT = NULL,
		@FNABacteriology INT = NULL,
		@FNAVirology INT = NULL,
		@FNAMycology INT = NULL,
		@FNAHistology INT = NULL,
		@CryoHistology INT,
		@FungalCultureMycology INT = NULL
	
	DECLARE @tmpSummary TABLE(Val VARCHAR(MAX))
	DECLARE @XMLlist XML

	SELECT 
		@summary = '',
		@RegionId = s.RegionId,
		@None=[None],
		@EBUSTB=EBUSTB,
		@EBUSHistology=EBUSHistology,
		@EBUSCytology=EBUSCytology,
		@EBUSBacteriology=EBUSBacteriology,
		@EndobronchialTB=EndobronchialTB,
		@EndobronchialHistology=EndobronchialHistology,
		@EndobronchialBacteriology=EndobronchialBacteriology,
		@EndobronchialVirology=EndobronchialVirology,
		@EndobronchialMycology=EndobronchialMycology,
		@BrushCytology=BrushCytology,
		@BrushBacteriology=BrushBacteriology,
		@BrushVirology=BrushVirology,
		@BrushMycology=BrushMycology,
		@DistalBlindTB=DistalBlindTB,
		@DistalBlindHistology=DistalBlindHistology,
		@DistalBlindBacteriology=DistalBlindBacteriology,
		@DistalBlindVirology=DistalBlindVirology,
		@DistalBlindMycology=DistalBlindMycology,
		@TransbronchialTB=TransbronchialTB,
		@TransbronchialHistology=TransbronchialHistology,
		@TransbronchialBacteriology=TransbronchialBacteriology,
		@TransbronchialVirology=TransbronchialVirology,
		@TransbronchialMycology=TransbronchialMycology,
		@TranstrachealHistology=TranstrachealHistology,
		@TranstrachealBacteriology=TranstrachealBacteriology,
		@TranstrachealVirology=TranstrachealVirology,
		@TranstrachealMycology=TranstrachealMycology,
		@TrapPCP=TrapPCP,
		@TrapTB=TrapTB,
		@TrapCytology=TrapCytology,
		@TrapBacteriology=TrapBacteriology,
		@TrapVirology=TrapVirology,
		@TrapMycology=TrapMycology,
		@BALPCP=BALPCP,
		@BALTB=BALTB,
		@BALCytology=BALCytology,
		@BALBacteriology=BALBacteriology,
		@BALVirology=BALVirology,
		@BALMycology=BALMycology,
		@BALVolInfused=BALVolInfused,
		@BALVolRecovered=BALVolRecovered,
		@FNATB=FNATB,
		@FNACytology=FNACytology,
		@FNABacteriology=FNABacteriology,
		@FNAVirology=FNAVirology,
		@FNAMycology=FNAMycology,
		@FNAHistology=FNAHistology,
		@CryoHistology=CryoHistology,
		@FungalCultureMycology = FungalCultureMycology
	FROM
		ERS_BRTSpecimens sp
	JOIN
		ERS_Sites s ON sp.SiteId = s.SiteId
	JOIN
		ERS_Procedures p ON s.ProcedureId = p.ProcedureId
	WHERE 
		sp.SiteId = @SiteId

	IF @None = 1
		SET @summary = @summary + 'No specimens taken'
	ELSE
	BEGIN
		IF @EBUSTB > 0 OR @EBUSHistology > 0 OR @EBUSCytology > 0 OR @EBUSBacteriology > 0
		BEGIN
			IF @EBUSTB > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @EBUSTB) + ' to TB bacteriology')
			IF @EBUSHistology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @EBUSHistology) + ' to histology')
			IF @EBUSCytology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @EBUSCytology) + ' to cytology')
			IF @EBUSBacteriology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @EBUSBacteriology) + ' to bacteriology')

			SET @XMLlist = (SELECT Val FROM @tmpSummary FOR XML  RAW, ELEMENTS, TYPE)
			SET @summary = 'EBUS specimen: ' + dbo.fnBuildString(@XMLlist)
		END

		IF @EndobronchialTB > 0 OR @EndobronchialHistology > 0 OR @EndobronchialBacteriology > 0 OR @EndobronchialVirology > 0 OR @EndobronchialMycology > 0
		BEGIN
			DELETE FROM @tmpSummary
			IF @summary <> '' SET @summary = @summary + '<br/>'
			IF @EndobronchialTB > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @EndobronchialTB) + ' to TB bacteriology')
			IF @EndobronchialHistology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @EndobronchialHistology) + ' to histology')
			IF @EndobronchialBacteriology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @EndobronchialBacteriology) + ' to bacteriology')
			IF @EndobronchialVirology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @EndobronchialVirology) + ' to virology')
			IF @EndobronchialMycology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @EndobronchialMycology) + ' to mycology')

			SET @XMLlist = (SELECT Val FROM @tmpSummary FOR XML  RAW, ELEMENTS, TYPE)
			SET @summary = @summary + 'Endobronchial biopsy: ' + dbo.fnBuildString(@XMLlist)
		END

		IF @BrushCytology > 0 OR @BrushBacteriology > 0 OR @BrushVirology > 0 OR @BrushMycology > 0
		BEGIN
			DELETE FROM @tmpSummary
			IF @summary <> '' SET @summary = @summary + '<br/>'
			IF @BrushCytology > 0  INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @BrushCytology) + ' to cytology')
			IF @BrushBacteriology > 0  INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @BrushBacteriology) + ' to bacteriology')
			IF @BrushVirology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @BrushVirology) + ' to virology')
			IF @BrushMycology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @BrushMycology) + ' to mycology')

			SET @XMLlist = (SELECT Val FROM @tmpSummary FOR XML  RAW, ELEMENTS, TYPE)
			SET @summary = @summary + 'Brush biopsy: ' + dbo.fnBuildString(@XMLlist)
		END

		IF @DistalBlindTB > 0 OR @DistalBlindHistology > 0 OR @DistalBlindBacteriology > 0 OR @DistalBlindVirology > 0 OR @DistalBlindMycology > 0
		BEGIN
			DELETE FROM @tmpSummary
			IF @summary <> '' SET @summary = @summary + '<br/>'
			IF @DistalBlindTB > 0  INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @DistalBlindTB) + ' to TB bacteriology')
			IF @DistalBlindHistology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @DistalBlindHistology) + ' to histology')
			IF @DistalBlindBacteriology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @DistalBlindBacteriology) + ' to bacteriology')
			IF @DistalBlindVirology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @DistalBlindVirology) + ' to virology')
			IF @DistalBlindMycology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @DistalBlindMycology) + ' to mycology')

			SET @XMLlist = (SELECT Val FROM @tmpSummary FOR XML  RAW, ELEMENTS, TYPE)
			SET @summary = @summary + 'Distal blind biopsy: ' + dbo.fnBuildString(@XMLlist)
		END

		IF @TransbronchialTB > 0 OR @TransbronchialHistology > 0 OR @TransbronchialBacteriology > 0 OR @TransbronchialVirology > 0 OR @TransbronchialMycology > 0
		BEGIN
			DELETE FROM @tmpSummary
			IF @summary <> '' SET @summary = @summary + '<br/>'
			IF @TransbronchialTB > 0  INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @TransbronchialTB) + ' to TB bacteriology')
			IF @TransbronchialHistology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @TransbronchialHistology) + ' to histology')
			IF @TransbronchialBacteriology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @TransbronchialBacteriology) + ' to bacteriology')
			IF @TransbronchialVirology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @TransbronchialVirology) + ' to virology')
			IF @TransbronchialMycology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @TransbronchialMycology) + ' to mycology')

			SET @XMLlist = (SELECT Val FROM @tmpSummary FOR XML  RAW, ELEMENTS, TYPE)
			SET @summary = @summary + 'Transbronchial biopsy: ' + dbo.fnBuildString(@XMLlist)
		END

		IF @TranstrachealHistology > 0 OR @TranstrachealBacteriology > 0 OR @TranstrachealVirology > 0 OR @TranstrachealMycology > 0
		BEGIN
			DELETE FROM @tmpSummary
			IF @summary <> '' SET @summary = @summary + '<br/>'
			IF @TranstrachealHistology > 0  INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @TranstrachealHistology) + ' to histology')
			IF @TranstrachealBacteriology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @TranstrachealBacteriology) + ' to bacteriology')
			IF @TranstrachealVirology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @TranstrachealVirology) + ' to virology')
			IF @TranstrachealMycology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @TranstrachealMycology) + ' to mycology')

			SET @XMLlist = (SELECT Val FROM @tmpSummary FOR XML  RAW, ELEMENTS, TYPE)
			SET @summary = @summary + 'Transtracheal biopsy: ' + dbo.fnBuildString(@XMLlist)
		END

		IF @TrapPCP > 0 OR @TrapTB > 0 OR @TrapCytology > 0 OR @TrapBacteriology > 0 OR @TrapVirology > 0 OR @TrapMycology > 0
		BEGIN
			DELETE FROM @tmpSummary
			IF @summary <> '' SET @summary = @summary + '<br/>'
			IF @TrapPCP > 0  INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @TrapPCP) + ' to PCP mycology')
			IF @TrapTB > 0  INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @TrapTB) + ' to TB bacteriology')
			IF @TrapCytology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @TrapCytology) + ' to cytology')
			IF @TrapBacteriology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @TrapBacteriology) + ' to bacteriology')
			IF @TrapVirology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @TrapVirology) + ' to virology')
			IF @TrapMycology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @TrapMycology) + ' to mycology')

			SET @XMLlist = (SELECT Val FROM @tmpSummary FOR XML  RAW, ELEMENTS, TYPE)
			SET @summary = @summary + 'Trap: ' + dbo.fnBuildString(@XMLlist)
		END

		IF @BALPCP > 0 OR @BALTB > 0 OR @BALCytology > 0 OR @BALBacteriology > 0 OR @BALVirology > 0 OR @BALMycology > 0 OR @BALVolInfused > 0 OR @BALVolRecovered > 0
		BEGIN
			DELETE FROM @tmpSummary
			IF @summary <> '' SET @summary = @summary + '<br/>'
			IF @BALPCP > 0  INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @BALPCP) + ' to PCP mycology')
			IF @BALTB > 0  INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @BALTB) + ' to TB bacteriology')
			IF @BALCytology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @BALCytology) + ' to cytology')
			IF @BALBacteriology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @BALBacteriology) + ' to bacteriology')
			IF @BALVirology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @BALVirology) + ' to virology')
			IF @BALMycology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @BALMycology) + ' to mycology')
			IF @BALVolInfused > 0 INSERT INTO @tmpSummary (Val) VALUES('Volume infused (' + dbo.fnRemoveDecTrailingZeroes(@BALVolInfused) + ' mls)')
			IF @BALVolRecovered > 0 INSERT INTO @tmpSummary (Val) VALUES('Volume recovered (' + dbo.fnRemoveDecTrailingZeroes(@BALVolRecovered) + ' mls)')

			SET @XMLlist = (SELECT Val FROM @tmpSummary FOR XML  RAW, ELEMENTS, TYPE)
			SET @summary = @summary + 'Bronchoalveolar Lavage: ' + dbo.fnBuildString(@XMLlist)
		END

		IF @FNATB > 0 OR @FNACytology > 0 OR @FNABacteriology > 0 OR @FNAVirology > 0 OR @FNAMycology > 0 OR @FNAHistology > 0
		BEGIN
			DELETE FROM @tmpSummary
			IF @summary <> '' SET @summary = @summary + '<br/>'
			IF @FNATB > 0  INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @FNATB) + ' to TB bacteriology')
			IF @FNAHistology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @FNAHistology) + ' to Histology')
			IF @FNACytology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @FNACytology) + ' to cytology')
			IF @FNABacteriology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @FNABacteriology) + ' to bacteriology')
			IF @FNAVirology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @FNAVirology) + ' to virology')
			IF @FNAMycology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @FNAMycology) + ' to mycology')
			

			SET @XMLlist = (SELECT Val FROM @tmpSummary FOR XML  RAW, ELEMENTS, TYPE)
			SET @summary = @summary + 'Fine needle aspirate: ' + dbo.fnBuildString(@XMLlist)
		END

		IF @CryoHistology > 0
		BEGIN
			IF @summary <> '' SET @summary = @summary + '<br/>'
			SET @summary = @summary + 'Cryobiopsy: ' + convert(varchar(10), @CryoHistology) + ' to histology'
		END

		
		IF @FungalCultureMycology > 0
		BEGIN
			IF @summary <> '' SET @summary = @summary + '<br/>'
			SET @summary = @summary + 'Fungal culture: ' + convert(varchar(10), @FungalCultureMycology) + ' to bacteriology'
		END
	END 
		
	-- Finally, update the summary in specimens table
	UPDATE ERS_BRTSpecimens 
	SET Summary=@summary 
	WHERE SiteId = @SiteId

GO


ALTER PROCEDURE [dbo].[printreport_specimens_select]
(
	@ProcedureId INT
)
AS
/***************************************************************************
*****                        Change History                           *****
***************************************************************************
** Rev	Date			Author			Description 
** --	-----------		---------		---------------------------------------
** 1	15 Sep 2021		Adrian (ARS)	New Bronchs section
** 2	21 Sep 2021		Adrian (ARS)	Add new reports for Bronchs
**
**************************************************************************/

SET NOCOUNT ON

DECLARE 
       @procType INT,
       @siteIdentification TINYINT,
       @siteId INT, 
       @siteNo INT,
       @siteTitle VARCHAR(3),
	   @OperatingHospitalID TINYINT
DECLARE 
       @SpecimensSummary TABLE (
              SiteId INT,
              LabRequestReportName VARCHAR(200),
              SpecimenKey VARCHAR(1000),
              Specimen VARCHAR(2000))

SELECT @procType = ProcedureType FROM ERS_Procedures WHERE ProcedureId = @ProcedureId
SELECT @OperatingHospitalID = OperatingHospitalID FROM ERS_Procedures WHERE ProcedureId = @ProcedureId


       SELECT s.SiteNo, Case @procType WHEN 1 THEN ISNULL(m.Area,'') ELSE '' END AS RegionSection, r.Region, sp.*, r.RegionId
       INTO #specimens
       FROM ERS_UpperGISpecimens sp
       JOIN ERS_Sites s ON sp.SiteId = s.SiteId
       JOIN ERS_Regions r ON s.RegionId = r.RegionId
       LEFT JOIN ERS_AbnormalitiesMatrixUpperGI m ON r.Region = m.Region AND m.ProcedureType = @procType
       LEFT JOIN [ERS_AbnormalitiesMatrixERCP] n ON r.Region = n.Region AND n.ProcedureType = @procType
       LEFT JOIN [ERS_AbnormalitiesMatrixColon] o ON r.Region = o.Region AND o.ProcedureType = @procType
       WHERE s.ProcedureId = @ProcedureId 

UPDATE #specimens SET RegionSection = CASE RegionSection WHEN 'Oesophagus' THEN 'oesophageal' WHEN 'Stomach' THEN 'gastric' WHEN 'Duodenum' THEN 'duodenal' ELSE '' END

update #specimens SET Region = CASE WHEN RegionId in (SELECT ercr.RegionId FROM dbo.ERS_ResectedColon erc
															INNER JOIN dbo.ERS_ResectedColonRegions ercr ON erc.ResectedColonID = ercr.ResectedColonID
															INNER JOIN dbo.ERS_Procedures ep ON erc.ResectedColonID = ep.ResectedColonNo
															WHERE ep.ProcedureId=@ProcedureId)
											THEN 'Anastomosis'
											ELSE Region
											END



DECLARE Site_Cursor CURSOR FOR
SELECT SiteId, SiteNo FROM #specimens ORDER BY SiteNo
       
OPEN Site_Cursor
FETCH NEXT FROM Site_Cursor INTO @siteId , @siteNo

WHILE @@FETCH_STATUS = 0
BEGIN
       SET @siteTitle = dbo.fnGetSiteTitle(@siteNo, @OperatingHospitalID)

       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Cytology', 
              CONVERT(VARCHAR, @siteId) + 'Brush', 
              LOWER(RegionSection) + ' brushings for cytology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND BrushCytology > 0
              
       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Histology', 
              CONVERT(VARCHAR, @siteId) + 'BiopsyHistology', 
              CONVERT(VARCHAR,BiopsyQtyHistology) + ' ' + LOWER(RegionSection) + CASE WHEN BiopsyQtyHistology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for histology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND BiopsyQtyHistology > 0

       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Microbiology', 
              CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
              CONVERT(VARCHAR,BiopsyQtyMicrobiology) + ' ' + LOWER(RegionSection) + CASE WHEN BiopsyQtyMicrobiology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for microbiology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND Biopsy = 1 AND BiopsyQtyMicrobiology > 0
              
       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Virology', 
              CONVERT(VARCHAR, @siteId) + 'BiopsyVirology', 
              CONVERT(VARCHAR,BiopsyQtyVirology) + ' ' + LOWER(RegionSection) + CASE WHEN BiopsyQtyVirology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for virology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND Biopsy = 1 AND BiopsyQtyVirology > 0
       
       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Histology', 
              CONVERT(VARCHAR, @siteId) + 'Polypectomy', 
              CONVERT(VARCHAR,PolypectomyQty) + ' ' + LOWER(RegionSection) + CASE WHEN PolypectomyQty > 1 THEN ' polyps' ELSE ' polyp' END + ' for histology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND Polypectomy = 1 AND PolypectomyQty > 0

       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Histology', 
              CONVERT(VARCHAR, @siteId) + 'HotBiopsy', 
              LOWER(RegionSection) + ' hot biopsy for histology from (' + LOWER(@siteTitle) + ' ) ' + Region + CASE WHEN HotBiopsyDistance > 0 THEN ' at ' + CONVERT(VARCHAR, HotBiopsyDistance) + 'cm' ELSE '' END 
       FROM #specimens 
       WHERE SiteId = @siteId AND HotBiopsy = 1
       
       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Cytology', 
              CONVERT(VARCHAR, @siteId) + 'NeedleAspirateHistology', 
              LOWER(RegionSection) + ' needle aspirate for cytology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND NeedleAspirate = 1 AND NeedleAspirateHistology = 1

       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Histology', 
              CONVERT(VARCHAR, @siteId) + 'NeedleBiopsyHistology', 
              LOWER(RegionSection) + ' needle biopsy for histology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND FNB = 1 AND NeedleBiopsyHistology = 1

       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Cytology', 
              CONVERT(VARCHAR, @siteId) + 'NeedleBiopsyCytology', 
              LOWER(RegionSection) + ' needle biopsy for cytology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND FNB = 1 AND NeedleBiopsyCytology = 1

       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Microbiology', 
              CONVERT(VARCHAR, @siteId) + 'NeedleBiopsyMicrobiology', 
              LOWER(RegionSection) + ' needle biopsy for microbiology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND FNB = 1 AND NeedleBiopsyMicrobiology = 1

       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Virology', 
              CONVERT(VARCHAR, @siteId) + 'NeedleBiopsyVirology', 
              LOWER(RegionSection) + ' needle biopsy for virology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND FNB = 1 AND NeedleBiopsyVirology = 1


       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Microbiology', 
              CONVERT(VARCHAR, @siteId) + 'NeedleAspirateMicrobiology', 
              LOWER(RegionSection) + ' needle aspirate for microbiology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND NeedleAspirate = 1 AND NeedleAspirateMicrobiology = 1

       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Virology', 
              CONVERT(VARCHAR, @siteId) + 'NeedleAspirateVirology', 
              LOWER(RegionSection) + ' needle aspirate for virology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND NeedleAspirate = 1 AND NeedleAspirateVirology = 1

       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Microbiology', 
              CONVERT(VARCHAR, @siteId) + 'GastricWashing', 
              'gastric washing for microbiology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND GastricWashing = 1

       FETCH NEXT FROM Site_Cursor INTO @siteId, @siteNo
END
CLOSE Site_Cursor;
DEALLOCATE Site_Cursor;

--biopsy series
INSERT INTO @SpecimensSummary
SELECT 
	ess.BiopsySiteId,
	'Histology',
	convert(varchar, ess.BiopsySiteId) + 'BiopsyHistology', 
	convert(varchar, ess.qty) + CASE WHEN ess.qty = 1 THEN ' biopsy' ELSE ' biopsies' END + ' for histology from ' + ebs.Description
FROM dbo.ERS_SiteSpecimens ess
	INNER JOIN dbo.ERS_BiopsySites ebs ON ess.BiopsySiteId = ebs.UniqueId
	INNER JOIN dbo.ERS_Sites es ON ess.SiteId = es.SiteId
WHERE ProcedureId = @ProcedureId


       SELECT s.SiteNo, Case @procType WHEN 1 THEN ISNULL(m.Area,'') ELSE '' END AS RegionSection, r.Region, sp.*, r.RegionId
       INTO #specimensCysto
       FROM ERS_CystoscopySpecimens sp
       JOIN ERS_Sites s ON sp.SiteId = s.SiteId
       JOIN ERS_Regions r ON s.RegionId = r.RegionId
       LEFT JOIN ERS_AbnormalitiesMatrixUpperGI m ON r.Region = m.Region AND m.ProcedureType = @procType
       LEFT JOIN [ERS_AbnormalitiesMatrixERCP] n ON r.Region = n.Region AND n.ProcedureType = @procType
       LEFT JOIN [ERS_AbnormalitiesMatrixColon] o ON r.Region = o.Region AND o.ProcedureType = @procType
       WHERE s.ProcedureId = @ProcedureId 
 
DECLARE Site_Cursor CURSOR FOR
SELECT SiteId, SiteNo FROM #specimensCysto ORDER BY SiteNo
       
OPEN Site_Cursor
FETCH NEXT FROM Site_Cursor INTO @siteId , @siteNo

WHILE @@FETCH_STATUS = 0
BEGIN
		SET @siteTitle = dbo.fnGetSiteTitle(@siteNo, @OperatingHospitalID)

		/****************************************************************
		*							MICROBIOLOGY						*
		****************************************************************/		
		/****************************************************************
		*	Microbiology Sub-section - EBUS Specimen					*
		****************************************************************/		
		INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Histology', 
              CONVERT(VARCHAR, @siteId) + 'BiopsyCystoHistology', 
              CONVERT(VARCHAR,Qunatity) + ' ' + LOWER(RegionSection) + CASE WHEN Qunatity > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for histology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimensCysto
       WHERE SiteId = @siteId AND Qunatity > 0


       FETCH NEXT FROM Site_Cursor INTO @siteId, @siteNo
END
CLOSE Site_Cursor;
DEALLOCATE Site_Cursor;

/****************************************************************
ARS(15/09/21) - Bronchs Section
ARS(21/09/21) - Updated for reports
****************************************************************/
SELECT s.SiteNo, '' AS RegionSection, r.Region, ebs.SiteID AS SiteId, r.RegionId, 
		ebs.EBUSTB, ebs.EBUSCytology, ebs.EBUSHistology, ebs.EBUSBacteriology, ebs.EndobronchialTB, ebs.EndobronchialHistology, ebs.EndobronchialBacteriology,
		ebs.EndobronchialVirology, ebs.EndobronchialMycology, ebs.BrushCytology, ebs.BrushBacteriology, ebs.BrushVirology, ebs.BrushMycology, ebs.DistalBlindTB,
		ebs.DistalBlindHistology, ebs.DistalBlindVirology, ebs.DistalBlindBacteriology, ebs.DistalBlindMycology, ebs.TransbronchialTB, ebs.TransbronchialHistology,
		ebs.TransbronchialBacteriology, ebs.TransbronchialVirology, ebs.TransbronchialMycology, ebs.TranstrachealHistology, ebs.TranstrachealBacteriology,
		ebs.TranstrachealVirology, ebs.TranstrachealMycology, ebs.TrapPCP, ebs.TrapTB, ebs.TrapCytology, ebs.TrapBacteriology, ebs.TrapVirology, ebs.TrapMycology,
		ebs.BALPCP, ebs.BALTB, ebs.BALCytology, ebs.BALBacteriology, ebs.BALVirology, ebs.BALMycology, ebs.BALVolInfused, ebs.BALVolRecovered, ebs.FNATB,
		ebs.FNACytology, ebs.FNABacteriology, ebs.FNAVirology, ebs.FNAMycology, ebs.FNAHistology, ebs.CryoHistology, ebs.FungalCultureMycology, ebs.Summary
       INTO #specimensBRT
       FROM dbo.ERS_BRTSpecimens AS ebs
       JOIN ERS_Sites s ON s.SiteId = ebs.SiteID
       JOIN ERS_Regions r ON s.RegionId = r.RegionId
       LEFT JOIN dbo.ERS_AbnormalitiesMatrixBRT AS eamb ON eamb.Region = r.Region AND eamb.ProcedureType = @procType
       WHERE s.ProcedureId = @ProcedureId 
	   
DECLARE Site_Cursor CURSOR FOR
SELECT SiteId, SiteNo FROM #specimensBRT ORDER BY SiteNo
       
OPEN Site_Cursor
FETCH NEXT FROM Site_Cursor INTO @siteId , @siteNo

WHILE @@FETCH_STATUS = 0
BEGIN
		SET @siteTitle = dbo.fnGetSiteTitle(@siteNo, @OperatingHospitalID)

		/****************************************************************
		*							MICROBIOLOGY						*
		****************************************************************/		
		/****************************************************************
		*	Microbiology Sub-section - EBUS Specimen					*
		****************************************************************/		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'SpecimenMicrobiology', 
            CONVERT(VARCHAR,spec.EBUSTB) + ' ' + LOWER(RegionSection) + CASE WHEN spec.EBUSTB > 1 THEN ' EBUS specimens' ELSE ' EBUS specimen' END + ' for TB bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.EBUSTB > 0
		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'SpecimenMicrobiology', 
            CONVERT(VARCHAR,spec.EBUSBacteriology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.EBUSBacteriology > 1 THEN ' specimens' ELSE ' specimen' END + ' for bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.EBUSBacteriology > 0
			   
		/****************************************************************
		*	Microbiology Sub-section - Endobronchial Biopsy				*
		****************************************************************/		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.EndobronchialTB) + ' ' + LOWER(RegionSection) + CASE WHEN spec.EndobronchialTB > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for TB bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.EndobronchialTB > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.EndobronchialBacteriology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.EndobronchialBacteriology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.EndobronchialBacteriology > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.EndobronchialVirology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.EndobronchialVirology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for virology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.EndobronchialVirology > 0
		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.EndobronchialMycology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.EndobronchialMycology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for mycology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.EndobronchialMycology > 0

		/****************************************************************
		*	Microbiology Sub-section - Brush Biopsy						*
		****************************************************************/		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.BrushBacteriology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.BrushBacteriology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.BrushBacteriology > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.BrushVirology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.BrushVirology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for virology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.BrushVirology > 0
		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.EndobronchialMycology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.EndobronchialMycology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for mycology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.EndobronchialMycology > 0

		/****************************************************************
		*	Microbiology Sub-section - Distal Blind Biopsy				*
		****************************************************************/		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.DistalBlindTB) + ' ' + LOWER(RegionSection) + CASE WHEN spec.DistalBlindTB > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for TB bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.DistalBlindTB > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.DistalBlindBacteriology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.DistalBlindBacteriology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.DistalBlindBacteriology > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.DistalBlindVirology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.DistalBlindVirology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for virology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.DistalBlindVirology > 0
		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.DistalBlindMycology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.DistalBlindMycology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for mycology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.DistalBlindMycology > 0

		/****************************************************************
		*	Microbiology Sub-section - Transbronchial Biopsy			*
		****************************************************************/		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.TransbronchialTB) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TransbronchialTB > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for TB bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TransbronchialTB > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.TransbronchialBacteriology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TransbronchialBacteriology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TransbronchialBacteriology > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.TransbronchialVirology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TransbronchialVirology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for virology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TransbronchialVirology > 0
		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.TransbronchialMycology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TransbronchialMycology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for mycology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TransbronchialMycology > 0

		/****************************************************************
		*	Microbiology Sub-section - Transtracheal Biopsy				*
		****************************************************************/		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.TranstrachealBacteriology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TranstrachealBacteriology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TranstrachealBacteriology > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.TranstrachealVirology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TranstrachealVirology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for virology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TranstrachealVirology > 0
		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.TranstrachealMycology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TranstrachealMycology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for mycology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TranstrachealMycology > 0

		/****************************************************************
		*	Microbiology Sub-section - Trap								*
		****************************************************************/		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.TrapTB) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TrapTB > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for TB bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TrapTB > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.TrapBacteriology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TrapBacteriology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TrapBacteriology > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.TrapVirology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TrapVirology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for virology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TrapVirology > 0
		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.TrapMycology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TrapMycology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for mycology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TrapMycology > 0

		/****************************************************************
		*	Microbiology Sub-section - Bronchoalveolar Lavage (BAL)		*
		****************************************************************/		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.BALTB) + ' ' + LOWER(RegionSection) + CASE WHEN spec.BALTB > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for TB bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.BALTB > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.BALBacteriology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.BALBacteriology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.BALBacteriology > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.BALVirology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.BALVirology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for virology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.BALVirology > 0
		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.BALMycology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.BALMycology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for mycology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.BALMycology > 0

		/****************************************************************
		*	Microbiology Sub-section - Fine Needle Aspirate (FNA)		*
		****************************************************************/		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.FNABacteriology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.FNABacteriology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.FNABacteriology > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.FNAVirology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.FNAVirology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for virology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.FNAVirology > 0
		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.FNAMycology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.FNAMycology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for mycology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.FNAMycology > 0

		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.FungalCultureMycology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.FungalCultureMycology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for mycology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.FungalCultureMycology > 0

		/****************************************************************
		*							HISTOLOGY							*
		****************************************************************/
		/****************************************************************
		*	Histology Sub-section - EBUS Specimen						*
		****************************************************************/
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Histology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyHistology', 
            CONVERT(VARCHAR,spec.EBUSHistology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.EBUSHistology > 1 THEN ' EBUS specimens' ELSE ' EBUS specimen' END + ' for histology from (' + LOWER(@siteTitle) + ') ' + Region			
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.EBUSHistology > 0

		/****************************************************************
		*	Histology Sub-section - Endobronchial Biopsy				*
		****************************************************************/
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Histology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyHistology', 
            CONVERT(VARCHAR,spec.EndobronchialHistology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.EndobronchialHistology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for histology from (' + LOWER(@siteTitle) + ') ' + Region			
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.EndobronchialHistology > 0

		/****************************************************************
		*	Histology Sub-section - Distal Blind Biopsy					*
		****************************************************************/
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Histology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyHistology', 
            CONVERT(VARCHAR,spec.DistalBlindHistology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.DistalBlindHistology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for histology from (' + LOWER(@siteTitle) + ') ' + Region			
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.DistalBlindHistology > 0

		/****************************************************************
		*	Histology Sub-section - Transbronchial Biopsy				*
		****************************************************************/
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Histology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyHistology', 
            CONVERT(VARCHAR,spec.TransbronchialHistology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TransbronchialHistology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for histology from (' + LOWER(@siteTitle) + ') ' + Region			
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TransbronchialHistology > 0

		/****************************************************************
		*	Histology Sub-section - Transtracheal Biopsy				*
		****************************************************************/
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Histology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyHistology', 
            CONVERT(VARCHAR,spec.TranstrachealHistology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TranstrachealHistology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for histology from (' + LOWER(@siteTitle) + ') ' + Region			
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TranstrachealHistology > 0

		/****************************************************************
		*	Histology Sub-section - Fine Needle Aspirate (FNA)			*
		****************************************************************/
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Histology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyHistology', 
            CONVERT(VARCHAR,spec.FNAHistology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.FNAHistology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for histology from (' + LOWER(@siteTitle) + ') ' + Region			
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.FNAHistology > 0

		/****************************************************************
		*	Histology Sub-section - Cryobiopsy							*
		****************************************************************/		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Histology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyHistology', 
            CONVERT(VARCHAR,spec.CryoHistology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.CryoHistology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for histology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.CryoHistology > 0

		/****************************************************************
		*							CYTOLOGY							*
		****************************************************************/
		/****************************************************************
		*	Cytology Sub-section - EBUS Specimen						*
		****************************************************************/
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Cytology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyCytology', 
            CONVERT(VARCHAR,spec.EBUSCytology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.EBUSCytology > 1 THEN ' EBUS specimens' ELSE ' EBUS specimen' END + ' for cytology from (' + LOWER(@siteTitle) + ') ' + Region			
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.EBUSCytology > 0

		/****************************************************************
		*	Cytology Sub-section - Brush Biopsy							*
		****************************************************************/
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Cytology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyCytology', 
            CONVERT(VARCHAR,spec.BrushCytology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.BrushCytology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for cytology from (' + LOWER(@siteTitle) + ') ' + Region			
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.BrushCytology > 0

		/****************************************************************
		*	Cytology Sub-section - Trap									*
		****************************************************************/
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Cytology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyCytology', 
            CONVERT(VARCHAR,spec.TrapCytology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TrapCytology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for cytology from (' + LOWER(@siteTitle) + ') ' + Region			
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TrapCytology > 0

		/****************************************************************
		*	Cytology Sub-section - Bronchoalveolar Lavage (BAL)			*
		****************************************************************/
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Cytology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyCytology', 
            CONVERT(VARCHAR,spec.BALCytology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.BALCytology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for cytology from (' + LOWER(@siteTitle) + ') ' + Region			
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.BALCytology > 0

		/****************************************************************
		*	Cytology Sub-section - Fine Needle Aspirate (FNA)			*
		****************************************************************/
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Cytology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyCytology', 
            CONVERT(VARCHAR,spec.FNACytology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.FNACytology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for cytology from (' + LOWER(@siteTitle) + ') ' + Region			
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.FNACytology > 0
	   
       FETCH NEXT FROM Site_Cursor INTO @siteId, @siteNo
END
CLOSE Site_Cursor;
DEALLOCATE Site_Cursor;

IF OBJECT_ID('tempdb..#specimens') IS NOT NULL DROP TABLE #specimens 
IF OBJECT_ID('tempdb..#specimensBRT') IS NOT NULL DROP TABLE #specimensBRT
SELECT * FROM @SpecimensSummary
GO



------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Steve 03/07/23
-- TFS#	1591
-- Description of change
-- Ability to edit create procedure page after the fact
--  Add get_SelectedStaffForProcedure to enable adding selected staff to a dropdown if they wouldn't normally show (supressed, not available for hospital etc.)
--  Add GetProcedureDetails stored Procedure, this was previously a string within the application code and added additional columns.
--  
------------------------------------------------------------------------------------------------------------------------
GO
PRINT N'Begining Updates for TFS# 1591';

GO
PRINT N'  Altering [dbo].[get_SelectedStaffForProcedureId]...';

GO

EXEC dbo.DropIfExist @ObjectName = 'get_SelectedStaffForProcedureId',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
					 
GO

/****** Object:  StoredProcedure [dbo].[get_SelectedStaffForProcedureId]    Script Date: 10/07/2023 09:41:59 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[get_SelectedStaffForProcedureId]
(
	@ConsultantType AS VARCHAR(20),
	@ProcedureID as integer
)
AS
-- =============================================
-- Author:		Mahfuz
-- Create date: 22 Mar 2022
-- Get the used Staffs in a Procedure to add in combo box if it is filtered out by Hospital
-- =============================================

BEGIN
	SET NOCOUNT ON;
	
	Declare @Consultant VARCHAR(20) = LOWER(@ConsultantType);
    WITH AllConsultants AS(	-- This CTE will make the primary list - with Operators Only- Consultants and Nurses! On the later SELECT atatement- you can do further filer on Consulant OR Nurse!
	select -- ERS Consultants!
		  distinct U.UserId
		, LTRIM(Surname) + 
				CASE WHEN ISNULL(LTRIM(Forename),'') = '' THEN '' 
						ELSE ', ' + LTRIM(Forename)	
				END	AS Consultant	
		, U.JobTitleID					AS TitleId
		, IsNull(T.Description, '')		AS Consultant_Title
		, IsListConsultant
		, IsNull(IsEndoscopist1,0)	AS IsEndoscopist1
		, IsNUll(IsEndoscopist2,0)	AS IsEndoscopist2
		, IsAssistantOrTrainee AS IsNurse1

		, IsNull(IsNurse1,0)		AS IsNurse2
		, IsNull(IsNurse2,0)		AS IsNurse3
		, IsNull(IsNurse2,0)		AS IsNurse4
	FROM  dbo.ERS_Users AS U
		 INNER JOIN dbo.ERS_UserOperatingHospitals euoh ON u.UserID = euoh.UserId 
		LEFT JOIN [dbo].[ERS_JobTitles] AS T ON	 U.JobTitleID = T.JobTitleID
		    WHERE ( ISNULL(U.IsListConsultant, 0)	= 1 OR
					ISNULL(U.IsEndoscopist1, 0)		= 1 OR
					ISNULL(U.IsEndoscopist2, 0)		= 1 OR
					ISNULL(U.IsAssistantOrTrainee, 0)=1 OR
					ISNULL(U.IsNurse1, 0)			= 1 OR
					ISNULL(U.IsNurse2, 0)			= 1 
					)
	)

	Select * 
	from AllConsultants AS Con
	Where 1=1
		AND 
			(
			(@Consultant='all'						AND (1=1)) 	-- Select All Endoscopist/Nurses
				OR
			((@Consultant LIKE '%list%')			AND ( Con.IsListConsultant = 1) and UserId in (Select ListConsultant from ERS_Procedures Where ProcedureId = @ProcedureID))
				OR 
			((@Consultant LIKE '%endoscopist1%')	AND ( Con.IsEndoscopist1 = 1) and UserId in (Select Endoscopist1 from ERS_Procedures Where ProcedureId = @ProcedureID))
				OR 
			((@Consultant LIKE '%endoscopist2%')	AND ( Con.IsEndoscopist2 = 1) and UserId in (Select Endoscopist2 from ERS_Procedures Where ProcedureId = @ProcedureID))
				OR
			((@Consultant LIKE '%nurse1%')		AND ( Con.IsNurse1 = 1) and UserId in (Select Nurse1 from ERS_Procedures Where ProcedureId = @ProcedureID))
				OR 
			((@Consultant LIKE '%nurse2%')			AND ( Con.IsNurse2 = 1) and UserId in (Select Nurse2 from ERS_Procedures Where ProcedureId = @ProcedureID))
				OR 			  
			((@Consultant LIKE '%nurse3')			AND ( Con.IsNurse3 = 1) and UserId in (Select Nurse3 from ERS_Procedures Where ProcedureId = @ProcedureID))
				OR 			  
			((@Consultant LIKE '%nurse4')			AND ( Con.IsNurse4 = 1) and UserId in (Select Nurse4 from ERS_Procedures Where ProcedureId = @ProcedureID))
			)

	ORDER BY Consultant
	END
GO

PRINT N'  Altering [dbo].[GetProcedureDetails]...';

GO

EXEC dbo.DropIfExist @ObjectName = 'GetProcedureDetails',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
					 
GO
/****** Object:  StoredProcedure [dbo].[GetProcedureDetails]    Script Date: 05/07/2023 13:36:15 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[GetProcedureDetails]
(
	@ProcedureID		AS INT

)
AS
BEGIN
	SELECT
		P.ImagePortId,
		P.ProviderTypeId,
		P.ProviderOther,
		P.ReferrerType,
		P.ReferrerTypeOther,
		P.ReferralHospitalNo,
		P.ReferralConsultantNo,
		P.ReferralConsultantSpeciality,
		P.PatientStatus,
		P.Ward,
		P.PatientType,
		P.CategoryListId,
		P.ListType, 
		p.[ListConsultant], 
		(SELECT ISNULL(u.Title, '') + ISNULL(' ' + u.Forename, '') + ' ' + u.Surname AS UserFullName FROM ERS_Users u WHERE u.UserID = p.[ListConsultant]) AS ListConsultantName,
		(SELECT ISNULL(u.GMCCode, '') FROM ERS_Users u WHERE u.UserID = p.[ListConsultant]) AS ListConsultantGMCCode,
		p.[Endoscopist1], p.Endo1Role,
		(SELECT ISNULL(u.Title, '') + ISNULL(' ' + u.Forename, '') + ' ' + u.Surname AS UserFullName FROM ERS_Users u WHERE u.UserID = p.[Endoscopist1]) AS Endoscopist1Name,
		(SELECT ISNULL(u.GMCCode, '') FROM ERS_Users u WHERE u.UserID = p.[Endoscopist1]) AS Endoscopist1GMCCode,
		p.[Endoscopist2], 
		p.Endo2Role,
		(SELECT ISNULL(u.Title, '') + ISNULL(' ' + u.Forename, '') + ' ' + u.Surname AS UserFullName FROM ERS_Users u WHERE u.UserID = p.[Endoscopist2]) AS Endoscopist2Name,
		(SELECT ISNULL(u.GMCCode, '') FROM ERS_Users u WHERE u.UserID = p.[Endoscopist2]) AS Endoscopist2GMCCode,
		ISNULL(p.[Nurse1],0) AS Nurse1,(SELECT ISNULL(u.Title, '') + ISNULL(' ' + u.Forename, '') + ' ' + u.Surname AS UserFullName FROM ERS_Users u WHERE u.UserID = p.[Nurse1]) AS Nurse1Name,
		ISNULL(p.[Nurse2],0) AS Nurse2 ,(SELECT ISNULL(u.Title, '') + ISNULL(' ' + u.Forename, '') + ' ' + u.Surname AS UserFullName FROM ERS_Users u WHERE u.UserID = p.[Nurse2]) AS Nurse2Name,
		ISNULL(p.[Nurse3],0) AS Nurse3 ,(SELECT ISNULL(u.Title, '') + ISNULL(' ' + u.Forename, '') + ' ' + u.Surname AS UserFullName FROM ERS_Users u WHERE u.UserID = p.[Nurse3]) AS Nurse3Name ,
		ISNULL(p.[Nurse4],0) AS Nurse4 ,(SELECT ISNULL(u.Title, '') + ISNULL(' ' + u.Forename, '') + ' ' + u.Surname AS UserFullName FROM ERS_Users u WHERE u.UserID = p.[Nurse4]) AS Nurse4Name 
	FROM 
		ERS_Procedures p 
	WHERE
		p.ProcedureId = @ProcedureId
END

GO

PRINT N'  Altering [dbo].[usp_UpdateProcedureStaff]...';

GO

EXEC dbo.DropIfExist @ObjectName = 'usp_UpdateProcedureStaff',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
					 
GO

/****** Object:  StoredProcedure [dbo].[usp_UpdateProcedureStaff]    Script Date: 11/01/2024 10:57:57 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[usp_UpdateProcedureStaff]
(
	@ProcedureID					AS INT,
	@ListType						AS INT,
	@ListConsultant					AS VARCHAR(24),
	@Endoscopist1					AS VARCHAR(24),
	@Endoscopist1Role				AS INT, 
	@Endoscopist2					AS VARCHAR(24),
	@Endoscopist2Role				AS INT,
	@Nurse1							AS VARCHAR(24),
	@Nurse2							AS VARCHAR(24),
	@Nurse3							AS VARCHAR(24),
	@Nurse4							AS VARCHAR(24),
	@OperatingHospitalId			AS INT,
	@LoggedInUserId					AS INT,
	@ImagePortId					AS INT,
	@ProviderTypeId					AS INT,
	@OtherProviderText				AS VARCHAR(24),
	@ReferrerType					AS INT,
	@OtherReferrerText				AS VARCHAR(24),
	@ReferralHospitalNo				AS INT,
	@ReferralConsultantNo			AS INT,
	@ReferralConsultantSpeciality	AS INT,
	@PatientStatus					AS INT,
	@Ward							AS INT,
	@PatientType					AS INT,
	@CategoryListId					AS INT

)
AS
BEGIN TRANSACTION
BEGIN TRY
	DECLARE @ppEndos VARCHAR(2000), @GPName varchar(255), @GPAddress varchar(max), @Endo1 varchar(500), @Endo2 varchar(500), @RefCons varchar(50), @RefHosp varchar(50)

	UPDATE ERS_Procedures 
		SET 
			  ListType						= @ListType
			, ListConsultant				= @ListConsultant
			, Endoscopist1					= @Endoscopist1
			, Endo1Role						= @Endoscopist1Role
			, Endoscopist2					= @Endoscopist2
			, Endo2Role						= @Endoscopist2Role
			, Nurse1						= @Nurse1
			, Nurse2						= @Nurse2
			, Nurse3						= @Nurse3 
			, Nurse4						= @Nurse4 
			, WhoUpdatedId					= @LoggedInUserId
			, WhenUpdated					= GETDATE()
			, ImagePortId					= @ImagePortId
			, ProviderTypeId				= @ProviderTypeId
			, ProviderOther					= @OtherProviderText
			, ReferrerType					= @ReferrerType
			, ReferrerTypeOther				= @OtherReferrerText
			, ReferralHospitalNo			= @ReferralHospitalNo
			, ReferralConsultantNo			= @ReferralConsultantNo
			, ReferralConsultantSpeciality	= @ReferralConsultantSpeciality
			, PatientStatus					= @PatientStatus
			, Ward							= @Ward
			, PatientType					= @PatientType
			, CategoryListId				= @CategoryListId
	WHERE ProcedureId = @ProcedureId;

	SET @ppEndos = ''
       IF @ListConsultant > 0 SELECT @ppEndos = @ppEndos + '$$List Consultant: ' + Title + ' ' + Forename + ' ' + Surname FROM tvfUsersByOperatingHospital(@OperatingHospitalId) WHERE UserID = @ListConsultant
       IF @Endoscopist1 > 0 
       BEGIN
			SELECT @Endo1 = Title + ' ' + Forename + ' ' + Surname FROM tvfUsersByOperatingHospital(@OperatingHospitalId) WHERE UserID = @Endoscopist1
			SELECT @ppEndos = @ppEndos + '$$Endoscopist No1: ' + @Endo1
			SELECT  @Endo1 = Title + ' ' + Forename + ' ' + Surname + 
					CASE WHEN isnull(Qualifications, '') != '' THEN ', ' + Qualifications else '' END + 
					CASE WHEN isnull(u.JobTitleID, 0) > 0 THEN CHAR(13)+CHAR(10) + jt.Description ELSE '' END  
			FROM ERS_Users u
			LEFT JOIN ERS_JobTitles jt on u.JobTitleID = jt.JobTitleID 
			WHERE UserID = @Endoscopist1
	   END
	   IF @Endoscopist2 > 0 
		BEGIN
			SELECT @Endo2 = Title + ' ' + Forename + ' ' + Surname FROM tvfUsersByOperatingHospital(@OperatingHospitalId) WHERE UserID = @Endoscopist2
			SELECT @ppEndos = @ppEndos + '$$Endoscopist No2: ' + @Endo2
			SELECT  @Endo2 = Title + ' ' + Forename + ' ' + Surname + 
					CASE WHEN isnull(Qualifications, '') != '' THEN ', ' + Qualifications else '' END + 
					CASE WHEN isnull(u.JobTitleID, 0) > 0 THEN CHAR(13)+CHAR(10) + jt.Description ELSE '' END  
			FROM ERS_Users u
			LEFT JOIN ERS_JobTitles jt on u.JobTitleID = jt.JobTitleID 		
			WHERE UserID = @Endoscopist2
		END
       IF @Nurse1 > 0 OR @Nurse2 > 0 OR @Nurse3 > 0 OR @Nurse4 > 0  
       BEGIN
              SELECT @ppEndos = @ppEndos + '$$' + 'Nurses: '
              IF @Nurse1 > 0 SELECT @ppEndos = @ppEndos + '##' + Title + ' ' + Forename + ' ' + Surname FROM tvfUsersByOperatingHospital(@OperatingHospitalId) WHERE UserID = @Nurse1
              IF @Nurse2 > 0 SELECT @ppEndos = @ppEndos + '##' + Title + ' ' + Forename + ' ' + Surname FROM tvfUsersByOperatingHospital(@OperatingHospitalId) WHERE UserID = @Nurse2
              IF @Nurse3 > 0 SELECT @ppEndos =  @ppEndos + '##' + Title + ' ' + Forename + ' ' + Surname FROM tvfUsersByOperatingHospital(@OperatingHospitalId) WHERE UserID = @Nurse3
              IF @Nurse4 > 0 SELECT @ppEndos =  @ppEndos + '##' + Title + ' ' + Forename + ' ' + Surname FROM tvfUsersByOperatingHospital(@OperatingHospitalId) WHERE UserID = @Nurse4
       END
       IF CHARINDEX('$$', @ppEndos) > 0 SET @ppEndos = REPLACE(STUFF(@ppEndos, charindex('$$', @ppEndos), 2, ''), '$$', '<br/>')
       IF CHARINDEX('##', @ppEndos) > 0 SET @ppEndos = REPLACE(STUFF(@ppEndos, charindex('##', @ppEndos), 2, ''), '##', '<br/>')
       
       SELECT @GPName = ISNULL(p.GPName,''), @GPAddress = ISNULL(p.GPAddress,'')
	   FROM ERS_VW_PatientswithGP p 
			LEFT JOIN  ERS_Procedures pr ON p.PatientId= pr.PatientId 
	   WHERE pr.ProcedureId = @ProcedureId;

	   SET @RefCons=''
		IF @ReferrerType = 1
		BEGIN
			SET @RefCons = 'GP'
		END
		ELSE IF @ReferrerType = 5
		BEGIN
			SET @RefCons = @OtherReferrerText
		END
		ELSE
		BEGIN
			SELECT @RefCons = ec.CompleteName FROM dbo.ERS_Consultant ec WHERE ec.ConsultantID = @ReferralConsultantNo
		END

		SET @RefHosp = ''
		SELECT @RefHosp = rh.HospitalName FROM dbo.ERS_ReferralHospitals rh WHERE rh.HospitalID = @ReferralHospitalNo

       UPDATE ERS_ProceduresReporting SET PP_Endos = @ppEndos, PP_Endo1 = @Endo1, PP_Endo2 = @Endo2, PP_GPName = @GPName, PP_GPAddress = @GPAddress, PP_RefCons = @RefCons, PP_RefHosp = @RefHosp WHERE ProcedureId = @ProcedureId;

END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;

GO
PRINT N'Finished Updates for TFS# 1591';

GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	1591
------------------------------------------------------------------------------------------------------------------------


Go
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Mahfuz	On 16 Jan 2024
-- TFS#	2612
-- Description of change
-- Patient Notes Available Option
------------------------------------------------------------------------------------------------------------------------
Go
--Check if column exists in a table
IF NOT EXISTS(SELECT * FROM sys.columns WHERE Name = N'IsPatientNotesAvailableMandatory' AND Object_ID = Object_ID(N'ERS_SystemConfig'))
ALTER TABLE [dbo].[ERS_SystemConfig]
   ADD [IsPatientNotesAvailableMandatory] bit NULL;

GO

--Check if column exists in a table
IF NOT EXISTS(SELECT * FROM sys.columns WHERE Name = N'IsPatientNotesAvailableMandatory' AND Object_ID = Object_ID(N'ERSAudit.ERS_SystemConfig_Audit'))
ALTER TABLE [ERSAudit].[ERS_SystemConfig_Audit]
    ADD [IsPatientNotesAvailableMandatory] bit NULL;
	
GO

--If Image Gender Type is made required on the procedure creation page, make it not-required
Update ERS_FieldLabels set Required = 0 where LabelId = 'ImageGenderID' and PageId = 5 and Required = 1
Go

EXEC DropIfExist 'GetSystemSettings','S';
GO
CREATE PROCEDURE [dbo].[GetSystemSettings]
    @operatingHospitalId AS INT
AS
/*
	Update History			:		
	10 Aug 2022				:		MH added two extra columns , IsPrintReportPopupActive, PrintReportPopupMessage
	14 Jan 2024				:		MH added new column IsPatientNotesAvailableMandatory
*/
BEGIN

	SELECT TOP(1) 
		OperatingHospitalID, 
		ApplicationTimeOut, 
		SiteIdentification, 
		SiteRadius, 
		ISNULL(OGDDiagnosis, 0) AS OGDDiagnosis, 
		ISNULL(UreaseTestsIncludeTickBoxes, 0) AS UreaseTestsIncludeTickBoxes,
		ISNULL(OesophagitisClassification, 0) AS OesophagitisClassification, BostonBowelPrepScale,
		ISNULL(PatientConsent, 0) AS PatientConsent,
		ISNULL(IsEvidenceOfCancerMandatory, 0) AS IsEvidenceOfCancerMandatory, 
		ISNULL(EvidenceOfCancerMandatoryFlagIgnoreBeforeDate, CONVERT(DATE, TRY_PARSE('31/12/2099' AS DATE USING 'en-gb'), 131)) AS CancerMandIgnoreBeforeDate,
		ISNULL(SortReferringConsultantBy, 0) AS SortReferringConsultantBy, 
		ISNULL(CompleteWHOSurgicalSafetyCheckList, 0) AS CompleteWHOSurgicalSafetyCheckList, 
		ISNULL(ReportLocking,1) AS ReportLocking , 
		ISNULL(LockingTime, '01:00') AS LockingTime, 
		ISNULL(LockingDays,1) AS LockingDays, 
		ISNULL(AuditLogEnabled, 0) AS AuditLogEnabled, 
		ISNULL(ErrorLogEnabled, 0) AS ErrorLogEnabled, 
		ISNULL(ImGrabEnabled, 0) AS ImGrabEnabled,
		ISNULL(NEDEnabled, 0) AS NEDEnabled, 
		ISNULL(NED_ExportPath, 0) AS NEDExportPath, 
		ISNULL(DefaultPatientStatus, 0) AS DefaultPatientStatus, 
		ISNULL(DefaultPatientType, 0) AS DefaultPatientType, 
		ISNULL(DefaultWard, 0) AS DefaultWard, 
		ISNULL(NED_HospitalSiteCode, '') AS NED_HospitalSiteCode, 
		ISNULL(NED_OrganisationCode, '') AS NED_OrganisationCode, 
		ISNULL(NED_APIKey, '') AS NED_APIKey,
		BRTPulmonaryPhysiology, 
		ISNULL(MaxWorklistDays, 2) AS MaxWorklistDays, 
		ISNULL(MinimumPatientSearchOption, 1) AS MinimumPatientSearchOption,
		ISNULL(EvidenceOfCancerMandatoryFlagIgnoreBeforeDate, GETDATE()) AS CancerManFlagIgnoreBeforeRadDatePicker,
		IsNull(IsPrintReportPopupActive,0) as IsPrintReportPopupActive,
		IsNull(PrintReportPopupMessage,'') as PrintReportPopupMessage,
		IsNull(PathwayPlanMaxQuestions, 10) as PathwayPlanMaxQuestions,
		IsNull(IsPatientNotesAvailableMandatory,0) as IsPatientNotesAvailableMandatory
	FROM 
		dbo.ERS_SystemConfig
	WHERE 
		OperatingHospitalID = @operatingHospitalId
	ORDER BY 
		OperatingHospitalID

END
Go
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	2612 by Mahfuz
------------------------------------------------------------------------------------------------------------------------
Go

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea
-- TFS#	
-- Description of change
-- Scheduler fix for overrun lists
------------------------------------------------------------------------------------------------------------------------
GO


ALTER PROCEDURE [dbo].[sch_get_day_diary]
(
	@OperatingHospitalID INT,
	@DiaryDate DATETIME,
	@RoomIds VARCHAR(MAX)
)
AS

	IF OBJECT_ID ('tempdb..#tmpDiaryRooms') IS NOT NULL
		DROP TABLE #tmpDiaryRooms

	SELECT Item
	INTO #tmpDiaryRooms
	FROM dbo.fnSplitString(@RoomIds, ',')

	SELECT DISTINCT
		d.DiaryId,
		d.DiaryStart,
		CASE WHEN (SELECT MAX(DATEADD(MINUTE, CONVERT(int, ersa.AppointmentDuration), StartDateTime)) FROM ERS_Appointments ersa WHERE ersa.DiaryId = d.DiaryId) > d.DiaryEnd THEN (SELECT MAX(DATEADD(MINUTE, CONVERT(int, ersa.AppointmentDuration), StartDateTime)) FROM ERS_Appointments ersa WHERE ersa.DiaryId = d.DiaryId) ELSE d.DiaryEnd END AS DiaryEnd,
		d.[DiaryEnd] ActualDiaryEnd,
		d.[UserID], 
		d.[RoomID], 
		d.ListRulesId, 
		s.SlotMinutes AS [Minutes],
		CASE WHEN ept.ProcedureType IS NULL THEN ss.Description 
		ELSE 'Reserved for ' + ss.Description + ' '+ ept.ProcedureType END AS [Subject],
		ss.Description,
		ISNULL(s.ProcedureTypeID,0) AS ProcedureTypeID,
		s.ListSlotId,
		ss.ForeColor,
		ss.StatusId,
		ISNULL(s.Points, 1) AS Points,
		ISNULL(l.Endoscopist,0) AS EndoscopistId,
		(CASE WHEN  ISNULL(u.Title,'') <> '' THEN u.Title + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(u.Forename,'') <> '' THEN u.Forename + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(u.Surname,'') <> '' THEN u.Surname + ' ' ELSE '' END) as EndoscopistName,
	  (CASE WHEN  ISNULL(c.Title,'') <> '' THEN c.Title + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(c.Forename,'') <> '' THEN c.Forename + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(c.Surname,'') <> '' THEN c.Surname + ' ' ELSE '' END) as ListConsultant,
		l.ListName,
		(CASE WHEN  ISNULL(u.Title,'') <> '' THEN u.Title + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(u.Forename,'') <> '' THEN u.Forename + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(u.Surname,'') <> '' THEN u.Surname + ' ' ELSE '' END) +
	  '  [' + CONVERT(VARCHAR(5),cast(d.DiaryStart as time)) + '-' + CONVERT(VARCHAR(5),cast(d.[DiaryEnd] as time)) + ']' +
	  CASE WHEN  ISNULL(l.Points,0) <> 0 THEN '  [' + CONVERT(VARCHAR, l.Points) + ' slots]' ELSE '' END  AS ListDescription
		,d.suppressed
		,d.SuppressedFromDate
		,d.Training
		,l.GIProcedure
		,ISNULL(apt.AppointmentId, 0) AppointmentId
		,apt.StartDateTime AppointmentStart
		,ISNULL(apt.TotalPoints,0) AppointmentPoints
		,ISNULL(apt.AppointmentDuration,0) AppointmentDuration
		,DATEADD(minute, convert(int, apt.AppointmentDuration), apt.StartDateTime) AppointmentEnd
		,ISNULL(apt.StatusCode,'') AppointmentStatusCode
		,ISNULL(apt.Notes,'') AppointmentNotes
		,p.HospitalNumber + ' - ' + p.Forename1 + ' ' + p.Surname + '<br />' + apt.Description + ' '+ STUFF(REPLACE(apt.Procs, CHAR(10), '+'), LEN(apt.procs),1,'') AS [AppointmentSubject]
		,ISNULL(apt.GeneralInformation, '') GeneralInformation
		,s.Locked
		,d.OperatingHospitalId
		,ISNULL(d.RecurrenceParentID,0)RecurrenceParentID
		,ISNULL(d.locked,0) LockedDiary
		,r.RoomName
	FROM ERS_SCH_DiaryPages d
		INNER JOIN #tmpDiaryRooms tr ON tr.Item = d.RoomID
		INNER JOIN dbo.ERS_SCH_Rooms r ON r.RoomId = tr.Item
		INNER JOIN ERS_SCH_ListRules l ON l.ListRulesId = d.ListRulesId
		INNER JOIN ERS_SCH_ListSlots s ON d.ListRulesId = s.ListRulesId AND s.Active = 1
		INNER JOIN dbo.ERS_SCH_SlotStatus ss ON ss.StatusId = s.SlotId
		LEFT JOIN dbo.ERS_ProcedureTypes ept ON s.ProceduretypeId = ept.ProcedureTypeId
		LEFT JOIN ERS_Users u ON u.UserID = d.UserId
		LEFT JOIN ERS_Users c ON c.UserID = d.ListConsultantId
		--LEFT JOIN ERS_Appointments a ON a.DiaryId = d.DiaryId and a.ListSlotId = s.ListSlotId AND ISNULL(a.AppointmentStatusId,0) <> dbo.fnSCHAppointmentStatusId('C')
		--LEFT JOIN (SELECT apt.AppointmentID, sum(Points) TotalPoints, sum(Minutes) TotalMinutes FROM ERS_AppointmentProcedureTypes apt GROUP BY AppointmentId) apt on apt.AppointmentID = a.AppointmentId
		LEFT JOIN (SELECT ea.AppointmentId, SUM(eapt.Points) AS TotalPoints, SUM(eapt.Minutes) AS TotalMinutes, ea.ListSlotId, ea.DiaryId, MAX(aps.HDCKEY) StatusCode, ass.Description, ea.PatientId,ea.GeneralInformation, ea.Notes, ea.AppointmentDuration,ea.StartDateTime,
						(SELECT
							AppointmentProcedures + char(10) AS [text()] 
						FROM dbo.SCH_AppointmentProcedures(ea.AppointmentId)
						WHERE AppointmentId = ea.AppointmentId
						FOR XML PATH('')) AS procs
					FROM dbo.ERS_Appointments ea
						INNER JOIN dbo.ERS_AppointmentProcedureTypes eapt ON ea.AppointmentId = eapt.AppointmentID
						INNER JOIN dbo.ERS_SCH_SlotStatus ass ON ea.SlotStatusID = ass.StatusId
						LEFT JOIN ERS_AppointmentStatus aps on aps.UniqueId = ea.AppointmentStatusId
					 WHERE ISNULL(aps.HDCKEY,'') <> 'C'
					GROUP BY ea.AppointmentId, ea.ListSlotId, ea.DiaryId, ass.Description, ea.PatientId,ea.GeneralInformation, ea.Notes, ea.AppointmentDuration,ea.StartDateTime) AS apt 
											ON apt.DiaryId = d.DiaryId and  apt.ListSlotId = s.ListSlotId
		LEFT JOIN ERS_Patients p ON p.patientId = apt.PatientId
	WHERE d.OperatingHospitalId = @OperatingHospitalID AND convert(varchar(10), DiaryStart, 103) = convert(varchar(10), @DiaryDate, 103)
	ORDER BY d.DiaryId, apt.StartDateTime, s.ListSlotId

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO



------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea Johnson 02.10.23
-- TFS#	3450
-- Description of change
-- NED 2.1 Indications amendments
------------------------------------------------------------------------------------------------------------------------
GO


DECLARE @IndicationsId INT , @ProcedureTypeIds VARCHAR(2000), @IndicationsSectionId INT
PRINT 'Inserting Angioectasia.....'
SELECT @IndicationsId = UniqueId FROM dbo.ERS_Indications WHERE NEDTerm = 'Angioectasia'
SELECT @IndicationsSectionId = IndicationSectionId FROM dbo.ERS_IndicationSections WHERE SectionName = 'Referral Symptoms' --Referral Symptoms | Planned Procedure | Imaging
IF ISNULL(@IndicationsId,0) = 0
BEGIN
	INSERT INTO ERS_Indications (Description, NEDTerm, SubIndicationParent, AdditionalInfo, IndicationSectionId)
	VALUES ('Angioectasia', 'Angioectasia', 0, 0, @IndicationsSectionId)

	SELECT @IndicationsId = SCOPE_IDENTITY()
END
--Indication ProcedureTypes
IF NOT EXISTS (SELECT 1 FROM dbo.ERS_IndicationsProcedureTypes WHERE IndicationId = @IndicationsId)
BEGIN
	DELETE FROM dbo.ERS_IndicationsProcedureTypes WHERE IndicationId = @IndicationsId


SET @ProcedureTypeIds = '1,2,3,4,5,6,7,8,9'
INSERT INTO dbo.ERS_IndicationsProcedureTypes
(
    IndicationId,
    ProcedureTypeId
)
SELECT @IndicationsId, CONVERT(INT, Item) FROM dbo.fnSplitString(@ProcedureTypeIds, ',')
END
GO

DECLARE @IndicationsId INT , @ProcedureTypeIds VARCHAR(2000), @IndicationsSectionId INT
PRINT 'Inserting Capsule placement.....'
SELECT @IndicationsId = UniqueId FROM dbo.ERS_Indications WHERE NEDTerm = 'Capsule placement'
SELECT @IndicationsSectionId = IndicationSectionId FROM dbo.ERS_IndicationSections WHERE SectionName = 'Planned procedures' --Referral Symptoms | Planned procedures | Imaging
IF ISNULL(@IndicationsId,0) = 0
BEGIN
	INSERT INTO ERS_Indications (Description, NEDTerm, SubIndicationParent, AdditionalInfo, IndicationSectionId)
	VALUES ('Capsule placement', 'Capsule placement', 0, 0, @IndicationsSectionId)

	SELECT @IndicationsId = SCOPE_IDENTITY()
END
--Indication ProcedureTypes
IF NOT EXISTS (SELECT 1 FROM dbo.ERS_IndicationsProcedureTypes WHERE IndicationId = @IndicationsId)
BEGIN

	SET @ProcedureTypeIds = '1,2,3,4,5,6,7,8,9'
	INSERT INTO dbo.ERS_IndicationsProcedureTypes
	(
		IndicationId,
		ProcedureTypeId
	)
	SELECT @IndicationsId, CONVERT(INT, Item) FROM dbo.fnSplitString(@ProcedureTypeIds, ',')
END
GO

DECLARE @IndicationsId INT , @ProcedureTypeIds VARCHAR(2000), @IndicationsSectionId INT

PRINT 'Inserting Polyp Assessment.....'
SELECT @IndicationsId = UniqueId FROM dbo.ERS_Indications WHERE NEDTerm = 'Polyp Assessment'
SELECT @IndicationsSectionId = IndicationSectionId FROM dbo.ERS_IndicationSections WHERE SectionName = 'Planned procedures' --Referral Symptoms | Planned procedures | Imaging
IF ISNULL(@IndicationsId,0) = 0
BEGIN
	INSERT INTO ERS_Indications (Description, NEDTerm, SubIndicationParent, AdditionalInfo, IndicationSectionId)
	VALUES ('Polyp Assessment', 'Polyp Assessment', 0, 0, @IndicationsSectionId)

	SELECT @IndicationsId = SCOPE_IDENTITY()
END
--Indication ProcedureTypes
IF NOT EXISTS (SELECT 1 FROM dbo.ERS_IndicationsProcedureTypes WHERE IndicationId = @IndicationsId)
BEGIN

	SET @ProcedureTypeIds = '1,2,3,4,5,6,7,8,9'
	INSERT INTO dbo.ERS_IndicationsProcedureTypes
	(
		IndicationId,
		ProcedureTypeId
	)
	SELECT @IndicationsId, CONVERT(INT, Item) FROM dbo.fnSplitString(@ProcedureTypeIds, ',')
END
GO

DECLARE @IndicationsId INT , @ProcedureTypeIds VARCHAR(2000), @IndicationsSectionId INT

PRINT 'Inserting Foreign body.....'
SELECT @IndicationsId = UniqueId FROM dbo.ERS_Indications WHERE NEDTerm = 'Foreign body'
SELECT @IndicationsSectionId = IndicationSectionId FROM dbo.ERS_IndicationSections WHERE SectionName = 'Referral Symptoms' --Referral Symptoms | Planned procedures | Imaging
IF ISNULL(@IndicationsId,0) = 0
BEGIN
	INSERT INTO ERS_Indications (Description, NEDTerm, SubIndicationParent, AdditionalInfo, IndicationSectionId)
	VALUES ('Foreign body', 'Foreign body', 0, 0, @IndicationsSectionId)

	SELECT @IndicationsId = SCOPE_IDENTITY()
END
--Indication ProcedureTypes
IF NOT EXISTS (SELECT 1 FROM dbo.ERS_IndicationsProcedureTypes WHERE IndicationId = @IndicationsId)
BEGIN

	SET @ProcedureTypeIds = '1,2,3,4,5,6,7,8,9'
	INSERT INTO dbo.ERS_IndicationsProcedureTypes
	(
		IndicationId,
		ProcedureTypeId
	)
	SELECT @IndicationsId, CONVERT(INT, Item) FROM dbo.fnSplitString(@ProcedureTypeIds, ',')
END
GO

DECLARE @IndicationsId INT , @ProcedureTypeIds VARCHAR(2000), @IndicationsSectionId INT
PRINT 'Inserting Injection of botulinum toxin.....'
SELECT @IndicationsId = UniqueId FROM dbo.ERS_Indications WHERE NEDTerm = 'Injection of botulinum toxin'
SELECT @IndicationsSectionId = IndicationSectionId FROM dbo.ERS_IndicationSections WHERE SectionName = 'Planned procedures' --Referral Symptoms | Planned procedures | Imaging
IF ISNULL(@IndicationsId,0) = 0
BEGIN
	INSERT INTO ERS_Indications (Description, NEDTerm, SubIndicationParent, AdditionalInfo, IndicationSectionId)
	VALUES ('Injection of botulinum toxin', 'Injection of botulinum toxin', 0, 0, @IndicationsSectionId)

	SELECT @IndicationsId = SCOPE_IDENTITY()
END
--Indication ProcedureTypes
IF NOT EXISTS (SELECT 1 FROM dbo.ERS_IndicationsProcedureTypes WHERE IndicationId = @IndicationsId)
BEGIN

	SET @ProcedureTypeIds = '1,2,3,4,5,6,7,8,9'
	INSERT INTO dbo.ERS_IndicationsProcedureTypes
	(
		IndicationId,
		ProcedureTypeId
	)
	SELECT @IndicationsId, CONVERT(INT, Item) FROM dbo.fnSplitString(@ProcedureTypeIds, ',')

END
GO

DECLARE @IndicationsId INT , @ProcedureTypeIds VARCHAR(2000), @IndicationsSectionId INT

PRINT 'Inserting Oesophagitis surveillance.....'
SELECT @IndicationsId = UniqueId FROM dbo.ERS_Indications WHERE NEDTerm = 'Oesophagitis surveillance'
SELECT @IndicationsSectionId = IndicationSectionId FROM dbo.ERS_IndicationSections WHERE SectionName = 'Planned procedures' --Referral Symptoms | Planned procedures | Imaging
IF ISNULL(@IndicationsId,0) = 0
BEGIN
	INSERT INTO ERS_Indications (Description, NEDTerm, SubIndicationParent, AdditionalInfo, IndicationSectionId)
	VALUES ('Oesophagitis surveillance', 'Oesophagitis surveillance', 0, 0, @IndicationsSectionId)

	SELECT @IndicationsId = SCOPE_IDENTITY()
END
--Indication ProcedureTypes
IF NOT EXISTS (SELECT 1 FROM dbo.ERS_IndicationsProcedureTypes WHERE IndicationId = @IndicationsId)
BEGIN

	SET @ProcedureTypeIds = '1,6'
	INSERT INTO dbo.ERS_IndicationsProcedureTypes
	(
		IndicationId,
		ProcedureTypeId
	)
	SELECT @IndicationsId, CONVERT(INT, Item) FROM dbo.fnSplitString(@ProcedureTypeIds, ',')

	END
GO

DECLARE @IndicationsId INT , @ProcedureTypeIds VARCHAR(2000), @IndicationsSectionId INT

PRINT 'Inserting Nasogastric tube insertion.....'
SELECT @IndicationsId = UniqueId FROM dbo.ERS_Indications WHERE NEDTerm = 'Nasogastric tube insertion'
SELECT @IndicationsSectionId = IndicationSectionId FROM dbo.ERS_IndicationSections WHERE SectionName = 'Planned procedures' --Referral Symptoms | Planned procedures | Imaging
IF ISNULL(@IndicationsId,0) = 0
BEGIN
	INSERT INTO ERS_Indications (Description, NEDTerm, SubIndicationParent, AdditionalInfo, IndicationSectionId)
	VALUES ('Nasogastric tube insertion', 'Nasogastric tube insertion', 0, 0, @IndicationsSectionId)

	SELECT @IndicationsId = SCOPE_IDENTITY()
END
--Indication ProcedureTypes
IF NOT EXISTS (SELECT 1 FROM dbo.ERS_IndicationsProcedureTypes WHERE IndicationId = @IndicationsId)
BEGIN

	SET @ProcedureTypeIds = '1,6'
	INSERT INTO dbo.ERS_IndicationsProcedureTypes
	(
		IndicationId,
		ProcedureTypeId
	)
	SELECT @IndicationsId, CONVERT(INT, Item) FROM dbo.fnSplitString(@ProcedureTypeIds, ',')

END
GO

DECLARE @IndicationsId INT , @ProcedureTypeIds VARCHAR(2000), @IndicationsSectionId INT

PRINT 'Inserting Radio frequency ablation (RFA).....'
SELECT @IndicationsId = UniqueId FROM dbo.ERS_Indications WHERE NEDTerm = 'Radio frequency ablation (RFA)'
SELECT @IndicationsSectionId = IndicationSectionId FROM dbo.ERS_IndicationSections WHERE SectionName = 'Referral Symptoms' --Referral Symptoms | Planned Procedure | Imaging
IF ISNULL(@IndicationsId,0) = 0
BEGIN
	INSERT INTO ERS_Indications (Description, NEDTerm, SubIndicationParent, AdditionalInfo, IndicationSectionId)
	VALUES ('Radio frequency ablation (RFA)', 'Radio frequency ablation (RFA)', 0, 0, @IndicationsSectionId)

	SELECT @IndicationsId = SCOPE_IDENTITY()
END
--Indication ProcedureTypes
IF NOT EXISTS (SELECT 1 FROM dbo.ERS_IndicationsProcedureTypes WHERE IndicationId = @IndicationsId)
BEGIN

	SET @ProcedureTypeIds = '1,2,3,4,5,6,7,8,9'
	INSERT INTO dbo.ERS_IndicationsProcedureTypes
	(
		IndicationId,
		ProcedureTypeId
	)
	SELECT @IndicationsId, CONVERT(INT, Item) FROM dbo.fnSplitString(@ProcedureTypeIds, ',')

END
GO

DECLARE @IndicationsId INT , @ProcedureTypeIds VARCHAR(2000), @IndicationsSectionId INT

PRINT 'Inserting Blood-based multi-cancer screening.....'
SELECT @IndicationsId = UniqueId FROM dbo.ERS_Indications WHERE NEDTerm = 'Blood-based multi-cancer screening'
SELECT @IndicationsSectionId = IndicationSectionId FROM dbo.ERS_IndicationSections WHERE SectionName = 'Referral Symptoms' --Referral Symptoms | Planned Procedure | Imaging
IF ISNULL(@IndicationsId,0) = 0
BEGIN
	INSERT INTO ERS_Indications (Description, NEDTerm, SubIndicationParent, AdditionalInfo, IndicationSectionId)
	VALUES ('Blood-based multi-cancer screening', 'Blood-based multi-cancer screening', 0, 0, @IndicationsSectionId)

	SELECT @IndicationsId = SCOPE_IDENTITY()
END
--Indication ProcedureTypes
IF NOT EXISTS (SELECT 1 FROM dbo.ERS_IndicationsProcedureTypes WHERE IndicationId = @IndicationsId)
BEGIN

	SET @ProcedureTypeIds = '1,2,3,4,5,6,7,8,9'
	INSERT INTO dbo.ERS_IndicationsProcedureTypes
	(
		IndicationId,
		ProcedureTypeId
	)
	SELECT @IndicationsId, CONVERT(INT, Item) FROM dbo.fnSplitString(@ProcedureTypeIds, ',')

END
GO

DECLARE @IndicationsId INT , @ProcedureTypeIds VARCHAR(2000), @IndicationsSectionId INT

PRINT 'Inserting Stricture dilatation.....'
SELECT @IndicationsId = UniqueId FROM dbo.ERS_Indications WHERE NEDTerm = 'Stricture dilatation'
SELECT @IndicationsSectionId = IndicationSectionId FROM dbo.ERS_IndicationSections WHERE SectionName = 'Planned procedures' --Referral Symptoms | Planned Procedure | Imaging
IF ISNULL(@IndicationsId,0) = 0
BEGIN
	INSERT INTO ERS_Indications (Description, NEDTerm, SubIndicationParent, AdditionalInfo, IndicationSectionId)
	VALUES ('Stricture dilatation', 'Stricture dilatation', 0, 0, @IndicationsSectionId)

	SELECT @IndicationsId = SCOPE_IDENTITY()
END
--Indication ProcedureTypes
IF NOT EXISTS (SELECT 1 FROM dbo.ERS_IndicationsProcedureTypes WHERE IndicationId = @IndicationsId)
BEGIN

	SET @ProcedureTypeIds = '1,2,3,4,5,6,7,8,9'
	INSERT INTO dbo.ERS_IndicationsProcedureTypes
	(
		IndicationId,
		ProcedureTypeId
	)
	SELECT @IndicationsId, CONVERT(INT, Item) FROM dbo.fnSplitString(@ProcedureTypeIds, ',')

	END
GO

DECLARE @IndicationsId INT , @ProcedureTypeIds VARCHAR(2000), @IndicationsSectionId INT

PRINT 'Inserting Planned dilatation.....'
SELECT @IndicationsId = UniqueId FROM dbo.ERS_Indications WHERE NEDTerm = 'Planned dilatation'
SELECT @IndicationsSectionId = IndicationSectionId FROM dbo.ERS_IndicationSections WHERE SectionName = 'Planned procedures' --Referral Symptoms | Planned Procedure | Imaging
IF ISNULL(@IndicationsId,0) = 0
BEGIN
	INSERT INTO ERS_Indications (Description, NEDTerm, SubIndicationParent, AdditionalInfo, IndicationSectionId)
	VALUES ('Planned dilatation', 'Planned dilatation', 0, 0, @IndicationsSectionId)

	SELECT @IndicationsId = SCOPE_IDENTITY()
END
--Indication ProcedureTypes
IF NOT EXISTS (SELECT 1 FROM dbo.ERS_IndicationsProcedureTypes WHERE IndicationId = @IndicationsId)
BEGIN

	SET @ProcedureTypeIds = '1,2,3,4,5,6,7,8,9'
	INSERT INTO dbo.ERS_IndicationsProcedureTypes
	(
		IndicationId,
		ProcedureTypeId
	)
	SELECT @IndicationsId, CONVERT(INT, Item) FROM dbo.fnSplitString(@ProcedureTypeIds, ',')

END
GO

UPDATE dbo.ERS_Indications SET WhenCreated = GETDATE() WHERE WhenCreated IS NULL
GO


UPDATE dbo.ERS_Indications SET Description = 'High cancer risk surveillance', NEDTerm = 'High cancer risk surveillance' WHERE NEDTerm = 'High colorectal cancer risk surveillance'
GO


------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea Johnson 02.10.23
-- TFS#	3454
-- Description of change
-- Therapeutics
------------------------------------------------------------------------------------------------------------------------
GO


IF NOT EXISTS (SELECT 1 FROM dbo.ERS_TherapeuticTypes WHERE LOWER(Description) = 'endoclot')
BEGIN
     INSERT INTO dbo.ERS_TherapeuticTypes
     (
         Description,
         NedName,
         OGD,
         ERCP,
         Colon,
         Flexi,
         SchedulerTherapeutic,
         Proct,
         EUS,
         EUS_HPB,
         Antegrade,
         RecordId,
         NEDRequired,
         Retrograde,
         Bronchs,
         Cysto,
         Bronch_Flexi,
         Bronch_Rigid
     )
     VALUES
     (   'EndoClot',      -- Description - varchar(128)
         'EndoClot spray',      -- NedName - varchar(128)
         1,    -- OGD - bit
         1,    -- ERCP - bit
         1,    -- Colon - bit
         1,    -- Flexi - bit
         1, -- SchedulerTherapeutic - bit
         0,    -- Proct - bit
         1,    -- EUS - bit
         1,    -- EUS_HPB - bit
         1,    -- Antegrade - bit
         98,    -- RecordId - int
         1, -- NEDRequired - bit
         1, -- Retrograde - bit
         0, -- Bronchs - bit
         0, -- Cysto - bit
         0, -- Bronch_Flexi - bit
         0  -- Bronch_Rigid - bit
         )
END
ELSE
BEGIN
     UPDATE dbo.ERS_TherapeuticTypes 
	 SET NedName = 'EndoClot spray',
		 OGD = 1,
		 ERCP=1,
		 Colon=1,
		 Flexi=1,
		 SchedulerTherapeutic=1,
		 Proct=0,
		 EUS=1,
		 EUS_HPB=1,
		 Antegrade=1,
		 RecordId=98,
		 NEDRequired=1,
		 Retrograde=1,
		 Bronchs=0,
		 Cysto=0,
		 Bronch_Flexi=0,
		 Bronch_Rigid=0
	 WHERE LOWER(Description) = 'endoclot'

END
GO


IF NOT EXISTS (SELECT 1 FROM dbo.ERS_TherapeuticTypes WHERE LOWER(Description) IN ('hemospray', 'haemospray'))
BEGIN
     INSERT INTO dbo.ERS_TherapeuticTypes
     (
         Description,
         NedName,
         OGD,
         ERCP,
         Colon,
         Flexi,
         SchedulerTherapeutic,
         Proct,
         EUS,
         EUS_HPB,
         Antegrade,
         RecordId,
         NEDRequired,
         Retrograde,
         Bronchs,
         Cysto,
         Bronch_Flexi,
         Bronch_Rigid
     )
     VALUES
     (   'Hemospray',      -- Description - varchar(128)
         'Hemospray',      -- NedName - varchar(128)
         1,    -- OGD - bit
         1,    -- ERCP - bit
         1,    -- Colon - bit
         1,    -- Flexi - bit
         1, -- SchedulerTherapeutic - bit
         0,    -- Proct - bit
         1,    -- EUS - bit
         1,    -- EUS_HPB - bit
         1,    -- Antegrade - bit
         99,    -- RecordId - int
         1, -- NEDRequired - bit
         1, -- Retrograde - bit
         0, -- Bronchs - bit
         0, -- Cysto - bit
         0, -- Bronch_Flexi - bit
         0  -- Bronch_Rigid - bit
         )
END
ELSE
BEGIN
     UPDATE dbo.ERS_TherapeuticTypes 
	 SET Description = 'Hemospray',
	     NedName = 'Hemospray',
		 OGD = 1,
		 ERCP=1,
		 Colon=1,
		 Flexi=1,
		 SchedulerTherapeutic=1,
		 Proct=0,
		 EUS=1,
		 EUS_HPB=1,
		 Antegrade=1,
		 RecordId=99,
		 NEDRequired=1,
		 Retrograde=1,
		 Bronchs=0,
		 Cysto=0,
		 Bronch_Flexi=0,
		 Bronch_Rigid=0
	 WHERE LOWER(Description) IN ('hemospray', 'haemospray')

END
GO



IF NOT EXISTS (SELECT 1 FROM dbo.ERS_TherapeuticTypes WHERE LOWER(Description) = 'purastat')
BEGIN
     INSERT INTO dbo.ERS_TherapeuticTypes
     (
         Description,
         NedName,
         OGD,
         ERCP,
         Colon,
         Flexi,
         SchedulerTherapeutic,
         Proct,
         EUS,
         EUS_HPB,
         Antegrade,
         RecordId,
         NEDRequired,
         Retrograde,
         Bronchs,
         Cysto,
         Bronch_Flexi,
         Bronch_Rigid
     )
     VALUES
     (   'Purastat',      -- Description - varchar(128)
         'Purastat',      -- NedName - varchar(128)
         1,    -- OGD - bit
         1,    -- ERCP - bit
         1,    -- Colon - bit
         1,    -- Flexi - bit
         1, -- SchedulerTherapeutic - bit
         0,    -- Proct - bit
         1,    -- EUS - bit
         1,    -- EUS_HPB - bit
         1,    -- Antegrade - bit
         100,    -- RecordId - int
         1, -- NEDRequired - bit
         1, -- Retrograde - bit
         0, -- Bronchs - bit
         0, -- Cysto - bit
         0, -- Bronch_Flexi - bit
         0  -- Bronch_Rigid - bit
         )
END
ELSE
BEGIN
     UPDATE dbo.ERS_TherapeuticTypes 
	 SET NedName = 'Purastat',
		 OGD = 1,
		 ERCP=1,
		 Colon=1,
		 Flexi=1,
		 SchedulerTherapeutic=1,
		 Proct=0,
		 EUS=1,
		 EUS_HPB=1,
		 Antegrade=1,
		 RecordId=100,
		 NEDRequired=1,
		 Retrograde=1,
		 Bronchs=0,
		 Cysto=0,
		 Bronch_Flexi=0,
		 Bronch_Rigid=0
	 WHERE LOWER(Description) = 'purastat'

END
GO



IF NOT EXISTS (SELECT 1 FROM dbo.ERS_TherapeuticTypes WHERE LOWER(Description) = 'diverticulotomy')
BEGIN
     INSERT INTO dbo.ERS_TherapeuticTypes
     (
         Description,
         NedName,
         OGD,
         ERCP,
         Colon,
         Flexi,
         SchedulerTherapeutic,
         Proct,
         EUS,
         EUS_HPB,
         Antegrade,
         RecordId,
         NEDRequired,
         Retrograde,
         Bronchs,
         Cysto,
         Bronch_Flexi,
         Bronch_Rigid
     )
     VALUES
     (   'Diverticulotomy',      -- Description - varchar(128)
         'Diverticulotomy',      -- NedName - varchar(128)
         1,    -- OGD - bit
         1,    -- ERCP - bit
         1,    -- Colon - bit
         1,    -- Flexi - bit
         1, -- SchedulerTherapeutic - bit
         0,    -- Proct - bit
         1,    -- EUS - bit
         1,    -- EUS_HPB - bit
         1,    -- Antegrade - bit
         101,    -- RecordId - int
         1, -- NEDRequired - bit
         1, -- Retrograde - bit
         0, -- Bronchs - bit
         0, -- Cysto - bit
         0, -- Bronch_Flexi - bit
         0  -- Bronch_Rigid - bit
         )
END
ELSE
BEGIN
     UPDATE dbo.ERS_TherapeuticTypes 
	 SET NedName = 'Diverticulotomy',
		 OGD = 1,
		 ERCP=1,
		 Colon=1,
		 Flexi=1,
		 SchedulerTherapeutic=1,
		 Proct=0,
		 EUS=1,
		 EUS_HPB=1,
		 Antegrade=1,
		 RecordId=101,
		 NEDRequired=1,
		 Retrograde=1,
		 Bronchs=0,
		 Cysto=0,
		 Bronch_Flexi=0,
		 Bronch_Rigid=0
	 WHERE LOWER(Description) = 'diverticulotomy'

END
GO



IF NOT EXISTS (SELECT 1 FROM dbo.ERS_TherapeuticTypes WHERE LOWER(Description) = 'insertion of gastric balloon')
BEGIN
     INSERT INTO dbo.ERS_TherapeuticTypes
     (
         Description,
         NedName,
         OGD,
         ERCP,
         Colon,
         Flexi,
         SchedulerTherapeutic,
         Proct,
         EUS,
         EUS_HPB,
         Antegrade,
         RecordId,
         NEDRequired,
         Retrograde,
         Bronchs,
         Cysto,
         Bronch_Flexi,
         Bronch_Rigid
     )
     VALUES
     (   'Insertion of gastric balloon',      -- Description - varchar(128)
         'Insertion of gastric balloon',      -- NedName - varchar(128)
         1,    -- OGD - bit
         0,    -- ERCP - bit
         0,    -- Colon - bit
         0,    -- Flexi - bit
         1, -- SchedulerTherapeutic - bit
         0,    -- Proct - bit
         0,    -- EUS - bit
         0,    -- EUS_HPB - bit
         0,    -- Antegrade - bit
         102,    -- RecordId - int
         1, -- NEDRequired - bit
         0, -- Retrograde - bit
         0, -- Bronchs - bit
         0, -- Cysto - bit
         0, -- Bronch_Flexi - bit
         0  -- Bronch_Rigid - bit
         )
END
ELSE
BEGIN
     UPDATE dbo.ERS_TherapeuticTypes 
	 SET NedName = 'Insertion of gastric balloon',
		 OGD = 0,
		 ERCP=0,
		 Colon=0,
		 Flexi=0,
		 SchedulerTherapeutic=1,
		 Proct=0,
		 EUS=0,
		 EUS_HPB=0,
		 Antegrade=0,
		 RecordId=102,
		 NEDRequired=1,
		 Retrograde=0,
		 Bronchs=0,
		 Cysto=0,
		 Bronch_Flexi=0,
		 Bronch_Rigid=0
	 WHERE LOWER(Description) = 'insertion of gastric balloon'

END
GO


IF NOT EXISTS (SELECT 1 FROM dbo.ERS_TherapeuticTypes WHERE LOWER(Description) = 'bipolar electrocoagulation')
BEGIN
     INSERT INTO dbo.ERS_TherapeuticTypes
     (
         Description,
         NedName,
         OGD,
         ERCP,
         Colon,
         Flexi,
         SchedulerTherapeutic,
         Proct,
         EUS,
         EUS_HPB,
         Antegrade,
         RecordId,
         NEDRequired,
         Retrograde,
         Bronchs,
         Cysto,
         Bronch_Flexi,
         Bronch_Rigid
     )
     VALUES
     (   'Bipolar electrocoagulation',      -- Description - varchar(128)
         'Bipolar electrocoagulation',      -- NedName - varchar(128)
         1,    -- OGD - bit
         1,    -- ERCP - bit
         1,    -- Colon - bit
         1,    -- Flexi - bit
         1, -- SchedulerTherapeutic - bit
         0,    -- Proct - bit
         1,    -- EUS - bit
         1,    -- EUS_HPB - bit
         1,    -- Antegrade - bit
         103,    -- RecordId - int
         1, -- NEDRequired - bit
         1, -- Retrograde - bit
         0, -- Bronchs - bit
         0, -- Cysto - bit
         0, -- Bronch_Flexi - bit
         0  -- Bronch_Rigid - bit
         )
END
ELSE
BEGIN
     UPDATE dbo.ERS_TherapeuticTypes 
	 SET NedName = 'Bipolar electrocoagulation',
		 OGD = 1,
		 ERCP=1,
		 Colon=1,
		 Flexi=1,
		 SchedulerTherapeutic=1,
		 Proct=0,
		 EUS=1,
		 EUS_HPB=1,
		 Antegrade=1,
		 NEDRequired=1,
		 Retrograde=1,
		 Bronchs=0,
		 Cysto=0,
		 Bronch_Flexi=0,
		 Bronch_Rigid=0
	 WHERE LOWER(Description) = 'bipolar electrocoagulation'

END
GO

UPDATE dbo.ERS_TherapeuticTypes 
SET OGD = 1,
	ERCP=1,
	Colon=1,
	Flexi=1,
	Proct=1,
	EUS=1,
	EUS_HPB=1,
	Antegrade=1,
	Retrograde=1,
	Bronchs=0,
	Cysto=0,
	Bronch_Flexi=0,
	Bronch_Rigid=0
WHERE LOWER(Description) IN ('band ligation','balloon dilation')
GO


PRINT N'Altering Table [dbo].[ERS_ERCPTherapeutics]...';


GO
IF NOT EXISTS (SELECT 1 FROM sys.columns WHERE name = 'Diverticulotomy' AND object_id = OBJECT_ID('ERS_ERCPTherapeutics'))
ALTER TABLE [dbo].[ERS_ERCPTherapeutics]
    ADD [Diverticulotomy] BIT CONSTRAINT [DF_ERS_ERCPTherapeutics_Diverticulotomy] DEFAULT ((0)) NOT NULL;


GO
IF NOT EXISTS (SELECT 1 FROM sys.columns WHERE name = 'Homeostasis' AND object_id = OBJECT_ID('ERS_ERCPTherapeutics'))
BEGIN
    ALTER TABLE [dbo].[ERS_ERCPTherapeutics]
        ADD [Homeostasis] BIT CONSTRAINT [DF_ERS_ERCPTherapeutics_Homeostasis] DEFAULT ((0)) NOT NULL;
END
ELSE
	BEGIN
		IF OBJECT_ID('dbo.DF_ERS_ERCPTherapeutics_Homeostasis', 'D') IS NULL
		BEGIN
			ALTER TABLE [dbo].[ERS_ERCPTherapeutics] ADD CONSTRAINT [DF_ERS_ERCPTherapeutics_Homeostasis] DEFAULT ((0)) FOR [Homeostasis]
		END
	    
	END

GO

IF NOT EXISTS (SELECT 1 FROM sys.columns WHERE name = 'HomeostasisType' AND object_id = OBJECT_ID('ERS_ERCPTherapeutics'))
ALTER TABLE [dbo].[ERS_ERCPTherapeutics]
    ADD [HomeostasisType]  INT NULL;


GO
PRINT N'Altering Table [dbo].[ERS_UpperGITherapeutics]...';


GO

IF EXISTS (SELECT 1 FROM sys.columns WHERE name = 'Homeostasis' AND object_id = OBJECT_ID('ERS_UpperGITherapeutics'))
	IF OBJECT_ID('dbo.DF_ERS_UpperGITherapeutics_Homeostasis', 'D') IS NULL
	BEGIN
	    ALTER TABLE [ERS_UpperGITherapeutics] ADD CONSTRAINT [DF_ERS_UpperGITherapeutics_Homeostasis] DEFAULT ((0))  FOR [Homeostasis]
	END

GO

IF NOT EXISTS (SELECT 1 FROM sys.columns WHERE name = 'Diverticulotomy' AND object_id = OBJECT_ID('ERS_UpperGITherapeutics'))
ALTER TABLE [dbo].[ERS_UpperGITherapeutics]
    ADD [Diverticulotomy]	BIT CONSTRAINT [DF_ERS_UpperGITherapeutics_Diverticulotomy] DEFAULT ((0)) NOT NULL;


GO

IF NOT EXISTS (SELECT 1 FROM sys.columns WHERE name = 'GastricBalloonInsertion' AND object_id = OBJECT_ID('ERS_UpperGITherapeutics'))
ALTER TABLE [dbo].[ERS_UpperGITherapeutics]
    ADD [GastricBalloonInsertion] BIT CONSTRAINT [DF_ERS_UpperGITherapeutics_GastricBalloonInsertion] DEFAULT ((0)) NOT NULL;


GO

IF NOT EXISTS (SELECT 1 FROM sys.columns WHERE name = 'Purastat' AND object_id = OBJECT_ID('ERS_UpperGITherapeutics'))
ALTER TABLE [dbo].[ERS_UpperGITherapeutics]
    ADD [Purastat] BIT CONSTRAINT [DF_ERS_UpperGITherapeutics_Purastat] DEFAULT ((0)) NOT NULL;


GO

PRINT N'Altering Function [dbo].[fnNED_GetOtherTypeTheraps]...';


GO
-----------------------------------------------------------------------------------------------------------

ALTER FUNCTION [dbo].[fnNED_GetOtherTypeTheraps]
(
	@ProcType		AS INT,
	@SiteId			AS INT,
	@EndRole		AS INT
)
RETURNS varchar(250)
AS
-- =============================================
-- Description:	This will Concatenate the 'Other' Type of TherapProcs which are not recognised by NED Schema.
--				So- when only 'OTHER' is passed as parameter- it will concatenate some specific theraps,
--						like: Bicap, Diathermy, Snare Excision and OTher Field's data itself
-- =============================================
BEGIN	
	DECLARE @ResultVar VARCHAR(250);

--	IF Lower(@TherapName) = 'other'
		BEGIN
			IF @ProcType=1		--## OGD / Gastroscopy
				BEGIN
					SELECT @ResultVar=(
							COALESCE((CASE WHEN T.Diathermy = 1			THEN 'Diathermy, '			END), '') +
							COALESCE((CASE WHEN T.PyloricDilatation = 1	THEN 'Pyloric Dilatation, '	END), '') +
							COALESCE((CASE WHEN T.pHProbeInsert = 1		THEN 'pHProbe Insert, '		END), '') +
							COALESCE((CASE WHEN ISNULL(T.Homeostasis,0) = 1	THEN 'Homeostatis - ' + l.ListItemText + ', '		END), '') +
							COALESCE(T.Other, '')  )
						FROM [dbo].ERS_UpperGITherapeutics AS T
						INNER JOIN dbo.ERS_Sites AS S ON T.SiteId=S.SiteId
						LEFT JOIN dbo.ERS_Lists l ON l.ListDescription = 'Homeostasis' AND l.ListItemNo = t.HomeostasisType
						WHERE T.SiteId = @SiteId
						  AND T.CarriedOutRole = @EndRole
						  AND (IsNull(Diathermy, 0)<>0 OR 
							IsNUll(PyloricDilatation, 0)<>0 OR IsNull(pHProbeInsert, 0)<>0 OR 
							(ISNULL(T.Homeostasis, 0) = 1 AND T.HomeostasisType NOT IN  (1,2,3)) OR
							LEN(IsNull(Other, '')) >= 1)
				END
			ELSE IF @ProcType = 2 --## ERCP
				BEGIN	
					SELECT 
						@ResultVar =(
						  COALESCE(CASE WHEN SnareExcision = 1 THEN 'Snare Excision, ' END, '') +
						  COALESCE(CASE WHEN YAGLaser = 1 THEN 'YAG laser, ' END, '') +
						  COALESCE(CASE WHEN ArgonBeamDiathermy = 1 THEN 'Argon beam photocoagulation, ' END, '') +
						  COALESCE(CASE WHEN BotoxInjection = 1 THEN 'Botox injection, ' END, '') +
						  COALESCE(CASE WHEN EndoloopPlacement = 1 THEN 'Endoloop placement, ' END, '') +
						  COALESCE(CASE WHEN HeatProbe = 1 THEN 'Heater probe, ' END, '') +
						  COALESCE(CASE WHEN Diathermy = 1 THEN 'Diathermy , ' END, '') +
						  COALESCE(CASE WHEN ForeignBody = 1 THEN 'Foreign body removal, ' END, '') +
						  COALESCE(CASE WHEN HotBiopsy = 1 THEN 'Hot biopsy, ' END, '') +
						  COALESCE(CASE WHEN EMR = 1 THEN 'EMR, ' END, '') +
						  COALESCE(CASE WHEN Marking = 1 THEN 'Marking / tattooing, ' END, '') +
						  COALESCE(CASE WHEN Clip = 1 THEN 'Clip placement, ' END, '') +
						  COALESCE(CASE WHEN PyloricDilatation = 1 THEN 'Pyloric/duodenal dilatation, ' END, '') +
						  COALESCE(CASE WHEN StrictureDilatation = 1 THEN 'Stricture dilatation, ' END, '') +
						  COALESCE(CASE WHEN GastrostomyInsertion = 1 THEN 'Nasojejunal tube (NJT), ' END, '') +
						  COALESCE(CASE WHEN GastrostomyRemoval = 1 THEN 'Nasojejunal removal (NJT), ' END, '') +
							COALESCE((CASE WHEN ISNULL(T.Homeostasis,0) = 1	THEN 'Homeostatis - ' + l.ListItemText + ', '		END), '') +
						  COALESCE(Other, '')
						)

						FROM dbo.ERS_ERCPTherapeutics AS T
						INNER JOIN dbo.ERS_Sites AS S ON T.SiteId=S.SiteId
						LEFT JOIN dbo.ERS_Lists l ON l.ListDescription = 'Homeostasis' AND l.ListItemNo = t.HomeostasisType
						WHERE T.SiteId = @SiteId AND CarriedOutRole = @EndRole
						AND ((IsNUll(SnareExcision, 0)<>0 OR IsNull(YAGLaser, 0)<>0 OR 
							IsNUll(ArgonBeamDiathermy, 0)<>0 OR 
							IsNUll(BotoxInjection, 0)<>0 OR IsNull(EndoloopPlacement, 0)<>0 OR 
							IsNUll(HeatProbe, 0)<>0 OR 
							IsNUll(Diathermy, 0)<>0 OR IsNull(ForeignBody, 0)<>0 OR 
							IsNUll(HotBiopsy, 0)<>0 OR IsNull(EMR, 0)<>0 OR 
							IsNUll(Marking, 0)<>0 OR IsNull(Clip, 0)<>0 OR 
							IsNUll(PyloricDilatation, 0)<>0 OR IsNull(GastrostomyInsertion, 0)<>0 OR 
							IsNUll(GastrostomyRemoval, 0)<>0 OR IsNull(StrictureDilatation, 0)<>0) OR 
							(ISNULL(T.Homeostasis, 0) = 1 AND T.HomeostasisType NOT IN  (1,2,3)) OR
							LEN(IsNull(Other, '')) >= 1)
												
					END				
			ELSE IF @ProcType = 3 OR @ProcType = 13 OR @ProcType = 4 --## FLEXY/COLON
				BEGIN
					SELECT @ResultVar=(
							COALESCE((CASE WHEN T.BotoxInjection = 1		THEN 'Botox injection, '		END), '') +
							COALESCE((CASE WHEN T.HeatProbe = 1		THEN 'Heater probe, '		END), '') +
							COALESCE((CASE WHEN T.Diathermy = 1		THEN 'Diathermy, '		END), '') +
							COALESCE((CASE WHEN T.HotBiopsy = 1		THEN 'Hot biopsy, '		END), '') +
							COALESCE((CASE WHEN T.EMR = 1		THEN 'EMR, '		END), '') +
							COALESCE((CASE WHEN T.EndoClot = 1		THEN 'Endoclot, '		END), '') +
							COALESCE((CASE WHEN T.Sigmoidopexy = 1		THEN 'Sigmoidopexy, '		END), '') +
							COALESCE((CASE WHEN ISNULL(T.Homeostasis,0) = 1		THEN 'Homeostatis - ' + l.ListItemText + ', '		END), '') +
							COALESCE(T.Other, '')  )
						FROM [dbo].ERS_UpperGITherapeutics AS T
						INNER JOIN dbo.ERS_Sites AS S ON T.SiteId=S.SiteId 
						LEFT JOIN dbo.ERS_Lists l ON l.ListDescription = 'Homeostasis' AND l.ListItemNo = t.HomeostasisType
						WHERE T.SiteId = @SiteId
						  AND T.CarriedOutRole = @EndRole
						  AND ((IsNUll(BotoxInjection, 0)<>0 OR IsNull(HeatProbe, 0)<>0 OR 
							IsNull(Diathermy, 0)<>0 OR 
							IsNUll(HotBiopsy, 0)<>0 OR IsNull(EMR, 0)<>0 OR 
							IsNUll(EndoClot, 0)<>0 OR IsNull(Sigmoidopexy, 0)<>0) OR 
							(ISNULL(T.Homeostasis, 0) = 1 AND T.HomeostasisType NOT IN  (1,2,3)) OR
							LEN(IsNull(Other, '')) >= 1)
				END
			ELSE IF @ProcType = 8 OR @ProcType = 9 --## ENT
				BEGIN	
					SELECT @ResultVar=(
							COALESCE((CASE WHEN ISNULL(T.Homeostasis,0) = 1		THEN 'Homeostatis - ' + l.ListItemText + ', '		END), '') +
							COALESCE(T.Other, '')  )
						FROM [dbo].ERS_UpperGITherapeutics AS T
						INNER JOIN dbo.ERS_Sites AS S ON T.SiteId=S.SiteId 
						LEFT JOIN dbo.ERS_Lists l ON l.ListDescription = 'Homeostasis' AND l.ListItemNo = t.HomeostasisType
						WHERE T.SiteId = @SiteId
						  AND T.CarriedOutRole = @EndRole
						  AND (ISNULL(T.Homeostasis, 0) = 1 AND T.HomeostasisType NOT IN  (1,2,3)) OR
							(LEN(IsNull(Other, '')) >= 1)				
				END
				
			ELSE IF @ProcType = 5 OR @ProcType = 6 --## EUS
				BEGIN	
					SELECT @ResultVar=(
							COALESCE((CASE WHEN ISNULL(T.Homeostasis,0) = 1		THEN 'Homeostatis - ' + l.ListItemText + ', '		END), '') +
							COALESCE(T.Other, '')  )
						FROM [dbo].ERS_UpperGITherapeutics AS T
						INNER JOIN dbo.ERS_Sites AS S ON T.SiteId=S.SiteId 
						LEFT JOIN dbo.ERS_Lists l ON l.ListDescription = 'Homeostasis' AND l.ListItemNo = t.HomeostasisType
						WHERE T.SiteId = @SiteId
						  AND T.CarriedOutRole = @EndRole
						  AND (ISNULL(T.Homeostasis, 0) = 1 AND T.HomeostasisType NOT IN  (1,2,3)) OR
							(LEN(IsNull(Other, '')) >= 1)				
				END
		END
	
	SET @ResultVar = ltrim(rtrim(@ResultVar));
	--## Remove the Last ',' of the String; That's a virus! Bad for indigestion!
	SELECT @ResultVar= CASE 
						WHEN RIGHT(@ResultVar, 1)=',' THEN SUBSTRING(@ResultVar, 1, LEN(@ResultVar)-1)
						ELSE @ResultVar END;

	RETURN @ResultVar;
END

--################## END Function: fnNED_GetOtherTypeTheraps; Scalar Function
GO
PRINT N'Altering Function [dbo].[tvfNED_ProcedureTherapeutic]...';


GO
/****** Object:  UserDefinedFunction [dbo].[tvfNED_ProcedureTherapeutic]    Script Date: 08/11/2023 10:05:00 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER FUNCTION [dbo].[tvfNED_ProcedureTherapeutic]
(	
	  @ProcedureType AS INT
	, @ProcedureId AS INT
	, @CarriedOutRole AS INT --## 1: Endo1; 2: Endo2
)
RETURNS TABLE 
AS
RETURN 
(

WITH CTE AS ( --## Just wrapping the selection in the CTE to use later for a COUNT() operation
	
	SELECT      DISTINCT
		  UP.ProcedureId
		, UP.ProcedureType
		, UP.SiteId
		, CASE WHEN UP.SiteNo = -77 THEN 'Colon' ELSE UP.[Site] END AS Saite
		, CASE WHEN UP.SiteNo = -77 THEN 'Colon' ELSE UP.[Site] END As [Site]
		--, UP.TherapyTypeId
		--, TT.[Description]
		, TT.NedName
		, UP.EndoRole 
		,UP.EndoRoleId
		--, UT_CarriedOutRole
		--, ERCP_CarriedOutRole
		, (CASE WHEN TT.NedName LIKE 'Polyp%' THEN (SELECT TOP 1 Tattooed FROM ERS_CommonAbnoPolypDetails WHERE SiteId = UP.SiteId) ELSE NULL END) AS Tattooed
		, (CASE WHEN TT.NedName LIKE 'Stent placement%' then COALESCE(UGI_StentQty, ER_StentQty)				else 1 END) AS StentPerformed --## 'Stent Placement' for O/C/F; And 'Stent placement - pancreas/CBD' for ERCP
		--, UGI_StentQty, ER_StentQty --#############
		, ISNULL(dbo.fnNED_GetTherapTypeSuccess(ProcedureType, SiteId, UP.EndoRoleId, @CarriedOutRole, NedName),0) AS Successful
		, (CASE WHEN UP.TherapyTypeId=2 THEN	--## Any Therap in 'Other' Category
			dbo.fnNED_GetOtherTypeTheraps(ProcedureType, UP.SiteId, @CarriedOutRole) 
			END --## ELSE Return NULL... Should only be available when 'Other' Therap is present
		  ) AS Comment
	FROM            
		(SELECT			
				P.ProcedureId,  
				P.ProcedureType,
				S.SiteId, 
				S.SiteNo,
				CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND s.SiteId = SiteId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END As [Site],			
				--R.NED_Term AS [Site], --## Link to [dbo.ERS_Regions] via Sites.Id
				NULL [role]
				, UT.CarriedOutRole											AS UGI_CarriedOutRole
				, ER.CarriedOutRole											AS ERCP_CarriedOutRole				
				, CASE WHEN PD.Size <20 THEN NULL ELSE pt.NEDTerm	END	AS Tattooed
				, UT.StentInsertionQty										AS UGI_StentQty
				, ER.StentInsertionQty										AS ER_StentQty,
				CASE WHEN (UT.[None] = 1 OR T.[None] = 1) THEN 1 END AS [None], 
				CASE WHEN @ProcedureType IN (1,3,4,8,9) AND UT.ArgonBeamDiathermy = 1 THEN 3 END								AS ArgonBeamDiathermy, --## C/F/O
				CASE WHEN (@ProcedureType IN (1,3,9,8,4) AND UT.BalloonDilation = 1) OR 
						  (@ProcedureType IN (2,7) AND ER.BalloonDilation = 1) THEN 4 END	AS BalloonDilation,		--## ALL: Balloon sphicteroplasty	
				--CASE WHEN @ProcedureType = 2 AND (ER.BalloonDilation = 1) THEN  91 END	AS Sphincteroplasty,		--## ALL: Balloon sphicteroplasty	
				CASE WHEN @ProcedureType = 2 AND ER.BalloonTrawl = 1 THEN 5 END												AS BalloonTrawl,
				CASE WHEN @ProcedureType = 1 AND (UT.BandLigation = 1 OR UT.VaricealBanding = 1) THEN  6 END					AS BandLigation, 
				CASE WHEN @ProcedureType IN (3,9,4) AND UT.BandingPiles = 1 THEN 7 END										AS BandingPiles,		--## O / C / F
				CASE WHEN @ProcedureType = 1 AND UT.BotoxInjection	= 1 THEN  8 END											AS BotoxInjection,
				CASE WHEN @ProcedureType IN (1,9) and ((UT.BougieDilation = 1 OR UT.OesophagealDilatation=1 AND UT.DilatorType=2)
														OR (ER.BalloonTrawlDilatorType=2 or ER.DilatorType=2)) --## Need to confirm this Logic!
														THEN 9 END															AS BougieDilation, --## O / E	
				CASE WHEN @ProcedureType=2 AND ER.BrushCytology = 1 THEN 10 END												AS Brush,
				CASE WHEN @ProcedureType=2 AND ER.Cannulation = 1 THEN 11 END												AS Cannulation,
				CASE WHEN @ProcedureType IN (1,3,4,8,9) AND UT.Clip = 1 THEN 12 END											AS Clip,
				CASE WHEN @ProcedureType=2 AND ER.RendezvousProcedure = 1 THEN 13 END										AS RendezvousProcedure,
				CASE WHEN @ProcedureType=2 AND ER.DiagCholangiogram	= 1 THEN 14 END											AS DiagCholangiogram,
				CASE WHEN @ProcedureType=2 AND ER.DiagPancreatogram		= 1 THEN 15 END										AS DiagPancreatogram,
				CASE WHEN @ProcedureType IN (1,8,9) AND UT.EMR = 1 THEN 
														(CASE WHEN ISNULL(UT.EMRType, 0)<> 0 THEN 
															(CASE UT.EMRType WHEN 1 THEN 16 ELSE 19 END) 
														END) END															AS EMR,
				CASE WHEN @ProcedureType IN (3,9,4) AND UT.EndoloopPlacement = 1 THEN 17 END								AS EndoloopPlacement,
				CASE WHEN @ProcedureType=2 AND ER.EndoscopicCystPuncture = 1 THEN 18 END									AS Cyst,
				CASE WHEN @ProcedureType IN (1,3,9,4) AND UT.ForeignBody = 1 THEN 20 END									AS ForeignBody,
				CASE WHEN @ProcedureType=2 AND ER.Haemostasis = 1 THEN 21 END												AS Haemostasis,
				CASE WHEN @ProcedureType IN (1,9) AND UT.HeatProbe = 1 THEN 22 END											AS HeatProbe, 
				CASE WHEN @ProcedureType IN (1,9) AND (UT.HotBiopsy = 1 OR T.HotBiopsy = 1) THEN 23 END						AS HotBiopsy,
				CASE WHEN @ProcedureType NOT IN (6,7) AND UT.Injection = 1 OR ER.Injection = 1	THEN 24 END					AS Injection,
				CASE WHEN @ProcedureType=2 AND ER.Manometry = 1 THEN 25 END													AS Manometry,
				CASE WHEN @ProcedureType NOT IN (2,6,7) AND UT.Marking = 1 THEN 26 END										AS Marking,
				CASE WHEN @ProcedureType=2 AND ER.NasopancreaticDrain = 1 THEN 27 END										AS NasopancreaticDrain,
				CASE WHEN @ProcedureType IN (1,9) AND UT.GastrostomyInsertion = 1 AND UT.GastrostomyRemoval = 1 THEN 28 END		AS PEGChange,
				CASE WHEN @ProcedureType IN (1,9) AND UT.GastrostomyInsertion = 1 AND UT.GastrostomyRemoval = 0 THEN 29 END		AS PEGInsertion,
				CASE WHEN @ProcedureType IN (1,9) AND UT.GastrostomyInsertion = 0 AND UT.GastrostomyRemoval = 1 THEN 30 END		AS PEGRemoval,
				CASE WHEN (UT.Polypectomy = 1 OR ER.Polypectomy = 1) AND (ISNULL(PD.SiteId,0)) > 0 THEN 
					CASE PD.NedTerm 
													WHEN 'Polyp snare - cold' THEN 35 --## 'Polyp - snare cold'
													WHEN 'Polyp snare - hot' THEN 36 --## 'Polyp - snare hot'
													WHEN 'Polyp - hot biopsy' THEN 34 --## 'Polyp - hot biopsy'
													WHEN 'Polyp - cold biopsy polypectomy' THEN 31 --## 'Polyp - cold biopsy POLYPECTOMY'
													WHEN 'Polyp - EMR' THEN 32 --## 'Polyp - EMR'
													WHEN 'Polyp - ESD' THEN 33 --## 'Polyp - ESD'
													WHEN 'Polyp - cold biopsy sampling' THEN 75 --## 'Polyp - cold biopsy sampling'
													WHEN 'Polyp - FTR' THEN 76 --## 'Polyp - FTR'
													WHEN 'Polyp - not removed' THEN 77 --## 'Polyp - FTR'
					END 
				END																											AS PolypRemovalType, 			
				CASE WHEN @ProcedureType=1 AND ((UT.Polypectomy = 1 OR ER.Polypectomy = 1) AND PD.SiteId is null) THEN 37 END					AS Polypectomy,			
				CASE WHEN @ProcedureType=1 AND UT.RFA = 1 THEN 38 END														AS RFA, 
				CASE WHEN @ProcedureType=2 AND (ER.PanOrificeSphincterotomy = 1 OR ER.Papillotomy = 1) THEN 39 END			AS Sphincterotomy,
				CASE WHEN (@ProcedureType IN (1,3,8,9,4) AND (UT.StentRemoval = 1 AND UT.StentInsertion = 1))  OR 
						  (@ProcedureType = 2 AND (ER.StentRemoval = 1 AND ER.StentInsertion = 1) AND LOWER(ERRegions.Area)<>'biliary' AND LOWER(ERRegions.Area)<>'pancreas') THEN 40 END  AS StentChange,
				CASE WHEN (@ProcedureType IN (1,3,4,8,9) AND UT.StentRemoval = 0 AND UT.StentInsertion = 1) OR 
						  (@ProcedureType = 2 AND (ER.StentRemoval = 0 AND ER.StentInsertion = 1) AND LOWER(ERRegions.Area)<>'biliary' AND LOWER(ERRegions.Area)<>'pancreas') /**/ THEN 41 END		AS StentPlacement,
				CASE WHEN (@ProcedureType IN (1,3,4,8,9) AND (UT.StentRemoval = 1 AND UT.StentInsertion = 0)) OR
						  (@ProcedureType = 2 AND (ER.StentRemoval = 1 AND ER.StentInsertion = 0)AND LOWER(ERRegions.Area)<>'biliary' AND LOWER(ERRegions.Area)<>'pancreas') /**/  THEN 44 END	AS StentRemoval,
				CASE WHEN @ProcedureType=2 AND (ER.StoneRemoval = 1 AND Abn.StonesSize>= 10) THEN 45 END												AS StoneExtractionGT10, --## Stone Size in mm
				CASE WHEN @ProcedureType=2 AND (ER.StoneRemoval = 1 AND Abn.StonesSize < 10) THEN 46 END												AS StoneExtractionLT10,
				CASE WHEN @ProcedureType=1 AND UT.VaricealSclerotherapy = 1 THEN 47 END										AS VaricealSclerotherapy,
				CASE WHEN @ProcedureType IN (1,3,4,8,9) AND UT.YAGLaser = 1 THEN 48 END										AS YAGLaser,
				--CASE WHEN UT.Diathermy = 1 THEN 50	END																		AS Diathermy,
				--CASE WHEN UT.EndoscopicResection = 1 THEN 98 END
				CASE WHEN UT.EMR = 1 AND ISNULL(UT.EMRType, 0) = 3 THEN 98 END												AS EndoscopicResection,
				CASE WHEN @ProcedureType=3 AND UT.PancolonicDyeSpray = 1 THEN 66 END										AS PancolonicDyeSpray,
				CASE WHEN @ProcedureType IN (3,4,9) AND UT.ColonicDecompression = 1 THEN 84 END								AS ColonicDecompression,
				CASE WHEN @ProcedureType IN (3,4,9) AND UT.FlatusTubeInsertion = 1 THEN 1069 END								AS FlatusTubeInsertion,
				CASE WHEN @ProcedureType = 2 AND ER.Cholangioscopy = 1 and er.CholangioscopyType = 1 THEN 82 END									AS LesionAssessment,
				CASE WHEN @ProcedureType = 2 AND ER.Cholangioscopy = 1 and er.CholangioscopyType = 2 THEN 83 END									AS StoneTherapy,
				CASE WHEN @ProcedureType = 2 AND (ER.StentRemoval = 1 AND ER.StentInsertion = 1) 
															AND LOWER(ERRegions.Area)='biliary'
														AND LOWER(R.Region) <>'common bile duct'  THEN 68 END					AS StentChangeBiliary,
				CASE WHEN @ProcedureType = 2 AND (ER.StentRemoval = 1 AND ER.StentInsertion = 1) 
															AND LOWER(ERRegions.Area)='pancreas' THEN 79 END				AS StentChangePancreatic,
				CASE WHEN @ProcedureType = 2 AND (ER.StentRemoval = 0 AND ER.StentInsertion = 1) 
															AND LOWER(R.Region)='common bile duct' THEN 42 END				AS StentPlacementCBD,
				CASE WHEN @ProcedureType = 2 AND (ER.StentRemoval = 0 AND ER.StentInsertion = 1 
															AND LOWER(ERRegions.Area)='biliary')
														AND LOWER(R.Region) <>'common bile duct'  THEN 69 END				AS StentPlacementBiliary,
				CASE WHEN @ProcedureType = 2 AND (ER.StentRemoval = 0 AND ER.StentInsertion = 1 
															AND LOWER(ERRegions.Area)='pancreas') THEN 95 END				AS StentPlacementPancreatic,
				CASE WHEN @ProcedureType = 2 AND (ER.StentInsertion = 0 AND ER.StentRemoval = 1) 
															AND LOWER(ERRegions.Area)='biliary' THEN 96 END					AS StentRemovalBiliary,
				CASE WHEN @ProcedureType = 2 AND (ER.StentInsertion = 0 AND ER.StentRemoval = 1) 
															AND LOWER(ERRegions.Area)='pancreas' THEN 97 END				AS StentRemovalPancreatic,
				CASE WHEN @ProcedureType=1 AND UT.NGNJTubeInsertion = 1 AND	LOWER(OGDRegions.Area) = 'stomach' THEN 52 END			AS NGTInsertion,
				CASE WHEN @ProcedureType=1 AND UT.NGNJTubeInsertion = 1 AND	LOWER(OGDRegions.Area) = 'duodenum' THEN 53 END			AS NJTInsertion,
				CASE WHEN (@ProcedureType=7 AND ER.FineNeedleAspiration = 1 AND 
																		er.FineNeedleAspirationType = 1) OR
						  (@ProcedureType=6 AND UT.FineNeedleAspiration = 1 AND 
																		UT.FineNeedleAspirationType = 1) THEN 73 END			AS FNACysticLesion,
				CASE WHEN (@ProcedureType=7 AND ER.FineNeedleAspiration = 1 AND 
																		er.FineNeedleAspirationType = 2) OR
						  (@ProcedureType=6 AND UT.FineNeedleAspiration = 1 AND 
																		UT.FineNeedleAspirationType = 2) THEN 78 END			AS FNASolidLesion,
				CASE WHEN (@ProcedureType=7 AND ER.FineNeedleBiopsy = 1) OR
						  (@ProcedureType=6 AND UT.FineNeedleBiopsy = 1)	THEN 74 END											AS FNBSolidLesion,
				
				/* 
					There are many other fields in the OGD/ERCP Therap Tables, but NED isn't interested in each and every Theraps.
					The Valid/Acceptable names are given in the XSD/Documentation file. Few other Theraps are put in 
					the 'Other' Category- instructions found in the Excel file, by Steve!
				*/

				(CASE  
						WHEN P.ProcedureType = 1 THEN							--## OGD / Gastroscopy
							(CASE WHEN 
									(UT.BicapElectro = 1  OR UT.PyloricDilatation = 1 OR
									UT.pHProbeInsert = 1 OR UT.EndoClot = 1 OR 
									UT.Diathermy = 1 OR
									UT.Haemospray = 1 OR LEN(UT.Other) > 1) THEN 2
								END)
						WHEN P.ProcedureType = 2 THEN							--## ERCP
							(CASE WHEN 
									(ER.SnareExcision = 1 OR 
									ER.YAGLaser = 1 OR ER.ArgonBeamDiathermy = 1 OR
									ER.BandLigation = 1 OR ER.BotoxInjection = 1 OR
									ER.EndoloopPlacement = 1 OR ER.HeatProbe = 1 OR
									ER.BicapElectro = 1 OR
									ER.ForeignBody = 1 OR ER.HotBiopsy = 1 OR
									ER.EMR = 1 OR ER.Marking = 1 OR
									ER.Clip = 1 OR ER.PyloricDilatation = 1 OR
									ER.StrictureDilatation = 1 OR ER.GastrostomyInsertion = 1 OR -- GastrostomyInsertion = Nasojejunal tube (NJT) 
									ER.GastrostomyRemoval = 1 OR LEN(ER.Other) > 1  --GastrostomyRemoval = Nasojejunal Removal (NJT) 
									) THEN 2
							  END)
						WHEN P.ProcedureType IN (3, 13, 4) THEN					-- ## COLON / FLEXI
							(CASE WHEN 
									(UT.BandLigation = 1 OR UT.VaricealBanding = 1 OR 
									UT.BotoxInjection = 1 OR UT.HeatProbe = 1 OR
									UT.BicapElectro = 1 OR
									UT.HotBiopsy = 1 OR UT.EMR = 1 OR
									UT.Diathermy = 1 OR
									UT.Sigmoidopexy = 1 OR UT.EndoClot = 1 OR
									LEN(UT.Other) > 1) THEN 2
							  END)
						 ELSE
							(CASE WHEN 
									(LEN(UT.Other) > 1) THEN 2
							  END)
				END) AS Other,
				CASE isnull(UT.EndoRole, ER.EndoRole) 
					when 1 then 'Independent (no trainer)'
					when 4 then 'Independent (no trainer)'
					when 2 then (case when @CarriedOutRole = 1 then 'I observed' else 'Was observed' END)
					when 3 then (case when @CarriedOutRole = 1 then 'I assisted physically' else 'Was assisted physically' END)
					when 5 then (case when @CarriedOutRole = 1 then 'I assisted physically' else 'Was assisted physically' END)
				END	AS EndoRole,
				isnull(UT.EndoRole, ER.EndoRole) AS EndoRoleId
			FROM            dbo.ERS_Procedures	AS	P	
				INNER JOIN				[dbo].ERS_Sites					AS  S ON P.ProcedureId = S.ProcedureId  
				LEFT JOIN				[dbo].ERS_Regions				AS  R ON S.RegionId = R.RegionId --## To Get SiteName
				LEFT JOIN ERS_AbnormalitiesMatrixERCP AS ERRegions ON ERRegions.Region = r.Region
				LEFT JOIN ERS_AbnormalitiesMatrixUpperGI AS OGDRegions ON OGDRegions.Region = r.Region
				LEFT OUTER JOIN			[dbo].ERS_ERCPTherapeutics		AS ER ON S.SiteId = ER.SiteId -- ER.CarriedOutRole  = @CarriedOutRole
				--LEFT OUTER JOIN			[dbo].ERS_ColonTherapeutics		AS CT ON S.SiteId = CT.SiteId
				LEFT OUTER JOIN				[dbo].ERS_UpperGITherapeutics	AS UT ON S.SiteId = UT.SiteId -- UT.CarriedOutRole  = @CarriedOutRole
				--LEFT OUTER JOIN			[dbo].[ERS_ColonAbnoLesions]	AS  L ON S.SiteId = L.SiteId 
				LEFT OUTER JOIN			[dbo].[ERS_UpperGISpecimens]	AS  T ON S.SiteId = T .SiteId
				LEFT OUTER JOIN			[dbo].[ERS_ERCPAbnoDuct]		AS Abn ON S.SiteId = Abn.SiteId
				LEFT OUTER JOIN			(SELECT d.PolypDetailId, d.TattooedId, d.SiteId, d.RemovalMethod, r.NEDTerm, d.Size FROM [dbo].[ERS_CommonAbnoPolypDetails] d LEFT JOIN ERS_PolypRemovalTypes r ON r.UniqueId = d.RemovalMethod WHERE d.SiteId IN (SELECT SiteId FROM ERS_Sites WHERE ProcedureId = @ProcedureId)) AS PD ON PD.SiteId = S.SiteId
				LEFT OUTER JOIN			ERS_TattooOptions pt ON pt.UniqueId = PD.TattooedId
				Where P.ProcedureId= @ProcedureId
				AND (((UT.EndoRole in (1, 2, 3, 5) AND @CarriedOutRole = 1)
				     OR
					 (UT.EndoRole in (2, 3, 4, 5) AND @CarriedOutRole = 2))
					OR
					((ER.EndoRole in (1, 2, 3, 5) AND @CarriedOutRole = 1)
				     OR
					 (ER.EndoRole in (2, 3, 4, 5) AND @CarriedOutRole = 2)))
		) AS PT 
				UNPIVOT (TherapyTypeId FOR Therapies IN 
												([None], Other
												, ArgonBeamDiathermy, BalloonDilation, /*Sphincteroplasty,*/ BandLigation, BotoxInjection, BougieDilation, Clip, EndoloopPlacement, EMR, BandingPiles	--, Colon Fields: (ESD,EMR)
												, ForeignBody, HeatProbe, HotBiopsy,  Marking, PEGChange, PEGInsertion, PEGRemoval, Polypectomy, RFA
												, StentRemoval, StentChange, StentPlacement, YAGLaser, Injection, PolypRemovalType
											--## Add ERCP Fields
												, BalloonTrawl,Brush, Cannulation, RendezvousProcedure, DiagCholangiogram, DiagPancreatogram
												, Cyst, Haemostasis, Manometry, Sphincterotomy, NasopancreaticDrain, StentPlacementCBD, 
												StoneExtractionGT10, StoneExtractionLT10, VaricealSclerotherapy, EndoscopicResection,PancolonicDyeSpray,
												ColonicDecompression,FlatusTubeInsertion, LesionAssessment,StoneTherapy,StentChangeBiliary,StentChangePancreatic,
												StentPlacementBiliary,StentPlacementPancreatic,StentRemovalBiliary,StentRemovalPancreatic,NGTInsertion,NJTInsertion,FNACysticLesion,
												FNASolidLesion,FNBSolidLesion)
						)  AS UP 
		LEFT JOIN dbo.ERS_TherapeuticTypes TT ON UP.TherapyTypeId = TT.RecordId
			WHERE 1=1
	) --## End of CTE.. Now just select the desired fields from this CTE

	SELECT ProcedureId, ProcedureType, CTE.SiteId, Saite, [Site], NedName, EndoRole,
		(CASE WHEN NedName LIKE '%not removed' THEN PS.PolypSizeText ELSE NULL END)		As polypSize,
		(CASE WHEN NedName LIKE 'Polyp%' AND NEDName <> 'polyp - not removed' THEN PolypSizeInt ELSE NULL END) AS PolypSizeInt,
		(CASE WHEN NedName LIKE 'Polyp%' THEN PS.Morphology ELSE NULL END) AS Morphology,
		Tattooed,
		CASE WHEN NedName = 'Polyp - not removed' then PS.Detected ELSE NULL END Detected,
		(CASE 
			WHEN NedName LIKE 'Polyp%' THEN 
				CASE WHEN NedName = 'Polyp - not removed' then 0 ELSE PS.Detected END
			WHEN NedName like 'Clip%' THEN
				(Select T.ClipNum from ERS_UpperGITherapeutics T where T.SiteId = CTE.SiteId)
			--WHEN NedName LIKE '%injection%' THEN
			--	(SELECT T.InjectionNumber FROM ERS_UpperGITherapeutics T WHERE T.SiteId = CTE.SiteId)
			WHEN NedName LIKE '%argon beam%' THEN
				(SELECT T.ArgonBeamDiathermyPulses FROM ERS_UpperGITherapeutics T WHERE T.SiteId = CTE.SiteId)
			WHEN NedName LIKE '%FNA%' THEN
				CASE WHEN ProcedureType IN (2,7) THEN (SELECT FNAPerformed FROM ERS_ERCPTherapeutics T WHERE T.SiteId = CTE.SiteId)
				ELSE (SELECT FNAPerformed FROM ERS_UpperGITherapeutics T WHERE T.SiteId = CTE.SiteId) END
			WHEN NedName LIKE '%FNB%' THEN
				CASE WHEN ProcedureType IN (2,7) THEN (SELECT FNBPerformed FROM ERS_ERCPTherapeutics T WHERE T.SiteId = CTE.SiteId)
				ELSE (SELECT FNBPerformed FROM ERS_UpperGITherapeutics T WHERE T.SiteId = CTE.SiteId) END
			WHEN NedName = 'Band ligation' THEN	
				(SELECT T.BandLigationPerformed FROM ERS_UpperGITherapeutics T WHERE T.SiteId = CTE.SiteId)
			WHEN NedName = 'Marking / tattooing' THEN	
				(SELECT T.MarkedQuantity FROM ERS_UpperGITherapeutics T WHERE T.SiteId = CTE.SiteId)
			ELSE 
				(CASE 
					WHEN StentPerformed>CTE.Successful THEN 
						StentPerformed 
					ELSE CTE.Successful 
				END) 
			END)		As Performed, --### Successful and Performed should be same!
		(CASE 
			WHEN NedName LIKE 'Polyp%' THEN 
				CASE WHEN CTE.EndoRoleId = 5 AND @CarriedOutRole = 1 THEN PS.Successful 
				     WHEN CTE.EndoRoleId = 5 AND @CarriedOutRole <> 1 THEN 0 ELSE
				PS.Successful END
			--WHEN NedName like 'Clip%' THEN 
			--	(Select T.ClipNumSuccess from ERS_UpperGITherapeutics T where T.SiteId = CTE.SiteId)
			--WHEN NedName LIKE '%injection%' THEN
			--	(SELECT T.InjectionNumber FROM ERS_UpperGITherapeutics T WHERE T.SiteId = CTE.SiteId)
			WHEN NedName LIKE '%argon beam%' THEN
				(SELECT T.ArgonBeamDiathermyPulses FROM ERS_UpperGITherapeutics T WHERE T.SiteId = CTE.SiteId)
			--WHEN NedName LIKE '%FNA%' THEN
			--	CASE WHEN ProcedureType IN (2,7) THEN (SELECT FNASuccessful FROM ERS_ERCPTherapeutics T WHERE T.SiteId = CTE.SiteId)
			--	ELSE (SELECT FNASuccessful FROM ERS_UpperGITherapeutics T WHERE T.SiteId = CTE.SiteId) END
			--WHEN NedName LIKE '%FNB%' THEN
			--	CASE WHEN ProcedureType IN (2,7) THEN (SELECT FNBSuccessful FROM ERS_ERCPTherapeutics T WHERE T.SiteId = CTE.SiteId)
			--	ELSE (SELECT FNBSuccessful FROM ERS_UpperGITherapeutics T WHERE T.SiteId = CTE.SiteId) END
			WHEN NedName = 'Marking / tattooing' THEN	
				(SELECT T.MarkedQuantity FROM ERS_UpperGITherapeutics T WHERE T.SiteId = CTE.SiteId)
			--WHEN NedName = 'Band ligation' THEN	
			--	(SELECT T.BandLigationSuccessful FROM ERS_UpperGITherapeutics T WHERE T.SiteId = CTE.SiteId)
			ELSE CTE.Successful
		END) AS Successful, --## 'CTE.StentPerformed' watches on the 'Stent placement% (CBD/PAN)' Qty' for Overall level.. better accuracy!
		(CASE 
			WHEN NedName LIKE 'Polyp%' THEN 
				PS.Retrieved
			WHEN NedName LIKE '%FNA%' THEN
				CASE WHEN ProcedureType IN (2,7) THEN (SELECT FNARetreived FROM ERS_ERCPTherapeutics T WHERE T.SiteId = CTE.SiteId)
				ELSE (SELECT FNARetreived FROM ERS_UpperGITherapeutics T WHERE T.SiteId = CTE.SiteId) END
			WHEN NedName LIKE '%FNB%' THEN
				CASE WHEN ProcedureType IN (2,7) THEN (SELECT FNBRetreived FROM ERS_ERCPTherapeutics T WHERE T.SiteId = CTE.SiteId)
				ELSE (SELECT FNBRetreived FROM ERS_UpperGITherapeutics T WHERE T.SiteId = CTE.SiteId) END 
			ELSE 
				0
		END)			As Retrieved,
		Comment 
		FROM CTE
		INNER JOIN (SELECT 
						SiteId, SUM(Detected) AS Detected, sum(Retrieved) AS Retrieved, SUM(Successful) AS Successful
						, PolypSizeText = (CASE WHEN Size IS NULL OR Size=0 THEN NULL WHEN Size<10 THEN 'ItemLessThan10mm' WHEN Size BETWEEN 10 AND 19 THEN 'Item10to19mm' ELSE 'Item20OrLargermm' END)
						, PolypSizeInt = Size
						, Morphology
					FROM dbo.tvfNED_PolypsDetailsView(@ProcedureType, @ProcedureId)
					GROUP BY SiteId, Retrieved, Successful, size,Morphology	)AS PS ON PS.SiteId = CTE.SiteId
	UNION ALL -- ## A Default Blank ROW.. ONLY when no Therap Record exist..
		SELECT TOP 1
			@ProcedureId AS ProcedureId, @ProcedureType	AS ProcedureType, NULL AS SiteId, NULL AS Saite
			, 'None' AS [Site]
			, 'None' AS NedName
			, NULL AS EndoRole	
			, NULL AS polypSize
			, NULL as PolypSizeInt
			, NULL AS Morphology
			, NULL AS Tattooed
			, NULL AS Detected
			, 0 AS Performed
			, 0 AS Successful
			, 0 AS Retrieved
			, NULL  AS Comment
		WHERE (SELECT IsNull(count(*), 0) FROM CTE)<1


);

GO

PRINT N'Altering Procedure [dbo].[therapeutics_ogd_summary_update]...';


GO

ALTER PROCEDURE [dbo].[therapeutics_ogd_summary_update]
(
	@TherapeuticId AS INT,
	@SiteId INT
)
AS
	SET NOCOUNT ON
	DECLARE   @msg VARCHAR(1000)
			, @msg2 VARCHAR(1000)
			, @Details VARCHAR(1000)
			, @Summary VARCHAR(4000)=''
			, @Area VARCHAR(500)=''
			, @br VARCHAR(6) = '<br />';

	DECLARE 
		@None BIT,
		@YAGLaser BIT,
		@YAGLaserWatts INT,
		@YAGLaserPulses INT,
		@YAGLaserSecs DECIMAL(8,2),
		@YAGLaserKJ DECIMAL(8,2),
		@ArgonBeamDiathermy BIT,
		@ArgonBeamDiathermyWatts INT,
		@ArgonBeamDiathermyPulses INT,
		@ArgonBeamDiathermySecs DECIMAL(8,2),
		@ArgonBeamDiathermyKJ DECIMAL(8,2),
		@BalloonDilation BIT,
		@BandLigation BIT,
		@BandLigationPerformed INT,
		@BandLigationSuccess INT,
		@BotoxInjection BIT,
		@EndoloopPlacement BIT,
		@HeatProbe BIT,
		@BicapElectro BIT,
		@Diathermy BIT,
		@DiathermyWatt INT,	--Mahfuz added on 30 Jul 2021
		@Coil BIT,
		@CoilQty INT,
		@CoilType INT,
		@Valve BIT,
		@ValveQty INT,
		@ValveType INT,
		@Cryotherapy BIT,
		@PhotoDynamicTherapy BIT,
		@ForeignBody BIT,
		@HotBiopsy BIT,
		@Injection BIT,
		@InjectionType INT,
		@InjectionVolume INT,
		@InjectionNumber INT,
		@OesophagealDilatation BIT,
		@DilatedTo INT,
		@DilatationUnits TINYINT,
		@DilatorType TINYINT,
		@DilatorScopePass BIT,
		@OesoDilNilByMouth BIT,
		@OesoDilNilByMouthHrs INT,
		@OesoDilXRay BIT,
		@OesoDilXRayHrs INT,
		@OesoDilSoftDiet BIT,
		@OesoDilSoftDietDays INT,
		@OesoDilWarmFluids BIT,
		@OesoDilWarmFluidsHrs INT,
		@OesoDilMedicalReview BIT,
		@OesoYAGNilByMouth BIT,
		@OesoYAGNilByMouthHrs INT,
		@OesoYAGWarmFluids BIT,
		@OesoYAGWarmFluidsHrs INT,
		@OesoYAGSoftDiet BIT,
		@OesoYAGSoftDietDays INT,
		@OesoYAGMedicalReview BIT,
		@Polypectomy BIT,
		@PolypectomyRemoval TINYINT,
		@PolypectomyRemovalType TINYINT,
		@BandingPiles BIT,
		@BandingNum INT,
		@GastrostomyInsertion BIT,
		@GastrostomyInsertionSize NUMERIC(9,2),
		@GastrostomyInsertionUnits TINYINT,
		@GastrostomyInsertionType TINYINT,
		@GastrostomyInsertionBatchNo VARCHAR(100),
		@CorrectPEGPlacement TINYINT,
		@PEGPlacementFailureReason VARCHAR(500),
		@NGNJInsertion BIT,
		@NGNJTubeNostril TINYINT,
		@NGNJTubeLength NUMERIC(9,2),
		@NGNJTubeBridle BIT,
		@NGNJTubeBatch VARCHAR(20),
		@NilByMouth BIT,
		@NilByMouthHrs INT,
		@NilByProc BIT,
		@NilByProcHrs INT,
		@FlangePosition NUMERIC(9,2),
		@AttachmentToWard BIT,
		@GastrostomyRemoval BIT,
		@PyloricDilatation BIT,
		@VaricealSclerotherapy BIT,
		@VaricealSclerotherapyInjectionType SMALLINT,
		@VaricealSclerotherapyInjectionVol INT,
		@VaricealSclerotherapyInjectionNum INT,
		@VaricealBanding BIT,
		@VaricealBandingNum INT,
		@VaricealClip BIT,
		@StentInsertion BIT,
		@StentInsertionQty INT,
		@StentInsertionType SMALLINT,
		@StentInsertionLength INT,
		@StentInsertionDiameter INT,
		@StentInsertionDiameterUnits TINYINT,
		@StentInsertionBatchNo VARCHAR(100),
		@CorrectStentPlacement TINYINT,
		@StentPlacementFailureReason VARCHAR(500),
		@StentRemoval BIT,
		@StentRemovalTechnique INT,
		@EMR BIT,
		@EMRType TINYINT,
		@EMRFluid INT,
		@EMRFluidVolume INT,
		@RFA BIT,
		@RFAType TINYINT,
		@RFATreatmentFrom INT,
		@RFATreatmentTo INT,
		@RFAEnergyDel INT,
		@RFANumSegTreated INT,
		@RFANumTimesSegTreated INT,
		@pHProbeInsert BIT,
		@pHProbeInsertAt INT,
		@pHProbeInsertChk BIT,
		@pHProbeInsertChkTopTo INT,
		@Haemospray BIT,
		@Sigmoidopexy BIT,
		@SigmoidopexyQty SMALLINT,
		@SigmoidopexyMake SMALLINT,
		@SigmoidopexyFluidsDays SMALLINT,
		@SigmoidopexyAntibioticsDays SMALLINT,
		@Marking BIT,
		@MarkedQuantity SMALLINT,
		@TattooLocationDistal BIT,
		@TattooLocationProximal BIT,
		@MarkingType INT,
		@Clip BIT,
		@ClipNum INT,
		@Other VARCHAR(1000),
		@EUSProcType SMALLINT,
		@EndoClot BIT,
		@ColonicDecompression BIT,
		@FlatusTubeInsertion BIT,
		@PancolonicDyeSpray BIT,
		@BougieDilation BIT,
		@EndoscopicResection BIT,
		@FineNeedleAspiration BIT,
		@FineNeedleAspirationType TINYINT,
		@FineNeedleBiopsy BIT,
		@Homeostasis BIT,
		@HomeostasisType INT,
		@Diverticulotomy BIT,
		@GastricBalloonInsertion BIT;

	IF OBJECT_ID('tempdb..#tmp_UpperGITherapeutics') IS NOT NULL
        DROP TABLE #tmp_UpperGITherapeutics;

	SELECT * INTO #tmp_UpperGITherapeutics 
	FROM dbo.[ERS_UpperGITherapeutics] 
	WHERE (Id = @TherapeuticId OR SiteID = @SiteId)

--## 1) If 'CarriedOutRole=2 (EE)' record is found for a SiteId in [ERS_UpperGITherapeutics] means it has both EE/ER Entries...
	--IF EXISTS(SELECT 'ER' FROM dbo.[ERS_UpperGITherapeutics] WHERE SiteId=@SiteId AND CarriedOutRole=2)
	--	BEGIN
			--PRINT '[ERS_UpperGITherapeutics] has both EE/ER Entries...';
			;WITH eeRecord AS (
				SELECT * FROM #tmp_UpperGITherapeutics WHERE CarriedOutRole = (SELECT MAX(CarriedOutRole) FROM #tmp_UpperGITherapeutics) --## 2 is EE
				--WHERE SiteId=@SiteId AND CarriedOutRole=2
			)
			SELECT
				@None							= (CASE WHEN ISNULL(ER.[None], 0) = 0 THEN EE.[None] ELSE ER.[None] END),
				@YAGLaser						= (CASE WHEN ISNULL(ER.[YAGLaser], 0) = 0 THEN EE.[YAGLaser] ELSE ER.[YAGLaser] END),
				@YAGLaserWatts					= (CASE WHEN ISNULL(ER.[YAGLaserWatts], 0) = 0 THEN EE.[YAGLaserWatts] ELSE ER.[YAGLaserWatts] END),
				@YAGLaserPulses					= (CASE WHEN ISNULL(ER.[YAGLaserPulses], 0) = 0 THEN EE.[YAGLaserPulses] ELSE ER.[YAGLaserPulses] END),
				@YAGLaserSecs					= (CASE WHEN ISNULL(ER.[YAGLaserSecs], 0) = 0 THEN EE.[YAGLaserSecs] ELSE ER.[YAGLaserSecs] END),
				@YAGLaserKJ						= (CASE WHEN ISNULL(ER.[YAGLaserKJ], 0) = 0 THEN EE.[YAGLaserKJ] ELSE ER.[YAGLaserKJ] END),
				@ArgonBeamDiathermy				= (CASE WHEN ISNULL(ER.[ArgonBeamDiathermy], 0) = 0 THEN EE.[ArgonBeamDiathermy] ELSE ER.[ArgonBeamDiathermy] END),
				@ArgonBeamDiathermyWatts		= (CASE WHEN ISNULL(ER.[ArgonBeamDiathermyWatts], 0) = 0 THEN EE.[ArgonBeamDiathermyWatts] ELSE ER.[ArgonBeamDiathermyWatts] END),
				@ArgonBeamDiathermyPulses		= (CASE WHEN ISNULL(ER.[ArgonBeamDiathermyPulses], 0) = 0 THEN EE.[ArgonBeamDiathermyPulses] ELSE ER.[ArgonBeamDiathermyPulses] END),
				@ArgonBeamDiathermySecs			= (CASE WHEN ISNULL(ER.[ArgonBeamDiathermySecs], 0) = 0 THEN EE.[ArgonBeamDiathermySecs] ELSE ER.[ArgonBeamDiathermySecs] END),
				@ArgonBeamDiathermyKJ			= (CASE WHEN ISNULL(ER.[ArgonBeamDiathermyKJ], 0) = 0 THEN EE.[ArgonBeamDiathermyKJ] ELSE ER.[ArgonBeamDiathermyKJ] END),
				@BalloonDilation				= (CASE WHEN ISNULL(ER.[BalloonDilation], 0) = 0 THEN EE.[BalloonDilation] ELSE ER.[BalloonDilation] END),
				@BandLigation					= (CASE WHEN ISNULL(ER.[BandLigation], 0) = 0 THEN EE.[BandLigation] ELSE ER.[BandLigation] END),
				@BandLigationPerformed			= (CASE WHEN ISNULL(ER.[BandLigationPerformed], 0) = 0 THEN EE.[BandLigationPerformed] ELSE ER.[BandLigationPerformed] END),
				@BandLigationSuccess			= (CASE WHEN ISNULL(ER.[BandLigationSuccessful], 0) = 0 THEN EE.[BandLigationSuccessful] ELSE ER.[BandLigationSuccessful] END),
				@BotoxInjection					= (CASE WHEN ISNULL(ER.[BotoxInjection], 0) = 0 THEN EE.[BotoxInjection] ELSE ER.[BotoxInjection] END),
				@EndoloopPlacement				= (CASE WHEN ISNULL(ER.[EndoloopPlacement], 0) = 0 THEN EE.[EndoloopPlacement] ELSE ER.[EndoloopPlacement] END),
				@HeatProbe						= (CASE WHEN ISNULL(ER.[HeatProbe], 0) = 0 THEN EE.[HeatProbe] ELSE ER.[HeatProbe] END),
				@BicapElectro					= (CASE WHEN ISNULL(ER.[BicapElectro], 0) = 0 THEN EE.[BicapElectro] ELSE ER.[BicapElectro] END),
				@Diathermy						= (CASE WHEN ISNULL(ER.[Diathermy], 0) = 0 THEN EE.[Diathermy] ELSE ER.[Diathermy] END),
				@DiathermyWatt					= (CASE WHEN ISNULL(ER.[DiathermyWatt], 0) = 0 THEN EE.[DiathermyWatt] ELSE ER.[DiathermyWatt] END),  
				@Coil							= (CASE WHEN ISNULL(ER.[Coil], 0) = 0 THEN EE.[Coil] ELSE ER.[Coil] END),
				@CoilQty						= (CASE WHEN ISNULL(ER.[CoilQty], 0) = 0 THEN EE.[CoilQty] ELSE ER.[CoilQty] END),
				@CoilType						= (CASE WHEN ISNULL(ER.[CoilType], 0) = 0 THEN EE.[CoilType] ELSE ER.[CoilType] END),
				@Valve							= (CASE WHEN ISNULL(ER.[Valve], 0) = 0 THEN EE.[Valve] ELSE ER.[Valve] END),
				@ValveQty						= (CASE WHEN ISNULL(ER.[ValveQty], 0) = 0 THEN EE.[ValveQty] ELSE ER.[ValveQty] END),
				@ValveType						= (CASE WHEN ISNULL(ER.[ValveType], 0) = 0 THEN EE.[ValveType] ELSE ER.[ValveType] END),
				@Cryotherapy					= (CASE WHEN ISNULL(ER.[Cryotherapy], 0) = 0 THEN EE.[Cryotherapy] ELSE ER.[Cryotherapy] END),
				@PhotoDynamicTherapy			= (CASE WHEN ISNULL(ER.[PhotoDynamicTherapy], 0) = 0 THEN EE.[PhotoDynamicTherapy] ELSE ER.[PhotoDynamicTherapy] END),
				@ForeignBody					= (CASE WHEN ISNULL(ER.[ForeignBody], 0) = 0 THEN EE.[ForeignBody] ELSE ER.[ForeignBody] END),
				@HotBiopsy						= (CASE WHEN ISNULL(ER.[HotBiopsy], 0) = 0 THEN EE.[HotBiopsy] ELSE ER.[HotBiopsy] END),
				@Injection						= (CASE WHEN ISNULL(ER.[Injection], 0) = 0 THEN EE.[Injection] ELSE ER.[Injection] END),
				@InjectionType					= (CASE WHEN ISNULL(ER.[InjectionType], 0) = 0 THEN EE.[InjectionType] ELSE ER.[InjectionType] END),
				@InjectionVolume				= (CASE WHEN ISNULL(ER.[InjectionVolume], 0) = 0 THEN EE.[InjectionVolume] ELSE ER.[InjectionVolume] END),
				@InjectionNumber				= (CASE WHEN ISNULL(ER.[InjectionNumber], 0) = 0 THEN EE.[InjectionNumber] ELSE ER.[InjectionNumber] END),
				@OesophagealDilatation			= (CASE WHEN ISNULL(ER.[OesophagealDilatation], 0) = 0 THEN EE.[OesophagealDilatation] ELSE ER.[OesophagealDilatation] END),
				@DilatedTo						= (CASE WHEN ISNULL(ER.[DilatedTo], 0) = 0 THEN EE.[DilatedTo] ELSE ER.[DilatedTo] END),
				@DilatationUnits				= (CASE WHEN ISNULL(ER.[DilatationUnits], 0) = 0 THEN EE.[DilatationUnits] ELSE ER.[DilatationUnits] END),
				@DilatorType					= (CASE WHEN ISNULL(ER.[DilatorType], 0) = 0 THEN EE.[DilatorType] ELSE ER.[DilatorType] END),
				@DilatorScopePass				= (CASE WHEN ISNULL(ER.[DilatorScopePass], 0) = 0 THEN EE.[DilatorScopePass] ELSE ER.[DilatorScopePass] END),
				@OesoDilNilByMouth				= (CASE WHEN ISNULL(ER.[OesoDilNilByMouth], 0) = 0 THEN EE.[OesoDilNilByMouth] ELSE ER.[OesoDilNilByMouth] END),
				@OesoDilNilByMouthHrs			= (CASE WHEN ISNULL(ER.[OesoDilNilByMouthHrs], 0) = 0 THEN EE.[OesoDilNilByMouthHrs] ELSE ER.[OesoDilNilByMouthHrs] END),
				@OesoDilXRay					= (CASE WHEN ISNULL(ER.[OesoDilXRay], 0) = 0 THEN EE.[OesoDilXRay] ELSE ER.[OesoDilXRay] END),
				@OesoDilXRayHrs					= (CASE WHEN ISNULL(ER.[OesoDilXRayHrs], 0) = 0 THEN EE.[OesoDilXRayHrs] ELSE ER.[OesoDilXRayHrs] END),
				@OesoDilSoftDiet				= (CASE WHEN ISNULL(ER.[OesoDilSoftDiet], 0) = 0 THEN EE.[OesoDilSoftDiet] ELSE ER.[OesoDilSoftDiet] END),
				@OesoDilSoftDietDays			= (CASE WHEN ISNULL(ER.[OesoDilSoftDietDays], 0) = 0 THEN EE.[OesoDilSoftDietDays] ELSE ER.[OesoDilSoftDietDays] END),
				@OesoDilWarmFluids				= (CASE WHEN ISNULL(ER.[OesoDilWarmFluids], 0) = 0 THEN EE.[OesoDilWarmFluids] ELSE ER.[OesoDilWarmFluids] END),
				@OesoDilWarmFluidsHrs			= (CASE WHEN ISNULL(ER.[OesoDilWarmFluidsHrs], 0) = 0 THEN EE.[OesoDilWarmFluidsHrs] ELSE ER.[OesoDilWarmFluidsHrs] END),
				@OesoDilMedicalReview			= (CASE WHEN ISNULL(ER.[OesoDilMedicalReview], 0) = 0 THEN EE.[OesoDilMedicalReview] ELSE ER.[OesoDilMedicalReview] END),
				@OesoYAGNilByMouth				= (CASE WHEN IsNull(ER.[OesoYAGNilByMouth], 0) = 0 THEN EE.[OesoYAGNilByMouth] ELSE ER.[OesoYAGNilByMouth] END),
				@OesoYAGNilByMouthHrs			= (CASE WHEN IsNull(ER.[OesoYAGNilByMouthHrs], 0) = 0 THEN EE.[OesoYAGNilByMouthHrs] ELSE ER.[OesoYAGNilByMouthHrs] END),
				@OesoYAGWarmFluids				= (CASE WHEN IsNull(ER.[OesoYAGWarmFluids], 0) = 0 THEN EE.[OesoYAGWarmFluids] ELSE ER.[OesoYAGWarmFluids] END),
				@OesoYAGWarmFluidsHrs			= (CASE WHEN IsNull(ER.[OesoYAGWarmFluidsHrs], 0) = 0 THEN EE.[OesoYAGWarmFluidsHrs] ELSE ER.[OesoYAGWarmFluidsHrs] END),
				@OesoYAGSoftDiet				= (CASE WHEN IsNull(ER.[OesoYAGSoftDiet], 0) = 0 THEN EE.[OesoYAGSoftDiet] ELSE ER.[OesoYAGSoftDiet] END),
				@OesoYAGSoftDietDays			= (CASE WHEN IsNull(ER.[OesoYAGSoftDietDays], 0) = 0 THEN EE.[OesoYAGSoftDietDays] ELSE ER.[OesoYAGSoftDietDays] END),
				@OesoYAGMedicalReview			= (CASE WHEN IsNull(ER.[OesoYAGMedicalReview], 0) = 0 THEN EE.[OesoYAGMedicalReview] ELSE ER.[OesoYAGMedicalReview] END),
				@Polypectomy					= (CASE WHEN IsNull(ER.[Polypectomy], 0) = 0 THEN EE.[Polypectomy] ELSE ER.[Polypectomy] END),
				@PolypectomyRemoval				= (CASE WHEN IsNull(ER.[PolypectomyRemoval], 0) = 0 THEN EE.[PolypectomyRemoval] ELSE ER.[PolypectomyRemoval] END),
				@PolypectomyRemovalType			= (CASE WHEN IsNull(ER.[PolypectomyRemovalType], 0) = 0 THEN EE.[PolypectomyRemovalType] ELSE ER.[PolypectomyRemovalType] END),
				@BandingPiles					= (CASE WHEN IsNull(ER.BandingPiles, 0) = 0 THEN EE.BandingPiles ELSE ER.BandingPiles END),
				@BandingNum						= (CASE WHEN IsNull(ER.BandingNum, 0) = 0 THEN EE.BandingNum ELSE ER.BandingNum END),
				@GastrostomyInsertion			= (CASE WHEN IsNull(ER.[GastrostomyInsertion], 0) = 0 THEN EE.[GastrostomyInsertion] ELSE ER.[GastrostomyInsertion] END),
				@GastrostomyInsertionSize		= (CASE WHEN IsNull(ER.[GastrostomyInsertionSize], 0) = 0 THEN EE.[GastrostomyInsertionSize] ELSE ER.[GastrostomyInsertionSize] END),
				@GastrostomyInsertionUnits		= (CASE WHEN IsNull(ER.[GastrostomyInsertionUnits], 0) = 0 THEN EE.[GastrostomyInsertionUnits] ELSE ER.[GastrostomyInsertionUnits] END),
				@GastrostomyInsertionType		= (CASE WHEN IsNull(ER.[GastrostomyInsertionType], 0) = 0 THEN EE.[GastrostomyInsertionType] ELSE ER.[GastrostomyInsertionType] END),
				@GastrostomyInsertionBatchNo	= (SELECT isnull((CASE WHEN IsNull(ER.[GastrostomyInsertionBatchNo], '') = '' THEN EE.[GastrostomyInsertionBatchNo] ELSE ER.[GastrostomyInsertionBatchNo] END), '') as [text()] FOR XML PATH('')),
				@CorrectPEGPlacement			= (CASE WHEN IsNull(ER.[CorrectPEGPlacement], 0) = 0 THEN EE.[CorrectPEGPlacement] ELSE ER.[CorrectPEGPlacement] END),
				@PEGPlacementFailureReason		= (SELECT isnull((CASE WHEN IsNull(ER.[PEGPlacementFailureReason], '') = '' THEN EE.[PEGPlacementFailureReason] ELSE ER.[PEGPlacementFailureReason] END), '') as [text()] FOR XML PATH('')),
				@NGNJInsertion 					= (CASE WHEN IsNull(ER.NGNJTubeInsertion, 0) = 0 THEN EE.NGNJTubeInsertion ELSE ER.NGNJTubeInsertion END),
				@NGNJTubeNostril				= (CASE WHEN IsNull(ER.NGNJTubeNostril, 0) = 0 THEN EE.NGNJTubeNostril ELSE ER.NGNJTubeNostril END),
				@NGNJTubeLength					= (CASE WHEN IsNull(ER.NGNJTubeLength, 0) = 0 THEN EE.NGNJTubeLength ELSE ER.NGNJTubeLength END),
				@NGNJTubeBridle					= (CASE WHEN IsNull(ER.NGNJTubeBridle, 0) = 0 THEN EE.NGNJTubeBridle ELSE ER.NGNJTubeBridle END),
				@NGNJTubeBatch					= (CASE WHEN IsNull(ER.NGNJTubeBatch, '') = '' THEN EE.NGNJTubeBatch ELSE ER.NGNJTubeBatch END),
				@NilByMouth						= (CASE WHEN IsNull(ER.[NilByMouth], 0) = 0 THEN EE.[NilByMouth] ELSE ER.[NilByMouth] END),
				@NilByMouthHrs					= (CASE WHEN IsNull(ER.[NilByMouthHrs], 0) = 0 THEN EE.[NilByMouthHrs] ELSE ER.[NilByMouthHrs] END),
				@NilByProc						= (CASE WHEN IsNull(ER.[NilByProc], 0) = 0 THEN EE.[NilByProc] ELSE ER.[NilByProc] END),
				@NilByProcHrs					= (CASE WHEN IsNull(ER.[NilByProcHrs], 0) = 0 THEN EE.[NilByProcHrs] ELSE ER.[NilByProcHrs] END),
				@FlangePosition					= (CASE WHEN IsNull(ER.[FlangePosition], 0) = 0 THEN EE.[FlangePosition] ELSE ER.[FlangePosition] END),
				@AttachmentToWard				= (CASE WHEN IsNull(ER.[AttachmentToWard], 0) = 0 THEN EE.[AttachmentToWard] ELSE ER.[AttachmentToWard] END),
				@GastrostomyRemoval				= (CASE WHEN IsNull(ER.[GastrostomyRemoval], 0) = 0 THEN EE.[GastrostomyRemoval] ELSE ER.[GastrostomyRemoval] END),
				@PyloricDilatation				= (CASE WHEN IsNull(ER.[PyloricDilatation], 0) = 0 THEN EE.[PyloricDilatation] ELSE ER.[PyloricDilatation] END),
				@VaricealSclerotherapy			= (CASE WHEN IsNull(ER.[VaricealSclerotherapy], 0) = 0 THEN EE.[VaricealSclerotherapy] ELSE ER.[VaricealSclerotherapy] END),
				@VaricealSclerotherapyInjectionType = (CASE WHEN IsNull(ER.[VaricealSclerotherapyInjectionType], 0) = 0 THEN EE.[VaricealSclerotherapyInjectionType] ELSE ER.[VaricealSclerotherapyInjectionType] END),
				@VaricealSclerotherapyInjectionVol  = (CASE WHEN IsNull(ER.[VaricealSclerotherapyInjectionVol], 0) = 0 THEN EE.[VaricealSclerotherapyInjectionVol] ELSE ER.[VaricealSclerotherapyInjectionVol] END),
				@VaricealSclerotherapyInjectionNum  = (CASE WHEN IsNull(ER.[VaricealSclerotherapyInjectionNum], 0) = 0 THEN EE.[VaricealSclerotherapyInjectionNum] ELSE ER.[VaricealSclerotherapyInjectionNum] END),
				@VaricealBanding				= (CASE WHEN IsNull(ER.[VaricealBanding], 0) = 0 THEN EE.[VaricealBanding] ELSE ER.[VaricealBanding] END),
				@VaricealBandingNum				= (CASE WHEN IsNull(ER.[VaricealBandingNum], 0) = 0 THEN EE.[VaricealBandingNum] ELSE ER.[VaricealBandingNum] END),
				@VaricealClip					= (CASE WHEN IsNull(ER.[VaricealClip], 0) = 0 THEN EE.[VaricealClip] ELSE ER.[VaricealClip] END),
				@StentInsertion					= (CASE WHEN IsNull(ER.[StentInsertion], 0) = 0 THEN EE.[StentInsertion] ELSE ER.[StentInsertion] END),
				@StentInsertionQty				= (CASE WHEN IsNull(ER.[StentInsertionQty], 0) = 0 THEN EE.[StentInsertionQty] ELSE ER.[StentInsertionQty] END),
				@StentInsertionType				= (CASE WHEN IsNull(ER.[StentInsertionType], 0) = 0 THEN EE.[StentInsertionType] ELSE ER.[StentInsertionType] END),
				@StentInsertionLength			= (CASE WHEN IsNull(ER.[StentInsertionLength], 0) = 0 THEN EE.[StentInsertionLength] ELSE ER.[StentInsertionLength] END),
				@StentInsertionDiameter			= (CASE WHEN IsNull(ER.[StentInsertionDiameter], 0) = 0 THEN EE.[StentInsertionDiameter] ELSE ER.[StentInsertionDiameter] END),
				@StentInsertionDiameterUnits	= (CASE WHEN IsNull(ER.[StentInsertionDiameterUnits], 0) = 0 THEN EE.[StentInsertionDiameterUnits] ELSE ER.[StentInsertionDiameterUnits] END),
				@StentInsertionBatchNo			= (CASE WHEN IsNull(ER.[StentInsertionBatchNo], '') = '' THEN EE.[StentInsertionBatchNo] ELSE ER.[StentInsertionBatchNo] END),
				@CorrectStentPlacement			= (CASE WHEN IsNull(ER.[CorrectStentPlacement], 0) = 0 THEN EE.[CorrectStentPlacement] ELSE ER.[CorrectStentPlacement] END),
				@StentPlacementFailureReason	= (SELECT isnull((CASE WHEN IsNull(ER.[StentPlacementFailureReason], '') = '' THEN EE.[StentPlacementFailureReason] ELSE ER.[StentPlacementFailureReason] END), '') as [text()] FOR XML PATH('')),
				@StentRemoval					= (CASE WHEN IsNull(ER.[StentRemoval], 0) = 0 THEN EE.[StentRemoval] ELSE ER.[StentRemoval] END),
				@StentRemovalTechnique			= (CASE WHEN IsNull(ER.[StentRemovalTechnique], 0) = 0 THEN EE.[StentRemovalTechnique] ELSE ER.[StentRemovalTechnique] END),
				@EMR							= (CASE WHEN IsNull(ER.[EMR], 0) = 0 THEN EE.[EMR] ELSE ER.[EMR] END),
				@EMRType						= (CASE WHEN IsNull(ER.[EMRType], 0) = 0 THEN EE.[EMRType] ELSE ER.[EMRType] END),
				@EMRFluid						= (CASE WHEN IsNull(ER.[EMRFluid], 0) = 0 THEN EE.[EMRFluid] ELSE ER.[EMRFluid] END),
				@EMRFluidVolume					= (CASE WHEN IsNull(ER.[EMRFluidVolume], 0) = 0 THEN EE.[EMRFluidVolume] ELSE ER.[EMRFluidVolume] END),
				@RFA							= (CASE WHEN IsNull(ER.[RFA], 0) = 0 THEN EE.[RFA] ELSE ER.[RFA] END),
				@RFAType						= (CASE WHEN IsNull(ER.[RFAType], 0) = 0 THEN EE.[RFAType] ELSE ER.[RFAType] END),
				@RFATreatmentFrom				= (CASE WHEN IsNull(ER.[RFATreatmentFrom], 0) = 0 THEN EE.[RFATreatmentFrom] ELSE ER.[RFATreatmentFrom] END),				
				@RFATreatmentTo					= (CASE WHEN IsNull(ER.[RFATreatmentTo], 0) = 0 THEN EE.[RFATreatmentTo] ELSE ER.[RFATreatmentTo] END),				
				@RFAEnergyDel					= (CASE WHEN IsNull(ER.[RFAEnergyDel], 0) = 0 THEN EE.[RFAEnergyDel] ELSE ER.[RFAEnergyDel] END),
				@RFANumSegTreated				= (CASE WHEN IsNull(ER.[RFANumSegTreated], 0) = 0 THEN EE.[RFANumSegTreated] ELSE ER.[RFANumSegTreated] END),
				@RFANumTimesSegTreated			= (CASE WHEN IsNull(ER.[RFANumTimesSegTreated], 0) = 0 THEN EE.[RFANumTimesSegTreated] ELSE ER.[RFANumTimesSegTreated] END),
				@pHProbeInsert					= (CASE WHEN IsNull(ER.[pHProbeInsert], 0) = 0 THEN EE.[pHProbeInsert] ELSE ER.[pHProbeInsert] END),
				@pHProbeInsertAt				= (CASE WHEN IsNull(ER.[pHProbeInsertAt], 0) = 0 THEN EE.[pHProbeInsertAt] ELSE ER.[pHProbeInsertAt] END),
				@pHProbeInsertChk				= (CASE WHEN IsNull(ER.[pHProbeInsertChk], 0) = 0 THEN EE.[pHProbeInsertChk] ELSE ER.[pHProbeInsertChk] END),
				@pHProbeInsertChkTopTo			= (CASE WHEN IsNull(ER.[pHProbeInsertChkTopTo], 0) = 0 THEN EE.[pHProbeInsertChkTopTo] ELSE ER.[pHProbeInsertChkTopTo] END),
				@Haemospray						= (CASE WHEN IsNull(ER.[Haemospray], 0) = 0 THEN EE.[Haemospray] ELSE ER.[Haemospray] END),
				@Sigmoidopexy					= (CASE WHEN IsNull(ER.[Sigmoidopexy], 0) = 0 THEN EE.[Sigmoidopexy] ELSE ER.[Sigmoidopexy] END),
				@SigmoidopexyQty				= (CASE WHEN IsNull(ER.[SigmoidopexyQty], 0) = 0 THEN EE.[SigmoidopexyQty] ELSE ER.[SigmoidopexyQty] END),
				@SigmoidopexyMake				= (CASE WHEN IsNull(ER.[SigmoidopexyMake], 0) = 0 THEN EE.[SigmoidopexyMake] ELSE ER.[SigmoidopexyMake] END),
				@SigmoidopexyFluidsDays			= (CASE WHEN IsNull(ER.[SigmoidopexyFluidsDays], 0) = 0 THEN EE.[SigmoidopexyFluidsDays] ELSE ER.[SigmoidopexyFluidsDays] END),
				@SigmoidopexyAntibioticsDays	= (CASE WHEN IsNull(ER.[SigmoidopexyAntibioticsDays], 0) = 0 THEN EE.[SigmoidopexyAntibioticsDays] ELSE ER.[SigmoidopexyAntibioticsDays] END),
				@Marking						= (CASE WHEN IsNull(ER.[Marking], 0) = 0 THEN EE.[Marking] ELSE ER.[Marking] END),
				--MH added on 19 Oct 2021
				--MH added on 19 Oct 2021 - later changed on 26 Nov 2021
				@TattooLocationDistal      = (CASE WHEN IsNull(ER.[TattooLocationDistal], 0) = 0 THEN EE.[TattooLocationDistal] ELSE ER.[TattooLocationDistal] END), 
				@TattooLocationProximal      = (CASE WHEN IsNull(ER.[TattooLocationProximal], 0) = 0 THEN EE.[TattooLocationProximal] ELSE ER.[TattooLocationProximal] END), 

				--MH added on 20 Oct 2021
				@MarkedQuantity    = (CASE WHEN IsNull(ER.[MarkedQuantity], 0) = 0 THEN EE.[MarkedQuantity] ELSE ER.[MarkedQuantity] END), 

				@MarkingType					= (CASE WHEN IsNull(ER.[MarkingType], 0) = 0 THEN EE.[MarkingType] ELSE ER.[MarkingType] END),
				@Clip							= (CASE WHEN IsNull(ER.[Clip], 0) = 0 THEN EE.[Clip] ELSE ER.[Clip] END),
				@ClipNum						= (CASE WHEN IsNull(ER.[ClipNum], 0) = 0 THEN EE.[ClipNum] ELSE ER.[ClipNum] END),
				@Other							= (SELECT isnull((CASE WHEN IsNull(ER.[Other], '') = '' THEN EE.[Other] ELSE ER.[Other] END), '') as [text()] FOR XML PATH('')),
				@EUSProcType					= (CASE WHEN IsNull(ER.[EUSProcType], 0) = 0 THEN EE.[EUSProcType] ELSE ER.[EUSProcType] END),
				@EndoClot						= (CASE WHEN IsNull(ER.[EndoClot], 0) = 0 THEN EE.[EndoClot] ELSE ER.[EndoClot] END),
				@ColonicDecompression			= (CASE WHEN IsNull(ER.[ColonicDecompression], 0) = 0 THEN EE.[ColonicDecompression] ELSE ER.[ColonicDecompression] END),
				@FlatusTubeInsertion			= (CASE WHEN IsNull(ER.[FlatusTubeInsertion], 0) = 0 THEN EE.[FlatusTubeInsertion] ELSE ER.[FlatusTubeInsertion] END),
				@PancolonicDyeSpray				= (CASE WHEN IsNull(ER.[PancolonicDyeSpray], 0) = 0 THEN EE.[PancolonicDyeSpray] ELSE ER.[PancolonicDyeSpray] END),
				@BougieDilation					= (CASE WHEN IsNull(ER.[BougieDilation], 0) = 0 THEN EE.[BougieDilation] ELSE ER.[BougieDilation] END),
				@EndoscopicResection			= (CASE WHEN IsNull(ER.[EndoscopicResection], 0) = 0 THEN EE.[EndoscopicResection] ELSE ER.[EndoscopicResection] END),
				@FineNeedleAspiration		    = (CASE WHEN IsNull(ER.FineNeedleAspiration, 0) = 0 THEN EE.FineNeedleAspiration ELSE ER.FineNeedleAspiration END),
				@FineNeedleAspirationType	    = (CASE WHEN IsNull(ER.FineNeedleAspirationType, 0) = 0 THEN EE.FineNeedleAspirationType ELSE ER.FineNeedleAspirationType END),
				@FineNeedleBiopsy			    = (CASE WHEN IsNull(ER.FineNeedleBiopsy, 0) = 0 THEN EE.FineNeedleBiopsy ELSE ER.FineNeedleBiopsy END),
				@Homeostasis					= (CASE WHEN ISNULL(ER.[Homeostasis], 0) = 0 THEN EE.[Homeostasis] ELSE ER.[Homeostasis] END),
				@HomeostasisType				= (CASE WHEN ISNULL(ER.[HomeostasisType], 0) = 0 THEN EE.[HomeostasisType] ELSE ER.[HomeostasisType] END),
				@Diverticulotomy				= (CASE WHEN ISNULL(ER.[Diverticulotomy], 0) = 0 THEN EE.[Diverticulotomy] ELSE ER.[Diverticulotomy] END),
				@GastricBalloonInsertion		= ISNULL(EE.[GastricBalloonInsertion], 0)
			FROM eeRecord AS EE
	  INNER JOIN #tmp_UpperGITherapeutics AS ER ON EE.SiteId = ER.SiteId
	 
	SELECT @Area = m.Area FROM dbo.ERS_AbnormalitiesMatrixUpperGI m LEFT JOIN dbo.ERS_Regions r ON m.Region = r.Region LEFT JOIN dbo.ERS_Sites s ON r.RegionId  = s.RegionID  WHERE s.siteId = @SiteId;
	
	IF @None = 1
		SET @summary = @summary + 'No therapeutic procedures'
	ELSE
	BEGIN
		IF @YAGLaser = 1
			BEGIN
			SET @msg =' YAG Laser'
			SET @Details = ''
			IF @YAGLaserWatts > 0 SET @Details = @Details + ' ' + CAST(@YAGLaserWatts as varchar(50)) + 'W'
			IF @YAGLaserSecs > 0 SET @Details = @Details + ' for ' + cast(CAST(@YAGLaserSecs AS FLOAT) as varchar(50)) + CASE WHEN @YAGLaserSecs <= 1 THEN ' second' else ' seconds' END
			IF @YAGLaserPulses > 0 SET @Details = @Details + ' in ' + cast(@YAGLaserPulses as varchar(50)) + CASE WHEN @YAGLaserPulses <= 1 THEN ' pulse' else ' pulses' END
			IF @YAGLaserKJ > 0 SET @Details = @Details + ' ('+ cast(CAST(@YAGLaserKJ AS FLOAT) as varchar(50)) + 'kJ)'
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + @br
			END
		
		IF @ArgonBeamDiathermy= 1
			BEGIN
			SET @msg ='  Argon beam diathermy'
			SET @Details = ''
			IF @ArgonBeamDiathermyWatts > 0 SET @Details = @Details + ' ' + cast(@ArgonBeamDiathermyWatts as varchar(50)) + 'W'
			IF @ArgonBeamDiathermySecs > 0 SET @Details = @Details + ' for ' + cast(CAST(@ArgonBeamDiathermySecs AS FLOAT) as varchar(50)) + CASE WHEN @ArgonBeamDiathermySecs <= 1 THEN ' second' else ' seconds' END
			IF @ArgonBeamDiathermyPulses > 0 SET @Details = @Details + ' in ' + cast(@ArgonBeamDiathermyPulses as varchar(50)) + CASE WHEN @ArgonBeamDiathermyPulses <= 1 THEN ' pulse' else ' pulses' END
			IF @ArgonBeamDiathermyKJ > 0 SET @Details = @Details + ' ('+ cast(CAST(@ArgonBeamDiathermyKJ AS FLOAT) as varchar(50)) + 'kJ)'
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
			END

			
		IF @Injection= 1
			BEGIN
			SET @msg =' Injection therapy'
			SET @Details = ''
			IF @InjectionVolume > 0 SET @Details = @Details + '  ' + cast(@InjectionVolume as varchar(50)) + 'ml'
			IF @InjectionVolume > 0  AND @InjectionType > 0 SET @Details = @Details + ' of'
			IF @InjectionType > 0 SET @Details = @Details + ' ' +   (SELECT [ListItemText] FROM dbo.ERS_Lists WHERE ListDescription = 'Agent Upper GI' AND [ListItemNo] = @InjectionType)
			IF @InjectionVolume> 0  AND @InjectionNumber > 0 SET @Details = @Details + ' via'
			IF @InjectionNumber >0 SET @Details = @Details + ' ' + CASE WHEN @InjectionNumber > 1 THEN cast(@InjectionNumber as varchar(50)) + ' injections' ELSE cast(@InjectionNumber as varchar(50)) + ' injection' END
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
	    IF @Homeostasis = 1
			BEGIN
			SET @msg =' Homeostasis'
			SET @Details = ''
			IF @HomeostasisType > 0 SET @Details = @Details + ' ' +   (SELECT [ListItemText] FROM dbo.ERS_Lists WHERE ListDescription = 'Homeostasis' AND [ListItemNo] = @HomeostasisType)
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
	
		IF @Polypectomy= 1  
			BEGIN
			SET @msg =' Polypectomy'
			SET @Details = ''
			DECLARE @Se bit, @SeExcised int, @Pe bit, @PeExcised int, @Su bit, @SuExcised int, @countExcised int = 0
			SELECT @Se = [Sessile],@SeExcised =[SessileNumExcised], @Pe = [Pedunculated], @PeExcised= [PedunculatedNumExcised], @Su =[Submucosal], @SuExcised = [SubmucosalNumExcised] FROM [ERS_UpperGIAbnoPolyps] WHERE SiteId =@SiteId
			IF @Se =1 AND @SeExcised <> null SET @countExcised= @countExcised + @SeExcised 
			IF  @Pe = 1 AND @PeExcised <> null SET @countExcised= @countExcised + @peExcised
			IF  @Su = 1 AND @suExcised <> null SET @countExcised= @countExcised + @suExcised

			IF @countExcised > 0 SET @Details = @Details + cast(@countExcised as varchar(50)) +' excised '

			IF @PolypectomyRemoval <> 0 OR @PolypectomyRemovalType <> 0
			BEGIN
			SET @Details = @Details + '('
            IF @PolypectomyRemoval = 1 SET @Details = @Details + 'removed entirely ' ELSE IF @PolypectomyRemoval = 2 SET @Details = @Details + 'removed piecemeal '
			IF @PolypectomyRemovalType = 1 SET @Details = @Details + ' using partial snare'
			ELSE IF  @PolypectomyRemovalType = 2 SET @Details = @Details + 'using cold snare'
			ELSE IF  @PolypectomyRemovalType = 3 SET @Details = @Details + 'using hot snare cauterisation'
			ELSE IF  @PolypectomyRemovalType = 4 SET @Details = @Details + 'using hot biopsy'
			ELSE IF  @PolypectomyRemovalType = 5 SET @Details = @Details + 'using cold biopsy'
			ELSE IF  @PolypectomyRemovalType = 6 SET @Details = @Details + 'using hot snare EMR'
			ELSE IF  @PolypectomyRemovalType = 7 SET @Details = @Details + 'using cold snare by EMR'
			SET @Details = @Details + ')'
			END

			If @Details<>'' SET @msg = @msg + ': ' + @Details
				--Add full stop 
				SET @msg = RTrim(LTRIM(@msg))
				IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
				--------------
				SET @summary = @summary + @msg + @br
			exec specimens_ogd_summary_update @SiteId
		END

		IF @BandingPiles= 1
		BEGIN 
			SET @msg = CASE WHEN @BandingNum > 1 THEN ': ' + CAST(@BandingNum as varchar(5)) + ' bands'
							WHEN @BandingNum = 1 THEN ': ' + CAST(@BandingNum as varchar(5)) + ' band'
							ELSE ''
						END
			--Add full stop 
			SET @msg = 'Banding of piles' + RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

	
		IF @Diathermy = 1
		BEGIN
			SET @msg = ' Diathermy'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg 
		--------------  
		if @DiathermyWatt <> 0 Set @msg =   ' ' + @msg + ' ' + cast(@DiathermyWatt as varchar(10)) + ' Watt.'

		SET @summary = @summary + @msg + @br  
		END  

		
		
		IF @Diverticulotomy = 1
			BEGIN
			SET @msg =' Diverticulotomy'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		
		
		IF @GastricBalloonInsertion = 1
			BEGIN
			SET @msg =' Gastric balloon insertion'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
  
	-- ## Valve
	  IF @Valve = 1  
	  BEGIN  
	   SET @msg = 'Valve'  
	   if @ValveQty <> 0 Set @msg2 = ' ' + cast(@ValveQty as varchar(10))
	   if @ValveType <> 0 Set @msg2 = @msg2 + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'BRT Valve Type' AND [ListItemNo] = @ValveType)  
	   Set @msg2 = ltrim(rtrim(@msg2))
	   if @msg2 <> '' Set @msg = @msg2 + ' Valve.' else Set @msg = 'Valve.'

	   SET @summary = @summary + @msg +  @br  
	  END

	  --- ### Cryotherapy and PhotoDynamicTherapy
	  Set @msg = ''
	  set @msg2 = ''
	  if @Cryotherapy = 1 Set @msg2 = 'Cryotherapy'
	  if @PhotoDynamicTherapy = 1 
	  Begin
		if @msg2 <> '' Set @msg = @msg2 + ' and Photodynamic Therapy have been used.' else set @msg = 'Photodynamic Therapy has been used.'
	  end
	  else
	  begin
		if @msg2 <> '' Set @msg = @msg2 + ' has been used.'
	  end
	  if @msg <> '' Set @summary = @summary + @msg + @br

		-- ## Coil
		IF @Coil = 1  
		BEGIN  
		SET @msg = 'Coil'  
		if @CoilQty <> 0 Set @msg2 = ' ' + cast(@CoilQty as varchar(10))
		if @CoilType <> 0 Set @msg2 = @msg2 + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'BRT Coil Type' AND [ListItemNo] = @CoilType)  
		Set @msg2 = ltrim(rtrim(@msg2))
		if @msg2 <> '' Set @msg = @msg2 + ' Coil.' else Set @msg = 'Coil.'

			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @BicapElectro = 1
		BEGIN
			SET @msg = ' Bicap electrocautery'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @HeatProbe = 1
		BEGIN
			SET @msg = ' Heater probe coagulation'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		--IF @BallDil = 1
		--	BEGIN
		--	SET @msg = ' Balloon dilatation'
		--	--Add full stop 
		--	SET @msg = RTrim(LTRIM(@msg))
		--	IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
		--	--------------
		--	SET @summary = @summary + @msg + @br
		--END
		
		IF @HotBiopsy = 1
		BEGIN
			SET @msg = ' Hot biopsy'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
		IF @BandLigation = 1
		BEGIN			
			SET @msg = ' Band ligation'
			IF @BandLigationPerformed > 0 SET @msg = @msg + ' performed ' + CAST(@BandLigationPerformed AS VARCHAR(100)) + CASE WHEN @BandLigationPerformed = 1 THEN ' procedure' ELSE ' procedures' END
			IF @BandLigationPerformed > 0 AND @BandLigationSuccess > 0 SET @msg = @msg + ' and ' + CAST(@BandLigationSuccess AS VARCHAR(100)) + CASE WHEN @BandLigationPerformed = 1 THEN ' was successful.' ELSE ' were successful.' END 
				ELSE IF @BandLigationPerformed = 0 AND @BandLigationSuccess > 0 SET @msg = @msg + ' ' + CAST(@BandLigationSuccess AS VARCHAR(100)) + CASE WHEN @BandLigationPerformed = 1 THEN ' procedure was successful.' ELSE ' procedures were successful.' END 
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br			
		END

		IF @BalloonDilation = 1
		BEGIN
			SET @msg = ' Balloon Dilation'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @BotoxInjection = 1
		BEGIN
			SET @msg = ' Botox injection'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @EndoscopicResection = 1
		BEGIN
			SET @msg = ' Endoscopic resection'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		-------------------------------
        -- FNA
        -------------------------------
		IF @FineNeedleAspiration= 1
		BEGIN
			SET @msg =' FNA'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		-------------------------------
        -- FNB
        -------------------------------
		IF @FineNeedleBiopsy= 1
		BEGIN
			SET @msg =' FNB'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @EndoloopPlacement = 1
		BEGIN
			SET @msg = ' Endoloop placement'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @ForeignBody = 1
		BEGIN
			SET @msg = ' Foreign body removal'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @StentInsertion= 1
			BEGIN
			SET @msg =' Stent insertion'
			SET @Details = ''
			IF @StentInsertionQty > 0 SET @Details = @Details + '  ' + cast(@StentInsertionQty as varchar(50))
			IF @StentInsertionType > 0 
				BEGIN
				IF @Area = 'Oesophagus'	 SET @Details = @Details + ' ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Therapeutic Stent Insertion Types' AND [ListItemNo] = @StentInsertionType)
				ELSE SET @Details = @Details + ' ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Therapeutic Stomach Stent Insertion Types' AND [ListItemNo] = @StentInsertionType)
				END	
			IF @StentInsertionLength > 0 AND @StentInsertionDiameter > 0 
				BEGIN
				SET @Details = @Details + ' (' 
				IF @StentInsertionLength > 0 SET @Details = @Details + ' length ' + cast(@StentInsertionLength as varchar(50)) + 'cm'
				IF @StentInsertionDiameter > 0 SET @Details = @Details + ', ' 
				SET @Details = @Details + ' diameter ' + cast(@StentInsertionDiameter as varchar(50))
				IF @StentInsertionDiameterUnits >= 0 SET @Details = @Details+ ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Oesophageal dilatation units' AND [ListItemNo] = @StentInsertionDiameterUnits)
				SET @Details = @Details + ')' 
				END
			IF @StentInsertionBatchNo <> ''  SET @Details = @Details + ' batch ' + LTRIM(RTRIM(@StentInsertionBatchNo))
			
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @StentRemoval= 1
			BEGIN
			SET @msg =' Stent removal'
			SET @Details = ''
			IF @StentRemovalTechnique > 0  SET @Details = @Details + 'using ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Therapeutic Stent Removal Technique' AND [ListItemNo] = @StentRemovalTechnique)
			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @EMR= 1
			BEGIN
			IF @EMRType = 3
				SET @msg =' Endoscopic full thickness resection'
			ELSE IF @EMRType = 2
				SET @msg =' Endoscopic submucosal dissection'
			ELSE IF @EMRType = 1
				SET @msg =' Endoscopic mucosal resection'
			SET @Details = ''
			IF @EMRFluid > 0  SET @Details = @Details + 'using ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Therapeutic EMR Fluid' AND [ListItemNo] = @EMRFluid)
			IF @EMRFluidVolume >0 
				BEGIN
				IF @EMRFluid >0 SET  @Details = @Details + ', '
				SET  @Details = @Details + 'total volume ' + cast(@emrfluidvolume AS varchar(50)) + 'ml'
				END
			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		
		IF @OesophagealDilatation= 1
			BEGIN
			SET @msg =' Oesophageal dilatation'
			SET @Details = ''
			IF @DilatedTo > 0  SET @Details = @Details + ' dilated to ' + cast(@dilatedto as varchar(50)) +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Oesophageal dilatation units' AND [ListItemNo] = @DilatationUnits)
			IF @DilatorType > 0
				BEGIN
				DECLARE @DilatorStr varchar(500) = (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Oesophageal dilator' AND [ListItemNo] = @DilatorType)
				IF @DilatorStr like 'with%' OR @DilatorStr like 'by%'  SET @Details = @Details + ' ' +  @DilatorStr
				ELSE SET @Details = @Details + ' with ' +  @DilatorStr
				END
			IF @DilatorScopePass = 1 SET  @Details = @Details + '(scope could pass)'
			
			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @VaricealSclerotherapy= 1
			BEGIN
			SET @msg =' Oesophagus variceal sclerotherapy'
			SET @Details = ''
			IF @VaricealSclerotherapyInjectionVol > 0  SET @Details = @Details + ' ' + cast(@VaricealSclerotherapyInjectionVol as varchar(50)) + 'ml' 
			IF @VaricealSclerotherapyInjectionVol > 0 AND  @VaricealSclerotherapyInjectiontype > 0  SET @Details = @Details + ' of'
			IF @VaricealSclerotherapyInjectiontype > 0 SET @Details = @Details + ' ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Agent Upper GI' AND [ListItemNo] = @VaricealSclerotherapyInjectiontype)
			IF @VaricealSclerotherapyInjectionVol > 0 AND  @VaricealSclerotherapyInjectionNum > 0  SET @Details = @Details + ' via'
			IF @VaricealSclerotherapyInjectionNum > 0 SET @Details = @Details + ' ' + CASE WHEN @VaricealSclerotherapyInjectionNum >1 THEN CAST(@VaricealSclerotherapyInjectionNum as varchar(50))+' injections' ELSE  CAST(@VaricealSclerotherapyInjectionNum as varchar(50))+' injection' END
			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @VaricealBanding= 1
			BEGIN
			IF @Area ='Oesophagus' SET @msg =' Oesophagus variceal banding' ELSE SET @msg =' Gastric variceal banding'
			SET @Details = ''
			IF @VaricealBandingNum > 0 SET @Details = @Details + ' ' + CASE WHEN @VaricealBandingNum >1 THEN CAST(@VaricealBandingNum as varchar(50))+' bands' ELSE  CAST(@VaricealBandingNum as varchar(50)) + ' band' END
			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @RFA = 1
			BEGIN
			SET @msg =' Radio Frequency Ablation'
			SET @Details = ''
			IF @RFAType = 1	SET @Details = @Details + ' circumferential'
			ELSE IF @RFAType = 2 SET @Details = @Details + ' focal'
			IF ISNULL(@RFAEnergyDel,0) <> 0 SET @Details = @Details + ', ' + cast(@RFAEnergyDel as varchar(50)) + ' joules'
			IF ISNULL(@RFANumSegTreated,0) <> 0
				BEGIN
				SET @Details = @Details + ' delivered to ' + cast(@RFANumSegTreated as varchar(50))
				IF @RFAType =1 SET @Details = @Details + ' x 3cm'
				SET @Details = @Details + ' segment'
				IF @RFANumSegTreated > 1 SET @Details = @Details + 's'
				END
			IF ISNULL(@RFANumTimesSegTreated,0)<>0
				BEGIN
				SET @Details = @Details + ', treated '
				If @RFANumTimesSegTreated = 1 SET @Details = @Details + 'once'
				ELSE SET @Details = @Details + cast(@RFANumTimesSegTreated as varchar(50)) + ' times'
				END
			IF ISNULL(@RFATreatmentFrom,0) <>0 OR ISNULL(@RFATreatmentTo,0) <>0
				BEGIN
				IF ISNULL(@RFATreatmentFrom,0) <> 0  SET @Details = @Details + ', starting at ' + cast(@RFATreatmentFrom as varchar(50)) +' cm'
				IF ISNULL(@RFATreatmentTo,0) <> 0 
				BEGIN
				IF ISNULL(@RFATreatmentFrom,0) <> 0 SET @Details = @Details + ' and ending at ' + cast(@RFATreatmentTo as varchar(50)) +' cm'
				ELSE  SET @Details = @Details + ' ending at ' + cast(@RFATreatmentTo as varchar(50)) +' cm'
				END
				SET @Details = @Details + ' from the incisors'
				END				

			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @GastrostomyInsertion =1
			BEGIN
			DECLARE @G bit, @J bit, @N bit
			SELECT @j = i.[JejunostomyInsertion], @G =i.[GastrostomyInsertion],@N = i.[NasoDuodenalTube] FROM [ERS_UpperGIIndications] i LEFT JOIN [ERS_Sites] s ON i.ProcedureId = s.ProcedureId WHERE s.SiteId = @SiteID
			IF @N = 1 SET @msg =' Nasojejunal tube (NJT)' ELSE IF @J= 1 SET @msg =' Jejunostomy insertion (PEJ)' ELSE SET @msg =' Gastrostomy insertion (PEG)'
			SET @Details = ''

			IF @GastrostomyInsertionType > 0
				BEGIN
				IF @GastrostomyInsertionSize>0
					BEGIN
					SET @Details = @Details + cast(@GastrostomyInsertionSize as varchar(50))
					IF @J=1 SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG units' AND [ListItemNo] = @GastrostomyInsertionUnits)
					ELSE IF @N =1 SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG units' AND [ListItemNo] = @GastrostomyInsertionUnits)
					ELSE SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG units' AND [ListItemNo] = @GastrostomyInsertionUnits)
					END
				END
				IF @GastrostomyInsertionType>0
						BEGIN
						IF @J=1 SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG type' AND [ListItemNo] = @GastrostomyInsertiontype)
						ELSE IF @N =1 SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG type' AND [ListItemNo] = @GastrostomyInsertiontype)
						ELSE SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG type' AND [ListItemNo] = @GastrostomyInsertiontype)
						END
				IF ISNULL(@GastrostomyInsertionBatchNo, '') <> ''  SET @Details = @Details + ' batch ' + @GastrostomyInsertionBatchNo
				
				IF @CorrectPEGPlacement = 2 SET @Details = @Details + ' incorrectly placed ' + isnull(@PEGPlacementFailureReason, '')
				    
				
				IF @Details<>'' SET @msg = @msg + ': ' + @Details
				--Add full stop 
				SET @msg = RTrim(LTRIM(@msg))
				IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
				--------------
				SET @summary = @summary + @msg + @br
				END

		IF @GastrostomyRemoval = 1
		BEGIN
			SET @msg =' Gastrostomy PEG Removal'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		IF @PyloricDilatation= 1
		BEGIN
			SET @msg =' Pyloric dilatation'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @NGNJInsertion = 1 
		BEGIN
			Set @msg = ' NG/NJ tube insertion'
			IF isnull(@NGNJTubeBatch, '') <> '' 
				SET @msg = @msg + ' (batch ' + @NGNJTubeBatch + ')'
			IF isnull(@NGNJTubeLength, 0) > 0
			BEGIN
				SET @msg = @msg + '. Tube length ' + convert(varchar, @NGNJTubeLength) + 'cm'
				IF isnull(@NGNJTubeNostril, 0) > 0
				BEGIN
					SELECT @msg = @msg + CASE WHEN @NGNJTubeNostril = 1 THEN ' at the right nostril'
											  WHEN @NGNJTubeNostril = 2 THEN ' at the left nostril'
										 END
				END
			END
			ELSE
			BEGIN
				IF isnull(@NGNJTubeNostril, 0) > 0
				BEGIN
					SELECT @msg = @msg + CASE WHEN @NGNJTubeNostril = 1 THEN ' via the right nostril'
											  WHEN @NGNJTubeNostril = 2 THEN ' via the left nostril'
										 END
				END
			END
			IF isnull(@NGNJTubeBridle, 0) = 1 
				SET @msg = @msg + ', bridle used'

			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @pHProbeInsert= 1
			BEGIN
			SET @msg =' pH probe insertion'
			SET @Details = ''
			IF @pHProbeInsertAt > 0 SET @Details = @Details + ' inserted at ' + CAST(@pHProbeInsertAt as varchar(50))+' cm'
			IF ISNULL(@pHProbeInsertChkTopTo,0) <> 0 
			BEGIN
				IF @Details <> '' SET @Details = @Details + ', '
				SET @Details = @Details + 'endoscopic check performed, top of probe at ' + CAST(@pHProbeInsertChkTopTo as varchar(50))+' cm'
			END
			--ELSE  SET @Details = @Details + ', insertion checked endoscopically'

			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @Haemospray= 1
		BEGIN
			SET @msg =' Haemospray'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @Sigmoidopexy= 1
		BEGIN
			
			SET @msg =' Sigmoidopexy'
			SET @Details = ''
			IF @SigmoidopexyQty > 0 SET @Details = @Details + CONVERT(VARCHAR, @SigmoidopexyQty)
			IF @SigmoidopexyMake > 0 SET @Details = @Details + ' ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Sigmoidopexy make' AND [ListItemNo] = @SigmoidopexyMake)

			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @Marking= 1
		BEGIN
			--MH added on 19 Oct 2021
			Declare @TattoLocationMessage varchar(50)
			Declare @TattoMessage varchar(100)
			declare @MaxId int, @MinId int, @loopCounter int

			Set @TattoLocationMessage = ''
			Set @TattoMessage = ''
			If @TattooLocationDistal > 0 
			Begin
				Set @TattoLocationMessage = 'Distal'
			End

			If @TattooLocationProximal > 0 
			Begin
				if @TattoLocationMessage = ''			
					begin
						Set @TattoLocationMessage = 'Proximal'
					end
				else
					begin
						Set @TattoLocationMessage = @TattoLocationMessage + ',Proximal'
					end		
			End

			Select @MinId = Min(id),@MaxId=Max(id) from fnSplitString(@TattoLocationMessage,',') 
			Set @loopCounter = @MinId
			While @loopCounter < (@MaxId+1)
			begin
				if @loopCounter = 1
				begin
					Set @TattoMessage = (Select Item from fnSplitString(@TattoLocationMessage,',') Where Id = @loopCounter)
				end
				else
				begin
					if @loopCounter <> @MaxId 
					begin
						Set @TattoMessage = @TattoMessage + ', ' + (Select Item from fnSplitString(@TattoLocationMessage,',') Where Id = @loopCounter)
					end
					else
					begin
						Set @TattoMessage = @TattoMessage + ' and ' + (Select Item from fnSplitString(@TattoLocationMessage,',') Where Id = @loopCounter)
					end

				end

				set @loopCounter = @loopCounter + 1
			END

			SET @msg =' Abnormality marked'
			SET @Details = ''
			IF @MarkingType > 0 SET @Details = @Details + ' by ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Abno marking' AND [ListItemNo] = @MarkingType)

			IF @Details<>'' SET @msg = @msg + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br

		END

		  If @MarkedQuantity > 0
		begin
			IF @summary <> '' SET @summary = @summary
			SET @summary = @summary + 'Total volume used ' + Convert(varchar(5),@MarkedQuantity) + ' ml.' + @br
		end
		
	  --MH added on 19 Oct 2021
	  If @TattoMessage <> ''
	  BEGIN		
		SET @summary = @summary + 'Tattoo located at ' + ISNULL(@TattoMessage, '') + @br		
	  End	  
		IF @Clip= 1
		BEGIN 
			SET @msg = CASE WHEN @ClipNum > 1 THEN  CAST(@ClipNum as varchar(5)) + ' clips'
							WHEN @ClipNum = 1 THEN  CAST(@ClipNum as varchar(5)) + ' clip'
							ELSE 'Clip'
						END
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
		IF @EndoClot = 1
		BEGIN 
			SET @msg = 'EndoClot used'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
		IF @ColonicDecompression = 1
		BEGIN 
			SET @msg = 'Colonic decompression'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
		IF @FlatusTubeInsertion = 1
		BEGIN 
			SET @msg = 'Flatus tube insertion'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
		IF @PancolonicDyeSpray = 1
		BEGIN 
			SET @msg = 'Pancolonic dye spray'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @BougieDilation = 1
		BEGIN 
			SET @msg = 'Bougie dilation'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
		IF LTRIM(RTRIM(@other)) <> ''
			BEGIN
			SET @msg =' ' + LTRIM(RTRIM(@other))
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary =  @summary + @msg  +@br
		END
		
		--Remove last <br />
		IF RIGHT(RTRIM(@summary),6) = '<br />'
		BEGIN
			SET @summary = RTRIM(@summary)
			SET @summary = LEFT(@summary, LEN(@summary) - 6)
		END

	--END
	
	-- Finally, update the summary in Therapeutics  table
	UPDATE dbo.ERS_UpperGITherapeutics 
	SET Summary=@summary 
	WHERE SiteId = @SiteId -- AND CarriedOutRole=1;	--### Summary text is Applicable only for TrainER....
	--WHERE Id = @TherapeuticId
	
	DECLARE @region VARCHAR(100)
	DECLARE @AreaNo INT
	DECLARE @insertionType VARCHAR(100)
	DECLARE @htmlAnchorCode VARCHAR(500)
	DECLARE @SummaryWithLinks VARCHAR(MAX)

	SELECT @region = CASE WHEN s.SiteNo = -77 THEN						--SiteNo is set to -77 for sites By Distance (Col & Sig only)
						CONVERT(VARCHAR,XCoordinate) +  
							CASE WHEN YCoordinate IS NULL OR YCoordinate=0 THEN ' cm' 
							ELSE (' to ' + CONVERT(VARCHAR,YCoordinate) + ' cm' ) 
							END
					ELSE (SELECT r.Region FROM ERS_Regions r WHERE r.RegionId = s.RegionId)
					END, 
			@AreaNo = ISNULL(AreaNo,0)
	FROM ERS_Sites s
	JOIN ERS_Procedures p ON s.ProcedureId = p.ProcedureId
	WHERE SiteId = @SiteId
	
	SET @htmlAnchorCode = '<a href="#" class="sitesummary" onclick="OpenSiteDetails(''' + @region + ''',' + CONVERT(VARCHAR(10),@SiteId) + ',''Therapeutic Procedures'', ''{0}'' , '''+ CONVERT(VARCHAR,@AreaNo) +  ''');">{1}</a>'

	SET @Summary = ''
	SET @SummaryWithLinks = ''
	DECLARE @SummaryHeading VARCHAR(200) = 'Post procedure patient care'
	
	IF @GastrostomyInsertion = 1
	BEGIN
		SET @insertionType = 'PEG'
		SET @SummaryHeading = 'Instructions for PEG care'
		IF @FlangePosition > 0 SET @Summary = 'Flange at ' + CONVERT(varchar, @FlangePosition) + ' cm.'
		IF @NilByMouth = 1
		BEGIN
			IF @Summary <> '' SET @Summary = @Summary + ' Nil by mouth' ELSE SET @Summary = 'Nil by mouth'
			IF @NilByMouthHrs > 0
			BEGIN
				SET @Summary = @Summary + ' for ' + CONVERT(varchar, @NilByMouthHrs)
				IF @NilByMouthHrs = 1
					SET @Summary = @Summary + ' hour'
				ELSE
					SET @Summary = @Summary + ' hours'
			END
		END
		IF @NilByProc = 1
		BEGIN
			IF @Summary <> '' SET @Summary = @Summary + ', nil by PEG' ELSE SET @Summary = 'Nil by PEG'
			IF @NilByProcHrs > 0
			BEGIN
				SET @Summary = @Summary + ' for ' + CONVERT(varchar, @NilByProcHrs)
				IF @NilByProcHrs = 1
					SET @Summary = @Summary + ' hour'
				ELSE
					SET @Summary = @Summary + ' hours'
			END
		END
		IF @Summary <> '' SET @Summary = @Summary + '.'
		IF @AttachmentToWard = 1
		BEGIN
			IF @Summary <> '' SET @Summary = @Summary + ' All attachments for feeding returned to the ward with patient.' ELSE SET @Summary = 'All attachments for feeding returned to the ward with patient.'
		END		
	END	
	ELSE
	BEGIN	
		IF @YAGLaser = 1
		BEGIN
			SET @insertionType = 'YAG'
			IF @OesoYAGNilByMouth = 1
			BEGIN
				SET @Summary = 'Nil by mouth'
				IF @OesoYAGNilByMouthHrs > 0
				BEGIN
					SET @Summary = @Summary + ' for ' + CONVERT(varchar, @OesoYAGNilByMouthHrs)
					IF @OesoYAGNilByMouthHrs = 1
						SET @Summary = @Summary + ' hour'
					ELSE
						SET @Summary = @Summary + ' hours'
				END
			END

			IF @OesoYAGWarmFluids = 1
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ', warm fluids only' ELSE SET @Summary = 'Warm fluids only'
				IF @OesoYAGWarmFluidsHrs > 0
				BEGIN
					SET @Summary = @Summary + ' for ' + CONVERT(varchar, @OesoYAGWarmFluidsHrs)
					IF @OesoYAGWarmFluidsHrs = 1
						SET @Summary = @Summary + ' hour'
					ELSE
						SET @Summary = @Summary + ' hours'
				END
			END

			IF @OesoYAGSoftDiet = 1
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ', soft diet' ELSE SET @Summary = 'Soft diet'
				IF @OesoYAGSoftDietDays > 0
				BEGIN
					SET @Summary = @Summary + ' for ' + CONVERT(varchar, @OesoYAGSoftDietDays)
					IF @OesoYAGSoftDietDays = 1
						SET @Summary = @Summary + ' day'
					ELSE
						SET @Summary = @Summary + ' days'
				END
			END

			IF @Summary <> '' SET @Summary = @Summary + '.'

			IF @OesoYAGMedicalReview = 1
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ' Medical review before discharge.' ELSE SET @Summary = 'Medical review before discharge.'
			END
		END

		IF @OesophagealDilatation = 1 OR @StentInsertion = 1
		BEGIN
			SET @insertionType = 'STENT'
			IF @OesoDilNilByMouth = 1
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ' Nil by mouth' ELSE SET @Summary = 'Nil by mouth'
				IF @OesoDilNilByMouthHrs > 0
				BEGIN
					SET @Summary = @Summary + ' for ' + CONVERT(varchar, @OesoDilNilByMouthHrs)
					IF @OesoDilNilByMouthHrs = 1
						SET @Summary = @Summary + ' hour'
					ELSE
						SET @Summary = @Summary + ' hours'
				END
			END

			IF @OesoDilWarmFluids = 1
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ', warm fluids only' ELSE SET @Summary = 'Warm fluids only'
				IF @OesoDilWarmFluidsHrs > 0
				BEGIN
					SET @Summary = @Summary + ' for ' + CONVERT(varchar, @OesoDilWarmFluidsHrs)
					IF @OesoDilWarmFluidsHrs = 1
						SET @Summary = @Summary + ' hour'
					ELSE
						SET @Summary = @Summary + ' hours'
				END
			END

			IF @OesoDilSoftDiet = 1
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ', soft diet' ELSE SET @Summary = 'Soft diet'
				IF @OesoDilSoftDietDays > 0
				BEGIN
					SET @Summary = @Summary + ' for ' + CONVERT(varchar, @OesoDilSoftDietDays)
					IF @OesoDilSoftDietDays = 1
						SET @Summary = @Summary + ' day'
					ELSE
						SET @Summary = @Summary + ' days'
				END
			END

			IF @OesoDilXRay = 1
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ', chest X-ray' ELSE SET @Summary = 'Chest X-ray'
				IF @OesoDilXRayHrs > 0
				BEGIN
					SET @Summary = @Summary + ' after ' + CONVERT(varchar, @OesoDilXRayHrs)
					IF @OesoDilXRayHrs = 1
						SET @Summary = @Summary + ' hour'
					ELSE
						SET @Summary = @Summary + ' hours'
				END
			END

			IF @Summary <> '' SET @Summary = @Summary + '.'

			IF @OesoDilMedicalReview = 1
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ' Medical review before discharge.' ELSE SET @Summary = 'Medical review before discharge.'
			END
		END

		IF @Sigmoidopexy= 1
		BEGIN
			SET @SummaryHeading = 'Ward instructions'
			IF ISNULL(@SigmoidopexyFluidsDays,0) > 0
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ' '
				SET @Summary = @Summary + 'Clear fluids for ' + CONVERT(varchar, @SigmoidopexyFluidsDays) 
								+ CASE WHEN @SigmoidopexyFluidsDays > 1 THEN ' days.' else ' day.' END
			END
			IF ISNULL(@SigmoidopexyAntibioticsDays,0) > 0
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ' '
				SET @Summary = @Summary + 'Antibiotics for ' + CONVERT(varchar, @SigmoidopexyAntibioticsDays) 
								+ CASE WHEN @SigmoidopexyAntibioticsDays > 1 THEN ' days.' ELSE ' day.' END
			END
		END
	END

	IF @Summary = '' SET @SummaryHeading = ''

	-- Finally, update the summary in PP_InstForCare  table
	UPDATE p
	SET PP_InstForCare = @Summary
		, PP_InstForCareHeading = @SummaryHeading
		, PP_InstForCareWithLinks = REPLACE(REPLACE(@htmlAnchorCode, '{0}', @insertionType), '{1}', @Summary)
	FROM ERS_ProceduresReporting p
	INNER JOIN ERS_Sites s ON p.ProcedureId = s.ProcedureId
	WHERE s.SiteId = @SiteId;

	DROP TABLE #tmp_UpperGITherapeutics;
 END
 GO

 PRINT N'Altering Procedure [dbo].[therapeutics_ercp_summary_update]...';
 GO

 ALTER PROCEDURE [dbo].[therapeutics_ercp_summary_update]
(
	@TherapeuticId AS INT,
	@SiteId INT
)
AS
	SET NOCOUNT ON
	DECLARE	  @msg		VARCHAR(1000)
			, @Details	VARCHAR(1000)
			, @Summary	VARCHAR(4000)=''
			, @Area		VARCHAR(500)=''
			, @br VARCHAR(6) = '<br />';

	DECLARE
	@None BIT,
	@YAGLaser BIT,
	@YAGLaserWatts INT,
	@YAGLaserPulses INT,
	@YAGLaserSecs decimal(8,2),
	@YAGLaserKJ decimal(8,2),
	@ArgonBeamDiathermy BIT,
	@ArgonBeamDiathermyWatts INT,
	@ArgonBeamDiathermyPulses INT,
	@ArgonBeamDiathermySecs decimal(8,2),
	@ArgonBeamDiathermyKJ decimal(8,2),		
	@HeatProbe BIT,					
	@BicapElectro BIT,				
	@Diathermy BIT,						
	@HotBiopsy BIT,
	@BandLigation BIT,
    @BandLigationPerformed INT,
	@BandLigationSuccess INT,
	@BotoxInjection BIT,
    @EndoloopPlacement BIT,
    @ForeignBody BIT,
	@Injection BIT,
	@InjectionType INT,
	@InjectionVolume INT,
	@InjectionNumber INT,
	@GastrostomyInsertion BIT,
	@GastrostomyInsertionSize numeric(9,2),
	@GastrostomyInsertionUnits TINYINT,
	@GastrostomyInsertionType TINYINT,
	@GastrostomyInsertionBatchNo VARCHAR(100),
	@GastrostomyRemoval BIT,
	@NilByMouth BIT,
	@NilByMouthHrs INT,
	@NilByProc BIT,
	@NilByProcHrs INT,
	@AttachmentToWard BIT,
	@PyloricDilatation BIT,	
	@StentInsertion BIT,
	@StentInsertionQty INT,
	@RadioactiveWirePlaced BIT,	
	@StentInsertionBatchNo VARCHAR(100),
	@StentRemoval BIT,
	@StentRemovalTechnique INT,
	@EMR BIT,
	@EMRType TINYINT,
	@EMRFluid INT,
	@EMRFluidVolume INT,
	@Marking BIT,
	@MarkingType INT,
	@Clip BIT,						
	@ClipNum INT,
	@Papillotomy BIT,
	@Sphincterotome TINYINT,
	@PapillotomyLength REAL,
	@PapillotomyAcceptBalloonSize REAL,
	@ReasonForPapillotomy TINYINT,
	@PapillotomyBleeding TINYINT,
	@SphincterDecompressed TINYINT,
	@PanOrificeSphincterotomy BIT,
	@StoneRemoval BIT,
	@RemovalUsing TINYINT,
	@ExtractionOutcome TINYINT,
	@InadequateSphincterotomy BIT,
	@StoneSize BIT,
	@QuantityOfStones BIT,
	@ImpactedStones BIT,
	@OtherReason BIT,
	@OtherReasonText VARCHAR(200),
	@StoneDecompressed TINYINT,
	@StrictureDilatation BIT,
	@DilatedTo REAL,
	@DilatationUnits TINYINT,
	@DilatorType TINYINT,
	@EndoscopicCystPuncture BIT,
	@CystPunctureDevice TINYINT,
	@CystPunctureVia TINYINT,
	@Cannulation BIT,
	@Manometry BIT,
	@Haemostasis BIT,
	@NasopancreaticDrain BIT,
	@RendezvousProcedure BIT,
	@SnareExcision SMALLINT,
	@BalloonDilation BIT,
	@BalloonDilatedTo REAL,
	@BalloonDilatationUnits SMALLINT,
	@BalloonDilatorType SMALLINT,
	@BalloonTrawl BIT,
	@BalloonTrawlDilatorType SMALLINT,
	@BalloonTrawlDilatorSize REAL,
	@BalloonTrawlDilatorUnits SMALLINT,
	@BalloonDecompressed TINYINT,
	@DiagCholangiogram SMALLINT,
	@DiagPancreatogram SMALLINT,
	@EndoscopistRole SMALLINT,
	@Other VARCHAR(1000),
	@EUSProcType SMALLINT,
	@CorrectStentPlacement bit,
	@CorrectStentPlacementNoReason int,
	@BalloonDilatation bit,
	@BougieDilatation bit,
	@BougieDilation bit,
	@BrushCytology bit,
	@Cholangioscopy bit,
	@StentChange bit,
	@StentPlacement bit,
	@RadioFrequencyAblation bit,
	@FineNeedleAspiration bit,
	@FineNeedleAspirationType tinyint,
	@FineNeedleBiopsy BIT,
	@Polypectomy BIT,
	@Diverticulotomy BIT

--BEGIN TRY

	SELECT * INTO #tmp_ERCPTherapeutics 
	FROM dbo.ERS_ERCPTherapeutics 
	WHERE (Id = @TherapeuticId OR SiteID = @SiteId)

--## 1) If 'CarriedOutRole=2 (EE)' record is found for a SiteId in [ERS_ERCPTherapeutics] means it has both EE/ER Entries...
	--IF EXISTS(SELECT 'ER' FROM dbo.ERS_ERCPTherapeutics WHERE SiteId=@SiteId AND CarriedOutRole=2)
		BEGIN
			--PRINT '[ERS_ERCPTherapeutics] has both EE/ER Entries...';
			;WITH eeRecord AS(
				SELECT * FROM #tmp_ERCPTherapeutics WHERE CarriedOutRole = (SELECT MAX(CarriedOutRole) FROM #tmp_ERCPTherapeutics) --## 2 is EE
			)
			SELECT
				@None				= (CASE WHEN IsNull(ER.[None], 0) = 0 THEN EE.[None] ELSE ER.[None] END),
				@YAGLaser			= (CASE WHEN IsNull(ER.YAGLaser, 0) = 0 THEN EE.YAGLaser ELSE ER.YAGLaser END),
				@YAGLaserWatts		= (CASE WHEN IsNull(ER.YAGLaserWatts, 0) = 0 THEN EE.YAGLaserWatts ELSE ER.YAGLaserWatts END),
				@YAGLaserPulses		= (CASE WHEN IsNull(ER.YAGLaserPulses, 0) = 0 THEN EE.YAGLaserPulses ELSE ER.YAGLaserPulses END),
				@YAGLaserSecs		= (CASE WHEN IsNull(ER.YAGLaserSecs, 0) = 0 THEN EE.YAGLaserSecs ELSE ER.YAGLaserSecs END),
				@YAGLaserKJ			= (CASE WHEN IsNull(ER.YAGLaserKJ, 0) = 0 THEN EE.YAGLaserKJ ELSE ER.YAGLaserKJ END),
				@ArgonBeamDiathermy	= (CASE WHEN IsNull(ER.ArgonBeamDiathermy, 0) = 0 THEN EE.ArgonBeamDiathermy ELSE ER.ArgonBeamDiathermy END),
				@ArgonBeamDiathermyWatts		= (CASE WHEN IsNull(ER.ArgonBeamDiathermyWatts, 0) = 0 THEN EE.ArgonBeamDiathermyWatts ELSE ER.ArgonBeamDiathermyWatts END),
				@ArgonBeamDiathermyPulses		= (CASE WHEN IsNull(ER.ArgonBeamDiathermyPulses, 0) = 0 THEN EE.ArgonBeamDiathermyPulses ELSE ER.ArgonBeamDiathermyPulses END),
				@ArgonBeamDiathermySecs			= (CASE WHEN IsNull(ER.ArgonBeamDiathermySecs, 0) = 0 THEN EE.ArgonBeamDiathermySecs ELSE ER.ArgonBeamDiathermySecs END),
				@ArgonBeamDiathermyKJ			= (CASE WHEN IsNull(ER.ArgonBeamDiathermyKJ, 0) = 0 THEN EE.ArgonBeamDiathermyKJ ELSE ER.ArgonBeamDiathermyKJ END),
				@HeatProbe			= (CASE WHEN IsNull(ER.HeatProbe, 0) = 0 THEN EE.HeatProbe ELSE ER.HeatProbe END),
				@BicapElectro		= (CASE WHEN IsNull(ER.BicapElectro, 0) = 0 THEN EE.BicapElectro ELSE ER.BicapElectro END),
				@Diathermy			= (CASE WHEN IsNull(ER.Diathermy, 0) = 0 THEN EE.Diathermy ELSE ER.Diathermy END),
				@HotBiopsy			= (CASE WHEN IsNull(ER.HotBiopsy, 0) = 0 THEN EE.HotBiopsy ELSE ER.HotBiopsy END),
				@BandLigation= (CASE WHEN IsNull(ER.BandLigation, 0) = 0 THEN EE.BandLigation ELSE ER.BandLigation END),
				@BandLigationPerformed			= (CASE WHEN ISNULL(ER.[BandLigationPerformed], 0) = 0 THEN ER.[BandLigationPerformed] ELSE EE.[BandLigationPerformed] END),
				@BandLigationSuccess			= (CASE WHEN ISNULL(ER.[BandLigationSuccessful], 0) = 0 THEN ER.[BandLigationSuccessful] ELSE EE.[BandLigationSuccessful] END),
				@BotoxInjection = (CASE WHEN IsNull(ER.BotoxInjection, 0) = 0 THEN EE.BotoxInjection ELSE ER.BotoxInjection END),
				@EndoloopPlacement = (CASE WHEN IsNull(ER.EndoloopPlacement, 0) = 0 THEN EE.EndoloopPlacement ELSE ER.EndoloopPlacement END),
				@ForeignBody= (CASE WHEN IsNull(ER.ForeignBody, 0) = 0 THEN EE.ForeignBody ELSE ER.ForeignBody END),
				@Injection			= (CASE WHEN IsNull(ER.Injection, 0) = 0 THEN EE.Injection ELSE ER.Injection END),
				@InjectionType		= (CASE WHEN IsNull(ER.InjectionType, 0) = 0 THEN EE.InjectionType ELSE ER.InjectionType END),
				@InjectionVolume	= (CASE WHEN IsNull(ER.InjectionVolume, 0) = 0 THEN EE.InjectionVolume ELSE ER.InjectionVolume END),
				@InjectionNumber	= (CASE WHEN IsNull(ER.InjectionNumber, 0) = 0 THEN EE.InjectionNumber ELSE ER.InjectionNumber END),
				@GastrostomyInsertion			= (CASE WHEN IsNull(ER.GastrostomyInsertion, 0) = 0 THEN EE.GastrostomyInsertion ELSE ER.GastrostomyInsertion END),
				@GastrostomyInsertionSize		= (CASE WHEN IsNull(ER.GastrostomyInsertionSize, 0) = 0 THEN EE.GastrostomyInsertionSize ELSE ER.GastrostomyInsertionSize END),
				@GastrostomyInsertionUnits		= (CASE WHEN ER.GastrostomyInsertionUnits IS NULL THEN EE.GastrostomyInsertionUnits ELSE ER.GastrostomyInsertionUnits END),
				@GastrostomyInsertionType		= (CASE WHEN IsNull(ER.GastrostomyInsertionType, 0) = 0 THEN EE.GastrostomyInsertionType ELSE ER.GastrostomyInsertionType END),
				@GastrostomyInsertionBatchNo	= (SELECT isnull((CASE WHEN IsNull(ER.GastrostomyInsertionBatchNo, '') = '' THEN EE.GastrostomyInsertionBatchNo ELSE ER.GastrostomyInsertionBatchNo END), '') as [text()] FOR XML PATH('')),
				@GastrostomyRemoval				= (CASE WHEN IsNull(ER.GastrostomyRemoval, 0) = 0 THEN EE.GastrostomyRemoval ELSE ER.GastrostomyRemoval END),
				@NilByMouth			= (CASE WHEN IsNull(ER.NilByMouth, 0) = 0 THEN EE.NilByMouth ELSE ER.NilByMouth END),
				@NilByMouthHrs		= (CASE WHEN IsNull(ER.NilByMouthHrs, 0) = 0 THEN EE.NilByMouthHrs ELSE ER.NilByMouthHrs END),
				@NilByProc			= (CASE WHEN IsNull(ER.NilByProc, 0) = 0 THEN EE.NilByProc ELSE ER.NilByProc END),
				@NilByProcHrs		= (CASE WHEN IsNull(ER.NilByProcHrs, 0) = 0 THEN EE.NilByProcHrs ELSE ER.NilByProcHrs END),
				@AttachmentToWard	= (CASE WHEN IsNull(ER.AttachmentToWard, 0) = 0 THEN EE.AttachmentToWard ELSE ER.AttachmentToWard END),
				@PyloricDilatation	= (CASE WHEN IsNull(ER.PyloricDilatation, 0) = 0 THEN EE.PyloricDilatation ELSE ER.PyloricDilatation END),
				@StentInsertion		= (CASE WHEN IsNull(ER.StentInsertion, 0) = 0 THEN EE.StentInsertion ELSE ER.StentInsertion END),
				@StentInsertionQty	= (CASE WHEN IsNull(ER.StentInsertionQty, 0) = 0 THEN EE.StentInsertionQty ELSE ER.StentInsertionQty END),
				@RadioactiveWirePlaced			= (CASE WHEN IsNull(ER.RadioactiveWirePlaced, 0) = 0 THEN EE.RadioactiveWirePlaced ELSE ER.RadioactiveWirePlaced END),
				@StentInsertionBatchNo			= (SELECT isnull((CASE WHEN IsNull(ER.StentInsertionBatchNo,'')= '' THEN EE.StentInsertionBatchNo ELSE ER.StentInsertionBatchNo END), '') as [text()] FOR XML PATH('')),
				@StentRemoval					= (CASE WHEN IsNull(ER.StentRemoval, 0) = 0 THEN EE.StentRemoval ELSE ER.StentRemoval END),
				@StentRemovalTechnique			= (CASE WHEN IsNull(ER.StentRemovalTechnique, 0) = 0 THEN EE.StentRemovalTechnique ELSE ER.StentRemovalTechnique END),
				@EMR				= (CASE WHEN IsNull(ER.EMR, 0) = 0 THEN EE.EMR ELSE ER.EMR END),
				@EMRType			= (CASE WHEN IsNull(ER.EMRType, 0) = 0 THEN EE.EMRType ELSE ER.EMRType END),
				@EMRFluid			= (CASE WHEN IsNull(ER.EMRFluid, 0) = 0 THEN EE.EMRFluid ELSE ER.EMRFluid END),
				@EMRFluidVolume		= (CASE WHEN IsNull(ER.EMRFluidVolume, 0) = 0 THEN EE.EMRFluidVolume ELSE ER.EMRFluidVolume END),
				@Marking			= (CASE WHEN IsNull(ER.Marking, 0) = 0 THEN EE.Marking ELSE ER.Marking END),
				@MarkingType		= (CASE WHEN IsNull(ER.MarkingType, 0) = 0 THEN EE.MarkingType ELSE ER.MarkingType END),
				@Clip				= (CASE WHEN IsNull(ER.Clip, 0) = 0 THEN EE.Clip ELSE ER.Clip END),
				@ClipNum			= (CASE WHEN IsNull(ER.ClipNum, 0) = 0 THEN EE.ClipNum ELSE ER.ClipNum END),
				@Papillotomy		= (CASE WHEN IsNull(ER.Papillotomy, 0) = 0 THEN EE.Papillotomy ELSE ER.Papillotomy END),
				@Sphincterotome		= (CASE WHEN IsNull(ER.Sphincterotome, 0) = 0 THEN EE.Sphincterotome ELSE ER.Sphincterotome END),
				@PapillotomyLength	= (CASE WHEN IsNull(ER.PapillotomyLength, 0) = 0 THEN EE.PapillotomyLength ELSE ER.PapillotomyLength END),
				@PapillotomyAcceptBalloonSize	= (CASE WHEN IsNull(ER.PapillotomyAcceptBalloonSize, 0) = 0 THEN EE.PapillotomyAcceptBalloonSize ELSE ER.PapillotomyAcceptBalloonSize END),
				@ReasonForPapillotomy		= (CASE WHEN IsNull(ER.ReasonForPapillotomy, 0) = 0 THEN EE.ReasonForPapillotomy ELSE ER.ReasonForPapillotomy END),
				@PapillotomyBleeding		= (CASE WHEN IsNull(ER.PapillotomyBleeding, 0) = 0 THEN EE.PapillotomyBleeding ELSE ER.PapillotomyBleeding END),
				@SphincterDecompressed		= (CASE WHEN IsNull(ER.SphincterDecompressed, 0) = 0 THEN EE.SphincterDecompressed ELSE ER.SphincterDecompressed END),
				@PanOrificeSphincterotomy	= (CASE WHEN IsNull(ER.PanOrificeSphincterotomy, 0) = 0 THEN EE.PanOrificeSphincterotomy ELSE ER.PanOrificeSphincterotomy END),
				@StoneRemoval				= (CASE WHEN IsNull(ER.StoneRemoval, 0) = 0 THEN EE.StoneRemoval ELSE ER.StoneRemoval END),
				@RemovalUsing				= (CASE WHEN IsNull(ER.RemovalUsing, 0) = 0 THEN EE.RemovalUsing ELSE ER.RemovalUsing END),
				@ExtractionOutcome			= (CASE WHEN IsNull(ER.ExtractionOutcome, 0) = 0 THEN EE.ExtractionOutcome ELSE ER.ExtractionOutcome END),
				@InadequateSphincterotomy	= (CASE WHEN IsNull(ER.InadequateSphincterotomy, 0) = 0 THEN EE.InadequateSphincterotomy ELSE ER.InadequateSphincterotomy END),
				@StoneSize			= (CASE WHEN IsNull(ER.StoneSize, 0) = 0 THEN EE.StoneSize ELSE ER.StoneSize END),
				@QuantityOfStones	= (CASE WHEN IsNull(ER.QuantityOfStones, 0) = 0 THEN EE.QuantityOfStones ELSE ER.QuantityOfStones END),
				@ImpactedStones		= (CASE WHEN IsNull(ER.ImpactedStones, 0) = 0 THEN EE.ImpactedStones ELSE ER.ImpactedStones END),
				@OtherReason		= (CASE WHEN IsNull(ER.OtherReason, 0) = 0 THEN EE.OtherReason ELSE ER.OtherReason END),
				@OtherReasonText	= (SELECT isnull((CASE WHEN IsNull(ER.OtherReasonText, '') = '' THEN EE.OtherReasonText ELSE ER.OtherReasonText END), '') as [text()] FOR XML PATH('')),
				@StoneDecompressed	= (CASE WHEN IsNull(ER.StoneDecompressed, 0) = 0 THEN EE.StoneDecompressed ELSE ER.StoneDecompressed END),
				@StrictureDilatation= (CASE WHEN IsNull(ER.StrictureDilatation, 0) = 0 THEN EE.StrictureDilatation ELSE ER.StrictureDilatation END),
				@DilatedTo			= (CASE WHEN IsNull(ER.DilatedTo, 0) = 0 THEN EE.DilatedTo ELSE ER.DilatedTo END),
				@DilatationUnits	= (CASE WHEN ER.DilatationUnits IS NULL THEN EE.DilatationUnits ELSE ER.DilatationUnits END),
				@DilatorType		= (CASE WHEN IsNull(ER.DilatorType, 0) = 0 THEN EE.DilatorType ELSE ER.DilatorType END),
				@EndoscopicCystPuncture	= (CASE WHEN IsNull(ER.EndoscopicCystPuncture, 0) = 0 THEN EE.EndoscopicCystPuncture ELSE ER.EndoscopicCystPuncture END),
				@CystPunctureDevice		= (CASE WHEN IsNull(ER.CystPunctureDevice, 0) = 0 THEN EE.CystPunctureDevice ELSE ER.CystPunctureDevice END),
				@CystPunctureVia		= (CASE WHEN IsNull(ER.CystPunctureVia, 0) = 0 THEN EE.CystPunctureVia ELSE ER.CystPunctureVia END),
				@Cannulation			= (CASE WHEN IsNull(ER.Cannulation, 0) = 0 THEN EE.Cannulation ELSE ER.Cannulation END),
				@Manometry				= (CASE WHEN IsNull(ER.Manometry, 0) = 0 THEN EE.Manometry ELSE ER.Manometry END),
				@Haemostasis			= (CASE WHEN IsNull(ER.Haemostasis, 0) = 0 THEN EE.Haemostasis ELSE ER.Haemostasis END),
				@NasopancreaticDrain	= (CASE WHEN IsNull(ER.NasopancreaticDrain, 0) = 0 THEN EE.NasopancreaticDrain ELSE ER.NasopancreaticDrain END),
				@RendezvousProcedure	= (CASE WHEN IsNull(ER.RendezvousProcedure, 0) = 0 THEN EE.RendezvousProcedure ELSE ER.RendezvousProcedure END),
				@SnareExcision			= (CASE WHEN IsNull(ER.SnareExcision, 0) = 0 THEN EE.SnareExcision ELSE ER.SnareExcision END),
				@BalloonDilation		= (CASE WHEN IsNull(ER.BalloonDilation, 0) = 0 THEN EE.BalloonDilation ELSE ER.BalloonDilation END),
				@BalloonDilatedTo		= (CASE WHEN IsNull(ER.BalloonDilatedTo, 0) = 0 THEN EE.BalloonDilatedTo ELSE ER.BalloonDilatedTo END),
				@BalloonDilatationUnits	= (CASE WHEN IsNull(ER.BalloonDilatationUnits, 0) = 0 THEN EE.BalloonDilatationUnits ELSE ER.BalloonDilatationUnits END),
				@BalloonDilatorType		= (CASE WHEN IsNull(ER.BalloonDilatorType, 0) = 0 THEN EE.BalloonDilatorType ELSE ER.BalloonDilatorType END),
				@BalloonTrawl			= (CASE WHEN IsNull(ER.BalloonTrawl, 0) = 0 THEN EE.BalloonTrawl ELSE ER.BalloonTrawl END),
				@BalloonTrawlDilatorType	= (CASE WHEN IsNull(ER.BalloonTrawlDilatorType, 0) = 0 THEN EE.BalloonTrawlDilatorType ELSE ER.BalloonTrawlDilatorType END),
				@BalloonTrawlDilatorSize	= (CASE WHEN IsNull(ER.BalloonTrawlDilatorSize, 0) = 0 THEN EE.BalloonTrawlDilatorSize ELSE ER.BalloonTrawlDilatorSize END),
				@BalloonTrawlDilatorUnits	= (CASE WHEN IsNull(ER.BalloonTrawlDilatorUnits, 0) = 0 THEN EE.BalloonTrawlDilatorUnits ELSE ER.BalloonTrawlDilatorUnits END),
				@BalloonDecompressed		= (CASE WHEN IsNull(ER.BalloonDecompressed, 0) = 0 THEN EE.BalloonDecompressed ELSE ER.BalloonDecompressed END),
				@DiagCholangiogram			= (CASE WHEN IsNull(ER.DiagCholangiogram, 0) = 0 THEN EE.DiagCholangiogram ELSE ER.DiagCholangiogram END),
				@DiagPancreatogram			= (CASE WHEN IsNull(ER.DiagPancreatogram, 0) = 0 THEN EE.DiagPancreatogram ELSE ER.DiagPancreatogram END),
				@EndoscopistRole			= (CASE WHEN IsNull(ER.CarriedOutRole, 0) = 0 THEN EE.CarriedOutRole ELSE ER.CarriedOutRole END),
				@Other						= (CASE WHEN IsNull(ER.Other, '') ='' THEN EE.Other ELSE ER.Other END),
				@EUSProcType				= (CASE WHEN IsNull(ER.EUSProcType, 0) = 0 THEN EE.EUSProcType ELSE ER.EUSProcType END),
				@CorrectStentPlacement		= ER.CorrectStentPlacement,
				@CorrectStentPlacementNoReason			= (CASE WHEN IsNull(ER.CorrectStentPlacementNoReason, 0) = 0 THEN EE.CorrectStentPlacementNoReason ELSE ER.CorrectStentPlacementNoReason END),
				@BalloonDilatation			= (CASE WHEN IsNull(ER.BalloonDilatation, 0) = 0 THEN EE.BalloonDilatation ELSE ER.BalloonDilatation END),
				@BougieDilatation			= (CASE WHEN IsNull(ER.BougieDilatation, 0) = 0 THEN EE.BougieDilatation ELSE ER.BougieDilatation END),
				@BougieDilation				= (CASE WHEN IsNull(ER.BougieDilation, 0) = 0 THEN EE.BougieDilation ELSE ER.BougieDilation END),
				@BrushCytology				= (CASE WHEN IsNull(ER.BrushCytology, 0) = 0 THEN EE.BrushCytology ELSE ER.BrushCytology END),
				@Cholangioscopy				= (CASE WHEN IsNull(ER.Cholangioscopy, 0) = 0 THEN EE.Cholangioscopy ELSE ER.Cholangioscopy END),
				@StentChange				= (CASE WHEN IsNull(ER.StentChange, 0) = 0 THEN EE.StentChange ELSE ER.StentChange END),
				@StentPlacement				= (CASE WHEN IsNull(ER.StentPlacement, 0) = 0 THEN EE.StentPlacement ELSE ER.StentPlacement END),
				@RadioFrequencyAblation		= (CASE WHEN IsNull(ER.RadioFrequencyAblation, 0) = 0 THEN EE.RadioFrequencyAblation ELSE ER.RadioFrequencyAblation END),
				@FineNeedleAspiration		= (CASE WHEN IsNull(ER.FineNeedleAspiration, 0) = 0 THEN EE.FineNeedleAspiration ELSE ER.FineNeedleAspiration END),
				@FineNeedleAspirationType	= (CASE WHEN IsNull(ER.FineNeedleAspirationType, 0) = 0 THEN EE.FineNeedleAspirationType ELSE ER.FineNeedleAspirationType END),
				@FineNeedleBiopsy			= (CASE WHEN IsNull(ER.FineNeedleBiopsy, 0) = 0 THEN EE.FineNeedleBiopsy ELSE ER.FineNeedleBiopsy END),
				@Polypectomy				= (CASE WHEN IsNull(ER.[Polypectomy], 0) = 0 THEN EE.[Polypectomy] ELSE ER.[Polypectomy] END),
				@Diverticulotomy			= (CASE WHEN ISNULL(ER.Diverticulotomy,0) = 0 THEN EE.Diverticulotomy ELSE ER.Diverticulotomy END)
			FROM eeRecord AS EE
	  INNER JOIN #tmp_ERCPTherapeutics AS ER ON EE.SiteId = ER.SiteId;
		END	--## Selecting from Combine
				
	
	IF @None = 1
		SET @summary = @summary + 'No specimens taken'
	ELSE
	BEGIN
		----------------------
        -- Sphincterotomy
        ----------------------
		IF @Papillotomy = 1
		BEGIN
			SET @msg =' Sphincterotomy'
			SET @Details = ''
			IF @ReasonForPapillotomy > 0 
			BEGIN
				SET @Details = @Details + ' ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'ERCP papillotomy reason' AND [ListItemNo] = @ReasonForPapillotomy)

				--Place the word 'for' in front of the reason for the papillotomy if required.
				IF LEFT(UPPER(LTRIM(@Details)),4) <> 'FOR ' SET @Details = ' for ' + @Details
				SET @msg = @msg + ' (' + @Details + ')'
				SET @Details = ''
			END
			IF @PapillotomyLength > 0 SET @Details = @Details + ' ' + CAST(@PapillotomyLength as varchar(50)) + 'mm'
			IF @Sphincterotome > 0 SET @Details = @Details + ' using ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Therapeutic ERCP sphincterotomes' AND [ListItemNo] = @Sphincterotome)
			IF @PapillotomyBleeding > 0 
			BEGIN
				If LEN(RTRIM(LTRIM(@Details))) > 0 SET @Details = @Details + ','
				SET @Details = @Details + CASE @PapillotomyBleeding
											WHEN 1 THEN ' with no bleeding'   
											WHEN 2 THEN ' with minor bleeding'  
											WHEN 3 THEN ' with major bleeding'
											ELSE '' 
										END   
			END
			IF @PapillotomyAcceptBalloonSize > 0 
			BEGIN
				If LEN(RTRIM(LTRIM(@Details))) > 0 SET @Details = @Details + ','
				SET @Details = @Details + ' incision accepted ' + cast(@PapillotomyAcceptBalloonSize as varchar(50)) + 'ml balloon'
			END
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END
		
		----------------------
        -- Pancreatic orifice sphincterotomy
        ----------------------
		IF @PanOrificeSphincterotomy = 1
		BEGIN
			SET @msg =' Pancreatic orifice sphincterotomy'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		----------------------
        -- Stone removal
        ----------------------
		IF @StoneRemoval = 1
		BEGIN
			SET @msg =' Stone removal'
			SET @Details = ''

			IF @ExtractionOutcome > 0 
			BEGIN
				SET @Details = @Details + CASE @ExtractionOutcome
											WHEN 1 THEN ' complete extraction'   
											WHEN 2 THEN ' fragmented'  
											WHEN 3 THEN ' partial extraction'
											WHEN 4 THEN ' unable to extract'
											ELSE '' 
										END   
				DECLARE @cnt bit = 0
				IF @ExtractionOutcome BETWEEN 3 AND 4
				BEGIN
					DECLARE @tmpDiv TABLE(Val VARCHAR(MAX))
					DECLARE @XMLlist XML

					IF @InadequateSphincterotomy > 0
					BEGIN
						INSERT INTO @tmpDiv (Val) VALUES('inadequate sphincterotomy')
					END

					IF @StoneSize > 0
					BEGIN
						INSERT INTO @tmpDiv (Val) VALUES('stone size')
					END

					IF @QuantityOfStones > 0
					BEGIN
						INSERT INTO @tmpDiv (Val) VALUES('quantity of stones')
					END

					IF @ImpactedStones > 0
					BEGIN
						INSERT INTO @tmpDiv (Val) VALUES('impacted stone(s)')
					END

					IF @OtherReason > 0
					BEGIN
						IF LTRIM(RTRIM(ISNULL(@OtherReasonText,''))) <> ''
						BEGIN
							INSERT INTO @tmpDiv (Val) VALUES(@OtherReasonText)
						END
					END

					IF (SELECT COUNT(Val) FROM @tmpDiv) > 0 
					BEGIN
						SET @XMLlist = (SELECT Val FROM @tmpDiv FOR XML  RAW, ELEMENTS, TYPE)
						SET @Details = @Details + ' due to ' + dbo.fnBuildString(@XMLlist)
					END
				END
			END

			IF @RemovalUsing > 0 SET @Details = @Details + ' using ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'ERCP stone removal method' AND [ListItemNo] = @RemovalUsing)


			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		----------------------
        -- Stricture dilatation
        ----------------------
		IF @StrictureDilatation= 1
			BEGIN
			SET @msg =' Stricture dilatation'
			SET @Details = ''

			IF @DilatedTo > 0 
			BEGIN
				SET @Details = @Details + ' dilated to ' + cast(@DilatedTo as varchar(50)) + ' ' + 
									ISNULL((SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Oesophageal dilatation units' AND [ListItemNo] = @DilatationUnits),'')
			END

			--Dilator type
			IF @DilatorType > 0 
			BEGIN
				DECLARE @tmpDilatorType VARCHAR(100) = (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Oesophageal dilator' AND [ListItemNo] = @DilatorType)
				IF UPPER(LEFT(LTRIM(@tmpDilatorType),5)) = 'WITH ' OR UPPER(LEFT(LTRIM(@tmpDilatorType),3)) = 'BY ' 
					SET @Details = @Details + ' ' + @tmpDilatorType
				ELSE
					SET @Details = @Details + ' with ' + @tmpDilatorType
			END	
			
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		----------------------
        -- Endoscopic cyst puncture
        ----------------------
		IF @EndoscopicCystPuncture = 1
		BEGIN
			SET @msg =' Endoscopic cyst puncture'
			SET @Details = ''
			IF @CystPunctureDevice > 0 SET @Details = @Details + ' using ' + 
															(SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'ERCP cyst punct device' AND [ListItemNo] = @CystPunctureDevice)

			SET @Details = @Details + CASE @CystPunctureVia
							WHEN 1 THEN ' via papilla'   
							WHEN 2 THEN ' via medial wall of duodenum (cyst-duodenostomy)'  
							WHEN 3 THEN ' via stomach (cyst-gastrostomy)'
							ELSE '' 
						END   

			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		-------------------------------
        -- Nasobiliary/pancreatic drain
        -------------------------------
		IF @NasopancreaticDrain = 1
		BEGIN
			IF EXISTS ( SELECT r.Region FROM ERS_AbnormalitiesMatrixERCP m 
							LEFT JOIN ERS_Regions r ON m.Region = r.Region 
									AND r.Region IN ('Uncinate Process', 'Head', 'Neck', 'Body', 'Tail', 'Accessory Pancreatic Duct', 'Main Pancreatic Duct')
							LEFT JOIN ERS_Sites s ON r.RegionId  = s.RegionID  
							WHERE s.siteId = @SiteId)
				SET @msg =' Nasopancreatic drain'
			ELSE
				SET @msg =' Nasobiliary drain'


			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		-------------------------------
        -- Combined procedure
        -------------------------------
		IF @RendezvousProcedure = 1
		BEGIN
			SET @msg =' Combined procedure (rendezvous)'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		-------------------------------
        -- Diverticulotomy
        -------------------------------
		IF @Diverticulotomy = 1
		BEGIN
			SET @msg =' Diverticulotomy'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		-------------------------------
        -- Snare excision
        -------------------------------
		IF @SnareExcision = 1
		BEGIN
			SET @msg =' Snare excision'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		----------------------
        -- Balloon sphincteroplasty
        ----------------------
		IF @BalloonDilation= 1
			BEGIN
			SET @msg =' Balloon sphincteroplasty'
			SET @Details = ''

			IF @BalloonDilatedTo > 0 
			BEGIN
				SET @Details = @Details + ' dilated to ' + cast(@BalloonDilatedTo as varchar(50)) + ' ' + 
									(SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Oesophageal dilatation units' AND [ListItemNo] = @BalloonDilatationUnits)
			END

			--Balloon Dilator type
			IF @BalloonDilatorType > 0 
			BEGIN
				DECLARE @tmpBalloonDilatorType VARCHAR(100) = (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'ERCP balloon dilator' AND [ListItemNo] = @BalloonDilatorType)
				IF UPPER(LEFT(LTRIM(@tmpBalloonDilatorType),5)) = 'WITH ' OR UPPER(LEFT(LTRIM(@tmpBalloonDilatorType),3)) = 'BY ' 
					SET @Details = @Details + ' ' + @tmpBalloonDilatorType
				ELSE
					SET @Details = @Details + ' with ' + @tmpBalloonDilatorType
			END	
			
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END


		----------------------
        -- Balloon trawl
        ----------------------
		IF @BalloonTrawl = 1
			BEGIN
			SET @msg =' Balloon trawl'
			SET @Details = ''

			IF @BalloonTrawlDilatorType > 0 
			BEGIN
				DECLARE @DilType VARCHAR(100) = (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'ERCP Balloon dilator' AND [ListItemNo] = @BalloonTrawlDilatorType)
				IF LTRIM(RTRIM(@DilType)) <> ''
				BEGIN
					
					IF UPPER(LEFT(@DilType,1)) in ('A','E','I','O','U') 
						SET @Details = @Details + ' using an' 
					ELSE
						SET @Details = @Details + ' using a'

					SET @Details = @Details + ' ' + @DilType
				END
			END

			IF @BalloonTrawlDilatorUnits >= 0 
			BEGIN
				IF @BalloonTrawlDilatorSize > 0 
				BEGIN
					SET @Details = @Details + ' dilated to ' + cast(@BalloonTrawlDilatorSize as varchar(50)) + ' ' + 
									(SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Oesophageal dilatation units' AND [ListItemNo] = @BalloonTrawlDilatorUnits)
				END
			END
			
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		-------------------------------
        -- Cannulation
        -------------------------------
		IF @Cannulation = 1
		BEGIN
			SET @msg =' Cannulation'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		-------------------------------
        -- Manometry
        -------------------------------
		IF @Manometry = 1
		BEGIN
			SET @msg =' Manometry'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		-------------------------------
        -- Haemostasis
        -------------------------------
		IF @Haemostasis = 1
		BEGIN
			SET @msg =' Haemostasis'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		-------------------------------
        -- Diagnostic cholangiogram
        -------------------------------
		IF @DiagCholangiogram = 1
		BEGIN
			SET @msg =' Diagnostic cholangiogram'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		-------------------------------
        -- Diagnostic pancreatogram
        -------------------------------
		IF @DiagPancreatogram = 1
		BEGIN
			SET @msg =' Diagnostic pancreatogram'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

	-- DUODENUM -----
		IF @YAGLaser = 1
			BEGIN
				SET @msg =' YAG Laser'
				SET @Details = ''
				IF @YAGLaserWatts > 0 SET @Details = @Details + ' ' + CAST(@YAGLaserWatts as varchar(50)) + 'W'
				IF @YAGLaserSecs > 0 SET @Details = @Details + ' for ' + cast(CAST(@YAGLaserSecs AS FLOAT) as varchar(50)) + CASE WHEN @YAGLaserSecs <= 1 THEN ' second' else ' seconds' END
				IF @YAGLaserPulses > 0 SET @Details = @Details + ' in ' + cast(@YAGLaserPulses as varchar(50)) + CASE WHEN @YAGLaserPulses <= 1 THEN ' pulse' else ' pulses' END
				IF @YAGLaserKJ > 0 SET @Details = @Details + ' ('+ cast(CAST(@YAGLaserKJ AS FLOAT) as varchar(50)) + 'kJ)'
				If @Details<>'' SET @msg = @msg + ': ' + @Details
				--Add full stop 
				SET @msg = RTrim(LTRIM(@msg))
				IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
				--------------
				SET @summary = @summary + @msg + '<br/>'
			END
		
		IF @ArgonBeamDiathermy= 1
			BEGIN
			SET @msg ='  Argon beam diathermy'
			SET @Details = ''
			IF @ArgonBeamDiathermyWatts > 0 SET @Details = @Details + ' ' + cast(@ArgonBeamDiathermyWatts as varchar(50)) + 'W'
			IF @ArgonBeamDiathermySecs > 0 SET @Details = @Details + ' for ' + cast(CAST(@ArgonBeamDiathermySecs AS FLOAT) as varchar(50)) + CASE WHEN @ArgonBeamDiathermySecs <= 1 THEN ' second' else ' seconds' END
			IF @ArgonBeamDiathermyPulses > 0 SET @Details = @Details + ' in ' + cast(@ArgonBeamDiathermyPulses as varchar(50)) + CASE WHEN @ArgonBeamDiathermyPulses <= 1 THEN ' pulse' else ' pulses' END
			IF @ArgonBeamDiathermyKJ > 0 SET @Details = @Details + ' ('+ cast(CAST(@ArgonBeamDiathermyKJ AS FLOAT) as varchar(50)) + 'kJ)'
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
			END

			
		IF @Injection= 1
			BEGIN
			SET @msg =' Injection'
			SET @Details = ''
			IF @InjectionVolume > 0 SET @Details = @Details + '  ' + cast(@InjectionVolume as varchar(50)) + 'ml'
			IF @InjectionVolume > 0  AND @InjectionType > 0 SET @Details = @Details + ' of'
			IF @InjectionType > 0 SET @Details = @Details + ' ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Agent Upper GI' AND [ListItemNo] = @InjectionType)
			IF @InjectionVolume> 0  AND @InjectionNumber > 0 SET @Details = @Details + ' via'
			IF @InjectionNumber >0 SET @Details = @Details + ' ' + CASE WHEN @InjectionNumber > 1 THEN cast(@InjectionNumber as varchar(50)) + ' injections' ELSE cast(@InjectionNumber as varchar(50)) + ' injection' END
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END
	
		IF @Diathermy = 1
			BEGIN
			SET @msg = ' Diathermy'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		IF @BicapElectro = 1
			BEGIN
			SET @msg = ' Bicap electrocautery'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		IF @HeatProbe = 1
			BEGIN
			SET @msg = ' Heater probe coagulation'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END
		
		IF @HotBiopsy = 1
			BEGIN
			SET @msg = ' Hot biopsy'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		IF @BandLigation = 1
			BEGIN
			SET @msg = ' Band ligation'
			IF @BandLigationPerformed > 0 SET @msg = @msg + ' performed ' + CAST(@BandLigationPerformed AS VARCHAR(100)) + CASE WHEN @BandLigationPerformed = 1 THEN ' procedure' ELSE ' procedures' END
			IF @BandLigationPerformed > 0 AND @BandLigationSuccess > 0 SET @msg = @msg + ' and ' + CAST(@BandLigationSuccess AS VARCHAR(100)) + CASE WHEN @BandLigationPerformed = 1 THEN ' was successful.' ELSE ' were successful.' END 
				ELSE IF @BandLigationPerformed = 0 AND @BandLigationSuccess > 0 SET @msg = @msg + ' ' + CAST(@BandLigationSuccess AS VARCHAR(100)) + CASE WHEN @BandLigationPerformed = 1 THEN ' procedure was successful.' ELSE ' procedures were successful.' END 
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		IF @BotoxInjection = 1
			BEGIN
			SET @msg = ' Botox injection'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		IF @EndoloopPlacement = 1
			BEGIN
			SET @msg = ' Endoloop placement'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		IF @ForeignBody = 1
			BEGIN
			SET @msg = ' Foreign body removal'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		----------------------
        -- Stent insertion
        ----------------------
		IF @StentInsertion= 1
			BEGIN

			IF @CorrectStentPlacement IS NOT NULL
			BEGIN
				IF @CorrectStentPlacement = 1
				BEGIN
					SET @msg = ' Correct placement across stricture '
				END
				ELSE IF @CorrectStentPlacement = 0
				BEGIN
					SET @msg = ' Incorrect placement across stricture '

					IF @CorrectStentPlacementNoReason >= 0
					BEGIN
						SET @msg = @msg + '(' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Correct Placement Across Stricture' AND [ListItemNo] = @CorrectStentPlacementNoReason) + ')'
					END
				END

				--Add full stop 
				SET @msg = RTrim(LTRIM(@msg))
				IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
				--------------
				SET @summary = @summary + @msg + '<br/>'
			END

			SET @msg =' Stent insertion'
			SET @Details = ''

			--Qty of stents used
			IF @StentInsertionQty > 0 SET @Details = @Details + '  ' + cast(@StentInsertionQty as varchar(50))

			IF @RadioactiveWirePlaced > 0  SET @Details = @Details + ', radiotherapeutic wire placed' 
			IF ISNULL(@StentInsertionBatchNo,'') <> ''  SET @Details = @Details + ', batch ' + LTRIM(RTRIM(@StentInsertionBatchNo))

			SET @Details = @Details + dbo.ercp_stentinsertions_summary(@TherapeuticId)
			
			If @Details<>'' SET @msg = @msg + ': ' + @Details 
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		----------------------
        -- Stent removal
        ----------------------
		IF @StentRemoval= 1
			BEGIN
			SET @msg =' Stent removal'
			SET @Details = ''
			IF @StentRemovalTechnique > 0  SET @Details = @Details + 'using ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Therapeutic Stent Removal Technique' AND [ListItemNo] = @StentRemovalTechnique)
			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		IF @EMR= 1
			BEGIN
			IF @EMRType = 2
				SET @msg =' Endoscopic submucosal dissection'
			ELSE
				SET @msg =' Endoscopic mucosal resection'
			SET @Details = ''
			IF @EMRFluid > 0  SET @Details = @Details + 'using ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Therapeutic EMR Fluid' AND [ListItemNo] = @EMRFluid)
			IF @EMRFluidVolume >0 
				BEGIN
				IF @EMRFluid >0 SET  @Details = @Details + ', '
				SET  @Details = @Details + 'total volume ' + cast(@emrfluidvolume AS varchar(50)) + 'ml'
				END
			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		IF @GastrostomyInsertion =1
		BEGIN
			DECLARE @G bit, @J bit, @N bit
			--SELECT @j = i.[JejunostomyInsertion], @G =i.[GastrostomyInsertion],@N = i.[NasoDuodenalTube] FROM [ERS_UpperGIIndications] i LEFT JOIN [ERS_Sites] s ON i.ProcedureId = s.ProcedureId WHERE s.SiteId = @SiteID
			--IF @N = 1 SET @msg =' Nasojejunal tube (NJT)' ELSE IF @J= 1 SET @msg =' Jejunostomy insertion (PEJ)' ELSE SET @msg =' Gastrostomy insertion (PEG)'
			SET @msg =' Nasojejunal tube (NJT)' -- For ERCP, it is Nasojejunal
			SET @Details = ''

			IF @GastrostomyInsertionType > 0
			BEGIN
				IF @GastrostomyInsertionSize>0
				BEGIN
					SET @Details = @Details + cast(@GastrostomyInsertionSize as varchar(50))
					--IF @J=1 
					SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG units' AND [ListItemNo] = @GastrostomyInsertionUnits)
					--ELSE IF @N =1 SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG units' AND [ListItemNo] = @GastrostomyInsertionUnits)
					--ELSE SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG units' AND [ListItemNo] = @GastrostomyInsertionUnits)
				END
			END
			IF @GastrostomyInsertionType>0
			BEGIN
				IF @J=1 SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG type' AND [ListItemNo] = @GastrostomyInsertiontype)
				ELSE IF @N =1 SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG type' AND [ListItemNo] = @GastrostomyInsertiontype)
				ELSE SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG type' AND [ListItemNo] = @GastrostomyInsertiontype)
			END
			IF @GastrostomyInsertionBatchNo <> null AND @GastrostomyInsertionBatchNo <> ''  SET @Details = @Details + ' batch ' + @GastrostomyInsertionBatchNo
				
			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		IF @GastrostomyRemoval = 1
			BEGIN
			SET @msg = ' Nasojejunal tube (NJT) removal'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		IF @Marking= 1
		BEGIN
			SET @msg =' Abnormality marked'
			SET @Details = ''
			IF @MarkingType > 0 SET @Details = @Details + ' by ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Abno marking' AND [ListItemNo] = @MarkingType)

			IF @Details<>'' SET @msg = @msg + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @Clip= 1
		BEGIN 
			SET @msg = CASE WHEN @ClipNum > 1 THEN  CAST(@ClipNum as varchar(5)) + ' clips'
							WHEN @ClipNum = 1 THEN  CAST(@ClipNum as varchar(5)) + ' clip'
							ELSE 'Clip'
						END
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		-------------------------------
        -- Pyloric/duodenal dilatation
        -------------------------------
		IF @PyloricDilatation= 1
		BEGIN
			SET @msg =' Pyloric dilatation'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		-------------------------------
        -- Balloon Dilatation
        -------------------------------
		IF @BalloonDilatation= 1
		BEGIN
			SET @msg =' Balloon dilatation'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		-------------------------------
        -- Bougie Dilatation
        -------------------------------
		IF @BougieDilatation= 1
		BEGIN
			SET @msg =' Bougie dilatation'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		-------------------------------
        -- Bougie Dilation
        -------------------------------
		IF @BougieDilation= 1
		BEGIN
			SET @msg =' Bougie dilation'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		-------------------------------
        -- Brush Cytology
        -------------------------------
		IF @BrushCytology= 1
		BEGIN
			SET @msg =' Brush cytology'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		-------------------------------
        -- Cholangioscopy
        -------------------------------
		IF @Cholangioscopy= 1
		BEGIN
			SET @msg =' Cholangioscopy'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
		-------------------------------
        -- Stent Change
        -------------------------------
		IF @StentChange= 1
		BEGIN
			SET @msg =' Stent change'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
		-------------------------------
        -- Stent Placement
        -------------------------------
		IF @StentPlacement= 1
		BEGIN
			SET @msg =' Stent placement'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
		-------------------------------
        -- Radio Frequency Ablation
        -------------------------------
		IF @RadioFrequencyAblation= 1
		BEGIN
			SET @msg =' Radio frequency ablation'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		-------------------------------
        -- FNA
        -------------------------------
		IF @FineNeedleAspiration= 1
		BEGIN
			SET @msg =' FNA'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		-------------------------------
        -- FNB
        -------------------------------
		IF @FineNeedleBiopsy= 1
		BEGIN
			SET @msg =' FNB'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
		-------------------------------
        -- Polypectomy
        -------------------------------
		IF @Polypectomy= 1
		BEGIN
			SET @msg =' Polypectomy'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
		IF LTRIM(RTRIM(@other)) <> ''
			BEGIN
			SET @msg =' ' + LTRIM(RTRIM(@other))
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary =  @summary + @msg  +'<br/>'
		END

	END;

	UPDATE dbo.ERS_ERCPTherapeutics 
	SET Summary=@summary 
	WHERE SiteID = @SiteId; --Id = @TherapeuticId

	DROP TABLE #tmp_ERCPTherapeutics;
GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea Johnson 16/10/23
-- TFS#	3455
-- Description of change
-- Drug types
------------------------------------------------------------------------------------------------------------------------
GO


IF NOT EXISTS (SELECT 1 FROM dbo.ERS_DrugList WHERE LOWER(DrugName) = 'remimazolam')
BEGIN
     INSERT INTO dbo.ERS_DrugList
     (
         ProductID,
         LocationID,
         DrugType,
         DrugName,
         DeliveryMethod,
         Units,
         DoseNotApplicable,
         DefaultDose,
         DoseIncrement,
         UsedInColonSig,
         UsedInERCP,
         UsedInUpperGI,
         IsReversingAgent,
         UsedInEUS_OGD,
         UsedInEUS_HPB,
         UsedInAntegrade,
         UsedInRetrograde,
         UsedInBroncho,
         CannotBeSuppressed,
         UsedInFlexiCystoscopy,
         UsedInRigidCystoscopy,
         UsedInEBUS
     )
     VALUES
     (   N'GI',     -- ProductID - nvarchar(2)
         N'XXXX',     -- LocationID - nvarchar(4)
         0,    -- DrugType - smallint
         'Remimazolam',    -- DrugName - nvarchar(50)
         'IV',    -- DeliveryMethod - nvarchar(25)
         'mg',    -- Units - varchar(50)
         0, -- DoseNotApplicable - bit
         5,    -- DefaultDose - real
         0.25,    -- DoseIncrement - real
         1, -- UsedInColonSig - smallint
         1, -- UsedInERCP - smallint
         1, -- UsedInUpperGI - smallint
         0, -- IsReversingAgent - smallint
         1, -- UsedInEUS_OGD - smallint
         1, -- UsedInEUS_HPB - smallint
         1, -- UsedInAntegrade - smallint
         1, -- UsedInRetrograde - smallint
         1, -- UsedInBroncho - smallint
         1, -- CannotBeSuppressed - bit
         0, -- UsedInFlexiCystoscopy - smallint
         0, -- UsedInRigidCystoscopy - smallint
         0  -- UsedInEBUS - bit
         )
END

GO


ALTER FUNCTION [dbo].[tvfNED_ProcedureDrugList]
(	
	@ProcedureId AS INT
)
-- =============================================
-- Description:	This will return the list of the Drugs Used in the Procedures performed on each Patient!
-- =============================================
RETURNS TABLE 
AS
RETURN 
(
	Select *
	From 
		(	
			Select PM.ProcedureId, PM.DrugName, PM.Dose
			, noDrugsAdministered = (case when Exists(Select 1 from ERS_UpperGIPremedication where ProcedureId=@ProcedureId and DrugNo NOT IN  (-1, -2) AND (DrugName not like 'Prophylactic%' and DrugName <> 'Pharyngeal Anaesthesia')) THEN 'No' ELSE 'Yes' END)
			FROM [dbo].[ERS_UpperGIPremedication] PM
			where PM.ProcedureId=@ProcedureId
			) As j
		PIVOT
		(
			SUM(j.Dose) For j.Drugname In ([pethidine],[midazolam],[fentanyl],[buscopan],[propofol],[flumazenil],[naloxone], [entonox], [Pharyngeal Anaesthesia], [remimazolam]) -- ## '06/10/2017 Entonox is added to UGI
		) As PR	
);
GO



------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea Johnson 17.10.23
-- TFS#	3486
-- Description of change
-- FIT results 
------------------------------------------------------------------------------------------------------------------------
GO


IF NOT EXISTS (SELECT 1 FROM sys.columns WHERE name = 'PP_FITResult' AND object_id = OBJECT_ID('ERS_ProceduresReporting'))
	ALTER TABLE dbo.ERS_ProceduresReporting ADD PP_FITResult nvarchar(2000) NULL
GO

IF NOT EXISTS (SELECT 1 FROM dbo.ERS_XMLMap WHERE FieldName = 'PP_FITResult' AND NodeName = 'FIT result' AND [Group] = 'LS')
	INSERT INTO dbo.ERS_XMLMap (FieldName, NodeName, [Group], Active, OrderID)
	VALUES ('PP_FITResult', 'FIT result', 'LS', -1, 1)
GO

IF NOT EXISTS (SELECT 1 FROM UI_Sections WHERE SectionName = 'FIT results')
BEGIN
	
	INSERT INTO UI_Sections (SectionName, SectionControl, ItemOrder, DisplayOnReport, NEDRequired, DNAExempt, PageId)
	VALUES ('FIT results', 'FITResult.ascx', 0, 1, 1, 1, 1)

	DECLARE @UISectionID INT = SCOPE_IDENTITY()

	INSERT INTO dbo.UI_SectionProcedureTypes(UISectionId, ProcedureTypeId)
	VALUES (@UISectionID, 3),
		   (@UISectionID, 4)
END
GO


PRINT N'Creating Table [dbo].[ERS_FitNotKnownReasons]...';


GO
IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE object_id = OBJECT_ID('ERS_FitNotKnownReasons'))
BEGIN
    CREATE TABLE [dbo].[ERS_FitNotKnownReasons] (
    	[UniqueId]       INT           IDENTITY (1, 1) NOT NULL,
    	[Description]    VARCHAR (500) NOT NULL,
    	[NEDTerm]        VARCHAR (500) NOT NULL,
    	[AdditionalInfo] BIT           NOT NULL CONSTRAINT [DF_ERS_FitValueTypes_AdditionalInfo] DEFAULT ((0)),
    	[ListOrderBy]    INT           NOT NULL,
    	[Suppressed]     BIT           NOT NULL CONSTRAINT [DF_ERS_FitValueTypes_Suppressed] DEFAULT ((0)),
    	CONSTRAINT [PK_ERS_FitValueTypes] PRIMARY KEY CLUSTERED ([UniqueId] ASC)
    );
END


GO
PRINT N'Creating Table [dbo].[ERS_ProcedureFitValue]...';


GO
IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE object_id = OBJECT_ID('ERS_ProcedureFitValue'))
BEGIN
    CREATE TABLE [dbo].[ERS_ProcedureFitValue] (
        [ProcedureFitValueTypeId] INT          IDENTITY (1, 1) NOT NULL,
        [ProcedureId]             INT          NOT NULL,
        [FITValue]                VARCHAR (50) NULL,
        [FITNotKnownId]           INT          NULL,
        [WhoCreatedId]            INT          NULL,
        [WhenCreated]             DATETIME     NOT NULL CONSTRAINT [DF_ERS_ProcedureFitValueType_WhenCreated] DEFAULT (getdate()),
        [WhoUpdatedId]            INT          NULL,
        [WhenUpdated]             DATETIME     NULL,
        CONSTRAINT [PK_ERS_ProcedureFitValueType] PRIMARY KEY CLUSTERED ([ProcedureFitValueTypeId] ASC)
    );
END


GO

PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedureFitValueType_ERS_Procedures]...';


GO
IF OBJECT_ID('dbo.FK_ERS_ProcedureFitValueType_ERS_Procedures', 'F') IS NULL
BEGIN
    ALTER TABLE [dbo].[ERS_ProcedureFitValue] WITH NOCHECK
        ADD CONSTRAINT [FK_ERS_ProcedureFitValueType_ERS_Procedures] FOREIGN KEY ([ProcedureId]) REFERENCES [dbo].[ERS_Procedures] ([ProcedureId]);
END

GO
PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedureFitValue_ERS_FitNotKnownReasons]...';


GO
IF OBJECT_ID('dbo.FK_ERS_ProcedureFitValue_ERS_FitNotKnownReasons', 'F') IS NULL
BEGIN
    ALTER TABLE [dbo].[ERS_ProcedureFitValue] WITH NOCHECK
        ADD CONSTRAINT [FK_ERS_ProcedureFitValue_ERS_FitNotKnownReasons] FOREIGN KEY ([FITNotKnownId]) REFERENCES [dbo].[ERS_FitNotKnownReasons] ([UniqueId]);
    
END

GO

DECLARE @FITIndication INT = (SELECT UniqueId FROM dbo.ERS_Indications WHERE Description = 'FIT positive')

IF NOT EXISTS (SELECT 1 FROM dbo.ERS_IndicationsProcedureTypes WHERE IndicationId = @FITIndication AND ProcedureTypeId = 1)
BEGIN
    --fit is now applicable to OGD
    INSERT INTO dbo.ERS_IndicationsProcedureTypes
    (
        IndicationId,
        ProcedureTypeId
    )
    VALUES 
    (@FITIndication,1)
END

--fit value is not longer required
DELETE FROM dbo.ERS_IndicationsProcedureTypes WHERE IndicationId = (SELECT UniqueId FROM dbo.ERS_Indications WHERE ParentId = @FITIndication)
DELETE FROM dbo.ERS_Indications WHERE ParentId = @FITIndication
GO



IF (SELECT COUNT(*) FROM ERS_FitNotKnownReasons) = 0
BEGIN
	INSERT INTO [dbo].[ERS_FitNotKnownReasons]
			   ([Description]
			   ,[NEDTerm]
			   ,[ListOrderBy])
		 VALUES
			   ('FIT not done' ,'FIT not done' ,'1'),
			   ('FIT done, result awaited/unknown' ,'FIT done, result awaited/unknown' ,'2'),
			   ('FIT (qualitative) positive' ,'FIT (qualitative) positive' ,'3'),
			   ('FIT (qualitative) negative' ,'FIT (qualitative) negative' ,'4'),
			   ('FIT carried out through Bowel Cancer Screening Programme' ,'FIT carried out through Bowel Cancer Screening Programme' ,'5')
END
GO

EXEC dbo.DropIfExist @ObjectName = 'fit_not_known_reasons_select',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE fit_not_known_reasons_select
AS
BEGIN
   SELECT UniqueId, [Description], NEDTerm 
   FROM ERS_FitNotKnownReasons
   WHERE Suppressed = 0
   ORDER BY ListOrderBy
END
GO

EXEC dbo.DropIfExist @ObjectName = 'procedure_fit_save',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE procedure_fit_save
(
	@FITValue VARCHAR(50),
	@FITNotKnownId INT,
	@ProcedureId INT,
	@LoggedInUserId INT,
	@Selected BIT	
)
AS
BEGIN

	DECLARE @ReportSummaryText VARCHAR(MAX)

	IF @Selected = 1
	BEGIN
	    IF NOT EXISTS (SELECT 1 FROM ERS_ProcedureFitValue WHERE ProcedureId = @ProcedureId)
		BEGIN
			INSERT INTO ERS_ProcedureFitValue (FITValue, FITNotKnownId, ProcedureId, WhoCreatedId, WhenCreated)
			VALUES (@FITValue, NULLIF(@FITNotKnownId,0), @ProcedureId, @LoggedInUserId, GETDATE())
		END
		ELSE
		BEGIN
			UPDATE ERS_ProcedureFitValue	    
			SET FITValue = @FITValue,
				FITNotKnownId = NULLIF(@FITNotKnownId,0),
				WhoUpdatedId = @LoggedInUserId,
				WhenUpdated = GETDATE()
			WHERE ProcedureId = @ProcedureId
		END	

		EXEC dbo.UI_update_procedure_summary @ProcedureId = @ProcedureId,  -- int
		                                     @Section = 'FIT results',     -- varchar(200)
		                                     @Summary = 'FIT Result:',     -- varchar(max)
		                                     @ResultId = 1,     -- int
		                                     @EndoscopistId = NULL -- int
		
		SET @ReportSummaryText = 'FIT value ' + CASE WHEN @FITValue = '' THEN 'unknown because ' + (SELECT Description FROM ERS_FITNotKnownReasons WHERE UniqueId = @FITNotKnownId) + '.' ELSE CONVERT(VARCHAR, @FITValue) END	
		
	END
	ELSE
	BEGIN	
		DELETE FROM ERS_ProcedureFitValue WHERE ProcedureId = @ProcedureId

				EXEC dbo.UI_update_procedure_summary @ProcedureId = @ProcedureId,  -- int
		                                     @Section = 'FIT results',     -- varchar(200)
		                                     @Summary = 'FIT Result:',     -- varchar(max)
		                                     @ResultId = 0,     -- int
		                                     @EndoscopistId = NULL -- int
		SET @ReportSummaryText = NULL
	END

	IF EXISTS (SELECT 1 FROM dbo.ERS_ProceduresReporting WHERE ProcedureId = @ProcedureId)
	BEGIN
		UPDATE dbo.ERS_ProceduresReporting SET PP_FITResult = @ReportSummaryText WHERE ProcedureID = @ProcedureId
	END

	
END
GO

EXEC dbo.DropIfExist @ObjectName = 'procedure_fit_select',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO


CREATE PROCEDURE procedure_fit_select
(
	@ProcedureId INT
)
AS
BEGIN
	SELECT ProcedureFITValueTypeId, ISNULL(FITValue,'') FITValue, ISNULL(FitNotKnownId,0) FitNotKnownId
	FROM ERS_ProcedureFitValue
	WHERE @ProcedureId = @ProcedureId
END
GO

ALTER FUNCTION [dbo].[tvfNED_ProcedureIndication]
(
	@ProcedureId AS INT
)
-- =============================================
-- Description:	This will return the list of 'Indication' for each Procedure- required for NED Export!
-- =============================================
RETURNS TABLE 
AS
RETURN 
(
  Select procedureindicationid,ISNULL(NULLIF(dbo.HTMLDecode(EI.NEDTerm),''), 'Other') NEDTerm --any entry that does not have a NED term in the lookup table is to be treated as other
		, CASE WHEN EI.NEDTerm = 'Other' then EPI.AdditionalInformation WHEN EI.NEDTerm = '' then EI.[Description] ELSE NULL END AS Comment --where the NED term is blank, the description should be included in the other field
		, CASE WHEN EI.NEDTerm = 'Elevated calprotectin' then EPI.AdditionalInformation ELSE NULL END AS elevatedCalprotectinValue
  from ERS_ProcedureIndications EPI
  join ERS_Indications EI on ISNULL(NULLIF(EPI.ChildIndicationId,0), EPI.IndicationId) = EI.UniqueId
  WHERE EPI.ProcedureId = @ProcedureId
);
GO


PRINT N'Altering Procedure [dbo].[procedure_fit_select]...';


GO


ALTER PROCEDURE procedure_fit_select
(
	@ProcedureId INT
)
AS
BEGIN
	SELECT ProcedureFITValueTypeId, ISNULL(FITValue,'') FITValue, ISNULL(FitNotKnownId,0) FitNotKnownId
	FROM ERS_ProcedureFitValue
	WHERE ProcedureId = @ProcedureId
END
GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea Johnson 07.11.23
-- TFS#	
-- Description of change
-- NED 2.1 Diagnoses 
------------------------------------------------------------------------------------------------------------------------
GO
UPDATE dbo.ERS_AbnormalitiesMatrixUpperGI SET Varices = 1 WHERE Varices = 0
UPDATE dbo.ERS_AbnormalitiesMatrixAntegrade SET Varices = 1 WHERE Varices = 0

UPDATE dbo.ERS_AbnormalitiesMatrixERCP SET Miscellaneous = 1 WHERE Area = 'Duodenum' AND Miscellaneous = 0
GO

IF NOT EXISTS (SELECT 1 FROM dbo.ERS_SiteDetailsMenuUrls WHERE ProcedureType = 2 AND Menu = 'Miscellaneous')
BEGIN
    INSERT INTO ERS_SiteDetailsMenuUrls (ProcedureType, Menu, NavigateUrl)
    VALUES (2,'Miscellaneous','~/Products/Gastro/Abnormalities/OGD/Miscellaneous.aspx')
END
GO

IF NOT EXISTS (SELECT 1 FROM dbo.ERS_DiagnosesMatrix WHERE DisplayName = 'Varices' AND Section = 'Duodenum' AND code LIKE 'DVARICES%')
BEGIN
    INSERT INTO ERS_DiagnosesMatrix (DisplayName, NED_Name, ProcedureTypeID, Section, OrderByNumber, Code, NED_Include)
    VALUES ('Varices', 'Varices', 1, 'Duodenum', 17, 'DVARICESP1', 1)
    	  ,('Varices', 'Varices', 2, 'Duodenum', 17, 'DVARICESP2', 1)
    	  ,('Varices', 'Varices', 3, 'Colon', 17, 'DVARICESP3', 1)
    	  ,('Varices', 'Varices', 4, 'Colon', 17, 'DVARICESP3', 1)
    	  ,('Varices', 'Varices', 6, 'Duodenum', 17, 'DVARICESP1', 1)
    	  ,('Varices', 'Varices', 7, 'Duodenum', 17, 'DVARICESP2', 1)
    	  ,('Varices', 'Varices', 8, 'Duodenum', 17, 'DVARICESP1', 1)
    	  ,('Varices', 'Varices', 9, 'Duodenum', 17, 'DVARICESP3', 1)
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.columns WHERE name = 'Varices' AND object_id = OBJECT_ID('ERS_AbnormalitiesMatrixERCP'))
	ALTER TABLE dbo.ERS_AbnormalitiesMatrixERCP ADD Varices BIT NOT NULL CONSTRAINT [DF_ERS_AbnormalitiesMatrixERCP_Varices] DEFAULT 0
GO

UPDATE ERS_AbnormalitiesMatrixERCP SET Varices = 1 WHERE Area = 'Duodenum' AND Varices = 0
GO

IF NOT EXISTS (SELECT 1 FROM sys.columns WHERE name = 'Varices' AND object_id = OBJECT_ID('ERS_AbnormalitiesMatrixColon'))
	ALTER TABLE dbo.ERS_AbnormalitiesMatrixColon ADD Varices BIT NOT NULL CONSTRAINT [DF_ERS_AbnormalitiesMatrixColon_Varices] DEFAULT 0
GO

UPDATE ERS_AbnormalitiesMatrixColon SET Varices = 1 WHERE Varices = 0
GO

IF NOT EXISTS (SELECT 1 FROM sys.columns WHERE name = 'Varices' AND object_id = OBJECT_ID('ERS_AbnormalitiesMatrixRetrograde'))
	ALTER TABLE dbo.ERS_AbnormalitiesMatrixRetrograde ADD Varices BIT NOT NULL CONSTRAINT [DF_ERS_AbnormalitiesMatrixRetrograde_Varices] DEFAULT 0
GO

UPDATE ERS_AbnormalitiesMatrixRetrograde SET Varices = 1 WHERE Varices = 0
GO


IF NOT EXISTS (SELECT 1 FROM dbo.ERS_SiteDetailsMenuUrls WHERE Menu = 'Varices' AND ProcedureType = 2)
BEGIN
	INSERT INTO ERS_SiteDetailsMenuUrls (ProcedureType, Menu, NavigateUrl)
	SELECT 2, Menu, NavigateUrl FROM dbo.ERS_SiteDetailsMenuUrls WHERE Menu = 'Varices' AND ProcedureType = 1
END


IF NOT EXISTS (SELECT 1 FROM dbo.ERS_SiteDetailsMenuUrls WHERE Menu = 'Varices' AND ProcedureType = 3)
BEGIN
	INSERT INTO ERS_SiteDetailsMenuUrls (ProcedureType, Menu, NavigateUrl)
	SELECT 3, Menu, NavigateUrl FROM dbo.ERS_SiteDetailsMenuUrls WHERE Menu = 'Varices' AND ProcedureType = 1
END


IF NOT EXISTS (SELECT 1 FROM dbo.ERS_SiteDetailsMenuUrls WHERE Menu = 'Varices' AND ProcedureType = 4)
BEGIN
	INSERT INTO ERS_SiteDetailsMenuUrls (ProcedureType, Menu, NavigateUrl)
	SELECT 4, Menu, NavigateUrl FROM dbo.ERS_SiteDetailsMenuUrls WHERE Menu = 'Varices' AND ProcedureType = 1
END


IF NOT EXISTS (SELECT 1 FROM dbo.ERS_SiteDetailsMenuUrls WHERE Menu = 'Varices' AND ProcedureType = 7)
BEGIN
	INSERT INTO ERS_SiteDetailsMenuUrls (ProcedureType, Menu, NavigateUrl)
	SELECT 7, Menu, NavigateUrl FROM dbo.ERS_SiteDetailsMenuUrls WHERE Menu = 'Varices' AND ProcedureType = 1
END


IF NOT EXISTS (SELECT 1 FROM dbo.ERS_SiteDetailsMenuUrls WHERE Menu = 'Varices' AND ProcedureType = 9)
BEGIN
	INSERT INTO ERS_SiteDetailsMenuUrls (ProcedureType, Menu, NavigateUrl)
	SELECT 9, Menu, NavigateUrl FROM dbo.ERS_SiteDetailsMenuUrls WHERE Menu = 'Varices' AND ProcedureType = 1
END
GO

/*VOLVUS*/

--Diagnoses Matrix entry
IF NOT EXISTS (SELECT 1 FROM ERS_DiagnosesMatrix WHERE LOWER(DisplayName) = 'volvulus')
BEGIN
	INSERT INTO ERS_DiagnosesMatrix (DisplayName, NED_Name, ProcedureTypeID, Section, OrderByNumber, Code, NED_Include)
    VALUES ('Volvulus', 'Volvulus', 1, 'Duodenum', 0, 'DVOLVULUSP1', 1),
		   ('Volvulus', 'Volvulus', 2, 'Duodenum', 0, 'DVOLVULUSP2', 1),
		   ('Volvulus', 'Volvulus', 3, 'Colon', 0, 'DVOLVULUSP3', 1),
		   ('Volvulus', 'Volvulus', 4, 'Colon', 0, 'DVOLVULUSP3', 1),
		   ('Volvulus', 'Volvulus', 6, 'Duodenum', 0, 'DVOLVULUSP1', 1),
		   ('Volvulus', 'Volvulus', 7, 'Duodenum', 0, 'DVOLVULUSP2', 1),
		   ('Volvulus', 'Volvulus', 8, 'Duodenum', 0, 'DVOLVULUSP1', 1),
		   ('Volvulus', 'Volvulus', 9, 'Duodenum', 0, 'DVOLVULUSP3', 1)
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.columns WHERE name = 'Volvulus' AND object_id = OBJECT_ID('ERS_ColonAbnoMiscellaneous'))
BEGIN
    ALTER TABLE dbo.ERS_ColonAbnoMiscellaneous
    	ADD Volvulus BIT CONSTRAINT [DF_ERS_ColonAbnoMiscellaneous_Volvulus] DEFAULT 0 NOT NULL
END
GO


IF NOT EXISTS (SELECT 1 FROM sys.columns WHERE name = 'Volvulus' AND object_id = OBJECT_ID('ERSAudit.ERS_ColonAbnoMiscellaneous_Audit'))
BEGIN
    ALTER TABLE ERSAudit.ERS_ColonAbnoMiscellaneous_Audit
    	ADD Volvulus BIT CONSTRAINT [DF_ERS_ColonAbnoMiscellaneous_Audit_Volvulus] DEFAULT 0 NOT NULL
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.columns WHERE name = 'Volvulus' AND object_id = OBJECT_ID('ERS_UpperGIAbnoMiscellaneous'))
BEGIN
    ALTER TABLE dbo.ERS_UpperGIAbnoMiscellaneous
    	ADD Volvulus BIT CONSTRAINT [DF_ERS_UpperGIAbnoMiscellaneous_Volvulus] DEFAULT 0 NOT NULL
END
GO


IF NOT EXISTS (SELECT 1 FROM sys.columns WHERE name = 'Volvulus' AND object_id = OBJECT_ID('ERSAudit.ERS_UpperGIAbnoMiscellaneous_Audit'))
BEGIN
    ALTER TABLE ERSAudit.ERS_UpperGIAbnoMiscellaneous_Audit
    	ADD Volvulus BIT CONSTRAINT [DF_ERS_UpperGIAbnoMiscellaneous_Audit_Volvulus] DEFAULT 0 NOT NULL
END
GO

/*Ampullary adenoma*/


--Diagnoses Matrix entry
IF NOT EXISTS (SELECT 1 FROM ERS_DiagnosesMatrix WHERE LOWER(DisplayName) = 'Ampullary adenoma')
BEGIN
	INSERT INTO ERS_DiagnosesMatrix (DisplayName, NED_Name, ProcedureTypeID, Section, OrderByNumber, Code, NED_Include)
    VALUES ('Ampullary adenoma', 'Ampullary adenoma', 1, 'Duodenum', 0, 'DAAdenomaP1', 1),
		   ('Ampullary adenoma', 'Ampullary adenoma', 2, 'Duodenum', 0, 'DAAdenomaP2', 1),
		   ('Ampullary adenoma', 'Ampullary adenoma', 3, 'Colon', 0, 'DAAdenomaP3', 1),
		   ('Ampullary adenoma', 'Ampullary adenoma', 4, 'Colon', 0, 'DAAdenomaP3', 1),
		   ('Ampullary adenoma', 'Ampullary adenoma', 6, 'Duodenum', 0, 'DAAdenomaP1', 1),
		   ('Ampullary adenoma', 'Ampullary adenoma', 7, 'Duodenum', 0, 'DAAdenomaP2', 1),
		   ('Ampullary adenoma', 'Ampullary adenoma', 8, 'Duodenum', 0, 'DAAdenomaP1', 1),
		   ('Ampullary adenoma', 'Ampullary adenoma', 9, 'Duodenum', 0, 'DAAdenomaP3', 1)
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.columns WHERE name = 'AmpullaryAdenoma' AND object_id = OBJECT_ID('ERS_UpperGIAbnoMiscellaneous'))
BEGIN
    ALTER TABLE dbo.ERS_UpperGIAbnoMiscellaneous
    	ADD AmpullaryAdenoma BIT CONSTRAINT [DF_ERS_UpperGIAbnoMiscellaneous_AmpullaryAdenoma] DEFAULT 0 NOT NULL
END
GO


IF NOT EXISTS (SELECT 1 FROM sys.columns WHERE name = 'AmpullaryAdenoma' AND object_id = OBJECT_ID('ERSAudit.ERS_UpperGIAbnoMiscellaneous_Audit'))
BEGIN
    ALTER TABLE ERSAudit.ERS_UpperGIAbnoMiscellaneous_Audit
    	ADD AmpullaryAdenoma BIT CONSTRAINT [DF_ERS_UpperGIAbnoMiscellaneous_Audit_AmpullaryAdenoma] DEFAULT 0 NOT NULL
END
GO


IF NOT EXISTS (SELECT 1 FROM sys.columns WHERE name = 'AmpullaryAdenoma' AND object_id = OBJECT_ID('ERS_ColonAbnoMiscellaneous'))
BEGIN
    ALTER TABLE dbo.ERS_ColonAbnoMiscellaneous
    	ADD AmpullaryAdenoma BIT CONSTRAINT [DF_ERS_ColonAbnoMiscellaneous_AmpullaryAdenoma] DEFAULT 0 NOT NULL
END
GO


IF NOT EXISTS (SELECT 1 FROM sys.columns WHERE name = 'AmpullaryAdenoma' AND object_id = OBJECT_ID('ERSAudit.ERS_ColonAbnoMiscellaneous_Audit'))
BEGIN
    ALTER TABLE ERSAudit.ERS_ColonAbnoMiscellaneous_Audit
    	ADD AmpullaryAdenoma BIT CONSTRAINT [DF_ERS_ColonAbnoMiscellaneous_Audit_AmpullaryAdenoma] DEFAULT 0 NOT NULL
END
GO


/*Stent Occlusion*/


--Diagnoses Matrix entry
IF NOT EXISTS (SELECT 1 FROM ERS_DiagnosesMatrix WHERE LOWER(NED_Name) = 'stent occlusion')
BEGIN
	INSERT INTO ERS_DiagnosesMatrix (DisplayName, NED_Name, ProcedureTypeID, Section, OrderByNumber, Code, NED_Include)
    VALUES ('Stent occlusion', 'Stent occlusion', 1, 'Oesophagus', 0, 'DOSTECNTOCCP1', 1),
		   ('Stent occlusion', 'Stent occlusion', 1, 'Stomach', 0, 'DSSTECNTOCCP1', 1),
		   ('Stent occlusion', 'Stent occlusion', 1, 'Duodenum', 0, 'DDSTECNTOCCP1', 1),


		   ('Stent occlusion', 'Stent occlusion', 2, 'Duodenum', 0, 'DSTECNTOCCP2', 1),

		   ('Stent occlusion', 'Stent occlusion', 3, 'Colon', 0, 'DSTECNTOCCP3', 1),
		   ('Stent occlusion', 'Stent occlusion', 4, 'Colon', 0, 'DSTECNTOCCP3', 1),
		   ('Stent occlusion', 'Stent occlusion', 9, 'Colon', 0, 'DSTECNTOCCP3', 1),

		   ('Stent occlusion', 'Stent occlusion', 6, 'Oesophagus', 0, 'DOSTECNTOCCP1', 1),
		   ('Stent occlusion', 'Stent occlusion', 6, 'Stomach', 0, 'DSSTECNTOCCP1', 1),
		   ('Stent occlusion', 'Stent occlusion', 6, 'Duodenum', 0, 'DDSTECNTOCCP1', 1),

		   ('Stent occlusion', 'Stent occlusion', 7, 'Duodenum', 0, 'DSTECNTOCCP2', 1),

		   ('Stent occlusion', 'Stent occlusion', 8, 'Oesophagus', 0, 'DOSTECNTOCCP1', 1),
		   ('Stent occlusion', 'Stent occlusion', 8, 'Stomach', 0, 'DSSTECNTOCCP1', 1),
		   ('Stent occlusion', 'Stent occlusion', 8, 'Duodenum', 0, 'DDSTECNTOCCP1', 1)
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.columns WHERE name = 'StentOcclusion' AND object_id = OBJECT_ID('ERS_UpperGIAbnoMiscellaneous'))
BEGIN
    ALTER TABLE dbo.ERS_UpperGIAbnoMiscellaneous
    	ADD StentOcclusion BIT CONSTRAINT [DF_ERS_UpperGIAbnoMiscellaneous_StentOcclusion] DEFAULT 0 NOT NULL
END
GO


IF NOT EXISTS (SELECT 1 FROM sys.columns WHERE name = 'StentOcclusion' AND object_id = OBJECT_ID('ERSAudit.ERS_UpperGIAbnoMiscellaneous_Audit'))
BEGIN
    ALTER TABLE ERSAudit.ERS_UpperGIAbnoMiscellaneous_Audit
    	ADD StentOcclusion BIT CONSTRAINT [DF_ERS_UpperGIAbnoMiscellaneous_Audit_StentOcclusion] DEFAULT 0 NOT NULL
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.columns WHERE name = 'StentOcclusion' AND object_id = OBJECT_ID('ERS_ColonAbnoMiscellaneous'))
BEGIN
    ALTER TABLE dbo.ERS_ColonAbnoMiscellaneous
    	ADD StentOcclusion BIT CONSTRAINT [DF_ERS_ColonAbnoMiscellaneous_StentOcclusion] DEFAULT 0 NOT NULL
END
GO


IF NOT EXISTS (SELECT 1 FROM sys.columns WHERE name = 'StentOcclusion' AND object_id = OBJECT_ID('ERSAudit.ERS_ColonAbnoMiscellaneous_Audit'))
BEGIN
    ALTER TABLE ERSAudit.ERS_ColonAbnoMiscellaneous_Audit
    	ADD StentOcclusion BIT CONSTRAINT [DF_ERS_ColonAbnoMiscellaneous_Audit_StentOcclusion] DEFAULT 0 NOT NULL
END
GO


UPDATE dbo.ERS_AbnormalitiesMatrixUpperGI SET Miscellaneous = 1 WHERE Miscellaneous = 0 AND Area = 'Duodenum'
UPDATE dbo.ERS_AbnormalitiesMatrixAntegrade SET Miscellaneous = 1 WHERE Miscellaneous = 0 AND Area = 'Duodenum'
GO


/*Stent in situ*/


--Diagnoses Matrix entry
IF NOT EXISTS (SELECT 1 FROM ERS_DiagnosesMatrix WHERE LOWER(NED_Name) = 'stent in situ')
BEGIN
	INSERT INTO ERS_DiagnosesMatrix (DisplayName, NED_Name, ProcedureTypeID, Section, OrderByNumber, Code, NED_Include)
    VALUES ('Stent in situ', 'Stent in situ', 1, 'Oesophagus', 0, 'DOSTECNTSITUP1', 1),
		   ('Stent in situ', 'Stent in situ', 1, 'Stomach', 0, 'DSSTECNTSITUP1', 1),
		   ('Stent in situ', 'Stent in situ', 1, 'Duodenum', 0, 'DDSTECNTSITUP1', 1),


		   ('Stent in situ', 'Stent in situ', 2, 'Duodenum', 0, 'DSTECNTSITUP2', 1),

		   ('Stent in situ', 'Stent in situ', 3, 'Colon', 0, 'DSTECNTSITUP3', 1),
		   ('Stent in situ', 'Stent in situ', 4, 'Colon', 0, 'DSTECNTSITUP3', 1),
		   ('Stent in situ', 'Stent in situ', 6, 'Oesophagus', 0, 'DOSTECNTSITUP1', 1),
		   ('Stent in situ', 'Stent in situ', 6, 'Stomach', 0, 'DSSTECNTSITUP1', 1),
		   ('Stent in situ', 'Stent in situ', 6, 'Duodenum', 0, 'DDSTECNTSITUP1', 1),
		   ('Stent in situ', 'Stent in situ', 7, 'Duodenum', 0, 'DSTECNTSITUP2', 1),
		   ('Stent in situ', 'Stent in situ', 8, 'Oesophagus', 0, 'DOSTECNTSITUP1', 1),
		   ('Stent in situ', 'Stent in situ', 8, 'Stomach', 0, 'DSSTECNTSITUP1', 1),
		   ('Stent in situ', 'Stent in situ', 8, 'Duodenum', 0, 'DDSTECNTSITUP1', 1),
		   ('Stent in situ', 'Stent in situ', 9, 'Colon', 0, 'DSTECNTSITUP3', 1)
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.columns WHERE name = 'StentInSitu' AND object_id = OBJECT_ID('ERS_UpperGIAbnoMiscellaneous'))
BEGIN
    ALTER TABLE dbo.ERS_UpperGIAbnoMiscellaneous
    	ADD StentInSitu BIT CONSTRAINT [DF_ERS_UpperGIAbnoMiscellaneous_StentInSitu] DEFAULT 0 NOT NULL
END
GO


IF NOT EXISTS (SELECT 1 FROM sys.columns WHERE name = 'StentInSitu' AND object_id = OBJECT_ID('ERSAudit.ERS_UpperGIAbnoMiscellaneous_Audit'))
BEGIN
    ALTER TABLE ERSAudit.ERS_UpperGIAbnoMiscellaneous_Audit
    	ADD StentInSitu BIT CONSTRAINT [DF_ERS_UpperGIAbnoMiscellaneous_Audit_StentInSitu] DEFAULT 0 NOT NULL
END
GO


IF NOT EXISTS (SELECT 1 FROM sys.columns WHERE name = 'StentInSitu' AND object_id = OBJECT_ID('ERS_ColonAbnoMiscellaneous'))
BEGIN
    ALTER TABLE dbo.ERS_ColonAbnoMiscellaneous
    	ADD StentInSitu BIT CONSTRAINT [DF_ERS_ColonAbnoMiscellaneous_StentInSitu] DEFAULT 0 NOT NULL
END
GO


IF NOT EXISTS (SELECT 1 FROM sys.columns WHERE name = 'StentInSitu' AND object_id = OBJECT_ID('ERSAudit.ERS_ColonAbnoMiscellaneous_Audit'))
BEGIN
    ALTER TABLE ERSAudit.ERS_ColonAbnoMiscellaneous_Audit
    	ADD StentInSitu BIT CONSTRAINT [DF_ERS_ColonAbnoMiscellaneous_Audit_StentInSitu] DEFAULT 0 NOT NULL
END
GO

/*Peg in situ*/


--Diagnoses Matrix entry
IF NOT EXISTS (SELECT 1 FROM ERS_DiagnosesMatrix WHERE LOWER(NED_Name) = 'peg in situ')
BEGIN
	INSERT INTO ERS_DiagnosesMatrix (DisplayName, NED_Name, ProcedureTypeID, Section, OrderByNumber, Code, NED_Include)
    VALUES ('PEG in situ', 'PEG in situ', 1, 'Oesophagus', 0, 'DOPEGINSITUP1', 1),
		   ('PEG in situ', 'PEG in situ', 1, 'Stomach', 0, 'DSPEGINSITUP1', 1),
		   ('PEG in situ', 'PEG in situ', 1, 'Duodenum', 0, 'DDPEGINSITUP1', 1),
		   ('PEG in situ', 'PEG in situ', 2, 'Duodenum', 0, 'DPEGINSITUP2', 1),
		   ('PEG in situ', 'PEG in situ', 3, 'Colon', 0, 'DPEGINSITUP3', 1),
		   ('PEG in situ', 'PEG in situ', 4, 'Colon', 0, 'DPEGINSITUP3', 1),
		   ('PEG in situ', 'PEG in situ', 6, 'Oesophagus', 0, 'DOPEGINSITUP1', 1),
		   ('PEG in situ', 'PEG in situ', 6, 'Stomach', 0, 'DSPEGINSITUP1', 1),
		   ('PEG in situ', 'PEG in situ', 6, 'Duodenum', 0, 'DDPEGINSITUP1', 1),
		   ('PEG in situ', 'PEG in situ', 7, 'Duodenum', 0, 'DPEGINSITUP2', 1),
		   ('PEG in situ', 'PEG in situ', 8, 'Oesophagus', 0, 'DOPEGINSITUP1', 1),
		   ('PEG in situ', 'PEG in situ', 8, 'Stomach', 0, 'DSPEGINSITUP1', 1),
		   ('PEG in situ', 'PEG in situ', 8, 'Duodenum', 0, 'DDPEGINSITUP1', 1),
		   ('PEG in situ', 'PEG in situ', 9, 'Colon', 0, 'DPEGINSITUP3', 1)
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.columns WHERE name = 'PEGInSitu' AND object_id = OBJECT_ID('ERS_UpperGIAbnoMiscellaneous'))
BEGIN
    ALTER TABLE dbo.ERS_UpperGIAbnoMiscellaneous
    	ADD PEGInSitu BIT CONSTRAINT [DF_ERS_UpperGIAbnoMiscellaneous_PEGInSitu] DEFAULT 0 NOT NULL
END
GO


IF NOT EXISTS (SELECT 1 FROM sys.columns WHERE name = 'PEGInSitu' AND object_id = OBJECT_ID('ERSAudit.ERS_UpperGIAbnoMiscellaneous_Audit'))
BEGIN
    ALTER TABLE ERSAudit.ERS_UpperGIAbnoMiscellaneous_Audit
    	ADD PEGInSitu BIT CONSTRAINT [DF_ERS_UpperGIAbnoMiscellaneous_Audit_PEGInSitu] DEFAULT 0 NOT NULL
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.columns WHERE name = 'PEGInSitu' AND object_id = OBJECT_ID('ERS_ColonAbnoMiscellaneous'))
BEGIN
    ALTER TABLE dbo.ERS_ColonAbnoMiscellaneous
    	ADD PEGInSitu BIT CONSTRAINT [DF_ERS_ColonAbnoMiscellaneous_PEGInSitu] DEFAULT 0 NOT NULL
END
GO


IF NOT EXISTS (SELECT 1 FROM sys.columns WHERE name = 'PEGInSitu' AND object_id = OBJECT_ID('ERSAudit.ERS_ColonAbnoMiscellaneous_Audit'))
BEGIN
    ALTER TABLE ERSAudit.ERS_ColonAbnoMiscellaneous_Audit
    	ADD PEGInSitu BIT CONSTRAINT [DF_ERS_ColonAbnoMiscellaneous_Audit_PEGInSitu] DEFAULT 0 NOT NULL
END
GO


/*Pouchitis*/


--Diagnoses Matrix entry
IF NOT EXISTS (SELECT 1 FROM ERS_DiagnosesMatrix WHERE LOWER(NED_Name) = 'pouchitis')
BEGIN
	INSERT INTO ERS_DiagnosesMatrix (DisplayName, NED_Name, ProcedureTypeID, Section, OrderByNumber, Code, NED_Include)
    VALUES ('Pouchitis', 'Pouchitis', 3, 'Colon', 0, 'DOPOUCGITISP3', 1),
		   ('Pouchitis', 'Pouchitis', 4, 'Colon', 0, 'DOPOUCHITIS3', 1),
		   ('Pouchitis', 'Pouchitis', 9, 'Colon', 0, 'DOPOUCHITIS3', 1)
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.columns WHERE name = 'Pouchitis' AND object_id = OBJECT_ID('ERS_ColonAbnoMiscellaneous'))
BEGIN
    ALTER TABLE dbo.ERS_ColonAbnoMiscellaneous
    	ADD Pouchitis BIT CONSTRAINT [DF_ERS_ColonAbnoMiscellaneous_Pouchitis] DEFAULT 0 NOT NULL
END
GO


IF NOT EXISTS (SELECT 1 FROM sys.columns WHERE name = 'Pouchitis' AND object_id = OBJECT_ID('ERSAudit.ERS_ColonAbnoMiscellaneous_Audit'))
BEGIN
    ALTER TABLE ERSAudit.ERS_ColonAbnoMiscellaneous_Audit
    	ADD Pouchitis BIT CONSTRAINT [DF_ERS_ColonAbnoMiscellaneous_Audit_Pouchitis] DEFAULT 0 NOT NULL
END
GO

/*Radiation proctopathy*/


--Diagnoses Matrix entry
IF NOT EXISTS (SELECT 1 FROM ERS_DiagnosesMatrix WHERE LOWER(NED_Name) = 'radiation proctopathy')
BEGIN
	INSERT INTO ERS_DiagnosesMatrix (DisplayName, NED_Name, ProcedureTypeID, Section, OrderByNumber, Code, NED_Include)
    VALUES ('Radiation proctopathy', 'Radiation proctopathy', 3, 'Colon', 0, 'DRPROCTP3', 1),
		   ('Radiation proctopathy', 'Radiation proctopathy', 4, 'Colon', 0, 'DRPROCTP3', 1),
		   ('Radiation proctopathy', 'Radiation proctopathy', 9, 'Colon', 0, 'DRPROCTP3', 1)

END
GO

/*Previous ESD scar*/


--Diagnoses Matrix entry
IF NOT EXISTS (SELECT 1 FROM ERS_DiagnosesMatrix WHERE LOWER(NED_Name) = 'Previous ESD Scar')
BEGIN
	INSERT INTO ERS_DiagnosesMatrix (DisplayName, NED_Name, ProcedureTypeID, Section, OrderByNumber, Code, NED_Include)
    VALUES ('Previous ESD Scar', 'Previous ESD Scar', 3, 'Colon', 0, 'DESDSCARP3', 1),
		   ('Previous ESD Scar', 'Previous ESD Scar', 4, 'Colon', 0, 'DESDSCARP3', 1),
		   ('Previous ESD Scar', 'Previous ESD Scar', 9, 'Colon', 0, 'DESDSCARP3', 1),

		   ('Previous ESD Scar', 'Previous ESD Scar', 1, 'Oesophagus', 0, 'DOESDSCARP1', 1),
		   ('Previous ESD Scar', 'Previous ESD Scar', 1, 'Stomach', 0, 'DSESDSCARP1', 1),
		   ('Previous ESD Scar', 'Previous ESD Scar', 1, 'Duodenum', 0, 'DDESDSCARP1', 1),
		   

		   ('Previous ESD Scar', 'Previous ESD Scar', 6, 'Oesophagus', 0, 'DOESDSCARP1', 1),
		   ('Previous ESD Scar', 'Previous ESD Scar', 6, 'Stomach', 0, 'DSESDSCARP1', 1),
		   ('Previous ESD Scar', 'Previous ESD Scar', 6, 'Duodenum', 0, 'DDESDSCARP1', 1),

		   
		   ('Previous ESD Scar', 'Previous ESD Scar', 8, 'Oesophagus', 0, 'DOESDSCARP1', 1),
		   ('Previous ESD Scar', 'Previous ESD Scar', 8, 'Stomach', 0, 'DSESDSCARP1', 1),
		   ('Previous ESD Scar', 'Previous ESD Scar', 8, 'Duodenum', 0, 'DDESDSCARP1', 1)
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.columns WHERE name = 'PreviousESDScar' AND object_id = OBJECT_ID('ERS_CommonAbnoLesions'))
BEGIN
    ALTER TABLE dbo.ERS_CommonAbnoLesions
    	ADD PreviousESDScar BIT CONSTRAINT [DF_ERS_ERS_CommonAbnoLesions_PreviousESDScar] DEFAULT 0 NOT NULL
END
GO


ALTER TRIGGER [dbo].[TR_ColonAbnoMiscellaneous]
ON [dbo].[ERS_ColonAbnoMiscellaneous]
AFTER INSERT, UPDATE, DELETE
AS 
	DECLARE @site_id INT, 
			@Action CHAR(1) = 'I',
			@Crohns VARCHAR(10) = 'False',
			@Fistula VARCHAR(10) = 'False',
			@ForeignBody VARCHAR(10) = 'False',
			@Lipoma VARCHAR(10) = 'False',
			@Melanosis VARCHAR(10) = 'False',
			@Parasites VARCHAR(10) = 'False',
			@PneuColi VARCHAR(10) = 'False',
			@PolypSyndrome VARCHAR(10) = 'False',
			@PostOp VARCHAR(10) = 'False',
			@PseudoObstruction VARCHAR(10) = 'False',
			@Pouchitis VARCHAR(10) = 'False',
			@Volvulus VARCHAR(10) = 'False',
			@AmpullaryAdenoma VARCHAR(10) = 'False',
			@StentInSitu VARCHAR(10) = 'False',
			@PEGInSitu VARCHAR(10) = 'False',
			@StentOcclusion VARCHAR(10) = 'False',
			@Other VARCHAR(10) = 'False'

	IF EXISTS(SELECT * FROM DELETED) SET @Action = CASE WHEN EXISTS(SELECT * FROM INSERTED) THEN 'U' ELSE 'D' END

	-- INSERTED OR UPDATED
	IF @Action IN ('I', 'U') 
	BEGIN
		SELECT @site_id=SiteId,
				@Crohns = (CASE WHEN (Crohn=1) THEN 'True' ELSE 'False' END),
				@Fistula = (CASE WHEN (Fistula=1) THEN 'True' ELSE 'False' END),
				@ForeignBody = (CASE WHEN (ForeignBody=1) THEN 'True' ELSE 'False' END),
				@Lipoma = (CASE WHEN (Lipoma=1) THEN 'True' ELSE 'False' END),
				@Melanosis = (CASE WHEN (Melanosis=1) THEN 'True' ELSE 'False' END),
				@Parasites = (CASE WHEN (Parasites=1) THEN 'True' ELSE 'False' END),
				@PneuColi = (CASE WHEN (PneumatosisColi=1) THEN 'True' ELSE 'False' END),
				@PolypSyndrome = (CASE WHEN (PolyposisSyndrome=1) THEN 'True' ELSE 'False' END),
				@PostOp = (CASE WHEN (PostoperativeAppearance=1) THEN 'True' ELSE 'False' END),
				@PseudoObstruction = (CASE WHEN (PseudoObstruction=1) THEN 'True' ELSE 'False' END),
				@Pouchitis = (CASE WHEN (Pouchitis=1) THEN 'True' ELSE 'False' END),
				@Volvulus = (CASE WHEN (Volvulus=1) THEN 'True' ELSE 'False' END),
				@AmpullaryAdenoma = (CASE WHEN (AmpullaryAdenoma=1) THEN 'True' ELSE 'False' END),
				@StentInSitu = (CASE WHEN (StentInSitu=1) THEN 'True' ELSE 'False' END),
				@PEGInSitu = (CASE WHEN (PEGInSitu=1) THEN 'True' ELSE 'False' END),
				@StentOcclusion = (CASE WHEN (StentOcclusion=1) THEN 'True' ELSE 'False' END),
				@Other = (CASE WHEN (ISNULL(Other,'') <> '') THEN 'True' ELSE 'False' END)
		FROM INSERTED

		EXEC abnormalities_colon_miscellaneous_summary_update @site_id
	END

	-- DELETED
	IF @Action = 'D'
	BEGIN
		SELECT @site_id=SiteId FROM DELETED
	END

	EXEC sites_summary_update @site_id
	EXEC diagnoses_control_save @site_id, 'D86P3', @Crohns			
	EXEC diagnoses_control_save @site_id, 'D71P3', @Fistula			
	EXEC diagnoses_control_save @site_id, 'D72P3', @ForeignBody			
	EXEC diagnoses_control_save @site_id, 'D73P3', @Lipoma			
	EXEC diagnoses_control_save @site_id, 'D74P3', @Melanosis			
	EXEC diagnoses_control_save @site_id, 'D75P3', @Parasites			
	EXEC diagnoses_control_save @site_id, 'D76P3', @PneuColi			
	EXEC diagnoses_control_save @site_id, 'D77P3', @PolypSyndrome			
	EXEC diagnoses_control_save @site_id, 'D78P3', @PostOp			
	EXEC diagnoses_control_save @site_id, 'D9P3', @PseudoObstruction			
	EXEC diagnoses_control_save @site_id, 'DOPOUCGITISP3', @Pouchitis					
	EXEC diagnoses_control_save @site_id, 'DVOLVULUSP3', @Volvulus						
	EXEC diagnoses_control_save @site_id, 'DAAdenomaP3', @AmpullaryAdenoma				
	EXEC diagnoses_control_save @site_id, 'DSTECNTSITUP3', @StentInSitu				
	EXEC diagnoses_control_save @site_id, 'DPEGINSITUP3', @PEGInSitu				
	EXEC diagnoses_control_save @site_id, 'DSTECNTOCCP3', @StentOcclusion				
	EXEC diagnoses_control_save @site_id, 'SN2016', @Other
GO


ALTER TRIGGER [dbo].[TR_CommonAbnoLesions]
ON [dbo].[ERS_CommonAbnoLesions]
AFTER INSERT, UPDATE, DELETE
AS 
	DECLARE @site_id INT, @Polyp VARCHAR(10) = 'False', 
						  @BenignTumour VARCHAR(10) = 'False', 
						  @MalignantTumour VARCHAR(10) = 'False', 
						  @SubmucosalTumour VARCHAR(10) = 'False', 
						  @FocalLesions VARCHAR(10) = 'False',
						  @SubmucoaslLesion VARCHAR(10) = 'False',
						  @FundicGlandPolyp VARCHAR(10) = 'False',
						  @PreviousESDScar VARCHAR(10) = 'False',
			@PolypTypeId int, @Region varchar(20), @ProcedureTypeId int, @MatrixCode varchar(50)
	
	IF EXISTS(SELECT * FROM INSERTED)
	BEGIN
		SELECT @site_id=SiteId,
				@Polyp = (CASE WHEN (ISNULL(Polyp,0) = 1) THEN 'True' ELSE 'False' END),
				@FocalLesions = (CASE WHEN (ISNULL(Focal,0) = 1) THEN 'True' ELSE 'False' END),
				@SubmucoaslLesion = (CASE WHEN (ISNULL(Submucosal,0) = 1) THEN 'True' ELSE 'False' END),
				@FundicGlandPolyp = (CASE WHEN (ISNULL(FundicGlandPolyp,0) = 1) THEN 'True' ELSE 'False' END),
				@PolypTypeId = PolypTypeId,
				@PreviousESDScar = (CASE WHEN (ISNULL(PreviousESDScar,0) = 1) THEN 'True' ELSE 'False' END)
				
		FROM INSERTED

		SELECT TOP 1 @ProcedureTypeId =  p.ProcedureType FROM ERS_Sites s INNER JOIN ERS_Procedures p ON p.ProcedureId = s.ProcedureId WHERE s.SiteId = @site_id
		--check if polyps = 1
		IF @Polyp = 'True' 
		BEGIN
			--check for polyp type
			DECLARE @PolypType VARCHAR(200) = (SELECT Description FROM ERS_PolypTypes WHERE UniqueId = @PolypTypeId)

			IF LOWER(@PolypType) = 'sessile'
			BEGIN
				--sessile polyps to produce a gastric tumour outcome depending on the tumour type
				IF EXISTS (SELECT 1 FROM ERS_CommonAbnoPolypDetails WHERE SiteId = @site_id AND Type = (SELECT UniqueId FROM ERS_TumourTypes WHERE Description = 'benign'))
					SET @BenignTumour = 'True'
				ELSE 
					SET @BenignTumour = 'False'

				IF EXISTS (SELECT 1 FROM ERS_CommonAbnoPolypDetails WHERE SiteId = @site_id AND Type = (SELECT UniqueId FROM ERS_TumourTypes WHERE Description = 'malignant'))
					SET @MalignantTumour = 'True'
				ELSE
					SET @MalignantTumour = 'False'
			END
			
			IF LOWER(@PolypType) = 'submucosal'  AND LOWER(@Region) = 'stomach'
				SET @SubmucoaslLesion = 'True'
			ELSE
				SET @SubmucoaslLesion = 'False'

		END
		
		IF @ProcedureTypeId IN (1,6,8)
		BEGIN
			SELECT @Region = dbo.fnSiteRegion(@site_id)

			IF LOWER(@Region) = 'stomach'
			BEGIN
				--SELECT @Polyp = CASE WHEN @FundicGlandPolyp = 'False' AND @BenignTumour = 'False' AND @MalignantTumour = 'False' AND @SubmucosalTumour = 'False' THEN 'True' ELSE 'False' END
				SET @MatrixCode = 'D40P1'
			END
			ELSE IF LOWER(@Region) = 'oesophagus'
				SET @MatrixCode = 'N2013'
			ELSE IF LOWER(@Region) = 'duodenum'
				SET @MatrixCode = 'D58P1'
			ELSE IF LOWER(@Region) = 'colon'
				SET @MatrixCode = 'D58P1'
				
		END
		ELSE IF @ProcedureTypeId IN (3,4,9)
		BEGIN
			SELECT @Region = dbo.fnSiteRegion(@site_id)

			IF @Polyp = 'True' AND @Region IN ('Rectum', 'Anal Margin')
				SET @MatrixCode = 'D4P3'

			IF @Polyp = 'True' AND @Region NOT IN ('Rectum', 'Anal Margin', 'Terminal Ileum')
				SET @MatrixCode = 'D12P3'

			IF @Polyp = 'True' AND @Region IN ('Terminal Ileum', 'Neo-Terminal Ileum')
				SET @MatrixCode = 'DIPOLYPP3'
		END

	END
	ELSE
	BEGIN
		SELECT @site_id=SiteId FROM DELETED
	END

	EXEC abnormalities_common_lesions_summary_update @site_id

	IF @site_id IS NOT NULL AND @ProcedureTypeId IN (1,3,4,6,8,9)
	BEGIN
		EXEC sites_summary_update @site_id

		EXEC diagnoses_control_save @site_id, @MatrixCode, @Polyp		
		--EXEC diagnoses_control_save @site_id, 'D86P1', @BenignTumour	
		--EXEC diagnoses_control_save @site_id, 'D87P1', @MalignantTumour	
		EXEC diagnoses_control_save @site_id, 'N2001', @FocalLesions
		EXEC diagnoses_control_save @site_id, 'D88P1', @SubmucosalTumour
		EXEC diagnoses_control_save @site_id, 'N2002', @SubmucoaslLesion
		EXEC diagnoses_control_save @site_id, 'N2019', @FundicGlandPolyp

		IF LOWER(@Region) = 'stomach'
		BEGIN
			EXEC diagnoses_control_save @site_id, 'DSESDSCARP1', @PreviousESDScar		
		END
		ELSE IF LOWER(@Region) = 'oesophagus'
		BEGIN
			EXEC diagnoses_control_save @site_id, 'DOESDSCARP1', @PreviousESDScar
		END
		ELSE IF LOWER(@Region) = 'duodenum'
		BEGIN
			EXEC diagnoses_control_save @site_id, 'DDESDSCARP1', @PreviousESDScar
		END
		ELSE IF LOWER(@Region) = 'colon'
		BEGIN
			EXEC diagnoses_control_save @site_id, 'DESDSCARP3', @PreviousESDScar
		END
	END
GO


PRINT N'Altering Trigger [dbo].[TR_UpperGIAbnoMiscellaneous_Delete]...';


GO

ALTER TRIGGER [dbo].[TR_UpperGIAbnoMiscellaneous_Delete]
ON [dbo].[ERS_UpperGIAbnoMiscellaneous]
AFTER DELETE
AS 
	DECLARE @site_id INT
	SELECT @site_id=SiteId FROM DELETED

	EXEC ogd_kpi_stricture_perforation @site_id --Update perforation text in QA for OGD KPI

	EXEC diagnoses_control_save @site_id, 'D32P1', 'False'		-- 'Diverticulum'
	EXEC diagnoses_control_save @site_id, 'D35P1', 'False'		-- 'Foreignbody'
	EXEC diagnoses_control_save @site_id, 'D24P1', 'False'		-- 'MaloryWeissTear'
	EXEC diagnoses_control_save @site_id, 'D28P1', 'False'		-- 'MotilityDisorder'
	EXEC diagnoses_control_save @site_id, 'D21P1', 'False'		-- 'Stricture'
	EXEC diagnoses_control_save @site_id, 'D72P1', 'False'		-- 'StrictureBenign'
	EXEC diagnoses_control_save @site_id, 'D73P1', 'False'		-- 'StrictureMalignant'
	EXEC diagnoses_control_save @site_id, 'D74P1', 'False'		-- 'Tumour'
	EXEC diagnoses_control_save @site_id, 'D25P1', 'False'		-- 'TumourBenign'
	EXEC diagnoses_control_save @site_id, 'D29P1', 'False'		-- 'TumourProbablyBenign'
	EXEC diagnoses_control_save @site_id, 'D34P1', 'False'		-- 'TumourMalignant'
	EXEC diagnoses_control_save @site_id, 'D37P1', 'False'		-- 'TumourProbablyMalignant'
	EXEC diagnoses_control_save @site_id, 'D26P1', 'False'		-- 'Ulcer'
	EXEC diagnoses_control_save @site_id, 'D38P1', 'False'		-- 'Web'
	EXEC diagnoses_control_save @site_id, 'D71P1', 'False'		-- 'SchatzkiRing'
	EXEC diagnoses_control_save @site_id, 'D67P1', 'False'		-- 'ExtrinsicCompression'
	EXEC diagnoses_control_save @site_id, 'D69P1', 'False'		-- 'Pharyngeal Pouch'
	EXEC diagnoses_control_save @site_id, 'D98P1', 'False'		-- 'Inlet Patch'				
	EXEC diagnoses_control_save @site_id, 'D99P1', 'False'		-- 'Food Residue'		
	EXEC diagnoses_control_save @site_id, 'D100P1', 'False'		-- 'Other'
	EXEC diagnoses_control_save @site_id, 'StomachNotEntered', 'False'			-- 'scope could not pass
	EXEC diagnoses_control_save @site_id, 'DuodenumNotEntered', 'False'			-- 'scope could not pass
	EXEC diagnoses_control_save @site_id, 'DInletPouchP1', 'False'			-- 'Inlet Pouch
	EXEC diagnoses_control_save @site_id, 'D68P1', 'False'
	EXEC diagnoses_control_save @site_id, 'DOSTECNTOCCP1', 'False'
	EXEC diagnoses_control_save @site_id, 'DSSTECNTOCCP1', 'False'
	EXEC diagnoses_control_save @site_id, 'DDSTECNTOCCP1', 'False'
	EXEC diagnoses_control_save @site_id, 'DVOLVULUSP1', 'False'				
	EXEC diagnoses_control_save @site_id, 'DAAdenomaP1', 'False'
	EXEC diagnoses_control_save @site_id, 'DOSTECNTSITUP1', 'False'
	EXEC diagnoses_control_save @site_id, 'DDSTECNTSITUP1', 'False'
	EXEC diagnoses_control_save @site_id, 'DSSTECNTSITUP1', 'False'

	EXEC sites_summary_update @site_id
GO
PRINT N'Altering Trigger [dbo].[trg_ERS_UpperGIAbnoMiscellaneous_Delete]...';


GO
ALTER TRIGGER [dbo].[trg_ERS_UpperGIAbnoMiscellaneous_Delete] 
							ON [dbo].[ERS_UpperGIAbnoMiscellaneous] 
							AFTER DELETE
						AS 
							SET NOCOUNT ON; 
							INSERT INTO [ERSAudit].[ERS_UpperGIAbnoMiscellaneous_Audit] (AbnoMiscellaneousId, tbl.[SiteId], tbl.[None], tbl.[Web], tbl.[Mallory], tbl.[SchatzkiRing], tbl.[FoodResidue], tbl.[ExtrinsicCompression], tbl.[Diverticulum], tbl.[DivertMultiple], tbl.[DivertQty], tbl.[Pharyngeal], tbl.[DiffuseIntramural], tbl.[TractionType], tbl.[PulsionType], tbl.[MotilityDisorder], tbl.[ProbableAchalasia], tbl.[ConfirmedAchalasia], tbl.[Presbyoesophagus], tbl.[MarkedTertiaryContractions], tbl.[LaxLowerOesoSphincter], tbl.[TortuousOesophagus], tbl.[DilatedOesophagus], tbl.[MotilityPoor], tbl.[Ulceration], tbl.[UlcerationType], tbl.[UlcerationMultiple], tbl.[UlcerationQty], tbl.[UlcerationLength], tbl.[UlcerationClotInBase], tbl.[UlcerationReflux], tbl.[UlcerationPostSclero], tbl.[UlcerationPostBanding], tbl.[Stricture], tbl.[StrictureCompression], tbl.[StrictureScopeNotPass], tbl.[StrictureSeverity], tbl.[StrictureType], tbl.[StrictureProbably], tbl.[StrictureBenignType], tbl.[StrictureBeginning], tbl.[StrictureLength], tbl.[StricturePerforation], tbl.[Tumour], tbl.[TumourType], tbl.[TumourProbably], tbl.[TumourExophytic], tbl.[TumourBenignType], tbl.[TumourBenignTypeOther], tbl.[TumourBeginning], tbl.[TumourLength], tbl.[MiscOther], tbl.[IsLAClassification], tbl.[Foreignbody], tbl.[EUSProcType], tbl.[InletPatch], tbl.[InletPatchMultiple], tbl.[InletPatchQty], tbl.[Summary],  LastActionId, ActionDateTime, ActionUserId, TumorScopeNotPass, TumourScopeNotPass, Fitsula, InletPouch, InletPouchQty, Volvulus)
							SELECT tbl.AbnoMiscellaneousId , tbl.[SiteId], tbl.[None], tbl.[Web], tbl.[Mallory], tbl.[SchatzkiRing], tbl.[FoodResidue], tbl.[ExtrinsicCompression], tbl.[Diverticulum], tbl.[DivertMultiple], tbl.[DivertQty], tbl.[Pharyngeal], tbl.[DiffuseIntramural], tbl.[TractionType], tbl.[PulsionType], tbl.[MotilityDisorder], tbl.[ProbableAchalasia], tbl.[ConfirmedAchalasia], tbl.[Presbyoesophagus], tbl.[MarkedTertiaryContractions], tbl.[LaxLowerOesoSphincter], tbl.[TortuousOesophagus], tbl.[DilatedOesophagus], tbl.[MotilityPoor], tbl.[Ulceration], tbl.[UlcerationType], tbl.[UlcerationMultiple], tbl.[UlcerationQty], tbl.[UlcerationLength], tbl.[UlcerationClotInBase], tbl.[UlcerationReflux], tbl.[UlcerationPostSclero], tbl.[UlcerationPostBanding], tbl.[Stricture], tbl.[StrictureCompression], tbl.[StrictureScopeNotPass], tbl.[StrictureSeverity], tbl.[StrictureType], tbl.[StrictureProbably], tbl.[StrictureBenignType], tbl.[StrictureBeginning], tbl.[StrictureLength], tbl.[StricturePerforation], tbl.[Tumour], tbl.[TumourType], tbl.[TumourProbably], tbl.[TumourExophytic], tbl.[TumourBenignType], tbl.[TumourBenignTypeOther], tbl.[TumourBeginning], tbl.[TumourLength], tbl.[MiscOther], tbl.[IsLAClassification], tbl.[Foreignbody], tbl.[EUSProcType], tbl.[InletPatch], tbl.[InletPatchMultiple], tbl.[InletPatchQty], tbl.[Summary],  3, GETDATE(), tbl.WhoUpdatedId, tbl.TumorScopeNotPass, tbl.TumourScopeNotPass, tbl.Fitsula, tbl.[InletPouch], tbl.[InletPouchQty], tbl.Volvulus
							FROM deleted tbl
GO
PRINT N'Altering Trigger [dbo].[trg_ERS_UpperGIAbnoMiscellaneous_Insert]...';


GO
ALTER TRIGGER [dbo].[trg_ERS_UpperGIAbnoMiscellaneous_Insert] 
							ON [dbo].[ERS_UpperGIAbnoMiscellaneous] 
							AFTER INSERT
						AS 
							SET NOCOUNT ON; 
							INSERT INTO [ERSAudit].[ERS_UpperGIAbnoMiscellaneous_Audit] (AbnoMiscellaneousId, tbl.[SiteId], tbl.[None], tbl.[Web], tbl.[Mallory], tbl.[SchatzkiRing], tbl.[FoodResidue], tbl.[ExtrinsicCompression], tbl.[Diverticulum], tbl.[DivertMultiple], tbl.[DivertQty], tbl.[Pharyngeal], tbl.[DiffuseIntramural], tbl.[TractionType], tbl.[PulsionType], tbl.[MotilityDisorder], tbl.[ProbableAchalasia], tbl.[ConfirmedAchalasia], tbl.[Presbyoesophagus], tbl.[MarkedTertiaryContractions], tbl.[LaxLowerOesoSphincter], tbl.[TortuousOesophagus], tbl.[DilatedOesophagus], tbl.[MotilityPoor], tbl.[Ulceration], tbl.[UlcerationType], tbl.[UlcerationMultiple], tbl.[UlcerationQty], tbl.[UlcerationLength], tbl.[UlcerationClotInBase], tbl.[UlcerationReflux], tbl.[UlcerationPostSclero], tbl.[UlcerationPostBanding], tbl.[Stricture], tbl.[StrictureCompression], tbl.[StrictureScopeNotPass], tbl.[StrictureSeverity], tbl.[StrictureType], tbl.[StrictureProbably], tbl.[StrictureBenignType], tbl.[StrictureBeginning], tbl.[StrictureLength], tbl.[StricturePerforation], tbl.[Tumour], tbl.[TumourType], tbl.[TumourProbably], tbl.[TumourExophytic], tbl.[TumourBenignType], tbl.[TumourBenignTypeOther], tbl.[TumourBeginning], tbl.[TumourLength], tbl.[MiscOther], tbl.[IsLAClassification], tbl.[Foreignbody], tbl.[EUSProcType], tbl.[InletPatch], tbl.[InletPatchMultiple], tbl.[InletPatchQty], tbl.[Summary],  LastActionId, ActionDateTime, ActionUserId, TumorScopeNotPass, TumourScopeNotPass, Fitsula, InletPouch, InletPouchQty, Volvulus)
							SELECT tbl.AbnoMiscellaneousId , tbl.[SiteId], tbl.[None], tbl.[Web], tbl.[Mallory], tbl.[SchatzkiRing], tbl.[FoodResidue], tbl.[ExtrinsicCompression], tbl.[Diverticulum], tbl.[DivertMultiple], tbl.[DivertQty], tbl.[Pharyngeal], tbl.[DiffuseIntramural], tbl.[TractionType], tbl.[PulsionType], tbl.[MotilityDisorder], tbl.[ProbableAchalasia], tbl.[ConfirmedAchalasia], tbl.[Presbyoesophagus], tbl.[MarkedTertiaryContractions], tbl.[LaxLowerOesoSphincter], tbl.[TortuousOesophagus], tbl.[DilatedOesophagus], tbl.[MotilityPoor], tbl.[Ulceration], tbl.[UlcerationType], tbl.[UlcerationMultiple], tbl.[UlcerationQty], tbl.[UlcerationLength], tbl.[UlcerationClotInBase], tbl.[UlcerationReflux], tbl.[UlcerationPostSclero], tbl.[UlcerationPostBanding], tbl.[Stricture], tbl.[StrictureCompression], tbl.[StrictureScopeNotPass], tbl.[StrictureSeverity], tbl.[StrictureType], tbl.[StrictureProbably], tbl.[StrictureBenignType], tbl.[StrictureBeginning], tbl.[StrictureLength], tbl.[StricturePerforation], tbl.[Tumour], tbl.[TumourType], tbl.[TumourProbably], tbl.[TumourExophytic], tbl.[TumourBenignType], tbl.[TumourBenignTypeOther], tbl.[TumourBeginning], tbl.[TumourLength], tbl.[MiscOther], tbl.[IsLAClassification], tbl.[Foreignbody], tbl.[EUSProcType], tbl.[InletPatch], tbl.[InletPatchMultiple], tbl.[InletPatchQty], tbl.[Summary],  1, GETDATE(), tbl.WhoCreatedId, tbl.TumorScopeNotPass, tbl.TumourScopeNotPass, tbl.Fitsula, tbl.InletPouch, tbl.InletPouchQty, tbl.Volvulus
							FROM inserted tbl
GO
PRINT N'Altering Trigger [dbo].[trg_ERS_UpperGIAbnoMiscellaneous_Update]...';


GO
ALTER TRIGGER [dbo].[trg_ERS_UpperGIAbnoMiscellaneous_Update] 
								ON [dbo].[ERS_UpperGIAbnoMiscellaneous] 
								AFTER UPDATE
							AS 
								SET NOCOUNT ON; 
								IF NOT UPDATE(Summary)
								BEGIN
									INSERT INTO [ERSAudit].[ERS_UpperGIAbnoMiscellaneous_Audit] (AbnoMiscellaneousId, tbl.[SiteId], tbl.[None], tbl.[Web], tbl.[Mallory], tbl.[SchatzkiRing], tbl.[FoodResidue], tbl.[ExtrinsicCompression], tbl.[Diverticulum], tbl.[DivertMultiple], tbl.[DivertQty], tbl.[Pharyngeal], tbl.[DiffuseIntramural], tbl.[TractionType], tbl.[PulsionType], tbl.[MotilityDisorder], tbl.[ProbableAchalasia], tbl.[ConfirmedAchalasia], tbl.[Presbyoesophagus], tbl.[MarkedTertiaryContractions], tbl.[LaxLowerOesoSphincter], tbl.[TortuousOesophagus], tbl.[DilatedOesophagus], tbl.[MotilityPoor], tbl.[Ulceration], tbl.[UlcerationType], tbl.[UlcerationMultiple], tbl.[UlcerationQty], tbl.[UlcerationLength], tbl.[UlcerationClotInBase], tbl.[UlcerationReflux], tbl.[UlcerationPostSclero], tbl.[UlcerationPostBanding], tbl.[Stricture], tbl.[StrictureCompression], tbl.[StrictureScopeNotPass], tbl.[StrictureSeverity], tbl.[StrictureType], tbl.[StrictureProbably], tbl.[StrictureBenignType], tbl.[StrictureBeginning], tbl.[StrictureLength], tbl.[StricturePerforation], tbl.[Tumour], tbl.[TumourType], tbl.[TumourProbably], tbl.[TumourExophytic], tbl.[TumourBenignType], tbl.[TumourBenignTypeOther], tbl.[TumourBeginning], tbl.[TumourLength], tbl.[MiscOther], tbl.[IsLAClassification], tbl.[Foreignbody], tbl.[EUSProcType], tbl.[InletPatch], tbl.[InletPatchMultiple], tbl.[InletPatchQty], tbl.[Summary],  LastActionId, ActionDateTime, ActionUserId, TumorScopeNotPass, TumourScopeNotPass, Fitsula, InletPouch, InletPouchQty, Volvulus)
									SELECT tbl.AbnoMiscellaneousId , tbl.[SiteId], tbl.[None], tbl.[Web], tbl.[Mallory], tbl.[SchatzkiRing], tbl.[FoodResidue], tbl.[ExtrinsicCompression], tbl.[Diverticulum], tbl.[DivertMultiple], tbl.[DivertQty], tbl.[Pharyngeal], tbl.[DiffuseIntramural], tbl.[TractionType], tbl.[PulsionType], tbl.[MotilityDisorder], tbl.[ProbableAchalasia], tbl.[ConfirmedAchalasia], tbl.[Presbyoesophagus], tbl.[MarkedTertiaryContractions], tbl.[LaxLowerOesoSphincter], tbl.[TortuousOesophagus], tbl.[DilatedOesophagus], tbl.[MotilityPoor], tbl.[Ulceration], tbl.[UlcerationType], tbl.[UlcerationMultiple], tbl.[UlcerationQty], tbl.[UlcerationLength], tbl.[UlcerationClotInBase], tbl.[UlcerationReflux], tbl.[UlcerationPostSclero], tbl.[UlcerationPostBanding], tbl.[Stricture], tbl.[StrictureCompression], tbl.[StrictureScopeNotPass], tbl.[StrictureSeverity], tbl.[StrictureType], tbl.[StrictureProbably], tbl.[StrictureBenignType], tbl.[StrictureBeginning], tbl.[StrictureLength], tbl.[StricturePerforation], tbl.[Tumour], tbl.[TumourType], tbl.[TumourProbably], tbl.[TumourExophytic], tbl.[TumourBenignType], tbl.[TumourBenignTypeOther], tbl.[TumourBeginning], tbl.[TumourLength], tbl.[MiscOther], tbl.[IsLAClassification], tbl.[Foreignbody], tbl.[EUSProcType], tbl.[InletPatch], tbl.[InletPatchMultiple], tbl.[InletPatchQty], tbl.[Summary],  2, GETDATE(), i.WhoUpdatedId, tbl.TumorScopeNotPass, tbl.TumourScopeNotPass, tbl.Fitsula, tbl.InletPouch, tbl.InletPouchQty, tbl.Volvulus
									FROM deleted tbl INNER JOIN inserted i ON tbl.AbnoMiscellaneousId = i.AbnoMiscellaneousId
								END
GO
PRINT N'Altering Trigger [dbo].[TR_UpperGIAbnoVarices]...';


GO


ALTER TRIGGER [dbo].[TR_UpperGIAbnoVarices]
ON [dbo].[ERS_UpperGIAbnoVarices]
AFTER INSERT, UPDATE, DELETE 
AS 
	DECLARE @site_id INT, 
			@Action CHAR(1) = 'I', 
			@Area varchar(20),
			@DuodenealVarices VARCHAR(10) = 'False', 
			@ColonVarices VARCHAR(10) = 'False', 
			@Varices VARCHAR(10) = 'False', 
			@VaricesBleeding VARCHAR(10) = 'False', 
			@StomachVarices VARCHAR(10) = 'False',
			@StomachVaricesBleeding VARCHAR(10) = 'False',
			@Varix VARCHAR(10) = 'False', 
			@VarixBleeding VARCHAR(10) = 'False', 
			@StomachVarix VARCHAR(10) = 'False',
			@StomachVarixBleeding VARCHAR(10) = 'False'

	IF EXISTS(SELECT * FROM DELETED) SET @Action = CASE WHEN EXISTS(SELECT * FROM INSERTED) THEN 'U' ELSE 'D' END

	IF @Action IN ('I', 'U') 
	BEGIN
		SELECT @site_id=SiteId FROM inserted
		DECLARE @ProcedureTypeId INT = (SELECT ProcedureType FROM ERS_Procedures p INNER JOIN dbo.ERS_Sites s ON s.ProcedureId = p.ProcedureId WHERE s.SiteId = @site_id)


		IF @ProcedureTypeId IN (3,4,9)
		BEGIN
			SELECT @ColonVarices = (CASE WHEN Grading > 0 THEN 'True' ELSE 'False' END)
				FROM INSERTED
		END
		ELSE IF @ProcedureTypeId IN (2,7)
		BEGIN
			SELECT @ColonVarices = (CASE WHEN Grading > 0 THEN 'True' ELSE 'False' END)
				FROM INSERTED
		END
		BEGIN
			Select @Area = dbo.fnSiteRegion(@site_id)
		
			IF @Area = 'Stomach'
			BEGIN
				SELECT  @StomachVarices = (CASE WHEN Grading > 0 AND ISNULL(Bleeding,0) <= 1 AND ISNULL(Quantity, 0) != 1 THEN 'True' ELSE 'False' END),
						@StomachVaricesBleeding = (CASE WHEN Grading > 0 AND Bleeding > 1 AND ISNULL(Quantity, 0) != 1 THEN 'True' ELSE 'False' END),
						@StomachVarix = (CASE WHEN Grading > 0 AND ISNULL(Bleeding,0) <= 1 AND ISNULL(Quantity, 0) = 1 THEN 'True' ELSE 'False' END),
						@StomachVarixBleeding = (CASE WHEN Grading > 0 AND Bleeding > 1 AND ISNULL(Quantity, 0) = 1 THEN 'True' ELSE 'False' END)
				FROM INSERTED
			END
			IF @Area = 'Oesophagus' 
			BEGIN
				SELECT  @Varices = (CASE WHEN Grading > 0 AND ISNULL(Bleeding,0) <= 1 AND ISNULL(Quantity, 0) != 1 THEN 'True' ELSE 'False' END),
						@VaricesBleeding = (CASE WHEN Grading > 0 AND Bleeding > 1 AND ISNULL(Quantity, 0) != 1 THEN 'True' ELSE 'False' END),
						@Varix = (CASE WHEN Grading > 0 AND ISNULL(Bleeding,0) <= 1 AND ISNULL(Quantity, 0) = 1 THEN 'True' ELSE 'False' END),
						@VarixBleeding = (CASE WHEN Grading > 0 AND Bleeding > 1 AND ISNULL(Quantity, 0) = 1 THEN 'True' ELSE 'False' END)
				FROM INSERTED
			END
			IF @Area = 'Duodenum' 
			BEGIN
				SELECT  @DuodenealVarices = (CASE WHEN Grading > 0 THEN 'True' ELSE 'False' END)
				FROM INSERTED
			END
		END
		EXEC abnormalities_varices_summary_update @site_id
	END

	IF @Action = 'D'
	BEGIN
		SELECT @site_id=SiteId FROM DELETED
	END

	EXEC sites_summary_update @site_id

	EXEC diagnoses_control_save @site_id, 'D30P1', @Varices				-- 'Varices'
	EXEC diagnoses_control_save @site_id, 'D31P1', @VaricesBleeding		-- 'VaricesBleeding'
	EXEC diagnoses_control_save @site_id, 'D47P1', @StomachVarices		-- 'StomachVarices'
	EXEC diagnoses_control_save @site_id, 'D110P1', @StomachVaricesBleeding		-- 'StomachVaricesBleeding'
	EXEC diagnoses_control_save @site_id, 'D115P1', @Varix				-- 'Varices'
	EXEC diagnoses_control_save @site_id, 'D116P1', @VarixBleeding		-- 'VaricesBleeding'
	EXEC diagnoses_control_save @site_id, 'D117P1', @StomachVarix		-- 'StomachVarices'
	EXEC diagnoses_control_save @site_id, 'D118P1', @StomachVarixBleeding		-- 'StomachVaricesBleeding'

	
	IF @ProcedureTypeId IN (3,4,9)--colon/lowers
		BEGIN
			EXEC diagnoses_control_save @site_id, 'DVARICESP3', @ColonVarices		-- 'DuodenealVarices - colon/flexi'
		END
	ELSE IF @ProcedureTypeId IN (2,7) --ercp
	BEGIN
		EXEC diagnoses_control_save @site_id, 'DVARICESP2', @DuodenealVarices		-- 'DuodenealVarices - colon/flexi'

	END
	ELSE
	BEGIN
		EXEC diagnoses_control_save @site_id, 'DVARICESP1', @DuodenealVarices		-- 'DuodenealVarices - ogd/eus/ant'
	END
GO
PRINT N'Altering Procedure [dbo].[abnormalities_colon_miscellaneous_save]...';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER OFF;


GO

ALTER PROCEDURE [dbo].[abnormalities_colon_miscellaneous_save]
(
	@SiteId INT,
	@None BIT,
    @Crohn BIT,
    @Fistula BIT,
    @ForeignBody BIT,
	@Lipoma BIT,
    @Melanosis BIT,
    @Parasites BIT,
    @PneumatosisColi BIT,
    @PolyposisSyndrome BIT,
    @PostoperativeAppearance BIT,
    @Pseudoobstruction BIT,
	@Pouchitis BIT,
	@Volvulus BIT,
	@AmpullaryAdenoma BIT,
	@StentInSitu BIT,
	@PEGInSitu BIT,
	@StentOcclusion BIT,
	@Other VARCHAR(500),
	@LoggedInUserId INT
)
AS

SET NOCOUNT ON

DECLARE @proc_id INT
DECLARE @proc_type INT

BEGIN TRANSACTION

BEGIN TRY
	SELECT 
		@proc_id = p.ProcedureId,
		@proc_type = p.ProcedureType
	FROM 
		ERS_Sites s
	JOIN 
		ERS_Procedures p ON s.ProcedureId = p.ProcedureId
	WHERE 
		SiteId = @SiteId
	
	IF (@None = 0 AND @Crohn = 0 AND @Fistula = 0 AND @ForeignBody = 0 AND @Lipoma = 0 AND @Melanosis = 0 AND @Parasites = 0 AND 
			@PneumatosisColi = 0 AND @PolyposisSyndrome = 0 AND @PostoperativeAppearance = 0 AND @Pseudoobstruction = 0 AND @Pouchitis = 0 AND @Volvulus = 0 AND @AmpullaryAdenoma = 0 AND 
			@StentInSitu = 0 AND @PEGInSitu = 0 AND @StentOcclusion = 0 AND @Other = '') 
	BEGIN
		IF EXISTS (SELECT 1 FROM [ERS_ColonAbnoMiscellaneous] WHERE SiteId = @SiteId)
		BEGIN
			DELETE FROM [ERS_ColonAbnoMiscellaneous] 
			WHERE SiteId = @SiteId

			DELETE FROM ERS_RecordCount 
			WHERE SiteId = @SiteId
			AND Identifier = 'Miscellaneous'
		END
	END


	ELSE IF NOT EXISTS (SELECT 1 FROM [ERS_ColonAbnoMiscellaneous] WHERE SiteId = @SiteId)
	BEGIN
		INSERT INTO [ERS_ColonAbnoMiscellaneous] (
			SiteId,
			[None],
			Crohn,
			Fistula,
			ForeignBody,
			Lipoma,
			Melanosis,
			Parasites,
			PneumatosisColi,
			PolyposisSyndrome,
			PostoperativeAppearance,
			Pseudoobstruction,
			Pouchitis,
			Volvulus,
			AmpullaryAdenoma,
			StentInSitu,
			PEGInSitu,
			StentOcclusion,
			Other,
			WhoCreatedId,
			WhenCreated) 
		VALUES (
			@SiteId,
			@None,
			@Crohn,
			@Fistula,
			@ForeignBody,
			@Lipoma,
			@Melanosis,
			@Parasites,
			@PneumatosisColi,
			@PolyposisSyndrome,
			@PostoperativeAppearance,
			@Pseudoobstruction,
			@Pouchitis,
			@Volvulus,
			@AmpullaryAdenoma,
			@StentInSitu,
			@PEGInSitu,
			@StentOcclusion,
			@Other,
			@LoggedInUserId,
			GETDATE())

		INSERT INTO ERS_RecordCount (
			[ProcedureId],
			[SiteId],
			[Identifier],
			[RecordCount]
		)
		VALUES (
			@proc_id,
			@SiteId,
			'Miscellaneous',
			1)
	END
	
	ELSE
	BEGIN
		UPDATE 
			[ERS_ColonAbnoMiscellaneous]
		SET 
			[None] = @None,
			Crohn = @Crohn,
			Fistula = @Fistula,
			ForeignBody = @ForeignBody,
			Lipoma = @Lipoma,
			Melanosis = @Melanosis,
			Parasites = @Parasites,
			PneumatosisColi = @PneumatosisColi,
			PolyposisSyndrome = @PolyposisSyndrome,
			PostoperativeAppearance = @PostoperativeAppearance,
			Pseudoobstruction = @Pseudoobstruction,
			Pouchitis = @Pouchitis,
			Volvulus = @Volvulus,
			AmpullaryAdenoma = @AmpullaryAdenoma,
			StentInSitu = @StentInSitu,
			PEGInSitu = @PEGInSitu,
			StentOcclusion = @StentOcclusion,
			WhoUpdatedId = @LoggedInUserId,
			Other = @Other,
			WhenUpdated = GETDATE()
		WHERE 
			SiteId = @SiteId
	END
END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;
GO
SET ANSI_NULLS, QUOTED_IDENTIFIER ON;


GO
PRINT N'Altering Procedure [dbo].[abnormalities_colon_miscellaneous_summary_update]...';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER OFF;


GO

ALTER PROCEDURE [dbo].[abnormalities_colon_miscellaneous_summary_update]
(
	@SiteId INT
)
AS
	SET NOCOUNT ON
	
	DECLARE 
		@summary VARCHAR (8000)
		,@tempsummary VARCHAR (1000)
		,@None BIT
		,@Crohn BIT
		,@Fistula BIT
		,@ForeignBody BIT
		,@Lipoma BIT
		,@Melanosis BIT
		,@Parasites BIT
		,@PneumatosisColi BIT
		,@PolyposisSyndrome BIT
		,@PostoperativeAppearance BIT
		,@Pseudoobstruction BIT
		,@Pouchitis BIT
		,@Volvulus BIT
		,@AmpullaryAdenoma BIT
		,@StentInSitu BIT
		,@PEGInSitu BIT
		,@Other VARCHAR(500)

	SET @summary = ''
	SET @tempsummary = ''

	SELECT 
		@None=[None]
		,@Crohn = Crohn
		,@Fistula = Fistula
		,@ForeignBody = ForeignBody
		,@Lipoma = Lipoma
		,@Melanosis = Melanosis
		,@Parasites = Parasites
		,@PneumatosisColi = PneumatosisColi
		,@PolyposisSyndrome = PolyposisSyndrome
		,@PostoperativeAppearance = PostoperativeAppearance
		,@Pseudoobstruction = Pseudoobstruction
		,@Pouchitis = Pouchitis
		,@Volvulus = Volvulus
		,@AmpullaryAdenoma = AmpullaryAdenoma
		,@StentInSitu = StentInSitu
		,@PEGInSitu = PEGInSitu
		,@Other = Other
	FROM
		[ERS_ColonAbnoMiscellaneous]
	WHERE
		SiteId = @SiteId

	
	IF @None = 1
		SET @summary = @summary + 'No miscellaneous abnormalities'

	ELSE
	BEGIN
		IF @Crohn = 1 
			SET @summary = @summary + 'Crohn''s - terminal ileum'

		IF @Fistula = 1
			IF @summary <> '' SET @summary = @summary + '$$fistula' 
			ELSE SET @summary = @summary + 'fistula'

		IF @ForeignBody = 1
			IF @summary <> '' SET @summary = @summary + '$$foreign body' 
			ELSE SET @summary = @summary + 'foreign body'

		IF @Lipoma = 1
			IF @summary <> '' SET @summary = @summary + '$$lipoma' 
			ELSE SET @summary = @summary + 'lipoma'

		IF @Melanosis = 1
			IF @summary <> '' SET @summary = @summary + '$$melanosis' 
			ELSE SET @summary = @summary + 'melanosis'

		IF @Parasites = 1
			IF @summary <> '' SET @summary = @summary + '$$parasites' 
			ELSE SET @summary = @summary + 'parasites'

		IF @PneumatosisColi = 1
			IF @summary <> '' SET @summary = @summary + '$$pneumatosis coli' 
			ELSE SET @summary = @summary + 'pneumatosis coli'

		IF @PolyposisSyndrome = 1
			IF @summary <> '' SET @summary = @summary + '$$polyposis syndrome' 
			ELSE SET @summary = @summary + 'polyposis syndrome'

		IF @PostoperativeAppearance = 1
			IF @summary <> '' SET @summary = @summary + '$$postoperative appearance' 
			ELSE SET @summary = @summary + 'postoperative appearance'

		IF @Pseudoobstruction = 1
			IF @summary <> '' SET @summary = @summary + '$$pseudo-obstruction' 
			ELSE SET @summary = @summary + 'pseudo-obstruction'

		IF @Pouchitis = 1
			IF @summary <> '' SET @summary = @summary + '$$pouchitis' 
			ELSE SET @summary = @summary + 'pouchitis'

		IF @Volvulus = 1
			IF @summary <> '' SET @summary = @summary + '$$volvulus' 
			ELSE SET @summary = @summary + 'volvulus'

		IF @AmpullaryAdenoma = 1
			IF @summary <> '' SET @summary = @summary + '$$ampullary adenoma' 
			ELSE SET @summary = @summary + 'ampullary adenoma'

		IF @StentInSitu = 1 
			IF @summary <> '' SET @summary = @summary + '$$stent in situ' 
			ELSE SET @summary = @summary + 'stent in situ'

		IF @PEGInSitu = 1
			IF @summary <> '' SET @summary = @summary + '$$peg in situ' 
			ELSE SET @summary = @summary + 'peg in situ'

		IF @Other <> ''
			IF @summary <> '' SET @summary = @summary + '$$' + @Other 
			ELSE SET @summary = @summary + @Other
		
		-- Set the last occurence of $$ to "and"
		IF CHARINDEX('$$', @summary) > 0 SET @summary = STUFF(@summary, len(@summary) - charindex('$$', reverse(@summary)), 2, ' and ')
		-- Replace all other occurences of $$ with commas
		SET @summary = REPLACE(@summary, '$$', ', ')
	END
	
	-- Finally, update the summary in Miscellaneous table
	UPDATE [ERS_ColonAbnoMiscellaneous] 
	SET Summary = @summary 
	WHERE SiteId = @SiteId
GO
SET ANSI_NULLS, QUOTED_IDENTIFIER ON;


GO
PRINT N'Altering Procedure [dbo].[abnormalities_common_lesions_save]...';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER OFF;


GO

ALTER PROCEDURE [dbo].[abnormalities_common_lesions_save]
(
	@SiteId int,
	@None bit,
	@Polyp bit,
	@PolypTypeId int,
	@Tattooed bit,
	@PreviouslyTattooed bit,
	@TattooType int,
	@TattooedQuantity int,
	@TattooedBy int,
	@Submucosal bit,
	@SubmucosalQuantity int,
	@SubmucosalLargest int,
	@SubmucosalProbably bit,
	@SubmucosalTumourTypeId int,
	@Focal bit,
	@FocalQuantity int,
	@FocalLargest int,
	@FocalProbably bit,
	@FocalTumourTypeId int,
	@FundicGlandPolyp BIT,
	@FundicGlandPolypQuantity INT,
	@FundicGlandPolypLargest numeric(18,2),
	@PreviousESDScar BIT,
	@LoggedInUserId int
)
AS

SET NOCOUNT ON

DECLARE @proc_id INT
DECLARE @proc_type INT
DECLARE @Insert BIT = 0

BEGIN TRANSACTION

BEGIN TRY
	SELECT 
		@proc_id = p.ProcedureId,
		@proc_type = p.ProcedureType
	FROM 
		ERS_Sites s
	JOIN 
		ERS_Procedures p ON s.ProcedureId = p.ProcedureId
	WHERE 
		SiteId = @SiteId
	

	IF (@None = 0 AND @Polyp = 0 AND @Submucosal = 0 AND @Focal = 0 AND @FundicGlandPolyp = 0 AND @PreviousESDScar = 0)
	BEGIN
		IF EXISTS (SELECT 1 FROM [ERS_CommonAbnoLesions] WHERE SiteId = @SiteId)
		BEGIN
			DELETE FROM [ERS_CommonAbnoLesions] 
			WHERE SiteId = @SiteId

			DELETE FROM ERS_RecordCount 
			WHERE SiteId = @SiteId
			AND Identifier = 'Lesions'
		END
	END

	ELSE IF NOT EXISTS (SELECT 1 FROM [ERS_CommonAbnoLesions] WHERE SiteId = @SiteId)
	BEGIN
		INSERT INTO [ERS_CommonAbnoLesions] (
			[SiteId],
			[None],
			[Polyp],
			[PolypTypeId],
			[Tattooed],
			[PreviouslyTattooed],
			[TattooType],
			[TattooedQuantity],
			[TattooedBy],
			[Submucosal],
			[SubmucosalQuantity],
			[SubmucosalLargest],
			[SubmucosalProbably],
			[SubmucosalTumourTypeId],
			[Focal],
			[FocalQuantity],
			[FocalLargest],
			[FocalProbably],
			[FocalTumourTypeId],
			[Granuloma],
			[Dysplastic],
			[PneumatosisColi],
			FundicGlandPolyp,
			FundicGlandPolypQuantity,
			FundicGlandPolypLargest,
			PreviousESDScar,
			[WhoCreatedId],
			[WhenCreated]) 
		VALUES (
			@SiteId,
			@None,
			@Polyp,
			@PolypTypeId,
			@Tattooed,
			@PreviouslyTattooed,
			@TattooType,
			@TattooedQuantity,
			@TattooedBy,
			@Submucosal,
			@SubmucosalQuantity,
			@SubmucosalLargest,
			@SubmucosalProbably,
			@SubmucosalTumourTypeId,
			@Focal,
			@FocalQuantity,
			@FocalLargest,
			@FocalProbably,
			@FocalTumourTypeId,
			0,
			0,
			0,
			@FundicGlandPolyp,
			@FundicGlandPolypQuantity,
			@FundicGlandPolypLargest,
			@PreviousESDScar,
			@LoggedInUserId,
			GETDATE())

		INSERT INTO ERS_RecordCount (
			[ProcedureId],
			[SiteId],
			[Identifier],
			[RecordCount]
		)
		VALUES (
			@proc_id,
			@SiteId,
			'Lesions',
			1)

			SET @Insert = 1
	END

	ELSE
	BEGIN
		UPDATE 
			[ERS_CommonAbnoLesions]
		SET 
			[None]=@None,
			Polyp=@Polyp,
			PolypTypeId = @PolypTypeId,
			Tattooed=@Tattooed,
			PreviouslyTattooed=@PreviouslyTattooed,
			TattooType=@TattooType,
			TattooedQuantity=@TattooedQuantity,
			TattooedBy=@TattooedBy,
			Submucosal=@Submucosal,
			SubmucosalQuantity=@SubmucosalQuantity,
			SubmucosalLargest=@SubmucosalLargest,
			SubmucosalProbably=@SubmucosalProbably,
			SubmucosalTumourTypeId=@SubmucosalTumourTypeId,
			Focal=@Focal,
			FocalQuantity=@FocalQuantity,
			FocalLargest=@FocalLargest,
			FocalProbably=@FocalProbably,
			FocalTumourTypeId=@FocalTumourTypeId,
			FundicGlandPolyp = @FundicGlandPolyp,
			FundicGlandPolypQuantity = @FundicGlandPolypQuantity,
			FundicGlandPolypLargest = @FundicGlandPolypLargest,
			PreviousESDScar = @PreviousESDScar,
			WhoUpdatedId = @LoggedInUserId,
			WhenUpdated = GETDATE()
		WHERE 
			SiteId = @SiteId
	END

	

	--Save Polypectomy in ERS_UpperGITherapeutics
	/*IF (@Insert=1) --only on an insert?.. so if they go and change in Therapeutic types and come back here and alter changes wont be carried across again
	BEGIN
	DECLARE @RemovalType tinyint
	DECLARE @Removal tinyint
	DECLARE @SentToLabs int

		IF @Sessile = 1 OR @Pedunculated = 1 OR @Pseudopolyps = 1
		BEGIN
			IF @Sessile = 1
			BEGIN
				SET @Removal = @SessileRemoval
				SET @RemovalType = @SessileRemovalMethod
				SET @SentToLabs = ISNULL(@SessileToLabs,0)
			END
			ELSE IF @Pedunculated = 1
			BEGIN
				SET @Removal = @PedunculatedRemoval
				SET @RemovalType = @PedunculatedRemovalMethod
				SET @SentToLabs = ISNULL(@PedunculatedToLabs,0)
			END
			ELSE IF @Pseudopolyps = 1
			BEGIN
				SET @Removal = @PseudopolypsRemoval
				SET @RemovalType = @PseudopolypsRemovalMethod
				SET @SentToLabs = ISNULL(@PseudopolypsToLabs,0)
			END	

			IF @Removal > 0 OR @RemovalType > 0 or @Tattooed = 1
			BEGIN
				IF NOT EXISTS (SELECT 1 FROM ERS_UpperGITherapeutics WHERE SiteId = @SiteId)
				BEGIN
					INSERT INTO ERS_UpperGITherapeutics (SiteId, Marking,	MarkingType, MarkedQuantity,	Polypectomy,	PolypectomyRemoval, PolypectomyRemovalType, CarriedOutRole, EndoRole, WhoCreatedId, WhenCreated) 
					VALUES (@SiteId, ISNULL(@Tattooed,0), @TattooType, @TattooedQty,	@Removal,	@Removal, @RemovalType, 1, 1, @LoggedInUserId, GETDATE())

					IF NOT EXISTS (SELECT 1 FROM ERS_RecordCount WHERE ProcedureId = @proc_id AND SiteId = @SiteId AND Identifier = 'Therapeutic Procedures')
					BEGIN
						INSERT INTO ERS_RecordCount ([ProcedureId],	[SiteId], [Identifier], [RecordCount])
						VALUES (@proc_id, @SiteId, 'Therapeutic Procedures', 1)
					END 
				END
				ELSE IF EXISTS (SELECT 1 FROM ERS_UpperGITherapeutics WHERE SiteId = @SiteId AND CarriedOutRole = 1)
				BEGIN
					UPDATE ERS_UpperGITherapeutics
					SET Polypectomy = 1,						
						PolypectomyRemoval = @Removal,
						PolypectomyRemovalType = @RemovalType,
						Marking = ISNULL(@Tattooed,0),	
						MarkingType = @TattooType, 
						MarkedQuantity = @TattooedQty,
						WhoUpdatedId = @LoggedInUserId,
						WhenUpdated = GETDATE()
					WHERE
						SiteId = @SiteId AND
						CarriedOutRole = 1
				END
				ELSE
				BEGIN
					UPDATE ERS_UpperGITherapeutics
					SET Polypectomy = 1,						
						PolypectomyRemoval = @Removal,
						PolypectomyRemovalType = @RemovalType,
						Marking = @Tattooed,	
						MarkingType = @TattooType, 
						MarkedQuantity = @TattooedQty,
						WhoUpdatedId = @LoggedInUserId,
						WhenUpdated = GETDATE()
					WHERE 
						SiteId = @SiteId AND
						CarriedOutRole = 2
				END
			END

			IF @SentToLabs > 0 
			BEGIN
				--update specimens as endo took a polypectomy which is a specimen
				IF NOT EXISTS (SELECT 1 FROM ERS_UpperGISpecimens WHERE SiteId = @SiteId)
				BEGIN
					INSERT INTO ERS_UpperGISpecimens (SiteId, Polypectomy, PolypectomyQty, WhoCreatedId, WhenCreated)
					VALUES (@SiteId, 1, @SentToLabs, @LoggedInUserId, GETDATE())
				END
				ELSE
					UPDATE ERS_UpperGISpecimens 
					SET Polypectomy = 1, 
						PolypectomyQty = (ISNULL(PolypectomyQty, 0) + @SentToLabs), 
						WhoUpdatedId = @LoggedInUserId, 
						WhenUpdated = GETDATE() 
					WHERE SiteId = @SiteId

				IF NOT EXISTS (SELECT 1 FROM ERS_RecordCount WHERE SiteId= @SiteId AND Identifier = 'Specimens Taken')
					INSERT INTO ERS_RecordCount ([ProcedureId],	[SiteId], [Identifier], [RecordCount])
					VALUES (@proc_id, @SiteId, 'Specimens Taken', 1)

				--prefill follow up tab as endo is now awaiting pathology results as a specimen was taken
				IF NOT EXISTS (SELECT 1 FROM ERS_UpperGIFollowUp WHERE ProcedureId = @proc_id)
				BEGIN
					INSERT INTO ERS_UpperGIFollowUp (ProcedureId, AwaitingPathologyResults, WhoCreatedId, WhenCreated)
					VALUES (@proc_id, 1, @LoggedInUserId, GETDATE())
				END
				ELSE
					UPDATE ERS_UpperGIFollowUp 
					SET AwaitingPathologyResults = 1, 
						WhoUpdatedId = @LoggedInUserId, 
						WhenUpdated = GETDATE()  
					WHERE ProcedureId = @proc_id


			END
		END	
	END
*/
END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;
GO
SET ANSI_NULLS, QUOTED_IDENTIFIER ON;


GO
PRINT N'Altering Procedure [dbo].[abnormalities_common_lesions_select]...';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER OFF;


GO

ALTER PROCEDURE [dbo].[abnormalities_common_lesions_select]
(
	@SiteId INT	
)
AS

SET NOCOUNT ON

	SELECT 
		[None],
		[SiteId],
		[Polyp],
		[PolypTypeId],
		[Tattooed],
		[PreviouslyTattooed],
		[TattooType],
		[TattooedQuantity],
		[TattooedBy],
		[Submucosal],
		[SubmucosalQuantity],
		[SubmucosalLargest],
		[SubmucosalProbably],
		[SubmucosalTumourTypeId],
		[Focal],
		[FocalQuantity],
		[FocalLargest],
		[FocalProbably],
		[FocalTumourTypeId],
		[Granuloma],
		[GranulomaQuantity],
		[GranulomaLargest],
		[Dysplastic],
		[DysplasticQuantity],
		[DysplasticLargest],
		[PneumatosisColi],
		FundicGlandPolyp,
		FundicGlandPolypQuantity,
		FundicGlandPolypLargest,
		PreviousESDScar
	FROM dbo.ERS_CommonAbnoLesions ecal 
	WHERE ecal.SiteId=@SiteId
GO
SET ANSI_NULLS, QUOTED_IDENTIFIER ON;


GO
PRINT N'Altering Procedure [dbo].[abnormalities_common_lesions_summary_update]...';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER OFF;


GO

ALTER PROCEDURE [dbo].[abnormalities_common_lesions_summary_update]
(
	@SiteId INT
)
AS
SET NOCOUNT ON
	
DECLARE 
	@summary VARCHAR (8000),
	@tempsummary VARCHAR (1000),
	@None BIT,
	@Polyp BIT,

	@Sessile BIT,
	@SessileQuantity INT,
	@SessileLargest INT,
	@SessileExcised INT,
	@SessileRetrieved INT,
	@SessileToLabs INT,
	@SessileRemoval TINYINT,
	@SessileRemovalMethod TINYINT,
	@SessileProbably BIT,
	@SessileType TINYINT,
	@SessileParisClass TINYINT,
	@SessilePitPattern TINYINT,
	@Pedunculated BIT,
	@PedunculatedQuantity INT,
	@PedunculatedLargest INT,
	@PedunculatedExcised INT,
	@PedunculatedRetrieved INT,
	@PedunculatedToLabs INT,
	@PedunculatedRemoval TINYINT,
	@PedunculatedRemovalMethod TINYINT,
	@PedunculatedProbably BIT,
	@PedunculatedType TINYINT,
	@PedunculatedParisClass TINYINT,
	@PedunculatedPitPattern TINYINT,
	@Pseudopolyps BIT,
	@PseudopolypsMultiple BIT,
	@PseudopolypsQuantity INT,
	@PseudopolypsLargest INT,
	@PseudopolypsExcised INT,
	@PseudopolypsRetrieved INT,
	@PseudopolypsToLabs INT,
	@PseudopolypsInflam BIT,
	@PseudopolypsPostInflam BIT,
	@PseudopolypsRemoval TINYINT,
	@PseudopolypsRemovalMethod TINYINT,
	@Submucosal BIT,
	@SubmucosalQuantity INT,
	@SubmucosalLargest INT,
	@SubmucosalProbably BIT,
	@SubmucosalTypeId TINYINT,
	@Focal BIT,
	@FocalQuantity INT,
	@FocalLargest INT,
	@FocalProbably BIT,
	@FocalTypeId TINYINT,
	@Villous BIT,
	@VillousQuantity INT,
	@VillousLargest INT,
	@VillousProbably BIT,
	@VillousType TINYINT,
	@Ulcerative BIT,
	@UlcerativeQuantity INT,
	@UlcerativeLargest INT,
	@UlcerativeProbably BIT,
	@UlcerativeType TINYINT,
	@Stricturing BIT,
	@StricturingQuantity INT,
	@StricturingLargest INT,
	@StricturingProbably BIT,
	@StricturingType TINYINT,
	@Polypoidal BIT,
	@PolypoidalQuantity INT,
	@PolypoidalLargest INT,
	@PolypoidalProbably BIT,
	@PolypoidalType TINYINT,
	@Granuloma BIT,
	@GranulomaQuantity INT,
	@GranulomaLargest INT,
	@Dysplastic BIT,
	@DysplasticQuantity INT,
	@DysplasticLargest INT,
	@PneumatosisColi BIT,
	@Tattooed BIT,
	@PreviouslyTattooed BIT,
	@TattooType INT,
	@TattooedQty INT,
	@FundicGlandPolyp BIT,
	@FundicGlandPolypQuantity INT,
	@FundicGlandPolypLargest Numeric(18,2),
	@PreviousESDScar BIT

SET @summary = ''
SET @tempsummary = ''

SELECT 
	@None=[None],
	@Polyp = Polyp,
	@Submucosal = Submucosal,
	@SubmucosalTypeId = SubmucosalTumourTypeId,
	@SubmucosalLargest = SubmucosalLargest,
	@SubmucosalProbably = SubmucosalProbably,
	@SubmucosalQuantity = SubmucosalQuantity,
	@Focal = Focal,
	@FocalTypeId = FocalTumourTypeId,
	@FocalLargest = FocalLargest,
	@FocalProbably = FocalProbably,
	@FocalQuantity = FocalQuantity,
	@Granuloma=Granuloma,
	@GranulomaQuantity=GranulomaQuantity,
	@GranulomaLargest=GranulomaLargest,
	@Dysplastic=Dysplastic,
	@DysplasticQuantity=DysplasticQuantity,
	@DysplasticLargest=DysplasticLargest,
	@PneumatosisColi=PneumatosisColi,
	@Tattooed = Tattooed,
	@PreviouslyTattooed = PreviouslyTattooed,
	@TattooType = TattooType,
	@TattooedQty = TattooedQuantity,
	@FundicGlandPolyp = FundicGlandPolyp,
	@FundicGlandPolypQuantity = FundicGlandPolypQuantity,
	@FundicGlandPolypLargest = FundicGlandPolypLargest,
	@PreviousESDScar = PreviousESDScar
FROM
	ERS_CommonAbnoLesions
WHERE
	SiteId = @SiteId

SET @Summary = ''

IF NOT EXISTS (SELECT 1 FROM ERS_CommonAbnoLesions WHERE SiteId = @SiteId) return

IF @None = 1 SET @summary = 'No lesions'

ELSE
BEGIN
	--saves calling the table multiple times :)
	DECLARE @TumourTypes TABLE (TypeId int, [Description] varchar(100))
	INSERT INTO @TumourTypes
	SELECT UniqueId, [Description] 
	FROM ERS_TumourTypes 
	WHERE Suppressed = 0
	------------------------------------------------------------------------------------------
	-------	TUMOUR: VILLOUS -------
	------------------------------------------------------------------------------------------
	IF @Villous > 0
	BEGIN
		IF @summary <> '' SET @summary = @summary + '##'

		IF @VillousQuantity > 1 SET @summary = @summary + CONVERT(VARCHAR(20), @VillousQuantity) + ' '
		ELSE SET @summary = @summary + 'A '
		
		IF @VillousProbably = 1 SET @summary = @summary + 'probably '

		IF @VillousType = 1 SET @summary = @summary + 'benign '
		ELSE IF @VillousType = 2 SET @summary = @summary + 'malignant '

		IF @VillousQuantity > 1 SET @summary = @summary + 'villous tumours ' ELSE SET @summary = @summary + 'villous tumour ' 

		IF (@VillousQuantity > 0 AND @VillousLargest > 0) 
		BEGIN
			IF @VillousQuantity > 1
				SET @summary = @summary + '(largest ' + CONVERT(VARCHAR(20), @VillousLargest) + 'mm) '
			ELSE
				SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @VillousLargest) + 'mm) '
		END
	END

	------------------------------------------------------------------------------------------
	-------	TUMOUR: ULCERATIVE -------
	------------------------------------------------------------------------------------------
	IF @Ulcerative > 0
	BEGIN
		DECLARE @UlcerSummary VARCHAR(300) = ''
		IF @summary <> '' SET @summary = @summary + '##'

		IF @UlcerativeQuantity > 1 SET @UlcerSummary = @UlcerSummary + CONVERT(VARCHAR(20), @UlcerativeQuantity) + ' '
		
		IF @UlcerativeProbably = 1 SET @UlcerSummary = @UlcerSummary + 'probably '

		IF @UlcerativeType = 1 SET @UlcerSummary = @UlcerSummary + 'benign '
		ELSE IF @UlcerativeType = 2 SET @UlcerSummary = @UlcerSummary + 'malignant '

		IF @UlcerativeQuantity > 1 SET @UlcerSummary = @UlcerSummary + 'ulcerative tumours ' ELSE SET @UlcerSummary = @UlcerSummary + 'ulcerative tumour ' 

		IF LEFT(@UlcerSummary,1) = 'u' SET @UlcerSummary =  'An ' + @UlcerSummary
		ELSE IF ISNULL(@UlcerativeQuantity,0) <= 1 SET @UlcerSummary =  'A ' + @UlcerSummary

		IF (@UlcerativeQuantity > 0 AND @UlcerativeLargest > 0) 
		BEGIN
			IF @UlcerativeQuantity > 1
				SET @UlcerSummary = @UlcerSummary + '(largest ' + CONVERT(VARCHAR(20), @UlcerativeLargest) + 'mm) '
			ELSE
				SET @UlcerSummary = @UlcerSummary + '(' + CONVERT(VARCHAR(20), @UlcerativeLargest) + 'mm) '
		END

		SET @summary = @summary + @UlcerSummary
	END

	------------------------------------------------------------------------------------------
	-------	TUMOUR: STRICTURING -------
	------------------------------------------------------------------------------------------
	IF @Stricturing > 0
	BEGIN
		IF @summary <> '' SET @summary = @summary + '##'

		IF @StricturingQuantity > 1 SET @summary = @summary + CONVERT(VARCHAR(20), @StricturingQuantity) + ' '
		ELSE SET @summary = @summary + 'A '
		
		IF @StricturingProbably = 1 SET @summary = @summary + 'probably '

		IF @StricturingType = 1 SET @summary = @summary + 'benign '
		ELSE IF @StricturingType = 2 SET @summary = @summary + 'malignant '

		IF @StricturingQuantity > 1 SET @summary = @summary + 'stricturing tumours ' ELSE SET @summary = @summary + 'stricturing tumour ' 

		IF (@StricturingQuantity > 0 AND @StricturingLargest > 0) 
		BEGIN
			IF @StricturingQuantity > 1
				SET @summary = @summary + '(largest ' + CONVERT(VARCHAR(20), @StricturingLargest) + 'mm) '
			ELSE
				SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @StricturingLargest) + 'mm) '
		END
	END

	------------------------------------------------------------------------------------------
	-------	TUMOUR: POLYPOIDAL -------
	------------------------------------------------------------------------------------------
	IF @Polypoidal > 0
	BEGIN
		IF @summary <> '' SET @summary = @summary + '##'

		IF @PolypoidalQuantity > 1 SET @summary = @summary + CONVERT(VARCHAR(20), @PolypoidalQuantity) + ' '
		ELSE SET @summary = @summary + 'A '
		
		IF @PolypoidalProbably = 1 SET @summary = @summary + 'probably '

		IF @PolypoidalType = 1 SET @summary = @summary + 'benign '
		ELSE IF @PolypoidalType = 2 SET @summary = @summary + 'malignant '

		IF @PolypoidalQuantity > 1 SET @summary = @summary + 'polypoidal tumours ' ELSE SET @summary = @summary + 'polypoidal tumour ' 

		IF (@PolypoidalQuantity > 0 AND @PolypoidalLargest > 0) 
		BEGIN
			IF @PolypoidalQuantity > 1
				SET @summary = @summary + '(largest ' + CONVERT(VARCHAR(20), @PolypoidalLargest) + 'mm) '
			ELSE
				SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @PolypoidalLargest) + 'mm) '
		END
	END

	------------------------------------------------------------------------------------------
	-------	SUTURE GRANULOMA -------
	------------------------------------------------------------------------------------------
	IF @Granuloma > 0
	BEGIN
		IF @summary <> '' SET @summary = @summary + '##'

		IF @GranulomaQuantity > 1 SET @summary = @summary + CONVERT(VARCHAR(20), @GranulomaQuantity) + ' '
		ELSE SET @summary = @summary + 'A '
		
		IF @GranulomaQuantity > 1 SET @summary = @summary + 'granuloma tumours ' ELSE SET @summary = @summary + 'granuloma tumour ' 

		IF (@GranulomaQuantity > 0 AND @GranulomaLargest > 0) 
		BEGIN
			IF @GranulomaQuantity > 1
				SET @summary = @summary + '(largest ' + CONVERT(VARCHAR(20), @GranulomaLargest) + 'mm) '
			ELSE
				SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @GranulomaLargest) + 'mm) '
		END
	END

	------------------------------------------------------------------------------------------
	-------	DYSPLASTIC LESION -------
	------------------------------------------------------------------------------------------
	IF @Dysplastic > 0
	BEGIN
		IF @summary <> '' SET @summary = @summary + '##'

		IF @DysplasticQuantity > 1 SET @summary = @summary + CONVERT(VARCHAR(20), @DysplasticQuantity) + ' '
		ELSE SET @summary = @summary + 'A '
		
		IF @DysplasticQuantity > 1 SET @summary = @summary + 'dysplastic tumours ' ELSE SET @summary = @summary + 'dysplastic tumour ' 

		IF (@DysplasticQuantity > 0 AND @DysplasticLargest > 0) 
		BEGIN
			IF @DysplasticQuantity > 1
				SET @summary = @summary + '(largest ' + CONVERT(VARCHAR(20), @DysplasticLargest) + 'mm) '
			ELSE
				SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @DysplasticLargest) + 'mm) '
		END

	END

	------------------------------------------------------------------------------------------
	-------	PNEUMATOSIS COLI -------
	------------------------------------------------------------------------------------------
	IF @PneumatosisColi > 0
	BEGIN
		BEGIN
			IF @summary <> '' SET @summary = @summary + '##'

			SET @summary = @summary + 'pneumatosis coli '
		END
	END	
	
	------------------------------------------------------------------------------------------
	-------	SUBMUCOSAL LESION -------
	------------------------------------------------------------------------------------------
	IF @Submucosal > 0
	BEGIN
		IF @summary <> '' SET @summary = @summary + '##'

		IF @SubmucosalQuantity > 1 SET @summary = @summary + CONVERT(VARCHAR(20), @SubmucosalQuantity) + ' '
		ELSE SET @summary = @summary + 'A '
		
		IF @SubmucosalProbably = 1 SET @summary = @summary + 'probably '

		SELECT @summary = @summary + LOWER([Description]) + ' ' FROM @TumourTypes WHERE TypeId = @SubmucosalTypeId

		IF @SubmucosalQuantity > 1 SET @summary = @summary + 'submucosal lesions ' ELSE SET @summary = @summary + 'submucosal lesion ' 

		IF (@SubmucosalQuantity > 0 AND @SubmucosalLargest > 0) 
		BEGIN
			IF @SubmucosalQuantity > 1
				SET @summary = @summary + '(largest ' + CONVERT(VARCHAR(20), @SubmucosalLargest) + 'mm) '
			ELSE
				SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @SubmucosalLargest) + 'mm) '
		END
	END

	------------------------------------------------------------------------------------------
	-------	FOCAL LESIONS -------
	------------------------------------------------------------------------------------------
	IF @Focal > 0
	BEGIN
		IF @summary <> '' SET @summary = @summary + '##'

		IF @FocalQuantity > 1 SET @summary = @summary + CONVERT(VARCHAR(20), @FocalQuantity) + ' '
		ELSE SET @summary = @summary + 'A '
		
		IF @FocalProbably = 1 SET @summary = @summary + 'probably '

		SELECT @summary = @summary + LOWER([Description]) + ' ' FROM @TumourTypes WHERE TypeId = @FocalTypeId

		IF @FocalQuantity > 1 SET @summary = @summary + 'focal lesions ' ELSE SET @summary = @summary + 'submucosal lesion ' 

		IF (@FocalQuantity > 0 AND @FocalLargest > 0) 
		BEGIN
			IF @FocalQuantity > 1
				SET @summary = @summary + '(largest ' + CONVERT(VARCHAR(20), @FocalLargest) + 'mm) '
			ELSE
				SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @FocalLargest) + 'mm) '
		END
	END

	-------------------------------------------------------------------------------------------
	-------	Fundic Gland Polyp -------
	------------------------------------------------------------------------------------------
	IF @FundicGlandPolyp > 0
	BEGIN
		IF @summary <> '' SET @summary = @summary + '##'

		IF @FundicGlandPolypQuantity > 1 SET @summary = @summary + CONVERT(VARCHAR(20), @FundicGlandPolypQuantity) + ' '
		ELSE SET @summary = @summary + 'A '
		
		IF @FundicGlandPolypQuantity > 1 SET @summary = @summary + 'Fundic Gland Polyp tumours found ' ELSE SET @summary = @summary + 'Fundic Gland Polyp tumour found ' 

		IF (@FundicGlandPolypQuantity > 0 AND @FundicGlandPolypLargest > 0) 
		BEGIN
			IF @FundicGlandPolypQuantity > 1
				SET @summary = @summary + '(largest ' + CONVERT(VARCHAR(20), @FundicGlandPolypLargest) + ' mm) '
			ELSE
				SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @FundicGlandPolypLargest) + ' mm) '
		END
	END
	
	------------------------------------------------------------------------------------------
	-------	Previous ESD Scar -------
	------------------------------------------------------------------------------------------
	IF @PreviousESDScar > 0
	BEGIN
		BEGIN
			IF @summary <> '' SET @summary = @summary + '##'

			SET @summary = @summary + 'previous ESD scar '
		END
	END	

	------------------------------------------------------------------------------------------
	-------	POLYPS	-------
	------------------------------------------------------------------------------------------
	IF @Polyp = 1
	BEGIN
		IF EXISTS (SELECT TOP 1 1 FROM dbo.ERS_CommonAbnoPolypDetails WHERE SiteId = @SiteId)
		BEGIN
			SET @summary = @summary + '<br /><div style="padding-left:8%;">' + dbo.common_polpydetails_summary(@SiteId, NULL) + '</div>'
		END
	END


	------------------------------------------------------------------------------------------
	-------	POLYPS TATTOO ----------
	------------------------------------------------------------------------------------------
	/*IF @Tattooed > 0 
	BEGIN
		DECLARE @TattooTypeText varchar(50)

		SELECT @TattooType = MarkingType, @TattooedQty = MarkedQuantity FROM dbo.ERS_UpperGITherapeutics WHERE SiteId = @SiteID AND Marking = 1
		
		IF @summary <> '' SET @summary = @summary + '## <br />'

		SET @summary = @summary + ' Tattooed, '
		
		IF @TattooType IS NOT NULL AND @TattooType > 0
		BEGIN
			SELECT @TattooTypeText = ListItemText FROM dbo.ERS_Lists el WHERE el.ListDescription = 'Abno marking' AND el.ListItemNo = @TattooType AND ListItemText IS NOT NULL

			SET @summary = @summary + CASE WHEN @TattooedQty IS NOT NULL AND @TattooedQty > 0 THEN + CONVERT(varchar(5), @TattooedQty) ELSE '' END + ' marked using ' + @TattooTypeText
		END	
	END	
	ELSE IF @PreviouslyTattooed > 0
	BEGIN
		IF @summary <> '' SET @summary = @summary + '##'

		SET @summary = @summary + ' previously tattooed '
	END	
	*/
END

SET @summary = LTRIM(RTRIM(@summary))
SET @summary = REPLACE(@summary, '##', '. ')
SET @summary = REPLACE(@summary, ' ,', ',')
SET @summary = REPLACE(@summary, ' )', ')')
SET @summary = REPLACE(@summary, ' .', '.')

DECLARE @finalSummary VARCHAR(8000) =''
----Set first letter to upper after full stop.
SELECT @finalSummary = @finalSummary + COALESCE(dbo.fnFirstLetterUpper(item) + '. ', '') 
FROM dbo.fnSplitString(@summary, '.')

SET @summary = LTRIM(RTRIM(@finalSummary))
IF @None <> 1 SET @summary = LOWER(LEFT(@summary,1)) + RIGHT(@summary,LEN(@summary)-1)
IF RIGHT(@summary,1) = '.' SET @summary = LEFT(@summary, LEN(@summary)-1)

-- Finally, update the summary in Diverticulum table
UPDATE ERS_CommonAbnoLesions
SET Summary = @summary 
WHERE SiteId = @SiteId


EXEC sites_summary_update @SiteId
GO
SET ANSI_NULLS, QUOTED_IDENTIFIER ON;


GO
PRINT N'Altering Procedure [dbo].[abnormalities_miscellaneous_save]...';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER OFF;


GO


ALTER PROCEDURE [dbo].[abnormalities_miscellaneous_save]
(
	@SiteId INT,
	@None BIT,
	@Web BIT,
	@Mallory BIT,
	@SchatzkiRing BIT,
	@FoodResidue BIT,
	@Foreignbody BIT,
	@ExtrinsicCompression BIT,
	@Diverticulum BIT,
	@DivertMultiple BIT,
	@DivertQty SMALLINT,
	@Pharyngeal BIT,
	@DiffuseIntramural BIT,
	@TractionType BIT,
	@PulsionType BIT,
	@MotilityDisorder BIT,
	@ProbableAchalasia BIT,
	@ConfirmedAchalasia BIT,
	@Presbyoesophagus BIT,
	@MarkedTertiaryContractions BIT,
	@LaxLowerOesoSphincter BIT,
	@TortuousOesophagus BIT,
	@DilatedOesophagus BIT,
	@MotilityPoor BIT,
	@Ulceration BIT,
	@UlcerationType BIT,
	@UlcerationMultiple BIT,
	@UlcerationQty SMALLINT,
	@UlcerationLength SMALLINT,
	@UlcerationClotInBase BIT,
	@UlcerationReflux BIT,
	@UlcerationPostSclero BIT,
	@UlcerationPostBanding BIT,
	@Stricture BIT,
	@StrictureCompression TINYINT,
	@StrictureScopeNotPass BIT,
	@StrictureSeverity TINYINT,
	@StrictureType SMALLINT,
	@StrictureProbably BIT,
	@StrictureBenignType TINYINT,
	@StrictureBeginning SMALLINT,
	@StrictureLength SMALLINT,
	@StricturePerforation TINYINT,
	@Tumour BIT,
	@TumourType TINYINT,
	@TumourProbably BIT,
	@TumourExophytic TINYINT,
	@TumourBenignType TINYINT,
	@TumourBenignTypeOther NVARCHAR(100),
	@TumourBeginning SMALLINT,
	@TumourLength SMALLINT,
	@TumourScopeCouldNotPass BIT,
	@MiscOther NVARCHAR(150),
	@InletPatch BIT,
	@InletPatchMultiple BIT,
	@InletPatchQty SMALLINT,
	@Fitsula BIT,
	@LoggedInUserId INT,
	@InletPouch BIT,	
	@InletPouchQty SMALLINT,
	@ZLine BIT,
	@ZLineSize INT,
	@Volvulus BIT,
	@AmpullaryAdenoma BIT,
	@StentOcclusion BIT,
	@StentInSitu BIT,
	@PEGInSitu BIT

)
AS

SET NOCOUNT ON

DECLARE @proc_id INT
DECLARE @proc_type INT

BEGIN TRANSACTION

BEGIN TRY
	SELECT 
		@proc_id = p.ProcedureId,
		@proc_type = p.ProcedureType
	FROM 
		ERS_Sites s
	JOIN 
		ERS_Procedures p ON s.ProcedureId = p.ProcedureId
	WHERE 
		SiteId = @SiteId
			
	IF NOT EXISTS (SELECT 1 FROM ERS_UpperGIAbnoMiscellaneous WHERE SiteId = @SiteId)
	BEGIN
		INSERT INTO ERS_UpperGIAbnoMiscellaneous (
			SiteId,
			[None],
			Web,
			Mallory,
			SchatzkiRing,
			FoodResidue,
			Foreignbody,
			ExtrinsicCompression,
			Diverticulum,
			DivertMultiple,
			DivertQty,
			Pharyngeal,
			DiffuseIntramural,
			TractionType,
			PulsionType,
			MotilityDisorder,
			ProbableAchalasia,
			ConfirmedAchalasia,
			Presbyoesophagus,
			MarkedTertiaryContractions,
			LaxLowerOesoSphincter,
			TortuousOesophagus,
			DilatedOesophagus,
			MotilityPoor,
			Ulceration,
			UlcerationType,
			UlcerationMultiple,
			UlcerationQty,
			UlcerationLength,
			UlcerationClotInBase,
			UlcerationReflux,
			UlcerationPostSclero,
			UlcerationPostBanding,
			Stricture,
			StrictureCompression,
			StrictureScopeNotPass,
			StrictureSeverity,
			StrictureType,
			StrictureProbably,
			StrictureBenignType,
			StrictureBeginning,
			StrictureLength,
			StricturePerforation,
			Tumour,
			TumourType,
			TumourProbably,
			TumourExophytic,
			TumourBenignType,
			TumourBenignTypeOther,
			TumourBeginning,
			TumourLength,
			TumourScopeNotPass,
			MiscOther,
			InletPatch,
			InletPatchMultiple,
			InletPatchQty,
			Fitsula,
			WhoCreatedId,
			WhenCreated,
			InletPouch,			
			InletPouchQty,
			ZLine,
			ZLineSize,
			Volvulus,
			AmpullaryAdenoma,
			StentOcclusion,
			StentInSitu,
			PEGInSitu) 
		VALUES (@SiteId,
				@None,
				@Web,
				@Mallory,
				@SchatzkiRing,
				@FoodResidue,
				@Foreignbody,
				@ExtrinsicCompression,
				@Diverticulum,
				@DivertMultiple,
				@DivertQty,
				@Pharyngeal,
				@DiffuseIntramural,
				@TractionType,
				@PulsionType,
				@MotilityDisorder,
				@ProbableAchalasia,
				@ConfirmedAchalasia,
				@Presbyoesophagus,
				@MarkedTertiaryContractions,
				@LaxLowerOesoSphincter,
				@TortuousOesophagus,
				@DilatedOesophagus,
				@MotilityPoor,
				@Ulceration,
				@UlcerationType,
				@UlcerationMultiple,
				@UlcerationQty,
				@UlcerationLength,
				@UlcerationClotInBase,
				@UlcerationReflux,
				@UlcerationPostSclero,
				@UlcerationPostBanding,
				@Stricture,
				@StrictureCompression,
				@StrictureScopeNotPass,
				@StrictureSeverity,
				@StrictureType,
				@StrictureProbably,
				@StrictureBenignType,
				@StrictureBeginning,
				@StrictureLength,
				@StricturePerforation,
				@Tumour,
				@TumourType,
				@TumourProbably,
				@TumourExophytic,
				@TumourBenignType,
				@TumourBenignTypeOther,
				@TumourBeginning,
				@TumourLength,
				@TumourScopeCouldNotPass,
				@MiscOther,
				@InletPatch,
				@InletPatchMultiple,
				@InletPatchQty,
				@Fitsula,
				@LoggedInUserId,
				GETDATE(),
				@InletPouch,			
				@InletPouchQty,
				@ZLine,
				@ZlineSize,
				@Volvulus,
				@AmpullaryAdenoma,
				@StentOcclusion,
				@StentInSitu,
				@PEGInSitu)

		INSERT INTO ERS_RecordCount (
			[ProcedureId],
			[SiteId],
			[Identifier],
			[RecordCount]
		)
		VALUES (
			@proc_id,
			@SiteId,
			'Miscellaneous',
			1)
	END

	ELSE IF (@None = 0 AND @Web = 0 AND @Mallory = 0 AND @SchatzkiRing = 0 AND @FoodResidue = 0 
			AND @Diverticulum = 0 AND @MotilityDisorder = 0 AND @Ulceration = 0 AND @Stricture = 0 AND @Tumour = 0 
			AND @Foreignbody = 0 AND @InletPatch = 0 AND @Fitsula = 0 AND @InletPatch = 0 AND @InletPouch = 0 AND @ZLine = 0 AND @Volvulus = 0 AND @AmpullaryAdenoma = 0 AND @StentOcclusion = 0
			AND @StentInSitu = 0 AND @PEGInSitu = 1 AND RTRIM(LTRIM(@MiscOther)) = '')
	BEGIN
		DELETE FROM ERS_UpperGIAbnoMiscellaneous 
		WHERE SiteId = @SiteId

		DELETE FROM ERS_RecordCount 
		WHERE SiteId = @SiteId
		AND Identifier = 'Miscellaneous'
	END
	
	ELSE
	BEGIN
		UPDATE 
			ERS_UpperGIAbnoMiscellaneous
		SET 
			[None]				=	@None,
			Web					=	@Web,
			Mallory				=	@Mallory,
			SchatzkiRing		=	@SchatzkiRing,
			FoodResidue			=	@FoodResidue,
			Foreignbody = @Foreignbody,
			ExtrinsicCompression	=	@ExtrinsicCompression,
			Diverticulum		=	@Diverticulum,
			DivertMultiple		=	@DivertMultiple,
			DivertQty			=	@DivertQty,
			Pharyngeal			=	@Pharyngeal,
			DiffuseIntramural	=	@DiffuseIntramural,
			TractionType		=	@TractionType,
			PulsionType			=	@PulsionType,
			MotilityDisorder	=	@MotilityDisorder,
			ProbableAchalasia	=	@ProbableAchalasia,
			ConfirmedAchalasia	=	@ConfirmedAchalasia,
			Presbyoesophagus	=	@Presbyoesophagus,
			MarkedTertiaryContractions	=	@MarkedTertiaryContractions,
			LaxLowerOesoSphincter		=	@LaxLowerOesoSphincter,
			TortuousOesophagus		=	@TortuousOesophagus,
			DilatedOesophagus		=	@DilatedOesophagus,
			MotilityPoor			=	@MotilityPoor,
			Ulceration				=	@Ulceration,
			UlcerationType			=	@UlcerationType,
			UlcerationMultiple		=	@UlcerationMultiple,
			UlcerationQty			=	@UlcerationQty,
			UlcerationLength		=	@UlcerationLength,
			UlcerationClotInBase	=	@UlcerationClotInBase,
			UlcerationReflux		=	@UlcerationReflux,
			UlcerationPostSclero	=	@UlcerationPostSclero,
			UlcerationPostBanding	=	@UlcerationPostBanding,
			Stricture				=	@Stricture,
			StrictureCompression	=	@StrictureCompression,
			StrictureScopeNotPass	=	@StrictureScopeNotPass,
			StrictureSeverity		=	@StrictureSeverity,
			StrictureType			=	@StrictureType,
			StrictureProbably		=	@StrictureProbably,
			StrictureBenignType		=	@StrictureBenignType,
			StrictureBeginning		=	@StrictureBeginning,
			StrictureLength			=	@StrictureLength,
			StricturePerforation	=	@StricturePerforation,
			Tumour					=	@Tumour,
			TumourType				=	@TumourType,
			TumourProbably			=	@TumourProbably,
			TumourExophytic			=	@TumourExophytic,
			TumourBenignType		=	@TumourBenignType,
			TumourBenignTypeOther	=	@TumourBenignTypeOther,
			TumourBeginning			=	@TumourBeginning,
			TumourLength			=	@TumourLength,
			TumourScopeNotPass		=	@TumourScopeCouldNotPass,
			MiscOther				=	@MiscOther,
			InletPatch				=	@InletPatch,
			InletPatchMultiple		=	@InletPatchMultiple,
			InletPatchQty			=	@InletPatchQty,
			Fitsula					=	@Fitsula,
			WhoUpdatedId			=	@LoggedInUserId,
			WhenUpdated				=	GETDATE(),
			InletPouch				=	@InletPouch,			
			InletPouchQty			=	@InletPouchQty,
			ZLine					=	@ZLine,
			ZLineSize				=	@ZLineSize,
			Volvulus				=	@Volvulus,
			AmpullaryAdenoma		=	@AmpullaryAdenoma,
			StentOcclusion			=	@StentOcclusion,
			StentInSitu				=	@StentInSitu,
			PEGInSitu				=	@PEGInSitu
		WHERE 
			SiteId = @SiteId
	END
END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;
GO
SET ANSI_NULLS, QUOTED_IDENTIFIER ON;


GO
PRINT N'Altering Procedure [dbo].[abnormalities_miscellaneous_select]...';


GO
SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER OFF;


GO

ALTER PROCEDURE [dbo].[abnormalities_miscellaneous_select]
(
	@SiteId INT	
)
AS

SET NOCOUNT ON

SELECT
	SiteId,						
	[None],							
	[Web],							
	[Mallory],				
	[SchatzkiRing],					
	[FoodResidue],					
	[Foreignbody],					
	[ExtrinsicCompression],			
	[Diverticulum],					
	[DivertMultiple],				
	[DivertQty],						
	[Pharyngeal],					
	[DiffuseIntramural],				
	[TractionType],					
	[PulsionType],					
	[MotilityDisorder],				
	[ProbableAchalasia],				
	[ConfirmedAchalasia],			
	[Presbyoesophagus],				
	[MarkedTertiaryContractions],	
	[LaxLowerOesoSphincter],			
	[TortuousOesophagus],			
	[DilatedOesophagus],				
	[MotilityPoor],					
	[Ulceration],					
	[UlcerationType],				
	[UlcerationMultiple],			
	[UlcerationQty],					
	[UlcerationLength],				
	[UlcerationClotInBase],			
	[UlcerationReflux],				
	[UlcerationPostSclero],			
	[UlcerationPostBanding],			
	[Stricture],						
	[StrictureCompression],			
	[StrictureScopeNotPass],			
	[StrictureSeverity],			
	[StrictureType],					
	[StrictureProbably],				
	[StrictureBenignType],			
	[StrictureBeginning],			
	[StrictureLength],	
	[StricturePerforation],			
	[Tumour],						
	[TumourType],					
	[TumourProbably],				
	[TumourExophytic],				
	[TumourBenignType],				
	[TumourBenignTypeOther],			
	[TumourBeginning],				
	[TumourLength],					
	[TumourScopeNotPass],			
	[MiscOther],						
	[EUSproctype],
	[InletPatch],
	[InletPatchMultiple],
	[InletPatchQty],
	[Fitsula],
	[Summary],
	[InletPouch],	
	[InletPouchQty],
	[ZLine],
	[ZLineSize],
	[Volvulus],
	[AmpullaryAdenoma],
	[StentOcclusion],
	[StentInSitu],
	[PEGInSitu]
FROM
	[ERS_UpperGIAbnoMiscellaneous]
WHERE 
	SiteId = @SiteId
GO
SET ANSI_NULLS, QUOTED_IDENTIFIER ON;


GO
PRINT N'Altering Procedure [dbo].[abnormalities_miscellaneous_summary_update]...';


GO

ALTER PROCEDURE [dbo].[abnormalities_miscellaneous_summary_update]
(
	@SiteId INT
)
AS
	SET NOCOUNT ON

	DECLARE
		@Summary VARCHAR(1200),
		@temp VARCHAR(50),
		@OesoUlcer BIT,
		@None BIT,
		@Web BIT,
		@Mallory BIT,
		@SchatzkiRing BIT,
		@FoodResidue BIT,
		@Foreignbody BIT,
		@ExtrinsicCompression BIT,
		@Diverticulum BIT,
		@DivertMultiple BIT,
		@DivertQty SMALLINT,
		@Pharyngeal BIT,
		@DiffuseIntramural BIT,
		@TractionType BIT,
		@PulsionType BIT,
		@MotilityDisorder BIT,
		@ProbableAchalasia BIT,
		@ConfirmedAchalasia BIT,
		@Presbyoesophagus BIT,
		@MarkedTertiaryContractions BIT,
		@LaxLowerOesoSphincter BIT,
		@TortuousOesophagus BIT,
		@DilatedOesophagus BIT,
		@MotilityPoor BIT,
		@Ulceration BIT,
		@UlcerationType BIT,
		@UlcerationMultiple BIT,
		@UlcerationQty SMALLINT,
		@UlcerationLength SMALLINT,
		@UlcerationClotInBase BIT,
		@UlcerationReflux BIT,
		@UlcerationPostSclero BIT,
		@UlcerationPostBanding BIT,
		@Stricture BIT,
		@StrictureCompression TINYINT,
		@StrictureScopeNotPass BIT,
		@StrictureSeverity TINYINT,
		@StrictureType SMALLINT,
		@StrictureProbably BIT,
		@StrictureBenignType TINYINT,
		@StrictureBeginning SMALLINT,
		@StrictureLength SMALLINT,
		@StricturePerforation TINYINT,
		@Tumour BIT,
		@TumourType TINYINT,
		@TumourProbably BIT,
		@TumourExophytic TINYINT,
		@TumourBenignType TINYINT,
		@TumourBenignTypeOther NVARCHAR(100),
		@TumourBeginning SMALLINT,
		@TumourLength SMALLINT,
		@MiscOther NVARCHAR(150),
		@IsLAClassification BIT,
		@InletPatch BIT,
		@InletPatchMultiple BIT,
		@InletPatchQty SMALLINT,
		@Fitsula BIT,
		@InletPouch BIT,		
		@InletPouchQty SMALLINT,
		@ZLine BIT,
		@ZLineSize INT,
		@Volvulus BIT,
		@AmpullaryAdenoma BIT,
		@StentOcclusion BIT,
		@StentInSitu BIT,
		@PEGInSitu BIT

	SELECT 
		@None				=	[None],
		@Web				=	Web,
		@Mallory			=	Mallory,
		@SchatzkiRing		=	SchatzkiRing,
		@FoodResidue		=	FoodResidue,
		@Foreignbody 		= 	Foreignbody,
		@ExtrinsicCompression	=	ExtrinsicCompression,
		@Diverticulum		=	Diverticulum,
		@DivertMultiple		=	DivertMultiple,
		@DivertQty			=	DivertQty,
		@Pharyngeal			=	Pharyngeal,
		@DiffuseIntramural	=	DiffuseIntramural,
		@TractionType		=	TractionType,
		@PulsionType		=	PulsionType,
		@MotilityDisorder	=	MotilityDisorder,
		@ProbableAchalasia	=	ProbableAchalasia,
		@ConfirmedAchalasia	=	ConfirmedAchalasia,
		@Presbyoesophagus	=	Presbyoesophagus,
		@MarkedTertiaryContractions	=	MarkedTertiaryContractions,
		@LaxLowerOesoSphincter		=	LaxLowerOesoSphincter,
		@TortuousOesophagus		=	TortuousOesophagus,
		@DilatedOesophagus		=	DilatedOesophagus,
		@MotilityPoor			=	MotilityPoor,
		@Ulceration				=	Ulceration,
		@UlcerationType			=	UlcerationType,
		@UlcerationMultiple		=	UlcerationMultiple,
		@UlcerationQty			=	UlcerationQty,
		@UlcerationLength		=	UlcerationLength,
		@UlcerationClotInBase	=	UlcerationClotInBase,
		@UlcerationReflux		=	UlcerationReflux,
		@UlcerationPostSclero	=	UlcerationPostSclero,
		@UlcerationPostBanding	=	UlcerationPostBanding,
		@Stricture				=	Stricture,
		@StrictureCompression	=	StrictureCompression,
		@StrictureScopeNotPass	=	StrictureScopeNotPass,
		@StrictureSeverity		=	StrictureSeverity,
		@StrictureType			=	StrictureType,
		@StrictureProbably		=	StrictureProbably,
		@StrictureBenignType	=	StrictureBenignType,
		@StrictureBeginning		=	StrictureBeginning,
		@StrictureLength		=	StrictureLength,
		@StricturePerforation	=	StricturePerforation,
		@Tumour					=	Tumour,
		@TumourType				=	TumourType,
		@TumourProbably			=	TumourProbably,
		@TumourExophytic		=	TumourExophytic,
		@TumourBenignType		=	TumourBenignType,
		@TumourBenignTypeOther	=	(SELECT isnull(TumourBenignTypeOther, '') as [text()] FOR XML PATH('')),
		@TumourBeginning		=	TumourBeginning,
		@TumourLength			=	TumourLength,
		@MiscOther				=	MiscOther,
		@IsLAClassification		=	ISNULL(IsLAClassification,0),
		@InletPatch				=	InletPatch,
		@InletPatchMultiple		=	InletPatchMultiple,
		@InletPatchQty			=	InletPatchQty,
		@Fitsula				=	Fitsula,
		@InletPouch				=	InletPouch,		
		@InletPouchQty			=	InletPouchQty,
		@ZLine					=	ZLine,
		@ZLineSize				=	ZLineSize,
		@Volvulus				=	Volvulus,
		@AmpullaryAdenoma		=	AmpullaryAdenoma,
		@StentOcclusion			=	StentOcclusion,
		@StentInSitu			=	StentInSitu,
		@PEGInSitu				=	PEGInSitu

	FROM
		ERS_UpperGIAbnoMiscellaneous
	WHERE
		SiteId = @SiteId

	SET @Summary = ''

	IF @None = 1
		SET @Summary = '' --@Summary + 'No varices'
	ELSE 
	BEGIN

		DECLARE @tmpMisc	TABLE(Val VARCHAR(MAX))
		DECLARE @tmpMiscTAR TABLE(Val VARCHAR(MAX))
		DECLARE @UlcerText VARCHAR(500)
		DECLARE @StrictText VARCHAR(500)
		DECLARE @TumourText VARCHAR(500)
		DECLARE @a VARCHAR(500) = ''
		DECLARE @XMLlist XML
		DECLARE @br VARCHAR(7) = '<br />'
		DECLARE @indent VARCHAR(10) = '&nbsp;- ';

		--This line will be ignored in funtion dbo.fnBuildString at the end
		INSERT INTO @tmpMisc (Val) VALUES('~~NoCommas~~')

		IF ISNULL(@Ulceration,0) = 1
		BEGIN
			IF @Ulceration = 1 SET @UlcerText = dbo.fnRepOesoUlcer(@SiteId)
			IF @UlcerText <> '' INSERT INTO @tmpMisc (Val) VALUES(@indent + dbo.fnFirstLetterUpper(RTRIM(LTRIM(@UlcerText))) + '.' + @br)
		END

		IF ISNULL(@Tumour,0) = 1
		BEGIN
			SET @TumourText = dbo.fnRepOesoTumour(@SiteId)
			IF @TumourText <> '' INSERT INTO @tmpMisc (Val) VALUES(@indent + dbo.fnFirstLetterUpper(RTRIM(LTRIM(@TumourText))) + '.' + @br)
		END

		IF ISNULL(@Stricture,0) = 1
		BEGIN
			SET @StrictText = dbo.fnRepOesoStricture(@SiteId)
			IF @StrictText <> '' INSERT INTO @tmpMisc (Val) VALUES(@indent + dbo.fnFirstLetterUpper(RTRIM(LTRIM(@StrictText))) + '.' + @br)
		END

		--IF ISNULL(@TumourText,'') <> '' AND ISNULL(@StrictText,'') <> '' 
		--	SET @a = @TumourText + '. <br />' + @StrictText
		--ELSE
		--SET @a = RTRIM(LTRIM(ISNULL(@TumourText,'') + ISNULL(@StrictText,'')))

		--IF @a <> '' INSERT INTO @tmpMisc (Val) VALUES(@a)

		IF @Web = 1				INSERT INTO @tmpMiscTAR (Val) VALUES('web')
		IF @Mallory = 1			INSERT INTO @tmpMiscTAR (Val) VALUES('Mallory-Weiss tear')
		IF @SchatzkiRing = 1	INSERT INTO @tmpMiscTAR (Val) VALUES('Schatzki ring')
		--IF @ExtrinsicCompression = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('extrinsic compression')
		IF @FoodResidue = 1		INSERT INTO @tmpMiscTAR (Val) VALUES('food residue')
		IF @Foreignbody = 1		INSERT INTO @tmpMiscTAR (Val) VALUES('foreign body')
		IF @Fitsula = 1		INSERT INTO @tmpMiscTAR (Val) VALUES('fitsula')
		IF @AmpullaryAdenoma = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('ampullary adenoma')
		IF @StentOcclusion = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('stent occlusion')
		IF @StentInSitu = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('stent in situ')
		IF @PEGInSitu = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('PEG in situ')
		IF @InletPatch = 1 
		BEGIN
			SET @a = 'inlet patch '
			IF @InletPatchMultiple = 1
				SET @a = @a + 'multiple: '
			ELSE
				SET @a = @a + ': '
			
			IF ISNULL(@InletPatchQty,0) > 0
			BEGIN
				SET @a= @a + CONVERT(VARCHAR, @InletPatchQty) + ' mm'
			END

			INSERT INTO @tmpMiscTAR(Val) VALUES	(@a)
		END

		IF @InletPouch = 1 
		BEGIN
			SET @a = ''
			IF ISNULL(@InletPouchQty,0) > 0
			BEGIN
				IF ISNULL(@InletPouchQty,0) = 1 SET @a='inlet pouch is one mm'
				ELSE SET @a='inlet pouch: ' + CONVERT(VARCHAR, @InletPouchQty) + 'mm '
			END

			INSERT INTO @tmpMiscTAR(Val) VALUES	(@a)
		END

		SET @a = ''

		IF @ZLine = 1 
		BEGIN
			SET @a = 'squamocolumnar (Z Line)'
			IF ISNULL(@ZLineSize,0) > 0
			BEGIN
				SET @a='squamocolumnar (Z Line): ' + CONVERT(VARCHAR, @ZLineSize) + 'cm '
			END

			INSERT INTO @tmpMiscTAR (Val) VALUES(@a)
		END

		SET @a = ''

		IF @Volvulus = 1	INSERT INTO @tmpMiscTAR (Val) VALUES('Volvulus')

		IF (SELECT COUNT(Val) FROM @tmpMiscTAR) > 0 
		BEGIN
			SET @XMLlist = (SELECT Val FROM @tmpMiscTAR FOR XML  RAW, ELEMENTS, TYPE)
			INSERT INTO @tmpMisc (Val) VALUES(@indent + dbo.fnFirstLetterUpper(dbo.fnBuildString(@XMLlist)) + '.' + @br)
			DELETE FROM @tmpMiscTAR
		END

		IF @MotilityDisorder = 1
		BEGIN
			IF @ProbableAchalasia = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('probable achalasia')
			IF @ConfirmedAchalasia = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('confirmed achalasia')
			IF @MarkedTertiaryContractions = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('marked tertiary contractions')
			IF @Presbyoesophagus = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('presbyoesophagus')
			IF @LaxLowerOesoSphincter = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('lax lower oesophageal sphincter')
			IF @TortuousOesophagus = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('tortuous oesophagus')
			IF @DilatedOesophagus = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('dilated oesophagus')
			IF @MotilityPoor = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('poor motility')

			IF (SELECT COUNT(Val) FROM @tmpMiscTAR) > 0 
			BEGIN
				SET @XMLlist = (SELECT Val FROM @tmpMiscTAR FOR XML  RAW, ELEMENTS, TYPE)
				INSERT INTO @tmpMisc (Val) VALUES(@indent + dbo.fnFirstLetterUpper(dbo.fnBuildString(@XMLlist)) + '.' + @br)
				DELETE FROM @tmpMiscTAR
			END
			ELSE --None selected
				INSERT INTO @tmpMisc (Val) VALUES(@indent + dbo.fnFirstLetterUpper('motility disorder') + '.' + @br)
		END


		SET @a = ''

		IF @Diverticulum = 1
		BEGIN
			IF @Pharyngeal = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('pharyngeal (Zenker''s)')
			IF @TractionType = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('traction type')
			IF @PulsionType = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('pulsion type')
			IF @DiffuseIntramural = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('diffuse intramural')

			IF @DivertMultiple = 1 
				SET @a = 'diverticulae: multiple '
			ELSE IF ISNULL(@DivertQty,0) > 0
			BEGIN
				IF ISNULL(@DivertQty,0) = 1 SET @a = 'one diverticulum'
				ELSE SET @a = 'diverticulae: ' + CONVERT(VARCHAR, @DivertQty) + ' '
			END
			ELSE 
				SET @a = 'diverticulum: '
			
			IF (SELECT COUNT(Val) FROM @tmpMiscTAR) > 0
			BEGIN
				IF LEFT(@a,3) = 'one' SET @a = @a + ', '
				SET @XMLlist = (SELECT Val FROM @tmpMiscTAR FOR XML  RAW, ELEMENTS, TYPE)
				SET @a =  @a + dbo.fnBuildString(@XMLlist)
			END

			IF LEN(@a) > 0 
			BEGIN
				SET @a = RTRIM(LTRIM(@a))
				IF RIGHT(@a,1) = ':' SET @a = LEFT(@a, LEN(@a) - 1)
				INSERT INTO @tmpMisc (Val) VALUES(@indent + dbo.fnFirstLetterUpper(@a) + '.' + @br)
				DELETE FROM @tmpMiscTAR
			END
		END

		
		IF ISNULL(@MiscOther,'') <> '' 
			INSERT INTO @tmpMisc (Val) VALUES(@indent + dbo.fnFirstLetterUpper(RTRIM(@MiscOther)) + @br)

		SET @XMLlist = (SELECT Val FROM @tmpMisc FOR XML  RAW, ELEMENTS, TYPE)
		SET @Summary = dbo.fnBuildString(@XMLlist)

		IF @Summary <> '' 
		BEGIN
			SET @Summary = LTRIM(RTRIM(@Summary))
			--Remove the first indent as this will be done in SP sites_summary_update
			IF LEFT(@Summary,8) = @indent SET @Summary = RIGHT(@Summary, LEN(@Summary) - 8)
			IF RIGHT(@Summary,6) = @br SET @Summary = LEFT(@Summary, LEN(@Summary) - 6)
			IF RIGHT(@Summary,1) = '.' SET @Summary = LEFT(@Summary, LEN(@Summary) - 1)
		END
	END

	-- Finally update the summary in abnormalities table
	UPDATE ERS_UpperGIAbnoMiscellaneous
	SET Summary = @Summary 
	WHERE SiteId = @siteId
GO
PRINT N'Altering Procedure [dbo].[infer_mucosa_diagnoses]...';


GO
SET ANSI_NULLS, QUOTED_IDENTIFIER OFF;


GO

ALTER PROCEDURE [dbo].[infer_mucosa_diagnoses]
(
	@SiteId INT,
	@LoggedInUserId INT
)
AS
-- =============================================
-- All the items which were under Diagnoses screen (as UGI) are being saved under this SP
-- Diagnoses been moved to Miscellaneous and Mucosa under Abnormalities, to be inferred and report under Diagnoses section of the report
-- =============================================

SET NOCOUNT ON

BEGIN TRANSACTION

BEGIN TRY

	DECLARE @ProcedureID INT,
	@ColonNormal BIT,
	@ColonRestNormal BIT,
	@Colitis BIT,
	@Ileitis BIT,
	@Proctitis BIT,
	@ColitisType VARCHAR(15),
	@ColitisExtent VARCHAR(15),
	@ColonList VARCHAR(1500),
	--@ColonOtherDiagnosis VARCHAR(MAX),
	@MayoScore VARCHAR(15),
	@SEScore VARCHAR(15),
	@IschaemicColitis VARCHAR(15),
	@PseudomembranousColitis VARCHAR(15),
	@UlcerativeColitis VARCHAR(15),
	@NonSpecificColitis VARCHAR(15),
	@ColitisIleum VARCHAR(15),
	@Crohns VARCHAR(15),
	@Diverticulosis VARCHAR(15),
	@RadiationProctopathy VARCHAR(15)





	
	
	IF EXISTS(SELECT 1 FROM ERS_Sites WHERE SiteId = @SiteId)
	BEGIN
  		SELECT @ProcedureId = p.ProcedureId
		FROM ERS_Sites s
		JOIN ERS_Procedures p ON s.ProcedureId = p.ProcedureId
		WHERE SiteId = @SiteId

		SELECT @ColonNormal = 1		FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND Value = '1' AND IsOtherData = 1 AND MatrixCode = 'ColonNormal'
		SELECT @ColonRestNormal = 1 FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND Value = '1' AND IsOtherData = 1 AND MatrixCode = 'ColonRestNormal'

		DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND IsOtherData = 1

		SELECT @ColonList = CASE WHEN [Crohn] = 1 THEN 'D70P3,' ELSE '' END +
		  CASE WHEN [Fistula] = 1 THEN 'D71P3,' ELSE '' END +
		  CASE WHEN [ForeignBody] = 1 THEN 'D72P3,' ELSE '' END +
		  CASE WHEN [Lipoma] = 1 THEN 'D73P3,' ELSE '' END +
		  CASE WHEN [Melanosis] = 1 THEN 'D74P3,' ELSE '' END +
		  CASE WHEN [Parasites] = 1 THEN 'D75P3,' ELSE '' END +
		  CASE WHEN [PneumatosisColi] = 1 THEN 'D76P3,' ELSE '' END +
		  CASE WHEN [PolyposisSyndrome] = 1 THEN 'D77P3,' ELSE '' END +
		  CASE WHEN [PostoperativeAppearance] = 1 THEN 'D78P3,' ELSE '' END +
		  CASE WHEN [PseudoObstruction] = 1 THEN 'D9P3,' ELSE '' END 
		FROM ERS_ColonAbnoMiscellaneous
		WHERE SiteId = @SiteId

		select @ColonList
		IF ISNULL(@ColonList,'') <> ''
		BEGIN
			INSERT INTO [ERS_Diagnoses] (ProcedureID, MatrixCode, Value, Region, IsOtherData, WhoCreatedId, WhenCreated)
			SELECT @ProcedureId, [item], CONVERT(VARCHAR(MAX),'True'), 'Colon', 1, @LoggedInUserId, GETDATE() FROM dbo.fnSplitString(@ColonList,',')
		END

		SELECT @Colitis=[InflammatoryColitis]			,@Ileitis=[InflammatoryIleitis]			,@Proctitis=[InflammatoryProctitis]			,@ColitisType=[InflammatoryDisorder]
				,@ColitisExtent=[InflammatoryExtent]	,@MayoScore=[InflammatoryMayoScore]		,@SEScore=[InflammatorySESCrohn]
		FROM ERS_ColonAbnoMucosa
		WHERE SiteId = @SiteId


		INSERT INTO [ERS_Diagnoses] (ProcedureID, MatrixCode, SiteId, Value, Region, IsOtherData, WhoCreatedId, WhenCreated)
		--SELECT @ProcedureId, [item], CONVERT(VARCHAR(MAX),'True'), 'Colon', 1, @LoggedInUserId, GETDATE() FROM dbo.fnSplitString(@ColonList,',')
		--UNION
		SELECT @ProcedureId, 'ColonNormal', NULL, CONVERT(VARCHAR(MAX),@ColonNormal), 'Colon', 1, @LoggedInUserId, GETDATE() WHERE @ColonNormal = 1 
		UNION
		SELECT @ProcedureId, 'ColonRestNormal', NULL, CONVERT(VARCHAR(MAX),@ColonRestNormal), 'Colon', 1, @LoggedInUserId, GETDATE() WHERE @ColonRestNormal = 1 
		UNION
		SELECT @ProcedureId, 'Colitis', @SiteId, CONVERT(VARCHAR(MAX),@Colitis), 'Colon', 1, @LoggedInUserId, GETDATE() WHERE @Colitis = 1 
		UNION
		SELECT @ProcedureId, 'Ileitis', @SiteId, CONVERT(VARCHAR(MAX),@Ileitis), 'Colon', 1, @LoggedInUserId, GETDATE() WHERE @Ileitis = 1 
		UNION
		SELECT @ProcedureId, 'Proctitis', @SiteId, CONVERT(VARCHAR(MAX),@Proctitis), 'Colon', 1, @LoggedInUserId, GETDATE() WHERE @Proctitis = 1 
		UNION
		SELECT @ProcedureId, 'N2015', @SiteId, CONVERT(VARCHAR(MAX),@Proctitis), 'Colon', 1, @LoggedInUserId, GETDATE() WHERE @Proctitis = 1 
		UNION
		SELECT @ProcedureId, 'ColitisType', @SiteId, CONVERT(VARCHAR(MAX),@ColitisType), 'Colon', 1, @LoggedInUserId, GETDATE() WHERE @ColitisType <> '' 
		UNION
		SELECT @ProcedureId, 'ColitisExtent', @SiteId, CONVERT(VARCHAR(MAX),@ColitisExtent), 'Colon', 1, @LoggedInUserId, GETDATE() WHERE @ColitisExtent <> '' AND @ColitisExtent <> '0'
		UNION
		--SELECT @ProcedureId, 'ColonOtherDiagnosis', CONVERT(VARCHAR(MAX),@ColonOtherDiagnosis), 'Colon', 1, @LoggedInUserId, GETDATE() WHERE @ColonOtherDiagnosis <> '' 
		--UNION
		SELECT @ProcedureId, 'MayoScore', @SiteId, CONVERT(VARCHAR(MAX),@MayoScore), 'Colon', 1, @LoggedInUserId, GETDATE() WHERE @MayoScore <> ''  AND @MayoScore <> '0'
		UNION
		SELECT @ProcedureId, 'SEScore', @SiteId, CONVERT(VARCHAR(MAX),@SEScore), 'Colon', 1, @LoggedInUserId, GETDATE() WHERE @SEScore <> '' AND @SEScore <> '0'

		IF @Colitis = 1
		BEGIN
			--ids from ERS_InflammatoryDisorders. your welcome ;)
			SET @IschaemicColitis = (CASE WHEN @ColitisType=8 THEN 'True' ELSE 'False' END)
			SET @PseudomembranousColitis = (CASE WHEN @ColitisType=10 THEN 'True' WHEN @ColitisType = 5 THEN 'True' ELSE 'False' END)
			SET @UlcerativeColitis = (CASE WHEN @ColitisType=12 THEN 'True' WHEN @ColitisType = 3 THEN 'True' ELSE 'False' END)
			SET @Diverticulosis = (CASE WHEN @ColitisType=4 THEN 'True' ELSE 'False' END)
			SET @NonSpecificColitis = (CASE WHEN @ColitisType=1 THEN 'True' ELSE 'False' END)
			SET @Crohns = (CASE WHEN @ColitisType=2 THEN 'True' ELSE 'False' END)
			SET @RadiationProctopathy = (CASE WHEN @Proctitis = 1 AND @ColitisType = 11 THEN 'True' ELSE 'False' END)
			
			EXEC diagnoses_control_save @SiteId, 'D92P3', @IschaemicColitis
			EXEC diagnoses_control_save @SiteId, 'D94P3', @PseudomembranousColitis
			EXEC diagnoses_control_save @SiteId, 'D96P3', @UlcerativeColitis
			--EXEC diagnoses_control_save @SiteId, 'D1P3',  @Diverticulosis
			EXEC diagnoses_control_save @SiteId, 'D86P3', @Crohns
			EXEC diagnoses_control_save @SiteId, 'N2014', @NonSpecificColitis
			EXEC diagnoses_control_save @SiteId, 'DRPROCTP3', @RadiationProctopathy

			--if region is terminal ileum D70P3
			DECLARE @ColitisRegion VARCHAR(50) = (SELECT region FROM ers_regions r
										INNER JOIN ers_sites s ON s.regionid = r.regionid
										WHERE siteid = @SiteId)

			SET @ColitisIleum = (CASE WHEN LOWER(@ColitisRegion) = 'terminal ileum' THEN 'True' ELSE 'False' END)
			EXEC diagnoses_control_save @SiteId, 'D70P3', @ColitisIleum

			
		END
		ELSE
		BEGIN
			EXEC diagnoses_control_save @SiteId, 'D92P3', 'False'
			EXEC diagnoses_control_save @SiteId, 'D94P3', 'False'
			EXEC diagnoses_control_save @SiteId, 'D96P3', 'False'
			--EXEC diagnoses_control_save @SiteId, 'D1P3',  'False'
			EXEC diagnoses_control_save @SiteId, 'D86P3', 'False'
			EXEC diagnoses_control_save @SiteId, 'N2014', 'False'
			EXEC diagnoses_control_save @SiteId, 'D70P3', 'False'
			EXEC diagnoses_control_save @SiteId, 'DRPROCTP3', 'False'

		END

		IF @ColonNormal = 0 
			DELETE FROM ERS_Diagnoses WHERE ProcedureId = @ProcedureID AND (MatrixCode = 'ColonNormal')

		IF @ColonRestNormal = 0
			DELETE FROM ERS_Diagnoses WHERE ProcedureId = @ProcedureID AND (MatrixCode = 'ColonRestNormal')

		IF  @Colitis = 0 AND @Ileitis = 0
		BEGIN
			DELETE FROM ERS_Diagnoses WHERE ProcedureId = @ProcedureID AND (MatrixCode = 'Colitis')
			DELETE FROM ERS_Diagnoses WHERE ProcedureId = @ProcedureID AND (MatrixCode = 'ColitisType')
		END

		IF  @Ileitis = 0
			DELETE FROM ERS_Diagnoses WHERE ProcedureId = @ProcedureID AND (MatrixCode = 'Ileitis')

		IF @Proctitis = 0
			DELETE FROM ERS_Diagnoses WHERE ProcedureId = @ProcedureID AND (MatrixCode = 'Proctitis')

		IF @ColitisType = '' OR @ColitisType = 0
			DELETE FROM ERS_Diagnoses WHERE ProcedureId = @ProcedureID AND (MatrixCode = 'ColitisType')

		IF @ColitisExtent = '' OR @ColitisExtent =0
			DELETE FROM ERS_Diagnoses WHERE ProcedureId = @ProcedureID AND (MatrixCode = 'ColitisExtent')

		IF @MayoScore = '' OR @MayoScore = 0
			DELETE FROM ERS_Diagnoses WHERE ProcedureId = @ProcedureID AND (MatrixCode = 'MayoScore')

		IF @SEScore = '' OR @SEScore = 0
			DELETE FROM ERS_Diagnoses WHERE ProcedureId = @ProcedureID AND (MatrixCode = 'SEScore')
		--EXEC ogd_diagnoses_summary_update @ProcedureId;
	END
END TRY
BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;
GO
SET ANSI_NULLS, QUOTED_IDENTIFIER ON;


GO
PRINT N'Altering Procedure [dbo].[site_details_menu_select]...';


GO
ALTER PROCEDURE [dbo].[site_details_menu_select]
(
	@SiteId INT	
)
AS

SET NOCOUNT ON

DECLARE	@ProcedureType INT
DECLARE @Region VARCHAR (500)
DECLARE	@Area VARCHAR (50)
DECLARE	@ProcedureId INT

CREATE TABLE #Menus (
	[SiteId] INT,
	[ProcedureType] INT,
	[Region] VARCHAR(500),	
	[ParentMenu] VARCHAR (500),
	[Menu] VARCHAR (500),
	[NavigateUrl] VARCHAR (4000),
	[SortOrder] TINYINT
)

DECLARE @SiteNo INT = NULL, @IsLymphNode BIT = 0

SELECT @SiteNo = SiteNo FROM ERS_Sites WHERE SiteId = @SiteId

IF @SiteId = -1 
BEGIN
	SET @ProcedureType = 11
	SET @IsLymphNode = 1
	SET @Region = 'EBUS'
END
ELSE IF @SiteNo = 0
	SET @SiteId = dbo.fnGetPrimeSiteId(@SiteId)
ELSE IF @SiteNo = -77   --'SiteNo is set to -77 for sites By Distance (Col & Sig only)
	SELECT @ProcedureType = 3, @Region = 'Anus'
ELSE
	SELECT @ProcedureType = p.ProcedureType, @Region = r.Region, @ProcedureId = p.ProcedureId, @IsLymphNode = s.IsLymphNode 
	FROM ERS_Sites s
	JOIN ERS_Procedures p ON s.ProcedureId = p.ProcedureId
	JOIN ERS_Regions r ON s.RegionId = r.RegionId
	WHERE SiteId = @SiteId

IF @ProcedureType IN (1,6) --Gastroscopy / EUS(OGD)
BEGIN

	SELECT TOP 1 @Area = [Area] 
	FROM ERS_AbnormalitiesMatrixUpperGI
	WHERE [ProcedureType] = @ProcedureType 
	AND [Region] = @Region

	INSERT INTO #Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu])
	SELECT 
		@SiteId,
		[ProcedureType], 
		[Region], 
		'Abnormalities' AS [ParentMenu], 
		[Menu]
	FROM 
	(
		SELECT * 
		FROM [ERS_AbnormalitiesMatrixUpperGI] 
		WHERE [ProcedureType] = @ProcedureType 
		AND [Region] = @Region
	) a
	UNPIVOT
	(
		[Display] 
		FOR [Menu] IN ([Gastritis], [Gastric Ulcer], [Lumen], [Malignancy], [Post Surgery], 
						[Deformity], [Polyps], [Varices], [Hiatus Hernia], [Achalasia], 
						[Oesophagitis], [Barretts], [Miscellaneous], [Diverticulum/Other], [Tumour], 
						[Duodenitis], [Pyloric Ulcer], [Duodenal Ulcer], [Scarring/Stenosis], [Vascular Lesions],
						[Atrophic Duodenum], [Mediastinal], [Lesions])
	) b
	WHERE [Display] = 1

	INSERT INTO #Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu], [NavigateUrl], [SortOrder])
	SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Gastro/TherapeuticProcedures/OGDTherapeuticProcedures.aspx', 1
	--SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Gastro/Abnormalities/OGD/Lumen.aspx'
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Gastro/Specimens/OGDSpecimensTaken.aspx', 2
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Media', '', '~/Products/Common/AttachedMedia.aspx', 3
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Additional notes', '', '~/Products/Gastro/Notes/Notes.aspx', 4
	--SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Gastro/Abnormalities/OGD/Lumen.aspx'
END

ELSE IF @ProcedureType IN (2,7) --ERCP / EUS(HPB)
BEGIN

	SELECT TOP 1 @Area = [Area] 
	FROM ERS_AbnormalitiesMatrixERCP
	WHERE [ProcedureType] = @ProcedureType 
	AND [Region] = @Region

	INSERT INTO #Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu])
	SELECT 
		@SiteId,
		[ProcedureType], 
		[Region], 
		'Abnormalities' AS [ParentMenu], 
		[Menu]
	FROM 
	(
		SELECT * 
		FROM [ERS_AbnormalitiesMatrixERCP] 
		WHERE [ProcedureType] = @ProcedureType 
		AND [Region] = @Region
	) a
	UNPIVOT
	(
		[Display] 
		FOR [Menu] IN ([Gall Bladder], [Duct], [Parenchyma], [Appearance], [Diverticulum], [Tumour], [Diverticulum/Other], 
						[TumourCommon],[Duodenitis],[Duodenal Ulcer],[Scarring/Stenosis],[Vascular Lesions],[Atrophic Duodenum],[Intrahepatic],[Site],[Miscellaneous], [Varices])
	) b
	WHERE [Display] = 1

	INSERT INTO #Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu], [NavigateUrl], [SortOrder])
	--SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Gastro/TherapeuticProcedures/ERCPTherapeuticProcedures.aspx'
	--SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Gastro/Abnormalities/OGD/Lumen.aspx'
	SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Gastro/TherapeuticProcedures/ERCPTherapeuticProcedures.aspx', 1
	UNION ALL
	--SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Gastro/Specimens/ERCPSpecimensTaken.aspx'
	--SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Gastro/Abnormalities/OGD/Lumen.aspx'
	SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Gastro/Specimens/OGDSpecimensTaken.aspx', 2
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Media', '', '~/Products/Common/AttachedMedia.aspx', 3
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Additional notes', '', '~/Products/Gastro/Notes/Notes.aspx', 4
	
END

ELSE IF @ProcedureType IN (3,4,5) --Colonoscopy / Proctoscopy / Sigmoidoscopy
BEGIN
	INSERT INTO #Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu])
	SELECT 
		@SiteId,
		[ProcedureType], 
		[Region], 
		'Abnormalities' AS [ParentMenu], 
		[Menu]
	FROM 
	(
		SELECT * 
		FROM [ERS_AbnormalitiesMatrixColon] 
		WHERE [ProcedureType] = @ProcedureType 
		AND [Region] = @Region
	) a
	UNPIVOT
	(
		[Display] 
		FOR [Menu] IN ([Calibre],[Mucosa], [Diverticulum], [Lesions], [Vascularity], [Haemorrhage], [Miscellaneous], [Perianal Lesions],[Tumour], [Varices])
	) b
	WHERE [Display] = 1

	INSERT INTO #Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu], [NavigateUrl], [SortOrder])
	--SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Gastro/TherapeuticProcedures/ColonTherapeuticProcedures.aspx'
	--SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Gastro/Abnormalities/OGD/Lumen.aspx'
	SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Gastro/TherapeuticProcedures/OGDTherapeuticProcedures.aspx', 1
	UNION ALL
	--SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Gastro/Specimens/ColonSpecimensTaken.aspx'
	--SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Gastro/Abnormalities/OGD/Lumen.aspx'
	SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Gastro/Specimens/OGDSpecimensTaken.aspx', 2
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Media', '', '~/Products/Common/AttachedMedia.aspx', 3
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Additional notes', '', '~/Products/Gastro/Notes/Notes.aspx', 4
END

ELSE IF @ProcedureType IN (8) --Antegrade
BEGIN
	SELECT TOP 1 @Area = [Area] 
	FROM [ERS_AbnormalitiesMatrixAntegrade]
	WHERE [ProcedureType] = @ProcedureType 
	AND [Region] = @Region

	INSERT INTO #Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu])
	SELECT 
		@SiteId,
		[ProcedureType], 
		[Region], 
		'Abnormalities' AS [ParentMenu], 
		CASE WHEN region = 'Jejunum' AND [Menu] = 'Diverticulum/Other' THEN 'Diverticulum' /*WHEN region= 'Ileum' AND [Menu] = 'Miscellaneous/Other' THEN 'Miscellaneous'*/ ELSE [Menu] END AS Menu
	FROM 
	(
		SELECT * 
		FROM [ERS_AbnormalitiesMatrixAntegrade] 
		WHERE [ProcedureType] = @ProcedureType 
		AND [Region] = @Region
	) a
	UNPIVOT
	(
		[Display] 
		FOR [Menu] IN ([Gastritis], [Gastric Ulcer], [Lumen], [Malignancy], [Post Surgery], 
						[Deformity], [Varices], [Hiatus Hernia], [Achalasia], 
						[Oesophagitis], [Barretts], [Miscellaneous], [Diverticulum/Other], [Tumour], 
						[Duodenitis], [Pyloric Ulcer], [Duodenal Ulcer], 
						[Lesions],[Jejunitis],[Jejunal Ulcer],[Ileitis],[Ileal Ulcer],
						[Scarring/Stenosis], [Vascular Lesions],
						[Atrophic Duodenum], [Miscellaneous/Other])
	) b
	WHERE [Display] = 1

	INSERT INTO #Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu], [NavigateUrl], [SortOrder])
	SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Gastro/TherapeuticProcedures/OGDTherapeuticProcedures.aspx', 1
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Gastro/Specimens/OGDSpecimensTaken.aspx', 2
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Media', '', '~/Products/Common/AttachedMedia.aspx', 3
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Additional notes', '', '~/Products/Gastro/Notes/Notes.aspx', 4
END

ELSE IF @ProcedureType IN (9) --Retrograde
BEGIN
	INSERT INTO #Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu])
	SELECT 
		@SiteId,
		[ProcedureType], 
		[Region], 
		'Abnormalities' AS [ParentMenu], 
		[Menu]
	FROM 
	(
		SELECT * 
		FROM [ERS_AbnormalitiesMatrixRetrograde] 
		WHERE [ProcedureType] = @ProcedureType 
		AND [Region] = @Region
	) a
	UNPIVOT
	(
		[Display] 
		FOR [Menu] IN ([Calibre], [Mucosa], [Diverticulum], [Lesions], [Vascularity], [Haemorrhage], [Miscellaneous], [Perianal Lesions], [Tumour], 
		[Jejunitis], [Jejunal Ulcer], [Scarring/Stenosis], [Ileitis], [Ileal Ulcer], [Varices])
	) b
	WHERE [Display] = 1

	INSERT INTO #Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu], [NavigateUrl], [SortOrder])
	--SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Gastro/TherapeuticProcedures/ColonTherapeuticProcedures.aspx'
	--SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Gastro/Abnormalities/OGD/Lumen.aspx'
	SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Gastro/TherapeuticProcedures/OGDTherapeuticProcedures.aspx', 1
	UNION ALL
	--SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Gastro/Specimens/ColonSpecimensTaken.aspx'
	--SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Gastro/Abnormalities/OGD/Lumen.aspx'
	SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Gastro/Specimens/OGDSpecimensTaken.aspx', 2
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Media', '', '~/Products/Common/AttachedMedia.aspx', 3
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Additional notes', '', '~/Products/Gastro/Notes/Notes.aspx', 4
END

ELSE IF @ProcedureType IN (10,11) and @IsLymphNode = 0 -- Bronchoscopy / EBUS
BEGIN
	INSERT INTO #Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu])
	SELECT 
		@SiteId,
		[ProcedureType], 
		[Region], 
		'Abnormalities' AS [ParentMenu], 
		[Menu]
	FROM 
	(
		SELECT * 
		FROM [ERS_AbnormalitiesMatrixBRT] 
		WHERE [ProcedureType] = @ProcedureType 
		--AND [Region] = @Region      -- Abnormality is the same for all BRT regions 
	) a
	UNPIVOT
	(
		[Display] 
		FOR [Menu] IN ([Carinal Abnormality], [Vocal Cord Paralysis], [Compression], [Stenosis], [Obstruction], [Mucosal], [Mucosal Irregularity], [Excessive secretions], [Bleeding])
	) b
	WHERE [Display] = 1

	INSERT INTO #Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu], [NavigateUrl], [SortOrder])
	SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Gastro/TherapeuticProcedures/OGDTherapeuticProcedures.aspx', 1
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Broncho/Specimens/BronchoSpecimens.aspx', 2
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Media', '', '~/Products/Common/AttachedMedia.aspx', 3
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Additional notes', '', '~/Products/Gastro/Notes/Notes.aspx', 4
END

ELSE IF @ProcedureType = 11 and @IsLymphNode = 1 --  EBUS
BEGIN
	INSERT INTO #Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu])
	SELECT 
		@SiteId,
		[ProcedureType], 
		[Region], 
		'Abnormalities' AS [ParentMenu], 
		[Menu]
	FROM 
	(
		SELECT * 
		FROM [ERS_AbnormalitiesMatrixBRT] 
		WHERE [ProcedureType] = @ProcedureType 
		--AND [Region] = @Region      -- Abnormality is the same for all BRT regions 
	) a
	UNPIVOT
	(
		[Display] 
		FOR [Menu] IN ([EBUS Abnormality descriptions])
	) b
	WHERE [Display] = 1

	INSERT INTO #Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu], [NavigateUrl], [SortOrder])
	SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Gastro/TherapeuticProcedures/OGDTherapeuticProcedures.aspx', 1
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Broncho/Specimens/BronchoSpecimens.aspx', 2
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Media', '', '~/Products/Common/AttachedMedia.aspx' , 3
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Additional notes', '', '~/Products/Gastro/Notes/Notes.aspx', 4
END
ELSE IF @ProcedureType IN (13) -- Cystoscopy
BEGIN
	INSERT INTO #Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu])
	SELECT 
		@SiteId,
		[ProcedureType], 
		[Region], 
		'Abnormalities' AS [ParentMenu], 
		[Menu]
	FROM 
	(
		SELECT * 
		FROM [ERS_AbnormalitiesMatrixCystoscopy] 
		WHERE [ProcedureType] = @ProcedureType 
		AND [Region] = @Region      
	) a
	UNPIVOT
	(
		[Display] 
		FOR [Menu] IN ([Bladder],[Prostate],[Urethra])
	) b
	WHERE [Display] = 1

	INSERT INTO #Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu], [NavigateUrl], [SortOrder])
	SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Cystoscopy/TherapeuticProcedures/CystoscopyTherapeuticProcedures.aspx', 1
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Cystoscopy/Specimens/CystoscopySpecimens.aspx', 2
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Media', '', '~/Products/Common/AttachedMedia.aspx', 3
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Additional notes', '', '~/Products/Gastro/Notes/Notes.aspx', 3
END

UPDATE a
SET NavigateUrl = b.NavigateUrl
FROM #Menus a
LEFT JOIN ERS_SiteDetailsMenuUrls b ON a.Menu = b.Menu
WHERE b.ProcedureType = @ProcedureType

UPDATE #Menus SET Menu = 'Tumour' WHERE Menu = 'TumourCommon'

-- Check if there are Other Abnormalities in this region, if there are, display Other in the Abnormalities tab
IF EXISTS (SELECT 1 FROM sys.objects WHERE object_id = object_id('ERS_OtherAbnormalitiesRegions'))
begin
If exists(Select 1 from ERS_OtherAbnormalitiesRegions oar join ERS_Sites s on s.RegionId = oar.RegionId join ERS_OtherAbnormalities OA on oar.OtherId = OA.OtherId where OA.Active = 1 and s.SiteId = @SiteId)
BEGIN
	INSERT INTO #Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu], [NavigateUrl])
	SELECT 
		@SiteId,
		@ProcedureType, 
		r.Region, 
		'Abnormalities' AS [ParentMenu], 
		'Other' as [Menu],
		'~/Products/Gastro/Abnormalities/Common/Other.aspx' as NavigateUrl
	FROM ERS_Sites s
	join ERS_Regions r on s.RegionId = r.regionId
	where s.SiteId = @SiteId 
END
end
SELECT 
	m.ProcedureType,
	m.Region,
	m.ParentMenu, 
	m.Menu,
	m.NavigateUrl, 
	CASE WHEN r.RecordCountId IS NULL THEN 0 ELSE 1 END AS RecordExists,
	ISNULL(@Area,ISNULL(@Region,'')) AS Area
FROM 
	#Menus m
LEFT OUTER JOIN
	ERS_RecordCount r ON 
		(m.SiteId = r.SiteId OR
			(@ProcedureType IN (2,7) AND r.ProcedureId = @ProcedureId AND r.Identifier = 'Diagnoses')) --These conditions for Diagnoses only (for the whole procedure unlike the other items which are per site)
		AND (m.Menu = r.Identifier OR m.ParentMenu = r.Identifier)
				--OR LEFT(m.Menu,12) = 'Diverticulum') -- embolden 'Diverticulum/Other' when its attributes have been set.
ORDER BY m.SortOrder, m.Menu

DROP TABLE #Menus
GO
PRINT N'Altering Procedure [dbo].[usp_NED_Generate_Report]...';


GO

ALTER PROCEDURE [dbo].[usp_NED_Generate_Report]
(
	@ProcedureId AS INT
)
AS
BEGIN
	SET NOCOUNT ON;

/*
	<xs:schema xmlns="https://www.jets.nhs.uk/schema/hospital.sendbatchmessage-version2.xsd" 
	xmlns:mstns="https://www.jets.nhs.uk/schema/hospital.sendbatchmessage-version2.xsd" 
	xmlns:xs="http://www.w3.org/2001/XMLSchema" 
	targetNamespace="https://www.jets.nhs.uk/schema/hospital.sendbatchmessage-version2.xsd" 
	elementFormDefault="qualified" id="SendBatchMessageFile">		

*/
Declare @site AS VARCHAR(50);
DECLARE 
		@description	AS VARCHAR(1000),
		@uniqueid		AS VARCHAR(15),
		@previousLocalProcedureId AS VARCHAR(15),
		@PatientId		AS INT,
		@sessionType	AS VARCHAR(50),
		@operatingHospitalId AS INT,
		@ProcedureTypeId AS INT,
		@ExportFolderPath AS VARCHAR(100);	--## XML Export Folder path.. Set by Admin in the [ERS_SystemConfig] Table

DECLARE @returnXML XML;

	Set @description = 'NED List';
	SELECT @operatingHospitalId = OperatingHospitalId FROM ERS_Procedures WHERE ProcedureId = @ProcedureId;
	SELECT @site = [NED_HospitalSiteCode], @ExportFolderPath=[NED_ExportPath] FROM [dbo].[ERS_SystemConfig] WHERE OperatingHospitalId = @operatingHospitalId;

	SELECT @ProcedureTypeId = ProcedureType,
		   @uniqueid = RIGHT(('00000' + CAST(@ProcedureId AS VARCHAR(6))),6) --## Procedure Id
							+ RIGHT(('0' + CAST(ProcedureType AS VARCHAR(2))),2)  --## Procedure Type; ie: OGD=1/ERCP=2/COLON=3/FLEXI=13
								+ (CASE ProcedureType	WHEN  1 THEN 'o' 
														WHEN  2 THEN 'e'
														WHEN  4 THEN 's' 
														WHEN  3 THEN 'c'
														WHEN  6 THEN 'u'
														WHEN  7 THEN 'u'
														WHEN  8 THEN 'n'
														WHEN  9 THEN 't'
									END)	--## Procedure Letter
		 , @sessionType=Case ListType	When 1 Then 'Service List' 
										When 2 Then 'Adhoc Training List' 
											   Else 'Dedicated Training List' End 
		, @PatientId = PatientId
	From dbo.ERS_Procedures Where ProcedureId=@ProcedureId;


	--## UniqueId is generated- so UPDATE this new value now in the ERS_Procedures Table
	UPDATE dbo.ERS_Procedures
	SET [NEDProcedureId] = @uniqueid
	WHERE ProcedureId=@ProcedureId;

	--## Now get the Previous NED Unique Id- of the same Patient... We know the Patient Id already! Use it!!
	SELECT @previousLocalProcedureId = IsNull([NEDProcedureId], '') 
			 FROM dbo.ERS_Procedures 
			WHERE PatientId = @PatientId AND ProcedureId<@ProcedureId
		 ORDER BY ProcedureID DESC;

	print '@uniqueid: ' + @uniqueid;

SET @returnXML=(
SELECT 
	  @uniqueid											AS '@uniqueId'
	, @description										AS '@description'
	, REPLACE(convert(varchar, p.CreatedOn, 106), ' ', '/')	AS '@date'	--### '10 Oct 2020' ==> '10/Oct/2020'
	, P.ProcedureTime AS '@time'
	, @sessionType										AS '@type'	-- SessionTypeEnum
	, @site												AS '@site'	--## Hospital Code

	/*	##### Procedure info	*/
	, (
	Select 
		  @uniqueid										AS '@localProcedureId'
		, @previousLocalProcedureId						AS '@previousLocalProcedureId'
		, (CASE P.ProcedureType WHEN 1 THEN 'OGD' 
								WHEN 2 THEN 'ERCP' 
								WHEN 3 THEN 'COLON' 
								WHEN 4 THEN 'FLEXI' 
								WHEN 6 THEN 'EUS' 
								WHEN 7 THEN 'EUS' 
								WHEN 8 THEN 'ENT' 
								WHEN 9 THEN 'ENT' 
		   END) AS '@procedureName'
		, Dis.NEDTerm AS '@procedureDiscomfort'	
		, PPDD.NEDTerm AS '@postProcedureDiscomfort' -- **************************** TO DO *********************************
		, dbo.fnNED_ProcedureExtent(@ProcedureId, 0) AS '@extent'	--## OverAll Extent info - EE/ER- whoever has gone Furthest distance!!
		, (CASE WHEN Drug.entonox IS NULL THEN 'No' ELSE 'Yes' END) AS '@entonox'
		, CASE WHEN ISNULL((Select DrugNo from ERS_UpperGIPremedication where ProcedureId = @ProcedureID and DrugNo = -2), 0) = -2 THEN 'Yes' ELSE 'No' END AS '@generalAnaes'
		, convert(varchar, P.StartDateTime, 126) AS '@procedureStartTime'
		, convert(varchar, P.EndDateTime, 126) AS '@procedureEndTime'
		, Ins.NEDTerm AS '@insufflation' 
		, PS.NEDTerm AS '@providerSector'
		, RT.NEDTerm AS '@referrer'
		, CASE WHEN isnull(P.ReferrerTypeOther, '') = '' THEN NULL ELSE P.ReferrerTypeOther END AS '@referrerOther' -- ***************** Only if referrer is 'Other' *******************************
		, PO.NEDTerm AS '@providerOrganisation' 
		, CASE WHEN isnull(P.ProviderOther, '') = '' THEN NULL ELSE P.ProviderOther END AS '@providerOrganisationOther' -- **************** Only if providerOrganisation is 'Other' *************************
		, CASE WHEN P.ChecklistComplete = 0 THEN 'No' ELSE 'Yes' END AS '@checklist' 
		, CASE WHEN PatStat.ListItemText = 'Day patient' THEN 'Inpatient' ELSE PatStat.ListItemText END AS '@admissionType'
		, Urgency.Description AS '@urgencyType' 
		, Ext.NEDTerm AS '@plannedExtent'
		, ISNULL(AIS.NEDTerm, 'None')  AS '@artificialintelligence'
		, CASE WHEN AIS.NEDTerm = 'Other' THEN PAIS.AISoftwareOther ELSE NULL END AS '@artificialintelligenceOther' -- **************** Only if artificialintelligence is 'Other' *************************
		, CASE WHEN PAIS.AISoftwareName IS NULL OR AIS.NEDTerm = 'None' THEN NULL ELSE PAIS.AISoftwareName END AS '@nameOfAISoftware' -- **************** Only if artificialintelligence is NOT 'None' *************************
		, CASE WHEN CHARINDEX('.00',P.Points,0) > 0 THEN convert(varchar(10), convert(int, P.Points)) ELSE convert(varchar(10), P.Points) END AS '@procedurePoints'


		/*	##### Patient Info	*/		
		, (CASE Pat.Gender WHEN 'Not Known' THEN 'Other' WHEN 'Not Specif' THEN 'Other' ELSE Pat.Gender END)		AS 'patient/@gender'
		, (0+ FORMAT(getdate(),'yyyyMMdd') - FORMAT(Pat.DateOfBirth,'yyyyMMdd') ) /10000 AS 'patient/@age'


		/*	##### Drugs	*/
		, CASE WHEN CHARINDEX('.00',IsNull(Drug.pethidine,0),0) > 0 THEN convert(varchar(10), convert(int,IsNull(Drug.pethidine,0))) ELSE CONVERT(varchar(10),IsNull(Drug.pethidine,0)) END	As 'drugs/@pethidine'	--## Required
		, CASE WHEN CHARINDEX('.00',IsNull(Drug.midazolam,0),0) > 0 THEN convert(varchar(10), convert(int,IsNull(Drug.midazolam,0))) ELSE CONVERT(varchar(10),IsNull(Drug.midazolam,0)) END	As 'drugs/@midazolam'	--## Required
		, CASE WHEN CHARINDEX('.00',IsNull(Drug.fentanyl,0),0) > 0 THEN convert(varchar(10), convert(int,IsNull(Drug.fentanyl,0))) ELSE CONVERT(varchar(10),IsNull(Drug.fentanyl,0))	END As 'drugs/@fentanyl'	--## Required
		, CASE WHEN CHARINDEX('.00',IsNull(Drug.buscopan,0),0) > 0 THEN convert(varchar(10), convert(int,IsNull(Drug.buscopan,0))) ELSE CONVERT(varchar(10),IsNull(Drug.buscopan,0))	END As 'drugs/@buscopan'	--## Required
		, CASE WHEN CHARINDEX('.00',IsNull(Drug.remimazolam,0),0) > 0 THEN convert(varchar(10), convert(int,IsNull(Drug.remimazolam,0))) ELSE CONVERT(varchar(10),IsNull(Drug.remimazolam,0))	END As 'drugs/@remimazolam'	--## Required
		, CASE WHEN IsNull(Drug.propofol, 0) = 0 THEN 'No' ELSE	'Yes' END			As 'drugs/@propofol'	--## YesNo
		, ISNULL(Drug.noDrugsAdministered, 'Yes')	As 'drugs/@noDrugsAdministered'


		/*	##### Staff.Members: 1 Procedure to MANY staff.. So - need a SQL Subquery- to return a RecordSet		*/
		,(
			SELECT 
			  Staff.professionalBodyCode AS '@professionalBodyCode'
			, Staff.EndoscopistRole		AS '@endoscopistRole'
			, Staff.ProcedureRole		AS '@procedureRole'	-- ProcedureRoleTypeEnum
			, Staff.Extent				AS '@extent'
			, CASE Staff.[jManoeuvre] WHEN 1 THEN 'Yes' WHEN 0 THEN 'No' ELSE NULL END 	AS '@jManoeuvre'	-- Opt -- Mandatory for OGD, Colon and Flexi procedures (Rectal retroversion)
			/*	##### Therapeutic = Sesion->Procedure-> Staff.members-> Staff-> Therapeutic; 1 [Staff] to Many [Therapeutic sessions]	*/
			, (
				Select * from (select 
					   T.NedName	AS '@type'	-- M	--## The type of therapeutic procedure.
					 , CASE WHEN rc.RegionId IS NULL THEN T.[Site] ELSE 'Ileo-colon anastomosis' END		AS '@site'	-- O -- BiopsyEnum  --## The location where the therapeutic procedure was performed.
					 , ISNULL(T.EndoRole, Staff.ProcedureRole) AS '@role' -- O	-- ProcedureRoleTypeEnum
					 , T.polypSize	AS '@polypSize' -- O	-- PolypSizeEnum --## The size of polyp (if found) -> is ONLY for COLON/FLEXI
					 , T.PolypSizeInt AS '@polypSizeInteger'  
					 , T.Detected AS '@observed' 
					 , T.Tattooed	AS '@tattooed'	-- O	-- TattooEnum
					 , sum(T.Performed)	AS '@performed'	-- M	-- REQUIRED; INT	-- ## Number performed
					 , sum(T.Successful)	AS '@successful' -- M	-- REQUIRED; INT -- Number of successful
					 , sum(T.Retrieved)	AS '@retrieved'	-- O	-- INT	-- ## Number of Polyp retrieved -> is ONLY for COLON/FLEXI
					 , T.comment 	AS '@comment'	-- O	--## Use this field to define what Other is when selected.
					 , T.Morphology AS '@morphology' -- **************************** TO DO *********************************

				FROM dbo.tvfNED_ProcedureTherapeutic(P.ProcedureType, @ProcedureId, Staff.ConsultantTypeId) AS T --## Which Consultant's Record in the Procedure?
					LEFT JOIN dbo.ERS_Sites ES ON es.SiteId = T.SiteId
					LEFT JOIN tvfProcedureResectedColon(@ProcedureId) RC ON RC.RegionId = ES.RegionId
				group by T.SiteId,T.NedName, 
						CASE WHEN rc.RegionId IS NULL THEN T.[Site] ELSE 'Ileo-colon anastomosis' END,
						T.EndoRole,
						T.polypSize,
						T.PolypSizeInt,
						T.Detected,
						T.Tattooed, 
						T.comment,
						T.Morphology) as a
				FOR XML PATH('therapeutic'), ROOT('therapeutics'), TYPE
			)/* End of: Therapeutic List- for a Staff Member		*/
			FROM dbo.tvfNED_ProcedureConsultants(@ProcedureId, P.ProcedureType) AS Staff
			WHERE Staff.EndosId > 0
			FOR XML PATH('Staff'), ROOT('staff.members'), TYPE
		)
			/*	##### Indications: -- 1 or Many	*/		
			, (
				SELECT 
					  dbo.HTMLDecode(I.NedTerm) As '@indication'
					, I.Comment AS '@comment'
					, I.elevatedCalprotectinValue AS '@elevatedCalprotectinValue' -- When indication is Elevated calprotectin then specify the value in (micrograms/gram)
					FROM dbo.tvfNED_ProcedureIndication(@ProcedureId) AS I
					FOR XML PATH('indication'), ROOT('indications'), TYPE
			)
			/*	##### subIndications: -- 0 or Many	*/	
			, (
				SELECT 
					  I.NedTerm As '@type'
					, I.Comment AS '@comment'
					FROM dbo.tvfNED_ProcedureSubIndication(@ProcedureId) AS I
					FOR XML PATH('subIndication'), ROOT('subIndications'), TYPE
			)
			
			/*	##### Limitations: */
			,(
				Select 	
					  L.Limitation As '@limitation'
					, L.Comment As '@comment'
				from [dbo].[tvfNED_ProcedureLimitation](P.ProcedureType, @ProcedureId) AS L
					FOR XML PATH('limitation'), ROOT('limitations'), TYPE
			)	

			/*	##### Biopsy: 0 or Many		*/ --## For Colon/Flexi/OGD
			, (	SELECT 
						  B.BiopsySite		AS '@biopsySite'
						, B.NumberPerformed AS '@numberPerformed'
					FROM [dbo].[tvfNED_ProcedureBiopsy](p.ProcedureType, @ProcedureId) AS B				
					 FOR XML PATH('biopsy'), ROOT('biopsies'), TYPE
			)
			/*	##### Diagnoses: 1 or Many		*/ 
			, (	SELECT 
						  D.Ned_Name	AS '@diagnosis'
						, D.tattooed	AS '@tattooed'
						, CASE WHEN RIGHT(D.Site,2) = ', '
							THEN (LEFT(D.Site, LEN(D.Site)-1))
							ELSE  D.Site END		AS '@site'
						, CASE WHEN RIGHT(D.Comment,2)=', ' 
							THEN (LEFT(D.Comment, LEN(D.Comment)-1)) 
							ELSE D.Comment END
									AS '@comment'	--## Remove the extra ',' at the end!
						,D.barrettsLengthCircumferential as '@barrettsLengthCircumferential' --Required for diagnosis of Barretts
						,D.barrettsLengthMaximum AS '@barrettsLengthMaximum'--, barrettsLengthMaximum --Required for diagnosis of Barretts
						,D.barretsInspectionTime AS '@barretsInspectionTime'--, barretsInspectionTime --Required for diagnosis of Barretts
						,D.gastricInspectiontime AS '@gastricInspectionTime'--, gastricInspectiontime --Required if diagnosis of gastric atrophy OR gastric intestinal metaplasia
						,D.oesophagitisLaClassification AS '@oesophagitisLAClassification'--, oesophagitisLaClassification --Required if diagnosis of Oesophagitis - reflux
						,D.DICAScore AS '@DICAScore'--, DICAScore --required if diagnosis of Diverticulosis
						,D.UCEIS AS '@UCEIS'--, UCEIS --If diagnosis is Ulcerative Colitis either UCEIS or Mayo scores must be provided
						,D.mayoScore AS '@mayoScore'--, mayoScore --If diagnosis is Ulcerative Colitis either UCEIS or Mayo scores must be provided
						--, site --If diagnosis is Crohns Colitis or Crohn`s- terminal ileum and [ExtentLookup]= Neo-terminal ileum
						,NULLIF(RutgeertsScore,'') AS '@rutgeertsScore' --If diagnosis is Crohns Colitis or Crohn`s- terminal ileum and [ExtentLookup]= Neo-terminal ileum
						, CDEIS AS '@CDEIS' --If diagnosis is Crohns Colitis or Crohn`s- terminal ileum
					FROM [dbo].[tvfNED_Diagnoses](p.ProcedureType, @ProcedureId) AS D
					 FOR XML PATH('diagnose'), ROOT('diagnoses'), TYPE
			)
			/*	##### Adverse events: -- 1 or Many	*/
			,(	SELECT 
					  IsNull(AD.adverseEvent,'None')	As '@adverseEvent'
					, (CASE WHEN AD.adverseEvent = 'Other' THEN AD.Comment END) 						As '@comment'
				FROM dbo.tvfNED_ProcedureAdverseEvents(@ProcedureId)		AS AD
				FOR XML PATH('adverse.event'), ROOT('adverse.events'), TYPE			
			)
			, ( Select * from (Select isnull(scog.NEDTerm, 'other') as '@manufacturerGeneration'
						, CASE WHEN scog.NEDTerm IS NULL THEN scog.Description ELSE NULL END as '@other'
				from ERS_Scopes sco
				join ERS_Procedures p on p.Instrument1 = sco.ScopeId
				join ERS_ScopeGenerations scog on sco.ScopeGenerationId = scog.UniqueId
				where p.ProcedureId = @ProcedureId
				union
				Select isnull(scog.NEDTerm, 'other') as '@manufacturerGeneration'
						, CASE WHEN scog.NEDTerm IS NULL THEN scog.Description ELSE NULL END as '@other'
				from ERS_Scopes sco
				join ERS_Procedures p on p.Instrument2 = sco.ScopeId
				join ERS_ScopeGenerations scog on sco.ScopeGenerationId = scog.UniqueId
				where p.ProcedureId = @ProcedureId) as a
				FOR XML PATH('scopes'), ROOT('scopes'), TYPE
			   )
			 , (
				SELECT ISNULL(C.NEDTerm, 'other') as '@type', 
				(CASE WHEN C.NEDTerm = 'Other' THEN PC.AdditionalInfo END) 						As '@comment'

				 FROM ERS_Chromendoscopies C 
				 join ERS_ProcedureChromendosopy PC on C.UniqueId = PC.ChromendoscopyId
				 WHERE PC.ProcedureId = @ProcedureId 
				 FOR XML PATH('chromendoscopy'), ROOT('chromendoscopies'), TYPE
				) 
				 ,( 
					SELECT CASE 
						WHEN @ProcedureTypeId = 1 THEN
							(SELECT DISTINCT * FROM (SELECT 
								CASE WHEN (SELECT COUNT(*) FROM ERS_UpperGIPremedication WHERE DrugName = 'Pharyngeal Anaesthesia' AND ProcedureId = @ProcedureId) = 1 THEN 'Yes' ELSE 'No' END as '@pharyngealAnaes'
								,pe.WithdrawalMins as '@scopeWithdrawalTime'
								,ISNULL(DA.NEDTerm,'None') as '@distalAttachment'
								,CASE WHEN LOWER(DA.NEDTerm) = 'other' THEN PD.AdditionalInfo ELSE NULL END as '@distalAttachmentOther'
								,CASE WHEN p.Transnasal = 1 THEN 'Nasal' ELSE 'Oral' END as '@OGDRoute'
								,V.NEDTerm as '@OGDMucosalVisualisation'
								,CASE WHEN (SELECT COUNT(*) FROM ERS_ProcedureMucosalCleaning WHERE ProcedureId = @ProcedureId) > 1 THEN 'Other' ELSE ISNULL(C.NEDTerm, 'None') END as '@OGDMucosalCleaning'
								,CASE WHEN (SELECT COUNT(*) FROM ERS_ProcedureMucosalCleaning WHERE ProcedureId = @ProcedureId) > 1 THEN dbo.fnNED_MucosalCleaning(@ProcedureId) WHEN LOWER(C.NEDTerm) = 'other' THEN C.Description ELSE NULL END as '@OGDMucosalCleaningOther'
								,CASE WHEN P.FormerProcedureId IS NOT NULL THEN 'Yes' WHEN (SELECT COUNT(*) FROM ERS_Procedures pq WHERE pq.FormerProcedureId = p.ProcedureId) > 0 THEN 'Yes' ELSE 'No' END as '@dualProcedure'
								,CASE WHEN dbo.fnNED_GetOGDPhotoDocumentation(@ProcedureId) = 1 THEN 'Yes' ELSE 'No' END '@photoDocumentation'
								from ERS_Procedures AS P 
									LEFT JOIN ERS_ProcedureMucosalVisualisation PV ON PV.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_MucosalVisualisation V ON V.UniqueId = PV.MucosalVisualisationId
									LEFT JOIN ERS_ProcedureUpperExtent PE ON PE.ProcedureId = P.ProcedureId AND PE.WithdrawalMins IS NOT NULL /*there may be more than 1 record in the table where there's 2 endos on a procedure*/
									LEFT JOIN ERS_ProcedureDistalAttachment PD ON PD.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_DistalAttachments DA ON DA.UniqueId = PD.DistalAttachmentId
									LEFT JOIN ERS_ProcedureMucosalCleaning PC ON PC.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_MucosalCleaning C ON C.UniqueId = PC.MucosalCleaningId
								Where P.ProcedureId=@ProcedureId) ogd
							FOR XML PATH('OGD'),TYPE)
						WHEN @ProcedureTypeId = 2 THEN
							(SELECT * FROM (SELECT DISTINCT 
								CASE WHEN (SELECT COUNT(*) FROM ERS_UpperGIPremedication WHERE DrugName = 'Pharyngeal Anaesthesia' AND ProcedureId = @ProcedureId) = 1 THEN 'Yes' ELSE 'No' END as '@pharyngealAnaes'
								,CASE WHEN (SELECT COUNT(*) FROM ERS_UpperGIPremedication WHERE DrugName = 'Prophylactic Antibiotics' AND ProcedureId = @ProcedureId) = 1 THEN 'Yes' ELSE 'No' END as '@antibioticGiven'
								,NULLIF(CASE WHEN ((ev.IntendedBileDuct = 1 AND ev.MajorPapillaBile = 1) OR (ev.IntendedBileDuct_ER = 1 AND ev.MajorPapillaBile_ER = 1)) OR
												  ((ev.IntendedPancreaticDuct = 1 AND ev.MajorPapillaPancreatic = 1) OR (ev.IntendedPancreaticDuct_ER = 1 AND ev.MajorPapillaPancreatic_ER = 1)) THEN 'Yes' 
											 WHEN ((ev.IntendedBileDuct = 1 AND ev.MajorPapillaBile <> 1) OR (ev.IntendedBileDuct_ER = 1 AND ev.MajorPapillaBile_ER <> 1)) OR
												  ((ev.IntendedPancreaticDuct = 1 AND ev.MajorPapillaPancreatic <> 1) OR (ev.IntendedPancreaticDuct_ER = 1 AND ev.MajorPapillaPancreatic_ER <> 1)) THEN 'No'
											ELSE 'Not Applicable' END,'') as '@successfulCannulation'
								,ISNULL((SELECT MAX(ISNULL(convert(int, d.StonesSize),0)) FROM ERS_ERCPAbnoDuct d INNER JOIN ERS_Sites s ON S.SiteId = d.SiteId WHERE S.ProcedureId = @ProcedureId),0) AS '@sizeLargestStone'
								--,ISNULL(CASE WHEN ExtractionOutcome = 1 THEN CONVERT(varchar(max),'Yes') 
								--       WHEN ExtractionOutcome <> 0 THEN CONVERT(varchar(max),'No') END,'Not Applicable') AS '@completeStoneClearance'
								,ISNULL((SELECT TOP 1 CASE WHEN ISNULL(ExtractionOutcome,0) = 1 THEN convert(varchar(max),'Yes') 
											  WHEN StoneRemoval = 0 or ExtractionOutcome <> 1 THEN 'No' END 
								 FROM dbo.ERS_ERCPTherapeutics ET WHERE SiteId IN (SELECT SiteId FROM ERS_Sites WHERE ProcedureId = @ProcedureId)),'Not Applicable') as '@completeStoneClearance'
								,ISNULL((SELECT CASE WHEN LOWER(Region) LIKE '%hepatic%' THEN convert(varchar(max), 'Yes') ELSE convert(varchar(max), 'No') END
											FROM ERS_ERCPAbnoDuct eed 
											INNER JOIN dbo.ERS_Sites es ON eed.SiteId = es.SiteId
												INNER JOIN dbo.ERS_Regions er ON es.RegionId = er.RegionId
											WHERE es.ProcedureId = @ProcedureId AND Stricture = 1),convert(varchar(max), 'Not Applicable')) AS '@extraHepaticStricture'
								,ISNULL((SELECT CASE WHEN eed.Stricture = 1 AND eug.BrushCytology = 1 THEN convert(varchar(max),'Yes') WHEN eed.Stricture = 1 AND eug.BrushCytology = 0 THEN convert(varchar(max),'No') WHEN eed.Stricture = 0 THEN 'Not Applicable' END 
										 FROM ERS_ERCPAbnoDuct eed 
												INNER JOIN dbo.ERS_Sites es ON eed.SiteId = es.SiteId
												INNER JOIN dbo.ERS_Regions er ON es.RegionId = er.RegionId
												INNER JOIN dbo.ERS_UpperGISpecimens eug ON es.SiteId = eug.SiteId
											WHERE es.ProcedureId = @ProcedureId AND
												LOWER(Region) LIKE '%hepatic%'),convert(varchar(max),'Not Applicable')) AS '@extrahepaticStrictureCytologyHistologyTaken'
								,ISNULL((SELECT CASE WHEN eug.CorrectStentPlacement = 1 OR ert.CorrectStentPlacement = 1 THEN convert(varchar(max),'Yes') ELSE convert(varchar(max),'No') END
											FROM ERS_ERCPAbnoDuct eed 
												INNER JOIN dbo.ERS_Sites es ON eed.SiteId = es.SiteId
												INNER JOIN dbo.ERS_Regions er ON es.RegionId = er.RegionId
												LEFT JOIN dbo.ERS_UpperGITherapeutics eug ON es.SiteId = eug.SiteId
												LEFT JOIN dbo.ERS_ERCPTherapeutics ert ON es.SiteId = ert.SiteId
											WHERE es.ProcedureId = @ProcedureId AND eed.Stricture = 1 AND eug.StentInsertion = 1 AND
												LOWER(Region) LIKE '%hepatic%'),convert(varchar(max),'Not Applicable')) AS '@extrahepaticStrictureStentSuccessfullyPlaced'
								,CASE WHEN ISNULL(eea.MajorBilrothRoux,0) = 1 THEN 'Yes' ELSE 'No' END AS '@previousSurgeryBilrothRoux'
								,NULLIF(lc.NEDTerm,0) AS '@levelOfComplexity'
								,CASE WHEN (SELECT COUNT(*) FROM ERS_UpperGIPremedication WHERE DrugName = 'Prophylactic Rectal NSAIDS' AND ProcedureId = @ProcedureId) = 1 THEN 'Yes' ELSE 'No' END as '@prophylacticRectalNSAIDS'
								,CASE WHEN eea.MinorSiteLocation IN (1,2) THEN 'No' ELSE 'Yes' END AS '@nativePapilla'
								from ERS_Procedures AS P 
									LEFT JOIN (SELECT eed.AbnoDuctId, es.ProcedureId, eed.Stricture, er.Region 
												FROM ERS_ERCPAbnoDuct eed 
													INNER JOIN dbo.ERS_Sites es ON eed.SiteId = es.SiteId
													INNER JOIN dbo.ERS_Regions er ON es.RegionId = er.RegionId
											WHERE es.ProcedureId = @ProcedureId AND
												LOWER(Region) LIKE '%hepatic%')  ercs ON ercs.ProcedureId = P.ProcedureId
									LEFT JOIN (SELECT Stones, ISNULL(t.ExtractionOutcome,0) ExtractionOutcome, es.ProcedureId 
												FROM ERS_ERCPAbnoDuct a
													 INNER JOIN dbo.ERS_Sites es ON a.SiteId = es.SiteId
													 LEFT JOIN ERS_ERCPTherapeutics t ON t.siteId = a.SiteId
												 WHERE a.Stones = 1) estones ON estones.ProcedureId = P.ProcedureId
									LEFT JOIN dbo.ERS_ERCPPapillaryAnatomy eea ON P.ProcedureId = eea.ProcedureId
									LEFT JOIN dbo.ERS_Visualisation ev ON P.ProcedureId = ev.ProcedureID
									LEFT JOIN dbo.ERS_ProcedureLevelOfComplexity cl ON cl.ProcedureId = P.ProcedureId
									LEFT JOIN dbo.ERS_LevelOfComplexity lc ON lc.UniqueId = cl.ComplexityId
								Where P.ProcedureId=@ProcedureId) ercp
							FOR XML PATH('ERCP'),TYPE) 
						WHEN @ProcedureTypeId = 3 THEN
							(SELECT TOP 1 * FROM (SELECT 
								(SELECT ISNULL(SUM(Detected),0) FROM tvfNED_PolypsDetailsView(@ProcedureTypeId, @ProcedureId)) as '@polypsDetected'
								,CASE WHEN p.ScopeGuide = 1 THEN 'Yes' ELSE 'No' END AS '@magneticEndoscopeImagerUsed'
								,LE.WithdrawalMins AS '@scopeWithdrawalTime'
								,CASE WHEN LE.RectalExamPerformed = 1 THEN 'Yes' ELSE 'No' END AS '@digitalRectalExamination'
								,CONVERT(VARCHAR(19),LE.CaecumIntubationStart, 126) AS '@caecumTime'
								,ISNULL(DA.NEDTerm,'None') as '@distalAttachment'
								,NULLIF(CASE WHEN LOWER(DA.NEDTerm) = 'other' THEN PD.AdditionalInfo ELSE '' END,'') as '@distalAttachmentOther'
								,IT.NEDTerm as '@insertionTechnique'
								,PB.LeftPrepScore as '@bowelPrepLeft'
								,PB.RightPrepScore as '@bowelPrepRight'
								,PB.TransversePrepScore as '@bowelPrepTransverse'
								,PB.TotalPrepScore as '@bowelPrepTotal'
								,ISNULL(B.NEDTerm,'None') as '@bowelPrep'
								,NULLIF(CASE WHEN LOWER(B.NEDTerm) = 'other' THEN B.[Description] ELSE '' END,'') as '@bowelPrepOther'
								,CASE WHEN P.FormerProcedureId IS NOT NULL THEN 'Yes' WHEN (SELECT COUNT(*) FROM ERS_Procedures pq WHERE pq.FormerProcedureId = p.ProcedureId) > 0 THEN 'Yes' ELSE 'No' END as '@dualProcedure'
								,CASE WHEN fit.FITValue IS NOT NULL THEN fit.FITValue END AS '@fitValue'
								,CASE WHEN fit.FITNotKnownId IS NOT NULL THEN fnk.NEDTerm END AS '@fitNotKnown'
								FROM ERS_Procedures AS P 
									LEFT JOIN ERS_ProcedureLowerExtent LE ON LE.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_ProcedureDistalAttachment PD ON PD.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_DistalAttachments DA ON DA.UniqueId = PD.DistalAttachmentId
									LEFT JOIN ERS_ProcedureInsertionTechnique PIT ON PIT.ProcedureId = p.ProcedureId
									LEFT JOIN ERS_InsertionTechniques IT ON IT.UniqueId = PIT.InsertionTechniqueId
									LEFT JOIN ERS_ProcedureBowelPrep PB ON PB.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_BowelPrep B ON B.UniqueId = PB.BowelPrepId
									LEFT JOIN ERS_ProcedureFITValue fit ON fit.ProcedureId = p.ProcedureId
									LEFT JOIN ERS_FitNotKnownReasons fnk ON fnk.UniqueId = fit.FITNotKnownId
								Where P.ProcedureId=@ProcedureId) col
							FOR XML PATH('Colon'),TYPE)
						WHEN @ProcedureTypeId = 4 THEN
							(SELECT * FROM (SELECT 
								(SELECT ISNULL(SUM(Detected),0) FROM tvfNED_PolypsDetailsView(@ProcedureTypeId, @ProcedureId)) as '@polypsDetected'
								,CASE WHEN LE.RectalExamPerformed = 1 THEN 'Yes' ELSE 'No' END AS '@digitalRectalExamination'
								,CASE WHEN p.ScopeGuide = 1 THEN 'Yes' ELSE 'No' END AS '@magneticEndoscopeImagerUsed'
								,ISNULL(DA.NEDTerm,'None') as '@distalAttachment'
								,CASE WHEN LOWER(DA.NEDTerm) = 'other' THEN PD.AdditionalInfo ELSE NULL END as '@distalAttachmentOther'
								,IT.NEDTerm as '@insertionTechnique'
								,PB.LeftPrepScore as '@bowelPrepLeft'
								,PB.TransversePrepScore as '@bowelPrepTransverse'
								,PB.RightPrepScore as '@bowelPrepRight'
								,PB.TotalPrepScore as '@bowelPrepTotal'
								,ISNULL(B.NEDTerm,'None') as '@bowelPrep'
								,CASE WHEN LOWER(B.NEDTerm) = 'other' THEN B.[Description] ELSE NULL END as '@bowelPrepOther'
								,CASE WHEN fit.FITValue IS NOT NULL THEN fit.FITValue END AS '@fitValue'
								,CASE WHEN fit.FITNotKnownId IS NOT NULL THEN fnk.NEDTerm END AS '@fitNotKnown'
								FROM ERS_Procedures AS P 
									LEFT JOIN (Select ProcedureId, Max(CONVERT(int,RectalExamPerformed)) as RectalExamPerformed from ERS_ProcedureLowerExtent group by ProcedureId) LE ON LE.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_ProcedureDistalAttachment PD ON PD.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_DistalAttachments DA ON DA.UniqueId = PD.DistalAttachmentId
									LEFT JOIN ERS_ProcedureInsertionTechnique PIT ON PIT.ProcedureId = p.ProcedureId
									LEFT JOIN ERS_InsertionTechniques IT ON IT.UniqueId = PIT.InsertionTechniqueId
									LEFT JOIN ERS_ProcedureBowelPrep PB ON PB.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_BowelPrep B ON B.UniqueId = PB.BowelPrepId
									LEFT JOIN ERS_ProcedureFITValue fit ON fit.ProcedureId = p.ProcedureId
									LEFT JOIN ERS_FitNotKnownReasons fnk ON fnk.UniqueId = fit.FITNotKnownId
								Where P.ProcedureId=@ProcedureId) flexi
							FOR XML PATH('Flexi'),TYPE)  
						WHEN @ProcedureTypeId IN (6,7) THEN
							(SELECT * FROM (SELECT DISTINCT CASE WHEN pm.DrugName = '' THEN 'Yes' ELSE 'No' END AS '@prophylacticAntibioticsBeforeEUS',
												ISNULL(dbo.fnNED_FNAFNBSolidLesions(@ProcedureId, P.ProcedureType),'Not applicable') AS '@FNAorFNBSolidLesions',
												ISNULL(dbo.fnNED_FNAFNBTissueAdequacy(@ProcedureId),'Not Applicable') AS '@FNAorFNBTissueAdequacy'
											FROM ERS_UpperGIPremedication pm
												LEFT JOIN ERS_Sites s ON s.ProcedureId = pm.ProcedureId
												LEFT JOIN ERS_UpperGITherapeutics T ON S.SiteId = T.SiteId
												LEFT JOIN ERS_UpperGISpecimens AS SP  ON SP.SiteId = S.SiteId
												LEFT JOIN ERS_ERCPTherapeutics ET ON ET.SiteId = S.SiteId
											WHERE pm.ProcedureId = @ProcedureId) eushpb
								FOR XML PATH('EUS'),TYPE)  
						WHEN @ProcedureTypeId IN (8,9) THEN
							 (SELECT * FROM (SELECT DISTINCT 
								 (SELECT ISNULL(SUM(Detected),0) FROM tvfNED_PolypsTotalsView(@ProcedureId)) AS '@polypsDetected'
								 ,ISNULL(DA.NEDTerm,'None') as '@distalAttachment'
								 ,CASE WHEN LOWER(DA.NEDTerm) = 'other' THEN PDA.AdditionalInfo ELSE NULL END as '@distalAttachmentOther'
								 ,ISNULL(ET.NEDTerm,'None') as '@enteroscopyTechnique'
								 ,CASE WHEN LOWER(ET.NEDTerm) = 'other' THEN PET.AdditionalInfo ELSE NULL END as '@enteroscopyTechniqueOther'
								 ,PID.InsertionLength AS '@depthOfInsertion'
								 ,CASE PID.Tattooed WHEN 1 THEN 'Yes' WHEN 0 THEN 'No' ELSE 'Not Applicable' END AS '@tattooMaxDepthInsertion'
								 ,CASE WHEN PE.RectalExamPerformed = 1 AND ET.NEDTerm IN ('Single balloon anal','Double balloon anal') THEN 'Yes' ELSE 'No' END AS '@digitalRectalExamination'
									FROM ERS_Procedures AS P 
										LEFT JOIN ERS_ProcedureDistalAttachment PDA ON PDA.ProcedureId = P.ProcedureId
										LEFT JOIN ERS_DistalAttachments DA ON DA.UniqueId = PDA.DistalAttachmentId
										LEFT JOIN ERS_ProcedureEnteroscopyTechniques PET ON PET.ProcedureId = P.ProcedureId
										LEFT JOIN ERS_EnteroscopyTechniques ET ON ET.UniqueId = PET.TechniqueId
										LEFT JOIN ERS_ProcedureInsertionDepth PID ON PID.ProcedureId = P.ProcedureId
										LEFT JOIN ERS_ProcedureLowerExtent PE ON PE.ProcedureId = P.ProcedureId
									Where P.ProcedureId=@ProcedureId) ent
								FOR XML PATH('ENT'),TYPE)
					END
				  )
		from ERS_Procedures AS P 
		Where P.ProcedureId=@ProcedureId
		FOR XML PATH('procedure'), ROOT('procedures'), TYPE
		)	

    FROM dbo.ERS_Procedures AS P
    LEFT join dbo.ERS_ProcedureDiscomfortScore as DisNo on P.ProcedureId = DisNo.ProcedureId
    LEFT Join dbo.ERS_DiscomfortScores as Dis on DisNo.DiscomfortScoreId = Dis.UniqueId
	LEFT join dbo.ERS_PostProcedureDiscomfortScore PPD on PPD.ProcedureId = P.ProcedureId 
	LEFT join dbo.ERS_DiscomfortScores as PPDD on PPD.DiscomfortScoreId = PPDD.UniqueId
	Left join dbo.ers_lists as PatStat on PatStat.ListDescription = 'Patient Status' and PatStat.ListItemNo = P.PatientStatus 
	Left Join dbo.ERS_UrgencyTypes as Urgency on P.CategoryListId = Urgency.UniqueId
	Left join dbo.ERS_ProcedurePlannedExtent as PPE on P.ProcedureId = PPE.ProcedureId 
	Left Join dbo.ERS_Extent as Ext on PPE.ExtentId = Ext.UniqueId 
	Left join dbo.ERS_ProcedureInsufflation as PIns on P.ProcedureId = PIns.ProcedureId
	Left Join dbo.ERS_Insufflation as Ins on PIns.InsufflationId = Ins.UniqueId 
	Left Join dbo.ERS_ProviderSectors as PS on P.PatientType = PS.UniqueId 
	Left Join dbo.ERS_ReferrerTypes as RT on P.ReferrerType = RT.UniqueId 
	Left join dbo.ERS_ProviderOrganisation as PO on P.ProviderTypeId = PO.UniqueId 
	Left Join dbo.ERS_ProcedureAISoftware as PAIS on P.ProcedureId = PAIS.ProcedureId 
	Left Join dbo.ERS_AISoftware as AIS on PAIS.AISoftwareId = AIS.UniqueId 
	Left Join dbo.ERS_ProcedureChromendosopy as PCHR on PCHR.ProcedureId = p.ProcedureId


  INNER JOIN dbo.ERS_VW_Patients			AS Pat  ON P.PatientId=Pat.[PatientId]
   LEFT JOIN dbo.tvfNED_ProcedureDrugList(@ProcedureId)	AS Drug		ON P.ProcedureId = Drug.ProcedureId	
   --LEFT JOIN dbo.ERS_UpperGIQA				AS QA   ON P.ProcedureId = QA.ProcedureId	-- Patient DIscomfort
   LEFT JOIN dbo.ERS_BowelPreparation		AS BP   ON P.ProcedureId=BP.ProcedureID	-- DIscomfort for Nurse
   LEFT JOIN dbo.ERS_ColonExtentOfIntubation   EL	ON P.ProcedureId = EL.ProcedureId
	   where P.ProcedureId= @ProcedureId
		 for XML PATH ('session'), ROOT('hospital.SendBatchMessage'), ELEMENTS
);

DECLARE   @xmlFileName AS varchar(100)
		, @ReportDate AS VARCHAR(10)
		, @ReportTime AS VARCHAR(8)
		, @xmlPreviousExportFileName AS VARCHAR(100);

SELECT    @ReportDate = CONVERT(VARCHAR(10), CreatedOn, 103)
		, @ReportTime = CONVERT(VARCHAR(8), ModifiedOn, 108) 
FROM dbo.ERS_Procedures WHERE ProcedureId=@ProcedureId;

--== Check whether Admin has added/removed the '\' at the end of the Path.. 
SET @ExportFolderPath = (CASE WHEN RIGHT(@ExportFolderPath, 1)='\' THEN @ExportFolderPath ELSE (@ExportFolderPath + '\') END);

SELECT top 1 @xmlPreviousExportFileName = xmlFileName FROM [dbo].[ERS_NedFilesLog] WHERE ProcedureId=@ProcedureId ORDER BY [LogId] desc;

--### File Path and Name example: 'NED_xml_output\74_22-09-2017_09-32-53_00831101o.xml' vs '99_19-10-2017_16-24-16_00205602e.xml'
SET @xmlFileName =    @ExportFolderPath 
					+ @site + '_' 
					+ replace(@ReportDate, '/', '-') + '_' 
					+ replace(@ReportTime, ':', '-') + '_' 
					+ @uniqueid	
					+ '.xml';					

SELECT @returnXML AS returnXML
				 , '<hospital.SendBatchMessage xmlns:xsd="http://www.w3.org/2001/XMLSchema"'
				  + 
				 ' xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"'
				  +
				 ' xmlns="https://www.jets.nhs.uk/schema/hospital.sendbatchmessage-version2.xsd"'
				  +
				 ' softwareVersion="2"' AS NS_Info		--## These extra info will be added to the Actual XML file in .NET while exporting;
				 , @xmlFileName AS xmlFileName
				 , IsNull(@xmlPreviousExportFileName, 'x') AS PreviousFileName;

END
GO
PRINT N'Altering Trigger [dbo].[TR_CommonAbnoLesions]...';


GO

ALTER TRIGGER [dbo].[TR_CommonAbnoLesions]
ON [dbo].[ERS_CommonAbnoLesions]
AFTER INSERT, UPDATE, DELETE
AS 
	DECLARE @site_id INT, @Polyp VARCHAR(10) = 'False', 
						  @BenignTumour VARCHAR(10) = 'False', 
						  @MalignantTumour VARCHAR(10) = 'False', 
						  @SubmucosalTumour VARCHAR(10) = 'False', 
						  @FocalLesions VARCHAR(10) = 'False',
						  @SubmucoaslLesion VARCHAR(10) = 'False',
						  @FundicGlandPolyp VARCHAR(10) = 'False',
						  @PreviousESDScar VARCHAR(10) = 'False',
			@PolypTypeId int, @Region varchar(20), @ProcedureTypeId int, @MatrixCode varchar(50)
	
	IF EXISTS(SELECT * FROM INSERTED)
	BEGIN
		SELECT @site_id=SiteId,
				@Polyp = (CASE WHEN (ISNULL(Polyp,0) = 1) THEN 'True' ELSE 'False' END),
				@FocalLesions = (CASE WHEN (ISNULL(Focal,0) = 1) THEN 'True' ELSE 'False' END),
				@SubmucoaslLesion = (CASE WHEN (ISNULL(Submucosal,0) = 1) THEN 'True' ELSE 'False' END),
				@FundicGlandPolyp = (CASE WHEN (ISNULL(FundicGlandPolyp,0) = 1) THEN 'True' ELSE 'False' END),
				@PolypTypeId = PolypTypeId,
				@PreviousESDScar = (CASE WHEN (ISNULL(PreviousESDScar,0) = 1) THEN 'True' ELSE 'False' END)
				
		FROM INSERTED

		SELECT TOP 1 @ProcedureTypeId =  p.ProcedureType FROM ERS_Sites s INNER JOIN ERS_Procedures p ON p.ProcedureId = s.ProcedureId WHERE s.SiteId = @site_id
		--check if polyps = 1
		IF @Polyp = 'True' 
		BEGIN
			--check for polyp type
			DECLARE @PolypType VARCHAR(200) = (SELECT Description FROM ERS_PolypTypes WHERE UniqueId = @PolypTypeId)

			IF LOWER(@PolypType) = 'sessile'
			BEGIN
				--sessile polyps to produce a gastric tumour outcome depending on the tumour type
				IF EXISTS (SELECT 1 FROM ERS_CommonAbnoPolypDetails WHERE SiteId = @site_id AND Type = (SELECT UniqueId FROM ERS_TumourTypes WHERE Description = 'benign'))
					SET @BenignTumour = 'True'
				ELSE 
					SET @BenignTumour = 'False'

				IF EXISTS (SELECT 1 FROM ERS_CommonAbnoPolypDetails WHERE SiteId = @site_id AND Type = (SELECT UniqueId FROM ERS_TumourTypes WHERE Description = 'malignant'))
					SET @MalignantTumour = 'True'
				ELSE
					SET @MalignantTumour = 'False'
			END
			
			IF LOWER(@PolypType) = 'submucosal'  AND LOWER(@Region) = 'stomach'
				SET @SubmucoaslLesion = 'True'
			ELSE
				SET @SubmucoaslLesion = 'False'

		END
		
		IF @ProcedureTypeId IN (1,6,8)
		BEGIN
			SELECT @Region = dbo.fnSiteRegion(@site_id)

			IF LOWER(@Region) = 'stomach'
			BEGIN
				--SELECT @Polyp = CASE WHEN @FundicGlandPolyp = 'False' AND @BenignTumour = 'False' AND @MalignantTumour = 'False' AND @SubmucosalTumour = 'False' THEN 'True' ELSE 'False' END
				SET @MatrixCode = 'D40P1'
			END
			ELSE IF LOWER(@Region) = 'oesophagus'
				SET @MatrixCode = 'N2013'
			ELSE IF LOWER(@Region) = 'duodenum'
				SET @MatrixCode = 'D58P1'
			ELSE IF LOWER(@Region) = 'colon'
				SET @MatrixCode = 'D58P1'
				
		END
		ELSE IF @ProcedureTypeId IN (3,4,9)
		BEGIN
			SELECT @Region = dbo.fnSiteRegion(@site_id)

			IF @Polyp = 'True' AND @Region IN ('Rectum', 'Anal Margin')
				SET @MatrixCode = 'D4P3'

			IF @Polyp = 'True' AND @Region NOT IN ('Rectum', 'Anal Margin', 'Terminal Ileum')
				SET @MatrixCode = 'D12P3'

			IF @Polyp = 'True' AND @Region IN ('Terminal Ileum', 'Neo-Terminal Ileum')
				SET @MatrixCode = 'DIPOLYPP3'
		END

	END
	ELSE
	BEGIN
		SELECT @site_id=SiteId FROM DELETED
	END

	EXEC abnormalities_common_lesions_summary_update @site_id

	IF @site_id IS NOT NULL AND @ProcedureTypeId IN (1,3,4,6,8,9)
	BEGIN
		EXEC sites_summary_update @site_id

		EXEC diagnoses_control_save @site_id, @MatrixCode, @Polyp		
		--EXEC diagnoses_control_save @site_id, 'D86P1', @BenignTumour	
		--EXEC diagnoses_control_save @site_id, 'D87P1', @MalignantTumour	
		EXEC diagnoses_control_save @site_id, 'N2001', @FocalLesions
		EXEC diagnoses_control_save @site_id, 'D88P1', @SubmucosalTumour
		EXEC diagnoses_control_save @site_id, 'N2002', @SubmucoaslLesion
		EXEC diagnoses_control_save @site_id, 'N2019', @FundicGlandPolyp

		IF LOWER(@Region) = 'stomach'
		BEGIN
			EXEC diagnoses_control_save @site_id, 'DSESDSCARP1', @PreviousESDScar		
		END
		ELSE IF LOWER(@Region) = 'oesophagus'
		BEGIN
			EXEC diagnoses_control_save @site_id, 'DOESDSCARP1', @PreviousESDScar
		END
		ELSE IF LOWER(@Region) = 'duodenum'
		BEGIN
			EXEC diagnoses_control_save @site_id, 'DDESDSCARP1', @PreviousESDScar
		END
		ELSE IF LOWER(@Region) = 'colon'
		BEGIN
			EXEC diagnoses_control_save @site_id, 'DESDSCARP3', @PreviousESDScar
		END
	END
GO
PRINT N'Altering Trigger [dbo].[TR_UpperGIAbnoMiscellaneous_Insert]...';


GO

ALTER TRIGGER [dbo].[TR_UpperGIAbnoMiscellaneous_Insert]
ON [dbo].[ERS_UpperGIAbnoMiscellaneous]
AFTER INSERT, UPDATE 
AS 
	DECLARE @site_id INT, @Diverticulum VARCHAR(10), @Foreignbody VARCHAR(10), @MaloryWeissTear VARCHAR(10), 
			@MotilityDisorder VARCHAR(10), @Stricture VARCHAR(10), @StrictureBenign VARCHAR(10), @StrictureMalignant VARCHAR(10), 
			@Tumour VARCHAR(10), @TumourBenign VARCHAR(10), @TumourProbablyBenign VARCHAR(10),
			@TumourMalignant VARCHAR(10), @TumourProbablyMalignant VARCHAR(10), @Ulcer VARCHAR(10), @Web VARCHAR(10), @SchatzkiRing VARCHAR(10), 
			@ExtrinsicCompression VARCHAR(10), @PharyngealPouch VARCHAR(10), @ScopeCouldNotPass VARCHAR(10), @InletPatch VARCHAR(10),
			@Other VARCHAR(10), @FoodResidue VARCHAR(10), @Fitsula VARCHAR(10), @InletPouch VARCHAR(10), @ZLine VARCHAR(10), @Volvulus VARCHAR(10), @AmpullaryAdenoma VARCHAR(10), @StentOcclusion VARCHAR(10),
			@StentInSitu VARCHAR(10), @PEGInSitu VARCHAR(10)

	SELECT @site_id=SiteId, 
			@Diverticulum = (CASE WHEN Diverticulum = 1 THEN 'True' ELSE 'False' END), 
			@Foreignbody = (CASE WHEN Foreignbody = 1 THEN 'True' ELSE 'False' END),
			@MaloryWeissTear = (CASE WHEN Mallory = 1 THEN 'True' ELSE 'False' END),
			@MotilityDisorder = (CASE WHEN MotilityDisorder = 1 THEN 'True' ELSE 'False' END),
			@Stricture = (CASE WHEN (Stricture = 1 AND StrictureType = 0) THEN 'True' ELSE 'False' END),
			@StrictureBenign = (CASE WHEN (Stricture = 1 AND StrictureType = 1) THEN 'True' ELSE 'False' END),
			@StrictureMalignant = (CASE WHEN (Stricture = 1 AND StrictureType = 2) THEN 'True' ELSE 'False' END),
			@Tumour = (CASE WHEN (Tumour = 1 AND TumourType = 0) THEN 'True' ELSE 'False' END),
			@TumourBenign = (CASE WHEN (Tumour = 1 AND TumourType = 1 AND TumourProbably <> 1) THEN 'True' ELSE 'False' END),
			@TumourProbablyBenign = (CASE WHEN (Tumour = 1 AND TumourType = 1 AND TumourProbably = 1) THEN 'True' ELSE 'False' END),
			@TumourMalignant = (CASE WHEN (Tumour = 1 AND TumourType = 2 AND TumourProbably <> 1) THEN 'True' ELSE 'False' END),
			@TumourProbablyMalignant = (CASE WHEN (Tumour = 1 AND TumourType = 2 AND TumourProbably = 1) THEN 'True' ELSE 'False' END),
			@Ulcer = (CASE WHEN (Ulceration = 1) THEN 'True' ELSE 'False' END),
			@Web = (CASE WHEN (Web = 1) THEN 'True' ELSE 'False' END),
			@SchatzkiRing = (CASE WHEN (SchatzkiRing = 1) THEN 'True' ELSE 'False' END),
			@ExtrinsicCompression = (CASE WHEN (ExtrinsicCompression = 1) THEN 'True' ELSE 'False' END),
			@PharyngealPouch = (CASE WHEN (Pharyngeal = 1) THEN 'True' ELSE 'False' END),
			@ScopeCouldNotPass = (CASE WHEN (StrictureScopeNotPass = 1) OR (TumourScopeNotPass = 1) THEN 'True' ELSE 'False' END),
			@InletPatch = (CASE WHEN (InletPatch = 1) AND (InletPatchQty > 0 OR InletPatchMultiple = 1) THEN 'True' ELSE 'False' END),
			@Other = (CASE WHEN (MiscOther != '') THEN 'True' ELSE 'False' END),
			@FoodResidue = (CASE WHEN (FoodResidue = 1) THEN 'True' ELSE 'False' END),
			@Fitsula = (CASE WHEN (Fitsula = 1) THEN 'True' ELSE 'False' END),
			@InletPouch = (CASE WHEN InletPouch = 1 AND InletPouchQty > 0 THEN 'True' ELSE 'False' END),
			@ZLine = (CASE WHEN ZLine = 1 THEN 'True' ELSE 'False' END),
			@Volvulus = (CASE WHEN Volvulus = 1 THEN 'True' ELSE 'False' END),
			@AmpullaryAdenoma = (CASE WHEN AmpullaryAdenoma = 1 THEN 'True' ELSE 'False' END),
			@StentOcclusion = (CASE WHEN StentOcclusion = 1 THEN 'True' ELSE 'False' END),
			@StentInSitu = (CASE WHEN StentInSitu = 1 THEN 'True' ELSE 'False' END),
			@PEGInSitu = (CASE WHEN PEGInSitu = 1 THEN 'True' ELSE 'False' END)

	FROM INSERTED

	EXEC ogd_kpi_stricture_perforation @site_id --Update perforation text in QA for OGD KPI

	EXEC abnormalities_miscellaneous_summary_update @site_id
	EXEC sites_summary_update @site_id

	DECLARE @Region VARCHAR(50) = dbo.fnSiteRegion(@site_id) 

	IF LOWER(@Region) = 'oesophagus'
	BEGIN
		--for sites in the oesophagus
		EXEC diagnoses_control_save @site_id, 'D32P1', @Diverticulum			-- 'Diverticulum'
		EXEC diagnoses_control_save @site_id, 'D35P1', @Foreignbody				-- 'Foreignbody'
		EXEC diagnoses_control_save @site_id, 'D24P1', @MaloryWeissTear			-- 'MaloryWeissTear'
		EXEC diagnoses_control_save @site_id, 'D28P1', @MotilityDisorder		-- 'MotilityDisorder'
		EXEC diagnoses_control_save @site_id, 'D21P1', @Stricture				-- 'Stricture'
		EXEC diagnoses_control_save @site_id, 'D72P1', @StrictureBenign			-- 'StrictureBenign'
		EXEC diagnoses_control_save @site_id, 'D73P1', @StrictureMalignant		-- 'StrictureMalignant'
		EXEC diagnoses_control_save @site_id, 'D74P1', @Tumour					-- 'Tumour'
		EXEC diagnoses_control_save @site_id, 'D25P1', @TumourBenign			-- 'TumourBenign'
		EXEC diagnoses_control_save @site_id, 'D29P1', @TumourProbablyBenign	-- 'TumourProbablyBenign'
		EXEC diagnoses_control_save @site_id, 'D34P1', @TumourMalignant			-- 'TumourMalignant'
		EXEC diagnoses_control_save @site_id, 'D37P1', @TumourProbablyMalignant	-- 'TumourProbablyMalignant'
		EXEC diagnoses_control_save @site_id, 'D26P1', @Ulcer					-- 'Ulcer'
		EXEC diagnoses_control_save @site_id, 'D38P1', @Web						-- 'Web'
		EXEC diagnoses_control_save @site_id, 'D71P1', @SchatzkiRing			-- 'SchatzkiRing'
		EXEC diagnoses_control_save @site_id, 'D67P1', @ExtrinsicCompression	-- 'ExtrinsicCompression'
		EXEC diagnoses_control_save @site_id, 'D69P1', @PharyngealPouch			-- 'Pharyngeal Pouch
		EXEC diagnoses_control_save @site_id, 'D98P1', @InletPatch				
		EXEC diagnoses_control_save @site_id, 'D99P1', @FoodResidue				
		EXEC diagnoses_control_save @site_id, 'D68P1', @Fitsula
		EXEC diagnoses_control_save @site_id, 'DInletPouchP1', @InletPouch		-- 'Inlet Pouch					
		EXEC diagnoses_control_save @site_id, 'NZLINEP1', @ZLine		-- 'Z-Line			
		EXEC diagnoses_control_save @site_id, 'DOSTECNTOCCP1', @StentOcclusion						
		EXEC diagnoses_control_save @site_id, 'DOSTECNTSITUP1', @StentInSitu						
		EXEC diagnoses_control_save @site_id, 'DOPEGINSITUP1', @PEGInSitu						

		
	END
	ELSE IF LOWER(@Region) = 'stomach'
	BEGIN
		--for sites in the stomach
		EXEC diagnoses_control_save @site_id, 'N2009', @Fitsula				
		EXEC diagnoses_control_save @site_id, 'N2010', @Foreignbody				-- 'Foreignbody'
		EXEC diagnoses_control_save @site_id, 'N2008', @Diverticulum			-- 'Diverticulum'
		EXEC diagnoses_control_save @site_id, 'DSSTECNTOCCP1', @StentOcclusion				
		EXEC diagnoses_control_save @site_id, 'DSSTECNTSITUP1', @StentInSitu								
		EXEC diagnoses_control_save @site_id, 'DSPEGINSITUP1', @PEGInSitu						

	END
	ELSE IF LOWER(@Region) = 'duodenum'
	BEGIN
		EXEC diagnoses_control_save @site_id, 'DVOLVULUSP1', @Volvulus				
		EXEC diagnoses_control_save @site_id, 'DAAdenomaP1', @AmpullaryAdenoma		
		EXEC diagnoses_control_save @site_id, 'DDSTECNTOCCP1', @StentOcclusion				
		EXEC diagnoses_control_save @site_id, 'DDSTECNTSITUP1', @StentInSitu						
		EXEC diagnoses_control_save @site_id, 'DDPEGINSITUP1', @PEGInSitu						
		
	END

	EXEC diagnoses_control_save @site_id, 'D100P1', @Other				
	EXEC diagnoses_control_save @site_id, 'StomachNotEntered', @ScopeCouldNotPass			-- 'scope could not pass
	EXEC diagnoses_control_save @site_id, 'DuodenumNotEntered', @ScopeCouldNotPass			-- 'scope could not pass
GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO




------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea Johnson
-- TFS#	
-- Description of change
-- Adding Indexes
------------------------------------------------------------------------------------------------------------------------
GO


IF NOT EXISTS (SELECT 1 FROM sys.indexes WHERE name='IX_ERS_ProcedureTypes' AND object_id = OBJECT_ID('dbo.ERS_ProcedureTypes'))
BEGIN
    ALTER TABLE [dbo].[ERS_ProcedureTypes]
        ADD CONSTRAINT [IX_ERS_ProcedureTypes] UNIQUE NONCLUSTERED ([ProcedureTypeId] ASC);
END


GO
PRINT N'Creating Index [dbo].[ERS_ASAStatus].[IX_ERS_ASAStatus_NEDTerm]...';


GO
IF NOT EXISTS (SELECT 1 FROM sys.indexes WHERE name='IX_ERS_ASAStatus_NEDTerm' AND object_id = OBJECT_ID('dbo.ERS_ASAStatus'))
BEGIN
    CREATE NONCLUSTERED INDEX [IX_ERS_ASAStatus_NEDTerm]
        ON [dbo].[ERS_ASAStatus]([NEDTerm] ASC);
END


GO
PRINT N'Creating Index [dbo].[ERS_BiopsySites].[IX_ERS_BiopsySites_NEDTerm]...';


GO
IF NOT EXISTS (SELECT 1 FROM sys.indexes WHERE name='IX_ERS_BiopsySites_NEDTerm' AND object_id = OBJECT_ID('dbo.ERS_BiopsySites'))
BEGIN
    CREATE NONCLUSTERED INDEX [IX_ERS_BiopsySites_NEDTerm]
        ON [dbo].[ERS_BiopsySites]([NEDTerm] ASC);
        
END

GO
PRINT N'Creating Index [dbo].[ERS_Chromendoscopies].[IX_ERS_Chromendoscopies]...';


GO
IF NOT EXISTS (SELECT 1 FROM sys.indexes WHERE name='IX_ERS_Chromendoscopies' AND object_id = OBJECT_ID('dbo.ERS_Chromendoscopies'))
BEGIN
    CREATE NONCLUSTERED INDEX [IX_ERS_Chromendoscopies]
        ON [dbo].[ERS_Chromendoscopies]([NEDTerm] ASC)
END;


GO
PRINT N'Creating Default Constraint [dbo].[DF_ERS_Indications_WhenCreated]...';


GO
IF OBJECT_ID('dbo.DF_ERS_Indications_WhenCreated', 'D') IS NULL
BEGIN
    ALTER TABLE [dbo].[ERS_Indications]
        ADD CONSTRAINT [DF_ERS_Indications_WhenCreated] DEFAULT (getdate()) FOR [WhenCreated];
    
END

GO
PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedureSubIndications_ERS_SubIndications]...';


GO
IF OBJECT_ID('dbo.FK_ERS_ProcedureSubIndications_ERS_SubIndications', 'F') IS NULL
BEGIN
    ALTER TABLE [dbo].[ERS_ProcedureSubIndications] WITH NOCHECK
        ADD CONSTRAINT [FK_ERS_ProcedureSubIndications_ERS_SubIndications] FOREIGN KEY ([SubIndicationId]) REFERENCES [dbo].[ERS_SubIndications] ([UniqueId]);
        
END

GO
PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedureSubIndications_ERS_Procedures]...';


GO
IF OBJECT_ID('dbo.FK_ERS_ProcedureSubIndications_ERS_Procedures', 'F') IS NULL
ALTER TABLE [dbo].[ERS_ProcedureSubIndications] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_ProcedureSubIndications_ERS_Procedures] FOREIGN KEY ([ProcedureId]) REFERENCES [dbo].[ERS_Procedures] ([ProcedureId]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_ERS_IndicationsProcedureTypes_ERS_Indications]...';


GO
IF OBJECT_ID('dbo.FK_ERS_IndicationsProcedureTypes_ERS_Indications', 'F') IS NULL
BEGIN
    ALTER TABLE [dbo].[ERS_IndicationsProcedureTypes] WITH NOCHECK
        ADD CONSTRAINT [FK_ERS_IndicationsProcedureTypes_ERS_Indications] FOREIGN KEY ([IndicationId]) REFERENCES [dbo].[ERS_Indications] ([UniqueId]);
        
END

GO
PRINT N'Creating Foreign Key [dbo].[FK_ERS_IndicationsProcedureTypes_ERS_ProcedureTypes]...';


GO
IF OBJECT_ID('dbo.FK_ERS_IndicationsProcedureTypes_ERS_ProcedureTypes', 'F') IS NULL
BEGIN
    ALTER TABLE [dbo].[ERS_IndicationsProcedureTypes] WITH NOCHECK
        ADD CONSTRAINT [FK_ERS_IndicationsProcedureTypes_ERS_ProcedureTypes] FOREIGN KEY ([ProcedureTypeId]) REFERENCES [dbo].[ERS_ProcedureTypes] ([ProcedureTypeId]);
    
END

GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 09.11.23
-- TFS#	
-- Description of change
-- Instruments save process
------------------------------------------------------------------------------------------------------------------------
GO


PRINT N'Altering Procedure [dbo].[procedure_ai_software_save]...';


GO
ALTER PROCEDURE [dbo].[procedure_ai_software_save]
(
	@ProcedureId int,
	@AISoftwareId int,
	@AISoftwareOther varchar(500), 
	@AISoftwareName varchar(500),
	@AIOtherSoftwareName varchar(500),
	@LoggedInUserId int
)
AS
BEGIN
	/*Check if new values needs adding */
	IF ISNULL(@AISoftwareOther,'') <> ''
	BEGIN
		IF NOT EXISTS (SELECT 1 FROM ERS_AISoftware WHERE Description = @AISoftwareOther)
		BEGIN
			/*get and set the new items order id so it appears 1 above 'other' we always want other to be last*/

			DECLARE @OtherListOrderBy int = (SELECT ListOrderBy FROM ERS_AISoftware WHERE Description = 'Other')
			INSERT INTO ERS_AISoftware (Description, NEDTerm, ListOrderBy) VALUES (@AISoftwareOther, 'Other', @OtherListOrderBy)
			
			UPDATE dbo.ERS_AISoftware SET ListOrderBy = @OtherListOrderBy + 1 WHERE Description = 'Other'
		END

		SELECT @AISoftwareId = UniqueId FROM dbo.ERS_AISoftware WHERE Description = @AISoftwareOther
	END

	IF NOT EXISTS (SELECT 1 FROM ERS_ProcedureAISoftware WHERE ProcedureId = @ProcedureId)
	BEGIN
		INSERT INTO ERS_ProcedureAISoftware (ProcedureId, AISoftwareId, AISoftwareOther, AISoftwareName, AIOtherSoftwareName, WhoCreatedId, WhenCreated)
		VALUES (@ProcedureId, @AISoftwareId, '', @AISoftwareName, NULLIF(@AIOtherSoftwareName,''), @LoggedInUserId, GETDATE())
	END
	ELSE
	BEGIN
		UPDATE ERS_ProcedureAISoftware
		SET AISoftwareId = @AISoftwareId, 
			AISoftwareOther = '',
			AISoftwareName = @AISoftwareName,
			AIOtherSoftwareName = NULLIF(@AIOtherSoftwareName,''),
			WhoUpdateId = @LoggedInUserId, 
			WhenUpdated = GETDATE()
		Where ProcedureId = @ProcedureId
	END

	DECLARE @Summary varchar(max) = 'AI Software used: ',
			@SectionId int = (SELECT UISectionId FROM UI_Sections WHERE SectionName = 'AI software')

	DELETE FROM ERS_ProcedureSummary WHERE ProcedureId = @ProcedureId AND SectionId = @SectionId
	

	--get software name
	DECLARE @SoftwareDescription VARCHAR(500) = (SELECT Description FROM dbo.ERS_AISoftware WHERE UniqueId = @AISoftwareId)

	--if none then pass
	IF LOWER(@SoftwareDescription) = 'none' OR 
	(LOWER(@SoftwareDescription) <> 'other' AND ISNULL(@AISoftwareName,'') <> '') OR --if not then requires a name
	(LOWER(@SoftwareDescription) = 'other' AND ISNULL(@AISoftwareOther,'') <> '' AND ISNULL(@AIOtherSoftwareName,'') <> '') --if other then requires an other value and name
	BEGIN
		INSERT INTO ERS_ProcedureSummary (SectionId, ProcedureId, Summary)
	    VALUES (@SectionId, @ProcedureId, @Summary)
	END
	
	

END
GO
PRINT N'Altering Procedure [dbo].[procedure_chromendoscopy_save]...';


GO
ALTER PROCEDURE [dbo].[procedure_chromendoscopy_save]
(
	@ProcedureId int,
	@ChromendoscopyId int,
	@AdditionalInfo varchar(500),
	@LoggedInUserId	int
)
AS
BEGIN
	/*Check if new values been */
	IF ISNULL(@AdditionalInfo,'') <> ''
	BEGIN
		IF NOT EXISTS (SELECT 1 FROM ERS_Chromendoscopies WHERE Description = @AdditionalInfo)
		BEGIN
			/*get and set the new items order id so it appears 1 above 'other' we always want other to be last*/

			DECLARE @OtherListOrderBy int = (SELECT ListOrderBy FROM ERS_Chromendoscopies WHERE Description = 'Other')
			INSERT INTO ERS_Chromendoscopies (Description, NEDTerm, ListOrderBy) VALUES (@AdditionalInfo, 'Other', @OtherListOrderBy)
			
			UPDATE dbo.ERS_Chromendoscopies SET ListOrderBy = @OtherListOrderBy + 1 WHERE Description = 'Other'
		END

		SELECT @ChromendoscopyId = UniqueId FROM dbo.ERS_Chromendoscopies WHERE Description = @AdditionalInfo
	END

	IF NOT EXISTS (SELECT 1 FROM ERS_ProcedureChromendosopy WHERE ProcedureId = @ProcedureId)
	BEGIN
		INSERT INTO ERS_ProcedureChromendosopy (ProcedureId, ChromendoscopyId, AdditionalInfo, WhoCreatedId, WhenCreated)
		VALUES (@ProcedureId, @ChromendoscopyId, '', @LoggedInUserId, getdate())
	END
	ELSE
	BEGIN
		UPDATE ERS_ProcedureChromendosopy
		SET ChromendoscopyId = @ChromendoscopyId,
			AdditionalInfo = '',
			WhoUpdatedId = @LoggedInUserId,
			WhenUpdated = getdate()
		WHERE ProcedureId = @ProcedureId
	END

	 --mark as incomplete. will be decided below
	EXEC UI_update_procedure_summary @ProcedureId, 'Chromendoscopies', 'Chromendoscopies:', 0
	
	--get description
	DECLARE @Description VARCHAR(200) = (SELECT [Description] FROM dbo.ERS_Chromendoscopies WHERE UniqueId = @ChromendoscopyId)
	
	--if not other then mark complete
	--if other and additional info then mark complete
	IF LOWER(@Description) <> 'other' OR (LOWER(@Description) = 'other' AND @AdditionalInfo <> '')
	BEGIN
	    DECLARE @Summary VARCHAR(max) = 'Chromendoscopies:'
	    EXEC UI_update_procedure_summary @ProcedureId, 'Chromendoscopies', @Summary, @ChromendoscopyId	
	END
    
END
GO
PRINT N'Altering Procedure [dbo].[procedure_distal_attachment_save]...';


GO

ALTER PROCEDURE [dbo].[procedure_distal_attachment_save]
(
	@ProcedureId int,
	@DistalAttachmentId int, 
	@DistalAttachmentOther varchar(max), 
	@Selected bit,
	@LoggedInUserId int
)
AS
BEGIN
	IF @Selected = 1
	BEGIN
		IF NOT EXISTS (SELECT 1 FROM ERS_ProcedureDistalAttachment WHERE ProcedureId = @ProcedureId)
		BEGIN
			INSERT INTO ERS_ProcedureDistalAttachment (ProcedureId, DistalAttachmentId, AdditionalInfo, WhoCreatedId, WhenCreated)
			VALUES (@ProcedureId, @DistalAttachmentId, @DistalAttachmentOther, @LoggedInUserId, GETDATE())
		END
		ELSE
		BEGIN
			UPDATE ERS_ProcedureDistalAttachment
			SET DistalAttachmentId = @DistalAttachmentId,
				AdditionalInfo = @DistalAttachmentOther,
				WhoUpdatedId = @LoggedInUserId,
				WhenUpdated = GETDATE()
			WHERE ProcedureId = @ProcedureId
		END

		--mark as incomplete. will be decided below
		EXEC UI_update_procedure_summary @ProcedureId, 'Distal attachments', 'Distal attachments:', 0

		--get description
		DECLARE @Description VARCHAR(200) = (SELECT [Description] FROM dbo.ERS_DistalAttachments WHERE UniqueId = @DistalAttachmentId)
	
		--if not other then mark complete
		--if other and additional info then mark complete
		IF LOWER(@Description) <> 'other' OR (LOWER(@Description) = 'other' AND @DistalAttachmentOther <> '')
		BEGIN
			EXEC UI_update_procedure_summary @ProcedureId, 'Distal attachments', 'Distal attachments:', 1
		END

	END
	ELSE
	BEGIN
		DELETE FROM ERS_ProcedureDistalAttachment WHERE ProcedureId = @ProcedureId

		EXEC UI_update_procedure_summary @ProcedureId, 'Distal attachments', 'Distal attachments:', 0
	END
		
END
GO
PRINT N'Altering Procedure [dbo].[sys_get_list_slots]...';


GO

ALTER procedure [dbo].[sys_get_list_slots]
(
	@ListRulesId INT
)    
as
select * from ERS_SCH_ListSlots
where ListRulesId = @ListRulesId AND Active = 1

GO
PRINT N'Creating Procedure [dbo].[usp_mark_section_selected]...';


GO
EXEC dbo.DropIfExist @ObjectName = 'usp_mark_section_selected',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE dbo.usp_mark_section_selected
(
	@ProcedureId int,
	@SectionName varchar(200)
)
AS
BEGIN
	DECLARE @SectionId INT = (SELECT UISectionId FROM dbo.UI_Sections WHERE LOWER(SectionName) = LOWER(@SectionName))
	IF NOT EXISTS (SELECT 1 FROM dbo.ERS_ProcedureSummary WHERE ProcedureId = @ProcedureId AND SectionId = @SectionId)
	BEGIN		
		INSERT INTO dbo.ERS_ProcedureSummary
		(
		    ProcedureId,
		    SectionId,
		    Summary,
		    EndoscopistId
		)
		VALUES
		(   @ProcedureId,   -- ProcedureId - int
		    @SectionId,   -- SectionId - int
		    @SectionName,  -- Summary - varchar(max)
		    NULL -- EndoscopistId - int
		    )
	END
END
GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 27.11.23
-- TFS#	3562
-- Description of change
-- Bowel prep changes
------------------------------------------------------------------------------------------------------------------------
GO


UPDATE dbo.UI_Sections SET PageId = 2 WHERE SectionName IN ('Bowel Prep', 'Procedure drugs')
GO


PRINT N'Altering Procedure [dbo].[procedure_bowel_prep_save]...';


GO

ALTER procedure [dbo].[procedure_bowel_prep_save]
(
	@ProcedureId int,
	@BowelPrepId int,
	@LeftScore int,
	@RightScore int,
	@TransverseScore int,
	@TotalScore int,
	@Quantity decimal(18,2),
	@EnemaId int,
	@EnemaOther varchar(200),
	@AdditionalInfo varchar(max),
	@LoggedInUserId int
)
AS
BEGIN
	IF @BowelPrepId >0 
	BEGIN
	    /*Check if new values been */
	    	IF ISNULL(@AdditionalInfo,'') <> ''
	    	BEGIN
	    		IF NOT EXISTS (SELECT 1 FROM ERS_BowelPrep WHERE Description = @AdditionalInfo)
	    		BEGIN
	    			/*get and set the new items order id so it appears 1 above 'other' we always want other to be last*/
	    
	    			DECLARE @OtherListOrderBy int = (SELECT ListOrderBy FROM ERS_BowelPrep WHERE Description = 'Other')
	    			INSERT INTO ERS_BowelPrep (Description, NEDTerm, ListOrderBy) VALUES (@AdditionalInfo, 'Other', @OtherListOrderBy)
	    			
	    			UPDATE dbo.ERS_BowelPrep SET ListOrderBy = @OtherListOrderBy + 1 WHERE Description = 'Other'
	    		END
	    
	    		SELECT @BowelPrepId = UniqueId FROM ERS_BowelPrep WHERE Description = @AdditionalInfo
	    	END
	    
	    	/*Check if new values been */
	    	IF ISNULL(@EnemaOther,'') <> ''
	    	BEGIN
	    		IF NOT EXISTS (SELECT 1 FROM ERS_BowelPrepEnemas WHERE Description = @EnemaOther)
	    		BEGIN
	    			/*get and set the new items order id so it appears 1 above 'other' we always want other to be last*/
	    
	    			DECLARE @EOtherListOrderBy int = (SELECT ListOrderBy FROM ERS_BowelPrepEnemas WHERE Description = 'Other')
	    			INSERT INTO ERS_BowelPrepEnemas (Description, NEDTerm, ListOrderBy) VALUES (@EnemaOther, 'Other', @EOtherListOrderBy)
	    			
	    			UPDATE dbo.ERS_BowelPrepEnemas SET ListOrderBy = @EOtherListOrderBy + 1 WHERE Description = 'Other'
	    		END
	    
	    		SELECT @EnemaId = UniqueId FROM ERS_BowelPrepEnemas WHERE Description = @EnemaOther
	    	END
	    
	    	IF NOT EXISTS (SELECT 1 FROM ERS_ProcedureBowelPrep WHERE ProcedureId = @ProcedureId)
	    	BEGIN
	    		INSERT INTO ERS_ProcedureBowelPrep (ProcedureId, BowelPrepId, Quantity, LeftPrepScore, RightPrepScore, TransversePrepScore, TotalPrepScore, AdditionalInfo, EnemaId, WhoCreatedId, WhenCreated)
	    		VALUES (@ProcedureId, @BowelPrepId, @Quantity, NULLIF(@LeftScore, -1), NULLIF(@RightScore, -1), NULLIF(@TransverseScore,-1), NULLIF(@TotalScore, -1), '', @EnemaId, @LoggedInUserId, getdate())
	    	END
	    	ELSE
	    	BEGIN
	    		UPDATE ERS_ProcedureBowelPrep
	    		SET BowelPrepId = NULLIF(@BowelPrepId,0),
	    			Quantity = @Quantity,
	    			LeftPrepScore = NULLIF(@LeftScore, -1),
	    			RightPrepScore = NULLIF(@RightScore, -1),
	    			TransversePrepScore = NULLIF(@TransverseScore, -1),
	    			TotalPrepScore = NULLIF(@TotalScore, -1),
	    			AdditionalInfo = @AdditionalInfo,
	    			EnemaId = @EnemaId,
	    			WhoUpdatedId = @LoggedInUserId,
	    			WhenUpdated = getdate()
	    		WHERE ProcedureId = @ProcedureId
	    	END
	END
	ELSE
	BEGIN
	    DELETE FROM dbo.ERS_ProcedureBowelPrep WHERE ProcedureId =@ProcedureId
	END
	

	DECLARE @Summary VARCHAR(max), 
			@BowelPrepFormula varchar(max) = (SELECT [Description] FROM ERS_BowelPrep WHERE UniqueId = @BowelPrepId) + 
				CASE WHEN ISNULL(@EnemaId,0) > 0 THEN ' + ' + (SELECT [Description] FROM dbo.ERS_BowelPrepEnemas WHERE UniqueId = @EnemaId) ELSE '' END +
				CASE WHEN ISNULL(@Quantity,0) > 0 THEN ' (Volume ' + CONVERT(varchar(10), convert(int, @Quantity))  + ')' ELSE '' END

	
	SET @Summary = @BowelPrepFormula + '. '
	
	IF NULLIF(@TotalScore, -1) IS NOT NULL 
	BEGIN
		SET @Summary = @Summary + ' Boston Bowel Prep Total Score ' +  cast( @TotalScore as varchar(10))
	END 

	--UPDATE  [ERS_BowelPreparation] SET Summary = @Summary WHERE ProcedureID=@ProcedureId
	UPDATE [ERS_ProceduresReporting] SET [PP_Bowel_Prep] = @Summary WHERE ProcedureID=@ProcedureId
	EXEC procedure_summary_update @ProcedureId

	DECLARE @SectionId int = (SELECT UISectionId FROM UI_Sections WHERE SectionName = 'Bowel Prep')

	DELETE FROM ERS_ProcedureSummary WHERE ProcedureId = @ProcedureId AND SectionId = @SectionId
	
	--validate completion
	IF @BowelPrepId > 0
	BEGIN
		--check extent for completion rules

		/*For colonoscopy and flexi sig, where the extent is anastamosis, 
		ileo-colon anastamosis or neo-terminal ileum, segmental BBPS scores 
		or a total BBPS score is no longer mandated.*/
		IF EXISTS (SELECT 1 FROM dbo.ERS_ProcedureLowerExtent pe WHERE pe.ProcedureId = @ProcedureId AND pe.ExtentId IN (
			SELECT e.UniqueId FROM dbo.ERS_Extent e WHERE e.NEDTerm IN ('Ileo-colon anastomosis','Neo-terminal ileum','Terminal ileum','Anastomosis')))
				BEGIN
				    EXEC UI_update_procedure_summary   @ProcedureId, 'Bowel Prep', @Summary, 1	
				END
		ELSE
			BEGIN
			    IF (@BowelPrepId = (SELECT bp.UniqueId FROM dbo.ERS_BowelPrep bp WHERE bp.NEDTerm = 'No preparation'))
					EXEC UI_update_procedure_summary   @ProcedureId, 'Bowel Prep', @Summary, 1	
				ELSE IF (@LeftScore > -1 AND @RightScore > -1 AND @TransverseScore > -1)
					EXEC UI_update_procedure_summary   @ProcedureId, 'Bowel Prep', @Summary, 1	
				ELSE
					EXEC UI_update_procedure_summary   @ProcedureId, 'Bowel Prep', @Summary, 0	
			END
			
	END

	
END
GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	
-- TFS#	
-- Description of change
-- 
------------------------------------------------------------------------------------------------------------------------
GO


PRINT N'Altering Procedure [dbo].[sites_summary_update]...';


GO
ALTER PROCEDURE [dbo].[sites_summary_update]
(
	@SiteId INT,
	@RefreshReport BIT = 1
)
AS
/*
-- Update History:
-- 10 Nov 2023		MH		replaced table reference ERS_ColonAbnoLesions with ERS_CommonAbnoLesions	TFS #3556
-- 15 Nov 2023		MH/Andrea		after finding the sp could updated from older version - the script has been taken from release 2_23_05_03 and then added some required refreshsummary works done by Steve, Polyp details are fixed here for Colon,Gastro etc
--							
*/
SET NOCOUNT ON

DECLARE @TrustId int
SELECT @TrustId = oh.TrustId
FROM ERS_Procedures p
JOIN ERS_Sites s ON s.ProcedureId = p.ProcedureId AND s.SiteId = @SiteId
JOIN ERS_OperatingHospitals oh ON oh.OperatingHospitalId = p.OperatingHospitalID

DECLARE @ReportSummaryRefresh int
SELECT @ReportSummaryRefresh = CAST([dbo].[fn_ShouldRefreshSummary](@TrustId) AS INT)

IF (@ReportSummaryRefresh + CAST(@RefreshReport AS INT) > 0)
BEGIN
	DECLARE @summaryAbnormalities VARCHAR(MAX)
			,@summarySpecimens VARCHAR(MAX)
			,@summaryTherapeutics VARCHAR(MAX)
			,@summaryWhole VARCHAR(MAX)
			,@summaryAbnormalitiesWithHyperLinks VARCHAR(MAX)
			,@summarySpecimensWithHyperLinks VARCHAR(MAX)
			,@summaryTherapeuticsWithHyperLinks VARCHAR(MAX)
			,@procType INT
			,@procId INT
			,@none TINYINT
			,@region VARCHAR(500)
			,@htmlAnchorCode VARCHAR(500)
			,@siteIdStr VARCHAR(15)
			,@indent VARCHAR(15) 
			,@br VARCHAR(10)
			,@opDiv VARCHAR(150)
			,@clDiv VARCHAR(50)
			,@opBold VARCHAR(5)
			,@clBold VARCHAR(5)
			,@fullStop VARCHAR(1)
			,@colon VARCHAR(2)
			,@fldNone VARCHAR(20)
			,@emptyStr VARCHAR(1)
			,@abnoTheraPresent BIT = 0
			,@tmpSummaryAbno VARCHAR(MAX)
			,@tmpSummaryAbnoLinks VARCHAR(MAX)
			,@SiteNo INT
			,@regionID INT
			,@AreaNo INT
			,@AbnormalProcedure BIT = 0


	BEGIN TRANSACTION

	BEGIN TRY

		SET	@summaryAbnormalities = ''
		SET	@summarySpecimens = ''
		SET	@summaryTherapeutics = ''
		SET	@summaryAbnormalitiesWithHyperLinks = ''
		SET	@summarySpecimensWithHyperLinks = ''
		SET	@summaryTherapeuticsWithHyperLinks = ''
		SET @siteIdStr = CONVERT(VARCHAR(10),@SiteId)
		SET @AbnormalProcedure = 0

		DECLARE @IsLymphNode VARCHAR(10) = 'False'

		SELECT @procId = p.ProcedureId,@procType = p.ProcedureType, @regionID = s.RegionId, @SiteNo = s.SiteNo, @AreaNo = ISNULL(AreaNo,0),
				@region = CASE WHEN s.SiteNo = -77 THEN						--SiteNo is set to -77 for sites By Distance (Col & Sig only)
							CONVERT(VARCHAR,XCoordinate) +  
								CASE WHEN YCoordinate IS NULL OR YCoordinate=0 THEN ' cm' 
								ELSE (' to ' + CONVERT(VARCHAR,YCoordinate) + ' cm' ) 
								END
						ELSE (SELECT r.Region FROM ERS_Regions r WHERE r.RegionId = s.RegionId)
						END
				,@IsLymphNode = CASE WHEN s.IsLymphNode = 1 THEN 'True' ELSE 'False' END
		FROM ERS_Sites s
		JOIN ERS_Procedures p ON s.ProcedureId = p.ProcedureId
		--JOIN ERS_Regions r ON s.RegionId = r.RegionId
		WHERE SiteId = @SiteId
		--SELECT @region = Region FROM ERS_Regions WHERE RegionId = @regionID

		SET @htmlAnchorCode = '<a href="#" class="sitesummary" onclick="OpenSiteDetails(''''' + @region + ''''',' + @siteIdStr + ',''''{0}'''',''''' + CONVERT(VARCHAR,@AreaNo) + ''''');">{1}</a>'
		--{0} is the name of the menu and {1} is the summary text

	
		DECLARE @SQLString NVARCHAR(MAX), @QryString NVARCHAR(MAX), @AbnoCheck BIT
		DECLARE @ProcedureType INT, @TableName VARCHAR(50), @AbnoNodeName VARCHAR(50), @Identifier VARCHAR(50)

		CREATE TABLE #QueryDetails (ProcType INT, TableName VARCHAR(50), AbnoNodeName VARCHAR(50), Identifier VARCHAR(50));

		--Notes to appear on the report just after the Site X heading, before the abnormalities.
		INSERT INTO #QueryDetails SELECT @procType,	'ERS_Sites',		'',		'Additional notes'
		IF @procType IN (1,6) --Gastroscopy / EUS(OGD)
		BEGIN
			INSERT INTO #QueryDetails VALUES 
			(@procType,	'ERS_CommonAbnoAtrophic',			'Atrophic duodenum','Atrophic Duodenum')
			,(@procType,	'ERS_UpperGIAbnoAchalasia',		'Achalasia',		'Achalasia')
			,(@procType,	'ERS_UpperGIAbnoBarrett',		'',					'Barretts Epithelium')
			,(@procType,	'ERS_UpperGIAbnoDeformity',		'Deformity',		'Deformity')
			,(@procType,	'ERS_CommonAbnoDiverticulum',	'Diverticulum',		'Diverticulum/Other')
			,(@procType,	'ERS_CommonAbnoDuodenalUlcer',	'',					CASE WHEN @region = 'Jejunum' THEN 'Jejunal Ulcer' WHEN @region = 'Ileum' THEN 'Ileal Ulcer' ELSE 'Duodenal Ulcer' END)
			,(@procType,	'ERS_CommonAbnoDuodenitis',		'',					CASE WHEN @region = 'Jejunum' THEN 'Jejunitis' WHEN @region = 'Ileum' THEN 'Ileitis' ELSE 'Duodenitis' END)
			,(@procType,	'ERS_UpperGIAbnoGastricUlcer',	'Gastric ulcer',	'Gastric Ulcer')
			,(@procType,	'ERS_UpperGIAbnoGastritis',		'Gastritis',		'Gastritis')
			,(@procType,	'ERS_UpperGIAbnoHiatusHernia',	'Hiatus hernia',	'Hiatus Hernia')
			,(@procType,	'ERS_UpperGIAbnoLumen',			'Lumen',			'Lumen')
			,(@procType,	'ERS_UpperGIAbnoMalignancy',	'Malignancy',		'Malignancy')
			,(@procType,	'ERS_UpperGIAbnoMiscellaneous',	'',					'Miscellaneous')
			,(@procType,	'ERS_UpperGIAbnoOesophagitis',	'Oesophagitis',		'Oesophagitis')
			,(@procType,	'ERS_CommonAbnoLesions',		'Lesions',			'Lesions')
			,(@procType,	'ERS_UpperGIAbnoPostSurgery',	'Post surgery',		'Post Surgery')
			,(@procType,	'ERS_CommonAbnoScaring',		'',					'Scarring/Stenosis')
			,(@procType,	'ERS_CommonAbnoTumour',			'',					'Tumour')
			,(@procType,	'ERS_UpperGIAbnoVarices',		CASE WHEN (Select isnull(Quantity, 0) from ERS_UpperGIAbnoVarices where SiteId = @SiteId) = 1 then 'Varix' ELSE 'Varices' END ,			'Varices')
			,(@procType,	'ERS_CommonAbnoVascularLesions','Vascular lesions',	'Vascular Lesions')
			,(@procType,	'ERS_EUSAbnoMediastinal',		'Mediastinal',		'Mediastinal')
			,(@procType,	'ERS_UpperGITherapeutics',		'Therapeutic procedure(s)',	'Therapeutic Procedures')
			,(@procType,	'ERS_UpperGISpecimens',			'Specimens taken',	'Specimens Taken')
		END
		ELSE IF @procType IN (2,7) --ERCP / / EUS(HPB)
		BEGIN
			INSERT INTO #QueryDetails VALUES 
			(@procType,		'ERS_ERCPAbnoAppearance',		'Appearance',		'Appearance')
			,(@procType,	'ERS_CommonAbnoAtrophic',		'Atrophic duodenum','Atrophic Duodenum')
			,(@procType,	'ERS_CommonAbnoDiverticulum',	'Diverticulum',		'Diverticulum/Other')
			,(@procType,	'ERS_ERCPAbnoDiverticulum',		'Diverticulum',		CASE WHEN @region IN ('Major Papilla', 'Minor Papilla') THEN 'Diverticulum' ELSE 'Diverticulum/Other' END)
			,(@procType,	'ERS_ERCPAbnoDuct',				'Duct',				CASE WHEN @region = 'Gall Bladder' THEN 'Gall Bladder' ELSE 'Duct' END)
			,(@procType,	'ERS_CommonAbnoDuodenalUlcer',	'',					CASE WHEN @region = 'Jejunum' THEN 'Jejunal Ulcer' WHEN @region = 'Ileum' THEN 'Ileal Ulcer' ELSE 'Duodenal Ulcer' END)
			,(@procType,	'ERS_CommonAbnoDuodenitis',		'',					CASE WHEN @region = 'Jejunum' THEN 'Jejunitis' WHEN @region = 'Ileum' THEN 'Ileitis' ELSE 'Duodenitis' END)
			,(@procType,	'ERS_ERCPAbnoParenchyma',		'Parenchyma',		'Parenchyma')
			,(@procType,	'ERS_CommonAbnoScaring',		'',					'Scarring/Stenosis')
			,(@procType,	'ERS_CommonAbnoTumour',			'',					'Tumour')
			,(@procType,	'ERS_ERCPAbnoTumour',			'Tumour',			'Tumour')
			,(@procType,	'ERS_ERCPAbnoIntrahepatic',		'Intrahepatic',		'Intrahepatic')
			,(@procType,	'ERS_CommonAbnoVascularLesions','Vascular lesions',	'Vascular Lesions')
			,(@procType,	'ERS_EUSAbnoMediastinal',		'Mediastinal',		'Mediastinal')
			,(@procType,	'ERS_UpperGIAbnoVarices',		CASE WHEN (Select isnull(Quantity, 0) from ERS_UpperGIAbnoVarices where SiteId = @SiteId) = 1 then 'Varix' ELSE 'Varices' END ,			'Varices')
			,(@procType,	'ERS_ERCPTherapeutics',			'Therapeutic procedure(s)',	'Therapeutic Procedures')
			,(@procType,	'ERS_UpperGISpecimens',			'Specimens taken',	'Specimens Taken')
		END
		ELSE IF @procType IN (3,4,5) --Colon/Sigmo/Procto
		BEGIN
			INSERT INTO #QueryDetails VALUES
			(@procType,		'ERS_ColonAbnoCalibre',			'Calibre',			'Calibre')
			,(@procType,	'ERS_ColonAbnoDiverticulum',	'Diverticulum',		'Diverticulum')
			,(@procType,	'ERS_ColonAbnoHaemorrhage',		'Haemorrhage',		'Haemorrhage')
			,(@procType,	'ERS_CommonAbnoLesions',			'Lesions',			'Lesions')
			,(@procType,	'ERS_ColonAbnoTumour',			'Tumour',			'Tumour')
			,(@procType,	'ERS_ColonAbnoMiscellaneous',	'',					'Miscellaneous')
			,(@procType,	'ERS_ColonAbnoMucosa',			'Mucosa',			'Mucosa')
			,(@procType,	'ERS_ColonAbnoperianallesions',	'Perianal lesions',	'Perianal Lesions')
			,(@procType,	'ERS_ColonAbnoVascularity',		'Vascularity',		'Vascularity')
			,(@procType,	'ERS_UpperGIAbnoVarices',		CASE WHEN (Select isnull(Quantity, 0) from ERS_UpperGIAbnoVarices where SiteId = @SiteId) = 1 then 'Varix' ELSE 'Varices' END ,			'Varices')
			,(@procType,	'ERS_UpperGITherapeutics',		'Therapeutic procedure(s)',	'Therapeutic Procedures')
			,(@procType,	'ERS_UpperGISpecimens',			'Specimens taken',	'Specimens Taken')
		END
		ELSE IF @procType IN (8) --Antegrade
		BEGIN
			INSERT INTO #QueryDetails VALUES 
			(@procType,		'ERS_UpperGIAbnoAchalasia',		'Achalasia',		'Achalasia')
			,(@procType,	'ERS_UpperGIAbnoBarrett',		'',					'Barretts Epithelium')
			,(@procType,	'ERS_UpperGIAbnoDeformity',		'Deformity',		'Deformity')
			,(@procType,	'ERS_CommonAbnoAtrophic',		'Atrophic duodenum','Atrophic Duodenum')
			,(@procType,	'ERS_CommonAbnoDiverticulum',	'Diverticulum',		'Diverticulum/Other')
			,(@procType,	'ERS_ColonAbnoDiverticulum',	'Diverticulum',		'Diverticulum')
			,(@procType,	'ERS_CommonAbnoDuodenalUlcer',	'',					CASE WHEN @region = 'Jejunum' THEN 'Jejunal Ulcer' WHEN @region = 'Ileum' THEN 'Ileal Ulcer' ELSE 'Duodenal Ulcer' END)
			,(@procType,	'ERS_CommonAbnoDuodenitis',		'',					CASE WHEN @region = 'Jejunum' THEN 'Jejunitis' WHEN @region = 'Ileum' THEN 'Ileitis' ELSE 'Duodenitis' END)
			,(@procType,	'ERS_ColonAbnoLesions',			'Lesions',			'Lesions')
			,(@procType,	'ERS_CommonAbnoScaring',		'',					'Scarring/Stenosis')
			,(@procType,	'ERS_CommonAbnoTumour',			'',					'Tumour')
			,(@procType,	'ERS_CommonAbnoVascularLesions','Vascular lesions',	'Vascular Lesions')
			,(@procType,	'ERS_UpperGIAbnoGastricUlcer',	'Gastric ulcer',	'Gastric Ulcer')
			,(@procType,	'ERS_UpperGIAbnoGastritis',		'Gastritis',		'Gastritis')
			,(@procType,	'ERS_UpperGIAbnoHiatusHernia',	'Hiatus hernia',	'Hiatus Hernia')
			,(@procType,	'ERS_UpperGIAbnoLumen',			'Lumen',			'Lumen')
			,(@procType,	'ERS_UpperGIAbnoMalignancy',	'Malignancy',		'Malignancy')
			,(@procType,	'ERS_UpperGIAbnoMiscellaneous',	'',					'Miscellaneous')
			,(@procType,	'ERS_UpperGIAbnoOesophagitis',	'Oesophagitis',		'Oesophagitis')
			,(@procType,	'ERS_UpperGIAbnoPostSurgery',	'Post surgery',		'Post Surgery')
			,(@procType,	'ERS_CommonAbnoLesions',		'Lesions',			'Lesions')
			,(@procType,	'ERS_UpperGIAbnoVarices',		CASE WHEN (Select isnull(Quantity, 0) from ERS_UpperGIAbnoVarices where SiteId = @SiteId) = 1 then 'Varix' ELSE 'Varices' END ,			'Varices')
			,(@procType,	'ERS_UpperGITherapeutics',		'Therapeutic procedure(s)',	'Therapeutic Procedures')
			,(@procType,	'ERS_UpperGISpecimens',			'Specimens taken',	'Specimens Taken')
		END
		ELSE IF @procType IN (9) --Retrograde
		BEGIN
			INSERT INTO #QueryDetails VALUES
			(@procType,		'ERS_ColonAbnoCalibre',			'Calibre',			'Calibre')
			,(@procType,	'ERS_ColonAbnoDiverticulum',	'Diverticulum',		'Diverticulum')
			,(@procType,	'ERS_ColonAbnoHaemorrhage',		'Haemorrhage',		'Haemorrhage')
			,(@procType,	'ERS_CommonAbnoLesions',			'Lesions',			'Lesions')
			,(@procType,	'ERS_ColonAbnoTumour',			'Tumour',			'Tumour')
			,(@procType,	'ERS_ColonAbnoMiscellaneous',	'',					'Miscellaneous')
			,(@procType,	'ERS_ColonAbnoMucosa',			'Mucosa',			'Mucosa')
			,(@procType,	'ERS_ColonAbnoperianallesions',	'Perianal lesions',	'Perianal Lesions')
			,(@procType,	'ERS_ColonAbnoVascularity',		'Vascularity',		'Vascularity')
			,(@procType,	'ERS_CommonAbnoDuodenalUlcer',	'',					CASE WHEN @region = 'Jejunum' THEN 'Jejunal Ulcer' WHEN @region = 'Ileum' THEN 'Ileal Ulcer' ELSE 'Duodenal Ulcer' END)
			,(@procType,	'ERS_CommonAbnoDuodenitis',		'',					CASE WHEN @region = 'Jejunum' THEN 'Jejunitis' WHEN @region = 'Ileum' THEN 'Ileitis' ELSE 'Duodenitis' END)
			,(@procType,	'ERS_CommonAbnoScaring',		'',					'Scarring/Stenosis')
			,(@procType,	'ERS_UpperGIAbnoVarices',		CASE WHEN (Select isnull(Quantity, 0) from ERS_UpperGIAbnoVarices where SiteId = @SiteId) = 1 then 'Varix' ELSE 'Varices' END ,			'Varices')
			,(@procType,	'ERS_UpperGITherapeutics',			'Therapeutic procedure(s)',	'Therapeutic Procedures')
			,(@procType,	'ERS_UpperGISpecimens',			'Specimens taken',	'Specimens Taken')
		END
		ELSE IF @procType IN (13) --Cystoscopy
		BEGIN
			INSERT INTO #QueryDetails VALUES
			(@procType,		'ERS_CystoscopyAbnoBladder',	'Bladder',			'Bladder')
			,(@procType,	'ERS_CystoscopyAbnoProstate',	'Prostate',		    'Prostate')
			,(@procType,	'ERS_CystoscopyAbnoUrethra',	'Urethra',		    'Urethra')
			,(@procType,	'ERS_CystoscopyTherapeutics',	'Therapeutic procedure(s)',	'Therapeutic Procedures')
			,(@procType,	'ERS_CystoscopySpecimens',		'Specimens taken',	'Specimens Taken')
		END
		ELSE IF @procType IN (10,12) --Bronchoscopy, Thoracoscopy
		BEGIN
			INSERT INTO #QueryDetails
			VALUES (
				@procType
				,'ERS_BRTSpecimens'
				,'Specimens taken'
				,'Specimens Taken'
				),
				(
				@procType
				,'ERS_UpperGITherapeutics'
				,'Therapeutic procedure(s)'
				,'Therapeutic Procedures'
				),
				(
				@procType
				,'ERS_BRTAbnoDescriptions'
				,'<strong>Abnormalities</strong>'			
				,''
				)

		END	
		ELSE IF @procType IN (
				11
				) --EBUS			
				BEGIN
					INSERT INTO #QueryDetails
					VALUES (
						@procType
						,'ERS_BRTSpecimens'
						,'Specimens taken'
						,'Specimens Taken'
						),
						(
						@procType
						,'ERS_UpperGITherapeutics'
						,'Therapeutic procedure(s)'
						,'Therapeutic Procedures'
						)
			
					IF @IsLymphNode = 'True'
					BEGIN
						INSERT INTO #QueryDetails
						VALUES 
							(
							@procType
							,'ERS_EBUSAbnoDescriptions'
							,'<strong>Abnormalities</strong>'
							,'EBUS Abnormality Descriptions'
							)
					END
					ELSE
					BEGIN
						INSERT INTO #QueryDetails
						VALUES 
							(
							@procType
							,'ERS_BRTAbnoDescriptions'
							,'<strong>Abnormalities</strong>'
							,''
							)
					END
				END


		DECLARE qry_cursor CURSOR FOR 
		SELECT ProcType, TableName, AbnoNodeName, Identifier FROM #QueryDetails

		OPEN qry_cursor 
		FETCH NEXT FROM qry_cursor INTO @ProcType, @TableName, @AbnoNodeName, @Identifier

		WHILE @@FETCH_STATUS = 0
		BEGIN
			SET @summaryWhole = ''
			SET @none = NULL
			SET @opDiv = '''<table><tr><td style="padding-left:25px;padding-right:50px; font-size:12px;"><span>'' + ' 
			SET @clDiv = ' + ''</span></td></tr></table>'''
			SET @indent = '&nbsp;- ';		SET @br = '<br />'
			SET @opBold = '<b>';			SET @clBold = '</b>'
			SET @fullStop = '.';			SET @colon = ': '
			SET @fldNone = 'None';			SET @emptyStr = ''
		
			IF @TableName = 'ERS_UpperGIAbnoLumen' SET @fldNone = 'NoBlood'
			ELSE IF @TableName = 'ERS_ERCPAbnoIntrahepatic' SET @fldNone = 'NormalIntraheptic'
			ELSE IF @TableName IN ('ERS_ERCPAbnoDuct', 'ERS_ERCPAbnoParenchyma', 'ERS_ERCPAbnoAppearance', 'ERS_ERCPAbnoDiverticulum','ERS_CystoscopyAbnoBladder','ERS_CystoscopyAbnoProstate','ERS_CystoscopyAbnoUrethra','ERS_EBUSAbnoDescriptions') SET @fldNone = 'Normal'
			ELSE SET @fldNone = 'None'
			--Get Summary from respective table
			IF @TableName = 'ERS_Sites'
				BEGIN
					SET @SQLString = 'SELECT @summaryWhole = AdditionalNotes FROM ' + @TableName + '  
								WHERE SiteId =  ' + CONVERT(VARCHAR,@SiteId) + ' AND ISNULL(AdditionalNotes,'''') <> '''' '
					SET @fullStop = @emptyStr
				END
			ELSE
				BEGIN
					SET @SQLString = 'SELECT @summaryWhole = Summary, @none = [' + @fldNone + '] FROM ' + @TableName + '  
								WHERE SiteId =  ' + CONVERT(VARCHAR,@SiteId) + ' AND ISNULL(Summary,'''') <> '''' '
				END
			EXECUTE sp_executesql @SQLString, N'@summaryWhole VARCHAR(MAX) OUTPUT, @none TINYINT OUTPUT', @summaryWhole OUTPUT, @none OUTPUT

			IF @Identifier = 'Therapeutic Procedures' 
			BEGIN
				IF ISNULL(@none,0) = 0 AND LEN(@summaryWhole) > 0
				BEGIN
					SET @fullStop = @emptyStr
					SET @abnoTheraPresent = 1
			END
			ELSE 
			BEGIN
					SET @opDiv = @emptyStr;		SET @clDiv = @emptyStr
					SET @opBold = @emptyStr;	SET @clBold = @emptyStr
			END
			END
			ELSE 
			BEGIN
				IF @Identifier = 'Specimens Taken' 
				BEGIN
					--IF therapeutics present, remove line before specimens
					IF @abnoTheraPresent = 1 SET @br = @emptyStr
				END
				ELSE 
				BEGIN
					SET @opBold = @emptyStr;	SET @clBold = @emptyStr
				END
				SET @opDiv = @emptyStr ;		SET @clDiv = @emptyStr
			END

			IF ISNULL(@summaryWhole,'') <> ''
			BEGIN
				SET @summaryWhole = REPLACE(@summaryWhole,'''','''''')

				--If None is clicked, prefix not required (e.g "Oesophagitis : No Oesophagitis." should be "No Oesophagitis.")
				--Prefix (@AbnoNodeName) is required for Lumen even if None (Blood free) is selected
				IF (ISNULL(@none,0) = 1 OR @AbnoNodeName = '') AND @TableName <> 'ERS_UpperGIAbnoLumen'
				BEGIN	
					SET @AbnoNodeName = '';		SET @colon = ''
				END
				ELSE
				BEGIN
					SET @colon = ': '
				END
		
				SET @tmpSummaryAbno = ' CASE WHEN ''' + @summaryWhole + ''' IN ('''', ''' + @AbnoNodeName + ''') THEN ''' +  @indent + @AbnoNodeName + '' + @fullStop + '''' +
										' ELSE  ''' + @indent + @opBold + @AbnoNodeName + @clBold + @colon + ''' + ' + @opDiv + '''' + @summaryWhole + @fullStop + '''' + @clDiv +
									' END'

				SET @tmpSummaryAbnoLinks = 'CASE WHEN ''' + @summaryWhole + ''' IN ('''', ''' + @AbnoNodeName + ''') THEN ''' +  @indent + @AbnoNodeName + ''' + REPLACE(REPLACE(''' + @htmlAnchorCode + ''',''{0}'',''' + @Identifier + '''),''{1}'',''' + @AbnoNodeName + ''') + ''' + @fullStop + '''' +
											' ELSE  ''' +  @indent + @opBold + @AbnoNodeName + @clBold + @colon + ''' + REPLACE(REPLACE(''' + @htmlAnchorCode + ''',''{0}'',''' + @Identifier + '''),''{1}'',' +  @opDiv + '''' + @summaryWhole + @fullStop + '''' +	 @clDiv +')  ' +
										' END'

			SET @SQLString = 'SELECT ' +
								CASE WHEN @Identifier = 'Specimens Taken'			THEN '@summarySpecimens = @summarySpecimens '
									 WHEN @Identifier = 'Therapeutic Procedures'	THEN '@summaryTherapeutics = @summaryTherapeutics '
									 ELSE '@summaryAbnormalities = @summaryAbnormalities ' END +
											' + ''' + @br  + ''' + '  + @tmpSummaryAbno + ', ' +

								CASE WHEN @Identifier = 'Specimens Taken'			THEN '@summarySpecimensWithHyperLinks = @summarySpecimensWithHyperLinks '
									 WHEN @Identifier = 'Therapeutic Procedures'	THEN '@summaryTherapeuticsWithHyperLinks = @summaryTherapeuticsWithHyperLinks '
									 ELSE '@summaryAbnormalitiesWithHyperLinks = @summaryAbnormalitiesWithHyperLinks ' END +
												' + ''' + @br  + ''' + '  + @tmpSummaryAbnoLinks 						
			--Perform abno check to determine normal procedure
			IF @none = 0  and @TableName <> 'ERS_UpperGISpecimens' AND @AbnormalProcedure <> 1  SET @AbnormalProcedure = 1

			IF @Identifier = 'Specimens Taken'
				EXECUTE sp_executesql @SQLString, N'@summarySpecimens VARCHAR(MAX) OUTPUT,@summarySpecimensWithHyperLinks VARCHAR(MAX) OUTPUT', 
							@summarySpecimens = @summarySpecimens OUTPUT, @summarySpecimensWithHyperLinks=@summarySpecimensWithHyperLinks OUTPUT
			ELSE IF @Identifier = 'Therapeutic Procedures'
				EXECUTE sp_executesql @SQLString, N'@summaryTherapeutics VARCHAR(MAX) OUTPUT,@summaryTherapeuticsWithHyperLinks VARCHAR(MAX) OUTPUT', 
							@summaryTherapeutics = @summaryTherapeutics OUTPUT, @summaryTherapeuticsWithHyperLinks=@summaryTherapeuticsWithHyperLinks OUTPUT
			ELSE
				EXECUTE sp_executesql @SQLString, N'@summaryAbnormalities VARCHAR(MAX) OUTPUT,@summaryAbnormalitiesWithHyperLinks VARCHAR(MAX) OUTPUT', 
							@summaryAbnormalities = @summaryAbnormalities OUTPUT, @summaryAbnormalitiesWithHyperLinks=@summaryAbnormalitiesWithHyperLinks OUTPUT
			END

			FETCH NEXT FROM qry_cursor INTO @ProcType, @TableName, @AbnoNodeName, @Identifier
		END

		CLOSE qry_cursor
		DEALLOCATE qry_cursor

		DROP TABLE #QueryDetails

		if exists(select 1 from ERS_CommonAbnoOther where SiteId = @SiteId)
		BEGIN
			SELECT @summaryAbnormalities = isnull(@summaryAbnormalities, '') + (SELECT STUFF((
																					SELECT ', ' + OA.Summary 
																					FROM ERS_OtherAbnormalities OA
																					JOIN ERS_CommonAbnoOther CAO ON OA.OtherId = CAO.OtherId
																					WHERE CAO.SiteId = @SiteId
																					FOR XML PATH('')), 1, 1, '') Code ),
				 @summaryAbnormalitiesWithHyperLinks = isnull(@summaryAbnormalitiesWithHyperLinks, '') + '<table><tr><td style="padding-right:50px;">- Other:' +
				 REPLACE(REPLACE(REPLACE(@htmlAnchorCode,'''{0}''','Other'),'{1}',
																					(SELECT STUFF((
																					SELECT ', ' + OA.Summary 
																					FROM ERS_OtherAbnormalities OA
																					JOIN ERS_CommonAbnoOther CAO ON OA.OtherId = CAO.OtherId
																					WHERE CAO.SiteId = @SiteId
																					FOR XML PATH('')), 1, 1, '') Code )), '''''', '''')
														+ '</td></tr></table>'
		END
		-- Update the current site's summary
		UPDATE ERS_Sites 
		SET	
			SiteSummary = @summaryAbnormalities,
			SiteSummarySpecimens = @summarySpecimens,
			SiteSummaryTherapeutics = @summaryTherapeutics,
			SiteSummaryWithLinks = @summaryAbnormalitiesWithHyperLinks,
			SiteSummarySpecimensWithLinks = @summarySpecimensWithHyperLinks,
			SiteSummaryTherapeuticsWithLinks = @summaryTherapeuticsWithHyperLinks,
			HasAbnormalities = @AbnormalProcedure
		WHERE 
			SiteId = @siteId

		-- Update the summary of the procedure (all the sites)
		EXEC procedure_summary_update @procId

	END TRY

	BEGIN CATCH
		DECLARE @ErrorMessage NVARCHAR(4000);
		DECLARE @ErrorSeverity INT;
		DECLARE @ErrorState INT;

		SELECT @ErrorMessage = ERROR_MESSAGE(),
			   @ErrorSeverity = ERROR_SEVERITY(),
			   @ErrorState = ERROR_STATE();
    
		RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

		IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
	END CATCH


	IF @@TRANCOUNT > 0 COMMIT TRANSACTION;
END
GO


PRINT N'Altering Procedure [dbo].[usp_NED_Generate_Report]...';


GO

ALTER PROCEDURE [dbo].[usp_NED_Generate_Report]
(
	@ProcedureId AS INT
)
AS
BEGIN
	SET NOCOUNT ON;

/*
	<xs:schema xmlns="https://www.jets.nhs.uk/schema/hospital.sendbatchmessage-version2.xsd" 
	xmlns:mstns="https://www.jets.nhs.uk/schema/hospital.sendbatchmessage-version2.xsd" 
	xmlns:xs="http://www.w3.org/2001/XMLSchema" 
	targetNamespace="https://www.jets.nhs.uk/schema/hospital.sendbatchmessage-version2.xsd" 
	elementFormDefault="qualified" id="SendBatchMessageFile">		

*/
Declare @site AS VARCHAR(50);
DECLARE 
		@description	AS VARCHAR(1000),
		@uniqueid		AS VARCHAR(15),
		@previousLocalProcedureId AS VARCHAR(15),
		@PatientId		AS INT,
		@sessionType	AS VARCHAR(50),
		@operatingHospitalId AS INT,
		@ProcedureTypeId AS INT,
		@ExportFolderPath AS VARCHAR(100);	--## XML Export Folder path.. Set by Admin in the [ERS_SystemConfig] Table

DECLARE @returnXML XML;

	Set @description = 'NED List';
	SELECT @operatingHospitalId = OperatingHospitalId FROM ERS_Procedures WHERE ProcedureId = @ProcedureId;
	SELECT @site = [NED_HospitalSiteCode], @ExportFolderPath=[NED_ExportPath] FROM [dbo].[ERS_SystemConfig] WHERE OperatingHospitalId = @operatingHospitalId;

	SELECT @ProcedureTypeId = ProcedureType,
		   @uniqueid = RIGHT(('00000' + CAST(@ProcedureId AS VARCHAR(6))),6) --## Procedure Id
							+ RIGHT(('0' + CAST(ProcedureType AS VARCHAR(2))),2)  --## Procedure Type; ie: OGD=1/ERCP=2/COLON=3/FLEXI=13
								+ (CASE ProcedureType	WHEN  1 THEN 'o' 
														WHEN  2 THEN 'e'
														WHEN  4 THEN 's' 
														WHEN  3 THEN 'c'
														WHEN  6 THEN 'u'
														WHEN  7 THEN 'u'
														WHEN  8 THEN 'n'
														WHEN  9 THEN 't'
									END)	--## Procedure Letter
		 , @sessionType=Case ListType	When 1 Then 'Service List' 
										When 2 Then 'Adhoc Training List' 
											   Else 'Dedicated Training List' End 
		, @PatientId = PatientId
	From dbo.ERS_Procedures Where ProcedureId=@ProcedureId;


	--## UniqueId is generated- so UPDATE this new value now in the ERS_Procedures Table
	UPDATE dbo.ERS_Procedures
	SET [NEDProcedureId] = @uniqueid
	WHERE ProcedureId=@ProcedureId;

	--## Now get the Previous NED Unique Id- of the same Patient... We know the Patient Id already! Use it!!
	SELECT @previousLocalProcedureId = IsNull([NEDProcedureId], '') 
			 FROM dbo.ERS_Procedures 
			WHERE PatientId = @PatientId AND ProcedureId<@ProcedureId
		 ORDER BY ProcedureID DESC;

	print '@uniqueid: ' + @uniqueid;

SET @returnXML=(
SELECT 
	  @uniqueid											AS '@uniqueId'
	, @description										AS '@description'
	, REPLACE(convert(varchar, p.CreatedOn, 106), ' ', '/')	AS '@date'	--### '10 Oct 2020' ==> '10/Oct/2020'
	, P.ProcedureTime AS '@time'
	, @sessionType										AS '@type'	-- SessionTypeEnum
	, @site												AS '@site'	--## Hospital Code

	/*	##### Procedure info	*/
	, (
	Select 
		  @uniqueid										AS '@localProcedureId'
		, @previousLocalProcedureId						AS '@previousLocalProcedureId'
		, (CASE P.ProcedureType WHEN 1 THEN 'OGD' 
								WHEN 2 THEN 'ERCP' 
								WHEN 3 THEN 'COLON' 
								WHEN 4 THEN 'FLEXI' 
								WHEN 6 THEN 'EUS' 
								WHEN 7 THEN 'EUS' 
								WHEN 8 THEN 'ENT' 
								WHEN 9 THEN 'ENT' 
		   END) AS '@procedureName'
		, Dis.NEDTerm AS '@procedureDiscomfort'	
		, PPDD.NEDTerm AS '@postProcedureDiscomfort' -- **************************** TO DO *********************************
		, dbo.fnNED_ProcedureExtent(@ProcedureId, 0) AS '@extent'	--## OverAll Extent info - EE/ER- whoever has gone Furthest distance!!
		, (CASE WHEN Drug.entonox IS NULL THEN 'No' ELSE 'Yes' END) AS '@entonox'
		, CASE WHEN ISNULL((Select DrugNo from ERS_UpperGIPremedication where ProcedureId = @ProcedureID and DrugNo = -2), 0) = -2 THEN 'Yes' ELSE 'No' END AS '@generalAnaes'
		, convert(varchar, P.StartDateTime, 126) AS '@procedureStartTime'
		, convert(varchar, P.EndDateTime, 126) AS '@procedureEndTime'
		, Ins.NEDTerm AS '@insufflation' 
		, PS.NEDTerm AS '@providerSector'
		, RT.NEDTerm AS '@referrer'
		, CASE WHEN isnull(P.ReferrerTypeOther, '') = '' THEN NULL ELSE P.ReferrerTypeOther END AS '@referrerOther' -- ***************** Only if referrer is 'Other' *******************************
		, PO.NEDTerm AS '@providerOrganisation' 
		, CASE WHEN isnull(P.ProviderOther, '') = '' THEN NULL ELSE P.ProviderOther END AS '@providerOrganisationOther' -- **************** Only if providerOrganisation is 'Other' *************************
		, CASE WHEN P.ChecklistComplete = 0 THEN 'No' ELSE 'Yes' END AS '@checklist' 
		, CASE WHEN PatStat.ListItemText = 'Day patient' THEN 'Inpatient' ELSE PatStat.ListItemText END AS '@admissionType'
		, Urgency.Description AS '@urgencyType' 
		, Ext.NEDTerm AS '@plannedExtent'
		, ISNULL(AIS.NEDTerm, 'None')  AS '@artificialintelligence'
		, CASE WHEN AIS.NEDTerm = 'Other' THEN PAIS.AISoftwareOther ELSE NULL END AS '@artificialintelligenceOther' -- **************** Only if artificialintelligence is 'Other' *************************
		, CASE WHEN PAIS.AISoftwareName IS NULL OR AIS.NEDTerm = 'None' THEN NULL ELSE PAIS.AISoftwareName END AS '@nameOfAISoftware' -- **************** Only if artificialintelligence is NOT 'None' *************************
		, CASE WHEN CHARINDEX('.00',P.Points,0) > 0 THEN convert(varchar(10), convert(int, P.Points)) ELSE convert(varchar(10), P.Points) END AS '@procedurePoints'


		/*	##### Patient Info	*/		
		, (CASE Pat.Gender WHEN 'Not Known' THEN 'Other' WHEN 'Not Specif' THEN 'Other' ELSE Pat.Gender END)		AS 'patient/@gender'
		, (0+ FORMAT(getdate(),'yyyyMMdd') - FORMAT(Pat.DateOfBirth,'yyyyMMdd') ) /10000 AS 'patient/@age'


		/*	##### Drugs	*/
		, CASE WHEN CHARINDEX('.00',IsNull(Drug.pethidine,0),0) > 0 THEN convert(varchar(10), convert(int,IsNull(Drug.pethidine,0))) ELSE CONVERT(varchar(10),IsNull(Drug.pethidine,0)) END	As 'drugs/@pethidine'	--## Required
		, CASE WHEN CHARINDEX('.00',IsNull(Drug.midazolam,0),0) > 0 THEN convert(varchar(10), convert(int,IsNull(Drug.midazolam,0))) ELSE CONVERT(varchar(10),IsNull(Drug.midazolam,0)) END	As 'drugs/@midazolam'	--## Required
		, CASE WHEN CHARINDEX('.00',IsNull(Drug.fentanyl,0),0) > 0 THEN convert(varchar(10), convert(int,IsNull(Drug.fentanyl,0))) ELSE CONVERT(varchar(10),IsNull(Drug.fentanyl,0))	END As 'drugs/@fentanyl'	--## Required
		, CASE WHEN CHARINDEX('.00',IsNull(Drug.buscopan,0),0) > 0 THEN convert(varchar(10), convert(int,IsNull(Drug.buscopan,0))) ELSE CONVERT(varchar(10),IsNull(Drug.buscopan,0))	END As 'drugs/@buscopan'	--## Required
		, CASE WHEN CHARINDEX('.00',IsNull(Drug.remimazolam,0),0) > 0 THEN convert(varchar(10), convert(int,IsNull(Drug.remimazolam,0))) ELSE CONVERT(varchar(10),IsNull(Drug.remimazolam,0))	END As 'drugs/@remimazolam'	--## Required
		, CASE WHEN IsNull(Drug.propofol, 0) = 0 THEN 'No' ELSE	'Yes' END			As 'drugs/@propofol'	--## YesNo
		, ISNULL(Drug.noDrugsAdministered, 'Yes')	As 'drugs/@noDrugsAdministered'


		/*	##### Staff.Members: 1 Procedure to MANY staff.. So - need a SQL Subquery- to return a RecordSet		*/
		,(
			SELECT 
			  Staff.professionalBodyCode AS '@professionalBodyCode'
			, Staff.EndoscopistRole		AS '@endoscopistRole'
			, Staff.ProcedureRole		AS '@procedureRole'	-- ProcedureRoleTypeEnum
			, Staff.Extent				AS '@extent'
			, CASE Staff.[jManoeuvre] WHEN 1 THEN 'Yes' WHEN 0 THEN 'No' ELSE NULL END 	AS '@jManoeuvre'	-- Opt -- Mandatory for OGD, Colon and Flexi procedures (Rectal retroversion)
			/*	##### Therapeutic = Sesion->Procedure-> Staff.members-> Staff-> Therapeutic; 1 [Staff] to Many [Therapeutic sessions]	*/
			, (
				Select * from (select 
					   T.NedName	AS '@type'	-- M	--## The type of therapeutic procedure.
					 , CASE WHEN rc.RegionId IS NULL THEN T.[Site] ELSE 'Ileo-colon anastomosis' END		AS '@site'	-- O -- BiopsyEnum  --## The location where the therapeutic procedure was performed.
					 , ISNULL(T.EndoRole, Staff.ProcedureRole) AS '@role' -- O	-- ProcedureRoleTypeEnum
					 , T.polypSize	AS '@polypSize' -- O	-- PolypSizeEnum --## The size of polyp (if found) -> is ONLY for COLON/FLEXI
					 , T.PolypSizeInt AS '@polypSizeInteger'  
					 , T.Detected AS '@observed' 
					 , T.Tattooed	AS '@tattooed'	-- O	-- TattooEnum
					 , sum(T.Performed)	AS '@performed'	-- M	-- REQUIRED; INT	-- ## Number performed
					 , sum(T.Successful)	AS '@successful' -- M	-- REQUIRED; INT -- Number of successful
					 , sum(T.Retrieved)	AS '@retrieved'	-- O	-- INT	-- ## Number of Polyp retrieved -> is ONLY for COLON/FLEXI
					 , T.comment 	AS '@comment'	-- O	--## Use this field to define what Other is when selected.
					 , T.Morphology AS '@morphology' -- **************************** TO DO *********************************

				FROM dbo.tvfNED_ProcedureTherapeutic(P.ProcedureType, @ProcedureId, Staff.ConsultantTypeId) AS T --## Which Consultant's Record in the Procedure?
					LEFT JOIN dbo.ERS_Sites ES ON es.SiteId = T.SiteId
					LEFT JOIN tvfProcedureResectedColon(@ProcedureId) RC ON RC.RegionId = ES.RegionId
				group by T.SiteId,T.NedName, 
						CASE WHEN rc.RegionId IS NULL THEN T.[Site] ELSE 'Ileo-colon anastomosis' END,
						T.EndoRole,
						T.polypSize,
						T.PolypSizeInt,
						T.Detected,
						T.Tattooed, 
						T.comment,
						T.Morphology) as a
				FOR XML PATH('therapeutic'), ROOT('therapeutics'), TYPE
			)/* End of: Therapeutic List- for a Staff Member		*/
			FROM dbo.tvfNED_ProcedureConsultants(@ProcedureId, P.ProcedureType) AS Staff
			WHERE Staff.EndosId > 0
			FOR XML PATH('Staff'), ROOT('staff.members'), TYPE
		)
			/*	##### Indications: -- 1 or Many	*/		
			, (
				SELECT 
					  dbo.HTMLDecode(I.NedTerm) As '@indication'
					, I.Comment AS '@comment'
					, I.elevatedCalprotectinValue AS '@elevatedCalprotectinValue' -- When indication is Elevated calprotectin then specify the value in (micrograms/gram)
					FROM dbo.tvfNED_ProcedureIndication(@ProcedureId) AS I
					FOR XML PATH('indication'), ROOT('indications'), TYPE
			)
			/*	##### subIndications: -- 0 or Many	*/	
			, (
				SELECT 
					  I.NedTerm As '@type'
					, I.Comment AS '@comment'
					FROM dbo.tvfNED_ProcedureSubIndication(@ProcedureId) AS I
					FOR XML PATH('subIndication'), ROOT('subIndications'), TYPE
			)
			
			/*	##### Limitations: */
			,(
				Select 	
					  L.Limitation As '@limitation'
					, L.Comment As '@comment'
				from [dbo].[tvfNED_ProcedureLimitation](P.ProcedureType, @ProcedureId) AS L
					FOR XML PATH('limitation'), ROOT('limitations'), TYPE
			)	

			/*	##### Biopsy: 0 or Many		*/ --## For Colon/Flexi/OGD
			, (	SELECT 
						  B.BiopsySite		AS '@biopsySite'
						, B.NumberPerformed AS '@numberPerformed'
					FROM [dbo].[tvfNED_ProcedureBiopsy](p.ProcedureType, @ProcedureId) AS B				
					 FOR XML PATH('biopsy'), ROOT('biopsies'), TYPE
			)
			/*	##### Diagnoses: 1 or Many		*/ 
			, (	SELECT 
						  D.Ned_Name	AS '@diagnosis'
						, D.tattooed	AS '@tattooed'
						, CASE WHEN RIGHT(D.Site,2) = ', '
							THEN (LEFT(D.Site, LEN(D.Site)-1))
							ELSE  D.Site END		AS '@site'
						, CASE WHEN RIGHT(D.Comment,2)=', ' 
							THEN (LEFT(D.Comment, LEN(D.Comment)-1)) 
							ELSE D.Comment END
									AS '@comment'	--## Remove the extra ',' at the end!
						,D.barrettsLengthCircumferential as '@barrettsLengthCircumferential' --Required for diagnosis of Barretts
						,D.barrettsLengthMaximum AS '@barrettsLengthMaximum'--, barrettsLengthMaximum --Required for diagnosis of Barretts
						,D.barretsInspectionTime AS '@barretsInspectionTime'--, barretsInspectionTime --Required for diagnosis of Barretts
						,D.gastricInspectiontime AS '@gastricInspectionTime'--, gastricInspectiontime --Required if diagnosis of gastric atrophy OR gastric intestinal metaplasia
						,D.oesophagitisLaClassification AS '@oesophagitisLAClassification'--, oesophagitisLaClassification --Required if diagnosis of Oesophagitis - reflux
						,D.DICAScore AS '@DICAScore'--, DICAScore --required if diagnosis of Diverticulosis
						,D.UCEIS AS '@UCEIS'--, UCEIS --If diagnosis is Ulcerative Colitis either UCEIS or Mayo scores must be provided
						,D.mayoScore AS '@mayoScore'--, mayoScore --If diagnosis is Ulcerative Colitis either UCEIS or Mayo scores must be provided
						--, site --If diagnosis is Crohns Colitis or Crohn`s- terminal ileum and [ExtentLookup]= Neo-terminal ileum
						,NULLIF(RutgeertsScore,'') AS '@rutgeertsScore' --If diagnosis is Crohns Colitis or Crohn`s- terminal ileum and [ExtentLookup]= Neo-terminal ileum
						, CDEIS AS '@CDEIS' --If diagnosis is Crohns Colitis or Crohn`s- terminal ileum
					FROM [dbo].[tvfNED_Diagnoses](p.ProcedureType, @ProcedureId) AS D
					 FOR XML PATH('diagnose'), ROOT('diagnoses'), TYPE
			)
			/*	##### Adverse events: -- 1 or Many	*/
			,(	SELECT 
					  IsNull(AD.adverseEvent,'None')	As '@adverseEvent'
					, (CASE WHEN AD.adverseEvent = 'Other' THEN AD.Comment END) 						As '@comment'
				FROM dbo.tvfNED_ProcedureAdverseEvents(@ProcedureId)		AS AD
				FOR XML PATH('adverse.event'), ROOT('adverse.events'), TYPE			
			)
			, ( Select * from (Select isnull(scog.NEDTerm, 'other') as '@manufacturerGeneration'
						, CASE WHEN scog.NEDTerm IS NULL THEN scog.Description ELSE NULL END as '@other'
				from ERS_Scopes sco
				join ERS_Procedures p on p.Instrument1 = sco.ScopeId
				join ERS_ScopeGenerations scog on sco.ScopeGenerationId = scog.UniqueId
				where p.ProcedureId = @ProcedureId
				union
				Select isnull(scog.NEDTerm, 'other') as '@manufacturerGeneration'
						, CASE WHEN scog.NEDTerm IS NULL THEN scog.Description ELSE NULL END as '@other'
				from ERS_Scopes sco
				join ERS_Procedures p on p.Instrument2 = sco.ScopeId
				join ERS_ScopeGenerations scog on sco.ScopeGenerationId = scog.UniqueId
				where p.ProcedureId = @ProcedureId) as a
				FOR XML PATH('scopes'), ROOT('scopes'), TYPE
			   )
			 , (
				SELECT ISNULL(C.NEDTerm, 'other') as '@type', 
				(CASE WHEN C.NEDTerm = 'Other' THEN PC.AdditionalInfo END) 						As '@comment'

				 FROM ERS_Chromendoscopies C 
				 join ERS_ProcedureChromendosopy PC on C.UniqueId = PC.ChromendoscopyId
				 WHERE PC.ProcedureId = @ProcedureId 
				 FOR XML PATH('chromendoscopy'), ROOT('chromendoscopies'), TYPE
				) 
				 ,( 
					SELECT CASE 
						WHEN @ProcedureTypeId = 1 THEN
							(SELECT DISTINCT * FROM (SELECT 
								CASE WHEN (SELECT COUNT(*) FROM ERS_UpperGIPremedication WHERE DrugName = 'Pharyngeal Anaesthesia' AND ProcedureId = @ProcedureId) = 1 THEN 'Yes' ELSE 'No' END as '@pharyngealAnaes'
								,pe.WithdrawalMins as '@scopeWithdrawalTime'
								,ISNULL(DA.NEDTerm,'None') as '@distalAttachment'
								,CASE WHEN LOWER(DA.NEDTerm) = 'other' THEN PD.AdditionalInfo ELSE NULL END as '@distalAttachmentOther'
								,CASE WHEN p.Transnasal = 1 THEN 'Nasal' ELSE 'Oral' END as '@OGDRoute'
								,V.NEDTerm as '@OGDMucosalVisualisation'
								,CASE WHEN (SELECT COUNT(*) FROM ERS_ProcedureMucosalCleaning WHERE ProcedureId = @ProcedureId) > 1 THEN 'Other' ELSE ISNULL(C.NEDTerm, 'None') END as '@OGDMucosalCleaning'
								,CASE WHEN (SELECT COUNT(*) FROM ERS_ProcedureMucosalCleaning WHERE ProcedureId = @ProcedureId) > 1 THEN dbo.fnNED_MucosalCleaning(@ProcedureId) WHEN LOWER(C.NEDTerm) = 'other' THEN C.Description ELSE NULL END as '@OGDMucosalCleaningOther'
								,CASE WHEN P.FormerProcedureId IS NOT NULL THEN 'Yes' WHEN (SELECT COUNT(*) FROM ERS_Procedures pq WHERE pq.FormerProcedureId = p.ProcedureId) > 0 THEN 'Yes' ELSE 'No' END as '@dualProcedure'
								,CASE WHEN dbo.fnNED_GetOGDPhotoDocumentation(@ProcedureId) = 1 THEN 'Yes' ELSE 'No' END '@photoDocumentation'
								from ERS_Procedures AS P 
									LEFT JOIN ERS_ProcedureMucosalVisualisation PV ON PV.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_MucosalVisualisation V ON V.UniqueId = PV.MucosalVisualisationId
									LEFT JOIN ERS_ProcedureUpperExtent PE ON PE.ProcedureId = P.ProcedureId AND PE.WithdrawalMins IS NOT NULL /*there may be more than 1 record in the table where there's 2 endos on a procedure*/
									LEFT JOIN ERS_ProcedureDistalAttachment PD ON PD.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_DistalAttachments DA ON DA.UniqueId = PD.DistalAttachmentId
									LEFT JOIN ERS_ProcedureMucosalCleaning PC ON PC.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_MucosalCleaning C ON C.UniqueId = PC.MucosalCleaningId
								Where P.ProcedureId=@ProcedureId) ogd
							FOR XML PATH('OGD'),TYPE)
						WHEN @ProcedureTypeId = 2 THEN
							(SELECT * FROM (SELECT DISTINCT 
								CASE WHEN (SELECT COUNT(*) FROM ERS_UpperGIPremedication WHERE DrugName = 'Pharyngeal Anaesthesia' AND ProcedureId = @ProcedureId) = 1 THEN 'Yes' ELSE 'No' END as '@pharyngealAnaes'
								,CASE WHEN (SELECT COUNT(*) FROM ERS_UpperGIPremedication WHERE DrugName = 'Prophylactic Antibiotics' AND ProcedureId = @ProcedureId) = 1 THEN 'Yes' ELSE 'No' END as '@antibioticGiven'
								,NULLIF(CASE WHEN ((ev.IntendedBileDuct = 1 AND ev.MajorPapillaBile = 1) OR (ev.IntendedBileDuct_ER = 1 AND ev.MajorPapillaBile_ER = 1)) OR
												  ((ev.IntendedPancreaticDuct = 1 AND ev.MajorPapillaPancreatic = 1) OR (ev.IntendedPancreaticDuct_ER = 1 AND ev.MajorPapillaPancreatic_ER = 1)) THEN 'Yes' 
											 WHEN ((ev.IntendedBileDuct = 1 AND ev.MajorPapillaBile <> 1) OR (ev.IntendedBileDuct_ER = 1 AND ev.MajorPapillaBile_ER <> 1)) OR
												  ((ev.IntendedPancreaticDuct = 1 AND ev.MajorPapillaPancreatic <> 1) OR (ev.IntendedPancreaticDuct_ER = 1 AND ev.MajorPapillaPancreatic_ER <> 1)) THEN 'No'
											ELSE 'Not Applicable' END,'') as '@successfulCannulation'
								,ISNULL((SELECT MAX(ISNULL(convert(int, d.StonesSize),0)) FROM ERS_ERCPAbnoDuct d INNER JOIN ERS_Sites s ON S.SiteId = d.SiteId WHERE S.ProcedureId = @ProcedureId),0) AS '@sizeLargestStone'
								--,ISNULL(CASE WHEN ExtractionOutcome = 1 THEN CONVERT(varchar(max),'Yes') 
								--       WHEN ExtractionOutcome <> 0 THEN CONVERT(varchar(max),'No') END,'Not Applicable') AS '@completeStoneClearance'
								,ISNULL((SELECT TOP 1 CASE WHEN ISNULL(ExtractionOutcome,0) = 1 THEN convert(varchar(max),'Yes') 
											  WHEN StoneRemoval = 0 or ExtractionOutcome <> 1 THEN 'No' END 
								 FROM dbo.ERS_ERCPTherapeutics ET WHERE SiteId IN (SELECT SiteId FROM ERS_Sites WHERE ProcedureId = @ProcedureId)),'Not Applicable') as '@completeStoneClearance'
								,ISNULL((SELECT CASE WHEN LOWER(Region) LIKE '%hepatic%' THEN convert(varchar(max), 'Yes') ELSE convert(varchar(max), 'No') END
											FROM ERS_ERCPAbnoDuct eed 
											INNER JOIN dbo.ERS_Sites es ON eed.SiteId = es.SiteId
												INNER JOIN dbo.ERS_Regions er ON es.RegionId = er.RegionId
											WHERE es.ProcedureId = @ProcedureId AND Stricture = 1),convert(varchar(max), 'Not Applicable')) AS '@extraHepaticStricture'
								,ISNULL((SELECT CASE WHEN eed.Stricture = 1 AND eug.BrushCytology = 1 THEN convert(varchar(max),'Yes') WHEN eed.Stricture = 1 AND eug.BrushCytology = 0 THEN convert(varchar(max),'No') WHEN eed.Stricture = 0 THEN 'Not Applicable' END 
										 FROM ERS_ERCPAbnoDuct eed 
												INNER JOIN dbo.ERS_Sites es ON eed.SiteId = es.SiteId
												INNER JOIN dbo.ERS_Regions er ON es.RegionId = er.RegionId
												INNER JOIN dbo.ERS_UpperGISpecimens eug ON es.SiteId = eug.SiteId
											WHERE es.ProcedureId = @ProcedureId AND
												LOWER(Region) LIKE '%hepatic%'),convert(varchar(max),'Not Applicable')) AS '@extrahepaticStrictureCytologyHistologyTaken'
								,ISNULL((SELECT CASE WHEN eug.CorrectStentPlacement = 1 OR ert.CorrectStentPlacement = 1 THEN convert(varchar(max),'Yes') ELSE convert(varchar(max),'No') END
											FROM ERS_ERCPAbnoDuct eed 
												INNER JOIN dbo.ERS_Sites es ON eed.SiteId = es.SiteId
												INNER JOIN dbo.ERS_Regions er ON es.RegionId = er.RegionId
												LEFT JOIN dbo.ERS_UpperGITherapeutics eug ON es.SiteId = eug.SiteId
												LEFT JOIN dbo.ERS_ERCPTherapeutics ert ON es.SiteId = ert.SiteId
											WHERE es.ProcedureId = @ProcedureId AND eed.Stricture = 1 AND eug.StentInsertion = 1 AND
												LOWER(Region) LIKE '%hepatic%'),convert(varchar(max),'Not Applicable')) AS '@extrahepaticStrictureStentSuccessfullyPlaced'
								,CASE WHEN ISNULL(eea.MajorBilrothRoux,0) = 1 THEN 'Yes' ELSE 'No' END AS '@previousSurgeryBilrothRoux'
								,NULLIF(lc.NEDTerm,0) AS '@levelOfComplexity'
								,CASE WHEN (SELECT COUNT(*) FROM ERS_UpperGIPremedication WHERE DrugName = 'Prophylactic Rectal NSAIDS' AND ProcedureId = @ProcedureId) = 1 THEN 'Yes' ELSE 'No' END as '@prophylacticRectalNSAIDS'
								,CASE WHEN eea.MinorSiteLocation IN (1,2) THEN 'No' ELSE 'Yes' END AS '@nativePapilla'
								from ERS_Procedures AS P 
									LEFT JOIN (SELECT eed.AbnoDuctId, es.ProcedureId, eed.Stricture, er.Region 
												FROM ERS_ERCPAbnoDuct eed 
													INNER JOIN dbo.ERS_Sites es ON eed.SiteId = es.SiteId
													INNER JOIN dbo.ERS_Regions er ON es.RegionId = er.RegionId
											WHERE es.ProcedureId = @ProcedureId AND
												LOWER(Region) LIKE '%hepatic%')  ercs ON ercs.ProcedureId = P.ProcedureId
									LEFT JOIN (SELECT Stones, ISNULL(t.ExtractionOutcome,0) ExtractionOutcome, es.ProcedureId 
												FROM ERS_ERCPAbnoDuct a
													 INNER JOIN dbo.ERS_Sites es ON a.SiteId = es.SiteId
													 LEFT JOIN ERS_ERCPTherapeutics t ON t.siteId = a.SiteId
												 WHERE a.Stones = 1) estones ON estones.ProcedureId = P.ProcedureId
									LEFT JOIN dbo.ERS_ERCPPapillaryAnatomy eea ON P.ProcedureId = eea.ProcedureId
									LEFT JOIN dbo.ERS_Visualisation ev ON P.ProcedureId = ev.ProcedureID
									LEFT JOIN dbo.ERS_ProcedureLevelOfComplexity cl ON cl.ProcedureId = P.ProcedureId
									LEFT JOIN dbo.ERS_LevelOfComplexity lc ON lc.UniqueId = cl.ComplexityId
								Where P.ProcedureId=@ProcedureId) ercp
							FOR XML PATH('ERCP'),TYPE) 
						WHEN @ProcedureTypeId = 3 THEN
							(SELECT TOP 1 * FROM (SELECT 
								(SELECT ISNULL(SUM(Detected),0) FROM tvfNED_PolypsDetailsView(@ProcedureTypeId, @ProcedureId)) as '@polypsDetected'
								,CASE WHEN p.ScopeGuide = 1 THEN 'Yes' ELSE 'No' END AS '@magneticEndoscopeImagerUsed'
								,LE.WithdrawalMins AS '@scopeWithdrawalTime'
								,CASE WHEN LE.RectalExamPerformed = 1 THEN 'Yes' ELSE 'No' END AS '@digitalRectalExamination'
								,CONVERT(VARCHAR(19),LE.CaecumIntubationStart, 126) AS '@caecumTime'
								,ISNULL(DA.NEDTerm,'None') as '@distalAttachment'
								,NULLIF(CASE WHEN LOWER(DA.NEDTerm) = 'other' THEN PD.AdditionalInfo ELSE '' END,'') as '@distalAttachmentOther'
								,IT.NEDTerm as '@insertionTechnique'
								,PB.LeftPrepScore as '@bowelPrepLeft'
								,PB.RightPrepScore as '@bowelPrepRight'
								,PB.TransversePrepScore as '@bowelPrepTransverse'
								,PB.TotalPrepScore as '@bowelPrepTotal'
								,ISNULL(B.NEDTerm,'None') as '@bowelPrep'
								,NULLIF(CASE WHEN LOWER(B.NEDTerm) = 'other' THEN B.[Description] ELSE '' END,'') as '@bowelPrepOther'
								,CASE WHEN P.FormerProcedureId IS NOT NULL THEN 'Yes' WHEN (SELECT COUNT(*) FROM ERS_Procedures pq WHERE pq.FormerProcedureId = p.ProcedureId) > 0 THEN 'Yes' ELSE 'No' END as '@dualProcedure'
								,CASE WHEN NULLIF(fit.FITValue,'') IS NOT NULL THEN fit.FITValue END AS '@fitValue'
								,CASE WHEN fit.FITNotKnownId IS NOT NULL THEN fnk.NEDTerm END AS '@fitNotKnown'
								FROM ERS_Procedures AS P 
									LEFT JOIN ERS_ProcedureLowerExtent LE ON LE.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_ProcedureDistalAttachment PD ON PD.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_DistalAttachments DA ON DA.UniqueId = PD.DistalAttachmentId
									LEFT JOIN ERS_ProcedureInsertionTechnique PIT ON PIT.ProcedureId = p.ProcedureId
									LEFT JOIN ERS_InsertionTechniques IT ON IT.UniqueId = PIT.InsertionTechniqueId
									LEFT JOIN ERS_ProcedureBowelPrep PB ON PB.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_BowelPrep B ON B.UniqueId = PB.BowelPrepId
									LEFT JOIN ERS_ProcedureFITValue fit ON fit.ProcedureId = p.ProcedureId
									LEFT JOIN ERS_FitNotKnownReasons fnk ON fnk.UniqueId = fit.FITNotKnownId
								Where P.ProcedureId=@ProcedureId) col
							FOR XML PATH('Colon'),TYPE)
						WHEN @ProcedureTypeId = 4 THEN
							(SELECT * FROM (SELECT 
								(SELECT ISNULL(SUM(Detected),0) FROM tvfNED_PolypsDetailsView(@ProcedureTypeId, @ProcedureId)) as '@polypsDetected'
								,CASE WHEN LE.RectalExamPerformed = 1 THEN 'Yes' ELSE 'No' END AS '@digitalRectalExamination'
								,CASE WHEN p.ScopeGuide = 1 THEN 'Yes' ELSE 'No' END AS '@magneticEndoscopeImagerUsed'
								,ISNULL(DA.NEDTerm,'None') as '@distalAttachment'
								,CASE WHEN LOWER(DA.NEDTerm) = 'other' THEN PD.AdditionalInfo ELSE NULL END as '@distalAttachmentOther'
								,IT.NEDTerm as '@insertionTechnique'
								,PB.LeftPrepScore as '@bowelPrepLeft'
								,PB.TransversePrepScore as '@bowelPrepTransverse'
								,PB.RightPrepScore as '@bowelPrepRight'
								,PB.TotalPrepScore as '@bowelPrepTotal'
								,ISNULL(B.NEDTerm,'None') as '@bowelPrep'
								,CASE WHEN LOWER(B.NEDTerm) = 'other' THEN B.[Description] ELSE NULL END as '@bowelPrepOther'
								,CASE WHEN fit.FITValue IS NOT NULL THEN fit.FITValue END AS '@fitValue'
								,CASE WHEN fit.FITNotKnownId IS NOT NULL THEN fnk.NEDTerm END AS '@fitNotKnown'
								FROM ERS_Procedures AS P 
									LEFT JOIN (Select ProcedureId, Max(CONVERT(int,RectalExamPerformed)) as RectalExamPerformed from ERS_ProcedureLowerExtent group by ProcedureId) LE ON LE.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_ProcedureDistalAttachment PD ON PD.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_DistalAttachments DA ON DA.UniqueId = PD.DistalAttachmentId
									LEFT JOIN ERS_ProcedureInsertionTechnique PIT ON PIT.ProcedureId = p.ProcedureId
									LEFT JOIN ERS_InsertionTechniques IT ON IT.UniqueId = PIT.InsertionTechniqueId
									LEFT JOIN ERS_ProcedureBowelPrep PB ON PB.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_BowelPrep B ON B.UniqueId = PB.BowelPrepId
									LEFT JOIN ERS_ProcedureFITValue fit ON fit.ProcedureId = p.ProcedureId
									LEFT JOIN ERS_FitNotKnownReasons fnk ON fnk.UniqueId = fit.FITNotKnownId
								Where P.ProcedureId=@ProcedureId) flexi
							FOR XML PATH('Flexi'),TYPE)  
						WHEN @ProcedureTypeId IN (6,7) THEN
							(SELECT * FROM (SELECT DISTINCT CASE WHEN pm.DrugName = '' THEN 'Yes' ELSE 'No' END AS '@prophylacticAntibioticsBeforeEUS',
												ISNULL(dbo.fnNED_FNAFNBSolidLesions(@ProcedureId, P.ProcedureType),'Not applicable') AS '@FNAorFNBSolidLesions',
												ISNULL(dbo.fnNED_FNAFNBTissueAdequacy(@ProcedureId),'Not Applicable') AS '@FNAorFNBTissueAdequacy'
											FROM ERS_UpperGIPremedication pm
												LEFT JOIN ERS_Sites s ON s.ProcedureId = pm.ProcedureId
												LEFT JOIN ERS_UpperGITherapeutics T ON S.SiteId = T.SiteId
												LEFT JOIN ERS_UpperGISpecimens AS SP  ON SP.SiteId = S.SiteId
												LEFT JOIN ERS_ERCPTherapeutics ET ON ET.SiteId = S.SiteId
											WHERE pm.ProcedureId = @ProcedureId) eushpb
								FOR XML PATH('EUS'),TYPE)  
						WHEN @ProcedureTypeId IN (8,9) THEN
							 (SELECT * FROM (SELECT DISTINCT 
								 (SELECT ISNULL(SUM(Detected),0) FROM tvfNED_PolypsTotalsView(@ProcedureId)) AS '@polypsDetected'
								 ,ISNULL(DA.NEDTerm,'None') as '@distalAttachment'
								 ,CASE WHEN LOWER(DA.NEDTerm) = 'other' THEN PDA.AdditionalInfo ELSE NULL END as '@distalAttachmentOther'
								 ,ISNULL(ET.NEDTerm,'None') as '@enteroscopyTechnique'
								 ,CASE WHEN LOWER(ET.NEDTerm) = 'other' THEN PET.AdditionalInfo ELSE NULL END as '@enteroscopyTechniqueOther'
								 ,PID.InsertionLength AS '@depthOfInsertion'
								 ,CASE PID.Tattooed WHEN 1 THEN 'Yes' WHEN 0 THEN 'No' ELSE 'Not Applicable' END AS '@tattooMaxDepthInsertion'
								 ,CASE WHEN PE.RectalExamPerformed = 1 AND ET.NEDTerm IN ('Single balloon anal','Double balloon anal') THEN 'Yes' ELSE 'No' END AS '@digitalRectalExamination'
									FROM ERS_Procedures AS P 
										LEFT JOIN ERS_ProcedureDistalAttachment PDA ON PDA.ProcedureId = P.ProcedureId
										LEFT JOIN ERS_DistalAttachments DA ON DA.UniqueId = PDA.DistalAttachmentId
										LEFT JOIN ERS_ProcedureEnteroscopyTechniques PET ON PET.ProcedureId = P.ProcedureId
										LEFT JOIN ERS_EnteroscopyTechniques ET ON ET.UniqueId = PET.TechniqueId
										LEFT JOIN ERS_ProcedureInsertionDepth PID ON PID.ProcedureId = P.ProcedureId
										LEFT JOIN ERS_ProcedureLowerExtent PE ON PE.ProcedureId = P.ProcedureId
									Where P.ProcedureId=@ProcedureId) ent
								FOR XML PATH('ENT'),TYPE)
					END
				  )
		from ERS_Procedures AS P 
		Where P.ProcedureId=@ProcedureId
		FOR XML PATH('procedure'), ROOT('procedures'), TYPE
		)	

    FROM dbo.ERS_Procedures AS P
    LEFT join dbo.ERS_ProcedureDiscomfortScore as DisNo on P.ProcedureId = DisNo.ProcedureId
    LEFT Join dbo.ERS_DiscomfortScores as Dis on DisNo.DiscomfortScoreId = Dis.UniqueId
	LEFT join dbo.ERS_PostProcedureDiscomfortScore PPD on PPD.ProcedureId = P.ProcedureId 
	LEFT join dbo.ERS_DiscomfortScores as PPDD on PPD.DiscomfortScoreId = PPDD.UniqueId
	Left join dbo.ers_lists as PatStat on PatStat.ListDescription = 'Patient Status' and PatStat.ListItemNo = P.PatientStatus 
	Left Join dbo.ERS_UrgencyTypes as Urgency on P.CategoryListId = Urgency.UniqueId
	Left join dbo.ERS_ProcedurePlannedExtent as PPE on P.ProcedureId = PPE.ProcedureId 
	Left Join dbo.ERS_Extent as Ext on PPE.ExtentId = Ext.UniqueId 
	Left join dbo.ERS_ProcedureInsufflation as PIns on P.ProcedureId = PIns.ProcedureId
	Left Join dbo.ERS_Insufflation as Ins on PIns.InsufflationId = Ins.UniqueId 
	Left Join dbo.ERS_ProviderSectors as PS on P.PatientType = PS.UniqueId 
	Left Join dbo.ERS_ReferrerTypes as RT on P.ReferrerType = RT.UniqueId 
	Left join dbo.ERS_ProviderOrganisation as PO on P.ProviderTypeId = PO.UniqueId 
	Left Join dbo.ERS_ProcedureAISoftware as PAIS on P.ProcedureId = PAIS.ProcedureId 
	Left Join dbo.ERS_AISoftware as AIS on PAIS.AISoftwareId = AIS.UniqueId 
	Left Join dbo.ERS_ProcedureChromendosopy as PCHR on PCHR.ProcedureId = p.ProcedureId


  INNER JOIN dbo.ERS_VW_Patients			AS Pat  ON P.PatientId=Pat.[PatientId]
   LEFT JOIN dbo.tvfNED_ProcedureDrugList(@ProcedureId)	AS Drug		ON P.ProcedureId = Drug.ProcedureId	
   --LEFT JOIN dbo.ERS_UpperGIQA				AS QA   ON P.ProcedureId = QA.ProcedureId	-- Patient DIscomfort
   LEFT JOIN dbo.ERS_BowelPreparation		AS BP   ON P.ProcedureId=BP.ProcedureID	-- DIscomfort for Nurse
   LEFT JOIN dbo.ERS_ColonExtentOfIntubation   EL	ON P.ProcedureId = EL.ProcedureId
	   where P.ProcedureId= @ProcedureId
		 for XML PATH ('session'), ROOT('hospital.SendBatchMessage'), ELEMENTS
);

DECLARE   @xmlFileName AS varchar(100)
		, @ReportDate AS VARCHAR(10)
		, @ReportTime AS VARCHAR(8)
		, @xmlPreviousExportFileName AS VARCHAR(100);

SELECT    @ReportDate = CONVERT(VARCHAR(10), CreatedOn, 103)
		, @ReportTime = CONVERT(VARCHAR(8), ModifiedOn, 108) 
FROM dbo.ERS_Procedures WHERE ProcedureId=@ProcedureId;

--== Check whether Admin has added/removed the '\' at the end of the Path.. 
SET @ExportFolderPath = (CASE WHEN RIGHT(@ExportFolderPath, 1)='\' THEN @ExportFolderPath ELSE (@ExportFolderPath + '\') END);

SELECT top 1 @xmlPreviousExportFileName = xmlFileName FROM [dbo].[ERS_NedFilesLog] WHERE ProcedureId=@ProcedureId ORDER BY [LogId] desc;

--### File Path and Name example: 'NED_xml_output\74_22-09-2017_09-32-53_00831101o.xml' vs '99_19-10-2017_16-24-16_00205602e.xml'
SET @xmlFileName =    @ExportFolderPath 
					+ @site + '_' 
					+ replace(@ReportDate, '/', '-') + '_' 
					+ replace(@ReportTime, ':', '-') + '_' 
					+ @uniqueid	
					+ '.xml';					

SELECT @returnXML AS returnXML
				 , '<hospital.SendBatchMessage xmlns:xsd="http://www.w3.org/2001/XMLSchema"'
				  + 
				 ' xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"'
				  +
				 ' xmlns="https://www.jets.nhs.uk/schema/hospital.sendbatchmessage-version2.xsd"'
				  +
				 ' softwareVersion="2"' AS NS_Info		--## These extra info will be added to the Actual XML file in .NET while exporting;
				 , @xmlFileName AS xmlFileName
				 , IsNull(@xmlPreviousExportFileName, 'x') AS PreviousFileName;

END
GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 11.12.2023
-- TFS#	3452
-- Description of change
-- Reassigned indication to the correct procedure type
------------------------------------------------------------------------------------------------------------------------
GO

DECLARE @IndicationId INT = (SELECT UniqueId FROM dbo.ERS_Indications WHERE NEDTerm = 'Nasogastric tube insertion')
DELETE FROM dbo.ERS_IndicationsProcedureTypes WHERE IndicationId = @IndicationId AND ProcedureTypeId = 6
IF NOT EXISTS (SELECT 1 FROM dbo.ERS_IndicationsProcedureTypes WHERE IndicationId = @IndicationId AND ProcedureTypeId = 8)
INSERT INTO	dbo.ERS_IndicationsProcedureTypes
(
    IndicationId,
    ProcedureTypeId
)
VALUES
(   @IndicationId, -- IndicationId - int
    8  -- ProcedureTypeId - int
)
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------

GO


ALTER PROCEDURE [dbo].[procedure_upper_extent_save]
(
	@ProcedureId int,
	@ExtentId int,
	@AdditionalInfo varchar(max),
	@EndoscopistId int,
	@JManoeuvreId int, 
	@LimitedById int, 
	@WithdrawalMins int,
	@LimitationOther varchar(max),
	@LoggedInUserId int
)
AS
/*
--	Update History
01.			04 Jan 2023		MH added Order Message Send block while saving Extent of Intubation TFS #2475
							No extra parameter required. ProcedureId will have associated OrderId and Extent Limited By value
02.			21 March 2023	AJ j manouver handled if -1 (not specified)
03.			27 March 2023	AJ Set sections as not entered based on the extent reached
04.			08 June 2023	SG Add call to ogd_diagnoses_summary_update to ensure report gets populated with Normal if no abnormalities are added
05.         08 Nov 2023     MS Add MucosalJunctionDistance column and related logic
							
*/
BEGIN
	Declare @bitHasProcedureFailed as bit
	Set @bitHasProcedureFailed = 0

	IF NOT EXISTS (SELECT 1 FROM ERS_ProcedureUpperExtent WHERE ProcedureId = @ProcedureId AND EndoscopistId = @EndoscopistId)
	BEGIN
		INSERT INTO ERS_ProcedureUpperExtent (ProcedureId, ExtentId, AdditionalInfo, EndoscopistId, JManoeuvreId, LimitationId, WhoUpdatedId, WhenUpdated, LimitationOther)
		VALUES (@ProcedureId, NULLIF(@ExtentId,0), NULLIF(@AdditionalInfo,''), @EndoscopistId, NULLIF(@JManoeuvreId,-1), NULLIF(@LimitedById,0), @LoggedInUserId, getdate(), NULLIF(@LimitationOther,''))
	END
	ELSE
	BEGIN

		/*Check if new values been added for limitations */
		IF ISNULL(@LimitationOther,'') <> ''
		BEGIN
			IF NOT EXISTS (SELECT 1 FROM dbo.ERS_Limitations WHERE Description = @LimitationOther)
			BEGIN
				/*get and set the new items order id so it appears 1 above 'other' we always want other to be last*/

				DECLARE @OtherListOrderBy_l int = (SELECT ListOrderBy FROM ERS_Limitations WHERE Description = 'Other')
				INSERT INTO ERS_Limitations (Description, NEDTerm, ListOrderBy) VALUES (@LimitationOther, 'Other', @OtherListOrderBy_l)
			
				UPDATE dbo.ERS_Limitations SET ListOrderBy = @OtherListOrderBy_l + 1 WHERE Description = 'Other'
		

			SELECT @LimitedById = UniqueId FROM ERS_Limitations WHERE Description = @LimitationOther
		
			DECLARE @ProcTypeId int = (SELECT ProcedureType FROM ERS_Procedures WHERE ProcedureId = @ProcedureId)
			INSERT INTO ERS_LimitationProcedureTypes (ProcedureTypeId, LimitationId) VALUES (@ProcTypeId, @LimitedById)
			END
			ELSE
				SELECT @LimitedById = UniqueId FROM ERS_Limitations WHERE Description = @LimitationOther
		END 

		UPDATE ERS_ProcedureUpperExtent
		SET 
			ExtentId = NULLIF(@ExtentId,0),
			AdditionalInfo = NULLIF(@AdditionalInfo,''),
			EndoscopistId = @EndoscopistId,
			JManoeuvreId = NULLIF(@JManoeuvreId,-1),
			LimitationId = NULLIF(@LimitedById,0),
			WhoUpdatedId = @LoggedInUserId,
			WhenUpdated = getdate(),
			LimitationOther = NULLIF(@LimitationOther,'')
		WHERE 
			ProcedureId = @ProcedureId AND
			EndoscopistId = @EndoscopistId
	END

	DECLARE @SectionId int, @ProceureTypeId int, @ExtentIsSuccess bit, @ExtentDescription varchar(200), @SummaryText varchar(max) = ''
	SELECT @SectionID = UISectionId FROM UI_Sections WHERE SectionName = 'Extent'

	SELECT @ProceureTypeId = ProcedureType FROM ERS_Procedures WHERE ProcedureId = @ProcedureId
	
	/*Furthest extent*/
	SELECT TOP 1 @ExtentDescription = ee.Description, @AdditionalInfo = epue.AdditionalInfo, @ExtentIsSuccess = ee.IsSuccess
								FROM dbo.ERS_ProcedureUpperExtent epue 
									INNER JOIN dbo.ERS_Extent ee ON epue.ExtentId = ee.UniqueId
								WHERE epue.ProcedureId=@ProcedureId
								ORDER BY ee.ListOrderBy DESC
	
	/*Handle failed procedures*/
	IF @ExtentDescription IN ('intubation failed','abandoned')
	Begin
		EXEC diagnoses_set_procedure_failed @ProcedureId
		Set @bitHasProcedureFailed = 1
	End


	IF (SELECT COUNT(*) FROM ERS_ProcedureUpperExtent WHERE ProcedureId = @ProcedureId AND NULLIF(JManoeuvreId,-1) IS NOT NULL) > 0
	BEGIN
		DECLARE @JManouvreResult varchar(100)

		/*Overall JManouvre result regardless of who done it, was it done*/
		IF EXISTS (SELECT 1 FROM ERS_ProcedureUpperExtent WHERE ProcedureId = @ProcedureId AND ISNULL(JManoeuvreId,0) = 1)
			SET @JManouvreResult = 'performed. '
		ELSE
			SET @JManouvreResult = 'not carried out. '

		SET @SummaryText = @SummaryText + 'J manoeuvre ' + @JManouvreResult
	END
		
	SET @SummaryText = @SummaryText +   
						CASE LOWER(@ExtentDescription )
							WHEN 'intubation failed' THEN 'Failed intubation' + CASE WHEN ISNULL(@AdditionalInfo,'') <> '' THEN ': ' + @AdditionalInfo ELSE '' END
							WHEN 'abandoned' THEN 'Procedure failed (abandoned)' + CASE WHEN ISNULL(@AdditionalInfo,'') <> '' THEN ': ' + @AdditionalInfo ELSE '' END
							WHEN 'other' THEN  'Procedure failed' + CASE WHEN ISNULL(@AdditionalInfo,'') <> '' THEN ': ' + @AdditionalInfo ELSE '' END
							ELSE 'The procedure was completed successfully to the ' + @ExtentDescription
						END
	--limited by...?
	IF ISNULL(@LimitedById, 0) > 0
	BEGIN
		SET @SummaryText = @SummaryText + ' but limited by ' + (SELECT LOWER(Description) FROM ERS_Limitations WHERE UniqueId = @LimitedById)
	END

	IF ISNULL(@SummaryText,'') <> ''
	BEGIN
		UPDATE ERS_ProcedureUpperExtent
		SET Summary = @SummaryText
		WHERE ProcedureId = @ProcedureId

		EXEC procedure_summary_update @ProcedureId
	END
	
	DECLARE @Summary VARCHAR(max) = 'Extent:'


	--remove complete section entry incase conditions no longer apply. Will get re-evaluated after
	EXEC UI_update_procedure_summary @ProcedureId, 'Extent', @Summary, 0, @EndoscopistId

	--Check if the Extent has reached or exceeded the planned extent, if so mark as success
	IF @ExtentId > 0 
	BEGIN
		DECLARE @ExtentListOrder int = (SELECT ListOrderBy FROM ERS_Extent WHERE UniqueId = @ExtentId)
		DECLARE @PlannedExtentListOrder int = (SELECT e.ListOrderBy FROM ERS_ProcedurePlannedExtent ppe JOIN ERS_Extent e ON e.UniqueId = ppe.ExtentId WHERE ppe.ProcedureId = @ProcedureId)

		IF (@ExtentListOrder >= @PlannedExtentListOrder AND @ExtentListOrder > 0)
				SET @ExtentIsSuccess = 1
	END

	IF @ExtentId > 0 AND @ExtentIsSuccess = 1
		EXEC UI_update_procedure_summary @ProcedureId, 'Extent', 'Extent:', @ExtentId, @EndoscopistId
	ELSE IF @ExtentIsSuccess = 0 AND @LimitedById > 1
	BEGIN
		IF (SELECT LOWER(NEDTerm) FROM dbo.ERS_Limitations WHERE UniqueId = @LimitedById) = 'other'
		BEGIN
			IF ISNULL(@LimitationOther,'') <> ''
			BEGIN
				EXEC UI_update_procedure_summary @ProcedureId, 'Extent', 'Extent:' , @ExtentId, @EndoscopistId
			END
		END
		ELSE
		BEGIN
			EXEC UI_update_procedure_summary @ProcedureId, 'Extent', 'Extent:', @ExtentId, @EndoscopistId
		END
	END

	IF ISNULL(@WithdrawalMins,0) > 0
	BEGIN
		EXEC UI_update_procedure_summary @ProcedureId, 'Total withdrawal time', 'Total withdrawal time:', 1, @EndoscopistId
	END

	IF @JManoeuvreId > -1
	BEGIN
		EXEC UI_update_procedure_summary @ProcedureId, 'JManoevre', 'JManoevre:', 1, @EndoscopistId
	END
	ELSE
	BEGIN
		EXEC UI_update_procedure_summary @ProcedureId, 'JManoevre', 'JManoevre:', 0 , @EndoscopistId
	END
	
	--MH Added on 04 Jan 2023 
	Exec usp_SendIntubationExtentOrderMessageByProcedureId @ProcedureId, @bitHasProcedureFailed, @LoggedInUserId

	EXEC ogd_diagnoses_summary_update @ProcedureID

	--Handle unentered sections
	DECLARE @MatrixCode VARCHAR(100)

	--based on extent reached
	IF LOWER(@ExtentDescription)= 'oesophagus'
	BEGIN
		--if Oesophagus then Stomach and Duodenum not entered
		EXEC dbo.diagnoses_control_save @SiteID = 0,               -- int
		                                @DiagnosesMatrixCode = 'StomachNotEntered', -- varchar(50)
		                                @Value = 'true'                -- varchar(50)
		
		EXEC dbo.diagnoses_control_save @SiteID = 0,               -- int
		                                @DiagnosesMatrixCode = 'DuodenumNotEntered', -- varchar(50)
		                                @Value = 'true'                -- varchar(50)
	END
	IF LOWER(@ExtentDescription)= 'stomach'
	BEGIN
		--if stomach Duodenum not entered
		EXEC dbo.diagnoses_control_save @SiteID = 0,               -- int
		                                @DiagnosesMatrixCode = 'DuodenumNotEntered', -- varchar(50)
		                                @Value = 'true'                -- varchar(50)
		
	END
END


GO



------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	
-- TFS#	
-- Description of change
-- Removed assignment of incorrect indications and procedure types
------------------------------------------------------------------------------------------------------------------------
GO


IF EXISTS (SELECT 1 FROM dbo.ERS_IndicationsProcedureTypes WHERE IndicationId = (
SELECT UniqueId FROM dbo.ERS_Indications WHERE NEDTerm = 'Oesophagitis surveillance') AND ProcedureTypeId = 6)
BEGIN
	DELETE FROM dbo.ERS_IndicationsProcedureTypes WHERE IndicationId = (SELECT UniqueId FROM dbo.ERS_Indications WHERE NEDTerm = 'Oesophagitis surveillance') AND ProcedureTypeId = 6
END


IF EXISTS (SELECT 1 FROM dbo.ERS_IndicationsProcedureTypes WHERE IndicationId = (
SELECT UniqueId FROM dbo.ERS_Indications WHERE NEDTerm = 'Nasogastric tube insertion') AND ProcedureTypeId = 8)
BEGIN
	DELETE FROM dbo.ERS_IndicationsProcedureTypes WHERE IndicationId = (SELECT UniqueId FROM dbo.ERS_Indications WHERE NEDTerm = 'Nasogastric tube insertion') AND ProcedureTypeId = 8
END



------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 20.12.23
-- TFS#	3454
-- Description of change
-- New therapeutics added to summary report
------------------------------------------------------------------------------------------------------------------------
GO


ALTER PROCEDURE [dbo].[therapeutics_ogd_summary_update]
(
	@TherapeuticId AS INT,
	@SiteId INT
)
AS
	SET NOCOUNT ON
	DECLARE   @msg VARCHAR(1000)
			, @msg2 VARCHAR(1000)
			, @Details VARCHAR(1000)
			, @Summary VARCHAR(4000)=''
			, @Area VARCHAR(500)=''
			, @br VARCHAR(6) = '<br />';

	DECLARE 
		@None BIT,
		@YAGLaser BIT,
		@YAGLaserWatts INT,
		@YAGLaserPulses INT,
		@YAGLaserSecs DECIMAL(8,2),
		@YAGLaserKJ DECIMAL(8,2),
		@ArgonBeamDiathermy BIT,
		@ArgonBeamDiathermyWatts INT,
		@ArgonBeamDiathermyPulses INT,
		@ArgonBeamDiathermySecs DECIMAL(8,2),
		@ArgonBeamDiathermyKJ DECIMAL(8,2),
		@BalloonDilation BIT,
		@BandLigation BIT,
		@BandLigationPerformed INT,
		@BandLigationSuccess INT,
		@BotoxInjection BIT,
		@EndoloopPlacement BIT,
		@HeatProbe BIT,
		@BicapElectro BIT,
		@Diathermy BIT,
		@DiathermyWatt INT,	--Mahfuz added on 30 Jul 2021
		@Coil BIT,
		@CoilQty INT,
		@CoilType INT,
		@Valve BIT,
		@ValveQty INT,
		@ValveType INT,
		@Cryotherapy BIT,
		@PhotoDynamicTherapy BIT,
		@ForeignBody BIT,
		@HotBiopsy BIT,
		@Injection BIT,
		@InjectionType INT,
		@InjectionVolume INT,
		@InjectionNumber INT,
		@OesophagealDilatation BIT,
		@DilatedTo INT,
		@DilatationUnits TINYINT,
		@DilatorType TINYINT,
		@DilatorScopePass BIT,
		@OesoDilNilByMouth BIT,
		@OesoDilNilByMouthHrs INT,
		@OesoDilXRay BIT,
		@OesoDilXRayHrs INT,
		@OesoDilSoftDiet BIT,
		@OesoDilSoftDietDays INT,
		@OesoDilWarmFluids BIT,
		@OesoDilWarmFluidsHrs INT,
		@OesoDilMedicalReview BIT,
		@OesoYAGNilByMouth BIT,
		@OesoYAGNilByMouthHrs INT,
		@OesoYAGWarmFluids BIT,
		@OesoYAGWarmFluidsHrs INT,
		@OesoYAGSoftDiet BIT,
		@OesoYAGSoftDietDays INT,
		@OesoYAGMedicalReview BIT,
		@Polypectomy BIT,
		@PolypectomyRemoval TINYINT,
		@PolypectomyRemovalType TINYINT,
		@BandingPiles BIT,
		@BandingNum INT,
		@GastrostomyInsertion BIT,
		@GastrostomyInsertionSize NUMERIC(9,2),
		@GastrostomyInsertionUnits TINYINT,
		@GastrostomyInsertionType TINYINT,
		@GastrostomyInsertionBatchNo VARCHAR(100),
		@CorrectPEGPlacement TINYINT,
		@PEGPlacementFailureReason VARCHAR(500),
		@NGNJInsertion BIT,
		@NGNJTubeNostril TINYINT,
		@NGNJTubeLength NUMERIC(9,2),
		@NGNJTubeBridle BIT,
		@NGNJTubeBatch VARCHAR(20),
		@NilByMouth BIT,
		@NilByMouthHrs INT,
		@NilByProc BIT,
		@NilByProcHrs INT,
		@FlangePosition NUMERIC(9,2),
		@AttachmentToWard BIT,
		@GastrostomyRemoval BIT,
		@PyloricDilatation BIT,
		@VaricealSclerotherapy BIT,
		@VaricealSclerotherapyInjectionType SMALLINT,
		@VaricealSclerotherapyInjectionVol INT,
		@VaricealSclerotherapyInjectionNum INT,
		@VaricealBanding BIT,
		@VaricealBandingNum INT,
		@VaricealClip BIT,
		@StentInsertion BIT,
		@StentInsertionQty INT,
		@StentInsertionType SMALLINT,
		@StentInsertionLength INT,
		@StentInsertionDiameter INT,
		@StentInsertionDiameterUnits TINYINT,
		@StentInsertionBatchNo VARCHAR(100),
		@CorrectStentPlacement TINYINT,
		@StentPlacementFailureReason VARCHAR(500),
		@StentRemoval BIT,
		@StentRemovalTechnique INT,
		@EMR BIT,
		@EMRType TINYINT,
		@EMRFluid INT,
		@EMRFluidVolume INT,
		@RFA BIT,
		@RFAType TINYINT,
		@RFATreatmentFrom INT,
		@RFATreatmentTo INT,
		@RFAEnergyDel INT,
		@RFANumSegTreated INT,
		@RFANumTimesSegTreated INT,
		@pHProbeInsert BIT,
		@pHProbeInsertAt INT,
		@pHProbeInsertChk BIT,
		@pHProbeInsertChkTopTo INT,
		@Haemospray BIT,
		@Sigmoidopexy BIT,
		@SigmoidopexyQty SMALLINT,
		@SigmoidopexyMake SMALLINT,
		@SigmoidopexyFluidsDays SMALLINT,
		@SigmoidopexyAntibioticsDays SMALLINT,
		@Marking BIT,
		@MarkedQuantity SMALLINT,
		@TattooLocationDistal BIT,
		@TattooLocationProximal BIT,
		@MarkingType INT,
		@Clip BIT,
		@ClipNum INT,
		@Other VARCHAR(1000),
		@EUSProcType SMALLINT,
		@EndoClot BIT,
		@ColonicDecompression BIT,
		@FlatusTubeInsertion BIT,
		@PancolonicDyeSpray BIT,
		@BougieDilation BIT,
		@EndoscopicResection BIT,
		@FineNeedleAspiration BIT,
		@FineNeedleAspirationType TINYINT,
		@FineNeedleBiopsy BIT,
		@Homeostasis BIT,
		@HomeostasisType INT,
		@Diverticulotomy BIT,
		@GastricBalloonInsertion BIT;

	IF OBJECT_ID('tempdb..#tmp_UpperGITherapeutics') IS NOT NULL
        DROP TABLE #tmp_UpperGITherapeutics;

	SELECT * INTO #tmp_UpperGITherapeutics 
	FROM dbo.[ERS_UpperGITherapeutics] 
	WHERE (Id = @TherapeuticId OR SiteID = @SiteId)

--## 1) If 'CarriedOutRole=2 (EE)' record is found for a SiteId in [ERS_UpperGITherapeutics] means it has both EE/ER Entries...
	--IF EXISTS(SELECT 'ER' FROM dbo.[ERS_UpperGITherapeutics] WHERE SiteId=@SiteId AND CarriedOutRole=2)
	--	BEGIN
			--PRINT '[ERS_UpperGITherapeutics] has both EE/ER Entries...';
			;WITH eeRecord AS (
				SELECT * FROM #tmp_UpperGITherapeutics WHERE CarriedOutRole = (SELECT MAX(CarriedOutRole) FROM #tmp_UpperGITherapeutics) --## 2 is EE
				--WHERE SiteId=@SiteId AND CarriedOutRole=2
			)
			SELECT
				@None							= (CASE WHEN ISNULL(ER.[None], 0) = 0 THEN EE.[None] ELSE ER.[None] END),
				@YAGLaser						= (CASE WHEN ISNULL(ER.[YAGLaser], 0) = 0 THEN EE.[YAGLaser] ELSE ER.[YAGLaser] END),
				@YAGLaserWatts					= (CASE WHEN ISNULL(ER.[YAGLaserWatts], 0) = 0 THEN EE.[YAGLaserWatts] ELSE ER.[YAGLaserWatts] END),
				@YAGLaserPulses					= (CASE WHEN ISNULL(ER.[YAGLaserPulses], 0) = 0 THEN EE.[YAGLaserPulses] ELSE ER.[YAGLaserPulses] END),
				@YAGLaserSecs					= (CASE WHEN ISNULL(ER.[YAGLaserSecs], 0) = 0 THEN EE.[YAGLaserSecs] ELSE ER.[YAGLaserSecs] END),
				@YAGLaserKJ						= (CASE WHEN ISNULL(ER.[YAGLaserKJ], 0) = 0 THEN EE.[YAGLaserKJ] ELSE ER.[YAGLaserKJ] END),
				@ArgonBeamDiathermy				= (CASE WHEN ISNULL(ER.[ArgonBeamDiathermy], 0) = 0 THEN EE.[ArgonBeamDiathermy] ELSE ER.[ArgonBeamDiathermy] END),
				@ArgonBeamDiathermyWatts		= (CASE WHEN ISNULL(ER.[ArgonBeamDiathermyWatts], 0) = 0 THEN EE.[ArgonBeamDiathermyWatts] ELSE ER.[ArgonBeamDiathermyWatts] END),
				@ArgonBeamDiathermyPulses		= (CASE WHEN ISNULL(ER.[ArgonBeamDiathermyPulses], 0) = 0 THEN EE.[ArgonBeamDiathermyPulses] ELSE ER.[ArgonBeamDiathermyPulses] END),
				@ArgonBeamDiathermySecs			= (CASE WHEN ISNULL(ER.[ArgonBeamDiathermySecs], 0) = 0 THEN EE.[ArgonBeamDiathermySecs] ELSE ER.[ArgonBeamDiathermySecs] END),
				@ArgonBeamDiathermyKJ			= (CASE WHEN ISNULL(ER.[ArgonBeamDiathermyKJ], 0) = 0 THEN EE.[ArgonBeamDiathermyKJ] ELSE ER.[ArgonBeamDiathermyKJ] END),
				@BalloonDilation				= (CASE WHEN ISNULL(ER.[BalloonDilation], 0) = 0 THEN EE.[BalloonDilation] ELSE ER.[BalloonDilation] END),
				@BandLigation					= (CASE WHEN ISNULL(ER.[BandLigation], 0) = 0 THEN EE.[BandLigation] ELSE ER.[BandLigation] END),
				@BandLigationPerformed			= (CASE WHEN ISNULL(ER.[BandLigationPerformed], 0) = 0 THEN EE.[BandLigationPerformed] ELSE ER.[BandLigationPerformed] END),
				@BandLigationSuccess			= (CASE WHEN ISNULL(ER.[BandLigationSuccessful], 0) = 0 THEN EE.[BandLigationSuccessful] ELSE ER.[BandLigationSuccessful] END),
				@BotoxInjection					= (CASE WHEN ISNULL(ER.[BotoxInjection], 0) = 0 THEN EE.[BotoxInjection] ELSE ER.[BotoxInjection] END),
				@EndoloopPlacement				= (CASE WHEN ISNULL(ER.[EndoloopPlacement], 0) = 0 THEN EE.[EndoloopPlacement] ELSE ER.[EndoloopPlacement] END),
				@HeatProbe						= (CASE WHEN ISNULL(ER.[HeatProbe], 0) = 0 THEN EE.[HeatProbe] ELSE ER.[HeatProbe] END),
				@BicapElectro					= (CASE WHEN ISNULL(ER.[BicapElectro], 0) = 0 THEN EE.[BicapElectro] ELSE ER.[BicapElectro] END),
				@Diathermy						= (CASE WHEN ISNULL(ER.[Diathermy], 0) = 0 THEN EE.[Diathermy] ELSE ER.[Diathermy] END),
				@DiathermyWatt					= (CASE WHEN ISNULL(ER.[DiathermyWatt], 0) = 0 THEN EE.[DiathermyWatt] ELSE ER.[DiathermyWatt] END),  
				@Coil							= (CASE WHEN ISNULL(ER.[Coil], 0) = 0 THEN EE.[Coil] ELSE ER.[Coil] END),
				@CoilQty						= (CASE WHEN ISNULL(ER.[CoilQty], 0) = 0 THEN EE.[CoilQty] ELSE ER.[CoilQty] END),
				@CoilType						= (CASE WHEN ISNULL(ER.[CoilType], 0) = 0 THEN EE.[CoilType] ELSE ER.[CoilType] END),
				@Valve							= (CASE WHEN ISNULL(ER.[Valve], 0) = 0 THEN EE.[Valve] ELSE ER.[Valve] END),
				@ValveQty						= (CASE WHEN ISNULL(ER.[ValveQty], 0) = 0 THEN EE.[ValveQty] ELSE ER.[ValveQty] END),
				@ValveType						= (CASE WHEN ISNULL(ER.[ValveType], 0) = 0 THEN EE.[ValveType] ELSE ER.[ValveType] END),
				@Cryotherapy					= (CASE WHEN ISNULL(ER.[Cryotherapy], 0) = 0 THEN EE.[Cryotherapy] ELSE ER.[Cryotherapy] END),
				@PhotoDynamicTherapy			= (CASE WHEN ISNULL(ER.[PhotoDynamicTherapy], 0) = 0 THEN EE.[PhotoDynamicTherapy] ELSE ER.[PhotoDynamicTherapy] END),
				@ForeignBody					= (CASE WHEN ISNULL(ER.[ForeignBody], 0) = 0 THEN EE.[ForeignBody] ELSE ER.[ForeignBody] END),
				@HotBiopsy						= (CASE WHEN ISNULL(ER.[HotBiopsy], 0) = 0 THEN EE.[HotBiopsy] ELSE ER.[HotBiopsy] END),
				@Injection						= (CASE WHEN ISNULL(ER.[Injection], 0) = 0 THEN EE.[Injection] ELSE ER.[Injection] END),
				@InjectionType					= (CASE WHEN ISNULL(ER.[InjectionType], 0) = 0 THEN EE.[InjectionType] ELSE ER.[InjectionType] END),
				@InjectionVolume				= (CASE WHEN ISNULL(ER.[InjectionVolume], 0) = 0 THEN EE.[InjectionVolume] ELSE ER.[InjectionVolume] END),
				@InjectionNumber				= (CASE WHEN ISNULL(ER.[InjectionNumber], 0) = 0 THEN EE.[InjectionNumber] ELSE ER.[InjectionNumber] END),
				@OesophagealDilatation			= (CASE WHEN ISNULL(ER.[OesophagealDilatation], 0) = 0 THEN EE.[OesophagealDilatation] ELSE ER.[OesophagealDilatation] END),
				@DilatedTo						= (CASE WHEN ISNULL(ER.[DilatedTo], 0) = 0 THEN EE.[DilatedTo] ELSE ER.[DilatedTo] END),
				@DilatationUnits				= (CASE WHEN ISNULL(ER.[DilatationUnits], 0) = 0 THEN EE.[DilatationUnits] ELSE ER.[DilatationUnits] END),
				@DilatorType					= (CASE WHEN ISNULL(ER.[DilatorType], 0) = 0 THEN EE.[DilatorType] ELSE ER.[DilatorType] END),
				@DilatorScopePass				= (CASE WHEN ISNULL(ER.[DilatorScopePass], 0) = 0 THEN EE.[DilatorScopePass] ELSE ER.[DilatorScopePass] END),
				@OesoDilNilByMouth				= (CASE WHEN ISNULL(ER.[OesoDilNilByMouth], 0) = 0 THEN EE.[OesoDilNilByMouth] ELSE ER.[OesoDilNilByMouth] END),
				@OesoDilNilByMouthHrs			= (CASE WHEN ISNULL(ER.[OesoDilNilByMouthHrs], 0) = 0 THEN EE.[OesoDilNilByMouthHrs] ELSE ER.[OesoDilNilByMouthHrs] END),
				@OesoDilXRay					= (CASE WHEN ISNULL(ER.[OesoDilXRay], 0) = 0 THEN EE.[OesoDilXRay] ELSE ER.[OesoDilXRay] END),
				@OesoDilXRayHrs					= (CASE WHEN ISNULL(ER.[OesoDilXRayHrs], 0) = 0 THEN EE.[OesoDilXRayHrs] ELSE ER.[OesoDilXRayHrs] END),
				@OesoDilSoftDiet				= (CASE WHEN ISNULL(ER.[OesoDilSoftDiet], 0) = 0 THEN EE.[OesoDilSoftDiet] ELSE ER.[OesoDilSoftDiet] END),
				@OesoDilSoftDietDays			= (CASE WHEN ISNULL(ER.[OesoDilSoftDietDays], 0) = 0 THEN EE.[OesoDilSoftDietDays] ELSE ER.[OesoDilSoftDietDays] END),
				@OesoDilWarmFluids				= (CASE WHEN ISNULL(ER.[OesoDilWarmFluids], 0) = 0 THEN EE.[OesoDilWarmFluids] ELSE ER.[OesoDilWarmFluids] END),
				@OesoDilWarmFluidsHrs			= (CASE WHEN ISNULL(ER.[OesoDilWarmFluidsHrs], 0) = 0 THEN EE.[OesoDilWarmFluidsHrs] ELSE ER.[OesoDilWarmFluidsHrs] END),
				@OesoDilMedicalReview			= (CASE WHEN ISNULL(ER.[OesoDilMedicalReview], 0) = 0 THEN EE.[OesoDilMedicalReview] ELSE ER.[OesoDilMedicalReview] END),
				@OesoYAGNilByMouth				= (CASE WHEN IsNull(ER.[OesoYAGNilByMouth], 0) = 0 THEN EE.[OesoYAGNilByMouth] ELSE ER.[OesoYAGNilByMouth] END),
				@OesoYAGNilByMouthHrs			= (CASE WHEN IsNull(ER.[OesoYAGNilByMouthHrs], 0) = 0 THEN EE.[OesoYAGNilByMouthHrs] ELSE ER.[OesoYAGNilByMouthHrs] END),
				@OesoYAGWarmFluids				= (CASE WHEN IsNull(ER.[OesoYAGWarmFluids], 0) = 0 THEN EE.[OesoYAGWarmFluids] ELSE ER.[OesoYAGWarmFluids] END),
				@OesoYAGWarmFluidsHrs			= (CASE WHEN IsNull(ER.[OesoYAGWarmFluidsHrs], 0) = 0 THEN EE.[OesoYAGWarmFluidsHrs] ELSE ER.[OesoYAGWarmFluidsHrs] END),
				@OesoYAGSoftDiet				= (CASE WHEN IsNull(ER.[OesoYAGSoftDiet], 0) = 0 THEN EE.[OesoYAGSoftDiet] ELSE ER.[OesoYAGSoftDiet] END),
				@OesoYAGSoftDietDays			= (CASE WHEN IsNull(ER.[OesoYAGSoftDietDays], 0) = 0 THEN EE.[OesoYAGSoftDietDays] ELSE ER.[OesoYAGSoftDietDays] END),
				@OesoYAGMedicalReview			= (CASE WHEN IsNull(ER.[OesoYAGMedicalReview], 0) = 0 THEN EE.[OesoYAGMedicalReview] ELSE ER.[OesoYAGMedicalReview] END),
				@Polypectomy					= (CASE WHEN IsNull(ER.[Polypectomy], 0) = 0 THEN EE.[Polypectomy] ELSE ER.[Polypectomy] END),
				@PolypectomyRemoval				= (CASE WHEN IsNull(ER.[PolypectomyRemoval], 0) = 0 THEN EE.[PolypectomyRemoval] ELSE ER.[PolypectomyRemoval] END),
				@PolypectomyRemovalType			= (CASE WHEN IsNull(ER.[PolypectomyRemovalType], 0) = 0 THEN EE.[PolypectomyRemovalType] ELSE ER.[PolypectomyRemovalType] END),
				@BandingPiles					= (CASE WHEN IsNull(ER.BandingPiles, 0) = 0 THEN EE.BandingPiles ELSE ER.BandingPiles END),
				@BandingNum						= (CASE WHEN IsNull(ER.BandingNum, 0) = 0 THEN EE.BandingNum ELSE ER.BandingNum END),
				@GastrostomyInsertion			= (CASE WHEN IsNull(ER.[GastrostomyInsertion], 0) = 0 THEN EE.[GastrostomyInsertion] ELSE ER.[GastrostomyInsertion] END),
				@GastrostomyInsertionSize		= (CASE WHEN IsNull(ER.[GastrostomyInsertionSize], 0) = 0 THEN EE.[GastrostomyInsertionSize] ELSE ER.[GastrostomyInsertionSize] END),
				@GastrostomyInsertionUnits		= (CASE WHEN IsNull(ER.[GastrostomyInsertionUnits], 0) = 0 THEN EE.[GastrostomyInsertionUnits] ELSE ER.[GastrostomyInsertionUnits] END),
				@GastrostomyInsertionType		= (CASE WHEN IsNull(ER.[GastrostomyInsertionType], 0) = 0 THEN EE.[GastrostomyInsertionType] ELSE ER.[GastrostomyInsertionType] END),
				@GastrostomyInsertionBatchNo	= (SELECT isnull((CASE WHEN IsNull(ER.[GastrostomyInsertionBatchNo], '') = '' THEN EE.[GastrostomyInsertionBatchNo] ELSE ER.[GastrostomyInsertionBatchNo] END), '') as [text()] FOR XML PATH('')),
				@CorrectPEGPlacement			= (CASE WHEN IsNull(ER.[CorrectPEGPlacement], 0) = 0 THEN EE.[CorrectPEGPlacement] ELSE ER.[CorrectPEGPlacement] END),
				@PEGPlacementFailureReason		= (SELECT isnull((CASE WHEN IsNull(ER.[PEGPlacementFailureReason], '') = '' THEN EE.[PEGPlacementFailureReason] ELSE ER.[PEGPlacementFailureReason] END), '') as [text()] FOR XML PATH('')),
				@NGNJInsertion 					= (CASE WHEN IsNull(ER.NGNJTubeInsertion, 0) = 0 THEN EE.NGNJTubeInsertion ELSE ER.NGNJTubeInsertion END),
				@NGNJTubeNostril				= (CASE WHEN IsNull(ER.NGNJTubeNostril, 0) = 0 THEN EE.NGNJTubeNostril ELSE ER.NGNJTubeNostril END),
				@NGNJTubeLength					= (CASE WHEN IsNull(ER.NGNJTubeLength, 0) = 0 THEN EE.NGNJTubeLength ELSE ER.NGNJTubeLength END),
				@NGNJTubeBridle					= (CASE WHEN IsNull(ER.NGNJTubeBridle, 0) = 0 THEN EE.NGNJTubeBridle ELSE ER.NGNJTubeBridle END),
				@NGNJTubeBatch					= (CASE WHEN IsNull(ER.NGNJTubeBatch, '') = '' THEN EE.NGNJTubeBatch ELSE ER.NGNJTubeBatch END),
				@NilByMouth						= (CASE WHEN IsNull(ER.[NilByMouth], 0) = 0 THEN EE.[NilByMouth] ELSE ER.[NilByMouth] END),
				@NilByMouthHrs					= (CASE WHEN IsNull(ER.[NilByMouthHrs], 0) = 0 THEN EE.[NilByMouthHrs] ELSE ER.[NilByMouthHrs] END),
				@NilByProc						= (CASE WHEN IsNull(ER.[NilByProc], 0) = 0 THEN EE.[NilByProc] ELSE ER.[NilByProc] END),
				@NilByProcHrs					= (CASE WHEN IsNull(ER.[NilByProcHrs], 0) = 0 THEN EE.[NilByProcHrs] ELSE ER.[NilByProcHrs] END),
				@FlangePosition					= (CASE WHEN IsNull(ER.[FlangePosition], 0) = 0 THEN EE.[FlangePosition] ELSE ER.[FlangePosition] END),
				@AttachmentToWard				= (CASE WHEN IsNull(ER.[AttachmentToWard], 0) = 0 THEN EE.[AttachmentToWard] ELSE ER.[AttachmentToWard] END),
				@GastrostomyRemoval				= (CASE WHEN IsNull(ER.[GastrostomyRemoval], 0) = 0 THEN EE.[GastrostomyRemoval] ELSE ER.[GastrostomyRemoval] END),
				@PyloricDilatation				= (CASE WHEN IsNull(ER.[PyloricDilatation], 0) = 0 THEN EE.[PyloricDilatation] ELSE ER.[PyloricDilatation] END),
				@VaricealSclerotherapy			= (CASE WHEN IsNull(ER.[VaricealSclerotherapy], 0) = 0 THEN EE.[VaricealSclerotherapy] ELSE ER.[VaricealSclerotherapy] END),
				@VaricealSclerotherapyInjectionType = (CASE WHEN IsNull(ER.[VaricealSclerotherapyInjectionType], 0) = 0 THEN EE.[VaricealSclerotherapyInjectionType] ELSE ER.[VaricealSclerotherapyInjectionType] END),
				@VaricealSclerotherapyInjectionVol  = (CASE WHEN IsNull(ER.[VaricealSclerotherapyInjectionVol], 0) = 0 THEN EE.[VaricealSclerotherapyInjectionVol] ELSE ER.[VaricealSclerotherapyInjectionVol] END),
				@VaricealSclerotherapyInjectionNum  = (CASE WHEN IsNull(ER.[VaricealSclerotherapyInjectionNum], 0) = 0 THEN EE.[VaricealSclerotherapyInjectionNum] ELSE ER.[VaricealSclerotherapyInjectionNum] END),
				@VaricealBanding				= (CASE WHEN IsNull(ER.[VaricealBanding], 0) = 0 THEN EE.[VaricealBanding] ELSE ER.[VaricealBanding] END),
				@VaricealBandingNum				= (CASE WHEN IsNull(ER.[VaricealBandingNum], 0) = 0 THEN EE.[VaricealBandingNum] ELSE ER.[VaricealBandingNum] END),
				@VaricealClip					= (CASE WHEN IsNull(ER.[VaricealClip], 0) = 0 THEN EE.[VaricealClip] ELSE ER.[VaricealClip] END),
				@StentInsertion					= (CASE WHEN IsNull(ER.[StentInsertion], 0) = 0 THEN EE.[StentInsertion] ELSE ER.[StentInsertion] END),
				@StentInsertionQty				= (CASE WHEN IsNull(ER.[StentInsertionQty], 0) = 0 THEN EE.[StentInsertionQty] ELSE ER.[StentInsertionQty] END),
				@StentInsertionType				= (CASE WHEN IsNull(ER.[StentInsertionType], 0) = 0 THEN EE.[StentInsertionType] ELSE ER.[StentInsertionType] END),
				@StentInsertionLength			= (CASE WHEN IsNull(ER.[StentInsertionLength], 0) = 0 THEN EE.[StentInsertionLength] ELSE ER.[StentInsertionLength] END),
				@StentInsertionDiameter			= (CASE WHEN IsNull(ER.[StentInsertionDiameter], 0) = 0 THEN EE.[StentInsertionDiameter] ELSE ER.[StentInsertionDiameter] END),
				@StentInsertionDiameterUnits	= (CASE WHEN IsNull(ER.[StentInsertionDiameterUnits], 0) = 0 THEN EE.[StentInsertionDiameterUnits] ELSE ER.[StentInsertionDiameterUnits] END),
				@StentInsertionBatchNo			= (CASE WHEN IsNull(ER.[StentInsertionBatchNo], '') = '' THEN EE.[StentInsertionBatchNo] ELSE ER.[StentInsertionBatchNo] END),
				@CorrectStentPlacement			= (CASE WHEN IsNull(ER.[CorrectStentPlacement], 0) = 0 THEN EE.[CorrectStentPlacement] ELSE ER.[CorrectStentPlacement] END),
				@StentPlacementFailureReason	= (SELECT isnull((CASE WHEN IsNull(ER.[StentPlacementFailureReason], '') = '' THEN EE.[StentPlacementFailureReason] ELSE ER.[StentPlacementFailureReason] END), '') as [text()] FOR XML PATH('')),
				@StentRemoval					= (CASE WHEN IsNull(ER.[StentRemoval], 0) = 0 THEN EE.[StentRemoval] ELSE ER.[StentRemoval] END),
				@StentRemovalTechnique			= (CASE WHEN IsNull(ER.[StentRemovalTechnique], 0) = 0 THEN EE.[StentRemovalTechnique] ELSE ER.[StentRemovalTechnique] END),
				@EMR							= (CASE WHEN IsNull(ER.[EMR], 0) = 0 THEN EE.[EMR] ELSE ER.[EMR] END),
				@EMRType						= (CASE WHEN IsNull(ER.[EMRType], 0) = 0 THEN EE.[EMRType] ELSE ER.[EMRType] END),
				@EMRFluid						= (CASE WHEN IsNull(ER.[EMRFluid], 0) = 0 THEN EE.[EMRFluid] ELSE ER.[EMRFluid] END),
				@EMRFluidVolume					= (CASE WHEN IsNull(ER.[EMRFluidVolume], 0) = 0 THEN EE.[EMRFluidVolume] ELSE ER.[EMRFluidVolume] END),
				@RFA							= (CASE WHEN IsNull(ER.[RFA], 0) = 0 THEN EE.[RFA] ELSE ER.[RFA] END),
				@RFAType						= (CASE WHEN IsNull(ER.[RFAType], 0) = 0 THEN EE.[RFAType] ELSE ER.[RFAType] END),
				@RFATreatmentFrom				= (CASE WHEN IsNull(ER.[RFATreatmentFrom], 0) = 0 THEN EE.[RFATreatmentFrom] ELSE ER.[RFATreatmentFrom] END),				
				@RFATreatmentTo					= (CASE WHEN IsNull(ER.[RFATreatmentTo], 0) = 0 THEN EE.[RFATreatmentTo] ELSE ER.[RFATreatmentTo] END),				
				@RFAEnergyDel					= (CASE WHEN IsNull(ER.[RFAEnergyDel], 0) = 0 THEN EE.[RFAEnergyDel] ELSE ER.[RFAEnergyDel] END),
				@RFANumSegTreated				= (CASE WHEN IsNull(ER.[RFANumSegTreated], 0) = 0 THEN EE.[RFANumSegTreated] ELSE ER.[RFANumSegTreated] END),
				@RFANumTimesSegTreated			= (CASE WHEN IsNull(ER.[RFANumTimesSegTreated], 0) = 0 THEN EE.[RFANumTimesSegTreated] ELSE ER.[RFANumTimesSegTreated] END),
				@pHProbeInsert					= (CASE WHEN IsNull(ER.[pHProbeInsert], 0) = 0 THEN EE.[pHProbeInsert] ELSE ER.[pHProbeInsert] END),
				@pHProbeInsertAt				= (CASE WHEN IsNull(ER.[pHProbeInsertAt], 0) = 0 THEN EE.[pHProbeInsertAt] ELSE ER.[pHProbeInsertAt] END),
				@pHProbeInsertChk				= (CASE WHEN IsNull(ER.[pHProbeInsertChk], 0) = 0 THEN EE.[pHProbeInsertChk] ELSE ER.[pHProbeInsertChk] END),
				@pHProbeInsertChkTopTo			= (CASE WHEN IsNull(ER.[pHProbeInsertChkTopTo], 0) = 0 THEN EE.[pHProbeInsertChkTopTo] ELSE ER.[pHProbeInsertChkTopTo] END),
				@Haemospray						= (CASE WHEN IsNull(ER.[Haemospray], 0) = 0 THEN EE.[Haemospray] ELSE ER.[Haemospray] END),
				@Sigmoidopexy					= (CASE WHEN IsNull(ER.[Sigmoidopexy], 0) = 0 THEN EE.[Sigmoidopexy] ELSE ER.[Sigmoidopexy] END),
				@SigmoidopexyQty				= (CASE WHEN IsNull(ER.[SigmoidopexyQty], 0) = 0 THEN EE.[SigmoidopexyQty] ELSE ER.[SigmoidopexyQty] END),
				@SigmoidopexyMake				= (CASE WHEN IsNull(ER.[SigmoidopexyMake], 0) = 0 THEN EE.[SigmoidopexyMake] ELSE ER.[SigmoidopexyMake] END),
				@SigmoidopexyFluidsDays			= (CASE WHEN IsNull(ER.[SigmoidopexyFluidsDays], 0) = 0 THEN EE.[SigmoidopexyFluidsDays] ELSE ER.[SigmoidopexyFluidsDays] END),
				@SigmoidopexyAntibioticsDays	= (CASE WHEN IsNull(ER.[SigmoidopexyAntibioticsDays], 0) = 0 THEN EE.[SigmoidopexyAntibioticsDays] ELSE ER.[SigmoidopexyAntibioticsDays] END),
				@Marking						= (CASE WHEN IsNull(ER.[Marking], 0) = 0 THEN EE.[Marking] ELSE ER.[Marking] END),
				--MH added on 19 Oct 2021
				--MH added on 19 Oct 2021 - later changed on 26 Nov 2021
				@TattooLocationDistal      = (CASE WHEN IsNull(ER.[TattooLocationDistal], 0) = 0 THEN EE.[TattooLocationDistal] ELSE ER.[TattooLocationDistal] END), 
				@TattooLocationProximal      = (CASE WHEN IsNull(ER.[TattooLocationProximal], 0) = 0 THEN EE.[TattooLocationProximal] ELSE ER.[TattooLocationProximal] END), 

				--MH added on 20 Oct 2021
				@MarkedQuantity    = (CASE WHEN IsNull(ER.[MarkedQuantity], 0) = 0 THEN EE.[MarkedQuantity] ELSE ER.[MarkedQuantity] END), 

				@MarkingType					= (CASE WHEN IsNull(ER.[MarkingType], 0) = 0 THEN EE.[MarkingType] ELSE ER.[MarkingType] END),
				@Clip							= (CASE WHEN IsNull(ER.[Clip], 0) = 0 THEN EE.[Clip] ELSE ER.[Clip] END),
				@ClipNum						= (CASE WHEN IsNull(ER.[ClipNum], 0) = 0 THEN EE.[ClipNum] ELSE ER.[ClipNum] END),
				@Other							= (SELECT isnull((CASE WHEN IsNull(ER.[Other], '') = '' THEN EE.[Other] ELSE ER.[Other] END), '') as [text()] FOR XML PATH('')),
				@EUSProcType					= (CASE WHEN IsNull(ER.[EUSProcType], 0) = 0 THEN EE.[EUSProcType] ELSE ER.[EUSProcType] END),
				@EndoClot						= (CASE WHEN IsNull(ER.[EndoClot], 0) = 0 THEN EE.[EndoClot] ELSE ER.[EndoClot] END),
				@ColonicDecompression			= (CASE WHEN IsNull(ER.[ColonicDecompression], 0) = 0 THEN EE.[ColonicDecompression] ELSE ER.[ColonicDecompression] END),
				@FlatusTubeInsertion			= (CASE WHEN IsNull(ER.[FlatusTubeInsertion], 0) = 0 THEN EE.[FlatusTubeInsertion] ELSE ER.[FlatusTubeInsertion] END),
				@PancolonicDyeSpray				= (CASE WHEN IsNull(ER.[PancolonicDyeSpray], 0) = 0 THEN EE.[PancolonicDyeSpray] ELSE ER.[PancolonicDyeSpray] END),
				@BougieDilation					= (CASE WHEN IsNull(ER.[BougieDilation], 0) = 0 THEN EE.[BougieDilation] ELSE ER.[BougieDilation] END),
				@EndoscopicResection			= (CASE WHEN IsNull(ER.[EndoscopicResection], 0) = 0 THEN EE.[EndoscopicResection] ELSE ER.[EndoscopicResection] END),
				@FineNeedleAspiration		    = (CASE WHEN IsNull(ER.FineNeedleAspiration, 0) = 0 THEN EE.FineNeedleAspiration ELSE ER.FineNeedleAspiration END),
				@FineNeedleAspirationType	    = (CASE WHEN IsNull(ER.FineNeedleAspirationType, 0) = 0 THEN EE.FineNeedleAspirationType ELSE ER.FineNeedleAspirationType END),
				@FineNeedleBiopsy			    = (CASE WHEN IsNull(ER.FineNeedleBiopsy, 0) = 0 THEN EE.FineNeedleBiopsy ELSE ER.FineNeedleBiopsy END),
				@Homeostasis					= (CASE WHEN ISNULL(ER.[Homeostasis], 0) = 0 THEN EE.[Homeostasis] ELSE ER.[Homeostasis] END),
				@HomeostasisType				= (CASE WHEN ISNULL(ER.[HomeostasisType], 0) = 0 THEN EE.[HomeostasisType] ELSE ER.[HomeostasisType] END),
				@Diverticulotomy				= (CASE WHEN ISNULL(ER.[Diverticulotomy], 0) = 0 THEN EE.[Diverticulotomy] ELSE ER.[Diverticulotomy] END),
				@GastricBalloonInsertion		= ISNULL(EE.[GastricBalloonInsertion], 0)
			FROM eeRecord AS EE
	  INNER JOIN #tmp_UpperGITherapeutics AS ER ON EE.SiteId = ER.SiteId
	 
	SELECT @Area = m.Area FROM dbo.ERS_AbnormalitiesMatrixUpperGI m LEFT JOIN dbo.ERS_Regions r ON m.Region = r.Region LEFT JOIN dbo.ERS_Sites s ON r.RegionId  = s.RegionID  WHERE s.siteId = @SiteId;
	
	IF @None = 1
		SET @summary = @summary + 'No therapeutic procedures'
	ELSE
	BEGIN
		IF @YAGLaser = 1
			BEGIN
			SET @msg =' YAG Laser'
			SET @Details = ''
			IF @YAGLaserWatts > 0 SET @Details = @Details + ' ' + CAST(@YAGLaserWatts as varchar(50)) + 'W'
			IF @YAGLaserSecs > 0 SET @Details = @Details + ' for ' + cast(CAST(@YAGLaserSecs AS FLOAT) as varchar(50)) + CASE WHEN @YAGLaserSecs <= 1 THEN ' second' else ' seconds' END
			IF @YAGLaserPulses > 0 SET @Details = @Details + ' in ' + cast(@YAGLaserPulses as varchar(50)) + CASE WHEN @YAGLaserPulses <= 1 THEN ' pulse' else ' pulses' END
			IF @YAGLaserKJ > 0 SET @Details = @Details + ' ('+ cast(CAST(@YAGLaserKJ AS FLOAT) as varchar(50)) + 'kJ)'
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + @br
			END
		
		IF @ArgonBeamDiathermy= 1
			BEGIN
			SET @msg ='  Argon beam diathermy'
			SET @Details = ''
			IF @ArgonBeamDiathermyWatts > 0 SET @Details = @Details + ' ' + cast(@ArgonBeamDiathermyWatts as varchar(50)) + 'W'
			IF @ArgonBeamDiathermySecs > 0 SET @Details = @Details + ' for ' + cast(CAST(@ArgonBeamDiathermySecs AS FLOAT) as varchar(50)) + CASE WHEN @ArgonBeamDiathermySecs <= 1 THEN ' second' else ' seconds' END
			IF @ArgonBeamDiathermyPulses > 0 SET @Details = @Details + ' in ' + cast(@ArgonBeamDiathermyPulses as varchar(50)) + CASE WHEN @ArgonBeamDiathermyPulses <= 1 THEN ' pulse' else ' pulses' END
			IF @ArgonBeamDiathermyKJ > 0 SET @Details = @Details + ' ('+ cast(CAST(@ArgonBeamDiathermyKJ AS FLOAT) as varchar(50)) + 'kJ)'
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
			END

			
		IF @Injection= 1
			BEGIN
			SET @msg =' Injection therapy'
			SET @Details = ''
			IF @InjectionVolume > 0 SET @Details = @Details + '  ' + cast(@InjectionVolume as varchar(50)) + 'ml'
			IF @InjectionVolume > 0  AND @InjectionType > 0 SET @Details = @Details + ' of'
			IF @InjectionType > 0 SET @Details = @Details + ' ' +   (SELECT [ListItemText] FROM dbo.ERS_Lists WHERE ListDescription = 'Agent Upper GI' AND [ListItemNo] = @InjectionType)
			IF @InjectionVolume> 0  AND @InjectionNumber > 0 SET @Details = @Details + ' via'
			IF @InjectionNumber >0 SET @Details = @Details + ' ' + CASE WHEN @InjectionNumber > 1 THEN cast(@InjectionNumber as varchar(50)) + ' injections' ELSE cast(@InjectionNumber as varchar(50)) + ' injection' END
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
	    IF @Homeostasis = 1
			BEGIN
			SET @msg =' Haemostasis'
			SET @Details = ''
			IF @HomeostasisType > 0 SET @Details = @Details + ' ' +   (SELECT [ListItemText] FROM dbo.ERS_Lists WHERE ListDescription = 'Homeostasis' AND [ListItemNo] = @HomeostasisType)
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
	
		IF @Polypectomy= 1  
			BEGIN
			SET @msg =' Polypectomy'
			SET @Details = ''
			DECLARE @Se bit, @SeExcised int, @Pe bit, @PeExcised int, @Su bit, @SuExcised int, @countExcised int = 0
			SELECT @Se = [Sessile],@SeExcised =[SessileNumExcised], @Pe = [Pedunculated], @PeExcised= [PedunculatedNumExcised], @Su =[Submucosal], @SuExcised = [SubmucosalNumExcised] FROM [ERS_UpperGIAbnoPolyps] WHERE SiteId =@SiteId
			IF @Se =1 AND @SeExcised <> null SET @countExcised= @countExcised + @SeExcised 
			IF  @Pe = 1 AND @PeExcised <> null SET @countExcised= @countExcised + @peExcised
			IF  @Su = 1 AND @suExcised <> null SET @countExcised= @countExcised + @suExcised

			IF @countExcised > 0 SET @Details = @Details + cast(@countExcised as varchar(50)) +' excised '

			IF @PolypectomyRemoval <> 0 OR @PolypectomyRemovalType <> 0
			BEGIN
			SET @Details = @Details + '('
            IF @PolypectomyRemoval = 1 SET @Details = @Details + 'removed entirely ' ELSE IF @PolypectomyRemoval = 2 SET @Details = @Details + 'removed piecemeal '
			IF @PolypectomyRemovalType = 1 SET @Details = @Details + ' using partial snare'
			ELSE IF  @PolypectomyRemovalType = 2 SET @Details = @Details + 'using cold snare'
			ELSE IF  @PolypectomyRemovalType = 3 SET @Details = @Details + 'using hot snare cauterisation'
			ELSE IF  @PolypectomyRemovalType = 4 SET @Details = @Details + 'using hot biopsy'
			ELSE IF  @PolypectomyRemovalType = 5 SET @Details = @Details + 'using cold biopsy'
			ELSE IF  @PolypectomyRemovalType = 6 SET @Details = @Details + 'using hot snare EMR'
			ELSE IF  @PolypectomyRemovalType = 7 SET @Details = @Details + 'using cold snare by EMR'
			SET @Details = @Details + ')'
			END

			If @Details<>'' SET @msg = @msg + ': ' + @Details
				--Add full stop 
				SET @msg = RTrim(LTRIM(@msg))
				IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
				--------------
				SET @summary = @summary + @msg + @br
			exec specimens_ogd_summary_update @SiteId
		END

		IF @BandingPiles= 1
		BEGIN 
			SET @msg = CASE WHEN @BandingNum > 1 THEN ': ' + CAST(@BandingNum as varchar(5)) + ' bands'
							WHEN @BandingNum = 1 THEN ': ' + CAST(@BandingNum as varchar(5)) + ' band'
							ELSE ''
						END
			--Add full stop 
			SET @msg = 'Banding of piles' + RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

	
		IF @Diathermy = 1
		BEGIN
			SET @msg = ' Diathermy'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg 
		--------------  
		if @DiathermyWatt <> 0 Set @msg =   ' ' + @msg + ' ' + cast(@DiathermyWatt as varchar(10)) + ' Watt.'

		SET @summary = @summary + @msg + @br  
		END  

		
		
		IF @Diverticulotomy = 1
			BEGIN
			SET @msg =' Diverticulotomy'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		
		
		IF @GastricBalloonInsertion = 1
			BEGIN
			SET @msg =' Gastric balloon insertion'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
  
	-- ## Valve
	  IF @Valve = 1  
	  BEGIN  
	   SET @msg = 'Valve'  
	   if @ValveQty <> 0 Set @msg2 = ' ' + cast(@ValveQty as varchar(10))
	   if @ValveType <> 0 Set @msg2 = @msg2 + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'BRT Valve Type' AND [ListItemNo] = @ValveType)  
	   Set @msg2 = ltrim(rtrim(@msg2))
	   if @msg2 <> '' Set @msg = @msg2 + ' Valve.' else Set @msg = 'Valve.'

	   SET @summary = @summary + @msg +  @br  
	  END

	  --- ### Cryotherapy and PhotoDynamicTherapy
	  Set @msg = ''
	  set @msg2 = ''
	  if @Cryotherapy = 1 Set @msg2 = 'Cryotherapy'
	  if @PhotoDynamicTherapy = 1 
	  Begin
		if @msg2 <> '' Set @msg = @msg2 + ' and Photodynamic Therapy have been used.' else set @msg = 'Photodynamic Therapy has been used.'
	  end
	  else
	  begin
		if @msg2 <> '' Set @msg = @msg2 + ' has been used.'
	  end
	  if @msg <> '' Set @summary = @summary + @msg + @br

		-- ## Coil
		IF @Coil = 1  
		BEGIN  
		SET @msg = 'Coil'  
		if @CoilQty <> 0 Set @msg2 = ' ' + cast(@CoilQty as varchar(10))
		if @CoilType <> 0 Set @msg2 = @msg2 + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'BRT Coil Type' AND [ListItemNo] = @CoilType)  
		Set @msg2 = ltrim(rtrim(@msg2))
		if @msg2 <> '' Set @msg = @msg2 + ' Coil.' else Set @msg = 'Coil.'

			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @BicapElectro = 1
		BEGIN
			SET @msg = ' Bicap electrocautery'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @HeatProbe = 1
		BEGIN
			SET @msg = ' Heater probe coagulation'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		--IF @BallDil = 1
		--	BEGIN
		--	SET @msg = ' Balloon dilatation'
		--	--Add full stop 
		--	SET @msg = RTrim(LTRIM(@msg))
		--	IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
		--	--------------
		--	SET @summary = @summary + @msg + @br
		--END
		
		IF @HotBiopsy = 1
		BEGIN
			SET @msg = ' Hot biopsy'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
		IF @BandLigation = 1
		BEGIN			
			SET @msg = ' Band ligation'
			IF @BandLigationPerformed > 0 SET @msg = @msg + ' performed ' + CAST(@BandLigationPerformed AS VARCHAR(100)) + CASE WHEN @BandLigationPerformed = 1 THEN ' procedure' ELSE ' procedures' END
			IF @BandLigationPerformed > 0 AND @BandLigationSuccess > 0 SET @msg = @msg + ' and ' + CAST(@BandLigationSuccess AS VARCHAR(100)) + CASE WHEN @BandLigationPerformed = 1 THEN ' was successful.' ELSE ' were successful.' END 
				ELSE IF @BandLigationPerformed = 0 AND @BandLigationSuccess > 0 SET @msg = @msg + ' ' + CAST(@BandLigationSuccess AS VARCHAR(100)) + CASE WHEN @BandLigationPerformed = 1 THEN ' procedure was successful.' ELSE ' procedures were successful.' END 
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br			
		END

		IF @BalloonDilation = 1
		BEGIN
			SET @msg = ' Balloon Dilation'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @BotoxInjection = 1
		BEGIN
			SET @msg = ' Botox injection'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @EndoscopicResection = 1
		BEGIN
			SET @msg = ' Endoscopic resection'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		-------------------------------
        -- FNA
        -------------------------------
		IF @FineNeedleAspiration= 1
		BEGIN
			SET @msg =' FNA'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		-------------------------------
        -- FNB
        -------------------------------
		IF @FineNeedleBiopsy= 1
		BEGIN
			SET @msg =' FNB'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @EndoloopPlacement = 1
		BEGIN
			SET @msg = ' Endoloop placement'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @ForeignBody = 1
		BEGIN
			SET @msg = ' Foreign body removal'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @StentInsertion= 1
			BEGIN
			SET @msg =' Stent insertion'
			SET @Details = ''
			IF @StentInsertionQty > 0 SET @Details = @Details + '  ' + cast(@StentInsertionQty as varchar(50))
			IF @StentInsertionType > 0 
				BEGIN
				IF @Area = 'Oesophagus'	 SET @Details = @Details + ' ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Therapeutic Stent Insertion Types' AND [ListItemNo] = @StentInsertionType)
				ELSE SET @Details = @Details + ' ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Therapeutic Stomach Stent Insertion Types' AND [ListItemNo] = @StentInsertionType)
				END	
			IF @StentInsertionLength > 0 AND @StentInsertionDiameter > 0 
				BEGIN
				SET @Details = @Details + ' (' 
				IF @StentInsertionLength > 0 SET @Details = @Details + ' length ' + cast(@StentInsertionLength as varchar(50)) + 'cm'
				IF @StentInsertionDiameter > 0 SET @Details = @Details + ', ' 
				SET @Details = @Details + ' diameter ' + cast(@StentInsertionDiameter as varchar(50))
				IF @StentInsertionDiameterUnits >= 0 SET @Details = @Details+ ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Oesophageal dilatation units' AND [ListItemNo] = @StentInsertionDiameterUnits)
				SET @Details = @Details + ')' 
				END
			IF @StentInsertionBatchNo <> ''  SET @Details = @Details + ' batch ' + LTRIM(RTRIM(@StentInsertionBatchNo))
			
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @StentRemoval= 1
			BEGIN
			SET @msg =' Stent removal'
			SET @Details = ''
			IF @StentRemovalTechnique > 0  SET @Details = @Details + 'using ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Therapeutic Stent Removal Technique' AND [ListItemNo] = @StentRemovalTechnique)
			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @EMR= 1
			BEGIN
			IF @EMRType = 3
				SET @msg =' Endoscopic full thickness resection'
			ELSE IF @EMRType = 2
				SET @msg =' Endoscopic submucosal dissection'
			ELSE IF @EMRType = 1
				SET @msg =' Endoscopic mucosal resection'
			SET @Details = ''
			IF @EMRFluid > 0  SET @Details = @Details + 'using ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Therapeutic EMR Fluid' AND [ListItemNo] = @EMRFluid)
			IF @EMRFluidVolume >0 
				BEGIN
				IF @EMRFluid >0 SET  @Details = @Details + ', '
				SET  @Details = @Details + 'total volume ' + cast(@emrfluidvolume AS varchar(50)) + 'ml'
				END
			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		
		IF @OesophagealDilatation= 1
			BEGIN
			SET @msg =' Oesophageal dilatation'
			SET @Details = ''
			IF @DilatedTo > 0  SET @Details = @Details + ' dilated to ' + cast(@dilatedto as varchar(50)) +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Oesophageal dilatation units' AND [ListItemNo] = @DilatationUnits)
			IF @DilatorType > 0
				BEGIN
				DECLARE @DilatorStr varchar(500) = (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Oesophageal dilator' AND [ListItemNo] = @DilatorType)
				IF @DilatorStr like 'with%' OR @DilatorStr like 'by%'  SET @Details = @Details + ' ' +  @DilatorStr
				ELSE SET @Details = @Details + ' with ' +  @DilatorStr
				END
			IF @DilatorScopePass = 1 SET  @Details = @Details + '(scope could pass)'
			
			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @VaricealSclerotherapy= 1
			BEGIN
			SET @msg =' Oesophagus variceal sclerotherapy'
			SET @Details = ''
			IF @VaricealSclerotherapyInjectionVol > 0  SET @Details = @Details + ' ' + cast(@VaricealSclerotherapyInjectionVol as varchar(50)) + 'ml' 
			IF @VaricealSclerotherapyInjectionVol > 0 AND  @VaricealSclerotherapyInjectiontype > 0  SET @Details = @Details + ' of'
			IF @VaricealSclerotherapyInjectiontype > 0 SET @Details = @Details + ' ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Agent Upper GI' AND [ListItemNo] = @VaricealSclerotherapyInjectiontype)
			IF @VaricealSclerotherapyInjectionVol > 0 AND  @VaricealSclerotherapyInjectionNum > 0  SET @Details = @Details + ' via'
			IF @VaricealSclerotherapyInjectionNum > 0 SET @Details = @Details + ' ' + CASE WHEN @VaricealSclerotherapyInjectionNum >1 THEN CAST(@VaricealSclerotherapyInjectionNum as varchar(50))+' injections' ELSE  CAST(@VaricealSclerotherapyInjectionNum as varchar(50))+' injection' END
			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @VaricealBanding= 1
			BEGIN
			IF @Area ='Oesophagus' SET @msg =' Oesophagus variceal banding' ELSE SET @msg =' Gastric variceal banding'
			SET @Details = ''
			IF @VaricealBandingNum > 0 SET @Details = @Details + ' ' + CASE WHEN @VaricealBandingNum >1 THEN CAST(@VaricealBandingNum as varchar(50))+' bands' ELSE  CAST(@VaricealBandingNum as varchar(50)) + ' band' END
			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @RFA = 1
			BEGIN
			SET @msg =' Radio Frequency Ablation'
			SET @Details = ''
			IF @RFAType = 1	SET @Details = @Details + ' circumferential'
			ELSE IF @RFAType = 2 SET @Details = @Details + ' focal'
			IF ISNULL(@RFAEnergyDel,0) <> 0 SET @Details = @Details + ', ' + cast(@RFAEnergyDel as varchar(50)) + ' joules'
			IF ISNULL(@RFANumSegTreated,0) <> 0
				BEGIN
				SET @Details = @Details + ' delivered to ' + cast(@RFANumSegTreated as varchar(50))
				IF @RFAType =1 SET @Details = @Details + ' x 3cm'
				SET @Details = @Details + ' segment'
				IF @RFANumSegTreated > 1 SET @Details = @Details + 's'
				END
			IF ISNULL(@RFANumTimesSegTreated,0)<>0
				BEGIN
				SET @Details = @Details + ', treated '
				If @RFANumTimesSegTreated = 1 SET @Details = @Details + 'once'
				ELSE SET @Details = @Details + cast(@RFANumTimesSegTreated as varchar(50)) + ' times'
				END
			IF ISNULL(@RFATreatmentFrom,0) <>0 OR ISNULL(@RFATreatmentTo,0) <>0
				BEGIN
				IF ISNULL(@RFATreatmentFrom,0) <> 0  SET @Details = @Details + ', starting at ' + cast(@RFATreatmentFrom as varchar(50)) +' cm'
				IF ISNULL(@RFATreatmentTo,0) <> 0 
				BEGIN
				IF ISNULL(@RFATreatmentFrom,0) <> 0 SET @Details = @Details + ' and ending at ' + cast(@RFATreatmentTo as varchar(50)) +' cm'
				ELSE  SET @Details = @Details + ' ending at ' + cast(@RFATreatmentTo as varchar(50)) +' cm'
				END
				SET @Details = @Details + ' from the incisors'
				END				

			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @GastrostomyInsertion =1
			BEGIN
			DECLARE @G bit, @J bit, @N bit
			SELECT @j = i.[JejunostomyInsertion], @G =i.[GastrostomyInsertion],@N = i.[NasoDuodenalTube] FROM [ERS_UpperGIIndications] i LEFT JOIN [ERS_Sites] s ON i.ProcedureId = s.ProcedureId WHERE s.SiteId = @SiteID
			IF @N = 1 SET @msg =' Nasojejunal tube (NJT)' ELSE IF @J= 1 SET @msg =' Jejunostomy insertion (PEJ)' ELSE SET @msg =' Gastrostomy insertion (PEG)'
			SET @Details = ''

			IF @GastrostomyInsertionType > 0
				BEGIN
				IF @GastrostomyInsertionSize>0
					BEGIN
					SET @Details = @Details + cast(@GastrostomyInsertionSize as varchar(50))
					IF @J=1 SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG units' AND [ListItemNo] = @GastrostomyInsertionUnits)
					ELSE IF @N =1 SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG units' AND [ListItemNo] = @GastrostomyInsertionUnits)
					ELSE SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG units' AND [ListItemNo] = @GastrostomyInsertionUnits)
					END
				END
				IF @GastrostomyInsertionType>0
						BEGIN
						IF @J=1 SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG type' AND [ListItemNo] = @GastrostomyInsertiontype)
						ELSE IF @N =1 SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG type' AND [ListItemNo] = @GastrostomyInsertiontype)
						ELSE SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG type' AND [ListItemNo] = @GastrostomyInsertiontype)
						END
				IF ISNULL(@GastrostomyInsertionBatchNo, '') <> ''  SET @Details = @Details + ' batch ' + @GastrostomyInsertionBatchNo
				
				IF @CorrectPEGPlacement = 2 SET @Details = @Details + ' incorrectly placed ' + isnull(@PEGPlacementFailureReason, '')
				    
				
				IF @Details<>'' SET @msg = @msg + ': ' + @Details
				--Add full stop 
				SET @msg = RTrim(LTRIM(@msg))
				IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
				--------------
				SET @summary = @summary + @msg + @br
				END

		IF @GastrostomyRemoval = 1
		BEGIN
			SET @msg =' Gastrostomy PEG Removal'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		IF @PyloricDilatation= 1
		BEGIN
			SET @msg =' Pyloric dilatation'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @NGNJInsertion = 1 
		BEGIN
			Set @msg = ' NG/NJ tube insertion'
			IF isnull(@NGNJTubeBatch, '') <> '' 
				SET @msg = @msg + ' (batch ' + @NGNJTubeBatch + ')'
			IF isnull(@NGNJTubeLength, 0) > 0
			BEGIN
				SET @msg = @msg + '. Tube length ' + convert(varchar, @NGNJTubeLength) + 'cm'
				IF isnull(@NGNJTubeNostril, 0) > 0
				BEGIN
					SELECT @msg = @msg + CASE WHEN @NGNJTubeNostril = 1 THEN ' at the right nostril'
											  WHEN @NGNJTubeNostril = 2 THEN ' at the left nostril'
										 END
				END
			END
			ELSE
			BEGIN
				IF isnull(@NGNJTubeNostril, 0) > 0
				BEGIN
					SELECT @msg = @msg + CASE WHEN @NGNJTubeNostril = 1 THEN ' via the right nostril'
											  WHEN @NGNJTubeNostril = 2 THEN ' via the left nostril'
										 END
				END
			END
			IF isnull(@NGNJTubeBridle, 0) = 1 
				SET @msg = @msg + ', bridle used'

			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @pHProbeInsert= 1
			BEGIN
			SET @msg =' pH probe insertion'
			SET @Details = ''
			IF @pHProbeInsertAt > 0 SET @Details = @Details + ' inserted at ' + CAST(@pHProbeInsertAt as varchar(50))+' cm'
			IF ISNULL(@pHProbeInsertChkTopTo,0) <> 0 
			BEGIN
				IF @Details <> '' SET @Details = @Details + ', '
				SET @Details = @Details + 'endoscopic check performed, top of probe at ' + CAST(@pHProbeInsertChkTopTo as varchar(50))+' cm'
			END
			--ELSE  SET @Details = @Details + ', insertion checked endoscopically'

			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @Haemospray= 1
		BEGIN
			SET @msg =' Haemospray'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @Sigmoidopexy= 1
		BEGIN
			
			SET @msg =' Sigmoidopexy'
			SET @Details = ''
			IF @SigmoidopexyQty > 0 SET @Details = @Details + CONVERT(VARCHAR, @SigmoidopexyQty)
			IF @SigmoidopexyMake > 0 SET @Details = @Details + ' ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Sigmoidopexy make' AND [ListItemNo] = @SigmoidopexyMake)

			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @Marking= 1
		BEGIN
			--MH added on 19 Oct 2021
			Declare @TattoLocationMessage varchar(50)
			Declare @TattoMessage varchar(100)
			declare @MaxId int, @MinId int, @loopCounter int

			Set @TattoLocationMessage = ''
			Set @TattoMessage = ''
			If @TattooLocationDistal > 0 
			Begin
				Set @TattoLocationMessage = 'Distal'
			End

			If @TattooLocationProximal > 0 
			Begin
				if @TattoLocationMessage = ''			
					begin
						Set @TattoLocationMessage = 'Proximal'
					end
				else
					begin
						Set @TattoLocationMessage = @TattoLocationMessage + ',Proximal'
					end		
			End

			Select @MinId = Min(id),@MaxId=Max(id) from fnSplitString(@TattoLocationMessage,',') 
			Set @loopCounter = @MinId
			While @loopCounter < (@MaxId+1)
			begin
				if @loopCounter = 1
				begin
					Set @TattoMessage = (Select Item from fnSplitString(@TattoLocationMessage,',') Where Id = @loopCounter)
				end
				else
				begin
					if @loopCounter <> @MaxId 
					begin
						Set @TattoMessage = @TattoMessage + ', ' + (Select Item from fnSplitString(@TattoLocationMessage,',') Where Id = @loopCounter)
					end
					else
					begin
						Set @TattoMessage = @TattoMessage + ' and ' + (Select Item from fnSplitString(@TattoLocationMessage,',') Where Id = @loopCounter)
					end

				end

				set @loopCounter = @loopCounter + 1
			END

			SET @msg =' Abnormality marked'
			SET @Details = ''
			IF @MarkingType > 0 SET @Details = @Details + ' by ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Abno marking' AND [ListItemNo] = @MarkingType)

			IF @Details<>'' SET @msg = @msg + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br

		END

		  If @MarkedQuantity > 0
		begin
			IF @summary <> '' SET @summary = @summary
			SET @summary = @summary + 'Total volume used ' + Convert(varchar(5),@MarkedQuantity) + ' ml.' + @br
		end
		
	  --MH added on 19 Oct 2021
	  If @TattoMessage <> ''
	  BEGIN		
		SET @summary = @summary + 'Tattoo located at ' + ISNULL(@TattoMessage, '') + @br		
	  End	  
		IF @Clip= 1
		BEGIN 
			SET @msg = CASE WHEN @ClipNum > 1 THEN  CAST(@ClipNum as varchar(5)) + ' clips'
							WHEN @ClipNum = 1 THEN  CAST(@ClipNum as varchar(5)) + ' clip'
							ELSE 'Clip'
						END
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
		IF @EndoClot = 1
		BEGIN 
			SET @msg = 'EndoClot used'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
		IF @ColonicDecompression = 1
		BEGIN 
			SET @msg = 'Colonic decompression'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
		IF @FlatusTubeInsertion = 1
		BEGIN 
			SET @msg = 'Flatus tube insertion'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
		IF @PancolonicDyeSpray = 1
		BEGIN 
			SET @msg = 'Pancolonic dye spray'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @BougieDilation = 1
		BEGIN 
			SET @msg = 'Bougie dilation'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
		IF LTRIM(RTRIM(@other)) <> ''
			BEGIN
			SET @msg =' ' + LTRIM(RTRIM(@other))
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary =  @summary + @msg  +@br
		END
		
		--Remove last <br />
		IF RIGHT(RTRIM(@summary),6) = '<br />'
		BEGIN
			SET @summary = RTRIM(@summary)
			SET @summary = LEFT(@summary, LEN(@summary) - 6)
		END

	--END
	
	-- Finally, update the summary in Therapeutics  table
	UPDATE dbo.ERS_UpperGITherapeutics 
	SET Summary=@summary 
	WHERE SiteId = @SiteId -- AND CarriedOutRole=1;	--### Summary text is Applicable only for TrainER....
	--WHERE Id = @TherapeuticId
	
	DECLARE @region VARCHAR(100)
	DECLARE @AreaNo INT
	DECLARE @insertionType VARCHAR(100)
	DECLARE @htmlAnchorCode VARCHAR(500)
	DECLARE @SummaryWithLinks VARCHAR(MAX)

	SELECT @region = CASE WHEN s.SiteNo = -77 THEN						--SiteNo is set to -77 for sites By Distance (Col & Sig only)
						CONVERT(VARCHAR,XCoordinate) +  
							CASE WHEN YCoordinate IS NULL OR YCoordinate=0 THEN ' cm' 
							ELSE (' to ' + CONVERT(VARCHAR,YCoordinate) + ' cm' ) 
							END
					ELSE (SELECT r.Region FROM ERS_Regions r WHERE r.RegionId = s.RegionId)
					END, 
			@AreaNo = ISNULL(AreaNo,0)
	FROM ERS_Sites s
	JOIN ERS_Procedures p ON s.ProcedureId = p.ProcedureId
	WHERE SiteId = @SiteId
	
	SET @htmlAnchorCode = '<a href="#" class="sitesummary" onclick="OpenSiteDetails(''' + @region + ''',' + CONVERT(VARCHAR(10),@SiteId) + ',''Therapeutic Procedures'', ''{0}'' , '''+ CONVERT(VARCHAR,@AreaNo) +  ''');">{1}</a>'

	SET @Summary = ''
	SET @SummaryWithLinks = ''
	DECLARE @SummaryHeading VARCHAR(200) = 'Post procedure patient care'
	
	IF @GastrostomyInsertion = 1
	BEGIN
		SET @insertionType = 'PEG'
		SET @SummaryHeading = 'Instructions for PEG care'
		IF @FlangePosition > 0 SET @Summary = 'Flange at ' + CONVERT(varchar, @FlangePosition) + ' cm.'
		IF @NilByMouth = 1
		BEGIN
			IF @Summary <> '' SET @Summary = @Summary + ' Nil by mouth' ELSE SET @Summary = 'Nil by mouth'
			IF @NilByMouthHrs > 0
			BEGIN
				SET @Summary = @Summary + ' for ' + CONVERT(varchar, @NilByMouthHrs)
				IF @NilByMouthHrs = 1
					SET @Summary = @Summary + ' hour'
				ELSE
					SET @Summary = @Summary + ' hours'
			END
		END
		IF @NilByProc = 1
		BEGIN
			IF @Summary <> '' SET @Summary = @Summary + ', nil by PEG' ELSE SET @Summary = 'Nil by PEG'
			IF @NilByProcHrs > 0
			BEGIN
				SET @Summary = @Summary + ' for ' + CONVERT(varchar, @NilByProcHrs)
				IF @NilByProcHrs = 1
					SET @Summary = @Summary + ' hour'
				ELSE
					SET @Summary = @Summary + ' hours'
			END
		END
		IF @Summary <> '' SET @Summary = @Summary + '.'
		IF @AttachmentToWard = 1
		BEGIN
			IF @Summary <> '' SET @Summary = @Summary + ' All attachments for feeding returned to the ward with patient.' ELSE SET @Summary = 'All attachments for feeding returned to the ward with patient.'
		END		
	END	
	ELSE
	BEGIN	
		IF @YAGLaser = 1
		BEGIN
			SET @insertionType = 'YAG'
			IF @OesoYAGNilByMouth = 1
			BEGIN
				SET @Summary = 'Nil by mouth'
				IF @OesoYAGNilByMouthHrs > 0
				BEGIN
					SET @Summary = @Summary + ' for ' + CONVERT(varchar, @OesoYAGNilByMouthHrs)
					IF @OesoYAGNilByMouthHrs = 1
						SET @Summary = @Summary + ' hour'
					ELSE
						SET @Summary = @Summary + ' hours'
				END
			END

			IF @OesoYAGWarmFluids = 1
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ', warm fluids only' ELSE SET @Summary = 'Warm fluids only'
				IF @OesoYAGWarmFluidsHrs > 0
				BEGIN
					SET @Summary = @Summary + ' for ' + CONVERT(varchar, @OesoYAGWarmFluidsHrs)
					IF @OesoYAGWarmFluidsHrs = 1
						SET @Summary = @Summary + ' hour'
					ELSE
						SET @Summary = @Summary + ' hours'
				END
			END

			IF @OesoYAGSoftDiet = 1
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ', soft diet' ELSE SET @Summary = 'Soft diet'
				IF @OesoYAGSoftDietDays > 0
				BEGIN
					SET @Summary = @Summary + ' for ' + CONVERT(varchar, @OesoYAGSoftDietDays)
					IF @OesoYAGSoftDietDays = 1
						SET @Summary = @Summary + ' day'
					ELSE
						SET @Summary = @Summary + ' days'
				END
			END

			IF @Summary <> '' SET @Summary = @Summary + '.'

			IF @OesoYAGMedicalReview = 1
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ' Medical review before discharge.' ELSE SET @Summary = 'Medical review before discharge.'
			END
		END

		IF @OesophagealDilatation = 1 OR @StentInsertion = 1
		BEGIN
			SET @insertionType = 'STENT'
			IF @OesoDilNilByMouth = 1
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ' Nil by mouth' ELSE SET @Summary = 'Nil by mouth'
				IF @OesoDilNilByMouthHrs > 0
				BEGIN
					SET @Summary = @Summary + ' for ' + CONVERT(varchar, @OesoDilNilByMouthHrs)
					IF @OesoDilNilByMouthHrs = 1
						SET @Summary = @Summary + ' hour'
					ELSE
						SET @Summary = @Summary + ' hours'
				END
			END

			IF @OesoDilWarmFluids = 1
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ', warm fluids only' ELSE SET @Summary = 'Warm fluids only'
				IF @OesoDilWarmFluidsHrs > 0
				BEGIN
					SET @Summary = @Summary + ' for ' + CONVERT(varchar, @OesoDilWarmFluidsHrs)
					IF @OesoDilWarmFluidsHrs = 1
						SET @Summary = @Summary + ' hour'
					ELSE
						SET @Summary = @Summary + ' hours'
				END
			END

			IF @OesoDilSoftDiet = 1
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ', soft diet' ELSE SET @Summary = 'Soft diet'
				IF @OesoDilSoftDietDays > 0
				BEGIN
					SET @Summary = @Summary + ' for ' + CONVERT(varchar, @OesoDilSoftDietDays)
					IF @OesoDilSoftDietDays = 1
						SET @Summary = @Summary + ' day'
					ELSE
						SET @Summary = @Summary + ' days'
				END
			END

			IF @OesoDilXRay = 1
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ', chest X-ray' ELSE SET @Summary = 'Chest X-ray'
				IF @OesoDilXRayHrs > 0
				BEGIN
					SET @Summary = @Summary + ' after ' + CONVERT(varchar, @OesoDilXRayHrs)
					IF @OesoDilXRayHrs = 1
						SET @Summary = @Summary + ' hour'
					ELSE
						SET @Summary = @Summary + ' hours'
				END
			END

			IF @Summary <> '' SET @Summary = @Summary + '.'

			IF @OesoDilMedicalReview = 1
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ' Medical review before discharge.' ELSE SET @Summary = 'Medical review before discharge.'
			END
		END

		IF @Sigmoidopexy= 1
		BEGIN
			SET @SummaryHeading = 'Ward instructions'
			IF ISNULL(@SigmoidopexyFluidsDays,0) > 0
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ' '
				SET @Summary = @Summary + 'Clear fluids for ' + CONVERT(varchar, @SigmoidopexyFluidsDays) 
								+ CASE WHEN @SigmoidopexyFluidsDays > 1 THEN ' days.' else ' day.' END
			END
			IF ISNULL(@SigmoidopexyAntibioticsDays,0) > 0
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ' '
				SET @Summary = @Summary + 'Antibiotics for ' + CONVERT(varchar, @SigmoidopexyAntibioticsDays) 
								+ CASE WHEN @SigmoidopexyAntibioticsDays > 1 THEN ' days.' ELSE ' day.' END
			END
		END
	END

	IF @Summary = '' SET @SummaryHeading = ''

	-- Finally, update the summary in PP_InstForCare  table
	UPDATE p
	SET PP_InstForCare = @Summary
		, PP_InstForCareHeading = @SummaryHeading
		, PP_InstForCareWithLinks = REPLACE(REPLACE(@htmlAnchorCode, '{0}', @insertionType), '{1}', @Summary)
	FROM ERS_ProceduresReporting p
	INNER JOIN ERS_Sites s ON p.ProcedureId = s.ProcedureId
	WHERE s.SiteId = @SiteId;

	DROP TABLE #tmp_UpperGITherapeutics;
 END


------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	
-- TFS#	
-- Description of change
-- 
------------------------------------------------------------------------------------------------------------------------
GO




--DECLARE @IndicationsId INT , @ProcedureTypeIds VARCHAR(2000), @IndicationsSectionId INT

--SELECT @IndicationsId = UniqueId FROM dbo.ERS_Indications WHERE NEDTerm = 'Oesophagitis surveillance'

--IF NOT EXISTS (SELECT 1 FROM dbo.ERS_IndicationsProcedureTypes WHERE IndicationId = @IndicationsId AND ProcedureTypeId = 6)
--BEGIN
--    INSERT INTO dbo.ERS_IndicationsProcedureTypes
--    (
--        IndicationId,
--        ProcedureTypeId
--    )
--    VALUES ( @IndicationsId, 6)
--END
--GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO


------------------------------------------------------------------------------------------------------------------------
-- Updated by	: Andrea 09.01.23	
-- TFS#	3453
-- Description of change
-- New therapeutics
------------------------------------------------------------------------------------------------------------------------
GO


 ALTER PROCEDURE [dbo].[therapeutics_ercp_summary_update]
(
	@TherapeuticId AS INT,
	@SiteId INT
)
AS
	SET NOCOUNT ON
	DECLARE	  @msg		VARCHAR(1000)
			, @Details	VARCHAR(1000)
			, @Summary	VARCHAR(4000)=''
			, @Area		VARCHAR(500)=''
			, @br VARCHAR(6) = '<br />';

	DECLARE
	@None BIT,
	@YAGLaser BIT,
	@YAGLaserWatts INT,
	@YAGLaserPulses INT,
	@YAGLaserSecs decimal(8,2),
	@YAGLaserKJ decimal(8,2),
	@ArgonBeamDiathermy BIT,
	@ArgonBeamDiathermyWatts INT,
	@ArgonBeamDiathermyPulses INT,
	@ArgonBeamDiathermySecs decimal(8,2),
	@ArgonBeamDiathermyKJ decimal(8,2),		
	@HeatProbe BIT,					
	@BicapElectro BIT,				
	@Diathermy BIT,						
	@HotBiopsy BIT,
	@BandLigation BIT,
    @BandLigationPerformed INT,
	@BandLigationSuccess INT,
	@BotoxInjection BIT,
    @EndoloopPlacement BIT,
    @ForeignBody BIT,
	@Injection BIT,
	@InjectionType INT,
	@InjectionVolume INT,
	@InjectionNumber INT,
	@GastrostomyInsertion BIT,
	@GastrostomyInsertionSize numeric(9,2),
	@GastrostomyInsertionUnits TINYINT,
	@GastrostomyInsertionType TINYINT,
	@GastrostomyInsertionBatchNo VARCHAR(100),
	@GastrostomyRemoval BIT,
	@NilByMouth BIT,
	@NilByMouthHrs INT,
	@NilByProc BIT,
	@NilByProcHrs INT,
	@AttachmentToWard BIT,
	@PyloricDilatation BIT,	
	@StentInsertion BIT,
	@StentInsertionQty INT,
	@RadioactiveWirePlaced BIT,	
	@StentInsertionBatchNo VARCHAR(100),
	@StentRemoval BIT,
	@StentRemovalTechnique INT,
	@EMR BIT,
	@EMRType TINYINT,
	@EMRFluid INT,
	@EMRFluidVolume INT,
	@Marking BIT,
	@MarkingType INT,
	@Clip BIT,						
	@ClipNum INT,
	@Papillotomy BIT,
	@Sphincterotome TINYINT,
	@PapillotomyLength REAL,
	@PapillotomyAcceptBalloonSize REAL,
	@ReasonForPapillotomy TINYINT,
	@PapillotomyBleeding TINYINT,
	@SphincterDecompressed TINYINT,
	@PanOrificeSphincterotomy BIT,
	@StoneRemoval BIT,
	@RemovalUsing TINYINT,
	@ExtractionOutcome TINYINT,
	@InadequateSphincterotomy BIT,
	@StoneSize BIT,
	@QuantityOfStones BIT,
	@ImpactedStones BIT,
	@OtherReason BIT,
	@OtherReasonText VARCHAR(200),
	@StoneDecompressed TINYINT,
	@StrictureDilatation BIT,
	@DilatedTo REAL,
	@DilatationUnits TINYINT,
	@DilatorType TINYINT,
	@EndoscopicCystPuncture BIT,
	@CystPunctureDevice TINYINT,
	@CystPunctureVia TINYINT,
	@Cannulation BIT,
	@Manometry BIT,
	@Haemostasis BIT,
	@NasopancreaticDrain BIT,
	@RendezvousProcedure BIT,
	@SnareExcision SMALLINT,
	@BalloonDilation BIT,
	@BalloonDilatedTo REAL,
	@BalloonDilatationUnits SMALLINT,
	@BalloonDilatorType SMALLINT,
	@BalloonTrawl BIT,
	@BalloonTrawlDilatorType SMALLINT,
	@BalloonTrawlDilatorSize REAL,
	@BalloonTrawlDilatorUnits SMALLINT,
	@BalloonDecompressed TINYINT,
	@DiagCholangiogram SMALLINT,
	@DiagPancreatogram SMALLINT,
	@EndoscopistRole SMALLINT,
	@Other VARCHAR(1000),
	@EUSProcType SMALLINT,
	@CorrectStentPlacement bit,
	@CorrectStentPlacementNoReason int,
	@BalloonDilatation bit,
	@BougieDilatation bit,
	@BougieDilation bit,
	@BrushCytology bit,
	@Cholangioscopy bit,
	@StentChange bit,
	@StentPlacement bit,
	@RadioFrequencyAblation bit,
	@FineNeedleAspiration bit,
	@FineNeedleAspirationType tinyint,
	@FineNeedleBiopsy BIT,
	@Polypectomy BIT,
	@Diverticulotomy BIT,
	@Homeostasis BIT,
	@HomeostasisType INT

--BEGIN TRY

	SELECT * INTO #tmp_ERCPTherapeutics 
	FROM dbo.ERS_ERCPTherapeutics 
	WHERE (Id = @TherapeuticId OR SiteID = @SiteId)

--## 1) If 'CarriedOutRole=2 (EE)' record is found for a SiteId in [ERS_ERCPTherapeutics] means it has both EE/ER Entries...
	--IF EXISTS(SELECT 'ER' FROM dbo.ERS_ERCPTherapeutics WHERE SiteId=@SiteId AND CarriedOutRole=2)
		BEGIN
			--PRINT '[ERS_ERCPTherapeutics] has both EE/ER Entries...';
			;WITH eeRecord AS(
				SELECT * FROM #tmp_ERCPTherapeutics WHERE CarriedOutRole = (SELECT MAX(CarriedOutRole) FROM #tmp_ERCPTherapeutics) --## 2 is EE
			)
			SELECT
				@None				= (CASE WHEN IsNull(ER.[None], 0) = 0 THEN EE.[None] ELSE ER.[None] END),
				@YAGLaser			= (CASE WHEN IsNull(ER.YAGLaser, 0) = 0 THEN EE.YAGLaser ELSE ER.YAGLaser END),
				@YAGLaserWatts		= (CASE WHEN IsNull(ER.YAGLaserWatts, 0) = 0 THEN EE.YAGLaserWatts ELSE ER.YAGLaserWatts END),
				@YAGLaserPulses		= (CASE WHEN IsNull(ER.YAGLaserPulses, 0) = 0 THEN EE.YAGLaserPulses ELSE ER.YAGLaserPulses END),
				@YAGLaserSecs		= (CASE WHEN IsNull(ER.YAGLaserSecs, 0) = 0 THEN EE.YAGLaserSecs ELSE ER.YAGLaserSecs END),
				@YAGLaserKJ			= (CASE WHEN IsNull(ER.YAGLaserKJ, 0) = 0 THEN EE.YAGLaserKJ ELSE ER.YAGLaserKJ END),
				@ArgonBeamDiathermy	= (CASE WHEN IsNull(ER.ArgonBeamDiathermy, 0) = 0 THEN EE.ArgonBeamDiathermy ELSE ER.ArgonBeamDiathermy END),
				@ArgonBeamDiathermyWatts		= (CASE WHEN IsNull(ER.ArgonBeamDiathermyWatts, 0) = 0 THEN EE.ArgonBeamDiathermyWatts ELSE ER.ArgonBeamDiathermyWatts END),
				@ArgonBeamDiathermyPulses		= (CASE WHEN IsNull(ER.ArgonBeamDiathermyPulses, 0) = 0 THEN EE.ArgonBeamDiathermyPulses ELSE ER.ArgonBeamDiathermyPulses END),
				@ArgonBeamDiathermySecs			= (CASE WHEN IsNull(ER.ArgonBeamDiathermySecs, 0) = 0 THEN EE.ArgonBeamDiathermySecs ELSE ER.ArgonBeamDiathermySecs END),
				@ArgonBeamDiathermyKJ			= (CASE WHEN IsNull(ER.ArgonBeamDiathermyKJ, 0) = 0 THEN EE.ArgonBeamDiathermyKJ ELSE ER.ArgonBeamDiathermyKJ END),
				@HeatProbe			= (CASE WHEN IsNull(ER.HeatProbe, 0) = 0 THEN EE.HeatProbe ELSE ER.HeatProbe END),
				@BicapElectro		= (CASE WHEN IsNull(ER.BicapElectro, 0) = 0 THEN EE.BicapElectro ELSE ER.BicapElectro END),
				@Diathermy			= (CASE WHEN IsNull(ER.Diathermy, 0) = 0 THEN EE.Diathermy ELSE ER.Diathermy END),
				@HotBiopsy			= (CASE WHEN IsNull(ER.HotBiopsy, 0) = 0 THEN EE.HotBiopsy ELSE ER.HotBiopsy END),
				@BandLigation= (CASE WHEN IsNull(ER.BandLigation, 0) = 0 THEN EE.BandLigation ELSE ER.BandLigation END),
				@BandLigationPerformed			= (CASE WHEN ISNULL(ER.[BandLigationPerformed], 0) = 0 THEN ER.[BandLigationPerformed] ELSE EE.[BandLigationPerformed] END),
				@BandLigationSuccess			= (CASE WHEN ISNULL(ER.[BandLigationSuccessful], 0) = 0 THEN ER.[BandLigationSuccessful] ELSE EE.[BandLigationSuccessful] END),
				@BotoxInjection = (CASE WHEN IsNull(ER.BotoxInjection, 0) = 0 THEN EE.BotoxInjection ELSE ER.BotoxInjection END),
				@EndoloopPlacement = (CASE WHEN IsNull(ER.EndoloopPlacement, 0) = 0 THEN EE.EndoloopPlacement ELSE ER.EndoloopPlacement END),
				@ForeignBody= (CASE WHEN IsNull(ER.ForeignBody, 0) = 0 THEN EE.ForeignBody ELSE ER.ForeignBody END),
				@Injection			= (CASE WHEN IsNull(ER.Injection, 0) = 0 THEN EE.Injection ELSE ER.Injection END),
				@InjectionType		= (CASE WHEN IsNull(ER.InjectionType, 0) = 0 THEN EE.InjectionType ELSE ER.InjectionType END),
				@InjectionVolume	= (CASE WHEN IsNull(ER.InjectionVolume, 0) = 0 THEN EE.InjectionVolume ELSE ER.InjectionVolume END),
				@InjectionNumber	= (CASE WHEN IsNull(ER.InjectionNumber, 0) = 0 THEN EE.InjectionNumber ELSE ER.InjectionNumber END),
				@GastrostomyInsertion			= (CASE WHEN IsNull(ER.GastrostomyInsertion, 0) = 0 THEN EE.GastrostomyInsertion ELSE ER.GastrostomyInsertion END),
				@GastrostomyInsertionSize		= (CASE WHEN IsNull(ER.GastrostomyInsertionSize, 0) = 0 THEN EE.GastrostomyInsertionSize ELSE ER.GastrostomyInsertionSize END),
				@GastrostomyInsertionUnits		= (CASE WHEN ER.GastrostomyInsertionUnits IS NULL THEN EE.GastrostomyInsertionUnits ELSE ER.GastrostomyInsertionUnits END),
				@GastrostomyInsertionType		= (CASE WHEN IsNull(ER.GastrostomyInsertionType, 0) = 0 THEN EE.GastrostomyInsertionType ELSE ER.GastrostomyInsertionType END),
				@GastrostomyInsertionBatchNo	= (SELECT isnull((CASE WHEN IsNull(ER.GastrostomyInsertionBatchNo, '') = '' THEN EE.GastrostomyInsertionBatchNo ELSE ER.GastrostomyInsertionBatchNo END), '') as [text()] FOR XML PATH('')),
				@GastrostomyRemoval				= (CASE WHEN IsNull(ER.GastrostomyRemoval, 0) = 0 THEN EE.GastrostomyRemoval ELSE ER.GastrostomyRemoval END),
				@NilByMouth			= (CASE WHEN IsNull(ER.NilByMouth, 0) = 0 THEN EE.NilByMouth ELSE ER.NilByMouth END),
				@NilByMouthHrs		= (CASE WHEN IsNull(ER.NilByMouthHrs, 0) = 0 THEN EE.NilByMouthHrs ELSE ER.NilByMouthHrs END),
				@NilByProc			= (CASE WHEN IsNull(ER.NilByProc, 0) = 0 THEN EE.NilByProc ELSE ER.NilByProc END),
				@NilByProcHrs		= (CASE WHEN IsNull(ER.NilByProcHrs, 0) = 0 THEN EE.NilByProcHrs ELSE ER.NilByProcHrs END),
				@AttachmentToWard	= (CASE WHEN IsNull(ER.AttachmentToWard, 0) = 0 THEN EE.AttachmentToWard ELSE ER.AttachmentToWard END),
				@PyloricDilatation	= (CASE WHEN IsNull(ER.PyloricDilatation, 0) = 0 THEN EE.PyloricDilatation ELSE ER.PyloricDilatation END),
				@StentInsertion		= (CASE WHEN IsNull(ER.StentInsertion, 0) = 0 THEN EE.StentInsertion ELSE ER.StentInsertion END),
				@StentInsertionQty	= (CASE WHEN IsNull(ER.StentInsertionQty, 0) = 0 THEN EE.StentInsertionQty ELSE ER.StentInsertionQty END),
				@RadioactiveWirePlaced			= (CASE WHEN IsNull(ER.RadioactiveWirePlaced, 0) = 0 THEN EE.RadioactiveWirePlaced ELSE ER.RadioactiveWirePlaced END),
				@StentInsertionBatchNo			= (SELECT isnull((CASE WHEN IsNull(ER.StentInsertionBatchNo,'')= '' THEN EE.StentInsertionBatchNo ELSE ER.StentInsertionBatchNo END), '') as [text()] FOR XML PATH('')),
				@StentRemoval					= (CASE WHEN IsNull(ER.StentRemoval, 0) = 0 THEN EE.StentRemoval ELSE ER.StentRemoval END),
				@StentRemovalTechnique			= (CASE WHEN IsNull(ER.StentRemovalTechnique, 0) = 0 THEN EE.StentRemovalTechnique ELSE ER.StentRemovalTechnique END),
				@EMR				= (CASE WHEN IsNull(ER.EMR, 0) = 0 THEN EE.EMR ELSE ER.EMR END),
				@EMRType			= (CASE WHEN IsNull(ER.EMRType, 0) = 0 THEN EE.EMRType ELSE ER.EMRType END),
				@EMRFluid			= (CASE WHEN IsNull(ER.EMRFluid, 0) = 0 THEN EE.EMRFluid ELSE ER.EMRFluid END),
				@EMRFluidVolume		= (CASE WHEN IsNull(ER.EMRFluidVolume, 0) = 0 THEN EE.EMRFluidVolume ELSE ER.EMRFluidVolume END),
				@Marking			= (CASE WHEN IsNull(ER.Marking, 0) = 0 THEN EE.Marking ELSE ER.Marking END),
				@MarkingType		= (CASE WHEN IsNull(ER.MarkingType, 0) = 0 THEN EE.MarkingType ELSE ER.MarkingType END),
				@Clip				= (CASE WHEN IsNull(ER.Clip, 0) = 0 THEN EE.Clip ELSE ER.Clip END),
				@ClipNum			= (CASE WHEN IsNull(ER.ClipNum, 0) = 0 THEN EE.ClipNum ELSE ER.ClipNum END),
				@Papillotomy		= (CASE WHEN IsNull(ER.Papillotomy, 0) = 0 THEN EE.Papillotomy ELSE ER.Papillotomy END),
				@Sphincterotome		= (CASE WHEN IsNull(ER.Sphincterotome, 0) = 0 THEN EE.Sphincterotome ELSE ER.Sphincterotome END),
				@PapillotomyLength	= (CASE WHEN IsNull(ER.PapillotomyLength, 0) = 0 THEN EE.PapillotomyLength ELSE ER.PapillotomyLength END),
				@PapillotomyAcceptBalloonSize	= (CASE WHEN IsNull(ER.PapillotomyAcceptBalloonSize, 0) = 0 THEN EE.PapillotomyAcceptBalloonSize ELSE ER.PapillotomyAcceptBalloonSize END),
				@ReasonForPapillotomy		= (CASE WHEN IsNull(ER.ReasonForPapillotomy, 0) = 0 THEN EE.ReasonForPapillotomy ELSE ER.ReasonForPapillotomy END),
				@PapillotomyBleeding		= (CASE WHEN IsNull(ER.PapillotomyBleeding, 0) = 0 THEN EE.PapillotomyBleeding ELSE ER.PapillotomyBleeding END),
				@SphincterDecompressed		= (CASE WHEN IsNull(ER.SphincterDecompressed, 0) = 0 THEN EE.SphincterDecompressed ELSE ER.SphincterDecompressed END),
				@PanOrificeSphincterotomy	= (CASE WHEN IsNull(ER.PanOrificeSphincterotomy, 0) = 0 THEN EE.PanOrificeSphincterotomy ELSE ER.PanOrificeSphincterotomy END),
				@StoneRemoval				= (CASE WHEN IsNull(ER.StoneRemoval, 0) = 0 THEN EE.StoneRemoval ELSE ER.StoneRemoval END),
				@RemovalUsing				= (CASE WHEN IsNull(ER.RemovalUsing, 0) = 0 THEN EE.RemovalUsing ELSE ER.RemovalUsing END),
				@ExtractionOutcome			= (CASE WHEN IsNull(ER.ExtractionOutcome, 0) = 0 THEN EE.ExtractionOutcome ELSE ER.ExtractionOutcome END),
				@InadequateSphincterotomy	= (CASE WHEN IsNull(ER.InadequateSphincterotomy, 0) = 0 THEN EE.InadequateSphincterotomy ELSE ER.InadequateSphincterotomy END),
				@StoneSize			= (CASE WHEN IsNull(ER.StoneSize, 0) = 0 THEN EE.StoneSize ELSE ER.StoneSize END),
				@QuantityOfStones	= (CASE WHEN IsNull(ER.QuantityOfStones, 0) = 0 THEN EE.QuantityOfStones ELSE ER.QuantityOfStones END),
				@ImpactedStones		= (CASE WHEN IsNull(ER.ImpactedStones, 0) = 0 THEN EE.ImpactedStones ELSE ER.ImpactedStones END),
				@OtherReason		= (CASE WHEN IsNull(ER.OtherReason, 0) = 0 THEN EE.OtherReason ELSE ER.OtherReason END),
				@OtherReasonText	= (SELECT isnull((CASE WHEN IsNull(ER.OtherReasonText, '') = '' THEN EE.OtherReasonText ELSE ER.OtherReasonText END), '') as [text()] FOR XML PATH('')),
				@StoneDecompressed	= (CASE WHEN IsNull(ER.StoneDecompressed, 0) = 0 THEN EE.StoneDecompressed ELSE ER.StoneDecompressed END),
				@StrictureDilatation= (CASE WHEN IsNull(ER.StrictureDilatation, 0) = 0 THEN EE.StrictureDilatation ELSE ER.StrictureDilatation END),
				@DilatedTo			= (CASE WHEN IsNull(ER.DilatedTo, 0) = 0 THEN EE.DilatedTo ELSE ER.DilatedTo END),
				@DilatationUnits	= (CASE WHEN ER.DilatationUnits IS NULL THEN EE.DilatationUnits ELSE ER.DilatationUnits END),
				@DilatorType		= (CASE WHEN IsNull(ER.DilatorType, 0) = 0 THEN EE.DilatorType ELSE ER.DilatorType END),
				@EndoscopicCystPuncture	= (CASE WHEN IsNull(ER.EndoscopicCystPuncture, 0) = 0 THEN EE.EndoscopicCystPuncture ELSE ER.EndoscopicCystPuncture END),
				@CystPunctureDevice		= (CASE WHEN IsNull(ER.CystPunctureDevice, 0) = 0 THEN EE.CystPunctureDevice ELSE ER.CystPunctureDevice END),
				@CystPunctureVia		= (CASE WHEN IsNull(ER.CystPunctureVia, 0) = 0 THEN EE.CystPunctureVia ELSE ER.CystPunctureVia END),
				@Cannulation			= (CASE WHEN IsNull(ER.Cannulation, 0) = 0 THEN EE.Cannulation ELSE ER.Cannulation END),
				@Manometry				= (CASE WHEN IsNull(ER.Manometry, 0) = 0 THEN EE.Manometry ELSE ER.Manometry END),
				@Haemostasis			= (CASE WHEN IsNull(ER.Haemostasis, 0) = 0 THEN EE.Haemostasis ELSE ER.Haemostasis END),
				@NasopancreaticDrain	= (CASE WHEN IsNull(ER.NasopancreaticDrain, 0) = 0 THEN EE.NasopancreaticDrain ELSE ER.NasopancreaticDrain END),
				@RendezvousProcedure	= (CASE WHEN IsNull(ER.RendezvousProcedure, 0) = 0 THEN EE.RendezvousProcedure ELSE ER.RendezvousProcedure END),
				@SnareExcision			= (CASE WHEN IsNull(ER.SnareExcision, 0) = 0 THEN EE.SnareExcision ELSE ER.SnareExcision END),
				@BalloonDilation		= (CASE WHEN IsNull(ER.BalloonDilation, 0) = 0 THEN EE.BalloonDilation ELSE ER.BalloonDilation END),
				@BalloonDilatedTo		= (CASE WHEN IsNull(ER.BalloonDilatedTo, 0) = 0 THEN EE.BalloonDilatedTo ELSE ER.BalloonDilatedTo END),
				@BalloonDilatationUnits	= (CASE WHEN IsNull(ER.BalloonDilatationUnits, 0) = 0 THEN EE.BalloonDilatationUnits ELSE ER.BalloonDilatationUnits END),
				@BalloonDilatorType		= (CASE WHEN IsNull(ER.BalloonDilatorType, 0) = 0 THEN EE.BalloonDilatorType ELSE ER.BalloonDilatorType END),
				@BalloonTrawl			= (CASE WHEN IsNull(ER.BalloonTrawl, 0) = 0 THEN EE.BalloonTrawl ELSE ER.BalloonTrawl END),
				@BalloonTrawlDilatorType	= (CASE WHEN IsNull(ER.BalloonTrawlDilatorType, 0) = 0 THEN EE.BalloonTrawlDilatorType ELSE ER.BalloonTrawlDilatorType END),
				@BalloonTrawlDilatorSize	= (CASE WHEN IsNull(ER.BalloonTrawlDilatorSize, 0) = 0 THEN EE.BalloonTrawlDilatorSize ELSE ER.BalloonTrawlDilatorSize END),
				@BalloonTrawlDilatorUnits	= (CASE WHEN IsNull(ER.BalloonTrawlDilatorUnits, 0) = 0 THEN EE.BalloonTrawlDilatorUnits ELSE ER.BalloonTrawlDilatorUnits END),
				@BalloonDecompressed		= (CASE WHEN IsNull(ER.BalloonDecompressed, 0) = 0 THEN EE.BalloonDecompressed ELSE ER.BalloonDecompressed END),
				@DiagCholangiogram			= (CASE WHEN IsNull(ER.DiagCholangiogram, 0) = 0 THEN EE.DiagCholangiogram ELSE ER.DiagCholangiogram END),
				@DiagPancreatogram			= (CASE WHEN IsNull(ER.DiagPancreatogram, 0) = 0 THEN EE.DiagPancreatogram ELSE ER.DiagPancreatogram END),
				@EndoscopistRole			= (CASE WHEN IsNull(ER.CarriedOutRole, 0) = 0 THEN EE.CarriedOutRole ELSE ER.CarriedOutRole END),
				@Other						= (CASE WHEN IsNull(ER.Other, '') ='' THEN EE.Other ELSE ER.Other END),
				@EUSProcType				= (CASE WHEN IsNull(ER.EUSProcType, 0) = 0 THEN EE.EUSProcType ELSE ER.EUSProcType END),
				@CorrectStentPlacement		= ER.CorrectStentPlacement,
				@CorrectStentPlacementNoReason			= (CASE WHEN IsNull(ER.CorrectStentPlacementNoReason, 0) = 0 THEN EE.CorrectStentPlacementNoReason ELSE ER.CorrectStentPlacementNoReason END),
				@BalloonDilatation			= (CASE WHEN IsNull(ER.BalloonDilatation, 0) = 0 THEN EE.BalloonDilatation ELSE ER.BalloonDilatation END),
				@BougieDilatation			= (CASE WHEN IsNull(ER.BougieDilatation, 0) = 0 THEN EE.BougieDilatation ELSE ER.BougieDilatation END),
				@BougieDilation				= (CASE WHEN IsNull(ER.BougieDilation, 0) = 0 THEN EE.BougieDilation ELSE ER.BougieDilation END),
				@BrushCytology				= (CASE WHEN IsNull(ER.BrushCytology, 0) = 0 THEN EE.BrushCytology ELSE ER.BrushCytology END),
				@Cholangioscopy				= (CASE WHEN IsNull(ER.Cholangioscopy, 0) = 0 THEN EE.Cholangioscopy ELSE ER.Cholangioscopy END),
				@StentChange				= (CASE WHEN IsNull(ER.StentChange, 0) = 0 THEN EE.StentChange ELSE ER.StentChange END),
				@StentPlacement				= (CASE WHEN IsNull(ER.StentPlacement, 0) = 0 THEN EE.StentPlacement ELSE ER.StentPlacement END),
				@RadioFrequencyAblation		= (CASE WHEN IsNull(ER.RadioFrequencyAblation, 0) = 0 THEN EE.RadioFrequencyAblation ELSE ER.RadioFrequencyAblation END),
				@FineNeedleAspiration		= (CASE WHEN IsNull(ER.FineNeedleAspiration, 0) = 0 THEN EE.FineNeedleAspiration ELSE ER.FineNeedleAspiration END),
				@FineNeedleAspirationType	= (CASE WHEN IsNull(ER.FineNeedleAspirationType, 0) = 0 THEN EE.FineNeedleAspirationType ELSE ER.FineNeedleAspirationType END),
				@FineNeedleBiopsy			= (CASE WHEN IsNull(ER.FineNeedleBiopsy, 0) = 0 THEN EE.FineNeedleBiopsy ELSE ER.FineNeedleBiopsy END),
				@Polypectomy				= (CASE WHEN IsNull(ER.[Polypectomy], 0) = 0 THEN EE.[Polypectomy] ELSE ER.[Polypectomy] END),
				@Diverticulotomy			= (CASE WHEN ISNULL(ER.Diverticulotomy,0) = 0 THEN EE.Diverticulotomy ELSE ER.Diverticulotomy END),
				@Homeostasis				= (CASE WHEN ISNULL(ER.[Homeostasis], 0) = 0 THEN EE.[Homeostasis] ELSE ER.[Homeostasis] END),
				@HomeostasisType			= (CASE WHEN ISNULL(ER.[HomeostasisType], 0) = 0 THEN EE.[HomeostasisType] ELSE ER.[HomeostasisType] END)
			FROM eeRecord AS EE
	  INNER JOIN #tmp_ERCPTherapeutics AS ER ON EE.SiteId = ER.SiteId;
		END	--## Selecting from Combine
				
	
	IF @None = 1
		SET @summary = @summary + 'No specimens taken'
	ELSE
	BEGIN
		----------------------
        -- Sphincterotomy
        ----------------------
		IF @Papillotomy = 1
		BEGIN
			SET @msg =' Sphincterotomy'
			SET @Details = ''
			IF @ReasonForPapillotomy > 0 
			BEGIN
				SET @Details = @Details + ' ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'ERCP papillotomy reason' AND [ListItemNo] = @ReasonForPapillotomy)

				--Place the word 'for' in front of the reason for the papillotomy if required.
				IF LEFT(UPPER(LTRIM(@Details)),4) <> 'FOR ' SET @Details = ' for ' + @Details
				SET @msg = @msg + ' (' + @Details + ')'
				SET @Details = ''
			END
			IF @PapillotomyLength > 0 SET @Details = @Details + ' ' + CAST(@PapillotomyLength as varchar(50)) + 'mm'
			IF @Sphincterotome > 0 SET @Details = @Details + ' using ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Therapeutic ERCP sphincterotomes' AND [ListItemNo] = @Sphincterotome)
			IF @PapillotomyBleeding > 0 
			BEGIN
				If LEN(RTRIM(LTRIM(@Details))) > 0 SET @Details = @Details + ','
				SET @Details = @Details + CASE @PapillotomyBleeding
											WHEN 1 THEN ' with no bleeding'   
											WHEN 2 THEN ' with minor bleeding'  
											WHEN 3 THEN ' with major bleeding'
											ELSE '' 
										END   
			END
			IF @PapillotomyAcceptBalloonSize > 0 
			BEGIN
				If LEN(RTRIM(LTRIM(@Details))) > 0 SET @Details = @Details + ','
				SET @Details = @Details + ' incision accepted ' + cast(@PapillotomyAcceptBalloonSize as varchar(50)) + 'ml balloon'
			END
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END
		
		----------------------
        -- Pancreatic orifice sphincterotomy
        ----------------------
		IF @PanOrificeSphincterotomy = 1
		BEGIN
			SET @msg =' Pancreatic orifice sphincterotomy'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		----------------------
        -- Stone removal
        ----------------------
		IF @StoneRemoval = 1
		BEGIN
			SET @msg =' Stone removal'
			SET @Details = ''

			IF @ExtractionOutcome > 0 
			BEGIN
				SET @Details = @Details + CASE @ExtractionOutcome
											WHEN 1 THEN ' complete extraction'   
											WHEN 2 THEN ' fragmented'  
											WHEN 3 THEN ' partial extraction'
											WHEN 4 THEN ' unable to extract'
											ELSE '' 
										END   
				DECLARE @cnt bit = 0
				IF @ExtractionOutcome BETWEEN 3 AND 4
				BEGIN
					DECLARE @tmpDiv TABLE(Val VARCHAR(MAX))
					DECLARE @XMLlist XML

					IF @InadequateSphincterotomy > 0
					BEGIN
						INSERT INTO @tmpDiv (Val) VALUES('inadequate sphincterotomy')
					END

					IF @StoneSize > 0
					BEGIN
						INSERT INTO @tmpDiv (Val) VALUES('stone size')
					END

					IF @QuantityOfStones > 0
					BEGIN
						INSERT INTO @tmpDiv (Val) VALUES('quantity of stones')
					END

					IF @ImpactedStones > 0
					BEGIN
						INSERT INTO @tmpDiv (Val) VALUES('impacted stone(s)')
					END

					IF @OtherReason > 0
					BEGIN
						IF LTRIM(RTRIM(ISNULL(@OtherReasonText,''))) <> ''
						BEGIN
							INSERT INTO @tmpDiv (Val) VALUES(@OtherReasonText)
						END
					END

					IF (SELECT COUNT(Val) FROM @tmpDiv) > 0 
					BEGIN
						SET @XMLlist = (SELECT Val FROM @tmpDiv FOR XML  RAW, ELEMENTS, TYPE)
						SET @Details = @Details + ' due to ' + dbo.fnBuildString(@XMLlist)
					END
				END
			END

			IF @RemovalUsing > 0 SET @Details = @Details + ' using ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'ERCP stone removal method' AND [ListItemNo] = @RemovalUsing)


			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		----------------------
        -- Stricture dilatation
        ----------------------
		IF @StrictureDilatation= 1
			BEGIN
			SET @msg =' Stricture dilatation'
			SET @Details = ''

			IF @DilatedTo > 0 
			BEGIN
				SET @Details = @Details + ' dilated to ' + cast(@DilatedTo as varchar(50)) + ' ' + 
									ISNULL((SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Oesophageal dilatation units' AND [ListItemNo] = @DilatationUnits),'')
			END

			--Dilator type
			IF @DilatorType > 0 
			BEGIN
				DECLARE @tmpDilatorType VARCHAR(100) = (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Oesophageal dilator' AND [ListItemNo] = @DilatorType)
				IF UPPER(LEFT(LTRIM(@tmpDilatorType),5)) = 'WITH ' OR UPPER(LEFT(LTRIM(@tmpDilatorType),3)) = 'BY ' 
					SET @Details = @Details + ' ' + @tmpDilatorType
				ELSE
					SET @Details = @Details + ' with ' + @tmpDilatorType
			END	
			
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		----------------------
        -- Endoscopic cyst puncture
        ----------------------
		IF @EndoscopicCystPuncture = 1
		BEGIN
			SET @msg =' Endoscopic cyst puncture'
			SET @Details = ''
			IF @CystPunctureDevice > 0 SET @Details = @Details + ' using ' + 
															(SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'ERCP cyst punct device' AND [ListItemNo] = @CystPunctureDevice)

			SET @Details = @Details + CASE @CystPunctureVia
							WHEN 1 THEN ' via papilla'   
							WHEN 2 THEN ' via medial wall of duodenum (cyst-duodenostomy)'  
							WHEN 3 THEN ' via stomach (cyst-gastrostomy)'
							ELSE '' 
						END   

			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		-------------------------------
        -- Nasobiliary/pancreatic drain
        -------------------------------
		IF @NasopancreaticDrain = 1
		BEGIN
			IF EXISTS ( SELECT r.Region FROM ERS_AbnormalitiesMatrixERCP m 
							LEFT JOIN ERS_Regions r ON m.Region = r.Region 
									AND r.Region IN ('Uncinate Process', 'Head', 'Neck', 'Body', 'Tail', 'Accessory Pancreatic Duct', 'Main Pancreatic Duct')
							LEFT JOIN ERS_Sites s ON r.RegionId  = s.RegionID  
							WHERE s.siteId = @SiteId)
				SET @msg =' Nasopancreatic drain'
			ELSE
				SET @msg =' Nasobiliary drain'


			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		-------------------------------
        -- Combined procedure
        -------------------------------
		IF @RendezvousProcedure = 1
		BEGIN
			SET @msg =' Combined procedure (rendezvous)'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		-------------------------------
        -- Diverticulotomy
        -------------------------------
		IF @Diverticulotomy = 1
		BEGIN
			SET @msg =' Diverticulotomy'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		-------------------------------
        -- Homeostasis
        -------------------------------
		IF @Homeostasis = 1
			BEGIN
			SET @msg =' Haemostasis'
			SET @Details = ''
			IF @HomeostasisType > 0 SET @Details = @Details + ' ' +   (SELECT [ListItemText] FROM dbo.ERS_Lists WHERE ListDescription = 'Homeostasis' AND [ListItemNo] = @HomeostasisType)
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		-------------------------------
        -- Snare excision
        -------------------------------
		IF @SnareExcision = 1
		BEGIN
			SET @msg =' Snare excision'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		----------------------
        -- Balloon sphincteroplasty
        ----------------------
		IF @BalloonDilation= 1
			BEGIN
			SET @msg =' Balloon sphincteroplasty'
			SET @Details = ''

			IF @BalloonDilatedTo > 0 
			BEGIN
				SET @Details = @Details + ' dilated to ' + cast(@BalloonDilatedTo as varchar(50)) + ' ' + 
									(SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Oesophageal dilatation units' AND [ListItemNo] = @BalloonDilatationUnits)
			END

			--Balloon Dilator type
			IF @BalloonDilatorType > 0 
			BEGIN
				DECLARE @tmpBalloonDilatorType VARCHAR(100) = (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'ERCP balloon dilator' AND [ListItemNo] = @BalloonDilatorType)
				IF UPPER(LEFT(LTRIM(@tmpBalloonDilatorType),5)) = 'WITH ' OR UPPER(LEFT(LTRIM(@tmpBalloonDilatorType),3)) = 'BY ' 
					SET @Details = @Details + ' ' + @tmpBalloonDilatorType
				ELSE
					SET @Details = @Details + ' with ' + @tmpBalloonDilatorType
			END	
			
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END


		----------------------
        -- Balloon trawl
        ----------------------
		IF @BalloonTrawl = 1
			BEGIN
			SET @msg =' Balloon trawl'
			SET @Details = ''

			IF @BalloonTrawlDilatorType > 0 
			BEGIN
				DECLARE @DilType VARCHAR(100) = (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'ERCP Balloon dilator' AND [ListItemNo] = @BalloonTrawlDilatorType)
				IF LTRIM(RTRIM(@DilType)) <> ''
				BEGIN
					
					IF UPPER(LEFT(@DilType,1)) in ('A','E','I','O','U') 
						SET @Details = @Details + ' using an' 
					ELSE
						SET @Details = @Details + ' using a'

					SET @Details = @Details + ' ' + @DilType
				END
			END

			IF @BalloonTrawlDilatorUnits >= 0 
			BEGIN
				IF @BalloonTrawlDilatorSize > 0 
				BEGIN
					SET @Details = @Details + ' dilated to ' + cast(@BalloonTrawlDilatorSize as varchar(50)) + ' ' + 
									(SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Oesophageal dilatation units' AND [ListItemNo] = @BalloonTrawlDilatorUnits)
				END
			END
			
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		-------------------------------
        -- Cannulation
        -------------------------------
		IF @Cannulation = 1
		BEGIN
			SET @msg =' Cannulation'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		-------------------------------
        -- Manometry
        -------------------------------
		IF @Manometry = 1
		BEGIN
			SET @msg =' Manometry'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		-------------------------------
        -- Haemostasis
        -------------------------------
		IF @Haemostasis = 1
		BEGIN
			SET @msg =' Haemostasis'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		-------------------------------
        -- Diagnostic cholangiogram
        -------------------------------
		IF @DiagCholangiogram = 1
		BEGIN
			SET @msg =' Diagnostic cholangiogram'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		-------------------------------
        -- Diagnostic pancreatogram
        -------------------------------
		IF @DiagPancreatogram = 1
		BEGIN
			SET @msg =' Diagnostic pancreatogram'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

	-- DUODENUM -----
		IF @YAGLaser = 1
			BEGIN
				SET @msg =' YAG Laser'
				SET @Details = ''
				IF @YAGLaserWatts > 0 SET @Details = @Details + ' ' + CAST(@YAGLaserWatts as varchar(50)) + 'W'
				IF @YAGLaserSecs > 0 SET @Details = @Details + ' for ' + cast(CAST(@YAGLaserSecs AS FLOAT) as varchar(50)) + CASE WHEN @YAGLaserSecs <= 1 THEN ' second' else ' seconds' END
				IF @YAGLaserPulses > 0 SET @Details = @Details + ' in ' + cast(@YAGLaserPulses as varchar(50)) + CASE WHEN @YAGLaserPulses <= 1 THEN ' pulse' else ' pulses' END
				IF @YAGLaserKJ > 0 SET @Details = @Details + ' ('+ cast(CAST(@YAGLaserKJ AS FLOAT) as varchar(50)) + 'kJ)'
				If @Details<>'' SET @msg = @msg + ': ' + @Details
				--Add full stop 
				SET @msg = RTrim(LTRIM(@msg))
				IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
				--------------
				SET @summary = @summary + @msg + '<br/>'
			END
		
		IF @ArgonBeamDiathermy= 1
			BEGIN
			SET @msg ='  Argon beam diathermy'
			SET @Details = ''
			IF @ArgonBeamDiathermyWatts > 0 SET @Details = @Details + ' ' + cast(@ArgonBeamDiathermyWatts as varchar(50)) + 'W'
			IF @ArgonBeamDiathermySecs > 0 SET @Details = @Details + ' for ' + cast(CAST(@ArgonBeamDiathermySecs AS FLOAT) as varchar(50)) + CASE WHEN @ArgonBeamDiathermySecs <= 1 THEN ' second' else ' seconds' END
			IF @ArgonBeamDiathermyPulses > 0 SET @Details = @Details + ' in ' + cast(@ArgonBeamDiathermyPulses as varchar(50)) + CASE WHEN @ArgonBeamDiathermyPulses <= 1 THEN ' pulse' else ' pulses' END
			IF @ArgonBeamDiathermyKJ > 0 SET @Details = @Details + ' ('+ cast(CAST(@ArgonBeamDiathermyKJ AS FLOAT) as varchar(50)) + 'kJ)'
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
			END

			
		IF @Injection= 1
			BEGIN
			SET @msg =' Injection'
			SET @Details = ''
			IF @InjectionVolume > 0 SET @Details = @Details + '  ' + cast(@InjectionVolume as varchar(50)) + 'ml'
			IF @InjectionVolume > 0  AND @InjectionType > 0 SET @Details = @Details + ' of'
			IF @InjectionType > 0 SET @Details = @Details + ' ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Agent Upper GI' AND [ListItemNo] = @InjectionType)
			IF @InjectionVolume> 0  AND @InjectionNumber > 0 SET @Details = @Details + ' via'
			IF @InjectionNumber >0 SET @Details = @Details + ' ' + CASE WHEN @InjectionNumber > 1 THEN cast(@InjectionNumber as varchar(50)) + ' injections' ELSE cast(@InjectionNumber as varchar(50)) + ' injection' END
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END
	
		IF @Diathermy = 1
			BEGIN
			SET @msg = ' Diathermy'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		IF @BicapElectro = 1
			BEGIN
			SET @msg = ' Bicap electrocautery'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		IF @HeatProbe = 1
			BEGIN
			SET @msg = ' Heater probe coagulation'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END
		
		IF @HotBiopsy = 1
			BEGIN
			SET @msg = ' Hot biopsy'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		IF @BandLigation = 1
			BEGIN
			SET @msg = ' Band ligation'
			IF @BandLigationPerformed > 0 SET @msg = @msg + ' performed ' + CAST(@BandLigationPerformed AS VARCHAR(100)) + CASE WHEN @BandLigationPerformed = 1 THEN ' procedure' ELSE ' procedures' END
			IF @BandLigationPerformed > 0 AND @BandLigationSuccess > 0 SET @msg = @msg + ' and ' + CAST(@BandLigationSuccess AS VARCHAR(100)) + CASE WHEN @BandLigationPerformed = 1 THEN ' was successful.' ELSE ' were successful.' END 
				ELSE IF @BandLigationPerformed = 0 AND @BandLigationSuccess > 0 SET @msg = @msg + ' ' + CAST(@BandLigationSuccess AS VARCHAR(100)) + CASE WHEN @BandLigationPerformed = 1 THEN ' procedure was successful.' ELSE ' procedures were successful.' END 
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		IF @BotoxInjection = 1
			BEGIN
			SET @msg = ' Botox injection'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		IF @EndoloopPlacement = 1
			BEGIN
			SET @msg = ' Endoloop placement'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		IF @ForeignBody = 1
			BEGIN
			SET @msg = ' Foreign body removal'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		----------------------
        -- Stent insertion
        ----------------------
		IF @StentInsertion= 1
			BEGIN

			IF @CorrectStentPlacement IS NOT NULL
			BEGIN
				IF @CorrectStentPlacement = 1
				BEGIN
					SET @msg = ' Correct placement across stricture '
				END
				ELSE IF @CorrectStentPlacement = 0
				BEGIN
					SET @msg = ' Incorrect placement across stricture '

					IF @CorrectStentPlacementNoReason >= 0
					BEGIN
						SET @msg = @msg + '(' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Correct Placement Across Stricture' AND [ListItemNo] = @CorrectStentPlacementNoReason) + ')'
					END
				END

				--Add full stop 
				SET @msg = RTrim(LTRIM(@msg))
				IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
				--------------
				SET @summary = @summary + @msg + '<br/>'
			END

			SET @msg =' Stent insertion'
			SET @Details = ''

			--Qty of stents used
			IF @StentInsertionQty > 0 SET @Details = @Details + '  ' + cast(@StentInsertionQty as varchar(50))

			IF @RadioactiveWirePlaced > 0  SET @Details = @Details + ', radiotherapeutic wire placed' 
			IF ISNULL(@StentInsertionBatchNo,'') <> ''  SET @Details = @Details + ', batch ' + LTRIM(RTRIM(@StentInsertionBatchNo))

			SET @Details = @Details + dbo.ercp_stentinsertions_summary(@TherapeuticId)
			
			If @Details<>'' SET @msg = @msg + ': ' + @Details 
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		----------------------
        -- Stent removal
        ----------------------
		IF @StentRemoval= 1
			BEGIN
			SET @msg =' Stent removal'
			SET @Details = ''
			IF @StentRemovalTechnique > 0  SET @Details = @Details + 'using ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Therapeutic Stent Removal Technique' AND [ListItemNo] = @StentRemovalTechnique)
			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		IF @EMR= 1
			BEGIN
			IF @EMRType = 2
				SET @msg =' Endoscopic submucosal dissection'
			ELSE
				SET @msg =' Endoscopic mucosal resection'
			SET @Details = ''
			IF @EMRFluid > 0  SET @Details = @Details + 'using ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Therapeutic EMR Fluid' AND [ListItemNo] = @EMRFluid)
			IF @EMRFluidVolume >0 
				BEGIN
				IF @EMRFluid >0 SET  @Details = @Details + ', '
				SET  @Details = @Details + 'total volume ' + cast(@emrfluidvolume AS varchar(50)) + 'ml'
				END
			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		IF @GastrostomyInsertion =1
		BEGIN
			DECLARE @G bit, @J bit, @N bit
			--SELECT @j = i.[JejunostomyInsertion], @G =i.[GastrostomyInsertion],@N = i.[NasoDuodenalTube] FROM [ERS_UpperGIIndications] i LEFT JOIN [ERS_Sites] s ON i.ProcedureId = s.ProcedureId WHERE s.SiteId = @SiteID
			--IF @N = 1 SET @msg =' Nasojejunal tube (NJT)' ELSE IF @J= 1 SET @msg =' Jejunostomy insertion (PEJ)' ELSE SET @msg =' Gastrostomy insertion (PEG)'
			SET @msg =' Nasojejunal tube (NJT)' -- For ERCP, it is Nasojejunal
			SET @Details = ''

			IF @GastrostomyInsertionType > 0
			BEGIN
				IF @GastrostomyInsertionSize>0
				BEGIN
					SET @Details = @Details + cast(@GastrostomyInsertionSize as varchar(50))
					--IF @J=1 
					SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG units' AND [ListItemNo] = @GastrostomyInsertionUnits)
					--ELSE IF @N =1 SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG units' AND [ListItemNo] = @GastrostomyInsertionUnits)
					--ELSE SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG units' AND [ListItemNo] = @GastrostomyInsertionUnits)
				END
			END
			IF @GastrostomyInsertionType>0
			BEGIN
				IF @J=1 SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG type' AND [ListItemNo] = @GastrostomyInsertiontype)
				ELSE IF @N =1 SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG type' AND [ListItemNo] = @GastrostomyInsertiontype)
				ELSE SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG type' AND [ListItemNo] = @GastrostomyInsertiontype)
			END
			IF @GastrostomyInsertionBatchNo <> null AND @GastrostomyInsertionBatchNo <> ''  SET @Details = @Details + ' batch ' + @GastrostomyInsertionBatchNo
				
			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		IF @GastrostomyRemoval = 1
			BEGIN
			SET @msg = ' Nasojejunal tube (NJT) removal'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		IF @Marking= 1
		BEGIN
			SET @msg =' Abnormality marked'
			SET @Details = ''
			IF @MarkingType > 0 SET @Details = @Details + ' by ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Abno marking' AND [ListItemNo] = @MarkingType)

			IF @Details<>'' SET @msg = @msg + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @Clip= 1
		BEGIN 
			SET @msg = CASE WHEN @ClipNum > 1 THEN  CAST(@ClipNum as varchar(5)) + ' clips'
							WHEN @ClipNum = 1 THEN  CAST(@ClipNum as varchar(5)) + ' clip'
							ELSE 'Clip'
						END
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		-------------------------------
        -- Pyloric/duodenal dilatation
        -------------------------------
		IF @PyloricDilatation= 1
		BEGIN
			SET @msg =' Pyloric dilatation'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		-------------------------------
        -- Balloon Dilatation
        -------------------------------
		IF @BalloonDilatation= 1
		BEGIN
			SET @msg =' Balloon dilatation'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		-------------------------------
        -- Bougie Dilatation
        -------------------------------
		IF @BougieDilatation= 1
		BEGIN
			SET @msg =' Bougie dilatation'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		-------------------------------
        -- Bougie Dilation
        -------------------------------
		IF @BougieDilation= 1
		BEGIN
			SET @msg =' Bougie dilation'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		-------------------------------
        -- Brush Cytology
        -------------------------------
		IF @BrushCytology= 1
		BEGIN
			SET @msg =' Brush cytology'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		-------------------------------
        -- Cholangioscopy
        -------------------------------
		IF @Cholangioscopy= 1
		BEGIN
			SET @msg =' Cholangioscopy'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
		-------------------------------
        -- Stent Change
        -------------------------------
		IF @StentChange= 1
		BEGIN
			SET @msg =' Stent change'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
		-------------------------------
        -- Stent Placement
        -------------------------------
		IF @StentPlacement= 1
		BEGIN
			SET @msg =' Stent placement'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
		-------------------------------
        -- Radio Frequency Ablation
        -------------------------------
		IF @RadioFrequencyAblation= 1
		BEGIN
			SET @msg =' Radio frequency ablation'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		-------------------------------
        -- FNA
        -------------------------------
		IF @FineNeedleAspiration= 1
		BEGIN
			SET @msg =' FNA'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		-------------------------------
        -- FNB
        -------------------------------
		IF @FineNeedleBiopsy= 1
		BEGIN
			SET @msg =' FNB'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
		-------------------------------
        -- Polypectomy
        -------------------------------
		IF @Polypectomy= 1
		BEGIN
			SET @msg =' Polypectomy'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
		IF LTRIM(RTRIM(@other)) <> ''
			BEGIN
			SET @msg =' ' + LTRIM(RTRIM(@other))
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary =  @summary + @msg  +'<br/>'
		END

	END;

	UPDATE dbo.ERS_ERCPTherapeutics 
	SET Summary=@summary 
	WHERE SiteID = @SiteId; --Id = @TherapeuticId

	DROP TABLE #tmp_ERCPTherapeutics;
GO


ALTER FUNCTION [dbo].[tvfNED_ProcedureTherapeutic]
(	
	  @ProcedureType AS INT
	, @ProcedureId AS INT
	, @CarriedOutRole AS INT --## 1: Endo1; 2: Endo2
)
RETURNS TABLE 
AS
RETURN 
(

WITH CTE AS ( --## Just wrapping the selection2 in the CTE to use later for a COUNT() operation
	
	SELECT      DISTINCT
		  UP.ProcedureId
		, UP.ProcedureType
		, UP.SiteId
		, CASE WHEN UP.SiteNo = -77 THEN 'Colon' ELSE UP.[Site] END AS Saite
		, CASE WHEN UP.SiteNo = -77 THEN 'Colon' ELSE UP.[Site] END As [Site]
		--, UP.TherapyTypeId
		--, TT.[Description]
		, TT.NedName
		, UP.EndoRole 
		,UP.EndoRoleId
		--, UT_CarriedOutRole
		--, ERCP_CarriedOutRole
		, (CASE WHEN TT.NedName LIKE 'Polyp%' THEN (SELECT TOP 1 Tattooed FROM ERS_CommonAbnoPolypDetails WHERE SiteId = UP.SiteId) ELSE NULL END) AS Tattooed
		, (CASE WHEN TT.NedName LIKE 'Stent placement%' then COALESCE(UGI_StentQty, ER_StentQty)				else 1 END) AS StentPerformed --## 'Stent Placement' for O/C/F; And 'Stent placement - pancreas/CBD' for ERCP
		--, UGI_StentQty, ER_StentQty --#############
		, ISNULL(dbo.fnNED_GetTherapTypeSuccess(ProcedureType, SiteId, UP.EndoRoleId, @CarriedOutRole, NedName),0) AS Successful
		, (CASE WHEN UP.TherapyTypeId=2 THEN	--## Any Therap in 'Other' Category
			dbo.fnNED_GetOtherTypeTheraps(ProcedureType, UP.SiteId, @CarriedOutRole) 
			END --## ELSE Return NULL... Should only be available when 'Other' Therap is present
		  ) AS Comment
	FROM            
		(SELECT			
				P.ProcedureId,  
				P.ProcedureType,
				S.SiteId, 
				S.SiteNo,
				CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND s.SiteId = SiteId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END As [Site],			
				--R.NED_Term AS [Site], --## Link to [dbo.ERS_Regions] via Sites.Id
				NULL [role]
				, UT.CarriedOutRole											AS UGI_CarriedOutRole
				, ER.CarriedOutRole											AS ERCP_CarriedOutRole				
				, CASE WHEN PD.Size <20 THEN NULL ELSE pt.NEDTerm	END	AS Tattooed
				, UT.StentInsertionQty										AS UGI_StentQty
				, ER.StentInsertionQty										AS ER_StentQty,
				CASE WHEN (UT.[None] = 1 OR T.[None] = 1) THEN 1 END AS [None], 
				CASE WHEN @ProcedureType IN (1,3,4,8,9) AND UT.ArgonBeamDiathermy = 1 THEN 3 END								AS ArgonBeamDiathermy, --## C/F/O
				CASE WHEN (@ProcedureType IN (1,3,9,8,4) AND UT.BalloonDilation = 1) OR 
						  (@ProcedureType IN (2,7) AND ER.BalloonDilation = 1) THEN 4 END	AS BalloonDilation,		--## ALL: Balloon sphicteroplasty	
				--CASE WHEN @ProcedureType = 2 AND (ER.BalloonDilation = 1) THEN  91 END	AS Sphincteroplasty,		--## ALL: Balloon sphicteroplasty	
				CASE WHEN @ProcedureType = 2 AND ER.BalloonTrawl = 1 THEN 5 END												AS BalloonTrawl,
				CASE WHEN (UT.BandLigation = 1 OR UT.VaricealBanding = 1) OR (ER.BandLigation = 1) THEN  6 END					AS BandLigation, 
				CASE WHEN @ProcedureType IN (3,9,4) AND UT.BandingPiles = 1 THEN 7 END										AS BandingPiles,		--## O / C / F
				CASE WHEN @ProcedureType = 1 AND UT.BotoxInjection	= 1 THEN  8 END											AS BotoxInjection,
				CASE WHEN @ProcedureType IN (1,9) and ((UT.BougieDilation = 1 OR UT.OesophagealDilatation=1 AND UT.DilatorType=2)
														OR (ER.BalloonTrawlDilatorType=2 or ER.DilatorType=2)) --## Need to confirm this Logic!
														THEN 9 END															AS BougieDilation, --## O / E	
				CASE WHEN @ProcedureType=2 AND ER.BrushCytology = 1 THEN 10 END												AS Brush,
				CASE WHEN @ProcedureType=2 AND ER.Cannulation = 1 THEN 11 END												AS Cannulation,
				CASE WHEN @ProcedureType IN (1,3,4,8,9) AND UT.Clip = 1 THEN 12 END											AS Clip,
				CASE WHEN @ProcedureType=2 AND ER.RendezvousProcedure = 1 THEN 13 END										AS RendezvousProcedure,
				CASE WHEN @ProcedureType=2 AND ER.DiagCholangiogram	= 1 THEN 14 END											AS DiagCholangiogram,
				CASE WHEN @ProcedureType=2 AND ER.DiagPancreatogram		= 1 THEN 15 END										AS DiagPancreatogram,
				CASE WHEN @ProcedureType IN (1,8,9) AND UT.EMR = 1 THEN 
														(CASE WHEN ISNULL(UT.EMRType, 0)<> 0 THEN 
															(CASE UT.EMRType WHEN 1 THEN 16 ELSE 19 END) 
														END) END															AS EMR,
				CASE WHEN @ProcedureType IN (3,9,4) AND UT.EndoloopPlacement = 1 THEN 17 END								AS EndoloopPlacement,
				CASE WHEN @ProcedureType=2 AND ER.EndoscopicCystPuncture = 1 THEN 18 END									AS Cyst,
				CASE WHEN @ProcedureType IN (1,3,9,4) AND UT.ForeignBody = 1 THEN 20 END									AS ForeignBody,
				CASE WHEN @ProcedureType=2 AND ER.Haemostasis = 1 THEN 21 END												AS Haemostasis,
				CASE WHEN @ProcedureType IN (1,9) AND UT.HeatProbe = 1 THEN 22 END											AS HeatProbe, 
				CASE WHEN @ProcedureType IN (1,9) AND (UT.HotBiopsy = 1 OR T.HotBiopsy = 1) THEN 23 END						AS HotBiopsy,
				CASE WHEN @ProcedureType NOT IN (6,7) AND UT.Injection = 1 OR ER.Injection = 1	THEN 24 END					AS Injection,
				CASE WHEN @ProcedureType=2 AND ER.Manometry = 1 THEN 25 END													AS Manometry,
				CASE WHEN @ProcedureType NOT IN (2,6,7) AND UT.Marking = 1 THEN 26 END										AS Marking,
				CASE WHEN @ProcedureType=2 AND ER.NasopancreaticDrain = 1 THEN 27 END										AS NasopancreaticDrain,
				CASE WHEN @ProcedureType IN (1,9) AND UT.GastrostomyInsertion = 1 AND UT.GastrostomyRemoval = 1 THEN 28 END		AS PEGChange,
				CASE WHEN @ProcedureType IN (1,9) AND UT.GastrostomyInsertion = 1 AND UT.GastrostomyRemoval = 0 THEN 29 END		AS PEGInsertion,
				CASE WHEN @ProcedureType IN (1,9) AND UT.GastrostomyInsertion = 0 AND UT.GastrostomyRemoval = 1 THEN 30 END		AS PEGRemoval,
				CASE WHEN (UT.Polypectomy = 1 OR ER.Polypectomy = 1) AND (ISNULL(PD.SiteId,0)) > 0 THEN 
					CASE PD.NedTerm 
													WHEN 'Polyp snare - cold' THEN 35 --## 'Polyp - snare cold'
													WHEN 'Polyp snare - hot' THEN 36 --## 'Polyp - snare hot'
													WHEN 'Polyp - hot biopsy' THEN 34 --## 'Polyp - hot biopsy'
													WHEN 'Polyp - cold biopsy polypectomy' THEN 31 --## 'Polyp - cold biopsy POLYPECTOMY'
													WHEN 'Polyp - EMR' THEN 32 --## 'Polyp - EMR'
													WHEN 'Polyp - ESD' THEN 33 --## 'Polyp - ESD'
													WHEN 'Polyp - cold biopsy sampling' THEN 75 --## 'Polyp - cold biopsy sampling'
													WHEN 'Polyp - FTR' THEN 76 --## 'Polyp - FTR'
													WHEN 'Polyp - not removed' THEN 77 --## 'Polyp - FTR'
					END 
				END																											AS PolypRemovalType, 			
				CASE WHEN @ProcedureType=1 AND ((UT.Polypectomy = 1 OR ER.Polypectomy = 1) AND PD.SiteId is null) THEN 37 END					AS Polypectomy,			
				CASE WHEN @ProcedureType=1 AND UT.RFA = 1 THEN 38 END														AS RFA, 
				CASE WHEN @ProcedureType=2 AND (ER.PanOrificeSphincterotomy = 1 OR ER.Papillotomy = 1) THEN 39 END			AS Sphincterotomy,
				CASE WHEN (@ProcedureType IN (1,3,8,9,4) AND (UT.StentRemoval = 1 AND UT.StentInsertion = 1))  OR 
						  (@ProcedureType = 2 AND (ER.StentRemoval = 1 AND ER.StentInsertion = 1) AND LOWER(ERRegions.Area)<>'biliary' AND LOWER(ERRegions.Area)<>'pancreas') THEN 40 END  AS StentChange,
				CASE WHEN (@ProcedureType IN (1,3,4,8,9) AND UT.StentRemoval = 0 AND UT.StentInsertion = 1) OR 
						  (@ProcedureType = 2 AND (ER.StentRemoval = 0 AND ER.StentInsertion = 1) AND LOWER(ERRegions.Area)<>'biliary' AND LOWER(ERRegions.Area)<>'pancreas') /**/ THEN 41 END		AS StentPlacement,
				CASE WHEN (@ProcedureType IN (1,3,4,8,9) AND (UT.StentRemoval = 1 AND UT.StentInsertion = 0)) OR
						  (@ProcedureType = 2 AND (ER.StentRemoval = 1 AND ER.StentInsertion = 0)AND LOWER(ERRegions.Area)<>'biliary' AND LOWER(ERRegions.Area)<>'pancreas') /**/  THEN 44 END	AS StentRemoval,
				CASE WHEN @ProcedureType=2 AND (ER.StoneRemoval = 1 AND Abn.StonesSize>= 10) THEN 45 END												AS StoneExtractionGT10, --## Stone Size in mm
				CASE WHEN @ProcedureType=2 AND (ER.StoneRemoval = 1 AND Abn.StonesSize < 10) THEN 46 END												AS StoneExtractionLT10,
				CASE WHEN @ProcedureType=1 AND UT.VaricealSclerotherapy = 1 THEN 47 END										AS VaricealSclerotherapy,
				CASE WHEN @ProcedureType IN (1,3,4,8,9) AND UT.YAGLaser = 1 THEN 48 END										AS YAGLaser,
				--CASE WHEN UT.Diathermy = 1 THEN 50	END																		AS Diathermy,
				--CASE WHEN UT.EndoscopicResection = 1 THEN 98 END
				CASE WHEN UT.EMR = 1 AND ISNULL(UT.EMRType, 0) = 3 THEN 98 END												AS EndoscopicResection,
				CASE WHEN @ProcedureType=3 AND UT.PancolonicDyeSpray = 1 THEN 66 END										AS PancolonicDyeSpray,
				CASE WHEN @ProcedureType IN (3,4,9) AND UT.ColonicDecompression = 1 THEN 84 END								AS ColonicDecompression,
				CASE WHEN @ProcedureType IN (3,4,9) AND UT.FlatusTubeInsertion = 1 THEN 1069 END								AS FlatusTubeInsertion,
				CASE WHEN @ProcedureType = 2 AND ER.Cholangioscopy = 1 and er.CholangioscopyType = 1 THEN 82 END									AS LesionAssessment,
				CASE WHEN @ProcedureType = 2 AND ER.Cholangioscopy = 1 and er.CholangioscopyType = 2 THEN 83 END									AS StoneTherapy,
				CASE WHEN @ProcedureType = 2 AND (ER.StentRemoval = 1 AND ER.StentInsertion = 1) 
															AND LOWER(ERRegions.Area)='biliary'
														AND LOWER(R.Region) <>'common bile duct'  THEN 68 END					AS StentChangeBiliary,
				CASE WHEN @ProcedureType = 2 AND (ER.StentRemoval = 1 AND ER.StentInsertion = 1) 
															AND LOWER(ERRegions.Area)='pancreas' THEN 79 END				AS StentChangePancreatic,
				CASE WHEN @ProcedureType = 2 AND (ER.StentRemoval = 0 AND ER.StentInsertion = 1) 
															AND LOWER(R.Region)='common bile duct' THEN 42 END				AS StentPlacementCBD,
				CASE WHEN @ProcedureType = 2 AND (ER.StentRemoval = 0 AND ER.StentInsertion = 1 
															AND LOWER(ERRegions.Area)='biliary')
														AND LOWER(R.Region) <>'common bile duct'  THEN 69 END				AS StentPlacementBiliary,
				CASE WHEN @ProcedureType = 2 AND (ER.StentRemoval = 0 AND ER.StentInsertion = 1 
															AND LOWER(ERRegions.Area)='pancreas') THEN 95 END				AS StentPlacementPancreatic,
				CASE WHEN @ProcedureType = 2 AND (ER.StentInsertion = 0 AND ER.StentRemoval = 1) 
															AND LOWER(ERRegions.Area)='biliary' THEN 96 END					AS StentRemovalBiliary,
				CASE WHEN @ProcedureType = 2 AND (ER.StentInsertion = 0 AND ER.StentRemoval = 1) 
															AND LOWER(ERRegions.Area)='pancreas' THEN 97 END				AS StentRemovalPancreatic,
				CASE WHEN @ProcedureType=1 AND UT.NGNJTubeInsertion = 1 AND	LOWER(OGDRegions.Area) = 'stomach' THEN 52 END			AS NGTInsertion,
				CASE WHEN @ProcedureType=1 AND UT.NGNJTubeInsertion = 1 AND	LOWER(OGDRegions.Area) = 'duodenum' THEN 53 END			AS NJTInsertion,
				CASE WHEN (@ProcedureType=7 AND ER.FineNeedleAspiration = 1 AND 
																		er.FineNeedleAspirationType = 1) OR
						  (@ProcedureType=6 AND UT.FineNeedleAspiration = 1 AND 
																		UT.FineNeedleAspirationType = 1) THEN 73 END			AS FNACysticLesion,
				CASE WHEN (@ProcedureType=7 AND ER.FineNeedleAspiration = 1 AND 
																		er.FineNeedleAspirationType = 2) OR
						  (@ProcedureType=6 AND UT.FineNeedleAspiration = 1 AND 
																		UT.FineNeedleAspirationType = 2) THEN 78 END			AS FNASolidLesion,
				CASE WHEN (@ProcedureType=7 AND ER.FineNeedleBiopsy = 1) OR
						  (@ProcedureType=6 AND UT.FineNeedleBiopsy = 1)	THEN 74 END											AS FNBSolidLesion,
				CASE WHEN (@ProcedureType IN (1,3,9,8,4,5,6) AND UT.Homeostasis = 1 AND UT.HomeostasisType = 1)  OR 
						  (@ProcedureType IN (2,7) AND ER.Homeostasis = 1 AND ER.HomeostasisType = 1) THEN 98 END	AS EndoClot,
				CASE WHEN (@ProcedureType IN (1,3,9,8,4,5,6) AND UT.Homeostasis = 1 AND UT.HomeostasisType = 2)  OR 
						  (@ProcedureType IN (2,7) AND ER.Homeostasis = 1 AND ER.HomeostasisType = 2) THEN 99 END	AS Hemospray,
				CASE WHEN (@ProcedureType IN (1,3,9,8,4,5,6) AND UT.Homeostasis = 1 AND UT.HomeostasisType = 3)  OR 
						  (@ProcedureType IN (2,7) AND ER.Homeostasis = 1 AND ER.HomeostasisType = 3) THEN 100 END	AS Purastat,
				/* 
					There are many other fields in the OGD/ERCP Therap Tables, but NED isn't interested in each and every Theraps.
					The Valid/Acceptable names are given in the XSD/Documentation file. Few other Theraps are put in 
					the 'Other' Category- instructions found in the Excel file, by Steve!
				*/

				(CASE  
						WHEN P.ProcedureType = 1 THEN							--## OGD / Gastroscopy
							(CASE WHEN 
									(UT.BicapElectro = 1  OR UT.PyloricDilatation = 1 OR
									UT.pHProbeInsert = 1 OR (UT.Homeostasis = 1 AND UT.HomeostasisType NOT IN (1,2,3)) OR 
									UT.Diathermy = 1  OR LEN(UT.Other) > 1) THEN 2
								END)
						WHEN P.ProcedureType = 2 THEN							--## ERCP
							(CASE WHEN 
									(ER.SnareExcision = 1 OR 
									ER.YAGLaser = 1 OR ER.ArgonBeamDiathermy = 1 OR
									ER.BotoxInjection = 1 OR
									ER.EndoloopPlacement = 1 OR ER.HeatProbe = 1 OR
									ER.BicapElectro = 1 OR
									ER.ForeignBody = 1 OR ER.HotBiopsy = 1 OR
									ER.EMR = 1 OR ER.Marking = 1 OR
									ER.Clip = 1 OR ER.PyloricDilatation = 1 OR
									ER.StrictureDilatation = 1 OR ER.GastrostomyInsertion = 1 OR -- GastrostomyInsertion = Nasojejunal tube (NJT) 
									ER.GastrostomyRemoval = 1 OR 
									(ER.Homeostasis = 1 AND ER.HomeostasisType NOT IN (1,2,3)) OR LEN(ER.Other) > 1  --GastrostomyRemoval = Nasojejunal Removal (NJT) 
									) THEN 2
							  END)
						
						WHEN P.ProcedureType = 6 THEN							--## EUS HPB
							(CASE WHEN 
									(UT.GastrostomyRemoval = 1 OR 
									(UT.Homeostasis = 1 AND UT.HomeostasisType NOT IN (1,2,3)) OR LEN(UT.Other) > 1  --GastrostomyRemoval = Nasojejunal Removal (NJT) 
									) THEN 2
							  END)
						WHEN P.ProcedureType = 7 THEN							--## EUS HPB
							(CASE WHEN 
									(ER.GastrostomyRemoval = 1 OR 
									(ER.Homeostasis = 1 AND ER.HomeostasisType NOT IN (1,2,3)) OR LEN(ER.Other) > 1  --GastrostomyRemoval = Nasojejunal Removal (NJT) 
									) THEN 2
							  END)
						WHEN P.ProcedureType IN (3, 13, 4) THEN					-- ## COLON / FLEXI
							(CASE WHEN 
									(UT.BotoxInjection = 1 OR UT.HeatProbe = 1 OR
									UT.BicapElectro = 1 OR
									UT.HotBiopsy = 1 OR UT.EMR = 1 OR
									UT.Diathermy = 1 OR
									UT.Sigmoidopexy = 1 OR (UT.Homeostasis = 1 AND UT.HomeostasisType NOT IN (1,2,3)) OR
									LEN(UT.Other) > 1) THEN 2
							  END)
						 ELSE
							(CASE WHEN 
									(LEN(UT.Other) > 1) THEN 2
							  END)
				END) AS Other,
				CASE isnull(UT.EndoRole, ER.EndoRole) 
					when 1 then 'Independent (no trainer)'
					when 4 then 'Independent (no trainer)'
					when 2 then (case when @CarriedOutRole = 1 then 'I observed' else 'Was observed' END)
					when 3 then (case when @CarriedOutRole = 1 then 'I assisted physically' else 'Was assisted physically' END)
					when 5 then (case when @CarriedOutRole = 1 then 'I assisted physically' else 'Was assisted physically' END)
				END	AS EndoRole,
				isnull(UT.EndoRole, ER.EndoRole) AS EndoRoleId
			FROM            dbo.ERS_Procedures	AS	P	
				INNER JOIN				[dbo].ERS_Sites					AS  S ON P.ProcedureId = S.ProcedureId  
				LEFT JOIN				[dbo].ERS_Regions				AS  R ON S.RegionId = R.RegionId --## To Get SiteName
				LEFT JOIN ERS_AbnormalitiesMatrixERCP AS ERRegions ON ERRegions.Region = r.Region
				LEFT JOIN ERS_AbnormalitiesMatrixUpperGI AS OGDRegions ON OGDRegions.Region = r.Region
				LEFT OUTER JOIN			[dbo].ERS_ERCPTherapeutics		AS ER ON S.SiteId = ER.SiteId -- ER.CarriedOutRole  = @CarriedOutRole
				--LEFT OUTER JOIN			[dbo].ERS_ColonTherapeutics		AS CT ON S.SiteId = CT.SiteId
				LEFT OUTER JOIN				[dbo].ERS_UpperGITherapeutics	AS UT ON S.SiteId = UT.SiteId -- UT.CarriedOutRole  = @CarriedOutRole
				--LEFT OUTER JOIN			[dbo].[ERS_ColonAbnoLesions]	AS  L ON S.SiteId = L.SiteId 
				LEFT OUTER JOIN			[dbo].[ERS_UpperGISpecimens]	AS  T ON S.SiteId = T .SiteId
				LEFT OUTER JOIN			[dbo].[ERS_ERCPAbnoDuct]		AS Abn ON S.SiteId = Abn.SiteId
				LEFT OUTER JOIN			(SELECT d.PolypDetailId, d.TattooedId, d.SiteId, d.RemovalMethod, r.NEDTerm, d.Size FROM [dbo].[ERS_CommonAbnoPolypDetails] d LEFT JOIN ERS_PolypRemovalTypes r ON r.UniqueId = d.RemovalMethod WHERE d.SiteId IN (SELECT SiteId FROM ERS_Sites WHERE ProcedureId = @ProcedureId)) AS PD ON PD.SiteId = S.SiteId
				LEFT OUTER JOIN			ERS_TattooOptions pt ON pt.UniqueId = PD.TattooedId
				Where P.ProcedureId= @ProcedureId
				AND (((UT.EndoRole in (1, 2, 3, 5) AND @CarriedOutRole = 1)
				     OR
					 (UT.EndoRole in (2, 3, 4, 5) AND @CarriedOutRole = 2))
					OR
					((ER.EndoRole in (1, 2, 3, 5) AND @CarriedOutRole = 1)
				     OR
					 (ER.EndoRole in (2, 3, 4, 5) AND @CarriedOutRole = 2)))
		) AS PT 
				UNPIVOT (TherapyTypeId FOR Therapies IN 
												([None], Other
												, ArgonBeamDiathermy, BalloonDilation, /*Sphincteroplasty,*/ BandLigation, BotoxInjection, BougieDilation, Clip, EndoloopPlacement, EMR, BandingPiles	--, Colon Fields: (ESD,EMR)
												, ForeignBody, HeatProbe, HotBiopsy,  Marking, PEGChange, PEGInsertion, PEGRemoval, Polypectomy, RFA
												, StentRemoval, StentChange, StentPlacement, YAGLaser, Injection, PolypRemovalType
											--## Add ERCP Fields
												, BalloonTrawl,Brush, Cannulation, RendezvousProcedure, DiagCholangiogram, DiagPancreatogram
												, Cyst, Haemostasis, Manometry, Sphincterotomy, NasopancreaticDrain, StentPlacementCBD, 
												StoneExtractionGT10, StoneExtractionLT10, VaricealSclerotherapy, EndoscopicResection,PancolonicDyeSpray,
												ColonicDecompression,FlatusTubeInsertion, LesionAssessment,StoneTherapy,StentChangeBiliary,StentChangePancreatic,
												StentPlacementBiliary,StentPlacementPancreatic,StentRemovalBiliary,StentRemovalPancreatic,NGTInsertion,NJTInsertion,FNACysticLesion,
												FNASolidLesion,FNBSolidLesion,EndoClot,Hemospray,Purastat)
						)  AS UP 
		LEFT JOIN dbo.ERS_TherapeuticTypes TT ON UP.TherapyTypeId = TT.RecordId
			WHERE 1=1
	) --## End of CTE.. Now just select the desired fields from this CTE

	SELECT ProcedureId, ProcedureType, CTE.SiteId, Saite, [Site], NedName, EndoRole,
		(CASE WHEN NedName LIKE '%not removed' THEN PS.PolypSizeText ELSE NULL END)		As polypSize,
		(CASE WHEN NedName LIKE 'Polyp%' AND NEDName <> 'polyp - not removed' THEN PolypSizeInt ELSE NULL END) AS PolypSizeInt,
		(CASE WHEN NedName LIKE 'Polyp%' THEN PS.Morphology ELSE NULL END) AS Morphology,
		Tattooed,
		CASE WHEN NedName = 'Polyp - not removed' then PS.Detected ELSE NULL END Detected,
		(CASE 
			WHEN NedName LIKE 'Polyp%' THEN 
				CASE WHEN NedName = 'Polyp - not removed' then 0 ELSE PS.Detected END
			WHEN NedName like 'Clip%' THEN
				(Select T.ClipNum from ERS_UpperGITherapeutics T where T.SiteId = CTE.SiteId)
			--WHEN NedName LIKE '%injection%' THEN
			--	(SELECT T.InjectionNumber FROM ERS_UpperGITherapeutics T WHERE T.SiteId = CTE.SiteId)
			WHEN NedName LIKE '%argon beam%' THEN
				(SELECT T.ArgonBeamDiathermyPulses FROM ERS_UpperGITherapeutics T WHERE T.SiteId = CTE.SiteId)
			WHEN NedName LIKE '%FNA%' THEN
				CASE WHEN ProcedureType IN (2,7) THEN (SELECT FNAPerformed FROM ERS_ERCPTherapeutics T WHERE T.SiteId = CTE.SiteId)
				ELSE (SELECT FNAPerformed FROM ERS_UpperGITherapeutics T WHERE T.SiteId = CTE.SiteId) END
			WHEN NedName LIKE '%FNB%' THEN
				CASE WHEN ProcedureType IN (2,7) THEN (SELECT FNBPerformed FROM ERS_ERCPTherapeutics T WHERE T.SiteId = CTE.SiteId)
				ELSE (SELECT FNBPerformed FROM ERS_UpperGITherapeutics T WHERE T.SiteId = CTE.SiteId) END
			WHEN NedName = 'Band ligation' THEN	
				(SELECT T.BandLigationPerformed FROM ERS_UpperGITherapeutics T WHERE T.SiteId = CTE.SiteId)
			WHEN NedName = 'Marking / tattooing' THEN	
				(SELECT T.MarkedQuantity FROM ERS_UpperGITherapeutics T WHERE T.SiteId = CTE.SiteId)
			ELSE 
				(CASE 
					WHEN StentPerformed>CTE.Successful THEN 
						StentPerformed 
					ELSE CTE.Successful 
				END) 
			END)		As Performed, --### Successful and Performed should be same!
		(CASE 
			WHEN NedName LIKE 'Polyp%' THEN 
				CASE WHEN CTE.EndoRoleId = 5 AND @CarriedOutRole = 1 THEN PS.Successful 
				     WHEN CTE.EndoRoleId = 5 AND @CarriedOutRole <> 1 THEN 0 ELSE
				PS.Successful END
			--WHEN NedName like 'Clip%' THEN 
			--	(Select T.ClipNumSuccess from ERS_UpperGITherapeutics T where T.SiteId = CTE.SiteId)
			--WHEN NedName LIKE '%injection%' THEN
			--	(SELECT T.InjectionNumber FROM ERS_UpperGITherapeutics T WHERE T.SiteId = CTE.SiteId)
			WHEN NedName LIKE '%argon beam%' THEN
				(SELECT T.ArgonBeamDiathermyPulses FROM ERS_UpperGITherapeutics T WHERE T.SiteId = CTE.SiteId)
			--WHEN NedName LIKE '%FNA%' THEN
			--	CASE WHEN ProcedureType IN (2,7) THEN (SELECT FNASuccessful FROM ERS_ERCPTherapeutics T WHERE T.SiteId = CTE.SiteId)
			--	ELSE (SELECT FNASuccessful FROM ERS_UpperGITherapeutics T WHERE T.SiteId = CTE.SiteId) END
			--WHEN NedName LIKE '%FNB%' THEN
			--	CASE WHEN ProcedureType IN (2,7) THEN (SELECT FNBSuccessful FROM ERS_ERCPTherapeutics T WHERE T.SiteId = CTE.SiteId)
			--	ELSE (SELECT FNBSuccessful FROM ERS_UpperGITherapeutics T WHERE T.SiteId = CTE.SiteId) END
			WHEN NedName = 'Marking / tattooing' THEN	
				(SELECT T.MarkedQuantity FROM ERS_UpperGITherapeutics T WHERE T.SiteId = CTE.SiteId)
			--WHEN NedName = 'Band ligation' THEN	
			--	(SELECT T.BandLigationSuccessful FROM ERS_UpperGITherapeutics T WHERE T.SiteId = CTE.SiteId)
			ELSE CTE.Successful
		END) AS Successful, --## 'CTE.StentPerformed' watches on the 'Stent placement% (CBD/PAN)' Qty' for Overall level.. better accuracy!
		(CASE 
			WHEN NedName LIKE 'Polyp%' THEN 
				PS.Retrieved
			WHEN NedName LIKE '%FNA%' THEN
				CASE WHEN ProcedureType IN (2,7) THEN (SELECT FNARetreived FROM ERS_ERCPTherapeutics T WHERE T.SiteId = CTE.SiteId)
				ELSE (SELECT FNARetreived FROM ERS_UpperGITherapeutics T WHERE T.SiteId = CTE.SiteId) END
			WHEN NedName LIKE '%FNB%' THEN
				CASE WHEN ProcedureType IN (2,7) THEN (SELECT FNBRetreived FROM ERS_ERCPTherapeutics T WHERE T.SiteId = CTE.SiteId)
				ELSE (SELECT FNBRetreived FROM ERS_UpperGITherapeutics T WHERE T.SiteId = CTE.SiteId) END 
			ELSE 
				0
		END)			As Retrieved,
		Comment 
		FROM CTE
		INNER JOIN (SELECT 
						SiteId, SUM(Detected) AS Detected, sum(Retrieved) AS Retrieved, SUM(Successful) AS Successful
						, PolypSizeText = (CASE WHEN Size IS NULL OR Size=0 THEN NULL WHEN Size<10 THEN 'ItemLessThan10mm' WHEN Size BETWEEN 10 AND 19 THEN 'Item10to19mm' ELSE 'Item20OrLargermm' END)
						, PolypSizeInt = Size
						, Morphology
					FROM dbo.tvfNED_PolypsDetailsView(@ProcedureType, @ProcedureId)
					GROUP BY SiteId, Retrieved, Successful, size,Morphology	)AS PS ON PS.SiteId = CTE.SiteId
	UNION ALL -- ## A Default Blank ROW.. ONLY when no Therap Record exist..
		SELECT TOP 1
			@ProcedureId AS ProcedureId, @ProcedureType	AS ProcedureType, NULL AS SiteId, NULL AS Saite
			, 'None' AS [Site]
			, 'None' AS NedName
			, NULL AS EndoRole	
			, NULL AS polypSize
			, NULL as PolypSizeInt
			, NULL AS Morphology
			, NULL AS Tattooed
			, NULL AS Detected
			, 0 AS Performed
			, 0 AS Successful
			, 0 AS Retrieved
			, NULL  AS Comment
		WHERE (SELECT IsNull(count(*), 0) FROM CTE)<1


);

GO


ALTER FUNCTION [dbo].[fnNED_GetOtherTypeTheraps]
(
	@ProcType		AS INT,
	@SiteId			AS INT,
	@EndRole		AS INT
)
RETURNS varchar(250)
AS
-- =============================================
-- Description:	This will Concatenate the 'Other' Type of TherapProcs which are not recognised by NED Schema.
--				So- when only 'OTHER' is passed as parameter- it will concatenate some specific theraps,
--						like: Bicap, Diathermy, Snare Excision and OTher Field's data itself
-- =============================================
BEGIN	
	DECLARE @ResultVar VARCHAR(250);

--	IF Lower(@TherapName) = 'other'
		BEGIN
			IF @ProcType=1		--## OGD / Gastroscopy
				BEGIN
					SELECT @ResultVar=(
							COALESCE((CASE WHEN T.Diathermy = 1			THEN 'Diathermy, '			END), '') +
							COALESCE((CASE WHEN T.PyloricDilatation = 1	THEN 'Pyloric Dilatation, '	END), '') +
							COALESCE((CASE WHEN T.pHProbeInsert = 1		THEN 'pHProbe Insert, '		END), '') +
							COALESCE((CASE WHEN ISNULL(T.Homeostasis,0) = 1	THEN 'Homeostatis - ' + l.ListItemText + ', '		END), '') +
							COALESCE(T.Other, '')  )
						FROM [dbo].ERS_UpperGITherapeutics AS T
						INNER JOIN dbo.ERS_Sites AS S ON T.SiteId=S.SiteId
						LEFT JOIN dbo.ERS_Lists l ON l.ListDescription = 'Homeostasis' AND l.ListItemNo = t.HomeostasisType
						WHERE T.SiteId = @SiteId
						  AND T.CarriedOutRole = @EndRole
						  AND (IsNull(Diathermy, 0)<>0 OR 
							IsNUll(PyloricDilatation, 0)<>0 OR IsNull(pHProbeInsert, 0)<>0 OR 
							(ISNULL(T.Homeostasis, 0) = 1 AND T.HomeostasisType NOT IN  (1,2,3)) OR
							LEN(IsNull(Other, '')) >= 1)
				END
			ELSE IF @ProcType = 2 --## ERCP
				BEGIN	
					SELECT 
						@ResultVar =(
						  COALESCE(CASE WHEN SnareExcision = 1 THEN 'Snare Excision, ' END, '') +
						  COALESCE(CASE WHEN YAGLaser = 1 THEN 'YAG laser, ' END, '') +
						  COALESCE(CASE WHEN ArgonBeamDiathermy = 1 THEN 'Argon beam photocoagulation, ' END, '') +
						  COALESCE(CASE WHEN BotoxInjection = 1 THEN 'Botox injection, ' END, '') +
						  COALESCE(CASE WHEN EndoloopPlacement = 1 THEN 'Endoloop placement, ' END, '') +
						  COALESCE(CASE WHEN HeatProbe = 1 THEN 'Heater probe, ' END, '') +
						  COALESCE(CASE WHEN Diathermy = 1 THEN 'Diathermy , ' END, '') +
						  COALESCE(CASE WHEN ForeignBody = 1 THEN 'Foreign body removal, ' END, '') +
						  COALESCE(CASE WHEN HotBiopsy = 1 THEN 'Hot biopsy, ' END, '') +
						  COALESCE(CASE WHEN EMR = 1 THEN 'EMR, ' END, '') +
						  COALESCE(CASE WHEN Marking = 1 THEN 'Marking / tattooing, ' END, '') +
						  COALESCE(CASE WHEN Clip = 1 THEN 'Clip placement, ' END, '') +
						  COALESCE(CASE WHEN PyloricDilatation = 1 THEN 'Pyloric/duodenal dilatation, ' END, '') +
						  COALESCE(CASE WHEN StrictureDilatation = 1 THEN 'Stricture dilatation, ' END, '') +
						  COALESCE(CASE WHEN GastrostomyInsertion = 1 THEN 'Nasojejunal tube (NJT), ' END, '') +
						  COALESCE(CASE WHEN GastrostomyRemoval = 1 THEN 'Nasojejunal removal (NJT), ' END, '') +
							COALESCE((CASE WHEN ISNULL(T.Homeostasis,0) = 1	THEN 'Homeostatis - ' + l.ListItemText + ', '		END), '') +
						  COALESCE(Other, '')
						)

						FROM dbo.ERS_ERCPTherapeutics AS T
						INNER JOIN dbo.ERS_Sites AS S ON T.SiteId=S.SiteId
						LEFT JOIN dbo.ERS_Lists l ON l.ListDescription = 'Homeostasis' AND l.ListItemNo = t.HomeostasisType
						WHERE T.SiteId = @SiteId AND CarriedOutRole = @EndRole
						AND ((IsNUll(SnareExcision, 0)<>0 OR IsNull(YAGLaser, 0)<>0 OR 
							IsNUll(ArgonBeamDiathermy, 0)<>0 OR 
							IsNUll(BotoxInjection, 0)<>0 OR IsNull(EndoloopPlacement, 0)<>0 OR 
							IsNUll(HeatProbe, 0)<>0 OR 
							IsNUll(Diathermy, 0)<>0 OR IsNull(ForeignBody, 0)<>0 OR 
							IsNUll(HotBiopsy, 0)<>0 OR IsNull(EMR, 0)<>0 OR 
							IsNUll(Marking, 0)<>0 OR IsNull(Clip, 0)<>0 OR 
							IsNUll(PyloricDilatation, 0)<>0 OR IsNull(GastrostomyInsertion, 0)<>0 OR 
							IsNUll(GastrostomyRemoval, 0)<>0 OR IsNull(StrictureDilatation, 0)<>0) OR 
							(ISNULL(T.Homeostasis, 0) = 1 AND T.HomeostasisType NOT IN  (1,2,3)) OR
							LEN(IsNull(Other, '')) >= 1)
												
					END				
			ELSE IF @ProcType = 3 OR @ProcType = 13 OR @ProcType = 4 --## FLEXY/COLON
				BEGIN
					SELECT @ResultVar=(
							COALESCE((CASE WHEN T.BotoxInjection = 1		THEN 'Botox injection, '		END), '') +
							COALESCE((CASE WHEN T.HeatProbe = 1		THEN 'Heater probe, '		END), '') +
							COALESCE((CASE WHEN T.Diathermy = 1		THEN 'Diathermy, '		END), '') +
							COALESCE((CASE WHEN T.HotBiopsy = 1		THEN 'Hot biopsy, '		END), '') +
							COALESCE((CASE WHEN T.EMR = 1		THEN 'EMR, '		END), '') +
							COALESCE((CASE WHEN T.EndoClot = 1		THEN 'Endoclot, '		END), '') +
							COALESCE((CASE WHEN T.Sigmoidopexy = 1		THEN 'Sigmoidopexy, '		END), '') +
							COALESCE((CASE WHEN ISNULL(T.Homeostasis,0) = 1		THEN 'Homeostatis - ' + l.ListItemText + ', '		END), '') +
							COALESCE(T.Other, '')  )
						FROM [dbo].ERS_UpperGITherapeutics AS T
						INNER JOIN dbo.ERS_Sites AS S ON T.SiteId=S.SiteId 
						LEFT JOIN dbo.ERS_Lists l ON l.ListDescription = 'Homeostasis' AND l.ListItemNo = t.HomeostasisType
						WHERE T.SiteId = @SiteId
						  AND T.CarriedOutRole = @EndRole
						  AND ((IsNUll(BotoxInjection, 0)<>0 OR IsNull(HeatProbe, 0)<>0 OR 
							IsNull(Diathermy, 0)<>0 OR 
							IsNUll(HotBiopsy, 0)<>0 OR IsNull(EMR, 0)<>0 OR 
							IsNUll(EndoClot, 0)<>0 OR IsNull(Sigmoidopexy, 0)<>0) OR 
							(ISNULL(T.Homeostasis, 0) = 1 AND T.HomeostasisType NOT IN  (1,2,3)) OR
							LEN(IsNull(Other, '')) >= 1)
				END
			ELSE IF @ProcType = 8 OR @ProcType = 9 --## ENT
				BEGIN	
					SELECT @ResultVar=(
							COALESCE((CASE WHEN ISNULL(T.Homeostasis,0) = 1		THEN 'Homeostatis - ' + l.ListItemText + ', '		END), '') +
							COALESCE((CASE WHEN T.GastricBalloonInsertion = 1		THEN 'Insertion of gastric balloon, '		END), '') +
							COALESCE(T.Other, '')  )
						FROM [dbo].ERS_UpperGITherapeutics AS T
						INNER JOIN dbo.ERS_Sites AS S ON T.SiteId=S.SiteId 
						LEFT JOIN dbo.ERS_Lists l ON l.ListDescription = 'Homeostasis' AND l.ListItemNo = t.HomeostasisType
						WHERE T.SiteId = @SiteId
						  AND T.CarriedOutRole = @EndRole
						  AND (ISNULL(T.Homeostasis, 0) = 1 AND T.HomeostasisType NOT IN  (1,2,3)) OR
						  ISNULL(t.GastricBalloonInsertion,0) = 1 OR
							(LEN(IsNull(Other, '')) >= 1)				
				END
				
			ELSE IF @ProcType = 5 OR @ProcType = 6 --## EUS
				BEGIN	
					SELECT @ResultVar=(
							COALESCE((CASE WHEN ISNULL(T.Homeostasis,0) = 1		THEN 'Homeostatis - ' + l.ListItemText + ', '		END), '') +
							COALESCE((CASE WHEN T.GastricBalloonInsertion = 1		THEN 'Insertion of gastric balloon, '		END), '') +
							COALESCE(T.Other, '')  )
						FROM [dbo].ERS_UpperGITherapeutics AS T
						INNER JOIN dbo.ERS_Sites AS S ON T.SiteId=S.SiteId 
						LEFT JOIN dbo.ERS_Lists l ON l.ListDescription = 'Homeostasis' AND l.ListItemNo = t.HomeostasisType
						WHERE T.SiteId = @SiteId
						  AND T.CarriedOutRole = @EndRole
						  AND (ISNULL(T.Homeostasis, 0) = 1 AND T.HomeostasisType NOT IN  (1,2,3)) OR
						  ISNULL(t.GastricBalloonInsertion,0) = 1 OR
							(LEN(IsNull(Other, '')) >= 1)				
				END
		END
	
	SET @ResultVar = ltrim(rtrim(@ResultVar));
	--## Remove the Last ',' of the String; That's a virus! Bad for indigestion!
	SELECT @ResultVar= CASE 
						WHEN RIGHT(@ResultVar, 1)=',' THEN SUBSTRING(@ResultVar, 1, LEN(@ResultVar)-1)
						ELSE @ResultVar END;

	RETURN @ResultVar;
END

--################## END Function: fnNED_GetOtherTypeTheraps; Scalar Function
GO




------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO




UPDATE dbo.ERS_TherapeuticTypes SET OGD = 1 WHERE Description = 'Insertion of gastric balloon'
GO



------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 17.01.24
-- TFS#	3542
-- Description of change
-- Set matrix code for flexi/sig independantly of colon
------------------------------------------------------------------------------------------------------------------------
GO


/****** Object:  Trigger [dbo].[TR_CommonAbnoLesions]    Script Date: 17/01/2024 08:50:16 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

	ALTER TRIGGER [dbo].[TR_CommonAbnoLesions]
	ON [dbo].[ERS_CommonAbnoLesions]
	AFTER INSERT, UPDATE, DELETE
	AS 
		DECLARE @site_id INT, @Polyp VARCHAR(10) = 'False', 
							  @BenignTumour VARCHAR(10) = 'False', 
							  @MalignantTumour VARCHAR(10) = 'False', 
							  @SubmucosalTumour VARCHAR(10) = 'False', 
							  @FocalLesions VARCHAR(10) = 'False',
							  @SubmucoaslLesion VARCHAR(10) = 'False',
							  @FundicGlandPolyp VARCHAR(10) = 'False',
							  @PreviousESDScar VARCHAR(10) = 'False',
				@PolypTypeId int, @Region varchar(20), @ProcedureTypeId int, @MatrixCode varchar(50)
	
		IF EXISTS(SELECT * FROM INSERTED)
		BEGIN
			SELECT @site_id=SiteId,
					@Polyp = (CASE WHEN (ISNULL(Polyp,0) = 1) THEN 'True' ELSE 'False' END),
					@FocalLesions = (CASE WHEN (ISNULL(Focal,0) = 1) THEN 'True' ELSE 'False' END),
					@SubmucoaslLesion = (CASE WHEN (ISNULL(Submucosal,0) = 1) THEN 'True' ELSE 'False' END),
					@FundicGlandPolyp = (CASE WHEN (ISNULL(FundicGlandPolyp,0) = 1) THEN 'True' ELSE 'False' END),
					@PolypTypeId = PolypTypeId,
					@PreviousESDScar = (CASE WHEN (ISNULL(PreviousESDScar,0) = 1) THEN 'True' ELSE 'False' END)
				
			FROM INSERTED

			SELECT TOP 1 @ProcedureTypeId =  p.ProcedureType FROM ERS_Sites s INNER JOIN ERS_Procedures p ON p.ProcedureId = s.ProcedureId WHERE s.SiteId = @site_id
			--check if polyps = 1
			IF @Polyp = 'True' 
			BEGIN
				--check for polyp type
				DECLARE @PolypType VARCHAR(200) = (SELECT Description FROM ERS_PolypTypes WHERE UniqueId = @PolypTypeId)

				IF LOWER(@PolypType) = 'sessile'
				BEGIN
					--sessile polyps to produce a gastric tumour outcome depending on the tumour type
					IF EXISTS (SELECT 1 FROM ERS_CommonAbnoPolypDetails WHERE SiteId = @site_id AND Type = (SELECT UniqueId FROM ERS_TumourTypes WHERE Description = 'benign'))
						SET @BenignTumour = 'True'
					ELSE 
						SET @BenignTumour = 'False'

					IF EXISTS (SELECT 1 FROM ERS_CommonAbnoPolypDetails WHERE SiteId = @site_id AND Type = (SELECT UniqueId FROM ERS_TumourTypes WHERE Description = 'malignant'))
						SET @MalignantTumour = 'True'
					ELSE
						SET @MalignantTumour = 'False'
				END
			
				IF LOWER(@PolypType) = 'submucosal'  AND LOWER(@Region) = 'stomach'
					SET @SubmucoaslLesion = 'True'
				ELSE
					SET @SubmucoaslLesion = 'False'

			END
		
			IF @ProcedureTypeId IN (1,6,8)
			BEGIN
				SELECT @Region = dbo.fnSiteRegion(@site_id)

				IF LOWER(@Region) = 'stomach'
				BEGIN
					--SELECT @Polyp = CASE WHEN @FundicGlandPolyp = 'False' AND @BenignTumour = 'False' AND @MalignantTumour = 'False' AND @SubmucosalTumour = 'False' THEN 'True' ELSE 'False' END
					SET @MatrixCode = 'D40P1'
				END
				ELSE IF LOWER(@Region) = 'oesophagus'
					SET @MatrixCode = 'N2013'
				ELSE IF LOWER(@Region) = 'duodenum'
					SET @MatrixCode = 'D58P1'
				ELSE IF LOWER(@Region) = 'colon'
					SET @MatrixCode = 'D58P1'
				
			END
			ELSE IF @ProcedureTypeId IN (3,4,9)
			BEGIN
				SELECT @Region = dbo.fnSiteRegion(@site_id)

				IF @Polyp = 'True' AND @Region IN ('Rectum', 'Anal Margin')
					SET @MatrixCode = 'D4P3'

				IF @Polyp = 'True' AND @Region NOT IN ('Rectum', 'Anal Margin', 'Terminal Ileum')
					SET @MatrixCode = 'D12P3'

				IF @Polyp = 'True' AND @Region IN ('Terminal Ileum', 'Neo-Terminal Ileum')
					SET @MatrixCode = 'DIPOLYPP3'
			END

		END
		ELSE
		BEGIN
			SELECT @site_id=SiteId FROM DELETED
		END

		EXEC abnormalities_common_lesions_summary_update @site_id

		IF @site_id IS NOT NULL AND @ProcedureTypeId IN (1,3,4,6,8,9,2,7)
		BEGIN
			EXEC sites_summary_update @site_id

			EXEC diagnoses_control_save @site_id, @MatrixCode, @Polyp		
			--EXEC diagnoses_control_save @site_id, 'D86P1', @BenignTumour	
			--EXEC diagnoses_control_save @site_id, 'D87P1', @MalignantTumour	
			EXEC diagnoses_control_save @site_id, 'N2001', @FocalLesions
			EXEC diagnoses_control_save @site_id, 'D88P1', @SubmucosalTumour
			EXEC diagnoses_control_save @site_id, 'N2002', @SubmucoaslLesion
			EXEC diagnoses_control_save @site_id, 'N2019', @FundicGlandPolyp

			IF @ProcedureTypeId IN (1,2,6,7,8)
			BEGIN
			    EXEC diagnoses_control_save @site_id, 'DSESDSCARP1', @PreviousESDScar		
			END
			ELSE IF @ProcedureTypeId IN (3,9)
			BEGIN
				EXEC diagnoses_control_save @site_id, 'DESDSCARP3', @PreviousESDScar
			END
			ELSE IF @ProcedureTypeId = 4
			BEGIN
				EXEC diagnoses_control_save @site_id, 'SDESDSCARP3', @PreviousESDScar
			END
		END
GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 17.01.24
-- TFS#	3542
-- Description of change
-- Updated diagnosis codes for sigi procedures to replace the 1st character with an S as required by diagnoses_control_save
------------------------------------------------------------------------------------------------------------------------
GO

 UPDATE dbo.ERS_DiagnosesMatrix
 SET Code = STUFF(code, 1, 1, 'S') 
 WHERE ProcedureTypeID = 4 AND LEFT(Code,1) <> 'S'

 GO





ALTER PROCEDURE [dbo].[sites_delete]
(
	@SiteId INT
)
AS

SET NOCOUNT ON

DECLARE @ProcedureId INT, @AreaNo INT, @SiteNo INT, @ProcedureType INT

-- AS (08/SEP/2021) - Adding IsLymphNode column to distinguish between EBUS and EBUS BRT subtype of EBUS.
DECLARE @IsLymphNode BIT

BEGIN TRANSACTION

BEGIN TRY
	SELECT @ProcedureId = s.ProcedureId, @AreaNo = s.AreaNo, @SiteNo = s.SiteNo, @ProcedureType = p.ProcedureType, @IsLymphNode = CASE WHEN s.IsLymphNode = 1 THEN 'True' ELSE 'False' END
	FROM ERS_Procedures p
	INNER JOIN ERS_Sites s ON p.ProcedureId = s.ProcedureId
	WHERE s.SiteId = @SiteId

	IF @ProcedureType IN (1, 6, 8) --Gastroscopy, EUS_OGD, ENT Ant
	BEGIN
		DELETE FROM ERS_UpperGIAbnoDeformity WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoAchalasia WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoGastricUlcer WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoGastritis WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoLumen WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoMalignancy WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoPolyps WHERE SiteId = @SiteId
		DELETE FROM ERS_CommonAbnoLesions WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoPostSurgery WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoVarices WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoHiatusHernia WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoOesophagitis WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoBarrett WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoMiscellaneous WHERE SiteId = @SiteId
		DELETE FROM ERS_EUSAbnoMediastinal WHERE SiteId = @SiteId
	END
	ELSE IF @ProcedureType IN (2, 7)   --ERCP, EUS_HPB
	BEGIN
		DELETE FROM ERS_ERCPAbnoDuct WHERE SiteId = @SiteId
		DELETE FROM ERS_ERCPAbnoParenchyma WHERE SiteId = @SiteId
		DELETE FROM ERS_ERCPAbnoAppearance WHERE SiteId = @SiteId
		DELETE FROM ERS_ERCPAbnoDiverticulum WHERE SiteId = @SiteId
		DELETE FROM ERS_ERCPAbnoTumour WHERE SiteId = @SiteId
		DELETE FROM ERS_ERCPAbnoIntrahepatic WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoVarices WHERE SiteId = @SiteId
		IF EXISTS (SELECT TOP 1 Id FROM ERS_ERCPTherapeutics WHERE SiteId = @SiteId)
		BEGIN
			DECLARE @TherapeuticId INT
			SET @TherapeuticId = (SELECT TOP 1 Id FROM ERS_ERCPTherapeutics WHERE SiteId = @SiteId)
			DELETE FROM ERS_ERCPTherapeuticStentInsertions WHERE TherapeuticId = @TherapeuticId
			DELETE FROM ERS_ERCPTherapeutics WHERE SiteId = @SiteId
		END
		DELETE FROM ERS_EUSAbnoMediastinal WHERE SiteId = @SiteId
	END
	ELSE IF @ProcedureType IN (3,4,5,9)   --Colonoscopy, Sigmoidscopy, Proctoscopy, ENT Retro
	BEGIN
		DELETE FROM ERS_ColonAbnoMucosa WHERE SiteId = @SiteId
		DELETE FROM ERS_ColonAbnoVascularity WHERE SiteId = @SiteId
		DELETE FROM ERS_CommonAbnoLesions WHERE SiteId = @SiteId
		DELETE FROM ERS_ColonAbnoDiverticulum WHERE SiteId = @SiteId
		DELETE FROM ERS_ColonAbnoHaemorrhage WHERE SiteId = @SiteId
		DELETE FROM ERS_ColonAbnoPerianalLesions WHERE SiteId = @SiteId
		DELETE FROM ERS_ColonAbnoCalibre WHERE SiteId = @SiteId
		DELETE FROM ERS_ColonAbnoMiscellaneous WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoVarices WHERE SiteId = @SiteId
		if exists(select 1 FROM ERS_ColonAbnoTumour WHERE SiteId = @SiteId)
			DELETE FROM ERS_ColonAbnoTumour WHERE SiteId = @SiteId
	END
	ELSE IF @ProcedureType IN (10)
	BEGIN
		DELETE FROM dbo.ERS_BRTAbnoDescriptions WHERE SiteId = @SiteId
	END

	ELSE IF @ProcedureType IN (11)
	BEGIN
		IF @IsLymphNode = 'True'
			DELETE FROM dbo.ERS_EBUSAbnoDescriptions WHERE SiteId = @SiteId
		ELSE
			DELETE FROM dbo.ERS_BRTAbnoDescriptions WHERE SiteId = @SiteId
	END

	DELETE FROM ERS_CommonAbnoDiverticulum WHERE SiteId = @SiteId	
	DELETE FROM ERS_CommonAbnoTumour WHERE SiteId = @SiteId		
	DELETE FROM ERS_CommonAbnoDuodenitis WHERE SiteId = @SiteId	
	DELETE FROM ERS_CommonAbnoDuodenalUlcer WHERE SiteId = @SiteId
	DELETE FROM ERS_CommonAbnoScaring WHERE SiteId = @SiteId	
	DELETE FROM ERS_CommonAbnoVascularLesions WHERE SiteId = @SiteId	
	DELETE FROM ERS_CommonAbnoAtrophic WHERE SiteId = @SiteId

	DELETE FROM ERS_CommonAbnoOther WHERE SiteId = @SiteId

	DELETE FROM ERS_UpperGISpecimens WHERE SiteId = @SiteId
	DELETE FROM ERS_BRTSpecimens WHERE SiteId = @SiteId
	DELETE FROM ERS_UpperGITherapeutics WHERE SiteId = @SiteId		

	DELETE FROM ERS_Photos WHERE SiteId = @SiteId

	DELETE FROM ERS_RecordCount WHERE SiteId = @SiteId	

	IF @AreaNo > 0 AND @SiteNo > 0 --Main Site of an Area
		DELETE FROM ERS_Sites WHERE ProcedureId = @ProcedureId AND AreaNo = @AreaNo 
	ELSE
		DELETE FROM ERS_Sites WHERE SiteId = @SiteId

	IF EXISTS (SELECT 1 FROM ERS_Diagnoses WHERE ProcedureId = @ProcedureId AND SiteId = @SiteId)
	BEGIN
		DELETE FROM ERS_Diagnoses WHERE ProcedureId = @ProcedureId AND SiteId = @SiteId
		EXEC ogd_diagnoses_summary_update @ProcedureID
	END

	EXEC sites_reorder @ProcedureId
	EXEC procedure_summary_update @ProcedureId
END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;
GO

IF NOT EXISTS (SELECT 1 FROM sys.columns WHERE name = 'Lesions' AND object_id = OBJECT_ID('ERS_AbnormalitiesMatrixERCP'))
BEGIN
    ALTER TABLE ERS_AbnormalitiesMatrixERCP ADD Lesions BIT NOT NULL CONSTRAINT [DF_ERS_AbnormalitiesMatrixERCP_Lesions] DEFAULT 0
END
GO

UPDATE ERS_AbnormalitiesMatrixERCP SET Lesions = 1 WHERE Area = 'Duodenum'
GO

IF NOT EXISTS (SELECT 1 FROM ERS_SiteDetailsMenuUrls WHERE ProcedureType IN (2,7) AND Menu = 'Lesions')
BEGIN
    INSERT INTO ERS_SiteDetailsMenuUrls (ProcedureType, Menu, NavigateUrl)
    VALUES (2, 'Lesions', '~/Products/Gastro/Abnormalities/Common/Lesions.aspx'),
    	   (7, 'Lesions', '~/Products/Gastro/Abnormalities/Common/Lesions.aspx')
END
GO


ALTER PROCEDURE [dbo].[site_details_menu_select]
(
	@SiteId INT	
)
AS

SET NOCOUNT ON

DECLARE	@ProcedureType INT
DECLARE @Region VARCHAR (500)
DECLARE	@Area VARCHAR (50)
DECLARE	@ProcedureId INT

CREATE TABLE #Menus (
	[SiteId] INT,
	[ProcedureType] INT,
	[Region] VARCHAR(500),	
	[ParentMenu] VARCHAR (500),
	[Menu] VARCHAR (500),
	[NavigateUrl] VARCHAR (4000),
	[SortOrder] TINYINT
)

DECLARE @SiteNo INT = NULL, @IsLymphNode BIT = 0

SELECT @SiteNo = SiteNo FROM ERS_Sites WHERE SiteId = @SiteId

IF @SiteId = -1 
BEGIN
	SET @ProcedureType = 11
	SET @IsLymphNode = 1
	SET @Region = 'EBUS'
END
ELSE IF @SiteNo = 0
	SET @SiteId = dbo.fnGetPrimeSiteId(@SiteId)
ELSE IF @SiteNo = -77   --'SiteNo is set to -77 for sites By Distance (Col & Sig only)
	SELECT @ProcedureType = 3, @Region = 'Anus'
ELSE
	SELECT @ProcedureType = p.ProcedureType, @Region = r.Region, @ProcedureId = p.ProcedureId, @IsLymphNode = s.IsLymphNode 
	FROM ERS_Sites s
	JOIN ERS_Procedures p ON s.ProcedureId = p.ProcedureId
	JOIN ERS_Regions r ON s.RegionId = r.RegionId
	WHERE SiteId = @SiteId

IF @ProcedureType IN (1,6) --Gastroscopy / EUS(OGD)
BEGIN

	SELECT TOP 1 @Area = [Area] 
	FROM ERS_AbnormalitiesMatrixUpperGI
	WHERE [ProcedureType] = @ProcedureType 
	AND [Region] = @Region

	INSERT INTO #Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu])
	SELECT 
		@SiteId,
		[ProcedureType], 
		[Region], 
		'Abnormalities' AS [ParentMenu], 
		[Menu]
	FROM 
	(
		SELECT * 
		FROM [ERS_AbnormalitiesMatrixUpperGI] 
		WHERE [ProcedureType] = @ProcedureType 
		AND [Region] = @Region
	) a
	UNPIVOT
	(
		[Display] 
		FOR [Menu] IN ([Gastritis], [Gastric Ulcer], [Lumen], [Malignancy], [Post Surgery], 
						[Deformity], [Polyps], [Varices], [Hiatus Hernia], [Achalasia], 
						[Oesophagitis], [Barretts], [Miscellaneous], [Diverticulum/Other], [Tumour], 
						[Duodenitis], [Pyloric Ulcer], [Duodenal Ulcer], [Scarring/Stenosis], [Vascular Lesions],
						[Atrophic Duodenum], [Mediastinal], [Lesions])
	) b
	WHERE [Display] = 1

	INSERT INTO #Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu], [NavigateUrl], [SortOrder])
	SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Gastro/TherapeuticProcedures/OGDTherapeuticProcedures.aspx', 1
	--SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Gastro/Abnormalities/OGD/Lumen.aspx'
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Gastro/Specimens/OGDSpecimensTaken.aspx', 2
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Media', '', '~/Products/Common/AttachedMedia.aspx', 3
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Additional notes', '', '~/Products/Gastro/Notes/Notes.aspx', 4
	--SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Gastro/Abnormalities/OGD/Lumen.aspx'
END

ELSE IF @ProcedureType IN (2,7) --ERCP / EUS(HPB)
BEGIN

	SELECT TOP 1 @Area = [Area] 
	FROM ERS_AbnormalitiesMatrixERCP
	WHERE [ProcedureType] = @ProcedureType 
	AND [Region] = @Region

	INSERT INTO #Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu])
	SELECT 
		@SiteId,
		[ProcedureType], 
		[Region], 
		'Abnormalities' AS [ParentMenu], 
		[Menu]
	FROM 
	(
		SELECT * 
		FROM [ERS_AbnormalitiesMatrixERCP] 
		WHERE [ProcedureType] = @ProcedureType 
		AND [Region] = @Region
	) a
	UNPIVOT
	(
		[Display] 
		FOR [Menu] IN ([Gall Bladder], [Duct], [Parenchyma], [Appearance], [Diverticulum], [Tumour], [Diverticulum/Other], 
						[TumourCommon],[Duodenitis],[Duodenal Ulcer],[Scarring/Stenosis],[Vascular Lesions],[Atrophic Duodenum],[Intrahepatic],[Site],[Miscellaneous], [Varices], [Lesions])
	) b
	WHERE [Display] = 1

	INSERT INTO #Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu], [NavigateUrl], [SortOrder])
	--SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Gastro/TherapeuticProcedures/ERCPTherapeuticProcedures.aspx'
	--SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Gastro/Abnormalities/OGD/Lumen.aspx'
	SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Gastro/TherapeuticProcedures/ERCPTherapeuticProcedures.aspx', 1
	UNION ALL
	--SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Gastro/Specimens/ERCPSpecimensTaken.aspx'
	--SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Gastro/Abnormalities/OGD/Lumen.aspx'
	SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Gastro/Specimens/OGDSpecimensTaken.aspx', 2
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Media', '', '~/Products/Common/AttachedMedia.aspx', 3
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Additional notes', '', '~/Products/Gastro/Notes/Notes.aspx', 4
	
END

ELSE IF @ProcedureType IN (3,4,5) --Colonoscopy / Proctoscopy / Sigmoidoscopy
BEGIN
	INSERT INTO #Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu])
	SELECT 
		@SiteId,
		[ProcedureType], 
		[Region], 
		'Abnormalities' AS [ParentMenu], 
		[Menu]
	FROM 
	(
		SELECT * 
		FROM [ERS_AbnormalitiesMatrixColon] 
		WHERE [ProcedureType] = @ProcedureType 
		AND [Region] = @Region
	) a
	UNPIVOT
	(
		[Display] 
		FOR [Menu] IN ([Calibre],[Mucosa], [Diverticulum], [Lesions], [Vascularity], [Haemorrhage], [Miscellaneous], [Perianal Lesions],[Tumour], [Varices])
	) b
	WHERE [Display] = 1

	INSERT INTO #Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu], [NavigateUrl], [SortOrder])
	--SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Gastro/TherapeuticProcedures/ColonTherapeuticProcedures.aspx'
	--SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Gastro/Abnormalities/OGD/Lumen.aspx'
	SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Gastro/TherapeuticProcedures/OGDTherapeuticProcedures.aspx', 1
	UNION ALL
	--SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Gastro/Specimens/ColonSpecimensTaken.aspx'
	--SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Gastro/Abnormalities/OGD/Lumen.aspx'
	SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Gastro/Specimens/OGDSpecimensTaken.aspx', 2
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Media', '', '~/Products/Common/AttachedMedia.aspx', 3
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Additional notes', '', '~/Products/Gastro/Notes/Notes.aspx', 4
END

ELSE IF @ProcedureType IN (8) --Antegrade
BEGIN
	SELECT TOP 1 @Area = [Area] 
	FROM [ERS_AbnormalitiesMatrixAntegrade]
	WHERE [ProcedureType] = @ProcedureType 
	AND [Region] = @Region

	INSERT INTO #Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu])
	SELECT 
		@SiteId,
		[ProcedureType], 
		[Region], 
		'Abnormalities' AS [ParentMenu], 
		CASE WHEN region = 'Jejunum' AND [Menu] = 'Diverticulum/Other' THEN 'Diverticulum' /*WHEN region= 'Ileum' AND [Menu] = 'Miscellaneous/Other' THEN 'Miscellaneous'*/ ELSE [Menu] END AS Menu
	FROM 
	(
		SELECT * 
		FROM [ERS_AbnormalitiesMatrixAntegrade] 
		WHERE [ProcedureType] = @ProcedureType 
		AND [Region] = @Region
	) a
	UNPIVOT
	(
		[Display] 
		FOR [Menu] IN ([Gastritis], [Gastric Ulcer], [Lumen], [Malignancy], [Post Surgery], 
						[Deformity], [Varices], [Hiatus Hernia], [Achalasia], 
						[Oesophagitis], [Barretts], [Miscellaneous], [Diverticulum/Other], [Tumour], 
						[Duodenitis], [Pyloric Ulcer], [Duodenal Ulcer], 
						[Lesions],[Jejunitis],[Jejunal Ulcer],[Ileitis],[Ileal Ulcer],
						[Scarring/Stenosis], [Vascular Lesions],
						[Atrophic Duodenum], [Miscellaneous/Other])
	) b
	WHERE [Display] = 1

	INSERT INTO #Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu], [NavigateUrl], [SortOrder])
	SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Gastro/TherapeuticProcedures/OGDTherapeuticProcedures.aspx', 1
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Gastro/Specimens/OGDSpecimensTaken.aspx', 2
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Media', '', '~/Products/Common/AttachedMedia.aspx', 3
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Additional notes', '', '~/Products/Gastro/Notes/Notes.aspx', 4
END

ELSE IF @ProcedureType IN (9) --Retrograde
BEGIN
	INSERT INTO #Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu])
	SELECT 
		@SiteId,
		[ProcedureType], 
		[Region], 
		'Abnormalities' AS [ParentMenu], 
		[Menu]
	FROM 
	(
		SELECT * 
		FROM [ERS_AbnormalitiesMatrixRetrograde] 
		WHERE [ProcedureType] = @ProcedureType 
		AND [Region] = @Region
	) a
	UNPIVOT
	(
		[Display] 
		FOR [Menu] IN ([Calibre], [Mucosa], [Diverticulum], [Lesions], [Vascularity], [Haemorrhage], [Miscellaneous], [Perianal Lesions], [Tumour], 
		[Jejunitis], [Jejunal Ulcer], [Scarring/Stenosis], [Ileitis], [Ileal Ulcer], [Varices])
	) b
	WHERE [Display] = 1

	INSERT INTO #Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu], [NavigateUrl], [SortOrder])
	--SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Gastro/TherapeuticProcedures/ColonTherapeuticProcedures.aspx'
	--SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Gastro/Abnormalities/OGD/Lumen.aspx'
	SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Gastro/TherapeuticProcedures/OGDTherapeuticProcedures.aspx', 1
	UNION ALL
	--SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Gastro/Specimens/ColonSpecimensTaken.aspx'
	--SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Gastro/Abnormalities/OGD/Lumen.aspx'
	SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Gastro/Specimens/OGDSpecimensTaken.aspx', 2
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Media', '', '~/Products/Common/AttachedMedia.aspx', 3
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Additional notes', '', '~/Products/Gastro/Notes/Notes.aspx', 4
END

ELSE IF @ProcedureType IN (10,11) and @IsLymphNode = 0 -- Bronchoscopy / EBUS
BEGIN
	INSERT INTO #Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu])
	SELECT 
		@SiteId,
		[ProcedureType], 
		[Region], 
		'Abnormalities' AS [ParentMenu], 
		[Menu]
	FROM 
	(
		SELECT * 
		FROM [ERS_AbnormalitiesMatrixBRT] 
		WHERE [ProcedureType] = @ProcedureType 
		--AND [Region] = @Region      -- Abnormality is the same for all BRT regions 
	) a
	UNPIVOT
	(
		[Display] 
		FOR [Menu] IN ([Carinal Abnormality], [Vocal Cord Paralysis], [Compression], [Stenosis], [Obstruction], [Mucosal], [Mucosal Irregularity], [Excessive secretions], [Bleeding])
	) b
	WHERE [Display] = 1

	INSERT INTO #Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu], [NavigateUrl], [SortOrder])
	SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Gastro/TherapeuticProcedures/OGDTherapeuticProcedures.aspx', 1
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Broncho/Specimens/BronchoSpecimens.aspx', 2
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Media', '', '~/Products/Common/AttachedMedia.aspx', 3
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Additional notes', '', '~/Products/Gastro/Notes/Notes.aspx', 4
END

ELSE IF @ProcedureType = 11 and @IsLymphNode = 1 --  EBUS
BEGIN
	INSERT INTO #Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu])
	SELECT 
		@SiteId,
		[ProcedureType], 
		[Region], 
		'Abnormalities' AS [ParentMenu], 
		[Menu]
	FROM 
	(
		SELECT * 
		FROM [ERS_AbnormalitiesMatrixBRT] 
		WHERE [ProcedureType] = @ProcedureType 
		--AND [Region] = @Region      -- Abnormality is the same for all BRT regions 
	) a
	UNPIVOT
	(
		[Display] 
		FOR [Menu] IN ([EBUS Abnormality descriptions])
	) b
	WHERE [Display] = 1

	INSERT INTO #Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu], [NavigateUrl], [SortOrder])
	SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Gastro/TherapeuticProcedures/OGDTherapeuticProcedures.aspx', 1
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Broncho/Specimens/BronchoSpecimens.aspx', 2
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Media', '', '~/Products/Common/AttachedMedia.aspx' , 3
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Additional notes', '', '~/Products/Gastro/Notes/Notes.aspx', 4
END
ELSE IF @ProcedureType IN (13) -- Cystoscopy
BEGIN
	INSERT INTO #Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu])
	SELECT 
		@SiteId,
		[ProcedureType], 
		[Region], 
		'Abnormalities' AS [ParentMenu], 
		[Menu]
	FROM 
	(
		SELECT * 
		FROM [ERS_AbnormalitiesMatrixCystoscopy] 
		WHERE [ProcedureType] = @ProcedureType 
		AND [Region] = @Region      
	) a
	UNPIVOT
	(
		[Display] 
		FOR [Menu] IN ([Bladder],[Prostate],[Urethra])
	) b
	WHERE [Display] = 1

	INSERT INTO #Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu], [NavigateUrl], [SortOrder])
	SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Cystoscopy/TherapeuticProcedures/CystoscopyTherapeuticProcedures.aspx', 1
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Cystoscopy/Specimens/CystoscopySpecimens.aspx', 2
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Media', '', '~/Products/Common/AttachedMedia.aspx', 3
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Additional notes', '', '~/Products/Gastro/Notes/Notes.aspx', 3
END

UPDATE a
SET NavigateUrl = b.NavigateUrl
FROM #Menus a
LEFT JOIN ERS_SiteDetailsMenuUrls b ON a.Menu = b.Menu
WHERE b.ProcedureType = @ProcedureType

UPDATE #Menus SET Menu = 'Tumour' WHERE Menu = 'TumourCommon'

-- Check if there are Other Abnormalities in this region, if there are, display Other in the Abnormalities tab
IF EXISTS (SELECT 1 FROM sys.objects WHERE object_id = object_id('ERS_OtherAbnormalitiesRegions'))
begin
If exists(Select 1 from ERS_OtherAbnormalitiesRegions oar join ERS_Sites s on s.RegionId = oar.RegionId join ERS_OtherAbnormalities OA on oar.OtherId = OA.OtherId where OA.Active = 1 and s.SiteId = @SiteId)
BEGIN
	INSERT INTO #Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu], [NavigateUrl])
	SELECT 
		@SiteId,
		@ProcedureType, 
		r.Region, 
		'Abnormalities' AS [ParentMenu], 
		'Other' as [Menu],
		'~/Products/Gastro/Abnormalities/Common/Other.aspx' as NavigateUrl
	FROM ERS_Sites s
	join ERS_Regions r on s.RegionId = r.regionId
	where s.SiteId = @SiteId 
END
end
SELECT 
	m.ProcedureType,
	m.Region,
	m.ParentMenu, 
	m.Menu,
	m.NavigateUrl, 
	CASE WHEN r.RecordCountId IS NULL THEN 0 ELSE 1 END AS RecordExists,
	ISNULL(@Area,ISNULL(@Region,'')) AS Area
FROM 
	#Menus m
LEFT OUTER JOIN
	ERS_RecordCount r ON 
		(m.SiteId = r.SiteId OR
			(@ProcedureType IN (2,7) AND r.ProcedureId = @ProcedureId AND r.Identifier = 'Diagnoses')) --These conditions for Diagnoses only (for the whole procedure unlike the other items which are per site)
		AND (m.Menu = r.Identifier OR m.ParentMenu = r.Identifier)
				--OR LEFT(m.Menu,12) = 'Diverticulum') -- embolden 'Diverticulum/Other' when its attributes have been set.
ORDER BY m.SortOrder, m.Menu

DROP TABLE #Menus
GO


ALTER PROCEDURE [dbo].[sites_summary_update]
(
	@SiteId INT,
	@RefreshReport BIT = 1
)
AS
/*
-- Update History:
-- 10 Nov 2023		MH		replaced table reference ERS_ColonAbnoLesions with ERS_CommonAbnoLesions	TFS #3556
-- 15 Nov 2023		MH/Andrea		after finding the sp could updated from older version - the script has been taken from release 2_23_05_03 and then added some required refreshsummary works done by Steve, Polyp details are fixed here for Colon,Gastro etc
--							
*/
SET NOCOUNT ON

DECLARE @TrustId int
SELECT @TrustId = oh.TrustId
FROM ERS_Procedures p
JOIN ERS_Sites s ON s.ProcedureId = p.ProcedureId AND s.SiteId = @SiteId
JOIN ERS_OperatingHospitals oh ON oh.OperatingHospitalId = p.OperatingHospitalID

DECLARE @ReportSummaryRefresh int
SELECT @ReportSummaryRefresh = CAST([dbo].[fn_ShouldRefreshSummary](@TrustId) AS INT)

IF (@ReportSummaryRefresh + CAST(@RefreshReport AS INT) > 0)
BEGIN
	DECLARE @summaryAbnormalities VARCHAR(MAX)
			,@summarySpecimens VARCHAR(MAX)
			,@summaryTherapeutics VARCHAR(MAX)
			,@summaryWhole VARCHAR(MAX)
			,@summaryAbnormalitiesWithHyperLinks VARCHAR(MAX)
			,@summarySpecimensWithHyperLinks VARCHAR(MAX)
			,@summaryTherapeuticsWithHyperLinks VARCHAR(MAX)
			,@procType INT
			,@procId INT
			,@none TINYINT
			,@region VARCHAR(500)
			,@htmlAnchorCode VARCHAR(500)
			,@siteIdStr VARCHAR(15)
			,@indent VARCHAR(15) 
			,@br VARCHAR(10)
			,@opDiv VARCHAR(150)
			,@clDiv VARCHAR(50)
			,@opBold VARCHAR(5)
			,@clBold VARCHAR(5)
			,@fullStop VARCHAR(1)
			,@colon VARCHAR(2)
			,@fldNone VARCHAR(20)
			,@emptyStr VARCHAR(1)
			,@abnoTheraPresent BIT = 0
			,@tmpSummaryAbno VARCHAR(MAX)
			,@tmpSummaryAbnoLinks VARCHAR(MAX)
			,@SiteNo INT
			,@regionID INT
			,@AreaNo INT
			,@AbnormalProcedure BIT = 0


	BEGIN TRANSACTION

	BEGIN TRY

		SET	@summaryAbnormalities = ''
		SET	@summarySpecimens = ''
		SET	@summaryTherapeutics = ''
		SET	@summaryAbnormalitiesWithHyperLinks = ''
		SET	@summarySpecimensWithHyperLinks = ''
		SET	@summaryTherapeuticsWithHyperLinks = ''
		SET @siteIdStr = CONVERT(VARCHAR(10),@SiteId)
		SET @AbnormalProcedure = 0

		DECLARE @IsLymphNode VARCHAR(10) = 'False'

		SELECT @procId = p.ProcedureId,@procType = p.ProcedureType, @regionID = s.RegionId, @SiteNo = s.SiteNo, @AreaNo = ISNULL(AreaNo,0),
				@region = CASE WHEN s.SiteNo = -77 THEN						--SiteNo is set to -77 for sites By Distance (Col & Sig only)
							CONVERT(VARCHAR,XCoordinate) +  
								CASE WHEN YCoordinate IS NULL OR YCoordinate=0 THEN ' cm' 
								ELSE (' to ' + CONVERT(VARCHAR,YCoordinate) + ' cm' ) 
								END
						ELSE (SELECT r.Region FROM ERS_Regions r WHERE r.RegionId = s.RegionId)
						END
				,@IsLymphNode = CASE WHEN s.IsLymphNode = 1 THEN 'True' ELSE 'False' END
		FROM ERS_Sites s
		JOIN ERS_Procedures p ON s.ProcedureId = p.ProcedureId
		--JOIN ERS_Regions r ON s.RegionId = r.RegionId
		WHERE SiteId = @SiteId
		--SELECT @region = Region FROM ERS_Regions WHERE RegionId = @regionID

		SET @htmlAnchorCode = '<a href="#" class="sitesummary" onclick="OpenSiteDetails(''''' + @region + ''''',' + @siteIdStr + ',''''{0}'''',''''' + CONVERT(VARCHAR,@AreaNo) + ''''');">{1}</a>'
		--{0} is the name of the menu and {1} is the summary text

	
		DECLARE @SQLString NVARCHAR(MAX), @QryString NVARCHAR(MAX), @AbnoCheck BIT
		DECLARE @ProcedureType INT, @TableName VARCHAR(50), @AbnoNodeName VARCHAR(50), @Identifier VARCHAR(50)

		CREATE TABLE #QueryDetails (ProcType INT, TableName VARCHAR(50), AbnoNodeName VARCHAR(50), Identifier VARCHAR(50));

		--Notes to appear on the report just after the Site X heading, before the abnormalities.
		INSERT INTO #QueryDetails SELECT @procType,	'ERS_Sites',		'',		'Additional notes'
		IF @procType IN (1,6) --Gastroscopy / EUS(OGD)
		BEGIN
			INSERT INTO #QueryDetails VALUES 
			(@procType,	'ERS_CommonAbnoAtrophic',			'Atrophic duodenum','Atrophic Duodenum')
			,(@procType,	'ERS_UpperGIAbnoAchalasia',		'Achalasia',		'Achalasia')
			,(@procType,	'ERS_UpperGIAbnoBarrett',		'',					'Barretts Epithelium')
			,(@procType,	'ERS_UpperGIAbnoDeformity',		'Deformity',		'Deformity')
			,(@procType,	'ERS_CommonAbnoDiverticulum',	'Diverticulum',		'Diverticulum/Other')
			,(@procType,	'ERS_CommonAbnoDuodenalUlcer',	'',					CASE WHEN @region = 'Jejunum' THEN 'Jejunal Ulcer' WHEN @region = 'Ileum' THEN 'Ileal Ulcer' ELSE 'Duodenal Ulcer' END)
			,(@procType,	'ERS_CommonAbnoDuodenitis',		'',					CASE WHEN @region = 'Jejunum' THEN 'Jejunitis' WHEN @region = 'Ileum' THEN 'Ileitis' ELSE 'Duodenitis' END)
			,(@procType,	'ERS_UpperGIAbnoGastricUlcer',	'Gastric ulcer',	'Gastric Ulcer')
			,(@procType,	'ERS_UpperGIAbnoGastritis',		'Gastritis',		'Gastritis')
			,(@procType,	'ERS_UpperGIAbnoHiatusHernia',	'Hiatus hernia',	'Hiatus Hernia')
			,(@procType,	'ERS_UpperGIAbnoLumen',			'Lumen',			'Lumen')
			,(@procType,	'ERS_UpperGIAbnoMalignancy',	'Malignancy',		'Malignancy')
			,(@procType,	'ERS_UpperGIAbnoMiscellaneous',	'',					'Miscellaneous')
			,(@procType,	'ERS_UpperGIAbnoOesophagitis',	'Oesophagitis',		'Oesophagitis')
			,(@procType,	'ERS_CommonAbnoLesions',		'Lesions',			'Lesions')
			,(@procType,	'ERS_UpperGIAbnoPostSurgery',	'Post surgery',		'Post Surgery')
			,(@procType,	'ERS_CommonAbnoScaring',		'',					'Scarring/Stenosis')
			,(@procType,	'ERS_CommonAbnoTumour',			'',					'Tumour')
			,(@procType,	'ERS_UpperGIAbnoVarices',		CASE WHEN (Select isnull(Quantity, 0) from ERS_UpperGIAbnoVarices where SiteId = @SiteId) = 1 then 'Varix' ELSE 'Varices' END ,			'Varices')
			,(@procType,	'ERS_CommonAbnoVascularLesions','Vascular lesions',	'Vascular Lesions')
			,(@procType,	'ERS_EUSAbnoMediastinal',		'Mediastinal',		'Mediastinal')
			,(@procType,	'ERS_UpperGITherapeutics',		'Therapeutic procedure(s)',	'Therapeutic Procedures')
			,(@procType,	'ERS_UpperGISpecimens',			'Specimens taken',	'Specimens Taken')
		END
		ELSE IF @procType IN (2,7) --ERCP / / EUS(HPB)
		BEGIN
			INSERT INTO #QueryDetails VALUES 
			(@procType,		'ERS_ERCPAbnoAppearance',		'Appearance',		'Appearance')
			,(@procType,	'ERS_CommonAbnoAtrophic',		'Atrophic duodenum','Atrophic Duodenum')
			,(@procType,	'ERS_CommonAbnoDiverticulum',	'Diverticulum',		'Diverticulum/Other')
			,(@procType,	'ERS_ERCPAbnoDiverticulum',		'Diverticulum',		CASE WHEN @region IN ('Major Papilla', 'Minor Papilla') THEN 'Diverticulum' ELSE 'Diverticulum/Other' END)
			,(@procType,	'ERS_ERCPAbnoDuct',				'Duct',				CASE WHEN @region = 'Gall Bladder' THEN 'Gall Bladder' ELSE 'Duct' END)
			,(@procType,	'ERS_CommonAbnoDuodenalUlcer',	'',					CASE WHEN @region = 'Jejunum' THEN 'Jejunal Ulcer' WHEN @region = 'Ileum' THEN 'Ileal Ulcer' ELSE 'Duodenal Ulcer' END)
			,(@procType,	'ERS_CommonAbnoDuodenitis',		'',					CASE WHEN @region = 'Jejunum' THEN 'Jejunitis' WHEN @region = 'Ileum' THEN 'Ileitis' ELSE 'Duodenitis' END)
			,(@procType,	'ERS_ERCPAbnoParenchyma',		'Parenchyma',		'Parenchyma')
			,(@procType,	'ERS_CommonAbnoScaring',		'',					'Scarring/Stenosis')
			,(@procType,	'ERS_UpperGIAbnoMiscellaneous',	'',					'Miscellaneous')
			,(@procType,	'ERS_CommonAbnoTumour',			'',					'Tumour')
			,(@procType,	'ERS_ERCPAbnoTumour',			'Tumour',			'Tumour')
			,(@procType,	'ERS_ERCPAbnoIntrahepatic',		'Intrahepatic',		'Intrahepatic')
			,(@procType,	'ERS_CommonAbnoVascularLesions','Vascular lesions',	'Vascular Lesions')
			,(@procType,	'ERS_EUSAbnoMediastinal',		'Mediastinal',		'Mediastinal')
			,(@procType,	'ERS_CommonAbnoLesions',		'Lesions',			'Lesions')
			,(@procType,	'ERS_UpperGIAbnoVarices',		CASE WHEN (Select isnull(Quantity, 0) from ERS_UpperGIAbnoVarices where SiteId = @SiteId) = 1 then 'Varix' ELSE 'Varices' END ,			'Varices')
			,(@procType,	'ERS_ERCPTherapeutics',			'Therapeutic procedure(s)',	'Therapeutic Procedures')
			,(@procType,	'ERS_UpperGISpecimens',			'Specimens taken',	'Specimens Taken')
		END
		ELSE IF @procType IN (3,4,5) --Colon/Sigmo/Procto
		BEGIN
			INSERT INTO #QueryDetails VALUES
			(@procType,		'ERS_ColonAbnoCalibre',			'Calibre',			'Calibre')
			,(@procType,	'ERS_ColonAbnoDiverticulum',	'Diverticulum',		'Diverticulum')
			,(@procType,	'ERS_ColonAbnoHaemorrhage',		'Haemorrhage',		'Haemorrhage')
			,(@procType,	'ERS_CommonAbnoLesions',			'Lesions',			'Lesions')
			,(@procType,	'ERS_ColonAbnoTumour',			'Tumour',			'Tumour')
			,(@procType,	'ERS_ColonAbnoMiscellaneous',	'',					'Miscellaneous')
			,(@procType,	'ERS_ColonAbnoMucosa',			'Mucosa',			'Mucosa')
			,(@procType,	'ERS_ColonAbnoperianallesions',	'Perianal lesions',	'Perianal Lesions')
			,(@procType,	'ERS_ColonAbnoVascularity',		'Vascularity',		'Vascularity')
			,(@procType,	'ERS_UpperGIAbnoVarices',		CASE WHEN (Select isnull(Quantity, 0) from ERS_UpperGIAbnoVarices where SiteId = @SiteId) = 1 then 'Varix' ELSE 'Varices' END ,			'Varices')
			,(@procType,	'ERS_UpperGITherapeutics',		'Therapeutic procedure(s)',	'Therapeutic Procedures')
			,(@procType,	'ERS_UpperGISpecimens',			'Specimens taken',	'Specimens Taken')
		END
		ELSE IF @procType IN (8) --Antegrade
		BEGIN
			INSERT INTO #QueryDetails VALUES 
			(@procType,		'ERS_UpperGIAbnoAchalasia',		'Achalasia',		'Achalasia')
			,(@procType,	'ERS_UpperGIAbnoBarrett',		'',					'Barretts Epithelium')
			,(@procType,	'ERS_UpperGIAbnoDeformity',		'Deformity',		'Deformity')
			,(@procType,	'ERS_CommonAbnoAtrophic',		'Atrophic duodenum','Atrophic Duodenum')
			,(@procType,	'ERS_CommonAbnoDiverticulum',	'Diverticulum',		'Diverticulum/Other')
			,(@procType,	'ERS_ColonAbnoDiverticulum',	'Diverticulum',		'Diverticulum')
			,(@procType,	'ERS_CommonAbnoDuodenalUlcer',	'',					CASE WHEN @region = 'Jejunum' THEN 'Jejunal Ulcer' WHEN @region = 'Ileum' THEN 'Ileal Ulcer' ELSE 'Duodenal Ulcer' END)
			,(@procType,	'ERS_CommonAbnoDuodenitis',		'',					CASE WHEN @region = 'Jejunum' THEN 'Jejunitis' WHEN @region = 'Ileum' THEN 'Ileitis' ELSE 'Duodenitis' END)
			,(@procType,	'ERS_ColonAbnoLesions',			'Lesions',			'Lesions')
			,(@procType,	'ERS_CommonAbnoScaring',		'',					'Scarring/Stenosis')
			,(@procType,	'ERS_CommonAbnoTumour',			'',					'Tumour')
			,(@procType,	'ERS_CommonAbnoVascularLesions','Vascular lesions',	'Vascular Lesions')
			,(@procType,	'ERS_UpperGIAbnoGastricUlcer',	'Gastric ulcer',	'Gastric Ulcer')
			,(@procType,	'ERS_UpperGIAbnoGastritis',		'Gastritis',		'Gastritis')
			,(@procType,	'ERS_UpperGIAbnoHiatusHernia',	'Hiatus hernia',	'Hiatus Hernia')
			,(@procType,	'ERS_UpperGIAbnoLumen',			'Lumen',			'Lumen')
			,(@procType,	'ERS_UpperGIAbnoMalignancy',	'Malignancy',		'Malignancy')
			,(@procType,	'ERS_UpperGIAbnoMiscellaneous',	'',					'Miscellaneous')
			,(@procType,	'ERS_UpperGIAbnoOesophagitis',	'Oesophagitis',		'Oesophagitis')
			,(@procType,	'ERS_UpperGIAbnoPostSurgery',	'Post surgery',		'Post Surgery')
			,(@procType,	'ERS_CommonAbnoLesions',		'Lesions',			'Lesions')
			,(@procType,	'ERS_UpperGIAbnoVarices',		CASE WHEN (Select isnull(Quantity, 0) from ERS_UpperGIAbnoVarices where SiteId = @SiteId) = 1 then 'Varix' ELSE 'Varices' END ,			'Varices')
			,(@procType,	'ERS_UpperGITherapeutics',		'Therapeutic procedure(s)',	'Therapeutic Procedures')
			,(@procType,	'ERS_UpperGISpecimens',			'Specimens taken',	'Specimens Taken')
		END
		ELSE IF @procType IN (9) --Retrograde
		BEGIN
			INSERT INTO #QueryDetails VALUES
			(@procType,		'ERS_ColonAbnoCalibre',			'Calibre',			'Calibre')
			,(@procType,	'ERS_ColonAbnoDiverticulum',	'Diverticulum',		'Diverticulum')
			,(@procType,	'ERS_ColonAbnoHaemorrhage',		'Haemorrhage',		'Haemorrhage')
			,(@procType,	'ERS_CommonAbnoLesions',			'Lesions',			'Lesions')
			,(@procType,	'ERS_ColonAbnoTumour',			'Tumour',			'Tumour')
			,(@procType,	'ERS_ColonAbnoMiscellaneous',	'',					'Miscellaneous')
			,(@procType,	'ERS_ColonAbnoMucosa',			'Mucosa',			'Mucosa')
			,(@procType,	'ERS_ColonAbnoperianallesions',	'Perianal lesions',	'Perianal Lesions')
			,(@procType,	'ERS_ColonAbnoVascularity',		'Vascularity',		'Vascularity')
			,(@procType,	'ERS_CommonAbnoDuodenalUlcer',	'',					CASE WHEN @region = 'Jejunum' THEN 'Jejunal Ulcer' WHEN @region = 'Ileum' THEN 'Ileal Ulcer' ELSE 'Duodenal Ulcer' END)
			,(@procType,	'ERS_CommonAbnoDuodenitis',		'',					CASE WHEN @region = 'Jejunum' THEN 'Jejunitis' WHEN @region = 'Ileum' THEN 'Ileitis' ELSE 'Duodenitis' END)
			,(@procType,	'ERS_CommonAbnoScaring',		'',					'Scarring/Stenosis')
			,(@procType,	'ERS_UpperGIAbnoVarices',		CASE WHEN (Select isnull(Quantity, 0) from ERS_UpperGIAbnoVarices where SiteId = @SiteId) = 1 then 'Varix' ELSE 'Varices' END ,			'Varices')
			,(@procType,	'ERS_UpperGITherapeutics',			'Therapeutic procedure(s)',	'Therapeutic Procedures')
			,(@procType,	'ERS_UpperGISpecimens',			'Specimens taken',	'Specimens Taken')
		END
		ELSE IF @procType IN (13) --Cystoscopy
		BEGIN
			INSERT INTO #QueryDetails VALUES
			(@procType,		'ERS_CystoscopyAbnoBladder',	'Bladder',			'Bladder')
			,(@procType,	'ERS_CystoscopyAbnoProstate',	'Prostate',		    'Prostate')
			,(@procType,	'ERS_CystoscopyAbnoUrethra',	'Urethra',		    'Urethra')
			,(@procType,	'ERS_CystoscopyTherapeutics',	'Therapeutic procedure(s)',	'Therapeutic Procedures')
			,(@procType,	'ERS_CystoscopySpecimens',		'Specimens taken',	'Specimens Taken')
		END
		ELSE IF @procType IN (10,12) --Bronchoscopy, Thoracoscopy
		BEGIN
			INSERT INTO #QueryDetails
			VALUES (
				@procType
				,'ERS_BRTSpecimens'
				,'Specimens taken'
				,'Specimens Taken'
				),
				(
				@procType
				,'ERS_UpperGITherapeutics'
				,'Therapeutic procedure(s)'
				,'Therapeutic Procedures'
				),
				(
				@procType
				,'ERS_BRTAbnoDescriptions'
				,'<strong>Abnormalities</strong>'			
				,''
				)

		END	
		ELSE IF @procType IN (
				11
				) --EBUS			
				BEGIN
					INSERT INTO #QueryDetails
					VALUES (
						@procType
						,'ERS_BRTSpecimens'
						,'Specimens taken'
						,'Specimens Taken'
						),
						(
						@procType
						,'ERS_UpperGITherapeutics'
						,'Therapeutic procedure(s)'
						,'Therapeutic Procedures'
						)
			
					IF @IsLymphNode = 'True'
					BEGIN
						INSERT INTO #QueryDetails
						VALUES 
							(
							@procType
							,'ERS_EBUSAbnoDescriptions'
							,'<strong>Abnormalities</strong>'
							,'EBUS Abnormality Descriptions'
							)
					END
					ELSE
					BEGIN
						INSERT INTO #QueryDetails
						VALUES 
							(
							@procType
							,'ERS_BRTAbnoDescriptions'
							,'<strong>Abnormalities</strong>'
							,''
							)
					END
				END


		DECLARE qry_cursor CURSOR FOR 
		SELECT ProcType, TableName, AbnoNodeName, Identifier FROM #QueryDetails

		OPEN qry_cursor 
		FETCH NEXT FROM qry_cursor INTO @ProcType, @TableName, @AbnoNodeName, @Identifier

		WHILE @@FETCH_STATUS = 0
		BEGIN
			SET @summaryWhole = ''
			SET @none = NULL
			SET @opDiv = '''<table><tr><td style="padding-left:25px;padding-right:50px; font-size:12px;"><span>'' + ' 
			SET @clDiv = ' + ''</span></td></tr></table>'''
			SET @indent = '&nbsp;- ';		SET @br = '<br />'
			SET @opBold = '<b>';			SET @clBold = '</b>'
			SET @fullStop = '.';			SET @colon = ': '
			SET @fldNone = 'None';			SET @emptyStr = ''
		
			IF @TableName = 'ERS_UpperGIAbnoLumen' SET @fldNone = 'NoBlood'
			ELSE IF @TableName = 'ERS_ERCPAbnoIntrahepatic' SET @fldNone = 'NormalIntraheptic'
			ELSE IF @TableName IN ('ERS_ERCPAbnoDuct', 'ERS_ERCPAbnoParenchyma', 'ERS_ERCPAbnoAppearance', 'ERS_ERCPAbnoDiverticulum','ERS_CystoscopyAbnoBladder','ERS_CystoscopyAbnoProstate','ERS_CystoscopyAbnoUrethra','ERS_EBUSAbnoDescriptions') SET @fldNone = 'Normal'
			ELSE SET @fldNone = 'None'
			--Get Summary from respective table
			IF @TableName = 'ERS_Sites'
				BEGIN
					SET @SQLString = 'SELECT @summaryWhole = AdditionalNotes FROM ' + @TableName + '  
								WHERE SiteId =  ' + CONVERT(VARCHAR,@SiteId) + ' AND ISNULL(AdditionalNotes,'''') <> '''' '
					SET @fullStop = @emptyStr
				END
			ELSE
				BEGIN
					SET @SQLString = 'SELECT @summaryWhole = Summary, @none = [' + @fldNone + '] FROM ' + @TableName + '  
								WHERE SiteId =  ' + CONVERT(VARCHAR,@SiteId) + ' AND ISNULL(Summary,'''') <> '''' '
				END
			EXECUTE sp_executesql @SQLString, N'@summaryWhole VARCHAR(MAX) OUTPUT, @none TINYINT OUTPUT', @summaryWhole OUTPUT, @none OUTPUT

			IF @Identifier = 'Therapeutic Procedures' 
			BEGIN
				IF ISNULL(@none,0) = 0 AND LEN(@summaryWhole) > 0
				BEGIN
					SET @fullStop = @emptyStr
					SET @abnoTheraPresent = 1
			END
			ELSE 
			BEGIN
					SET @opDiv = @emptyStr;		SET @clDiv = @emptyStr
					SET @opBold = @emptyStr;	SET @clBold = @emptyStr
			END
			END
			ELSE 
			BEGIN
				IF @Identifier = 'Specimens Taken' 
				BEGIN
					--IF therapeutics present, remove line before specimens
					IF @abnoTheraPresent = 1 SET @br = @emptyStr
				END
				ELSE 
				BEGIN
					SET @opBold = @emptyStr;	SET @clBold = @emptyStr
				END
				SET @opDiv = @emptyStr ;		SET @clDiv = @emptyStr
			END

			IF ISNULL(@summaryWhole,'') <> ''
			BEGIN
				SET @summaryWhole = REPLACE(@summaryWhole,'''','''''')

				--If None is clicked, prefix not required (e.g "Oesophagitis : No Oesophagitis." should be "No Oesophagitis.")
				--Prefix (@AbnoNodeName) is required for Lumen even if None (Blood free) is selected
				IF (ISNULL(@none,0) = 1 OR @AbnoNodeName = '') AND @TableName <> 'ERS_UpperGIAbnoLumen'
				BEGIN	
					SET @AbnoNodeName = '';		SET @colon = ''
				END
				ELSE
				BEGIN
					SET @colon = ': '
				END
		
				SET @tmpSummaryAbno = ' CASE WHEN ''' + @summaryWhole + ''' IN ('''', ''' + @AbnoNodeName + ''') THEN ''' +  @indent + @AbnoNodeName + '' + @fullStop + '''' +
										' ELSE  ''' + @indent + @opBold + @AbnoNodeName + @clBold + @colon + ''' + ' + @opDiv + '''' + @summaryWhole + @fullStop + '''' + @clDiv +
									' END'

				SET @tmpSummaryAbnoLinks = 'CASE WHEN ''' + @summaryWhole + ''' IN ('''', ''' + @AbnoNodeName + ''') THEN ''' +  @indent + @AbnoNodeName + ''' + REPLACE(REPLACE(''' + @htmlAnchorCode + ''',''{0}'',''' + @Identifier + '''),''{1}'',''' + @AbnoNodeName + ''') + ''' + @fullStop + '''' +
											' ELSE  ''' +  @indent + @opBold + @AbnoNodeName + @clBold + @colon + ''' + REPLACE(REPLACE(''' + @htmlAnchorCode + ''',''{0}'',''' + @Identifier + '''),''{1}'',' +  @opDiv + '''' + @summaryWhole + @fullStop + '''' +	 @clDiv +')  ' +
										' END'

			SET @SQLString = 'SELECT ' +
								CASE WHEN @Identifier = 'Specimens Taken'			THEN '@summarySpecimens = @summarySpecimens '
									 WHEN @Identifier = 'Therapeutic Procedures'	THEN '@summaryTherapeutics = @summaryTherapeutics '
									 ELSE '@summaryAbnormalities = @summaryAbnormalities ' END +
											' + ''' + @br  + ''' + '  + @tmpSummaryAbno + ', ' +

								CASE WHEN @Identifier = 'Specimens Taken'			THEN '@summarySpecimensWithHyperLinks = @summarySpecimensWithHyperLinks '
									 WHEN @Identifier = 'Therapeutic Procedures'	THEN '@summaryTherapeuticsWithHyperLinks = @summaryTherapeuticsWithHyperLinks '
									 ELSE '@summaryAbnormalitiesWithHyperLinks = @summaryAbnormalitiesWithHyperLinks ' END +
												' + ''' + @br  + ''' + '  + @tmpSummaryAbnoLinks 						
			--Perform abno check to determine normal procedure
			IF @none = 0  and @TableName <> 'ERS_UpperGISpecimens' AND @AbnormalProcedure <> 1  SET @AbnormalProcedure = 1

			IF @Identifier = 'Specimens Taken'
				EXECUTE sp_executesql @SQLString, N'@summarySpecimens VARCHAR(MAX) OUTPUT,@summarySpecimensWithHyperLinks VARCHAR(MAX) OUTPUT', 
							@summarySpecimens = @summarySpecimens OUTPUT, @summarySpecimensWithHyperLinks=@summarySpecimensWithHyperLinks OUTPUT
			ELSE IF @Identifier = 'Therapeutic Procedures'
				EXECUTE sp_executesql @SQLString, N'@summaryTherapeutics VARCHAR(MAX) OUTPUT,@summaryTherapeuticsWithHyperLinks VARCHAR(MAX) OUTPUT', 
							@summaryTherapeutics = @summaryTherapeutics OUTPUT, @summaryTherapeuticsWithHyperLinks=@summaryTherapeuticsWithHyperLinks OUTPUT
			ELSE
				EXECUTE sp_executesql @SQLString, N'@summaryAbnormalities VARCHAR(MAX) OUTPUT,@summaryAbnormalitiesWithHyperLinks VARCHAR(MAX) OUTPUT', 
							@summaryAbnormalities = @summaryAbnormalities OUTPUT, @summaryAbnormalitiesWithHyperLinks=@summaryAbnormalitiesWithHyperLinks OUTPUT
			END

			FETCH NEXT FROM qry_cursor INTO @ProcType, @TableName, @AbnoNodeName, @Identifier
		END

		CLOSE qry_cursor
		DEALLOCATE qry_cursor

		DROP TABLE #QueryDetails

		if exists(select 1 from ERS_CommonAbnoOther where SiteId = @SiteId)
		BEGIN
			SELECT @summaryAbnormalities = isnull(@summaryAbnormalities, '') + (SELECT STUFF((
																					SELECT ', ' + OA.Summary 
																					FROM ERS_OtherAbnormalities OA
																					JOIN ERS_CommonAbnoOther CAO ON OA.OtherId = CAO.OtherId
																					WHERE CAO.SiteId = @SiteId
																					FOR XML PATH('')), 1, 1, '') Code ),
				 @summaryAbnormalitiesWithHyperLinks = isnull(@summaryAbnormalitiesWithHyperLinks, '') + '<table><tr><td style="padding-right:50px;">- Other:' +
				 REPLACE(REPLACE(REPLACE(@htmlAnchorCode,'''{0}''','Other'),'{1}',
																					(SELECT STUFF((
																					SELECT ', ' + OA.Summary 
																					FROM ERS_OtherAbnormalities OA
																					JOIN ERS_CommonAbnoOther CAO ON OA.OtherId = CAO.OtherId
																					WHERE CAO.SiteId = @SiteId
																					FOR XML PATH('')), 1, 1, '') Code )), '''''', '''')
														+ '</td></tr></table>'
		END
		-- Update the current site's summary
		UPDATE ERS_Sites 
		SET	
			SiteSummary = @summaryAbnormalities,
			SiteSummarySpecimens = @summarySpecimens,
			SiteSummaryTherapeutics = @summaryTherapeutics,
			SiteSummaryWithLinks = @summaryAbnormalitiesWithHyperLinks,
			SiteSummarySpecimensWithLinks = @summarySpecimensWithHyperLinks,
			SiteSummaryTherapeuticsWithLinks = @summaryTherapeuticsWithHyperLinks,
			HasAbnormalities = @AbnormalProcedure
		WHERE 
			SiteId = @siteId

		-- Update the summary of the procedure (all the sites)
		EXEC procedure_summary_update @procId

	END TRY

	BEGIN CATCH
		DECLARE @ErrorMessage NVARCHAR(4000);
		DECLARE @ErrorSeverity INT;
		DECLARE @ErrorState INT;

		SELECT @ErrorMessage = ERROR_MESSAGE(),
			   @ErrorSeverity = ERROR_SEVERITY(),
			   @ErrorState = ERROR_STATE();
    
		RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

		IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
	END CATCH


	IF @@TRANCOUNT > 0 COMMIT TRANSACTION;
END
GO





IF NOT EXISTS (SELECT 1 FROM ERS_DiagnosesMatrix WHERE Code = 'DDESDSCARP2')
BEGIN
    INSERT INTO ERS_DiagnosesMatrix (DisplayName, NED_Name, ProcedureTypeID, Section, OrderByNumber, Code, NED_Include)
    VALUES ('Previous ESD Scar', 'Previous ESD Scar', 2, 'Duodenum', 0, 'DDESDSCARP2', 1),
           ('Previous ESD Scar', 'Previous ESD Scar', 7, 'Duodenum', 0, 'DDESDSCARP2', 1)
END
GO


	ALTER TRIGGER [dbo].[TR_CommonAbnoLesions]
	ON [dbo].[ERS_CommonAbnoLesions]
	AFTER INSERT, UPDATE, DELETE
	AS 
		DECLARE @site_id INT, @Polyp VARCHAR(10) = 'False', 
							  @BenignTumour VARCHAR(10) = 'False', 
							  @MalignantTumour VARCHAR(10) = 'False', 
							  @SubmucosalTumour VARCHAR(10) = 'False', 
							  @FocalLesions VARCHAR(10) = 'False',
							  @SubmucoaslLesion VARCHAR(10) = 'False',
							  @FundicGlandPolyp VARCHAR(10) = 'False',
							  @PreviousESDScar VARCHAR(10) = 'False',
				@PolypTypeId int, @Region varchar(20), @ProcedureTypeId int, @MatrixCode varchar(50)
	
		IF EXISTS(SELECT * FROM INSERTED)
		BEGIN
			SELECT @site_id=SiteId,
					@Polyp = (CASE WHEN (ISNULL(Polyp,0) = 1) THEN 'True' ELSE 'False' END),
					@FocalLesions = (CASE WHEN (ISNULL(Focal,0) = 1) THEN 'True' ELSE 'False' END),
					@SubmucoaslLesion = (CASE WHEN (ISNULL(Submucosal,0) = 1) THEN 'True' ELSE 'False' END),
					@FundicGlandPolyp = (CASE WHEN (ISNULL(FundicGlandPolyp,0) = 1) THEN 'True' ELSE 'False' END),
					@PolypTypeId = PolypTypeId,
					@PreviousESDScar = (CASE WHEN (ISNULL(PreviousESDScar,0) = 1) THEN 'True' ELSE 'False' END)
				
			FROM INSERTED

			SELECT TOP 1 @ProcedureTypeId =  p.ProcedureType FROM ERS_Sites s INNER JOIN ERS_Procedures p ON p.ProcedureId = s.ProcedureId WHERE s.SiteId = @site_id
			--check if polyps = 1
			IF @Polyp = 'True' 
			BEGIN
				--check for polyp type
				DECLARE @PolypType VARCHAR(200) = (SELECT Description FROM ERS_PolypTypes WHERE UniqueId = @PolypTypeId)

				IF LOWER(@PolypType) = 'sessile'
				BEGIN
					--sessile polyps to produce a gastric tumour outcome depending on the tumour type
					IF EXISTS (SELECT 1 FROM ERS_CommonAbnoPolypDetails WHERE SiteId = @site_id AND Type = (SELECT UniqueId FROM ERS_TumourTypes WHERE Description = 'benign'))
						SET @BenignTumour = 'True'
					ELSE 
						SET @BenignTumour = 'False'

					IF EXISTS (SELECT 1 FROM ERS_CommonAbnoPolypDetails WHERE SiteId = @site_id AND Type = (SELECT UniqueId FROM ERS_TumourTypes WHERE Description = 'malignant'))
						SET @MalignantTumour = 'True'
					ELSE
						SET @MalignantTumour = 'False'
				END
			
				IF LOWER(@PolypType) = 'submucosal'  AND LOWER(@Region) = 'stomach'
					SET @SubmucoaslLesion = 'True'
				ELSE
					SET @SubmucoaslLesion = 'False'

			END
		
			IF @ProcedureTypeId IN (1,6,8)
			BEGIN
				SELECT @Region = dbo.fnSiteRegion(@site_id)

				IF LOWER(@Region) = 'stomach'
				BEGIN
					--SELECT @Polyp = CASE WHEN @FundicGlandPolyp = 'False' AND @BenignTumour = 'False' AND @MalignantTumour = 'False' AND @SubmucosalTumour = 'False' THEN 'True' ELSE 'False' END
					SET @MatrixCode = 'D40P1'
				END
				ELSE IF LOWER(@Region) = 'oesophagus'
					SET @MatrixCode = 'N2013'
				ELSE IF LOWER(@Region) = 'duodenum'
					SET @MatrixCode = 'D58P1'
				ELSE IF LOWER(@Region) = 'colon'
					SET @MatrixCode = 'D58P1'
				
			END
			ELSE IF @ProcedureTypeId IN (3,4,9)
			BEGIN
				SELECT @Region = dbo.fnSiteRegion(@site_id)

				IF @Polyp = 'True' AND @Region IN ('Rectum', 'Anal Margin')
					SET @MatrixCode = 'D4P3'

				IF @Polyp = 'True' AND @Region NOT IN ('Rectum', 'Anal Margin', 'Terminal Ileum')
					SET @MatrixCode = 'D12P3'

				IF @Polyp = 'True' AND @Region IN ('Terminal Ileum', 'Neo-Terminal Ileum')
					SET @MatrixCode = 'DIPOLYPP3'
			END

		END
		ELSE
		BEGIN
			SELECT @site_id=SiteId FROM DELETED
		END

		EXEC abnormalities_common_lesions_summary_update @site_id

		IF @site_id IS NOT NULL AND @ProcedureTypeId IN (1,3,4,6,8,9,2,7)
		BEGIN
			EXEC sites_summary_update @site_id

			EXEC diagnoses_control_save @site_id, @MatrixCode, @Polyp		
			--EXEC diagnoses_control_save @site_id, 'D86P1', @BenignTumour	
			--EXEC diagnoses_control_save @site_id, 'D87P1', @MalignantTumour	
			EXEC diagnoses_control_save @site_id, 'N2001', @FocalLesions
			EXEC diagnoses_control_save @site_id, 'D88P1', @SubmucosalTumour
			EXEC diagnoses_control_save @site_id, 'N2002', @SubmucoaslLesion
			EXEC diagnoses_control_save @site_id, 'N2019', @FundicGlandPolyp

			IF @ProcedureTypeId IN (1,6,8)
			BEGIN
			    EXEC diagnoses_control_save @site_id, 'DSESDSCARP1', @PreviousESDScar		
			END
			ELSE IF @ProcedureTypeId IN (2,7)
			BEGIN
				EXEC diagnoses_control_save @site_id, 'DDESDSCARP2', @PreviousESDScar
			END
			ELSE IF @ProcedureTypeId IN (3,9)
			BEGIN
				EXEC diagnoses_control_save @site_id, 'DESDSCARP3', @PreviousESDScar
			END
			ELSE IF @ProcedureTypeId = 4
			BEGIN
				EXEC diagnoses_control_save @site_id, 'SDESDSCARP3', @PreviousESDScar
			END
		END
GO


/****** Object:  Trigger [dbo].[TR_UpperGIAbnoVarices]    Script Date: 18/01/2024 08:38:17 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


ALTER TRIGGER [dbo].[TR_UpperGIAbnoVarices]
ON [dbo].[ERS_UpperGIAbnoVarices]
AFTER INSERT, UPDATE, DELETE 
AS 
	DECLARE @site_id INT, 
			@Action CHAR(1) = 'I', 
			@Area varchar(20),
			@DuodenealVarices VARCHAR(10) = 'False', 
			@ColonVarices VARCHAR(10) = 'False', 
			@Varices VARCHAR(10) = 'False', 
			@VaricesBleeding VARCHAR(10) = 'False', 
			@StomachVarices VARCHAR(10) = 'False',
			@StomachVaricesBleeding VARCHAR(10) = 'False',
			@Varix VARCHAR(10) = 'False', 
			@VarixBleeding VARCHAR(10) = 'False', 
			@StomachVarix VARCHAR(10) = 'False',
			@StomachVarixBleeding VARCHAR(10) = 'False'

	IF EXISTS(SELECT * FROM DELETED) SET @Action = CASE WHEN EXISTS(SELECT * FROM INSERTED) THEN 'U' ELSE 'D' END

	IF @Action IN ('I', 'U') 
	BEGIN
		SELECT @site_id=SiteId FROM inserted
		DECLARE @ProcedureTypeId INT = (SELECT ProcedureType FROM ERS_Procedures p INNER JOIN dbo.ERS_Sites s ON s.ProcedureId = p.ProcedureId WHERE s.SiteId = @site_id)


		IF @ProcedureTypeId IN (3,4,9)
		BEGIN
			SELECT @ColonVarices = (CASE WHEN Grading > 0 THEN 'True' ELSE 'False' END)
				FROM INSERTED
		END
		ELSE IF @ProcedureTypeId IN (2,7)
		BEGIN
			SELECT @DuodenealVarices = (CASE WHEN Grading > 0 THEN 'True' ELSE 'False' END)
				FROM INSERTED
		END
		BEGIN
			Select @Area = dbo.fnSiteRegion(@site_id)
		
			IF @Area = 'Stomach'
			BEGIN
				SELECT  @StomachVarices = (CASE WHEN Grading > 0 AND ISNULL(Bleeding,0) <= 1 AND ISNULL(Quantity, 0) != 1 THEN 'True' ELSE 'False' END),
						@StomachVaricesBleeding = (CASE WHEN Grading > 0 AND Bleeding > 1 AND ISNULL(Quantity, 0) != 1 THEN 'True' ELSE 'False' END),
						@StomachVarix = (CASE WHEN Grading > 0 AND ISNULL(Bleeding,0) <= 1 AND ISNULL(Quantity, 0) = 1 THEN 'True' ELSE 'False' END),
						@StomachVarixBleeding = (CASE WHEN Grading > 0 AND Bleeding > 1 AND ISNULL(Quantity, 0) = 1 THEN 'True' ELSE 'False' END)
				FROM INSERTED
			END
			IF @Area = 'Oesophagus' 
			BEGIN
				SELECT  @Varices = (CASE WHEN Grading > 0 AND ISNULL(Bleeding,0) <= 1 AND ISNULL(Quantity, 0) != 1 THEN 'True' ELSE 'False' END),
						@VaricesBleeding = (CASE WHEN Grading > 0 AND Bleeding > 1 AND ISNULL(Quantity, 0) != 1 THEN 'True' ELSE 'False' END),
						@Varix = (CASE WHEN Grading > 0 AND ISNULL(Bleeding,0) <= 1 AND ISNULL(Quantity, 0) = 1 THEN 'True' ELSE 'False' END),
						@VarixBleeding = (CASE WHEN Grading > 0 AND Bleeding > 1 AND ISNULL(Quantity, 0) = 1 THEN 'True' ELSE 'False' END)
				FROM INSERTED
			END
			IF @Area = 'Duodenum' 
			BEGIN
				SELECT  @DuodenealVarices = (CASE WHEN Grading > 0 THEN 'True' ELSE 'False' END)
				FROM INSERTED
			END
		END
		EXEC abnormalities_varices_summary_update @site_id
	END

	IF @Action = 'D'
	BEGIN
		SELECT @site_id=SiteId FROM DELETED
	END

	EXEC sites_summary_update @site_id

	EXEC diagnoses_control_save @site_id, 'D30P1', @Varices				-- 'Varices'
	EXEC diagnoses_control_save @site_id, 'D31P1', @VaricesBleeding		-- 'VaricesBleeding'
	EXEC diagnoses_control_save @site_id, 'D47P1', @StomachVarices		-- 'StomachVarices'
	EXEC diagnoses_control_save @site_id, 'D110P1', @StomachVaricesBleeding		-- 'StomachVaricesBleeding'
	EXEC diagnoses_control_save @site_id, 'D115P1', @Varix				-- 'Varices'
	EXEC diagnoses_control_save @site_id, 'D116P1', @VarixBleeding		-- 'VaricesBleeding'
	EXEC diagnoses_control_save @site_id, 'D117P1', @StomachVarix		-- 'StomachVarices'
	EXEC diagnoses_control_save @site_id, 'D118P1', @StomachVarixBleeding		-- 'StomachVaricesBleeding'

	
	IF @ProcedureTypeId IN (3,4,9)--colon/lowers
		BEGIN
			EXEC diagnoses_control_save @site_id, 'DVARICESP3', @ColonVarices		-- 'DuodenealVarices - colon/flexi'
		END
	ELSE IF @ProcedureTypeId IN (2,7) --ercp
	BEGIN
		EXEC diagnoses_control_save @site_id, 'DVARICESP2', @DuodenealVarices		-- 'DuodenealVarices - ercp/hpb'

	END
	ELSE
	BEGIN
		EXEC diagnoses_control_save @site_id, 'DVARICESP1', @DuodenealVarices		-- 'DuodenealVarices - ogd/eus/ant'
	END
GO

SET QUOTED_IDENTIFIER ON
SET ANSI_NULLS ON
GO
ALTER PROCEDURE [dbo].[diagnoses_control_save]
(
       @SiteID int, 
       @DiagnosesMatrixCode varchar(50),
	   @Value varchar(50)
)
AS

SET NOCOUNT ON

BEGIN TRANSACTION

BEGIN TRY
	DECLARE @DiagCount int, @ProcedureID int,  @Region varchar(50), @ProcedureType int, @MatrixSection varchar(50),
		@SiteNo int, @XCoordinate int

	SELECT @ProcedureID =p.ProcedureID, @ProcedureType = p.ProcedureType, @SiteNo = SiteNo, @XCoordinate=XCoordinate
	FROM ers_sites s INNER JOIN ers_procedures p ON s.ProcedureId = p.ProcedureId 
	WHERE SiteId = @SiteID

	--Change the @DiagnosesMatrixCode if procedure type is 2 (ERCP) for Duodenum
	IF @ProcedureType in (2, 7) AND RIGHT(@DiagnosesMatrixCode,2) <> 'P2'
	BEGIN 
		SET @DiagnosesMatrixCode = STUFF(@DiagnosesMatrixCode, LEN(@DiagnosesMatrixCode) - 1, 2, 'P2')
	END
	
	IF @ProcedureType IN (3,4,5,9)   ---------- Colonoscopy, Sigmoidscopy, Proctoscopy ----------------------
	BEGIN
		IF @ProcedureType = 9
		BEGIN
			SET @Region=(select x.Region from [dbo].[ERS_AbnormalitiesMatrixRetrograde] x inner join ERS_Regions r on x.region = r.Region AND r.ProcedureType= x.ProcedureType inner join ers_sites s on r.RegionId = s.RegionId where s.SiteId = @siteID )
		END
		ELSE
		BEGIN
		    SET @Region=(select x.Region from [ERS_AbnormalitiesMatrixColon] x inner join ERS_Regions r on x.region = r.Region AND r.ProcedureType= x.ProcedureType inner join ers_sites s on r.RegionId = s.RegionId where s.SiteId = @siteID )
		END

		SET @MatrixSection= 'Colon'

		--ColonicPolyp (D12P3) should not be in region 'Rectum'
		--RectalPolyp (D4P3) should be in region 'Rectum'
		IF @DiagnosesMatrixCode IN ('D12P3') AND @Region in ('Rectum', 'Anal Margin')		SET @ProcedureID = NULL
		ELSE IF @DiagnosesMatrixCode IN ('D4P3') AND @Region not in ('Rectum', 'Anal Margin')		SET @ProcedureID = NULL
		ELSE IF @DiagnosesMatrixCode = 'D8P3' AND @Region in ('Rectum', 'Anal Margin')	SET @DiagnosesMatrixCode = 'D13P3' -- D8P3 for 'Malignant colonic tumour', D13P3 for Malignant rectal tumour
		ELSE IF @DiagnosesMatrixCode IN ('D6P3') 
			BEGIN
				IF @SiteNo = -77	AND @XCoordinate >= 17		SET @DiagnosesMatrixCode = 'D11P3' -- D6P3 for 'Benign colonic tumour', D11P3 for Benign rectal tumour
				ELSE IF @SiteNo > 0 AND @Region in ('Rectum', 'Anal Margin')		SET @DiagnosesMatrixCode = 'D11P3' -- D6P3 for 'Benign colonic tumour', D11P3 for Benign rectal tumour
			END
		ELSE IF @DiagnosesMatrixCode IN ('D15P3') 
			BEGIN
				IF @SiteNo = -77	AND @XCoordinate >= 17		SET @ProcedureID = NULL -- By distance, "Redundant anterior rectal mucosa" should be in region 'Rectum' and rectal is if the site is < 17 cm
				ELSE IF @SiteNo > 0 AND @Region not in ('Rectum', 'Anal Margin')		SET @ProcedureID = NULL -- Redundant anterior rectal mucosa (D15P3) should be in region 'Rectum'
			END
		ELSE IF @DiagnosesMatrixCode IN ('D80P3') 
			BEGIN
				IF @SiteNo = -77	AND @XCoordinate >= 17		SET @DiagnosesMatrixCode = 'D83P3' -- By distance, D80P3 for 'Rectal ulcer(s)', D83P3 for 'Colonic ulcer(s)'
				ELSE IF @SiteNo > 0 AND @Region = 'Terminal Ileum'	SET @DiagnosesMatrixCode = 'D100P3'   --D80P3 for 'Rectal ulcer(s)', D83P3 for 'Colonic ulcer(s)'
				ELSE IF @SiteNo > 0 AND @Region not in ('Rectum', 'Anal Margin')	SET @DiagnosesMatrixCode = 'D83P3'   --D80P3 for 'Rectal ulcer(s)', D83P3 for 'Colonic ulcer(s)'
			END	
		IF @ProcedureType = 4 AND LEFT(@DiagnosesMatrixCode,1) <> 'S'
		BEGIN
			SET @DiagnosesMatrixCode = STUFF(@DiagnosesMatrixCode, 1, 1, 'S')
		END
	END
	ELSE IF @ProcedureType IN (1, 6, 8)	--------------- Gastroscopy, EUS (OGD) ------------------------
	BEGIN
		SET @Region = (
			SELECT x.area
			FROM ERS_AbnormalitiesMatrixUpperGI x
			INNER JOIN ERS_Regions r ON x.region = r.Region AND x.ProcedureType = r.ProcedureType AND x.ProcedureType =  @ProcedureType
			INNER JOIN ers_sites s ON r.RegionId = s.RegionId AND SiteId = @siteid  
		)
		--SET @Region = (select x.area from ERS_AbnormalitiesMatrixUpperGI x inner join ERS_Regions r on x.region = r.Region inner join ers_sites s on r.RegionId = s.RegionId where SiteId =@siteid)
		IF @DiagnosesMatrixCode = 'D20P1' AND @Region <> 'Oesophagus'	SET @DiagnosesMatrixCode = 'D61P1'
		SET @MatrixSection= ISNULL((SELECT top(1)  Section FROM [ERS_DiagnosesMatrix] WHERE ProcedureTypeID = @ProcedureType AND Code=@DiagnosesMatrixCode),@Region)

		--Varices (D30P1) should be in region 'Oesophagus'
		--StomachVarices (D47P1) should be in region 'Stomach'
		--TelangiectasiaAngioma (D59P1) should be in region 'Duodenum'
		IF @DiagnosesMatrixCode = 'D30P1' AND @Region <> 'Oesophagus'		SET @ProcedureID = NULL
		ELSE IF @DiagnosesMatrixCode = 'D31P1' AND @Region <> 'Oesophagus'	SET @ProcedureID = NULL
		ELSE IF @DiagnosesMatrixCode = 'D47P1' AND @Region <> 'Stomach'		SET @ProcedureID = NULL
		ELSE IF @DiagnosesMatrixCode = 'D59P1' AND @Region <> 'Duodenum'	SET @ProcedureID = NULL

		--Remove noraml procedure diagnoses entry where applicapble
		IF LOWER(@Value) IN ('true', '1')
		BEGIN
			IF EXISTS (SELECT 1 FROM ERS_Diagnoses WHERE ProcedureId = @ProcedureID AND MatrixCode = 'OverallNormal')
				DELETE FROM ERS_Diagnoses WHERE ProcedureId = @ProcedureID AND MatrixCode = 'OverallNormal'
		END			

	END
	ELSE IF @ProcedureType IN (2, 7)	------------ ERCP, EUS(HPB) --------------------------
	BEGIN
		SET @Region = (
			SELECT x.area
			FROM ERS_AbnormalitiesMatrixERCP x
			INNER JOIN ERS_Regions r ON x.region = r.Region AND x.ProcedureType = r.ProcedureType AND x.ProcedureType =  @ProcedureType
			INNER JOIN ers_sites s ON r.RegionId = s.RegionId AND SiteId = @siteid  
		)
		--SET @Region = (select x.area from ERS_AbnormalitiesMatrixERCP x inner join ERS_Regions r on x.region = r.Region inner join ers_sites s on r.RegionId = s.RegionId where SiteId =@siteid)
		SET @MatrixSection= ISNULL((SELECT top(1)  Section FROM [ERS_DiagnosesMatrix] WHERE ProcedureTypeID = @ProcedureType AND Code=@DiagnosesMatrixCode),@Region)
	END

	IF @ProcedureID IS NULL GOTO RETURN_NULL

	--Check for correct Procedure Type
	IF CHARINDEX('notentered',LOWER(@DiagnosesMatrixCode)) = 0 
	AND NOT (EXISTS (SELECT 1 
					FROM ERS_DiagnosesMatrix 
					WHERE ProcedureTypeID = @ProcedureType 
					AND Code = @DiagnosesMatrixCode) OR @DiagnosesMatrixCode IN ('D999P0', 'S999P0'))
		GOTO RETURN_NULL

	--Set correct region for not entered codes
	IF CHARINDEX('notentered',LOWER(@DiagnosesMatrixCode)) > 0
	BEGIN
		SET @siteid = NULL
		SELECT @MatrixSection = 
		CASE LOWER(@DiagnosesMatrixCode)
			WHEN 'oesophagusnotentered' THEN 'Oesophagus'
			WHEN 'stomachnotentered' THEN 'Stomach'
			WHEN 'duodenumnotentered' THEN 'Duodenum'
		END
	END
	
	IF LOWER(@Value) NOT IN ('true', '1') SET @Value = 'False'


	IF @Value = 'False'
	BEGIN
		DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode= @DiagnosesMatrixCode AND (SiteId = @siteid OR ISNULL(@siteid,'') = '')
	END
	ELSE
	BEGIN
		UPDATE [ERS_Diagnoses] SET [Value] = @Value, Region = @MatrixSection 
		WHERE ProcedureID = @ProcedureID AND MatrixCode= @DiagnosesMatrixCode
		AND (SiteId = @siteid OR ISNULL(@siteid,'') = '')

		IF @@ROWCOUNT=0 
		BEGIN
			--No records found in ERS_Diagnoses when updating, go ahead and insert it
			INSERT INTO [ERS_Diagnoses] (ProcedureID, SiteID, MatrixCode, [Value], [Region]) 
			VALUES (@ProcedureID, @SiteID, @DiagnosesMatrixCode,@Value,@MatrixSection) 
		END
	END

	EXEC ogd_diagnoses_summary_update @ProcedureID

	RETURN_NULL:
END TRY

BEGIN CATCH
    DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

    IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH

IF @@TRANCOUNT > 0 COMMIT TRANSACTION;
GO


SET QUOTED_IDENTIFIER OFF
SET ANSI_NULLS OFF
GO
ALTER PROCEDURE [dbo].[sites_delete]
(
	@SiteId INT
)
AS

SET NOCOUNT ON

DECLARE @ProcedureId INT, @AreaNo INT, @SiteNo INT, @ProcedureType INT

-- AS (08/SEP/2021) - Adding IsLymphNode column to distinguish between EBUS and EBUS BRT subtype of EBUS.
DECLARE @IsLymphNode BIT

BEGIN TRANSACTION

BEGIN TRY
	SELECT @ProcedureId = s.ProcedureId, @AreaNo = s.AreaNo, @SiteNo = s.SiteNo, @ProcedureType = p.ProcedureType, @IsLymphNode = CASE WHEN s.IsLymphNode = 1 THEN 'True' ELSE 'False' END
	FROM ERS_Procedures p
	INNER JOIN ERS_Sites s ON p.ProcedureId = s.ProcedureId
	WHERE s.SiteId = @SiteId

	IF @ProcedureType IN (1, 6, 8) --Gastroscopy, EUS_OGD, ENT Ant
	BEGIN
		DELETE FROM ERS_UpperGIAbnoDeformity WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoAchalasia WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoGastricUlcer WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoGastritis WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoLumen WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoMalignancy WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoPolyps WHERE SiteId = @SiteId
		DELETE FROM ERS_CommonAbnoLesions WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoPostSurgery WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoVarices WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoHiatusHernia WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoOesophagitis WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoBarrett WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoMiscellaneous WHERE SiteId = @SiteId
		DELETE FROM ERS_EUSAbnoMediastinal WHERE SiteId = @SiteId
	END
	ELSE IF @ProcedureType IN (2, 7)   --ERCP, EUS_HPB
	BEGIN
		DELETE FROM ERS_ERCPAbnoDuct WHERE SiteId = @SiteId
		DELETE FROM ERS_ERCPAbnoParenchyma WHERE SiteId = @SiteId
		DELETE FROM ERS_ERCPAbnoAppearance WHERE SiteId = @SiteId
		DELETE FROM ERS_ERCPAbnoDiverticulum WHERE SiteId = @SiteId
		DELETE FROM ERS_ERCPAbnoTumour WHERE SiteId = @SiteId
		DELETE FROM ERS_ERCPAbnoIntrahepatic WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoVarices WHERE SiteId = @SiteId
		IF EXISTS (SELECT TOP 1 Id FROM ERS_ERCPTherapeutics WHERE SiteId = @SiteId)
		BEGIN
			DECLARE @TherapeuticId INT
			SET @TherapeuticId = (SELECT TOP 1 Id FROM ERS_ERCPTherapeutics WHERE SiteId = @SiteId)
			DELETE FROM ERS_ERCPTherapeuticStentInsertions WHERE TherapeuticId = @TherapeuticId
			DELETE FROM ERS_ERCPTherapeutics WHERE SiteId = @SiteId
		END
		DELETE FROM ERS_EUSAbnoMediastinal WHERE SiteId = @SiteId
	END
	ELSE IF @ProcedureType IN (3,4,5,9)   --Colonoscopy, Sigmoidscopy, Proctoscopy, ENT Retro
	BEGIN
		DELETE FROM ERS_ColonAbnoMucosa WHERE SiteId = @SiteId
		DELETE FROM ERS_ColonAbnoVascularity WHERE SiteId = @SiteId
		DELETE FROM ERS_CommonAbnoLesions WHERE SiteId = @SiteId
		DELETE FROM ERS_ColonAbnoDiverticulum WHERE SiteId = @SiteId
		DELETE FROM ERS_ColonAbnoHaemorrhage WHERE SiteId = @SiteId
		DELETE FROM ERS_ColonAbnoPerianalLesions WHERE SiteId = @SiteId
		DELETE FROM ERS_ColonAbnoCalibre WHERE SiteId = @SiteId
		DELETE FROM ERS_ColonAbnoMiscellaneous WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoVarices WHERE SiteId = @SiteId
		if exists(select 1 FROM ERS_ColonAbnoTumour WHERE SiteId = @SiteId)
			DELETE FROM ERS_ColonAbnoTumour WHERE SiteId = @SiteId
	END
	ELSE IF @ProcedureType IN (10)
	BEGIN
		DELETE FROM dbo.ERS_BRTAbnoDescriptions WHERE SiteId = @SiteId
	END

	ELSE IF @ProcedureType IN (11)
	BEGIN
		IF @IsLymphNode = 'True'
			DELETE FROM dbo.ERS_EBUSAbnoDescriptions WHERE SiteId = @SiteId
		ELSE
			DELETE FROM dbo.ERS_BRTAbnoDescriptions WHERE SiteId = @SiteId
	END

	DELETE FROM ERS_CommonAbnoDiverticulum WHERE SiteId = @SiteId
	DELETE FROM dbo.ERS_ProcedureDICAScores WHERE SiteId = @SiteId
	DELETE FROM ERS_CommonAbnoTumour WHERE SiteId = @SiteId		
	DELETE FROM ERS_CommonAbnoDuodenitis WHERE SiteId = @SiteId	
	DELETE FROM ERS_CommonAbnoDuodenalUlcer WHERE SiteId = @SiteId
	DELETE FROM ERS_CommonAbnoScaring WHERE SiteId = @SiteId	
	DELETE FROM ERS_CommonAbnoVascularLesions WHERE SiteId = @SiteId	
	DELETE FROM ERS_CommonAbnoAtrophic WHERE SiteId = @SiteId

	DELETE FROM ERS_CommonAbnoOther WHERE SiteId = @SiteId

	DELETE FROM ERS_UpperGISpecimens WHERE SiteId = @SiteId
	DELETE FROM ERS_BRTSpecimens WHERE SiteId = @SiteId
	DELETE FROM ERS_UpperGITherapeutics WHERE SiteId = @SiteId		

	DELETE FROM ERS_Photos WHERE SiteId = @SiteId

	DELETE FROM ERS_RecordCount WHERE SiteId = @SiteId	

	IF @AreaNo > 0 AND @SiteNo > 0 --Main Site of an Area
		DELETE FROM ERS_Sites WHERE ProcedureId = @ProcedureId AND AreaNo = @AreaNo 
	ELSE
		DELETE FROM ERS_Sites WHERE SiteId = @SiteId

	IF EXISTS (SELECT 1 FROM ERS_Diagnoses WHERE ProcedureId = @ProcedureId AND SiteId = @SiteId)
	BEGIN
		DELETE FROM ERS_Diagnoses WHERE ProcedureId = @ProcedureId AND SiteId = @SiteId
		EXEC ogd_diagnoses_summary_update @ProcedureID
	END

	EXEC sites_reorder @ProcedureId
	EXEC procedure_summary_update @ProcedureId
END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;
GO

update dbo.ERS_DiagnosesMatrix SET code = 'DESDSCARP9' WHERE code = 'DESDSCARP3' AND ProcedureTypeID = 9
GO


/****** Object:  Trigger [dbo].[TR_CommonAbnoLesions]    Script Date: 18/01/2024 18:33:49 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

	ALTER TRIGGER [dbo].[TR_CommonAbnoLesions]
	ON [dbo].[ERS_CommonAbnoLesions]
	AFTER INSERT, UPDATE, DELETE
	AS 
		DECLARE @site_id INT, @Polyp VARCHAR(10) = 'False', 
							  @BenignTumour VARCHAR(10) = 'False', 
							  @MalignantTumour VARCHAR(10) = 'False', 
							  @SubmucosalTumour VARCHAR(10) = 'False', 
							  @FocalLesions VARCHAR(10) = 'False',
							  @SubmucoaslLesion VARCHAR(10) = 'False',
							  @FundicGlandPolyp VARCHAR(10) = 'False',
							  @PreviousESDScar VARCHAR(10) = 'False',
				@PolypTypeId INT, @Region VARCHAR(20), @ProcedureTypeId INT, @MatrixCode VARCHAR(50)
	
		IF EXISTS(SELECT * FROM INSERTED)
		BEGIN
			SELECT @site_id=SiteId,
					@Polyp = (CASE WHEN (ISNULL(Polyp,0) = 1) THEN 'True' ELSE 'False' END),
					@FocalLesions = (CASE WHEN (ISNULL(Focal,0) = 1) THEN 'True' ELSE 'False' END),
					@SubmucoaslLesion = (CASE WHEN (ISNULL(Submucosal,0) = 1) THEN 'True' ELSE 'False' END),
					@FundicGlandPolyp = (CASE WHEN (ISNULL(FundicGlandPolyp,0) = 1) THEN 'True' ELSE 'False' END),
					@PolypTypeId = PolypTypeId,
					@PreviousESDScar = (CASE WHEN (ISNULL(PreviousESDScar,0) = 1) THEN 'True' ELSE 'False' END)
				
			FROM INSERTED

			SELECT TOP 1 @ProcedureTypeId =  p.ProcedureType FROM ERS_Sites s INNER JOIN ERS_Procedures p ON p.ProcedureId = s.ProcedureId WHERE s.SiteId = @site_id
			--check if polyps = 1
			IF @Polyp = 'True' 
			BEGIN
				--check for polyp type
				DECLARE @PolypType VARCHAR(200) = (SELECT Description FROM ERS_PolypTypes WHERE UniqueId = @PolypTypeId)

				IF LOWER(@PolypType) = 'sessile'
				BEGIN
					--sessile polyps to produce a gastric tumour outcome depending on the tumour type
					IF EXISTS (SELECT 1 FROM ERS_CommonAbnoPolypDetails WHERE SiteId = @site_id AND Type = (SELECT UniqueId FROM ERS_TumourTypes WHERE Description = 'benign'))
						SET @BenignTumour = 'True'
					ELSE 
						SET @BenignTumour = 'False'

					IF EXISTS (SELECT 1 FROM ERS_CommonAbnoPolypDetails WHERE SiteId = @site_id AND Type = (SELECT UniqueId FROM ERS_TumourTypes WHERE Description = 'malignant'))
						SET @MalignantTumour = 'True'
					ELSE
						SET @MalignantTumour = 'False'
				END
			
				IF LOWER(@PolypType) = 'submucosal'  AND LOWER(@Region) = 'stomach'
					SET @SubmucoaslLesion = 'True'
				ELSE
					SET @SubmucoaslLesion = 'False'

			END
		
			IF @ProcedureTypeId IN (1,6,8)
			BEGIN
				SELECT @Region = dbo.fnSiteRegion(@site_id)

				IF LOWER(@Region) = 'stomach'
				BEGIN
					--SELECT @Polyp = CASE WHEN @FundicGlandPolyp = 'False' AND @BenignTumour = 'False' AND @MalignantTumour = 'False' AND @SubmucosalTumour = 'False' THEN 'True' ELSE 'False' END
					SET @MatrixCode = 'D40P1'
				END
				ELSE IF LOWER(@Region) = 'oesophagus'
					SET @MatrixCode = 'N2013'
				ELSE IF LOWER(@Region) = 'duodenum'
					SET @MatrixCode = 'D58P1'
				ELSE IF LOWER(@Region) = 'colon'
					SET @MatrixCode = 'D58P1'
				
			END
			ELSE IF @ProcedureTypeId IN (3,4,9)
			BEGIN
				SELECT @Region = dbo.fnSiteRegion(@site_id)

				IF @Polyp = 'True' AND @Region IN ('Rectum', 'Anal Margin')
					SET @MatrixCode = 'D4P3'

				IF @Polyp = 'True' AND @Region NOT IN ('Rectum', 'Anal Margin', 'Terminal Ileum')
					SET @MatrixCode = 'D12P3'

				IF @Polyp = 'True' AND @Region IN ('Terminal Ileum', 'Neo-Terminal Ileum')
					SET @MatrixCode = 'DIPOLYPP3'
			END

		END
		ELSE
		BEGIN
			SELECT @site_id=SiteId FROM DELETED
		END

		EXEC abnormalities_common_lesions_summary_update @site_id

		IF @site_id IS NOT NULL AND @ProcedureTypeId IN (1,3,4,6,8,9,2,7)
		BEGIN
			EXEC sites_summary_update @site_id

			EXEC diagnoses_control_save @site_id, @MatrixCode, @Polyp		
			--EXEC diagnoses_control_save @site_id, 'D86P1', @BenignTumour	
			--EXEC diagnoses_control_save @site_id, 'D87P1', @MalignantTumour	
			EXEC diagnoses_control_save @site_id, 'N2001', @FocalLesions
			EXEC diagnoses_control_save @site_id, 'D88P1', @SubmucosalTumour
			EXEC diagnoses_control_save @site_id, 'N2002', @SubmucoaslLesion
			EXEC diagnoses_control_save @site_id, 'N2019', @FundicGlandPolyp

			IF @ProcedureTypeId IN (1,6,8)
			BEGIN
			    EXEC diagnoses_control_save @site_id, 'DSESDSCARP1', @PreviousESDScar		
			END
			ELSE IF @ProcedureTypeId IN (2,7)
			BEGIN
				EXEC diagnoses_control_save @site_id, 'DDESDSCARP2', @PreviousESDScar
			END
			ELSE IF @ProcedureTypeId IN (3,9)
			BEGIN
				EXEC diagnoses_control_save @site_id, 'DESDSCARP3', @PreviousESDScar
			END
			ELSE IF @ProcedureTypeId = 4
			BEGIN
				EXEC diagnoses_control_save @site_id, 'SDESDSCARP3', @PreviousESDScar
			END
		END
GO


ALTER TRIGGER [dbo].[TR_UpperGIAbnoMiscellaneous_Insert]
ON [dbo].[ERS_UpperGIAbnoMiscellaneous]
AFTER INSERT, UPDATE 
AS 
	DECLARE @site_id INT, @Diverticulum VARCHAR(10), @Foreignbody VARCHAR(10), @MaloryWeissTear VARCHAR(10), 
			@MotilityDisorder VARCHAR(10), @Stricture VARCHAR(10), @StrictureBenign VARCHAR(10), @StrictureMalignant VARCHAR(10), 
			@Tumour VARCHAR(10), @TumourBenign VARCHAR(10), @TumourProbablyBenign VARCHAR(10),
			@TumourMalignant VARCHAR(10), @TumourProbablyMalignant VARCHAR(10), @Ulcer VARCHAR(10), @Web VARCHAR(10), @SchatzkiRing VARCHAR(10), 
			@ExtrinsicCompression VARCHAR(10), @PharyngealPouch VARCHAR(10), @ScopeCouldNotPass VARCHAR(10), @InletPatch VARCHAR(10),
			@Other VARCHAR(10), @FoodResidue VARCHAR(10), @Fitsula VARCHAR(10), @InletPouch VARCHAR(10), @ZLine VARCHAR(10), @Volvulus VARCHAR(10), @AmpullaryAdenoma VARCHAR(10), @StentOcclusion VARCHAR(10),
			@StentInSitu VARCHAR(10), @PEGInSitu VARCHAR(10)

	SELECT @site_id=SiteId, 
			@Diverticulum = (CASE WHEN Diverticulum = 1 THEN 'True' ELSE 'False' END), 
			@Foreignbody = (CASE WHEN Foreignbody = 1 THEN 'True' ELSE 'False' END),
			@MaloryWeissTear = (CASE WHEN Mallory = 1 THEN 'True' ELSE 'False' END),
			@MotilityDisorder = (CASE WHEN MotilityDisorder = 1 THEN 'True' ELSE 'False' END),
			@Stricture = (CASE WHEN (Stricture = 1 AND StrictureType = 0) THEN 'True' ELSE 'False' END),
			@StrictureBenign = (CASE WHEN (Stricture = 1 AND StrictureType = 1) THEN 'True' ELSE 'False' END),
			@StrictureMalignant = (CASE WHEN (Stricture = 1 AND StrictureType = 2) THEN 'True' ELSE 'False' END),
			@Tumour = (CASE WHEN (Tumour = 1 AND TumourType = 0) THEN 'True' ELSE 'False' END),
			@TumourBenign = (CASE WHEN (Tumour = 1 AND TumourType = 1 AND TumourProbably <> 1) THEN 'True' ELSE 'False' END),
			@TumourProbablyBenign = (CASE WHEN (Tumour = 1 AND TumourType = 1 AND TumourProbably = 1) THEN 'True' ELSE 'False' END),
			@TumourMalignant = (CASE WHEN (Tumour = 1 AND TumourType = 2 AND TumourProbably <> 1) THEN 'True' ELSE 'False' END),
			@TumourProbablyMalignant = (CASE WHEN (Tumour = 1 AND TumourType = 2 AND TumourProbably = 1) THEN 'True' ELSE 'False' END),
			@Ulcer = (CASE WHEN (Ulceration = 1) THEN 'True' ELSE 'False' END),
			@Web = (CASE WHEN (Web = 1) THEN 'True' ELSE 'False' END),
			@SchatzkiRing = (CASE WHEN (SchatzkiRing = 1) THEN 'True' ELSE 'False' END),
			@ExtrinsicCompression = (CASE WHEN (ExtrinsicCompression = 1) THEN 'True' ELSE 'False' END),
			@PharyngealPouch = (CASE WHEN (Pharyngeal = 1) THEN 'True' ELSE 'False' END),
			@ScopeCouldNotPass = (CASE WHEN (StrictureScopeNotPass = 1) OR (TumourScopeNotPass = 1) THEN 'True' ELSE 'False' END),
			@InletPatch = (CASE WHEN (InletPatch = 1) AND (InletPatchQty > 0 OR InletPatchMultiple = 1) THEN 'True' ELSE 'False' END),
			@Other = (CASE WHEN (MiscOther != '') THEN 'True' ELSE 'False' END),
			@FoodResidue = (CASE WHEN (FoodResidue = 1) THEN 'True' ELSE 'False' END),
			@Fitsula = (CASE WHEN (Fitsula = 1) THEN 'True' ELSE 'False' END),
			@InletPouch = (CASE WHEN InletPouch = 1 AND InletPouchQty > 0 THEN 'True' ELSE 'False' END),
			@ZLine = (CASE WHEN ZLine = 1 THEN 'True' ELSE 'False' END),
			@Volvulus = (CASE WHEN Volvulus = 1 THEN 'True' ELSE 'False' END),
			@AmpullaryAdenoma = (CASE WHEN AmpullaryAdenoma = 1 THEN 'True' ELSE 'False' END),
			@StentOcclusion = (CASE WHEN StentOcclusion = 1 THEN 'True' ELSE 'False' END),
			@StentInSitu = (CASE WHEN StentInSitu = 1 THEN 'True' ELSE 'False' END),
			@PEGInSitu = (CASE WHEN PEGInSitu = 1 THEN 'True' ELSE 'False' END)

	FROM INSERTED

	DECLARE @ProcedureTypeId INT

	SELECT TOP 1 @ProcedureTypeId =  p.ProcedureType FROM ERS_Sites s INNER JOIN ERS_Procedures p ON p.ProcedureId = s.ProcedureId WHERE s.SiteId = @site_id


	EXEC ogd_kpi_stricture_perforation @site_id --Update perforation text in QA for OGD KPI

	EXEC abnormalities_miscellaneous_summary_update @site_id
	EXEC sites_summary_update @site_id

	DECLARE @Region VARCHAR(50) = dbo.fnSiteRegion(@site_id) 

	IF LOWER(@Region) = 'oesophagus'
	BEGIN
		--for sites in the oesophagus
		EXEC diagnoses_control_save @site_id, 'D32P1', @Diverticulum			-- 'Diverticulum'
		EXEC diagnoses_control_save @site_id, 'D35P1', @Foreignbody				-- 'Foreignbody'
		EXEC diagnoses_control_save @site_id, 'D24P1', @MaloryWeissTear			-- 'MaloryWeissTear'
		EXEC diagnoses_control_save @site_id, 'D28P1', @MotilityDisorder		-- 'MotilityDisorder'
		EXEC diagnoses_control_save @site_id, 'D21P1', @Stricture				-- 'Stricture'
		EXEC diagnoses_control_save @site_id, 'D72P1', @StrictureBenign			-- 'StrictureBenign'
		EXEC diagnoses_control_save @site_id, 'D73P1', @StrictureMalignant		-- 'StrictureMalignant'
		EXEC diagnoses_control_save @site_id, 'D74P1', @Tumour					-- 'Tumour'
		EXEC diagnoses_control_save @site_id, 'D25P1', @TumourBenign			-- 'TumourBenign'
		EXEC diagnoses_control_save @site_id, 'D29P1', @TumourProbablyBenign	-- 'TumourProbablyBenign'
		EXEC diagnoses_control_save @site_id, 'D34P1', @TumourMalignant			-- 'TumourMalignant'
		EXEC diagnoses_control_save @site_id, 'D37P1', @TumourProbablyMalignant	-- 'TumourProbablyMalignant'
		EXEC diagnoses_control_save @site_id, 'D26P1', @Ulcer					-- 'Ulcer'
		EXEC diagnoses_control_save @site_id, 'D38P1', @Web						-- 'Web'
		EXEC diagnoses_control_save @site_id, 'D71P1', @SchatzkiRing			-- 'SchatzkiRing'
		EXEC diagnoses_control_save @site_id, 'D67P1', @ExtrinsicCompression	-- 'ExtrinsicCompression'
		EXEC diagnoses_control_save @site_id, 'D69P1', @PharyngealPouch			-- 'Pharyngeal Pouch
		EXEC diagnoses_control_save @site_id, 'D98P1', @InletPatch				
		EXEC diagnoses_control_save @site_id, 'D99P1', @FoodResidue				
		EXEC diagnoses_control_save @site_id, 'D68P1', @Fitsula
		EXEC diagnoses_control_save @site_id, 'DInletPouchP1', @InletPouch		-- 'Inlet Pouch					
		EXEC diagnoses_control_save @site_id, 'NZLINEP1', @ZLine		-- 'Z-Line			
		EXEC diagnoses_control_save @site_id, 'DOSTECNTOCCP1', @StentOcclusion						
		EXEC diagnoses_control_save @site_id, 'DOSTECNTSITUP1', @StentInSitu						
		EXEC diagnoses_control_save @site_id, 'DOPEGINSITUP1', @PEGInSitu						

		
	END
	ELSE IF LOWER(@Region) = 'stomach'
	BEGIN
		--for sites in the stomach
		EXEC diagnoses_control_save @site_id, 'N2009', @Fitsula				
		EXEC diagnoses_control_save @site_id, 'N2010', @Foreignbody				-- 'Foreignbody'
		EXEC diagnoses_control_save @site_id, 'N2008', @Diverticulum			-- 'Diverticulum'
		EXEC diagnoses_control_save @site_id, 'DSSTECNTOCCP1', @StentOcclusion				
		EXEC diagnoses_control_save @site_id, 'DSSTECNTSITUP1', @StentInSitu								
		EXEC diagnoses_control_save @site_id, 'DSPEGINSITUP1', @PEGInSitu						

	END
	ELSE IF LOWER(@Region) = 'duodenum'
	BEGIN
		EXEC diagnoses_control_save @site_id, 'DVOLVULUSP1', @Volvulus				
		EXEC diagnoses_control_save @site_id, 'DAAdenomaP1', @AmpullaryAdenoma		
		EXEC diagnoses_control_save @site_id, 'DDSTECNTOCCP1', @StentOcclusion				
		EXEC diagnoses_control_save @site_id, 'DDSTECNTSITUP1', @StentInSitu						
		EXEC diagnoses_control_save @site_id, 'DDPEGINSITUP1', @PEGInSitu						
		
		IF @ProcedureTypeId IN (2,7)
		BEGIN
			EXEC diagnoses_control_save @site_id, 'DPEGINSITUP2', @PEGInSitu						
			EXEC diagnoses_control_save @site_id, 'DSTECNTSITUP2', @PEGInSitu						
			EXEC diagnoses_control_save @site_id, 'DSTECNTOCCP2', @StentOcclusion						
			EXEC diagnoses_control_save @site_id, 'DAAdenomaP2', @AmpullaryAdenoma						
			EXEC diagnoses_control_save @site_id, 'DVOLVULUSP2', @Volvulus						
		END
	END

	EXEC diagnoses_control_save @site_id, 'D100P1', @Other				
	EXEC diagnoses_control_save @site_id, 'StomachNotEntered', @ScopeCouldNotPass			-- 'scope could not pass
	EXEC diagnoses_control_save @site_id, 'DuodenumNotEntered', @ScopeCouldNotPass			-- 'scope could not pass
GO	
	
update dbo.ERS_DiagnosesMatrix SET code = 'SOPOUCHITISP3' WHERE code = 'SOPOUCHITIS3' AND ProcedureTypeID = 4
GO

update dbo.ERS_DiagnosesMatrix SET code = 'DOPOUCHITISP3' WHERE code = 'DOPOUCGITISP3' AND ProcedureTypeID = 3
GO



ALTER TRIGGER [dbo].[TR_ColonAbnoMiscellaneous]
ON [dbo].[ERS_ColonAbnoMiscellaneous]
AFTER INSERT, UPDATE, DELETE
AS 
	DECLARE @site_id INT, 
			@Action CHAR(1) = 'I',
			@Crohns VARCHAR(10) = 'False',
			@Fistula VARCHAR(10) = 'False',
			@ForeignBody VARCHAR(10) = 'False',
			@Lipoma VARCHAR(10) = 'False',
			@Melanosis VARCHAR(10) = 'False',
			@Parasites VARCHAR(10) = 'False',
			@PneuColi VARCHAR(10) = 'False',
			@PolypSyndrome VARCHAR(10) = 'False',
			@PostOp VARCHAR(10) = 'False',
			@PseudoObstruction VARCHAR(10) = 'False',
			@Pouchitis VARCHAR(10) = 'False',
			@Volvulus VARCHAR(10) = 'False',
			@AmpullaryAdenoma VARCHAR(10) = 'False',
			@StentInSitu VARCHAR(10) = 'False',
			@PEGInSitu VARCHAR(10) = 'False',
			@StentOcclusion VARCHAR(10) = 'False',
			@Other VARCHAR(10) = 'False'

	IF EXISTS(SELECT * FROM DELETED) SET @Action = CASE WHEN EXISTS(SELECT * FROM INSERTED) THEN 'U' ELSE 'D' END

	-- INSERTED OR UPDATED
	IF @Action IN ('I', 'U') 
	BEGIN
		SELECT @site_id=SiteId,
				@Crohns = (CASE WHEN (Crohn=1) THEN 'True' ELSE 'False' END),
				@Fistula = (CASE WHEN (Fistula=1) THEN 'True' ELSE 'False' END),
				@ForeignBody = (CASE WHEN (ForeignBody=1) THEN 'True' ELSE 'False' END),
				@Lipoma = (CASE WHEN (Lipoma=1) THEN 'True' ELSE 'False' END),
				@Melanosis = (CASE WHEN (Melanosis=1) THEN 'True' ELSE 'False' END),
				@Parasites = (CASE WHEN (Parasites=1) THEN 'True' ELSE 'False' END),
				@PneuColi = (CASE WHEN (PneumatosisColi=1) THEN 'True' ELSE 'False' END),
				@PolypSyndrome = (CASE WHEN (PolyposisSyndrome=1) THEN 'True' ELSE 'False' END),
				@PostOp = (CASE WHEN (PostoperativeAppearance=1) THEN 'True' ELSE 'False' END),
				@PseudoObstruction = (CASE WHEN (PseudoObstruction=1) THEN 'True' ELSE 'False' END),
				@Pouchitis = (CASE WHEN (Pouchitis=1) THEN 'True' ELSE 'False' END),
				@Volvulus = (CASE WHEN (Volvulus=1) THEN 'True' ELSE 'False' END),
				@AmpullaryAdenoma = (CASE WHEN (AmpullaryAdenoma=1) THEN 'True' ELSE 'False' END),
				@StentInSitu = (CASE WHEN (StentInSitu=1) THEN 'True' ELSE 'False' END),
				@PEGInSitu = (CASE WHEN (PEGInSitu=1) THEN 'True' ELSE 'False' END),
				@StentOcclusion = (CASE WHEN (StentOcclusion=1) THEN 'True' ELSE 'False' END),
				@Other = (CASE WHEN (ISNULL(Other,'') <> '') THEN 'True' ELSE 'False' END)
		FROM INSERTED

		EXEC abnormalities_colon_miscellaneous_summary_update @site_id
	END

	-- DELETED
	IF @Action = 'D'
	BEGIN
		SELECT @site_id=SiteId FROM DELETED
	END

	EXEC sites_summary_update @site_id
	EXEC diagnoses_control_save @site_id, 'D86P3', @Crohns			
	EXEC diagnoses_control_save @site_id, 'D71P3', @Fistula			
	EXEC diagnoses_control_save @site_id, 'D72P3', @ForeignBody			
	EXEC diagnoses_control_save @site_id, 'D73P3', @Lipoma			
	EXEC diagnoses_control_save @site_id, 'D74P3', @Melanosis			
	EXEC diagnoses_control_save @site_id, 'D75P3', @Parasites			
	EXEC diagnoses_control_save @site_id, 'D76P3', @PneuColi			
	EXEC diagnoses_control_save @site_id, 'D77P3', @PolypSyndrome			
	EXEC diagnoses_control_save @site_id, 'D78P3', @PostOp			
	EXEC diagnoses_control_save @site_id, 'D9P3', @PseudoObstruction			
	EXEC diagnoses_control_save @site_id, 'DOPOUCHITISP3', @Pouchitis					
	EXEC diagnoses_control_save @site_id, 'DVOLVULUSP3', @Volvulus						
	EXEC diagnoses_control_save @site_id, 'DAAdenomaP3', @AmpullaryAdenoma				
	EXEC diagnoses_control_save @site_id, 'DSTECNTSITUP3', @StentInSitu				
	EXEC diagnoses_control_save @site_id, 'DPEGINSITUP3', @PEGInSitu				
	EXEC diagnoses_control_save @site_id, 'DSTECNTOCCP3', @StentOcclusion				
	EXEC diagnoses_control_save @site_id, 'SN2016', @Other
GO


ALTER PROCEDURE [dbo].[ogd_diagnoses_summary_update]
(
	@ProcedureId INT
)
AS

SET NOCOUNT ON

--DECLARE @ProcedureType Int = (SELECT ProcedureType FROM ERS_Procedures WHERE ProcedureId=@ProcedureId)
DECLARE @ProcedureType INT
DECLARE @Summary varchar(MAX)=''
DECLARE @tmpSummary varchar(MAX)=''
DECLARE @XMLlist XML
DECLARE @OperatingHospitalId INT
DECLARE @OGDDiagnosisOption INT
DECLARE @Extent INT
DECLARE @ExtentItem VARCHAR(MAX)
DECLARE @ExtentDescription VARCHAR(MAX)
DECLARE @ExtentLevelReached BIT = 0

SELECT 
	@ProcedureType = ProcedureType, 
	@OperatingHospitalId = COALESCE(OperatingHospitalId, 0, OperatingHospitalID)
FROM ERS_Procedures 
WHERE ProcedureId = @ProcedureId

SELECT 
	@OGDDiagnosisOption = OGDDiagnosis
FROM dbo.ERS_SystemConfig 
WHERE OperatingHospitalId = @OperatingHospitalId

--SELECT
--	@Extent = CASE WHEN ugeoi.Extent > 0 THEN ugeoi.Extent ELSE ugeoi.TrainerExtent END,
--	@ExtentItem = el.ListItemText,
--	@ExtentDescription = el.ListDescription,
--	@ExtentLevelReached = CASE WHEN el.ListItemText IN ('Jejunum', 'D3', 'D2', 'D1') THEN 1 ELSE 0 END
--FROM dbo.ERS_UpperGIExtentOfIntubation ugeoi
--LEFT OUTER JOIN dbo.ERS_Lists el ON (ugeoi.Extent = el.ListItemNo OR ugeoi.TrainerExtent = el.ListItemNo)
--WHERE el.ListDescription = 'Extent of Intubation OGD'
--AND ugeoi.ProcedureId = @ProcedureId

--check for procedure DNA
DECLARE @ProcNotCarriedOut bit = ISNULL((SELECT 1 FROM ERS_Procedures WHERE ProcedureId = @ProcedureId AND DNA IS NOT NULL), 0)

IF @ProcNotCarriedOut = 1
	RETURN --DNA procs do not procude a diagnosis
	
	 
IF @ProcedureType IN (2, 7)    --For ERCP & EUS_HPB, execute a different SP
BEGIN
	EXEC ercp_diagnoses_summary_update @ProcedureId
	RETURN
END

BEGIN TRANSACTION

BEGIN TRY

SELECT * INTO #tbl_ERS_Diagnoses FROM ERS_Diagnoses WHERE ProcedureId=@ProcedureId 

IF @ProcedureType IN (1,6,8)   --Gastroscopy
BEGIN
	IF OBJECT_ID('tempdb..#Oesophagus') IS NOT NULL DROP TABLE #Oesophagus
	IF OBJECT_ID('tempdb..#Stomach') IS NOT NULL DROP TABLE #Stomach
	IF OBJECT_ID('tempdb..#Duodenum') IS NOT NULL DROP TABLE #Duodenum

    IF OBJECT_ID('tempdb..#OesophagusTemp') IS NOT NULL DROP TABLE #OesophagusTemp
                             create table #OesophagusTemp ([cx] Int null, [Text] varchar(MAX) null)
    IF OBJECT_ID('tempdb..#StomachTemp') IS NOT NULL DROP TABLE #StomachTemp
                             create table #StomachTemp ([cx] Int null, [Text] varchar(MAX) null)
    IF OBJECT_ID('tempdb..#DuodenumTemp') IS NOT NULL DROP TABLE #DuodenumTemp
                             create table #DuodenumTemp ([cx] Int null, [Text] varchar(MAX) null)
	
	IF (SELECT COUNT(*) FROM #tbl_ERS_Diagnoses ted) = 0
	BEGIN
		INSERT INTO ERS_Diagnoses (ProcedureID, MatrixCode, [Value], IsOtherData)
		VALUES (@ProcedureId, 'OverallNormal', '1', 1)
	END
	ELSE
	BEGIN
		/*OESOPHGAS REGION*/
		IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Region='Oesophagus' AND Value IN ('True', '1') AND MatrixCode NOT IN ('OesophagusNormal', 'OesophagusNotEntered'))
		BEGIN
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'OesophagusNormal') DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'OesophagusNormal' AND Value IN ('True', '1')
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'OesophagusNotEntered')  DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'OesophagusNotEntered' AND Value IN ('True', '1')
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'OverallNormal') DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'OverallNormal'
		END
		ELSE IF NOT EXISTS (SELECT 1 FROM #tbl_ERS_Diagnoses WHERE Region = 'Oesophagus' OR MatrixCode = 'OverallNormal')
		BEGIN
			INSERT INTO [ERS_Diagnoses] (ProcedureId, MatrixCode, Value, Region, IsOtherData) VALUES (@ProcedureId, 'OesophagusNormal', 'True', 'Oesophagus', 1)
		END

		/*STOMACH REGION*/
		IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Region='Stomach' AND Value IN ('True', '1') AND MatrixCode NOT IN ('StomachNormal', 'StomachNotEntered'))
		BEGIN
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'StomachNormal')  DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'StomachNormal' AND Value IN ('True', '1')
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'StomachNotEntered')  DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'StomachNotEntered' AND Value IN ('True', '1')
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'OverallNormal')  DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'OverallNormal'

			/*Oesophagus must've been entered to get a diagnoses*/
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'OesophagusNotEntered')  DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'OesophagusNotEntered' AND Value IN ('True', '1')
		END
		ELSE IF NOT EXISTS (SELECT 1 FROM #tbl_ERS_Diagnoses WHERE Region = 'Stomach' OR MatrixCode = 'OverallNormal')
		BEGIN
			INSERT INTO [ERS_Diagnoses] (ProcedureId, MatrixCode, Value, Region, IsOtherData) VALUES (@ProcedureId, 'StomachNormal', 'True', 'Stomach', 1)
		END

		/*DUODENUM REGION*/
		IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Region='Duodenum' AND Value IN ('True', '1') AND MatrixCode NOT IN ('DuodenumNormal', 'DuodenumNotEntered'))
		BEGIN
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'DuodenumNormal')  DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'DuodenumNormal' AND Value IN ('True', '1')
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'DuodenumNotEntered')  DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'DuodenumNotEntered' AND Value IN ('True', '1')
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'OverallNormal')   DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'OverallNormal'

			/*Oesophagus and stomach must've been entered to get a diagnoses*/
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'OesophagusNotEntered')  DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'OesophagusNotEntered' AND Value IN ('True', '1')
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'StomachNotEntered')  DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'StomachNotEntered' AND Value IN ('True', '1')

		END
		ELSE IF NOT EXISTS (SELECT 1 FROM #tbl_ERS_Diagnoses WHERE Region = 'Duodenum' OR MatrixCode = 'OverallNormal')
		BEGIN
			INSERT INTO [ERS_Diagnoses] (ProcedureId, MatrixCode, Value, Region, IsOtherData) VALUES (@ProcedureId, 'DuodenumNormal', 'True', 'Duodenum', 1)
		END

	END

	IF EXISTS (SELECT 1 FROM #tbl_ERS_Diagnoses ted WHERE Region = 'Oesophagus' AND MatrixCode = 'OesophagusNormal' AND ted.[Value] IN ('True', '1')) AND
			EXISTS (SELECT 1 FROM #tbl_ERS_Diagnoses ted WHERE Region = 'Stomach' AND MatrixCode = 'StomachNormal' AND ted.[Value] IN ('True', '1')) AND
			EXISTS (SELECT 1 FROM #tbl_ERS_Diagnoses ted WHERE Region = 'Duodenum' AND MatrixCode = 'DuodenumNormal' AND ted.[Value] IN ('True', '1')) AND
			NOT EXISTS (SELECT 1 FROM #tbl_ERS_Diagnoses ted WHERE MatrixCode <> 'Summary' AND MatrixCode NOT IN ('OesophagusNormal','StomachNormal','DuodenumNormal'))
	BEGIN
		DELETE FROM ERS_Diagnoses WHERE MatrixCode IN ('OesophagusNormal','StomachNormal','DuodenumNormal')

		INSERT INTO ERS_Diagnoses (ProcedureID, MatrixCode, [Value], IsOtherData)
		VALUES (@ProcedureId, 'OverallNormal', '1', 1)
	END



	-- Don't repeat diagnoses
	IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE MatrixCode in ('D39P1', 'D84P1')) DELETE FROM ERS_Diagnoses WHERE MatrixCode = 'D49P1' and ProcedureID = @ProcedureId
	IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE MatrixCode in ('D90P1', 'D91P1')) DELETE FROM ERS_Diagnoses WHERE MatrixCode = 'D53P1' and ProcedureID = @ProcedureId

	DELETE FROM #tbl_ERS_Diagnoses
	INSERT INTO #tbl_ERS_Diagnoses
	(
	    ProcedureID,
	    SiteId,
	    MatrixCode,
	    [Value],
	    Region,
	    IsOtherData
	)
	SELECT  
	    ProcedureID,
	    SiteId,
	    MatrixCode,
	    [Value],
	    Region,
	    IsOtherData 
	FROM ERS_Diagnoses WHERE ProcedureId=@ProcedureId 



    SELECT  RowNum = ROW_NUMBER() OVER(ORDER BY [DiagnosesID]),d.*, convert(varchar(Max), m.DisplayName) AS DisplayName	INTO #Oesophagus	FROM #tbl_ERS_Diagnoses d	LEFT JOIN ERS_DiagnosesMatrix m ON d.matrixcode=m.Code WHERE Region='Oesophagus'	AND [Value] IS NOT NULL AND [Value]<>'False' AND [Value]<>'' AND MatrixCode <>'Summary'
    SELECT  RowNum = ROW_NUMBER() OVER(ORDER BY [DiagnosesID]),d.*, convert(varchar(Max), m.DisplayName) AS DisplayName	INTO #Stomach		FROM #tbl_ERS_Diagnoses d	LEFT JOIN ERS_DiagnosesMatrix m ON d.matrixcode=m.Code WHERE Region='Stomach'		AND [Value] IS NOT NULL AND [Value]<>'False' AND [Value]<>'' AND MatrixCode <>'Summary'
    SELECT  RowNum = ROW_NUMBER() OVER(ORDER BY [DiagnosesID]),d.*, convert(varchar(Max), m.DisplayName) AS DisplayName	INTO #Duodenum		FROM #tbl_ERS_Diagnoses d	LEFT JOIN ERS_DiagnosesMatrix m ON d.matrixcode=m.Code WHERE Region='Duodenum'		AND [Value] IS NOT NULL AND [Value]<>'False' AND [Value]<>'' AND MatrixCode <>'Summary'
	

	--Insert Other Abnormality
	If EXISTS(Select 1 from ERS_CommonAbnoOther CAO join ERS_Sites S On CAO.SiteId = s.SiteId where S.ProcedureId = @ProcedureId)
	BEGIN

		Insert into #Oesophagus (DiagnosesID, DisplayName, SiteId, ProcedureID, MatrixCode)
		SELECT 999, STUFF((
			SELECT DISTINCT ', ' + OA.Diagnoses  
			FROM ERS_OtherAbnormalities OA
			JOIN ERS_CommonAbnoOther CAO ON OA.OtherId = CAO.OtherId
			JOIN ERS_Sites S ON CAO.SiteId = s.SiteId
			JOIN ERS_Regions R ON S.RegionId = R.RegionId
			JOIN ERS_AbnormalitiesMatrixUpperGI AMU ON R.Region = AMU.Region
			WHERE S.ProcedureId = @ProcedureId
			AND AMU.Area = 'Oesophagus'
			AND AMU.ProcedureType = @ProcedureType
			FOR XML PATH('')), 1, 1, '') Code, 2, @ProcedureId, 'D999P0'

		Insert into #Stomach (DiagnosesID, DisplayName, SiteId, ProcedureID, MatrixCode)
		SELECT 999, STUFF((
			SELECT DISTINCT ', ' + OA.Diagnoses  
			FROM ERS_OtherAbnormalities OA
			JOIN ERS_CommonAbnoOther CAO ON OA.OtherId = CAO.OtherId
			JOIN ERS_Sites S ON CAO.SiteId = s.SiteId
			JOIN ERS_Regions R ON S.RegionId = R.RegionId
			JOIN ERS_AbnormalitiesMatrixUpperGI AMU ON R.Region = AMU.Region
			WHERE S.ProcedureId = @ProcedureId
			AND AMU.Area = 'Stomach'
			AND AMU.ProcedureType = @ProcedureType
			FOR XML PATH('')), 1, 1, '') Code, 2, @ProcedureId, 'D999P0'

		Insert into #Duodenum (DiagnosesID, DisplayName, SiteId, ProcedureID, MatrixCode)
		SELECT 999, STUFF((
			SELECT DISTINCT ', ' + OA.Diagnoses  
			FROM ERS_OtherAbnormalities OA
			JOIN ERS_CommonAbnoOther CAO ON OA.OtherId = CAO.OtherId
			JOIN ERS_Sites S ON CAO.SiteId = s.SiteId
			JOIN ERS_Regions R ON S.RegionId = R.RegionId
			JOIN ERS_AbnormalitiesMatrixUpperGI AMU ON R.Region = AMU.Region
			WHERE S.ProcedureId = @ProcedureId
			AND AMU.Area = 'Duodenum'
			AND AMU.ProcedureType = @ProcedureType
			FOR XML PATH('')), 1, 1, '') Code, 2, @ProcedureId, 'D999P0'
	END
	--Delete duplicates
	--DELETE FROM #Oesophagus WHERE RowNum NOT IN (SELECT MIN(RowNum) FROM #Oesophagus GROUP BY MatrixCode)
	--DELETE FROM #Stomach	WHERE RowNum NOT IN (SELECT MIN(RowNum) FROM #Stomach	GROUP BY MatrixCode)
	--DELETE FROM #Duodenum	WHERE RowNum NOT IN (SELECT MIN(RowNum) FROM #Duodenum	GROUP BY MatrixCode)
	--Delete duplicates
	
	--OESOPHAGUS
	INSERT INTO #OesophagusTemp ([cx],[Text]) 	--UNION to exclude duplicates for Abnormalities!
		--'Not Entered' or 'Normal' selected from the diagnoses screen
		SELECT 1, 'not entered' FROM #Oesophagus WHERE MatrixCode = 'OesophagusNotEntered'
		UNION
		SELECT 2, 'normal' FROM #Oesophagus WHERE MatrixCode = 'OesophagusNormal'
		UNION
		SELECT 3, CAST([Value] as Varchar(MAX)) FROM #Oesophagus WHERE MatrixCode = 'OesophagusOtherDiagnosis'
		UNION
		SELECT 0, DisplayName FROM #Oesophagus WHERE SiteId > 0 --Abnormalities for each sites 

	
	--STOMACH          
	INSERT INTO #StomachTemp ([cx],[Text]) 	--UNION to exclude duplicates for Abnormalities!
		--'Not Entered' or 'Normal' selected from the diagnoses screen
		SELECT 1, 'not entered' FROM #Stomach WHERE MatrixCode = 'StomachNotEntered'
		UNION
		SELECT 2, 'normal' FROM #Stomach WHERE MatrixCode = 'StomachNormal'
		UNION
		SELECT 3, CAST([Value] as Varchar(MAX)) FROM #Stomach WHERE MatrixCode = 'StomachOtherDiagnosis'
		UNION
		SELECT 0, DisplayName FROM #Stomach WHERE SiteId > 0 --Abnormalities for each sites 


	--DUODENUM      
	INSERT INTO #DuodenumTemp ([cx],[Text]) 	--UNION to exclude duplicates for Abnormalities!
		--'Not Entered' or 'Normal' selected from the diagnoses screen
		SELECT 1, 'not entered' FROM #Duodenum WHERE MatrixCode = 'DuodenumNotEntered'
		UNION
		SELECT 2, 'normal' FROM #Duodenum WHERE MatrixCode = 'DuodenumNormal'
		UNION
		SELECT 4, '2nd part not entered' FROM #Duodenum WHERE MatrixCode = 'Duodenum2ndPartNotEntered'
		UNION
		SELECT 3, CAST([Value] as Varchar(MAX)) FROM #Duodenum WHERE MatrixCode = 'DuodenumOtherDiagnosis'
		UNION
		SELECT 0, DisplayName FROM #Duodenum WHERE SiteId > 0 --Abnormalities for each sites 

--Determining the OGD diagnoses option set in System Settings
-- 0: Whole upper tract normal
-- 1: Individually Oesophagus normal, Stomach normal, Duodenum normal

	DECLARE @overallStatus AS INT
	IF EXISTS(SELECT 1 FROM #tbl_ERS_Diagnoses WHERE Value = 1 AND MatrixCode = 'OverallNormal')
	BEGIN
		SET @overallStatus = 1
	END
	ELSE
	BEGIN
		SET @overallStatus = 0
	END

	IF @OGDDiagnosisOption = 0 AND @overallStatus = 1
    BEGIN	
		SET @Summary = @summary + 'Whole upper gastro-intestinal tract normal.<br/>'			
	END
	ELSE 
	BEGIN
		--Oesophagus
		IF EXISTS(select 1 from #OesophagusTemp)
		BEGIN
			SET @XMLlist = (SELECT [text] AS Val FROM #OesophagusTemp FOR XML  RAW, ELEMENTS, TYPE)
			SET @tmpSummary = dbo.fnBuildString(@XMLlist)
			IF @tmpSummary <> '' SET @Summary = @summary + '<b>Oesophagus: </b>' + @tmpSummary + '.<br/>'
		END
		
		--Stomach 
		IF EXISTS(select 1 from #StomachTemp)
		BEGIN
			SET @XMLlist = (SELECT [text] AS Val FROM #StomachTemp FOR XML  RAW, ELEMENTS, TYPE)
			SET @tmpSummary = dbo.fnBuildString(@XMLlist)
			IF @tmpSummary <> '' SET @Summary = @summary + '<b>Stomach: </b>' + @tmpSummary + '.<br/>'
		END
		
		--Duodenum 
		IF EXISTS(select 1 from #DuodenumTemp) --AND @ExtentLevelReached = 1
		BEGIN
			SET @XMLlist = (SELECT [text] AS Val FROM #DuodenumTemp FOR XML  RAW, ELEMENTS, TYPE)
			SET @tmpSummary = dbo.fnBuildString(@XMLlist)
			IF @tmpSummary <> '' SET @Summary = @summary + '<b>Duodenum: </b>' + @tmpSummary + '.<br/>'
		END
		--ELSE
		--IF EXISTS(select 1 from #DuodenumTemp)
		--BEGIN
		--	SET @XMLlist = (SELECT [text] AS Val FROM #DuodenumTemp FOR XML  RAW, ELEMENTS, TYPE)
		--	SET @tmpSummary = dbo.fnBuildString(@XMLlist)
		--	IF @tmpSummary <> '' SET @Summary = @summary + '<b>Duodenum: </b>' + 'not entered.<br/>'
		--END		
	END	

	--IF EXISTS(SELECT 1 FROM ERS_UpperGIBleeds WHERE ProcedureID = @ProcedureId)
	--BEGIN
	--	SET @Summary = @summary +'<b>RISK OF REBLEED: </b>' + ISNULL((SELECT [OverallRiskAssessment] FROM ERS_UpperGIBleeds WHERE ProcedureID = @ProcedureId),'') + '. <br/> '
	--END

    DROP TABLE #Oesophagus
    DROP TABLE #OesophagusTemp
    DROP TABLE #Stomach
    DROP TABLE #StomachTemp
    DROP TABLE #Duodenum
    DROP TABLE #DuodenumTemp
END
ELSE IF @ProcedureType IN (3,4,5,9) --Colonoscopy, Sigmoidscopy, Proctoscopy
BEGIN
	IF OBJECT_ID('tempdb..#Colon') IS NOT NULL DROP TABLE #Colon
	IF OBJECT_ID('tempdb..#ColonTemp') IS NOT NULL DROP TABLE #ColonTemp
		create table #ColonTemp ([cx] Int null,	[Text] VARCHAR(MAX) null)

	IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True','1') AND MatrixCode <> 'ColonNormal' )
	BEGIN
		DELETE [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'ColonNormal'
		DELETE #tbl_ERS_Diagnoses WHERE MatrixCode = 'ColonNormal'
	END;

	--Select first row in each group (in case there's more than 1 record for a given MatrixCode)
	WITH colSummary AS (
    SELECT p.DiagnosesID, p.MatrixCode, p.Value, p.Region,
           ROW_NUMBER() OVER(PARTITION BY p.MatrixCode ORDER BY p.DiagnosesID DESC) AS rk
    FROM #tbl_ERS_Diagnoses p)

	SELECT d.*, cast(m.DisplayName as varchar(500)) as DisplayName
	INTO #Colon
	FROM colSummary d 
	LEFT JOIN ERS_DiagnosesMatrix m ON d.matrixcode = m.Code AND m.ProcedureTypeID = @ProcedureType
	WHERE rk = 1 -- Get the first record only
	AND Region = 'Colon'	AND [Value] IS NOT NULL	AND [Value] <> 'False'
	AND [Value] <> ''		AND [Value] <> '0'		--AND MatrixCode <> 'Summary'

	If EXISTS(Select 1 from ERS_CommonAbnoOther CAO join ERS_Sites S On CAO.SiteId = s.SiteId where S.ProcedureId = @ProcedureId)
	BEGIN

		Insert into #Colon (DiagnosesID, DisplayName, MatrixCode)
		SELECT 999, STUFF((
			SELECT DISTINCT ', ' + OA.Diagnoses  
			FROM ERS_OtherAbnormalities OA
			JOIN ERS_CommonAbnoOther CAO ON OA.OtherId = CAO.OtherId
			JOIN ERS_Sites S ON CAO.SiteId = s.SiteId
			WHERE S.ProcedureId = @ProcedureId
			FOR XML PATH('')), 1, 1, '') Code, 'D999P3'
	END

	IF ISNULL((SELECT CASE WHEN Abandoned = 1 OR NED_Abandoned = 1 THEN 1 ELSE 0 END FROM ERS_ColonExtentOfIntubation WHERE ProcedureId = @ProcedureId), 0) = 0
	BEGIN
		INSERT INTO #ColonTemp ([cx],[Text]) 
		SELECT 1, CONVERT(VARCHAR(MAX), 'The examination to the point of insertion was normal.') FROM #Colon WHERE MatrixCode = 'ColonNormal'
		UNION
		SELECT 2, 'The rest of the examination to the point of insertion was normal' FROM #Colon WHERE MatrixCode = 'ColonRestNormal'
	END
	ELSE
	BEGIN
		INSERT INTO #ColonTemp ([cx],[Text]) 
		SELECT 300, CONVERT(VARCHAR(MAX), 'Procedure abandoned')
	END

	INSERT INTO #ColonTemp ([cx],[Text])
	SELECT 4, MatrixCode FROM #Colon WHERE MatrixCode = 'Colitis'
	UNION
	SELECT 5, (SELECT m.DisplayName FROM ERS_DiagnosesMatrix m WHERE m.code= d.Value AND m.ProcedureTypeID = @ProcedureType)  FROM #Colon d WHERE d.MatrixCode = 'ColitisType' AND VALUE NOT IN ('D85P3', 'S85P3', 'P85P3') -- '?85P3' = None specified
	UNION
	SELECT 6, (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Diagnoses Colon Extent' AND [ListItemNo] = Value) FROM #Colon WHERE MatrixCode = 'ColitisExtent'
	UNION
	SELECT 7, (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Mayo Score' AND [ListItemNo] = Value) FROM #Colon WHERE MatrixCode = 'MayoScore'
	UNION
	SELECT 8, (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Simple Endoscopic Score  Crohn''s Disease' AND [ListItemNo] = Value) FROM #Colon WHERE MatrixCode = 'SEScore'
	UNION
	SELECT 9, MatrixCode FROM #Colon WHERE MatrixCode = 'Ileitis'
	UNION
	SELECT 10, MatrixCode FROM #Colon WHERE MatrixCode = 'Proctitis'
	UNION
	SELECT 0, LOWER(DisplayName) FROM #Colon WHERE RIGHT(MatrixCode,2) = 'P3'
	UNION
	SELECT 300, Value FROM #Colon WHERE MatrixCode = 'ColonOtherDiagnosis'
	

	IF EXISTS(select 1 from #ColonTemp)
	BEGIN
		SET @Summary = ''

		IF EXISTS(SELECT 1 FROM #ColonTemp WHERE cx =1) -- no need to check further if "point of insertion was normal"
			SET @Summary = (SELECT TOP 1 [text] from #ColonTemp where cx=1)
		ELSE 
		BEGIN
			--IF EXISTS(SELECT 1 FROM #ColonTemp WHERE cx IN (9)) --Ileitis checked
			--BEGIN
			--	SET @Summary = (SELECT TOP 1 [text] from #ColonTemp where cx=9)
			--END

			IF EXISTS(SELECT 1 FROM #ColonTemp WHERE cx IN (4, 9, 10)) --Colitis checked
			BEGIN
				DECLARE @ck varchar(1000) =''
				DECLARE @ms varchar(1000) = ''
				DECLARE @ses varchar(1000) = ''
				DECLARE @ColitisType VARCHAR(200) = ''
				IF EXISTS(SELECT 1 FROM #ColonTemp WHERE cx =6) 
					SET @ck=  (SELECT CASE @ck WHEN '' THEN (SELECT TOP 1 [text] from #ColonTemp where cx=6) ELSE @ck + ' ' + (SELECT TOP 1 [text] from #ColonTemp where cx=6) END)

				IF EXISTS(SELECT 1 FROM #ColonTemp WHERE cx =7) 
					SET @ms=  (SELECT CASE @ms WHEN '' THEN (SELECT TOP 1 [text] from #ColonTemp where cx=7) ELSE @ms + ' ' + (SELECT TOP 1 [text] from #ColonTemp where cx=7) END)

				IF EXISTS(SELECT 1 FROM #ColonTemp WHERE cx =8) 
					SET @ses=  (SELECT CASE @ses WHEN '' THEN (SELECT TOP 1 [text] from #ColonTemp where cx=8) ELSE @ses + ' ' + (SELECT TOP 1 [text] from #ColonTemp where cx=8) END)
				
				IF EXISTS(SELECT 1 FROM #ColonTemp WHERE cx = 9) --Ileitis checked
				BEGIN
					INSERT INTO #ColonTemp ([cx],[Text])  SELECT 50, 'Ileitis'
				END

				IF EXISTS(SELECT 1 FROM #ColonTemp WHERE cx =5) 
				BEGIN
					SET @ColitisType = ISNULL((SELECT TOP 1 [text] from #ColonTemp where cx=5),'')
				
					IF @ColitisType = '' SET @ColitisType = ISNULL((SELECT TOP 1 [text] from #ColonTemp where cx=4),'')

					IF @ms = '' AND @ses = ''
						SET @ColitisType = @ColitisType + (SELECT CASE @ck WHEN '' THEN '' ELSE ' (' + @ck +')' END)
					ELSE
					BEGIN
						IF @ms <> ''
							SET @ColitisType = @ColitisType + LOWER((SELECT CASE @ms WHEN '' THEN '' ELSE ': ' + @ms  END) + (SELECT CASE @ck WHEN '' THEN '' ELSE ', ' + @ck  END))
						
						IF @ses <> ''
							SET @ColitisType = @ColitisType + LOWER((SELECT CASE @ses WHEN '' THEN '' ELSE ': ' + @ses  END) + (SELECT CASE @ck WHEN '' THEN '' ELSE ', ' + @ck END))
					END
				END
				ELSE SET @ColitisType = LOWER((SELECT TOP 1 [text] from #ColonTemp where cx=4))

				--Concatnate text for colitis (4,5,6,7) and insert into #ColonTemp with id 100
				INSERT INTO #ColonTemp ([cx],[Text])  SELECT 100, @ColitisType

				IF EXISTS(SELECT 1 FROM #ColonTemp WHERE cx = 10) --Ileitis checked
				BEGIN
					INSERT INTO #ColonTemp ([cx],[Text])  SELECT 200, 'Proctitis'
				END
			END

			-- 0 = diag matrix ending with 'P3'  ;  100 = colitis   ;  300 = others
			SET @XMLlist = (SELECT [Text] AS Val FROM #ColonTemp WHERE [cx] in (0,50,100,200,300) ORDER BY [cx] FOR XML  RAW, ELEMENTS, TYPE)
			SET @Summary =  dbo.fnBuildString(@XMLlist) 

			SET @Summary = ISNULL((SELECT TOP 1 [text] + '.<br/>' FROM #ColonTemp WHERE cx=2),'')  + 
					CASE WHEN  @Summary <> '' THEN dbo.fnFirstLetterUpper(@Summary) + '.<br/>' ELSE '' END
		END

	END

	DROP TABLE #Colon
	DROP TABLE #ColonTemp
END
ELSE IF @ProcedureType IN (999) --Colonoscopy, Sigmoidscopy, Proctoscopy
BEGIN
	IF OBJECT_ID('tempdb..#Colon') IS NOT NULL DROP TABLE #ENT
	IF OBJECT_ID('tempdb..#ColonTemp') IS NOT NULL DROP TABLE #ENTTemp
		create table #ENTTemp ([cx] Int null,	[Text] VARCHAR(MAX) null)

	IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True','1') AND MatrixCode <> 'ColonNormal' )
	BEGIN
		DELETE [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'ColonNormal'
		DELETE #tbl_ERS_Diagnoses WHERE MatrixCode = 'ColonNormal'
	END;

	--Select first row in each group (in case there's more than 1 record for a given MatrixCode)
	WITH colSummary AS (
    SELECT p.DiagnosesID, p.MatrixCode, p.Value, p.Region,
           ROW_NUMBER() OVER(PARTITION BY p.MatrixCode ORDER BY p.DiagnosesID DESC) AS rk
    FROM #tbl_ERS_Diagnoses p)

	SELECT d.*, cast(m.DisplayName as varchar(500)) as DisplayName
	INTO #ENT
	FROM colSummary d 
	LEFT JOIN ERS_DiagnosesMatrix m ON d.matrixcode = m.Code AND m.ProcedureTypeID = @ProcedureType
	WHERE rk = 1 -- Get the first record only
	AND Region = 'Colon'	AND [Value] IS NOT NULL	AND [Value] <> 'False'
	AND [Value] <> ''		AND [Value] <> '0'		--AND MatrixCode <> 'Summary'

	If EXISTS(Select 1 from ERS_CommonAbnoOther CAO join ERS_Sites S On CAO.SiteId = s.SiteId where S.ProcedureId = @ProcedureId)
	BEGIN

		Insert into #ENT (DiagnosesID, DisplayName, MatrixCode)
		SELECT 999, STUFF((
			SELECT DISTINCT ', ' + OA.Diagnoses  
			FROM ERS_OtherAbnormalities OA
			JOIN ERS_CommonAbnoOther CAO ON OA.OtherId = CAO.OtherId
			JOIN ERS_Sites S ON CAO.SiteId = s.SiteId
			WHERE S.ProcedureId = @ProcedureId
			FOR XML PATH('')), 1, 1, '') Code, 'D999P9'
	END

	IF ISNULL((SELECT CASE WHEN Abandoned = 1 OR NED_Abandoned = 1 THEN 1 ELSE 0 END FROM ERS_ColonExtentOfIntubation WHERE ProcedureId = @ProcedureId), 0) = 0
	BEGIN
		INSERT INTO #ENTTemp ([cx],[Text]) 
		SELECT 1, CONVERT(VARCHAR(MAX), 'The examination to the point of insertion was normal.') FROM #ENT WHERE MatrixCode = 'ColonNormal'
		UNION
		SELECT 2, 'The rest of the examination to the point of insertion was normal' FROM #ENT WHERE MatrixCode = 'ColonRestNormal'
	END
	ELSE
	BEGIN
		INSERT INTO #ENTTemp ([cx],[Text]) 
		SELECT 300, CONVERT(VARCHAR(MAX), 'Procedure abandoned')
	END

	INSERT INTO #ENTTemp ([cx],[Text])
	SELECT 4, MatrixCode FROM #ENT WHERE MatrixCode = 'Colitis'
	UNION
	SELECT 5, (SELECT m.DisplayName FROM ERS_DiagnosesMatrix m WHERE m.code= d.Value AND m.ProcedureTypeID = @ProcedureType)  FROM #ENT d WHERE d.MatrixCode = 'ColitisType' AND VALUE NOT IN ('D85P3', 'S85P3', 'P85P3') -- '?85P3' = None specified
	UNION
	SELECT 6, (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Diagnoses Colon Extent' AND [ListItemNo] = Value) FROM #ENT WHERE MatrixCode = 'ColitisExtent'
	UNION
	SELECT 7, (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Mayo Score' AND [ListItemNo] = Value) FROM #ENT WHERE MatrixCode = 'MayoScore'
	UNION
	SELECT 8, (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Simple Endoscopic Score  Crohn''s Disease' AND [ListItemNo] = Value) FROM #ENT WHERE MatrixCode = 'SEScore'
	UNION
	SELECT 9, MatrixCode FROM #ENT WHERE MatrixCode = 'Ileitis'
	UNION
	SELECT 10, MatrixCode FROM #ENT WHERE MatrixCode = 'Proctitis'
	UNION
	SELECT 0, LOWER(DisplayName) FROM #ENT WHERE RIGHT(MatrixCode,2) = 'P9'
	UNION
	SELECT 300, Value FROM #ENT WHERE MatrixCode = 'ColonOtherDiagnosis'
	

	IF EXISTS(select 1 from #ENTTemp)
	BEGIN
		SET @Summary = ''

		IF EXISTS(SELECT 1 FROM #ENTTemp WHERE cx =1) -- no need to check further if "point of insertion was normal"
			SET @Summary = (SELECT TOP 1 [text] from #ENTTemp where cx=1)
		ELSE 
		BEGIN
			--IF EXISTS(SELECT 1 FROM #ColonTemp WHERE cx IN (9)) --Ileitis checked
			--BEGIN
			--	SET @Summary = (SELECT TOP 1 [text] from #ColonTemp where cx=9)
			--END

			IF EXISTS(SELECT 1 FROM #ENTTemp WHERE cx IN (4, 9, 10)) --Colitis checked
			BEGIN
				SET @ck =''
				SET @ms = ''
				SET @ses = ''
				SET @ColitisType = ''
				IF EXISTS(SELECT 1 FROM #ENTTemp WHERE cx =6) 
					SET @ck=  (SELECT CASE @ck WHEN '' THEN (SELECT TOP 1 [text] from #ENTTemp where cx=6) ELSE @ck + ' ' + (SELECT TOP 1 [text] from #ENTTemp where cx=6) END)

				IF EXISTS(SELECT 1 FROM #ENTTemp WHERE cx =7) 
					SET @ms=  (SELECT CASE @ms WHEN '' THEN (SELECT TOP 1 [text] from #ENTTemp where cx=7) ELSE @ms + ' ' + (SELECT TOP 1 [text] from #ENTTemp where cx=7) END)

				IF EXISTS(SELECT 1 FROM #ENTTemp WHERE cx =8) 
					SET @ses=  (SELECT CASE @ses WHEN '' THEN (SELECT TOP 1 [text] from #ENTTemp where cx=8) ELSE @ses + ' ' + (SELECT TOP 1 [text] from #ENTTemp where cx=8) END)
				
				IF EXISTS(SELECT 1 FROM #ENTTemp WHERE cx = 9) --Ileitis checked
				BEGIN
					INSERT INTO #ENTTemp ([cx],[Text])  SELECT 50, 'Ileitis'
				END

				IF EXISTS(SELECT 1 FROM #ENTTemp WHERE cx =5) 
				BEGIN
					SET @ColitisType = ISNULL((SELECT TOP 1 [text] from #ENTTemp where cx=5),'')
				
					IF @ColitisType = '' SET @ColitisType = ISNULL((SELECT TOP 1 [text] from #ENTTemp where cx=4),'')

					IF @ms = '' AND @ses = ''
						SET @ColitisType = @ColitisType + (SELECT CASE @ck WHEN '' THEN '' ELSE ' (' + @ck +')' END)
					ELSE
					BEGIN
						IF @ms <> ''
							SET @ColitisType = @ColitisType + LOWER((SELECT CASE @ms WHEN '' THEN '' ELSE ': ' + @ms  END) + (SELECT CASE @ck WHEN '' THEN '' ELSE ', ' + @ck  END))
						
						IF @ses <> ''
							SET @ColitisType = @ColitisType + LOWER((SELECT CASE @ses WHEN '' THEN '' ELSE ': ' + @ses  END) + (SELECT CASE @ck WHEN '' THEN '' ELSE ', ' + @ck END))
					END
				END
				ELSE SET @ColitisType = LOWER((SELECT TOP 1 [text] from #ENTTemp where cx=4))

				--Concatnate text for colitis (4,5,6,7) and insert into #ColonTemp with id 100
				INSERT INTO #ENTTemp ([cx],[Text])  SELECT 100, @ColitisType

				IF EXISTS(SELECT 1 FROM #ENTTemp WHERE cx = 10) --Ileitis checked
				BEGIN
					INSERT INTO #ENTTemp ([cx],[Text])  SELECT 200, 'Proctitis'
				END
			END

			-- 0 = diag matrix ending with 'P3'  ;  100 = colitis   ;  300 = others
			SET @XMLlist = (SELECT [Text] AS Val FROM #ENTTemp WHERE [cx] in (0,50,100,200,300) ORDER BY [cx] FOR XML  RAW, ELEMENTS, TYPE)
			SET @Summary =  dbo.fnBuildString(@XMLlist) 

			SET @Summary = ISNULL((SELECT TOP 1 [text] + '.<br/>' FROM #ENTTemp WHERE cx=2),'')  + 
					CASE WHEN  @Summary <> '' THEN dbo.fnFirstLetterUpper(@Summary) + '.<br/>' ELSE '' END
		END

	END

	DROP TABLE #ENT
	DROP TABLE #ENTTemp
END
IF EXISTS(SELECT 1 FROM #tbl_ERS_Diagnoses WHERE MatrixCode='Summary') UPDATE [ERS_Diagnoses] SET [Value] = @summary WHERE Procedureid=@ProcedureID AND MatrixCode='Summary'
ELSE INSERT INTO [ERS_Diagnoses] (ProcedureID,MatrixCode,[Value]) VALUES (@ProcedureID,'Summary', @Summary)

UPDATE ERS_ProceduresReporting SET PP_Diagnoses = @summary WHERE ProcedureId = @ProcedureId

IF ISNULL(@Summary,'') = '' AND NOT EXISTS (SELECT 1 FROM #tbl_ERS_Diagnoses WHERE [Value]<>'False' AND ISNULL([Value],'')<>'' AND MatrixCode <>'Summary')
	DELETE FROM ERS_RecordCount	WHERE [ProcedureId] = @ProcedureId AND [Identifier] = 'Diagnoses'
ELSE
	BEGIN
		IF NOT EXISTS (SELECT 1 FROM ERS_RecordCount WHERE [ProcedureId] = @ProcedureId AND [Identifier] = 'Diagnoses')
			INSERT INTO ERS_RecordCount ([ProcedureId], [SiteId], [Identifier], [RecordCount])
			VALUES (@ProcedureId, NULL, 'Diagnoses', 1)
	END

DROP TABLE #tbl_ERS_Diagnoses

--EXEC procedure_summary_update @procedureID

END TRY

BEGIN CATCH
       DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);
	
       IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;
GO

update dbo.ERS_DiagnosesMatrix SET code = 'DESDSCARP3' WHERE code = 'DESDSCARP9' AND ProcedureTypeID = 9
GO

update dbo.ERS_DiagnosesMatrix SET code = 'DOPOUCHITISP3' WHERE code = 'DOPOUCHITIS3' AND ProcedureTypeID = 9
GO


UPDATE ERS_DiagnosesMatrix SET NED_Name = 'Gallbladder tumour' WHERE NED_Name = 'Gallbladder tumor'
GO
UPDATE ERS_DiagnosesMatrix SET NED_Name = 'Pancreatic tumour' WHERE NED_Name = 'Pancreatic tumor'
GO
UPDATE ERS_DiagnosesMatrix SET NED_Name = 'Papillary tumour' WHERE NED_Name = 'Papillary tumor'
GO

ALTER FUNCTION [dbo].[tvfNED_Diagnoses]
(	
	 @ProcedureType AS INT
	, @ProcedureId AS INT
)
RETURNS @Diagnoses TABLE (
	Ned_Name VARCHAR(200),
	Tattooed VARCHAR(3),
	[site] VARCHAR(100),
	Comment  VARCHAR(1000),
	barrettsLengthCircumferential INT,
	barrettsLengthMaximum INT,
	barretsInspectionTime INT,
	gastricInspectiontime INT,
	oesophagitisLaClassification VARCHAR(2),
	DICAScore INT,
	UCEIS INT,
	mayoScore INT,
	rutgeertsScore VARCHAR(2),
	CDEIS INT
)
AS
BEGIN
	IF NOT EXISTS (SELECT 1 FROM ERS_Diagnoses WHERE ProcedureId = @ProcedureId AND MatrixCode NOT IN ('Summary','D138P2','D33P2', 'D51P2','D67P2'))
	BEGIN
		INSERT INTO @Diagnoses
		--## There are few Exception 'Diagnoses' Code.. Which doesn't exist int he DiagnosesMatrix.Code field. So- read them separately
			SELECT TOP 1 --## 'Top 1' Because- it can be like: "'OverallNormal', 'DuodenumNormal', 'OesophagusNormal', 'StomachNormal'"- and we need only once to show 'Normal!'
				  'Normal' AS Ned_Name
				, NULL	AS Tattooed
				, 'None' AS site		
				, NULL	AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL AS oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
	END
	ELSE IF EXISTS (SELECT 1 FROM ERS_Diagnoses WHERE ProcedureId = @ProcedureId AND MatrixCode = 'OverallNormal')
	BEGIN
		INSERT INTO @Diagnoses
		--## There are few Exception 'Diagnoses' Code.. Which doesn't exist int he DiagnosesMatrix.Code field. So- read them separately
			SELECT TOP 1 --## 'Top 1' Because- it can be like: "'OverallNormal', 'DuodenumNormal', 'OesophagusNormal', 'StomachNormal'"- and we need only once to show 'Normal!'
				  'Normal' AS Ned_Name
				, NULL	AS Tattooed
				, 'None' AS site		
				, NULL	AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL AS oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
	END
	ELSE IF EXISTS (SELECT 1 FROM ERS_Diagnoses WHERE ProcedureId = @ProcedureId AND MatrixCode = 'ColonNormal')
	BEGIN
		INSERT INTO @Diagnoses
		--## There are few Exception 'Diagnoses' Code.. Which doesn't exist int he DiagnosesMatrix.Code field. So- read them separately
			SELECT TOP 1 --## 'Top 1' Because- it can be like: "'OverallNormal', 'DuodenumNormal', 'OesophagusNormal', 'StomachNormal'"- and we need only once to show 'Normal!'
				  'Normal' AS Ned_Name
				, NULL	AS Tattooed
				, 'None' AS site		
				, NULL	AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL AS oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
	END
	ELSE
	BEGIN
		INSERT INTO @Diagnoses
		   SELECT 'Colorectal cancer' AS Ned_Name
				, CASE WHEN ISNULL(T.TattooedId, 0) = 1 THEN 'No' WHEN ISNULL(T.TattooedId, 0) = 2 THEN 'Yes' END AS tattooed	--## 'Colonic polyps or Rectal polyps' => Colon/FLexi ONLY! 
				, dbo.fnNED_GetBiopsySiteName(P.ProcedureId, R.Region) AS Site		--## Location of tattoo. BiopsyEnum (Page 42, in Business Spec.doc v.1.15): The Biopsy field is procedure specific. See the BiopsyEnum table for further information.
				, NULL AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL AS oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
			 FROM [dbo].[ERS_Diagnoses] D
		--LEFT JOIN [dbo].[ERS_DiagnosesMatrix]	AS M ON D.MatrixCode = M.Code
		LEFT JOIN [dbo].[ERS_Procedures]		AS P ON D.ProcedureID = P.ProcedureId
		LEFT JOIN dbo.ERS_Sites		AS S ON D.SiteId = S.SiteId
		LEFT JOIN dbo.ERS_Regions	AS R ON S.RegionId = R.RegionId
		LEFT JOIN dbo.ERS_ColonAbnoTumour T ON T.SiteId = S.SiteID
			WHERE D.ProcedureId= @ProcedureId
			  AND P.ProcedureType IN(3,4,9)	--## Only for OGD/Colon/FLEXI! NOT for ERCP! - NO, Colon and Flexi only. How can you get colon cancer in an OGD procedure? - Don't forget ENT procedures, but really, we don't need this line as it should be taken care of by the matrix code on the next line
			  AND D.MatrixCode IN ('S69P3', 'D69P3')  --## 'Colorectal cancer'

		UNION ALL
		SELECT 'Barrett''s oesophagus' AS Ned_Name
				, NULL AS tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END AS [Site]
				, NULL AS Comment
				, B.DistanceM2 AS barrettsLengthCircumferential
				, B.DistanceM1 AS barrettsLengthMaximum
				, B.InspectionTimeMins AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
			 FROM [dbo].[ERS_Diagnoses] D
		LEFT JOIN [dbo].[ERS_Procedures]		AS P ON D.ProcedureID = P.ProcedureId
		LEFT JOIN dbo.ERS_Sites		AS S ON D.SiteId = S.SiteId
		LEFT JOIN ERS_Regions		AS R ON R.RegionId = S.RegionId
		left join dbo.ERS_UpperGIAbnoBarrett AS B on B.SiteId = S.SiteId 
			WHERE D.ProcedureId= @ProcedureId 
			  AND P.ProcedureType IN(1, 2, 6, 8)	--## Only for upper procedures
			  AND D.MatrixCode IN ('D23P1')  --## Barrett's oesophagus

		UNION ALL
		SELECT 'Gastric atrophy' AS Ned_Name
				, NULL AS tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END As [Site]	
				, NULL AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, datediff(minute, G.GastricInspectionStartDateTime, G.GastricInspectionEndDateTime) AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
			 FROM [dbo].[ERS_Diagnoses] D
		--LEFT JOIN [dbo].[ERS_DiagnosesMatrix]	AS M ON D.MatrixCode = M.Code
		LEFT JOIN [dbo].[ERS_Procedures]		AS P ON D.ProcedureID = P.ProcedureId
		LEFT JOIN dbo.ERS_Sites		AS S ON D.SiteId = S.SiteId
		LEFT JOIN ERS_Regions		AS R ON R.RegionId = S.RegionId
		left join dbo.ERS_UpperGIAbnoGastritis AS G on G.SiteId = S.SiteId 
			WHERE D.ProcedureId= @ProcedureId
			  AND P.ProcedureType IN(1, 2, 6, 8)	--## Only for upper procedures
			  AND D.MatrixCode IN ('N2006')

		UNION ALL
		SELECT top 1 M.NED_Name
				, NULL AS tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END As [Site]
				, NULL AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, CASE O.LAClassification 
					WHEN 1 THEN 'A'
					WHEN 2 THEN 'B'
					WHEN 3 THEN 'C'
					WHEN 4 THEN 'D'
				  END as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
			 FROM [dbo].[ERS_Diagnoses] D
		LEFT JOIN [dbo].[ERS_DiagnosesMatrix]	AS M ON D.MatrixCode = M.Code
		LEFT JOIN [dbo].[ERS_Procedures]		AS P ON D.ProcedureID = P.ProcedureId
		LEFT JOIN dbo.ERS_Sites		AS S ON D.SiteId = S.SiteId
		LEFT JOIN ERS_Regions		AS R ON R.RegionId = S.RegionId
		left join dbo.ERS_UpperGIAbnoOesophagitis AS O on O.SiteId = S.SiteId 
			WHERE D.ProcedureId= @ProcedureId
			  AND P.ProcedureType IN(1, 2, 6, 8)	--## Only for upper procedures
			  AND D.MatrixCode IN ('D36P1') --Oesophagitis - reflux

		UNION ALL	
		select DISTINCT --## DISTINCT REQUIRED- When in Stomach- 3 sites - all has Polyps and Gastric- then they will repeat.
				  'Other'
				, NULL	AS Tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END As [Site]		
				, eugm.MiscOther AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
		FROM ERS_diagnoses AS D
		INNER JOIN [dbo].[ERS_DiagnosesMatrix] AS M ON D.MatrixCode = M.Code
		INNER JOIN ERS_Sites S ON D.SiteId = S.SiteId
			INNER JOIN ERS_Regions R ON s.RegionId = R.RegionId
			INNER JOIN dbo.ERS_UpperGIAbnoMiscellaneous eugm ON S.SiteId = eugm.SiteId
		where D.ProcedureId= @ProcedureId 
			AND M.NED_Include = 1
			AND M.ProcedureTypeID = @ProcedureType
			AND M.DisplayName = 'Other'
		
		UNION ALL	-- dbo.fnNED_GetBiopsySiteName(P.ProcedureId, R.Region)
		select DISTINCT --## DISTINCT REQUIRED- When in Stomach- 3 sites - all has Polyps and Gastric- then they will repeat.
				  'Other'
				, NULL	AS Tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END As [Site]		
				, eugm.OtherDesc AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
		FROM ERS_diagnoses AS D
		INNER JOIN [dbo].[ERS_DiagnosesMatrix] AS M ON D.MatrixCode = M.Code
		INNER JOIN ERS_Sites S ON D.SiteId = S.SiteId
			INNER JOIN ERS_Regions R ON s.RegionId = R.RegionId
			INNER JOIN dbo.ERS_CommonAbnoDiverticulum eugm ON S.SiteId = eugm.SiteId
		where D.ProcedureId= @ProcedureId 
			AND M.NED_Include = 1
			AND M.ProcedureTypeID = @ProcedureType
			AND M.DisplayName = 'Other'
		UNION ALL
		select DISTINCT --## DISTINCT REQUIRED- When in Stomach- 3 sites - all has Polyps and Gastric- then they will repeat.
				  'Other'
				, NULL	AS Tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END As [Site]		
				, eugm.Other AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
		FROM ERS_diagnoses AS D
		INNER JOIN [dbo].[ERS_DiagnosesMatrix] AS M ON D.MatrixCode = M.Code
		INNER JOIN ERS_Sites S ON D.SiteId = S.SiteId
			INNER JOIN ERS_Regions R ON s.RegionId = R.RegionId
			INNER JOIN dbo.ERS_ERCPAbnoDiverticulum eugm ON S.SiteId = eugm.SiteId
		where D.ProcedureId= @ProcedureId 
			AND M.NED_Include = 1
			AND M.ProcedureTypeID = @ProcedureType
			AND M.DisplayName = 'Other'
		UNION ALL
		select DISTINCT --## DISTINCT REQUIRED- When in Stomach- 3 sites - all has Polyps and Gastric- then they will repeat.
				  'Other'
				, NULL	AS Tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE dbo.fnNED_GetBiopsySiteName(S.ProcedureId, R.Region) END As [Site]		
				, eugm.Other AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
		FROM ERS_diagnoses AS D
		INNER JOIN [dbo].[ERS_DiagnosesMatrix] AS M ON D.MatrixCode = M.Code
		INNER JOIN ERS_Sites S ON D.SiteId = S.SiteId
			INNER JOIN ERS_Regions R ON s.RegionId = R.RegionId
			INNER JOIN dbo.ERS_ColonAbnoMiscellaneous eugm ON S.SiteId = eugm.SiteId
		where D.ProcedureId= @ProcedureId 
			AND M.NED_Include = 1
			AND M.ProcedureTypeID = @ProcedureType
			AND M.DisplayName = 'Other'
		UNION ALL				
		select DISTINCT --## DISTINCT REQUIRED- When in Stomach- 3 sites - all has Polyps and Gastric- then they will repeat.
				  M.Ned_Name
				, NULL	AS Tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END As [Site]		
				, NULL	AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
		FROM ERS_diagnoses AS D
		INNER JOIN [dbo].[ERS_DiagnosesMatrix] AS M ON D.MatrixCode = M.Code
		INNER JOIN ERS_Sites S ON D.SiteId = S.SiteId
			INNER JOIN ERS_Regions R ON s.RegionId = R.RegionId
		where D.ProcedureId= @ProcedureId 
			AND M.Ned_Name IS NOT NULL --## I mean select the 'NED Mapped' fields ONLY!
			AND M.NED_Include = 1
			AND M.ProcedureTypeID = @ProcedureType
			AND D.MatrixCode NOT IN ('D70P3', 'S69P3', 'D69P3', 'D23P1', 'N2006', 'D36P1', 'D86P3', 'D96P3', 'S96P3', 'D1P3', 'N2015','S1P3','D1P3','P1P3','D1P9') -- don't include Colorectal cancer, barretts, Gastric atrophy, Oesophagitis, Diverticulosis - reflux or proctitus, they are already done 
			AND M.DisplayName <> 'Other'

		UNION ALL					--## Combine 'OTHER' type of Diagnoses! Which Doesn't have a NED Name mapping!
			select top 1
			  'Other' AS DisplayName
			, NULL	AS Tattooed
			, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END As [Site]				
		
			, 
			(select 
				  (/*Section + ' ' +*/ M.DisplayName) + ', ' 
			FROM ERS_diagnoses AS D 
			LEFT JOIN [dbo].[ERS_DiagnosesMatrix] AS M ON D.MatrixCode = M.Code
			where D.ProcedureId= @ProcedureId
				AND M.Ned_Name IS NULL --## 'NED Mapped' is Missing
				--AND D.MatrixCode NOT IN ('D198P2', 'D265P2', 'D32P2', 'D33P2', 'D51P2', 'D67P2','D138P2') --## Diagnoses thinks these Exceptions belongs to others.. Because these are not Mapped to NED seperately
				AND D.MatrixCode not in ('N257P1', 'D70P3', 'D21P3', 'S21P3', 'D100P1','N2016', 'SN2016', 'N100P2') -- Could be NED field for Chrones, need to work that out, see next select
				AND M.NED_Include = 1
				AND D.SiteId = S.SiteId
				AND M.ProcedureTypeID = @ProcedureType
				FOR XML PATH('')
			) AS Comment		--## All the fields which are not in the 'NED Restricted Lookup' list!
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
		FROM ERS_diagnoses AS D
		INNER JOIN [dbo].[ERS_DiagnosesMatrix] AS M ON D.MatrixCode = M.Code --## InnerJoin- to avoid keeping anything which Codes (Summary, OverallNormal) don't exist in the Matrix Table.. WIll exclude them...
		INNER JOIN ERS_Sites S ON D.SiteId = S.SiteId
			INNER JOIN ERS_Regions R ON s.RegionId = R.RegionId
			where D.ProcedureId= @ProcedureId
			AND M.Ned_Name IS NULL --## Means when 'NED Mapped' is Missing- those belong to 'Other' type 
			AND D.MatrixCode not in ('N257P1', 'D21P3', 'S21P3', 'D100P1','N2016', 'SN2016', 'N100P2')
			AND M.NED_Include = 1
			AND M.ProcedureTypeID = @ProcedureType
		UNION ALL
			Select top 1 'Crohn''s - terminal ileum'
				, NULL	AS Tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE dbo.fnNED_GetBiopsySiteName(S.ProcedureId, R.Region) END As [Site]		
				, NULL	AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, CASE WHEN dbo.fnNED_ProcedureExtent(@ProcedureId, 0) = 'Neo-terminal ileum' THEN rs.NEDTerm ELSE NULL END AS rutgeertsScore
				, CDEISScore AS CDEIS
			FROM ERS_ColonAbnoMucosa C
			join ERS_Sites S on S.SiteId = C.SiteId
			INNER JOIN ERS_Regions R ON S.RegionId = R.RegionId
			LEFT JOIN ERS_RutgeertsScores rs ON rs.UniqueId = C.RutgeertsScore
			where C.InflammatoryIleitis	 = 1 AND c.InflammatoryDisorder = 2
			AND S.ProcedureId = @ProcedureId 
		UNION ALL
			Select top 1 'Crohn''s colitis'
				, NULL	AS Tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE dbo.fnNED_GetBiopsySiteName(S.ProcedureId, R.Region) END As [Site]		
				, NULL	AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, CASE WHEN dbo.fnNED_ProcedureExtent(@ProcedureId, 0) = 'Neo-terminal ileum' THEN rs.NEDTerm ELSE NULL END AS rutgeertsScore
				, CDEISScore AS CDEIS
			FROM ERS_ColonAbnoMucosa C
			join ERS_Sites S on S.SiteId = C.SiteId
			INNER JOIN ERS_Regions R ON S.RegionId = R.RegionId
			LEFT JOIN ERS_RutgeertsScores rs ON rs.UniqueId = C.RutgeertsScore
			where C.InflammatoryColitis = 1 AND c.InflammatoryDisorder = 2
			AND S.ProcedureId = @ProcedureId 

		UNION ALL
			Select top 1 'Proctitis'
				, NULL	AS Tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END As [Site]		
				, NULL	AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
			FROM ERS_ColonAbnoMucosa C
			join ERS_Sites S on S.SiteId = C.SiteId
			INNER JOIN ERS_Regions R ON S.RegionId = R.RegionId
			where C.InflammatoryProctitis = 1
			AND S.ProcedureId = @ProcedureId 
	
	
		UNION ALL
			Select top 1 'Colitis - unspecified'
				, NULL	AS Tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END As [Site]		
				, NULL	AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
			FROM ERS_ColonAbnoMucosa C
			join ERS_Sites S on S.SiteId = C.SiteId
			INNER JOIN ERS_Regions R ON S.RegionId = R.RegionId
			where C.InflammatoryDisorder = 1
			AND S.ProcedureId = @ProcedureId 

		UNION ALL
			Select top 1 'Colitis - pseudomembranous'
				, NULL	AS Tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END As [Site]		
				, NULL	AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
			FROM ERS_ColonAbnoMucosa C
			join ERS_Sites S on S.SiteId = C.SiteId
			INNER JOIN ERS_Regions R ON S.RegionId = R.RegionId
			where C.InflammatoryDisorder = 10
			AND S.ProcedureId = @ProcedureId 

		UNION ALL
			Select top 1 'Colitis - ischemic'
				, NULL	AS Tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END As [Site]		
				, NULL	AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
			FROM ERS_ColonAbnoMucosa C
			join ERS_Sites S on S.SiteId = C.SiteId
			INNER JOIN ERS_Regions R ON S.RegionId = R.RegionId
			where C.InflammatoryDisorder = 8
			AND S.ProcedureId = @ProcedureId 

		UNION ALL
			Select top 1 'Diverticulosis'
				, NULL	AS Tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END As [Site]		
				, NULL	AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, isnull(ePoints.Points, 0) + isnull(GPoints.Points, 0) + isnull(IPoints.points, 0) + isnull(CPoints.Points, 0) AS DICAScore -- THIS IS NEEDED HERE
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
			FROM ERS_ColonAbnoMucosa C
			join ERS_Sites S on S.SiteId = C.SiteId
			INNER JOIN ERS_Regions R ON S.RegionId = R.RegionId
			JOIN ERS_ProcedureDICAScores D on S.SiteId = D.SiteId 
			left join ERS_DICAScores ePoints on D.ExtensionId = ePoints.UniqueId
			left join ERS_DICAScores GPoints on D.GradeId = gPoints.UniqueId
			left join ERS_DICAScores iPoints on D.InflammatorySignsId = iPoints.UniqueId
			left join ERS_DICAScores CPoints on D.ComplicationsId = cPoints.UniqueId
			where C.InflammatoryDisorder = 4
			AND S.ProcedureId = @ProcedureId 
		
		UNION ALL
			Select top 1 'Diverticulosis'
				, NULL	AS Tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END As [Site]		
				, NULL	AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, isnull(ePoints.Points, 0) + isnull(GPoints.Points, 0) + isnull(IPoints.points, 0) + isnull(CPoints.Points, 0) AS DICAScore -- THIS IS NEEDED HERE
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
			FROM ERS_ColonAbnoDiverticulum C
			INNER join ERS_Sites S on S.SiteId = C.SiteId
			INNER JOIN ERS_Regions R ON S.RegionId = R.RegionId
			INNER JOIN ERS_ProcedureDICAScores D on S.SiteId = D.SiteId 
			INNER join ERS_DICAScores ePoints on D.ExtensionId = ePoints.UniqueId
			INNER join ERS_DICAScores GPoints on D.GradeId = gPoints.UniqueId
			INNER join ERS_DICAScores iPoints on D.InflammatorySignsId = iPoints.UniqueId
			INNER join ERS_DICAScores CPoints on D.ComplicationsId = cPoints.UniqueId
			AND S.ProcedureId = @ProcedureId 
		UNION ALL
			Select top 1 'Ulcerative colitis'
				, NULL	AS Tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE isnull(R.NED_Term, 'Colon') END As [Site]		
				, NULL	AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, (Select sum(points) from ERS_UCEISScores where UniqueId in (VascularPatternUCEISScore, BleedingUCEISScore, ErosionsUCEISScore)) AS UCEIS
				, InflammatoryMayoScore AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
			FROM ERS_ColonAbnoMucosa C
			join ERS_Sites S on S.SiteId = C.SiteId
			Left JOIN ERS_Regions R ON s.RegionId = R.RegionId
			where C.InflammatoryDisorder = 12
			AND S.ProcedureId = @ProcedureId 

		

		UNION ALL--## Handles colotis diagnosis as the diagnoses matrix table is joined on ERS_Diagnoses 'value' column rather than the 'code' column
			SELECT 
			  ISNULL(NED_Name,'Colitis - unspecified') AS NED_Name
			, NULL	AS Tattooed
			, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END As [Site]		
			, NULL	AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
			FROM ERS_Diagnoses d
				INNER JOIN dbo.ERS_DiagnosesMatrix edm	ON code=value
			INNER JOIN ERS_Sites S ON S.SiteId = d.SiteId
			INNER JOIN ERS_Regions R ON S.RegionId = R.RegionId
			WHERE d.MatrixCode='ColitisType'  AND d.procedureid=@ProcedureId	
			AND edm.ProcedureTypeID = @ProcedureType

		UNION ALL
		SELECT DISTINCT --## DISTINCT REQUIRED- When in Stomach- 3 sites - all has Polyps and Gastric- then they will repeat.
					  M.Ned_Name
					, NULL AS tattooed	--## 'Colonic polyps or Rectal polyps' => Colon/FLexi ONLY! 
					, 'Colon' As [Site]		
					, NULL	AS Comment
					, NULL AS barrettsLengthCircumferential
					, NULL AS barrettsLengthMaximum
					, NULL AS barretsInspectionTime
					, NULL AS gastricInspectiontime
					, NULL as oesophagitisLaClassification
					, NULL AS DICAScore
					, NULL AS UCEIS
					, NULL AS mayoScore
					, NULL AS rutgeertsScore
					, NULL AS CDEIS
			FROM ERS_diagnoses AS D
			INNER JOIN [dbo].[ERS_DiagnosesMatrix] AS M ON D.MatrixCode = M.Code
			INNER JOIN ERS_Sites S ON D.SiteId = S.SiteId
			where D.ProcedureId= @ProcedureId 
				AND M.Ned_Name IS NOT NULL --## I mean select the 'NED Mapped' fields ONLY!
				AND M.NED_Include = 1
				AND M.ProcedureTypeID = @ProcedureType
				AND SiteNo = -77 --site by distance diagnoses
				and M.Ned_Name <> 'Ulcerative Colitis'
	
	END
	If (Select 1 from @Diagnoses where Ned_Name = 'Gastric atrophy') > 0
		Delete from @Diagnoses where Ned_Name = 'Gastritis - non-erosive'

	RETURN ;
END

/* columns returned
   ----------------
    Ned_Name
    Tattooed
    Comment
	barrettsLengthCircumferential	--Required for diagnosis of Barretts
	barrettsLengthMaximum			--Required for diagnosis of Barretts
	barretsInspectionTime			--Required for diagnosis of Barretts
	gastricInspectiontime			--Required if diagnosis of gastric atrophy OR gastric intestinal metaplasia
	oesophagitisLaClassification	--Required if diagnosis of Oesophagitis - reflux
	DICAScore						--required if diagnosis of Diverticulosis
	UCEIS							--If diagnosis is Ulcerative Colitis both UCEIS and Mayo scores must be provided
	mayoScore						--If diagnosis is Ulcerative Colitis both UCEIS and Mayo scores must be provided
	site							--If diagnosis is Crohns Colitis or Crohn`s- terminal ileum and [ExtentLookup]= Neo-terminal ileum
	rutgeertsScore					--If diagnosis is Crohns Colitis or Crohn`s- terminal ileum and [ExtentLookup]= Neo-terminal ileum
	CDEIS							--If diagnosis is Crohns Colitis or Crohn`s- terminal ileum
*/
GO




------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO



ALTER PROCEDURE [dbo].[procedure_upper_extent_save]
(
	@ProcedureId int,
	@ExtentId int,
	@AdditionalInfo varchar(max),
	@EndoscopistId int,
	@JManoeuvreId int, 
	@LimitedById int, 
	@WithdrawalMins int,
	@MucosalJunctionDistance int,
	@LimitationOther varchar(max),
	@LoggedInUserId int
)
AS
/*
--	Update History
01.			04 Jan 2023		MH added Order Message Send block while saving Extent of Intubation TFS #2475
							No extra parameter required. ProcedureId will have associated OrderId and Extent Limited By value
02.			21 March 2023	AJ j manouver handled if -1 (not specified)
03.			27 March 2023	AJ Set sections as not entered based on the extent reached
04.			08 June 2023	SG Add call to ogd_diagnoses_summary_update to ensure report gets populated with Normal if no abnormalities are added
05.         08 Nov 2023     MS Add MucosalJunctionDistance column and related logic
							
*/
BEGIN
	Declare @bitHasProcedureFailed as bit
	Set @bitHasProcedureFailed = 0

	IF NOT EXISTS (SELECT 1 FROM ERS_ProcedureUpperExtent WHERE ProcedureId = @ProcedureId AND EndoscopistId = @EndoscopistId)
	BEGIN
		INSERT INTO ERS_ProcedureUpperExtent (ProcedureId, ExtentId, AdditionalInfo, EndoscopistId, JManoeuvreId, LimitationId, MucosalJunctionDistance, WhoUpdatedId, WhenUpdated, LimitationOther)
		VALUES (@ProcedureId, NULLIF(@ExtentId,0), NULLIF(@AdditionalInfo,''), @EndoscopistId, NULLIF(@JManoeuvreId,-1), NULLIF(@LimitedById,0), NULLIF(@MucosalJunctionDistance,0), @LoggedInUserId, getdate(), NULLIF(@LimitationOther,''))
	END
	ELSE
	BEGIN

		/*Check if new values been added for limitations */
		IF ISNULL(@LimitationOther,'') <> ''
		BEGIN
			IF NOT EXISTS (SELECT 1 FROM dbo.ERS_Limitations WHERE Description = @LimitationOther)
			BEGIN
				/*get and set the new items order id so it appears 1 above 'other' we always want other to be last*/

				DECLARE @OtherListOrderBy_l int = (SELECT ListOrderBy FROM ERS_Limitations WHERE Description = 'Other')
				INSERT INTO ERS_Limitations (Description, NEDTerm, ListOrderBy) VALUES (@LimitationOther, 'Other', @OtherListOrderBy_l)
			
				UPDATE dbo.ERS_Limitations SET ListOrderBy = @OtherListOrderBy_l + 1 WHERE Description = 'Other'
		

			SELECT @LimitedById = UniqueId FROM ERS_Limitations WHERE Description = @LimitationOther
		
			DECLARE @ProcTypeId int = (SELECT ProcedureType FROM ERS_Procedures WHERE ProcedureId = @ProcedureId)
			INSERT INTO ERS_LimitationProcedureTypes (ProcedureTypeId, LimitationId) VALUES (@ProcTypeId, @LimitedById)
			END
			ELSE
				SELECT @LimitedById = UniqueId FROM ERS_Limitations WHERE Description = @LimitationOther
		END 

		UPDATE ERS_ProcedureUpperExtent
		SET 
			ExtentId = NULLIF(@ExtentId,0),
			AdditionalInfo = NULLIF(@AdditionalInfo,''),
			EndoscopistId = @EndoscopistId,
			JManoeuvreId = NULLIF(@JManoeuvreId,-1),
			LimitationId = NULLIF(@LimitedById,0),
			MucosalJunctionDistance = NULLIF(@MucosalJunctionDistance,0),
			WhoUpdatedId = @LoggedInUserId,
			WhenUpdated = getdate(),
			LimitationOther = NULLIF(@LimitationOther,'')
		WHERE 
			ProcedureId = @ProcedureId AND
			EndoscopistId = @EndoscopistId
	END

	DECLARE @SectionId int, @ProceureTypeId int, @ExtentIsSuccess bit, @ExtentDescription varchar(200), @SummaryText varchar(max) = ''
	SELECT @SectionID = UISectionId FROM UI_Sections WHERE SectionName = 'Extent'

	SELECT @ProceureTypeId = ProcedureType FROM ERS_Procedures WHERE ProcedureId = @ProcedureId
	
	/*Furthest extent*/
	SELECT TOP 1 @ExtentDescription = ee.Description, @AdditionalInfo = epue.AdditionalInfo, @ExtentIsSuccess = ee.IsSuccess
								FROM dbo.ERS_ProcedureUpperExtent epue 
									INNER JOIN dbo.ERS_Extent ee ON epue.ExtentId = ee.UniqueId
								WHERE epue.ProcedureId=@ProcedureId
								ORDER BY ee.ListOrderBy DESC
	
	/*Handle failed procedures*/
	IF @ExtentDescription IN ('intubation failed','abandoned')
	Begin
		EXEC diagnoses_set_procedure_failed @ProcedureId
		Set @bitHasProcedureFailed = 1
	END
    
	IF ISNULL(@MucosalJunctionDistance,0) > 0
	BEGIN

		SET @SummaryText = 'The apparent mucosal junction: ' + @MucosalJunctionDistance + 'cm'
	END

	IF (SELECT COUNT(*) FROM ERS_ProcedureUpperExtent WHERE ProcedureId = @ProcedureId AND NULLIF(JManoeuvreId,-1) IS NOT NULL) > 0
	BEGIN
		DECLARE @JManouvreResult varchar(100)

		/*Overall JManouvre result regardless of who done it, was it done*/
		IF EXISTS (SELECT 1 FROM ERS_ProcedureUpperExtent WHERE ProcedureId = @ProcedureId AND ISNULL(JManoeuvreId,0) = 1)
			SET @JManouvreResult = 'performed. '
		ELSE
			SET @JManouvreResult = 'not carried out. '

		SET @SummaryText = @SummaryText + 'J manoeuvre ' + @JManouvreResult
	END
		
	SET @SummaryText = @SummaryText +   
						CASE LOWER(@ExtentDescription )
							WHEN 'intubation failed' THEN 'Failed intubation' + CASE WHEN ISNULL(@AdditionalInfo,'') <> '' THEN ': ' + @AdditionalInfo ELSE '' END
							WHEN 'abandoned' THEN 'Procedure failed (abandoned)' + CASE WHEN ISNULL(@AdditionalInfo,'') <> '' THEN ': ' + @AdditionalInfo ELSE '' END
							WHEN 'other' THEN  'Procedure failed' + CASE WHEN ISNULL(@AdditionalInfo,'') <> '' THEN ': ' + @AdditionalInfo ELSE '' END
							ELSE 'The procedure was completed successfully to the ' + @ExtentDescription
						END
	--limited by...?
	IF ISNULL(@LimitedById, 0) > 0
	BEGIN
		SET @SummaryText = @SummaryText + ' but limited by ' + (SELECT LOWER(Description) FROM ERS_Limitations WHERE UniqueId = @LimitedById)
	END

	IF ISNULL(@SummaryText,'') <> ''
	BEGIN
		UPDATE ERS_ProcedureUpperExtent
		SET Summary = @SummaryText
		WHERE ProcedureId = @ProcedureId

		EXEC procedure_summary_update @ProcedureId
	END
	
	DECLARE @Summary VARCHAR(max) = 'Extent:'


	--remove complete section entry incase conditions no longer apply. Will get re-evaluated after
	EXEC UI_update_procedure_summary @ProcedureId, 'Extent', @Summary, 0, @EndoscopistId

	--Check if the Extent has reached or exceeded the planned extent, if so mark as success
	IF @ExtentId > 0 
	BEGIN
		DECLARE @ExtentListOrder int = (SELECT ListOrderBy FROM ERS_Extent WHERE UniqueId = @ExtentId)
		DECLARE @PlannedExtentListOrder int = (SELECT e.ListOrderBy FROM ERS_ProcedurePlannedExtent ppe JOIN ERS_Extent e ON e.UniqueId = ppe.ExtentId WHERE ppe.ProcedureId = @ProcedureId)

		IF (@ExtentListOrder >= @PlannedExtentListOrder AND @ExtentListOrder > 0)
				SET @ExtentIsSuccess = 1
	END

	IF @ExtentId > 0 AND @ExtentIsSuccess = 1
		EXEC UI_update_procedure_summary @ProcedureId, 'Extent', 'Extent:', @ExtentId, @EndoscopistId
	ELSE IF @ExtentIsSuccess = 0 AND @LimitedById > 1
	BEGIN
		IF (SELECT LOWER(NEDTerm) FROM dbo.ERS_Limitations WHERE UniqueId = @LimitedById) = 'other'
		BEGIN
			IF ISNULL(@LimitationOther,'') <> ''
			BEGIN
				EXEC UI_update_procedure_summary @ProcedureId, 'Extent', 'Extent:' , @ExtentId, @EndoscopistId
			END
		END
		ELSE
		BEGIN
			EXEC UI_update_procedure_summary @ProcedureId, 'Extent', 'Extent:', @ExtentId, @EndoscopistId
		END
	END

	IF ISNULL(@WithdrawalMins,0) > 0
	BEGIN
		EXEC UI_update_procedure_summary @ProcedureId, 'Total withdrawal time', 'Total withdrawal time:', 1, @EndoscopistId
	END

	IF @JManoeuvreId > -1
	BEGIN
		EXEC UI_update_procedure_summary @ProcedureId, 'JManoevre', 'JManoevre:', 1, @EndoscopistId
	END
	ELSE
	BEGIN
		EXEC UI_update_procedure_summary @ProcedureId, 'JManoevre', 'JManoevre:', 0 , @EndoscopistId
	END
	
	--MH Added on 04 Jan 2023 
	Exec usp_SendIntubationExtentOrderMessageByProcedureId @ProcedureId, @bitHasProcedureFailed, @LoggedInUserId

	EXEC ogd_diagnoses_summary_update @ProcedureID

	--Handle unentered sections
	DECLARE @MatrixCode VARCHAR(100)

	--based on extent reached
	IF LOWER(@ExtentDescription)= 'oesophagus'
	BEGIN
		--if Oesophagus then Stomach and Duodenum not entered
		EXEC dbo.diagnoses_control_save @SiteID = 0,               -- int
		                                @DiagnosesMatrixCode = 'StomachNotEntered', -- varchar(50)
		                                @Value = 'true'                -- varchar(50)
		
		EXEC dbo.diagnoses_control_save @SiteID = 0,               -- int
		                                @DiagnosesMatrixCode = 'DuodenumNotEntered', -- varchar(50)
		                                @Value = 'true'                -- varchar(50)
	END
	IF LOWER(@ExtentDescription)= 'stomach'
	BEGIN
		--if stomach Duodenum not entered
		EXEC dbo.diagnoses_control_save @SiteID = 0,               -- int
		                                @DiagnosesMatrixCode = 'DuodenumNotEntered', -- varchar(50)
		                                @Value = 'true'                -- varchar(50)
		
	END
END


GO


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 22.01.24
-- TFS#	
-- Description of change
-- Overwritten SPs replaced
------------------------------------------------------------------------------------------------------------------------
GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO


---------------- Added by MH	On	31 Jan 2024
GO
/****** Object:  StoredProcedure [dbo].[DropIfExist]    Script Date: 31/01/2024 12:05:13 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[DropIfExist](
	@ObjectName varchar(100), 
	@ObjectTypePrefix varchar(5)	--## Possible value: T= Table (dbo); Ta= Table (ERSAudit); F = Function; S= StoredProc; V = View; TR = Trigger
)
AS
/*
	Update History		:
	31 Jan 2024			:		MH		added Index drop option
*/
BEGIN
	SET NOCOUNT ON;

	DECLARE @DynamiDropStatement AS NVARCHAR(300);
	declare @TableObjectIdForIndex as int;
	declare @TableNameForIndex as nvarchar(100);

	IF @ObjectTypePrefix='Ta'
		BEGIN
			IF (EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = 'ERSAudit' AND TABLE_NAME = @ObjectName))
			  SET @DynamiDropStatement = 'DROP TABLE ERSAudit.' + QUOTENAME(@ObjectName);
		  
		END
	ELSE IF @ObjectTypePrefix='T'
		BEGIN
			IF (EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = 'dbo' AND TABLE_NAME = @ObjectName))
			  SET @DynamiDropStatement = 'DROP TABLE ' + QUOTENAME(@ObjectName);
		  
		END
	ELSE IF @ObjectTypePrefix = 'F'
		BEGIN
			IF EXISTS (SELECT 1 FROM sys.objects WHERE object_id = OBJECT_ID(@ObjectName) AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
			  SET @DynamiDropStatement = 'DROP FUNCTION ' + QUOTENAME(@ObjectName);
		END
	ELSE IF @ObjectTypePrefix='S'
		BEGIN
			IF EXISTS (SELECT 1 FROM sys.objects WHERE object_id = OBJECT_ID(@ObjectName) AND type IN (N'P', N'PC')) 
				SET @DynamiDropStatement = 'DROP PROCEDURE ' + QUOTENAME(@ObjectName);
		END
	ELSE IF @ObjectTypePrefix='V'
		BEGIN
			IF EXISTS(SELECT 1 FROM sys.views WHERE name=@ObjectName and TYPE='v')
				SET @DynamiDropStatement = 'DROP VIEW ' + QUOTENAME(@ObjectName);
		END
	ELSE IF @ObjectTypePrefix='TR'
		BEGIN
			IF OBJECT_ID (@ObjectName, 'TR') IS NOT NULL
				SET @DynamiDropStatement = 'DROP TRIGGER ' + QUOTENAME(@ObjectName);
		END		
	ELSE IF @ObjectTypePrefix='I'
		BEGIN
			if exists(Select * from sys.indexes where Name = @ObjectName)
			Begin
				Select @TableObjectIdForIndex = [object_id] from sys.indexes where [Name] = @ObjectName
				Select @TableNameForIndex = object_name(@TableObjectIdForIndex)
				SET @DynamiDropStatement = 'DROP Index ' + QUOTENAME(@ObjectName) + ' ON ' + QUOTENAME(@TableNameForIndex);
			End
		END	

	--## The Dynamic SQL is ready now- Safe to Execute and Drop the Desired Object	
	EXEC(@DynamiDropStatement);

END

Go



/****** Object:  UserDefinedFunction [dbo].[tvfNED_ProcedureIndication]    Script Date: 22/01/2024 15:00:23 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER FUNCTION [dbo].[tvfNED_ProcedureIndication]
(
	@ProcedureId AS INT
)
-- =============================================
-- Description:	This will return the list of 'Indication' for each Procedure- required for NED Export!
-- =============================================
RETURNS TABLE 
AS
RETURN 
(
  Select procedureindicationid,ISNULL(NULLIF(dbo.HTMLDecode(EI.NEDTerm),''), 'Other') NEDTerm --any entry that does not have a NED term in the lookup table is to be treated as other
		, CASE WHEN EI.NEDTerm = 'Other' then EI.[Description] ELSE NULL END AS Comment --where the NED term is blank, the description should be included in the other field
		, CASE WHEN EI.NEDTerm = 'Elevated calprotectin' then EPI.AdditionalInformation ELSE NULL END AS elevatedCalprotectinValue
  from ERS_ProcedureIndications EPI
  join ERS_Indications EI on ISNULL(NULLIF(EPI.ChildIndicationId,0), EPI.IndicationId) = EI.UniqueId
  WHERE EPI.ProcedureId = @ProcedureId
);
GO
/* MH changed as below on 31 Jan 2024
DROP INDEX [IX_ERS_Procedures] ON [dbo].[ERS_Procedures]
DROP INDEX [IX_ERS_Procedures_IsActive_OperatingHospitalID] ON [dbo].[ERS_Procedures]
*/
Exec DropIfExist 'IX_ERS_Procedures','I'
Go
Exec DropIfExist 'IX_ERS_Procedures_IsActive_OperatingHospitalID','I'
Go
Exec DropIfExist 'IX_ERS_Procedures_ProcedureCompleted_IsActive_OperatingHospitalID','I'
Go
Exec DropIfExist 'IX_ERS_Procedures_OperatingHospitalID_IsActive','I'
Go
GO
alter table ERS_Procedures alter column OperatingHospitalId int not null
GO
CREATE NONCLUSTERED INDEX [IX_ERS_Procedures] ON [dbo].[ERS_Procedures]
(
	[ProcedureType] ASC,
	[CreatedOn] ASC,
	[PatientId] ASC,
	[OperatingHospitalID] ASC,
	[ListConsultant] ASC,
	[Endoscopist1] ASC,
	[Endoscopist2] ASC,
	[Endo1Role] ASC,
	[Endo2Role] ASC,
	[IsActive] ASC,
	[ProcedureCompleted] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO

CREATE NONCLUSTERED INDEX [IX_ERS_Procedures_IsActive_OperatingHospitalID] ON [dbo].[ERS_Procedures]
(
	[IsActive] ASC,
	[OperatingHospitalID] ASC
)
INCLUDE([ProcedureType],[CreatedOn]) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO

/****** Object:  Index [IX_ERS_Procedures_ProcedureCompleted_IsActive_OperatingHospitalID]    Script Date: 31/01/2024 13:48:13 ******/
CREATE NONCLUSTERED INDEX [IX_ERS_Procedures_ProcedureCompleted_IsActive_OperatingHospitalID] ON [dbo].[ERS_Procedures]
(
	[ProcedureCompleted] ASC,
	[IsActive] ASC,
	[OperatingHospitalID] ASC
)
INCLUDE([ProcedureType],[CreatedOn],[DNA]) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO

alter table ERS_Procedures alter column Instrument1 int
alter table ERS_Procedures alter column Instrument2 int
GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Chris Gammage 12/12/2023
-- TFS#	3571
-- Description of change
-- update GI schedlering therapeutics
------------------------------------------------------------------------------------------------------------------------
GO
INSERT INTO ERS_TherapeuticTypes (Description, NedName, SchedulerTherapeutic, OGD)
SELECT 'Barretts', 'None', 1, 1
WHERE NOT EXISTS (
    SELECT 1
    FROM ERS_TherapeuticTypes
    WHERE Description = 'Barretts'
	)
INSERT INTO ERS_TherapeuticTypes (Description, NedName, SchedulerTherapeutic, OGD)
SELECT 'GI Bleed', 'None', 1, 1
WHERE NOT EXISTS (
    SELECT 1
    FROM ERS_TherapeuticTypes
    WHERE Description = 'GI Bleed'
	)
GO
	ALTER PROCEDURE [dbo].[GetTherapeuticTypes]
@procedureId AS int
AS

BEGIN

DECLARE @sqlString NVARCHAR(1000)

SELECT @sqlString =
'SELECT
[Id],
[Description],
[NedName],
[OGD],
[ERCP],
[Colon],
[Flexi],
[SchedulerTherapeutic],
[WhoUpdatedId],
[WhoCreatedId],
[WhenCreated],
[WhenUpdated],
[Proct],
[EUS],
[EUS_HPB],
[Antegrade],
[Retrograde],
[Bronchs],
[Cysto],
[Bronch_Flexi],
[Bronch_Rigid]
FROM
dbo.ERS_TherapeuticTypes
WHERE
[Id] NOT IN (1, 2) AND
[SchedulerTherapeutic] = 1'

IF @procedureId = 1
SELECT @sqlString = @sqlString + ' AND [OGD] = 1'
ELSE IF @procedureId = 2
SELECT @sqlString = @sqlString + ' AND [ERCP] = 1'
ELSE IF @procedureId = 3
SELECT @sqlString = @sqlString + ' AND [COLON] = 1'
ELSE IF @procedureId = 4
SELECT @sqlString = @sqlString + ' AND [FLEXI] = 1'
ELSE IF @procedureId = 5
SELECT @sqlString = @sqlString + ' AND [PROCT] = 1'
ELSE IF @procedureId = 6
SELECT @sqlString = @sqlString + ' AND [EUS] = 1'
ELSE IF @procedureId = 7
SELECT @sqlString = @sqlString + ' AND [EUS_HPB] = 1'
ELSE IF @procedureId = 8
SELECT @sqlString = @sqlString + ' AND [Antegrade] = 1'
ELSE IF @procedureId = 9
SELECT @sqlString = @sqlString + ' AND [Retrograde] = 1'
ELSE IF @procedureId IN (10, 11)
SELECT @sqlString = @sqlString + ' AND [Bronchs] = 1'
ELSE IF @procedureId IN (13,14)
SELECT @sqlString = @sqlString + ' AND [Cysto] = 1'


SELECT @sqlString = @sqlString + ' ORDER BY [Description]'

EXEC sp_executesql @sqlString

END
GO
 ------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
IF NOT EXISTS (SELECT 1 FROM ERS_MenuMap where NodeName = 'Support Hub')
       INSERT INTO ERS_MenuMap (NodeName, MenuCategory, MenuUrl, isViewer, ParentID, Suppressed, PageID)
       SELECT top 1 'Support Hub', 'StartMenu', 'https://www.hd-clinical.com/support-hub', 1, MapId, 0, 0
       FROM ERS_MenuMap
       WHERE NodeName = 'Help'

go

-------------------------------------------------------------------------------------------------------------------------
-- Add Foreign Keys
-------------------------------------------------------------------------------------------------------------------------
GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;

GO
PRINT N'Altering Table [dbo].[ERS_Procedures]...';

GO
ALTER TABLE [dbo].[ERS_Procedures] ALTER COLUMN [ReferralConsultantNo] INT NULL;

ALTER TABLE [dbo].[ERS_Procedures] ALTER COLUMN [ReferralHospitalNo] INT NULL;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'PRIMARY KEY'
      AND TABLE_NAME = 'ERS_AdverseEvents'
      AND CONSTRAINT_NAME = 'PK_ERS_AdverseEvents'
)
BEGIN
    PRINT N'Creating Primary Key on ERS_AdverseEvents table...';
	ALTER TABLE [dbo].[ERS_AdverseEvents]
    ADD CONSTRAINT [PK_ERS_AdverseEvents] PRIMARY KEY CLUSTERED ([UniqueId] ASC);
END;

GO
IF NOT EXISTS(
	SELECT * 
	FROM sys.indexes 
	WHERE object_id = object_id('ERS_AdverseEvents' ) 
	  AND NAME ='IX_ERS_AdverseEvents_NEDTerm'
)
BEGIN
	
	PRINT N'Creating Index [dbo].[ERS_AdverseEvents].[IX_ERS_AdverseEvents_NEDTerm]...';

	CREATE NONCLUSTERED INDEX [IX_ERS_AdverseEvents_NEDTerm]
    ON [dbo].[ERS_AdverseEvents]([NEDTerm] ASC);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_AppointmentTherapeutics'
      AND CONSTRAINT_NAME = 'FK_ERS_AppointmentTherapeutics_ERS_TherapeuticTypes'
)
BEGIN
    PRINT N'Creating Foreign Key FK_ERS_AppointmentTherapeutics_ERS_TherapeuticTypes...';
	ALTER TABLE [dbo].[ERS_AppointmentTherapeutics]
	ADD CONSTRAINT [FK_ERS_AppointmentTherapeutics_ERS_TherapeuticTypes] FOREIGN KEY ([TherapeuticTypeID]) REFERENCES [dbo].[ERS_TherapeuticTypes] ([Id]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_ConsultantProcedureTherapeutics'
      AND CONSTRAINT_NAME = 'FK_ERS_ConsultantProcedureTherapeutics_ERS_TherapeuticTypes'
)
BEGIN
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_ConsultantProcedureTherapeutics_ERS_TherapeuticTypes]...';
	ALTER TABLE [dbo].[ERS_ConsultantProcedureTherapeutics] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_ConsultantProcedureTherapeutics_ERS_TherapeuticTypes] FOREIGN KEY ([TherapeuticTypeID]) REFERENCES [dbo].[ERS_TherapeuticTypes] ([Id]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_AdverseEventsProcedureTypes'
      AND CONSTRAINT_NAME = 'FK_ERS_AdverseEventsProcedureTypes_ERS_AdverseEvents'
)
BEGIN
	PRINT N'Removing Orphan records from ERS_AdverseEventsProcedureTypes table'
	DELETE
	FROM ERS_AdverseEventsProcedureTypes
	WHERE AdverseEventsId NOT IN (SELECT UniqueId
								  FROM ERS_AdverseEvents)

	PRINT N'Creating Foreign Key [dbo].[FK_ERS_AdverseEventsProcedureTypes_ERS_AdverseEvents]...';
	ALTER TABLE [dbo].[ERS_AdverseEventsProcedureTypes] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_AdverseEventsProcedureTypes_ERS_AdverseEvents] FOREIGN KEY ([AdverseEventsId]) REFERENCES [dbo].[ERS_AdverseEvents] ([UniqueId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_Appointments'
      AND CONSTRAINT_NAME = 'FK_ERS_Appointments_StaffAccessedId'
)
BEGIN
    PRINT N'Removing Orphan records from ERS_AdverseEventsProcedureTypes table'
	UPDATE ERS_Appointments
	SET StaffAccessedId = NULL
	WHERE StaffAccessedId NOT IN (SELECT UserId
								  FROM ERS_Users)

	PRINT N'Creating Foreign Key [dbo].[FK_ERS_Appointments_StaffAccessedId]...';
	ALTER TABLE [dbo].[ERS_Appointments] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_Appointments_StaffAccessedId] FOREIGN KEY ([StaffAccessedId]) REFERENCES [dbo].[ERS_Users] ([UserID]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_BiopsySitesProcedureTypes'
      AND CONSTRAINT_NAME = 'FK_ERS_BiopsySitesProcedureTypes_ERS_BiopsySites'
)
BEGIN
    PRINT N'Removing Orphan records from ERS_AdverseEventsProcedureTypes table'
	DELETE
	FROM ERS_BiopsySitesProcedureTypes
	WHERE BiopsySiteId NOT IN (SELECT UniqueId
								  FROM ERS_BiopsySites)

	PRINT N'Creating Foreign Key [dbo].[FK_ERS_BiopsySitesProcedureTypes_ERS_BiopsySites]...';
	ALTER TABLE [dbo].[ERS_BiopsySitesProcedureTypes] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_BiopsySitesProcedureTypes_ERS_BiopsySites] FOREIGN KEY ([BiopsySiteId]) REFERENCES [dbo].[ERS_BiopsySites] ([UniqueId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_ProcedureAdverseEvents'
      AND CONSTRAINT_NAME = 'FK_ERS_ProcedureAdverseEvents_ERS_AdverseEvents'
)
BEGIN
    PRINT N'Removing Orphaned AdverseEvent data in ProcedureAdverseEvents'
	DELETE
	FROM ERS_ProcedureAdverseEvents
	WHERE AdverseEventId not in (
		SELECT UniqueId
		FROM ERS_AdverseEvents)
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedureAdverseEvents_ERS_AdverseEvents]...';
	ALTER TABLE [dbo].[ERS_ProcedureAdverseEvents] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_ProcedureAdverseEvents_ERS_AdverseEvents] FOREIGN KEY ([AdverseEventId]) REFERENCES [dbo].[ERS_AdverseEvents] ([UniqueId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_ProcedureAdverseEvents'
      AND CONSTRAINT_NAME = 'FK_ERS_ProcedureAdverseEvents_ERS_Procedures'
)
BEGIN
    PRINT N'Removing Orphaned Procedure data in ProcedureAdverseEvents'
	DELETE
	FROM ERS_ProcedureAdverseEvents
	WHERE AdverseEventId not in (
		SELECT ProcedureId
		FROM ERS_Procedures)
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedureAdverseEvents_ERS_Procedures]...';
	ALTER TABLE [dbo].[ERS_ProcedureAdverseEvents] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_ProcedureAdverseEvents_ERS_Procedures] FOREIGN KEY ([ProcedureId]) REFERENCES [dbo].[ERS_Procedures] ([ProcedureId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_ProcedureAISoftware'
      AND CONSTRAINT_NAME = 'FK_ERS_ProcedureAISoftware_ERS_AISoftware'
)
BEGIN
    PRINT N'Removing Orphaned AISoftware data in ProcedureAISoftware'
	DELETE
	FROM ERS_ProcedureAISoftware
	WHERE AISoftwareId not in (
		SELECT UniqueId
		FROM ERS_AISoftware)
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedureAISoftware_ERS_AISoftware]...';
	ALTER TABLE [dbo].[ERS_ProcedureAISoftware] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_ProcedureAISoftware_ERS_AISoftware] FOREIGN KEY ([AISoftwareId]) REFERENCES [dbo].[ERS_AISoftware] ([UniqueId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_ProcedureAISoftware'
      AND CONSTRAINT_NAME = 'FK_ERS_ProcedureAISoftware_ERS_Procedures'
)
BEGIN
    PRINT N'Removing Orphaned Procedure data in ProcedureAISoftware'
	DELETE
	FROM ERS_ProcedureAISoftware
	WHERE ProcedureId not in (
		SELECT ProcedureId
		FROM ERS_Procedures)
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedureAISoftware_ERS_Procedures]...';
	ALTER TABLE [dbo].[ERS_ProcedureAISoftware] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_ProcedureAISoftware_ERS_Procedures] FOREIGN KEY ([ProcedureId]) REFERENCES [dbo].[ERS_Procedures] ([ProcedureId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_ProcedureBowelPrep'
      AND CONSTRAINT_NAME = 'FK_ERS_ProcedureBowelPrep_ERS_BowelPrep'
)
BEGIN
    PRINT N'Removing Orphaned BowelPrep data in ProcedureBowelPrep'
	DELETE
	FROM ERS_ProcedureBowelPrep
	WHERE BowelPrepId not in (
		SELECT UniqueId
		FROM ERS_BowelPrep)
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedureBowelPrep_ERS_BowelPrep]...';
	ALTER TABLE [dbo].[ERS_ProcedureBowelPrep] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_ProcedureBowelPrep_ERS_BowelPrep] FOREIGN KEY ([BowelPrepId]) REFERENCES [dbo].[ERS_BowelPrep] ([UniqueId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_ProcedureBronchoReferralData'
      AND CONSTRAINT_NAME = 'FK_ERS_ProcedureBronchoReferralData_ERS_Procedures'
)
BEGIN
    PRINT N'Removing Orphaned Procedure data in ProcedureBowelPrep'
	DELETE
	FROM ERS_ProcedureBowelPrep
	WHERE ProcedureId not in (
		SELECT ProcedureId
		FROM ERS_Procedures)
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedureBronchoReferralData_ERS_Procedures]...';
	ALTER TABLE [dbo].[ERS_ProcedureBronchoReferralData] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_ProcedureBronchoReferralData_ERS_Procedures] FOREIGN KEY ([ProcedureId]) REFERENCES [dbo].[ERS_Procedures] ([ProcedureId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_ProcedureChromendosopy'
      AND CONSTRAINT_NAME = 'FK_ERS_ProcedureChromendosopy_ERS_Chromendoscopies'
)
BEGIN
    PRINT N'Removing Orphaned Chromendoscopy data in ProcedureChromendosopy'
	DELETE
	FROM ERS_ProcedureChromendosopy
	WHERE ChromendoscopyId not in (
		SELECT UniqueId
		FROM ERS_Chromendoscopies)
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedureChromendosopy_ERS_Chromendoscopies]...';
	ALTER TABLE [dbo].[ERS_ProcedureChromendosopy] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_ProcedureChromendosopy_ERS_Chromendoscopies] FOREIGN KEY ([ChromendoscopyId]) REFERENCES [dbo].[ERS_Chromendoscopies] ([UniqueId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_ProcedureChromendosopy'
      AND CONSTRAINT_NAME = 'FK_ERS_ProcedureChromendosopy_ERS_Procedures'
)
BEGIN
    PRINT N'Removing Orphaned Procedure data in ProcedureChromendosopy'
	DELETE
	FROM ERS_ProcedureChromendosopy
	WHERE ProcedureId not in (
		SELECT ProcedureId
		FROM ERS_Procedures)
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedureChromendosopy_ERS_Procedures]...';
	ALTER TABLE [dbo].[ERS_ProcedureChromendosopy] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_ProcedureChromendosopy_ERS_Procedures] FOREIGN KEY ([ProcedureId]) REFERENCES [dbo].[ERS_Procedures] ([ProcedureId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_ProcedureComorbidity'
      AND CONSTRAINT_NAME = 'FK_ERS_ProcedureComorbidity_ERS_Comorbidity'
)
BEGIN
    PRINT N'Removing Orphaned Comorbidity data in ProcedureComorbidity'
	DELETE
	FROM ERS_ProcedureComorbidity
	WHERE ComorbidityId not in (
		SELECT UniqueId
		FROM ERS_Comorbidity)
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedureComorbidity_ERS_Comorbidity]...';
	ALTER TABLE [dbo].[ERS_ProcedureComorbidity] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_ProcedureComorbidity_ERS_Comorbidity] FOREIGN KEY ([ComorbidityId]) REFERENCES [dbo].[ERS_Comorbidity] ([UniqueId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_ProcedureComorbidity'
      AND CONSTRAINT_NAME = 'FK_ERS_ProcedureComorbidity_ERS_Procedures'
)
BEGIN
    PRINT N'Removing Orphaned Procedure data in ProcedureComorbidity'
	DELETE
	FROM ERS_ProcedureComorbidity
	WHERE ProcedureId not in (
		SELECT ProcedureId
		FROM ERS_Procedures)
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedureComorbidity_ERS_Procedures]...';
	ALTER TABLE [dbo].[ERS_ProcedureComorbidity] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_ProcedureComorbidity_ERS_Procedures] FOREIGN KEY ([ProcedureId]) REFERENCES [dbo].[ERS_Procedures] ([ProcedureId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_ProcedureDamagingDrugs'
      AND CONSTRAINT_NAME = 'FK_ERS_ProcedureDamagingDrugs_ERS_PotentialDamagingDrugs'
)
BEGIN
    PRINT N'Removing Orphaned DamagingDrugs data in ProcedureDamagingDrugs'
	DELETE
	FROM ERS_ProcedureDamagingDrugs
	WHERE DamagingDrugId not in (
		SELECT UniqueId
		FROM ERS_PotentialDamagingDrugs)
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedureDamagingDrugs_ERS_PotentialDamagingDrugs]...';
	ALTER TABLE [dbo].[ERS_ProcedureDamagingDrugs] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_ProcedureDamagingDrugs_ERS_PotentialDamagingDrugs] FOREIGN KEY ([DamagingDrugId]) REFERENCES [dbo].[ERS_PotentialDamagingDrugs] ([UniqueId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_ProcedureDamagingDrugs'
      AND CONSTRAINT_NAME = 'FK_ERS_ProcedureDamagingDrugs_ERS_Procedures'
)
BEGIN
    PRINT N'Removing Orphaned Procedure data in ProcedureDamagingDrugs'
	DELETE
	FROM ERS_ProcedureDamagingDrugs
	WHERE ProcedureId not in (
		SELECT ProcedureId
		FROM ERS_Procedures)
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedureDamagingDrugs_ERS_Procedures]...';
	ALTER TABLE [dbo].[ERS_ProcedureDamagingDrugs] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_ProcedureDamagingDrugs_ERS_Procedures] FOREIGN KEY ([ProcedureDamagingDrugsId]) REFERENCES [dbo].[ERS_Procedures] ([ProcedureId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_ProcedureDICAScores'
      AND CONSTRAINT_NAME = 'FK_ERS_ProcedureDICAScores_ERS_Sites'
)
BEGIN
    PRINT N'Removing Orphaned Site data in ProcedureDICAScores'
	DELETE
	FROM ERS_ProcedureDICAScores
	WHERE SiteId not in (
		SELECT SiteId
		FROM ERS_Sites)
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedureDICAScores_ERS_Sites]...';
	ALTER TABLE [dbo].[ERS_ProcedureDICAScores] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_ProcedureDICAScores_ERS_Sites] FOREIGN KEY ([SiteId]) REFERENCES [dbo].[ERS_Sites] ([SiteId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_ProcedureDiscomfortScore'
      AND CONSTRAINT_NAME = 'FK_ERS_ProcedureDiscomfortScore_ERS_Procedures'
)
BEGIN
    PRINT N'Removing Orphaned Procedure data in ProcedureDiscomfortScore'
	DELETE
	FROM ERS_ProcedureDiscomfortScore
	WHERE ProcedureId not in (
		SELECT ProcedureId
		FROM ERS_Procedures)
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedureDiscomfortScore_ERS_Procedures]...';
	ALTER TABLE [dbo].[ERS_ProcedureDiscomfortScore] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_ProcedureDiscomfortScore_ERS_Procedures] FOREIGN KEY ([ProcedureId]) REFERENCES [dbo].[ERS_Procedures] ([ProcedureId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_ProcedureDistalAttachment'
      AND CONSTRAINT_NAME = 'FK_ERS_ProcedureDistalAttachment_ERS_DistalAttachments'
)
BEGIN
    PRINT N'Removing Orphaned DistalAttachment data in ProcedureDistalAttachments'
	DELETE
	FROM ERS_ProcedureDistalAttachment
	WHERE DistalAttachmentId not in (
		SELECT UniqueId
		FROM ERS_DistalAttachments)
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedureDistalAttachment_ERS_DistalAttachments]...';
	ALTER TABLE [dbo].[ERS_ProcedureDistalAttachment] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_ProcedureDistalAttachment_ERS_DistalAttachments] FOREIGN KEY ([DistalAttachmentId]) REFERENCES [dbo].[ERS_DistalAttachments] ([UniqueId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_ProcedureDistalAttachment'
      AND CONSTRAINT_NAME = 'FK_ERS_ProcedureDistalAttachment_ERS_Procedures'
)
BEGIN
    PRINT N'Removing Orphaned Procedure data in ProcedureDistalAttachments'
	DELETE
	FROM ERS_ProcedureDistalAttachment
	WHERE ProcedureId not in (
		SELECT ProcedureId
		FROM ERS_Procedures)
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedureDistalAttachment_ERS_Procedures]...';
	ALTER TABLE [dbo].[ERS_ProcedureDistalAttachment] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_ProcedureDistalAttachment_ERS_Procedures] FOREIGN KEY ([ProcedureId]) REFERENCES [dbo].[ERS_Procedures] ([ProcedureId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_ProcedureEnteroscopyTechniques'
      AND CONSTRAINT_NAME = 'FK_ERS_ProcedureEnteroscopyTechniques_ERS_EnteroscopyTechniques'
)
BEGIN
    PRINT N'Removing Orphaned Enteroscopy data in ProcedureEntroscopyTechniques'
	DELETE
	FROM ERS_ProcedureEnteroscopyTechniques
	WHERE TechniqueId not in (
		SELECT UniqueId
		FROM ERS_EnteroscopyTechniques)
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedureEnteroscopyTechniques_ERS_EnteroscopyTechniques]...';
	ALTER TABLE [dbo].[ERS_ProcedureEnteroscopyTechniques] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_ProcedureEnteroscopyTechniques_ERS_EnteroscopyTechniques] FOREIGN KEY ([TechniqueId]) REFERENCES [dbo].[ERS_EnteroscopyTechniques] ([UniqueId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_ProcedureEnteroscopyTechniques'
      AND CONSTRAINT_NAME = 'FK_ERS_ProcedureEnteroscopyTechniques_ERS_Procedures'
)
BEGIN
    PRINT N'Removing Orphaned Procedure data in ProcedureEntroscopyTechniques'
	DELETE
	FROM ERS_ProcedureEnteroscopyTechniques
	WHERE ProcedureId not in (
		SELECT ProcedureId
		FROM ERS_Procedures)
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedureEnteroscopyTechniques_ERS_Procedures]...';
	ALTER TABLE [dbo].[ERS_ProcedureEnteroscopyTechniques] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_ProcedureEnteroscopyTechniques_ERS_Procedures] FOREIGN KEY ([ProcedureId]) REFERENCES [dbo].[ERS_Procedures] ([ProcedureId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_ProcedureImagingMethod'
      AND CONSTRAINT_NAME = 'FK_ERS_ProcedureImagingMethod_ERS_ImagingMethods'
)
BEGIN
    PRINT N'Removing Orphaned ImagingMethod data in ProcedureImagingMethod'
	DELETE
	FROM ERS_ProcedureImagingMethod
	WHERE ImagingMethodId not in (
		SELECT UniqueId
		FROM ERS_ImagingMethods)
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedureImagingMethod_ERS_ImagingMethods]...';
	ALTER TABLE [dbo].[ERS_ProcedureImagingMethod] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_ProcedureImagingMethod_ERS_ImagingMethods] FOREIGN KEY ([ImagingMethodId]) REFERENCES [dbo].[ERS_ImagingMethods] ([UniqueId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_ProcedureImagingMethod'
      AND CONSTRAINT_NAME = 'FK_ERS_ProcedureImagingMethod_ERS_Procedures'
)
BEGIN
    PRINT N'Removing Orphaned Procedure data in ProcedureImagingMethod'
	DELETE
	FROM ERS_ProcedureImagingMethod
	WHERE ProcedureId not in (
		SELECT ProcedureId
		FROM ERS_Procedures)
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedureImagingMethod_ERS_Procedures]...';
	ALTER TABLE [dbo].[ERS_ProcedureImagingMethod] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_ProcedureImagingMethod_ERS_Procedures] FOREIGN KEY ([ProcedureId]) REFERENCES [dbo].[ERS_Procedures] ([ProcedureId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_ProcedureImagingOutcome'
      AND CONSTRAINT_NAME = 'FK_ERS_ProcedureImagingOutcome_ERS_ImagingOutcomes'
)
BEGIN
    PRINT N'Removing Orphaned ImagingOutcome data in ProcedureImagingOutcome'
	DELETE
	FROM ERS_ProcedureImagingOutcome
	WHERE ImagingOutcomeId not in (
		SELECT UniqueId
		FROM ERS_ImagingOutcomes)
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedureImagingOutcome_ERS_ImagingOutcomes]...';
	ALTER TABLE [dbo].[ERS_ProcedureImagingOutcome] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_ProcedureImagingOutcome_ERS_ImagingOutcomes] FOREIGN KEY ([ImagingOutcomeId]) REFERENCES [dbo].[ERS_ImagingOutcomes] ([UniqueId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_ProcedureImagingOutcome'
      AND CONSTRAINT_NAME = 'FK_ERS_ProcedureImagingOutcome_ERS_Procedures'
)
BEGIN
    PRINT N'Removing Orphaned Procedure data in ProcedureImagingOutcome'
	DELETE
	FROM ERS_ProcedureImagingOutcome
	WHERE ProcedureId not in (
		SELECT ProcedureId
		FROM ERS_Procedures)
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedureImagingOutcome_ERS_Procedures]...';
	ALTER TABLE [dbo].[ERS_ProcedureImagingOutcome] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_ProcedureImagingOutcome_ERS_Procedures] FOREIGN KEY ([ProcedureId]) REFERENCES [dbo].[ERS_Procedures] ([ProcedureId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_ProcedureIndications'
      AND CONSTRAINT_NAME = 'FK_ERS_ProcedureIndications_ERS_Indications'
)
BEGIN
    PRINT N'Removing Orphaned Indications data in ProcedureIndications'
	DELETE
	FROM ERS_ProcedureIndications
	WHERE IndicationId not in (
		SELECT UniqueId
		FROM ERS_Indications)
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedureIndications_ERS_Indications]...';
	ALTER TABLE [dbo].[ERS_ProcedureIndications] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_ProcedureIndications_ERS_Indications] FOREIGN KEY ([IndicationId]) REFERENCES [dbo].[ERS_Indications] ([UniqueId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_ProcedureIndications'
      AND CONSTRAINT_NAME = 'FK_ERS_ProcedureIndications_ERS_Procedures'
)
BEGIN
    PRINT N'Removing Orphaned Procedure data in ProcedureIdnications'
	DELETE
	FROM ERS_ProcedureIndications
	WHERE ProcedureId not in (
		SELECT ProcedureId
		FROM ERS_Procedures)
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedureIndications_ERS_Procedures]...';
	ALTER TABLE [dbo].[ERS_ProcedureIndications] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_ProcedureIndications_ERS_Procedures] FOREIGN KEY ([ProcedureId]) REFERENCES [dbo].[ERS_Procedures] ([ProcedureId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_ProcedureInsertionTechnique'
      AND CONSTRAINT_NAME = 'FK_ERS_ProcedureInsertionTechnique_ERS_InsertionTechniques'
)
BEGIN
    PRINT N'Removing Orphaned InsertionTechnique data in ProcedureIsertionTechnique'
	DELETE
	FROM ERS_ProcedureInsertionTechnique
	WHERE InsertionTechniqueId not in (
		SELECT UniqueId
		FROM ERS_InsertionTechniques)
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedureInsertionTechnique_ERS_InsertionTechniques]...';
	ALTER TABLE [dbo].[ERS_ProcedureInsertionTechnique] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_ProcedureInsertionTechnique_ERS_InsertionTechniques] FOREIGN KEY ([InsertionTechniqueId]) REFERENCES [dbo].[ERS_InsertionTechniques] ([UniqueId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_ProcedureInsertionTechnique'
      AND CONSTRAINT_NAME = 'FK_ERS_ProcedureInsertionTechnique_ERS_Procedures'
)
BEGIN
    PRINT N'Removing Orphaned Procedure data in ProcedureInsertionTechnique'
	DELETE
	FROM ERS_ProcedureInsertionTechnique
	WHERE ProcedureId not in (
		SELECT ProcedureId
		FROM ERS_Procedures)
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedureInsertionTechnique_ERS_Procedures]...';
	ALTER TABLE [dbo].[ERS_ProcedureInsertionTechnique] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_ProcedureInsertionTechnique_ERS_Procedures] FOREIGN KEY ([ProcedureId]) REFERENCES [dbo].[ERS_Procedures] ([ProcedureId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_ProcedureInsufflation'
      AND CONSTRAINT_NAME = 'FK_ERS_ProcedureInsufflation_ERS_Insufflation'
)
BEGIN
    PRINT N'Removing Orphaned Insuflation data in ProcedureInsuflation'
	DELETE
	FROM ERS_ProcedureInsufflation
	WHERE InsufflationId not in (
		SELECT UniqueId
		FROM ERS_Insufflation)
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedureInsufflation_ERS_Insufflation]...';
	ALTER TABLE [dbo].[ERS_ProcedureInsufflation] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_ProcedureInsufflation_ERS_Insufflation] FOREIGN KEY ([InsufflationId]) REFERENCES [dbo].[ERS_Insufflation] ([UniqueId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_ProcedureInsufflation'
      AND CONSTRAINT_NAME = 'FK_ERS_ProcedureInsufflation_ERS_Procedures'
)
BEGIN
    PRINT N'Removing Orphaned Procedure data in ProcedureInsuflation'
	DELETE
	FROM ERS_ProcedureInsufflation
	WHERE ProcedureId not in (
		SELECT ProcedureId
		FROM ERS_Procedures)
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedureInsufflation_ERS_Procedures]...';
	ALTER TABLE [dbo].[ERS_ProcedureInsufflation] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_ProcedureInsufflation_ERS_Procedures] FOREIGN KEY ([ProcedureId]) REFERENCES [dbo].[ERS_Procedures] ([ProcedureId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_ProcedureLevelOfComplexity'
      AND CONSTRAINT_NAME = 'FK_ERS_ProcedureLevelOfComplexity_ERS_LevelOfComplexity'
)
BEGIN
    PRINT N'Removing Orphaned LevelOfComplexity data in ProcedureLevelOfComplexity'
	DELETE
	FROM ERS_ProcedureLevelOfComplexity
	WHERE ComplexityId not in (
		SELECT UniqueId
		FROM ERS_LevelOfComplexity)
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedureLevelOfComplexity_ERS_LevelOfComplexity]...';
	ALTER TABLE [dbo].[ERS_ProcedureLevelOfComplexity] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_ProcedureLevelOfComplexity_ERS_LevelOfComplexity] FOREIGN KEY ([ComplexityId]) REFERENCES [dbo].[ERS_LevelOfComplexity] ([UniqueId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_ProcedureLevelOfComplexity'
      AND CONSTRAINT_NAME = 'FK_ERS_ProcedureLevelOfComplexity_ERS_Procedures'
)
BEGIN
    PRINT N'Removing Orphaned Procedure data in ProcedureLevelOfComplexity'
	DELETE
	FROM ERS_ProcedureLevelOfComplexity
	WHERE ProcedureId not in (
		SELECT ProcedureId
		FROM ERS_Procedures)
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedureLevelOfComplexity_ERS_Procedures]...';
	ALTER TABLE [dbo].[ERS_ProcedureLevelOfComplexity] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_ProcedureLevelOfComplexity_ERS_Procedures] FOREIGN KEY ([ProcedureId]) REFERENCES [dbo].[ERS_Procedures] ([ProcedureId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_ProcedureLUTSIPSSSymptoms'
      AND CONSTRAINT_NAME = 'FK_ERS_ProcedureLUTSIPSSSymptoms_ERS_LUTSIPSSSymptoms'
)
BEGIN
    PRINT N'Removing Orphaned LUTSIPSSSymptoms data in ProcedureLUTSIPSSSymptoms'
	DELETE
	FROM ERS_ProcedureLUTSIPSSSymptoms
	WHERE LUTSIPSSSymptomId not in (
		SELECT UniqueId
		FROM ERS_LUTSIPSSSymptoms)
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedureLUTSIPSSSymptoms_ERS_LUTSIPSSSymptoms]...';
	ALTER TABLE [dbo].[ERS_ProcedureLUTSIPSSSymptoms] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_ProcedureLUTSIPSSSymptoms_ERS_LUTSIPSSSymptoms] FOREIGN KEY ([LUTSIPSSSymptomId]) REFERENCES [dbo].[ERS_LUTSIPSSSymptoms] ([UniqueId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_ProcedureLUTSIPSSSymptoms'
      AND CONSTRAINT_NAME = 'FK_ERS_ProcedureLUTSIPSSSymptoms_ERS_Procedures'
)
BEGIN
    PRINT N'Removing Orphaned Procedure data in ProcedureLUTSIPSSSymptoms'
	DELETE
	FROM ERS_ProcedureLUTSIPSSSymptoms
	WHERE ProcedureId not in (
		SELECT ProcedureId
		FROM ERS_Procedures)
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedureLUTSIPSSSymptoms_ERS_Procedures]...';
	ALTER TABLE [dbo].[ERS_ProcedureLUTSIPSSSymptoms] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_ProcedureLUTSIPSSSymptoms_ERS_Procedures] FOREIGN KEY ([ProcedureId]) REFERENCES [dbo].[ERS_Procedures] ([ProcedureId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_ProcedureManagement'
      AND CONSTRAINT_NAME = 'FK_ERS_ProcedureManagement_ERS_Management'
)
BEGIN
    PRINT N'Removing Orphaned Management data in ProcedureManagement'
	DELETE
	FROM ERS_ProcedureManagement
	WHERE ManagementId not in (
		SELECT UniqueId
		FROM ERS_Management)
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedureManagement_ERS_Management]...';
	ALTER TABLE [dbo].[ERS_ProcedureManagement] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_ProcedureManagement_ERS_Management] FOREIGN KEY ([ManagementId]) REFERENCES [dbo].[ERS_Management] ([UniqueId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_ProcedureManagement'
      AND CONSTRAINT_NAME = 'FK_ERS_ProcedureManagement_ERS_Procedures'
)
BEGIN
    PRINT N'Removing Orphaned Procedure data in ProcedureManagement'
	DELETE
	FROM ERS_ProcedureManagement
	WHERE ProcedureId not in (
		SELECT ProcedureId
		FROM ERS_Procedures)
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedureManagement_ERS_Procedures]...';
	ALTER TABLE [dbo].[ERS_ProcedureManagement] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_ProcedureManagement_ERS_Procedures] FOREIGN KEY ([ProcedureId]) REFERENCES [dbo].[ERS_Procedures] ([ProcedureId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_ProcedureMucosalCleaning'
      AND CONSTRAINT_NAME = 'FK_ERS_ProcedureMucosalCleaning_ERS_MucosalCleaning'
)
BEGIN
    PRINT N'Removing Orphaned MucosalCleansing data in ProcedureMucosalCleansing'
	DELETE
	FROM ERS_ProcedureMucosalCleaning
	WHERE MucosalCleaningId not in (
		SELECT UniqueId
		FROM ERS_MucosalCleaning)
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedureMucosalCleaning_ERS_MucosalCleaning]...';
	ALTER TABLE [dbo].[ERS_ProcedureMucosalCleaning] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_ProcedureMucosalCleaning_ERS_MucosalCleaning] FOREIGN KEY ([MucosalCleaningId]) REFERENCES [dbo].[ERS_MucosalCleaning] ([UniqueId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_ProcedureMucosalCleaning'
      AND CONSTRAINT_NAME = 'FK_ERS_ProcedureMucosalCleaning_ERS_Procedures'
)
BEGIN
    PRINT N'Removing Orphaned Procedure data in ProcedureMucosalCleansing'
	DELETE
	FROM ERS_ProcedureMucosalCleaning
	WHERE ProcedureId not in (
		SELECT ProcedureId
		FROM ERS_Procedures)
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedureMucosalCleaning_ERS_Procedures]...';
	ALTER TABLE [dbo].[ERS_ProcedureMucosalCleaning] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_ProcedureMucosalCleaning_ERS_Procedures] FOREIGN KEY ([ProcedureId]) REFERENCES [dbo].[ERS_Procedures] ([ProcedureId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_ProcedureMucosalVisualisation'
      AND CONSTRAINT_NAME = 'FK_ERS_ProcedureMucosalVisualisation_ERS_MucosalVisualisation'
)
BEGIN
    PRINT N'Removing Orphaned MucosalVisualisation data in ProcedureMucosalVisualisation'
	DELETE
	FROM ERS_ProcedureMucosalVisualisation
	WHERE MucosalVisualisationId not in (
		SELECT UniqueId
		FROM ERS_MucosalVisualisation)
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedureMucosalVisualisation_ERS_MucosalVisualisation]...';
	ALTER TABLE [dbo].[ERS_ProcedureMucosalVisualisation] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_ProcedureMucosalVisualisation_ERS_MucosalVisualisation] FOREIGN KEY ([MucosalVisualisationId]) REFERENCES [dbo].[ERS_MucosalVisualisation] ([UniqueId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_ProcedureMucosalVisualisation'
      AND CONSTRAINT_NAME = 'FK_ERS_ProcedureMucosalVisualisation_ERS_Procedures'
)
BEGIN
    PRINT N'Removing Orphaned Procedure data in ProcedureMucosalVisualisation'
	DELETE
	FROM ERS_ProcedureMucosalVisualisation
	WHERE ProcedureId not in (
		SELECT ProcedureId
		FROM ERS_Procedures)
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedureMucosalVisualisation_ERS_Procedures]...';
	ALTER TABLE [dbo].[ERS_ProcedureMucosalVisualisation] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_ProcedureMucosalVisualisation_ERS_Procedures] FOREIGN KEY ([ProcedureId]) REFERENCES [dbo].[ERS_Procedures] ([ProcedureId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_ProcedurePathwayPlanAnswers'
      AND CONSTRAINT_NAME = 'FK_ERS_ProcedurePathwayPlanAnswers_ERS_PathwayPlanQuestions'
)
BEGIN
    PRINT N'Removing Orphaned PathwayPlanQuestions data in ProcedurePathwayPlanAnswers'
	DELETE
	FROM ERS_ProcedurePathwayPlanAnswers
	WHERE QuestionId not in (
		SELECT QuestionId
		FROM ERS_PathwayPlanQuestions)
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedurePathwayPlanAnswers_ERS_PathwayPlanQuestions]...';
	ALTER TABLE [dbo].[ERS_ProcedurePathwayPlanAnswers] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_ProcedurePathwayPlanAnswers_ERS_PathwayPlanQuestions] FOREIGN KEY ([QuestionId]) REFERENCES [dbo].[ERS_PathwayPlanQuestions] ([QuestionId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_Procedures'
      AND CONSTRAINT_NAME = 'FK_ERS_Procedures_ERS_Diagrams'
)
BEGIN
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_Procedures_ERS_Diagrams]...';
	ALTER TABLE [dbo].[ERS_Procedures] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_Procedures_ERS_Diagrams] FOREIGN KEY ([DiagramNumber]) REFERENCES [dbo].[ERS_Diagrams] ([DiagramId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_Procedures'
      AND CONSTRAINT_NAME = 'FK_ERS_Procedures_ERS_DistalAttachments'
)
BEGIN
    PRINT N'Removing DistalAttachment entry for Procedures where ID not in ERS_DistalAttachments table'
	
	-- disable the trigger if it exists
	IF (OBJECT_ID(N'trg_ERS_Procedures_Update') IS NOT NULL)
		ALTER TABLE ERS_Procedures DISABLE TRIGGER trg_ERS_Procedures_Update

	UPDATE ERS_Procedures
	SET DistalAttachmentId = NULL
	WHERE DistalAttachmentId not in (
		SELECT UniqueId
		FROM ERS_DistalAttachments)

	-- Re-enable the trigger
	IF (OBJECT_ID(N'trg_ERS_Procedures_Update') IS NOT NULL)
		ALTER TABLE ERS_Procedures ENABLE TRIGGER trg_ERS_Procedures_Update
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_Procedures_ERS_DistalAttachments]...';
	ALTER TABLE [dbo].[ERS_Procedures] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_Procedures_ERS_DistalAttachments] FOREIGN KEY ([DistalAttachmentId]) REFERENCES [dbo].[ERS_DistalAttachments] ([UniqueId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_Procedures'
      AND CONSTRAINT_NAME = 'FK_ERS_Procedures_ERS_Orders'
)
BEGIN
    PRINT N'Removing Order entry for Procedures where ID not in ERS_Orders table'
	
	-- disable the trigger if it exists
	IF (OBJECT_ID(N'trg_ERS_Procedures_Update') IS NOT NULL)
		ALTER TABLE ERS_Procedures DISABLE TRIGGER trg_ERS_Procedures_Update

	UPDATE ERS_Procedures
	SET OrderId = NULL
	WHERE OrderId not in (
		SELECT OrderId
		FROM ERS_Orders)

	-- Re-enable the trigger
	IF (OBJECT_ID(N'trg_ERS_Procedures_Update') IS NOT NULL)
		ALTER TABLE ERS_Procedures ENABLE TRIGGER trg_ERS_Procedures_Update
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_Procedures_ERS_Orders]...';
	ALTER TABLE [dbo].[ERS_Procedures] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_Procedures_ERS_Orders] FOREIGN KEY ([OrderId]) REFERENCES [dbo].[ERS_Orders] ([OrderId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_Procedures'
      AND CONSTRAINT_NAME = 'FK_ERS_Procedures_ERS_ProviderOrganisation'
)
BEGIN
    PRINT N'Removing ProviderOrganisation entry for Procedures where ID not in ERS_ProviderOrganisation table'
	
	-- disable the trigger if it exists
	IF (OBJECT_ID(N'trg_ERS_Procedures_Update') IS NOT NULL)
		ALTER TABLE ERS_Procedures DISABLE TRIGGER trg_ERS_Procedures_Update

	UPDATE ERS_Procedures
	SET ProviderTypeId = NULL
	WHERE ProviderTypeId not in (
		SELECT UniqueId
		FROM ERS_ProviderOrganisation)

	-- Re-enable the trigger
	IF (OBJECT_ID(N'trg_ERS_Procedures_Update') IS NOT NULL)
		ALTER TABLE ERS_Procedures ENABLE TRIGGER trg_ERS_Procedures_Update
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_Procedures_ERS_ProviderOrganisation]...';
	ALTER TABLE [dbo].[ERS_Procedures] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_Procedures_ERS_ProviderOrganisation] FOREIGN KEY ([ProviderTypeId]) REFERENCES [dbo].[ERS_ProviderOrganisation] ([UniqueId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_Procedures'
      AND CONSTRAINT_NAME = 'FK_ERS_Procedures_ERS_ProviderSectors'
)
BEGIN
    PRINT N'Removing ProviderSector entry for Procedures where ID not in ERS_ProviderSectors table'
	
	-- disable the trigger if it exists
	IF (OBJECT_ID(N'trg_ERS_Procedures_Update') IS NOT NULL)
		ALTER TABLE ERS_Procedures DISABLE TRIGGER trg_ERS_Procedures_Update

	UPDATE ERS_Procedures
	SET PatientType = NULL
	WHERE PatientType not in (
		SELECT UniqueId
		FROM ERS_ProviderSectors)

	-- Re-enable the trigger
	IF (OBJECT_ID(N'trg_ERS_Procedures_Update') IS NOT NULL)
		ALTER TABLE ERS_Procedures ENABLE TRIGGER trg_ERS_Procedures_Update
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_Procedures_ERS_ProviderSectors]...';
	ALTER TABLE [dbo].[ERS_Procedures] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_Procedures_ERS_ProviderSectors] FOREIGN KEY ([PatientType]) REFERENCES [dbo].[ERS_ProviderSectors] ([UniqueId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_Procedures'
      AND CONSTRAINT_NAME = 'FK_ERS_Procedures_ERS_ReferrerTypes'
)
BEGIN
    PRINT N'Removing ReferrerType entry for Procedures where ID not in ERS_ReferrerTypes table'
	
	-- disable the trigger if it exists
	IF (OBJECT_ID(N'trg_ERS_Procedures_Update') IS NOT NULL)
		ALTER TABLE ERS_Procedures DISABLE TRIGGER trg_ERS_Procedures_Update

	UPDATE ERS_Procedures
	SET ReferrerType = NULL
	WHERE ReferrerType not in (
		SELECT UniqueId
		FROM ERS_ReferrerTypes)

	-- Re-enable the trigger
	IF (OBJECT_ID(N'trg_ERS_Procedures_Update') IS NOT NULL)
		ALTER TABLE ERS_Procedures ENABLE TRIGGER trg_ERS_Procedures_Update
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_Procedures_ERS_ReferrerTypes]...';
	ALTER TABLE [dbo].[ERS_Procedures] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_Procedures_ERS_ReferrerTypes] FOREIGN KEY ([ReferrerType]) REFERENCES [dbo].[ERS_ReferrerTypes] ([UniqueId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_Procedures'
      AND CONSTRAINT_NAME = 'FK_ERS_Procedures_ERS_ReferringHospitals'
)
BEGIN
    PRINT N'Removing ReferringHospitals entry for Procedures where ID not in ERS_ReferringHospitals table'
	
	-- disable the trigger if it exists
	IF (OBJECT_ID(N'trg_ERS_Procedures_Update') IS NOT NULL)
		ALTER TABLE ERS_Procedures DISABLE TRIGGER trg_ERS_Procedures_Update

	UPDATE ERS_Procedures
	SET ReferralHospitalNo = NULL
	WHERE ReferralHospitalNo not in (
		SELECT HospitalId
		FROM ERS_ReferralHospitals)

	-- Re-enable the trigger
	IF (OBJECT_ID(N'trg_ERS_Procedures_Update') IS NOT NULL)
		ALTER TABLE ERS_Procedures ENABLE TRIGGER trg_ERS_Procedures_Update
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_Procedures_ERS_ReferringHospitals]...';
	ALTER TABLE [dbo].[ERS_Procedures] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_Procedures_ERS_ReferringHospitals] FOREIGN KEY ([ReferralHospitalNo]) REFERENCES [dbo].[ERS_ReferralHospitals] ([HospitalID]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_Procedures'
      AND CONSTRAINT_NAME = 'FK_ERS_Procedures_ERS_Scopes1'
)
BEGIN
	PRINT N'Associating Orphaned Procedure Instument data with Dummy Record (Unknown Scope)'
	IF (SELECT COUNT(1)
		FROM ERS_Procedures
		WHERE Instrument1 NOT IN (SELECT ScopeId
								  FROM ERS_Scopes)) > 0
	BEGIN
		DECLARE @ScopeId INT

		IF EXISTS (SELECT 1 FROM ERS_Scopes WHERE ScopeName = 'Unknown Scope')
			SELECT @ScopeId = MAX(ScopeId)
			FROM ERS_Scopes
			WHERE ScopeName = 'Unknown Scope'
		ELSE
		BEGIN
			--Create Dummy Scope to assign tp procedures
			INSERT INTO ERS_Scopes (ScopeName, RoomID, AllProcedureTypes, Suppressed, SuppressDate, ScopeGenerationId)
			VALUES ('Unknown Scope', NULL, 0, 1, NULL, NULL)
		END

		-- disable the trigger if it exists
		IF (OBJECT_ID(N'trg_ERS_Procedures_Update') IS NOT NULL)
			ALTER TABLE ERS_Procedures DISABLE TRIGGER trg_ERS_Procedures_Update

		UPDATE ERS_Procedures
		SET Instrument1 = @ScopeId
		WHERE Instrument1 NOT IN (SELECT ScopeId
								  FROM ERS_Scopes)
	
		-- Re-enable the trigger
		IF (OBJECT_ID(N'trg_ERS_Procedures_Update') IS NOT NULL)
			ALTER TABLE ERS_Procedures ENABLE TRIGGER trg_ERS_Procedures_Update
	END

    PRINT N'Creating Foreign Key [dbo].[FK_ERS_Procedures_ERS_Scopes1]...';
	ALTER TABLE [dbo].[ERS_Procedures] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_Procedures_ERS_Scopes1] FOREIGN KEY ([Instrument1]) REFERENCES [dbo].[ERS_Scopes] ([ScopeId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_Procedures'
      AND CONSTRAINT_NAME = 'FK_ERS_Procedures_ERS_Users'
)
BEGIN
    PRINT N'Associating Orphaned ListConsultant records with ADMIN user'
	-- disable the trigger if it exists
	IF (OBJECT_ID(N'trg_ERS_Procedures_Update') IS NOT NULL)
		ALTER TABLE ERS_Procedures DISABLE TRIGGER trg_ERS_Procedures_Update

	UPDATE ERS_Procedures
	SET ListConsultant = 1
	WHERE ListConsultant NOT IN (SELECT UserId
							  FROM ERS_Users)
	
	-- Re-enable the trigger
	IF (OBJECT_ID(N'trg_ERS_Procedures_Update') IS NOT NULL)
		ALTER TABLE ERS_Procedures ENABLE TRIGGER trg_ERS_Procedures_Update

    PRINT N'Creating Foreign Key [dbo].[FK_ERS_Procedures_ERS_Users]...';
	ALTER TABLE [dbo].[ERS_Procedures] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_Procedures_ERS_Users] FOREIGN KEY ([ListConsultant]) REFERENCES [dbo].[ERS_Users] ([UserID]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_Procedures'
      AND CONSTRAINT_NAME = 'FK_ERS_Procedures_ERS_Users1'
)
BEGIN
	PRINT N'Associating Orphaned Endoscopist1 records with ADMIN user'
	-- disable the trigger if it exists
	IF (OBJECT_ID(N'trg_ERS_Procedures_Update') IS NOT NULL)
		ALTER TABLE ERS_Procedures DISABLE TRIGGER trg_ERS_Procedures_Update

	UPDATE ERS_Procedures
	SET Endoscopist1 = 1
	WHERE Endoscopist1 NOT IN (SELECT UserId
							  FROM ERS_Users)
	
	-- Re-enable the trigger
	IF (OBJECT_ID(N'trg_ERS_Procedures_Update') IS NOT NULL)
		ALTER TABLE ERS_Procedures ENABLE TRIGGER trg_ERS_Procedures_Update

    PRINT N'Creating Foreign Key [dbo].[FK_ERS_Procedures_ERS_Users1]...';
	ALTER TABLE [dbo].[ERS_Procedures] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_Procedures_ERS_Users1] FOREIGN KEY ([Endoscopist1]) REFERENCES [dbo].[ERS_Users] ([UserID]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_Procedures'
      AND CONSTRAINT_NAME = 'FK_ERS_Procedures_ERS_Users2'
)
BEGIN
	PRINT N'Removing Endoscopist2 entry for Procedures where User not in ERS_USERS table'
	-- disable the trigger if it exists
	IF (OBJECT_ID(N'trg_ERS_Procedures_Update') IS NOT NULL)
		ALTER TABLE ERS_Procedures DISABLE TRIGGER trg_ERS_Procedures_Update

	UPDATE ERS_Procedures
	SET Endoscopist2 = NULL
	WHERE Endoscopist2 NOT IN (SELECT UserId
							  FROM ERS_Users)
	
	-- Re-enable the trigger
	IF (OBJECT_ID(N'trg_ERS_Procedures_Update') IS NOT NULL)
		ALTER TABLE ERS_Procedures ENABLE TRIGGER trg_ERS_Procedures_Update

    PRINT N'Creating Foreign Key [dbo].[FK_ERS_Procedures_ERS_Users2]...';
	ALTER TABLE [dbo].[ERS_Procedures] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_Procedures_ERS_Users2] FOREIGN KEY ([Endoscopist2]) REFERENCES [dbo].[ERS_Users] ([UserID]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_Procedures'
      AND CONSTRAINT_NAME = 'FK_ERS_Procedures_ERS_Users3'
)
BEGIN
    PRINT N'Removing Nurse1 entry for Procedures where User not in ERS_USERS table'
	-- disable the trigger if it exists
	IF (OBJECT_ID(N'trg_ERS_Procedures_Update') IS NOT NULL)
		ALTER TABLE ERS_Procedures DISABLE TRIGGER trg_ERS_Procedures_Update

	UPDATE ERS_Procedures
	SET Nurse1 = NULL
	WHERE Nurse1 NOT IN (SELECT UserId
							  FROM ERS_Users)
	
	-- Re-enable the trigger
	IF (OBJECT_ID(N'trg_ERS_Procedures_Update') IS NOT NULL)
		ALTER TABLE ERS_Procedures ENABLE TRIGGER trg_ERS_Procedures_Update

    PRINT N'Creating Foreign Key [dbo].[FK_ERS_Procedures_ERS_Users3]...';
	ALTER TABLE [dbo].[ERS_Procedures] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_Procedures_ERS_Users3] FOREIGN KEY ([Nurse1]) REFERENCES [dbo].[ERS_Users] ([UserID]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_Procedures'
      AND CONSTRAINT_NAME = 'FK_ERS_Procedures_ERS_Users4'
)
BEGIN
    PRINT N'Removing Nurse2 entry for Procedures where User not in ERS_USERS table'
	-- disable the trigger if it exists
	IF (OBJECT_ID(N'trg_ERS_Procedures_Update') IS NOT NULL)
		ALTER TABLE ERS_Procedures DISABLE TRIGGER trg_ERS_Procedures_Update

	UPDATE ERS_Procedures
	SET Nurse2 = NULL
	WHERE Nurse2 NOT IN (SELECT UserId
							  FROM ERS_Users)
	
	-- Re-enable the trigger
	IF (OBJECT_ID(N'trg_ERS_Procedures_Update') IS NOT NULL)
		ALTER TABLE ERS_Procedures ENABLE TRIGGER trg_ERS_Procedures_Update

    PRINT N'Creating Foreign Key [dbo].[FK_ERS_Procedures_ERS_Users4]...';
	ALTER TABLE [dbo].[ERS_Procedures] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_Procedures_ERS_Users4] FOREIGN KEY ([Nurse2]) REFERENCES [dbo].[ERS_Users] ([UserID]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_Procedures'
      AND CONSTRAINT_NAME = 'FK_ERS_Procedures_ERS_Users5'
)
BEGIN
    PRINT N'Removing Nurse3 entry for Procedures where User not in ERS_USERS table'
	-- disable the trigger if it exists
	IF (OBJECT_ID(N'trg_ERS_Procedures_Update') IS NOT NULL)
		ALTER TABLE ERS_Procedures DISABLE TRIGGER trg_ERS_Procedures_Update

	UPDATE ERS_Procedures
	SET Nurse3 = NULL
	WHERE Nurse3 NOT IN (SELECT UserId
							  FROM ERS_Users)
	
	-- Re-enable the trigger
	IF (OBJECT_ID(N'trg_ERS_Procedures_Update') IS NOT NULL)
		ALTER TABLE ERS_Procedures ENABLE TRIGGER trg_ERS_Procedures_Update

    PRINT N'Creating Foreign Key [dbo].[FK_ERS_Procedures_ERS_Users5]...';
	ALTER TABLE [dbo].[ERS_Procedures] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_Procedures_ERS_Users5] FOREIGN KEY ([Nurse3]) REFERENCES [dbo].[ERS_Users] ([UserID]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_Procedures'
      AND CONSTRAINT_NAME = 'FK_ERS_Procedures_ERS_Users6'
)
BEGIN
    PRINT N'Removing Nurse4 entry for Procedures where User not in ERS_USERS table'
	-- disable the trigger if it exists
	IF (OBJECT_ID(N'trg_ERS_Procedures_Update') IS NOT NULL)
		ALTER TABLE ERS_Procedures DISABLE TRIGGER trg_ERS_Procedures_Update

	UPDATE ERS_Procedures
	SET Nurse4 = NULL
	WHERE Nurse4 NOT IN (SELECT UserId
							  FROM ERS_Users)
	
	-- Re-enable the trigger
	IF (OBJECT_ID(N'trg_ERS_Procedures_Update') IS NOT NULL)
		ALTER TABLE ERS_Procedures ENABLE TRIGGER trg_ERS_Procedures_Update

    PRINT N'Creating Foreign Key [dbo].[FK_ERS_Procedures_ERS_Users6]...';
	ALTER TABLE [dbo].[ERS_Procedures] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_Procedures_ERS_Users6] FOREIGN KEY ([Nurse4]) REFERENCES [dbo].[ERS_Users] ([UserID]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_ProcedureSedationScore'
      AND CONSTRAINT_NAME = 'FK_ERS_ProcedureSedationScore_ERS_Procedures'
)
BEGIN
    PRINT N'Removing Orphaned Procedure data in ProcedureSedationScore'
	DELETE
	FROM ERS_ProcedureSedationScore
	WHERE ProcedureId not in (
		SELECT ProcedureId
		FROM ERS_Procedures)
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedureSedationScore_ERS_Procedures]...';
	ALTER TABLE [dbo].[ERS_ProcedureSedationScore] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_ProcedureSedationScore_ERS_Procedures] FOREIGN KEY ([ProcedureId]) REFERENCES [dbo].[ERS_Procedures] ([ProcedureId]);
END;

GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_TYPE = 'FOREIGN KEY'
      AND TABLE_NAME = 'ERS_ProcedureSedationScore'
      AND CONSTRAINT_NAME = 'FK_ERS_ProcedureSedationScore_ERS_SedationScores'
)
BEGIN
    PRINT N'Removing Orphaned SedationScore data in ProcedureSedationScore'
	DELETE
	FROM ERS_ProcedureSedationScore
	WHERE SedationScoreId not in (
		SELECT UniqueId
		FROM ERS_SedationScores)
	
    PRINT N'Creating Foreign Key [dbo].[FK_ERS_ProcedureSedationScore_ERS_SedationScores]...';
	ALTER TABLE [dbo].[ERS_ProcedureSedationScore] WITH NOCHECK
    ADD CONSTRAINT [FK_ERS_ProcedureSedationScore_ERS_SedationScores] FOREIGN KEY ([SedationScoreId]) REFERENCES [dbo].[ERS_SedationScores] ([UniqueId]);
END;

GO

PRINT N'Checking existing data against newly created constraints';

GO
ALTER TABLE [dbo].[ERS_AppointmentTherapeutics] WITH CHECK CHECK CONSTRAINT [FK_ERS_AppointmentTherapeutics_ERS_TherapeuticTypes];

ALTER TABLE [dbo].[ERS_ConsultantProcedureTherapeutics] WITH CHECK CHECK CONSTRAINT [FK_ERS_ConsultantProcedureTherapeutics_ERS_TherapeuticTypes];

ALTER TABLE [dbo].[ERS_AdverseEventsProcedureTypes] WITH CHECK CHECK CONSTRAINT [FK_ERS_AdverseEventsProcedureTypes_ERS_AdverseEvents];

ALTER TABLE [dbo].[ERS_Appointments] WITH CHECK CHECK CONSTRAINT [FK_ERS_Appointments_StaffAccessedId];

ALTER TABLE [dbo].[ERS_BiopsySitesProcedureTypes] WITH CHECK CHECK CONSTRAINT [FK_ERS_BiopsySitesProcedureTypes_ERS_BiopsySites];

ALTER TABLE [dbo].[ERS_ProcedureAdverseEvents] WITH CHECK CHECK CONSTRAINT [FK_ERS_ProcedureAdverseEvents_ERS_AdverseEvents];

ALTER TABLE [dbo].[ERS_ProcedureAdverseEvents] WITH CHECK CHECK CONSTRAINT [FK_ERS_ProcedureAdverseEvents_ERS_Procedures];

ALTER TABLE [dbo].[ERS_ProcedureAISoftware] WITH CHECK CHECK CONSTRAINT [FK_ERS_ProcedureAISoftware_ERS_AISoftware];

ALTER TABLE [dbo].[ERS_ProcedureAISoftware] WITH CHECK CHECK CONSTRAINT [FK_ERS_ProcedureAISoftware_ERS_Procedures];

ALTER TABLE [dbo].[ERS_ProcedureBowelPrep] WITH CHECK CHECK CONSTRAINT [FK_ERS_ProcedureBowelPrep_ERS_BowelPrep];

ALTER TABLE [dbo].[ERS_ProcedureBronchoReferralData] WITH CHECK CHECK CONSTRAINT [FK_ERS_ProcedureBronchoReferralData_ERS_Procedures];

ALTER TABLE [dbo].[ERS_ProcedureChromendosopy] WITH CHECK CHECK CONSTRAINT [FK_ERS_ProcedureChromendosopy_ERS_Chromendoscopies];

ALTER TABLE [dbo].[ERS_ProcedureChromendosopy] WITH CHECK CHECK CONSTRAINT [FK_ERS_ProcedureChromendosopy_ERS_Procedures];

ALTER TABLE [dbo].[ERS_ProcedureComorbidity] WITH CHECK CHECK CONSTRAINT [FK_ERS_ProcedureComorbidity_ERS_Comorbidity];

ALTER TABLE [dbo].[ERS_ProcedureComorbidity] WITH CHECK CHECK CONSTRAINT [FK_ERS_ProcedureComorbidity_ERS_Procedures];

ALTER TABLE [dbo].[ERS_ProcedureDamagingDrugs] WITH CHECK CHECK CONSTRAINT [FK_ERS_ProcedureDamagingDrugs_ERS_PotentialDamagingDrugs];

--ALTER TABLE [dbo].[ERS_ProcedureDamagingDrugs] WITH CHECK CHECK CONSTRAINT [FK_ERS_ProcedureDamagingDrugs_ERS_Procedures];

ALTER TABLE [dbo].[ERS_ProcedureDICAScores] WITH CHECK CHECK CONSTRAINT [FK_ERS_ProcedureDICAScores_ERS_Sites];

ALTER TABLE [dbo].[ERS_ProcedureDiscomfortScore] WITH CHECK CHECK CONSTRAINT [FK_ERS_ProcedureDiscomfortScore_ERS_Procedures];

ALTER TABLE [dbo].[ERS_ProcedureDistalAttachment] WITH CHECK CHECK CONSTRAINT [FK_ERS_ProcedureDistalAttachment_ERS_DistalAttachments];

ALTER TABLE [dbo].[ERS_ProcedureDistalAttachment] WITH CHECK CHECK CONSTRAINT [FK_ERS_ProcedureDistalAttachment_ERS_Procedures];

ALTER TABLE [dbo].[ERS_ProcedureEnteroscopyTechniques] WITH CHECK CHECK CONSTRAINT [FK_ERS_ProcedureEnteroscopyTechniques_ERS_EnteroscopyTechniques];

ALTER TABLE [dbo].[ERS_ProcedureEnteroscopyTechniques] WITH CHECK CHECK CONSTRAINT [FK_ERS_ProcedureEnteroscopyTechniques_ERS_Procedures];

ALTER TABLE [dbo].[ERS_ProcedureImagingMethod] WITH CHECK CHECK CONSTRAINT [FK_ERS_ProcedureImagingMethod_ERS_ImagingMethods];

ALTER TABLE [dbo].[ERS_ProcedureImagingMethod] WITH CHECK CHECK CONSTRAINT [FK_ERS_ProcedureImagingMethod_ERS_Procedures];

ALTER TABLE [dbo].[ERS_ProcedureImagingOutcome] WITH CHECK CHECK CONSTRAINT [FK_ERS_ProcedureImagingOutcome_ERS_ImagingOutcomes];

ALTER TABLE [dbo].[ERS_ProcedureImagingOutcome] WITH CHECK CHECK CONSTRAINT [FK_ERS_ProcedureImagingOutcome_ERS_Procedures];

ALTER TABLE [dbo].[ERS_ProcedureIndications] WITH CHECK CHECK CONSTRAINT [FK_ERS_ProcedureIndications_ERS_Indications];

ALTER TABLE [dbo].[ERS_ProcedureIndications] WITH CHECK CHECK CONSTRAINT [FK_ERS_ProcedureIndications_ERS_Procedures];

ALTER TABLE [dbo].[ERS_ProcedureInsertionTechnique] WITH CHECK CHECK CONSTRAINT [FK_ERS_ProcedureInsertionTechnique_ERS_InsertionTechniques];

ALTER TABLE [dbo].[ERS_ProcedureInsertionTechnique] WITH CHECK CHECK CONSTRAINT [FK_ERS_ProcedureInsertionTechnique_ERS_Procedures];

ALTER TABLE [dbo].[ERS_ProcedureInsufflation] WITH CHECK CHECK CONSTRAINT [FK_ERS_ProcedureInsufflation_ERS_Insufflation];

ALTER TABLE [dbo].[ERS_ProcedureInsufflation] WITH CHECK CHECK CONSTRAINT [FK_ERS_ProcedureInsufflation_ERS_Procedures];

ALTER TABLE [dbo].[ERS_ProcedureLevelOfComplexity] WITH CHECK CHECK CONSTRAINT [FK_ERS_ProcedureLevelOfComplexity_ERS_LevelOfComplexity];

ALTER TABLE [dbo].[ERS_ProcedureLevelOfComplexity] WITH CHECK CHECK CONSTRAINT [FK_ERS_ProcedureLevelOfComplexity_ERS_Procedures];

ALTER TABLE [dbo].[ERS_ProcedureLUTSIPSSSymptoms] WITH CHECK CHECK CONSTRAINT [FK_ERS_ProcedureLUTSIPSSSymptoms_ERS_LUTSIPSSSymptoms];

ALTER TABLE [dbo].[ERS_ProcedureLUTSIPSSSymptoms] WITH CHECK CHECK CONSTRAINT [FK_ERS_ProcedureLUTSIPSSSymptoms_ERS_Procedures];

ALTER TABLE [dbo].[ERS_ProcedureManagement] WITH CHECK CHECK CONSTRAINT [FK_ERS_ProcedureManagement_ERS_Management];

ALTER TABLE [dbo].[ERS_ProcedureManagement] WITH CHECK CHECK CONSTRAINT [FK_ERS_ProcedureManagement_ERS_Procedures];

ALTER TABLE [dbo].[ERS_ProcedureMucosalCleaning] WITH CHECK CHECK CONSTRAINT [FK_ERS_ProcedureMucosalCleaning_ERS_MucosalCleaning];

ALTER TABLE [dbo].[ERS_ProcedureMucosalCleaning] WITH CHECK CHECK CONSTRAINT [FK_ERS_ProcedureMucosalCleaning_ERS_Procedures];

ALTER TABLE [dbo].[ERS_ProcedureMucosalVisualisation] WITH CHECK CHECK CONSTRAINT [FK_ERS_ProcedureMucosalVisualisation_ERS_MucosalVisualisation];

ALTER TABLE [dbo].[ERS_ProcedureMucosalVisualisation] WITH CHECK CHECK CONSTRAINT [FK_ERS_ProcedureMucosalVisualisation_ERS_Procedures];

ALTER TABLE [dbo].[ERS_ProcedurePathwayPlanAnswers] WITH CHECK CHECK CONSTRAINT [FK_ERS_ProcedurePathwayPlanAnswers_ERS_PathwayPlanQuestions];

ALTER TABLE [dbo].[ERS_Procedures] WITH CHECK CHECK CONSTRAINT [FK_ERS_Procedures_ERS_Diagrams];

ALTER TABLE [dbo].[ERS_Procedures] WITH CHECK CHECK CONSTRAINT [FK_ERS_Procedures_ERS_DistalAttachments];

ALTER TABLE [dbo].[ERS_Procedures] WITH CHECK CHECK CONSTRAINT [FK_ERS_Procedures_ERS_Orders];

ALTER TABLE [dbo].[ERS_Procedures] WITH CHECK CHECK CONSTRAINT [FK_ERS_Procedures_ERS_ProviderOrganisation];

ALTER TABLE [dbo].[ERS_Procedures] WITH CHECK CHECK CONSTRAINT [FK_ERS_Procedures_ERS_ProviderSectors];

ALTER TABLE [dbo].[ERS_Procedures] WITH CHECK CHECK CONSTRAINT [FK_ERS_Procedures_ERS_ReferrerTypes];

ALTER TABLE [dbo].[ERS_Procedures] WITH CHECK CHECK CONSTRAINT [FK_ERS_Procedures_ERS_ReferringHospitals];

ALTER TABLE [dbo].[ERS_Procedures] WITH CHECK CHECK CONSTRAINT [FK_ERS_Procedures_ERS_Scopes1];

ALTER TABLE [dbo].[ERS_Procedures] WITH CHECK CHECK CONSTRAINT [FK_ERS_Procedures_ERS_Users];

ALTER TABLE [dbo].[ERS_Procedures] WITH CHECK CHECK CONSTRAINT [FK_ERS_Procedures_ERS_Users1];

ALTER TABLE [dbo].[ERS_Procedures] WITH CHECK CHECK CONSTRAINT [FK_ERS_Procedures_ERS_Users2];

ALTER TABLE [dbo].[ERS_Procedures] WITH CHECK CHECK CONSTRAINT [FK_ERS_Procedures_ERS_Users3];

ALTER TABLE [dbo].[ERS_Procedures] WITH CHECK CHECK CONSTRAINT [FK_ERS_Procedures_ERS_Users4];

ALTER TABLE [dbo].[ERS_Procedures] WITH CHECK CHECK CONSTRAINT [FK_ERS_Procedures_ERS_Users5];

ALTER TABLE [dbo].[ERS_Procedures] WITH CHECK CHECK CONSTRAINT [FK_ERS_Procedures_ERS_Users6];

ALTER TABLE [dbo].[ERS_ProcedureSedationScore] WITH CHECK CHECK CONSTRAINT [FK_ERS_ProcedureSedationScore_ERS_Procedures];

ALTER TABLE [dbo].[ERS_ProcedureSedationScore] WITH CHECK CHECK CONSTRAINT [FK_ERS_ProcedureSedationScore_ERS_SedationScores];

GO
-------------------------------------------------------------------------------------------------------------------------
-- End of Add Foreign Keys
-------------------------------------------------------------------------------------------------------------------------
Go
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Mahfuz	On 01 Feb 2024
-- TFS#	2885
-- Description of change
-- Cancelled reports - remove Diagnoses from report for Cancelled Reports
------------------------------------------------------------------------------------------------------------------------
Go

EXEC DropIfExist 'usp_PrintReport_Select','S';
GO
CREATE PROCEDURE [dbo].[usp_PrintReport_Select]  
(  
 @ProcedureId INT,  
 @Group VARCHAR(10),  
 @EpisodeNo INT = 0,  
       @PatientComboId VARCHAR(30) = NULL,  
       @ProcedureType INT,  
       @ColonType INT  
)  
/*
	Update History:
	01 Feb 2024			:		MH	removed Diagnoses part for DNA / Cancelled reports TFS : 2885 - Cancelled reports
*/
AS  
  
SET NOCOUNT ON  
  
 DECLARE @SQLString NVARCHAR(MAX),  
   @FieldName VARCHAR(150),  
   @NodeName VARCHAR(50),  
   @TableName VARCHAR(50),  
   @Condition VARCHAR(100),  
   @ReportStyle SMALLINT,  
   @ExecQuery BINARY = 0,  
   @IncludeUGI BIT = 0,
   @DNAProcedure smallint = 0,
   @SummaryOrder	INT = 0;  
  
 DECLARE @Procedure_Reporting_TableJoinText VARCHAR(255);  
 select @EpisodeNo=(CASE WHEN dbo.fnShouldIncludeUGI()=1 THEN @EpisodeNo ELSE 0 END);  
 
 select @DNAProcedure  = IsNull(DNA,0) from ERS_Procedures Where ProcedureId = @ProcedureId

 CREATE TABLE #Summary (NodeName VARCHAR(200), NodeSummary NVARCHAR(MAX) ,[Group] VARCHAR(10), [SummaryOrder] INT)  
 CREATE TABLE #xmlmap ([FieldName] [varchar](50), [NodeName] [varchar](50), [Group] [varchar](10), [Active] [smallint], [OrderID] [int])  
  
 --DECLARE @ProcedureTypeId INT  
 --SELECT @ProcedureTypeId = ProcedureType FROM ERS_Procedures WHERE ProcedureId = @ProcedureId  
 
IF @Group = 'AD'  
 INSERT INTO #xmlmap  
 SELECT FieldName, NodeName, [Group], Active, OrderID  
 FROM ERS_XMLMap   
 WHERE [FieldName] IN ('PP_Site_Legend', 'PP_SpecimenTaken')  
 ORDER BY OrderID  
ELSE IF @Group='Premed'  
       INSERT INTO #xmlmap  
       SELECT FieldName, NodeName, [Group], Active, OrderID   
    FROM ERS_XMLMap WHERE [FieldName] IN ('PP_Premed', 'PP_Bowel_Prep') AND [Group]='RS'  
ELSE  
 INSERT INTO #xmlmap  
 SELECT FieldName, NodeName, [Group], Active, OrderID  
 FROM ERS_XMLMap   
 WHERE [Group] = @Group AND [FieldName] NOT IN ('PP_Site_Legend', 'PP_SpecimenTaken')  
 ORDER BY OrderID  
  
  --MH Added on 01 Feb 2024 - TFS 2885 - Cancelled reports
  if @DNAProcedure > 0
  Begin
	Delete from #xmlmap Where FieldName = 'PP_Diagnoses'
  End

 IF @ProcedureId IS NOT NULL AND @ProcedureId > 0  
  BEGIN  
   SET @TableName = '[ERS_Procedures]'  
   SET @Procedure_Reporting_TableJoinText = '  AS P LEFT JOIN dbo.ERS_ProceduresReporting AS PR ON P.ProcedureId = PR.ProcedureId '  
   SET @Condition = 'P.ProcedureId = @ProcedureId'  
  
   IF (SELECT isnull(PP_Pathology, '') from ERS_ProceduresReporting where ProcedureID = @ProcedureId) != ''  
    AND @Group = 'RS'  
    INSERT INTO #Summary   
    Select 'Revised', 'Revised report following pathology report dated ' + isnull(convert(varchar, DateOfReport, 106), ''), 'RS', @SummaryOrder  from ERS_UpperGIPathologyResults where ProcedureId = @ProcedureId  
  END  
 ELSE IF @EpisodeNo > 0  
  BEGIN  
      SELECT TOP 1 @TableName = LTRIM(RTRIM(dbo.fnGetUGI_tablename(@ProcedureType,'procedure')))  
   FROM [Episode]   
   WHERE CHARINDEX('1', [Status]) BETWEEN 1 AND 8 AND [Patient No] = @PatientComboId AND [Episode No] = @EpisodeNo  
   SET @Condition = '[Patient No] = @PatientComboId AND [Episode No] = @EpisodeNo'  
      IF @ColonType >= 0 SET @Condition = @Condition + ' AND [Procedure type] = ' +CAST( @ColonType as varchar(50))  
  END  
  
 DECLARE report_cursor CURSOR FOR   
 SELECT FieldName FROM #xmlmap ORDER BY OrderID ASC  
  
 OPEN report_cursor   
 FETCH NEXT FROM report_cursor INTO @FieldName  
  
 WHILE @@FETCH_STATUS = 0  
 BEGIN  
  SELECT @NodeName = NodeName, @Group = [Group], @SummaryOrder = OrderID FROM #xmlmap WHERE FieldName = @FieldName
	IF (@SummaryOrder IS NULL)
	BEGIN
		SET @SummaryOrder = 0
	END
   
  IF @ProcedureId IS NOT NULL AND @ProcedureId > 0  
  BEGIN  
   IF @FieldName = 'Endoscribe comments' SET @FieldName = 'EndoscribeComments'  
   ELSE IF @FieldName = 'Procedure date' SET @FieldName = 'CreatedOn'  
   ELSE IF @FieldName = 'Time of procedure' SET @FieldName = 'CreatedOn'  
   ELSE IF @FieldName = 'PP2_CompiledOn' SET @FieldName = 'ModifiedOn'  
   ELSE IF @FieldName = 'PP2_SiteData' SET @FieldName = 'PP_Site_Legend'  
   --ELSE IF @FieldName = 'PP_MainReportBody' SET @FieldName = 'Summary'    
  END  
  
  IF @FieldName = 'PP_Premed' AND @ProcedureType in (10, 11) --Bronchoscopy or EBUS
   SET @NodeName = 'Sedation and anaesthesia'  
  
  --IF [Report Style] = 1 -> New style report, select from PP2 field  
  IF @TableName <> '[ERS_Procedures]' AND @EpisodeNo > 0 AND @FieldName = 'PP_MainReportBody'  
    SET @FieldName = 'CASE WHEN ISNULL([Report Style],0) = 0 THEN PP_MainReportBody ELSE PP2_MainReportBody END'  
  ELSE IF @FieldName = 'PP_MainReportBody' AND @ProcedureId > 0 SET @FieldName = 'PR.Summary'    
  ELSE IF @FieldName = 'Resected colon no' AND @ProcedureId > 0 SET @FieldName = 'ResectedColonNo'   

  ELSE  
   SET @FieldName = '[' + @FieldName + ']'  
   
  SET @SQLString = 'INSERT INTO #Summary ' +   
       ' SELECT ''' + @NodeName + ''', ' + @FieldName + ', ' + '''' + @Group + '''' + ', ' + CAST(@SummaryOrder AS NVARCHAR(10)) +  
       ' FROM ' + @TableName +   
       CASE WHEN @ProcedureId>0 THEN @Procedure_Reporting_TableJoinText ELSE '' END +  
       ' WHERE ' + @Condition;  
   
  --PP_Therapies (Therapeutic procedures) should be displayed for UGI old style report only, else should be part of the site  
  IF @TableName <> '[ERS_Procedures]' AND @EpisodeNo > 0   
  BEGIN  
   IF @FieldName IN ('[PP_Therapies]', '[PP_SpecimenTaken]' )  
    SET @SQLString = @SQLString + ' AND ISNULL([Report Style],0) = 0'  
   --PP2_SiteData (Site Data) should not be displayed for UGI old style report  
   ELSE IF @FieldName = '[PP2_SiteData]'  
    SET @SQLString = @SQLString + ' AND ISNULL([Report Style],0) = 1'  
  END   
  
  SET @ExecQuery =   
   CASE   
    WHEN @FieldName = '[PP_NPSAalert]' AND @TableName <> '[Upper GI Procedure]' THEN 0  
    WHEN @FieldName = '[PP_ResectedColon]' AND @EpisodeNo > 0 THEN 0  
    WHEN @FieldName = '[Resected colon no]' AND @TableName <> '[Colon Procedure]' THEN 0  
    WHEN @FieldName = '[PP_Coding]' AND @TableName <> '[ERS_Procedures]' THEN 0  
    WHEN @FieldName = '[Report style]' AND @TableName = '[ERS_Procedures]' THEN 0  
    WHEN LEFT(@FieldName,10) = '[PP2_Patho' AND @TableName = '[ERS_Procedures]' THEN 0  
    ELSE 1  
   END  
  
  --Select @ProcedureId, @EpisodeNo, @PatientComboId, @sqlstring  
  IF @ExecQuery = 1   
  BEGIN  
   EXEC sp_executesql @SQLString,  
    N'@ProcedureId INT, @EpisodeNo INT, @PatientComboId VARCHAR(30)',  
    @ProcedureId, @EpisodeNo, @PatientComboId  
  END  
  
  FETCH NEXT FROM report_cursor INTO @FieldName  
 END  
  
 CLOSE report_cursor  
 DEALLOCATE report_cursor  
  
 IF @EpisodeNo > 0 --UGI  
 BEGIN  
  UPDATE #Summary SET NodeSummary = REPLACE(NodeSummary,char(13),'<BR />') WHERE NodeName in ('Report', 'Indications', 'Advice/comments')   
  --UPDATE #Summary SET NodeSummary = REPLACE(NodeSummary,'<br><b>','<b>') WHERE NodeName in ('Site Data')  
  UPDATE #Summary SET NodeSummary = REPLACE(NodeSummary,'</b>','</b><BR />') WHERE NodeName in ('Site Data')   
  --UPDATE #Summary SET NodeSummary = REPLACE(NodeSummary,char(13),'<BR />&nbsp;&nbsp;') WHERE NodeName in ('Site Data')   
  --UPDATE #Summary SET NodeSummary = REPLACE(NodeSummary,'<BR />&nbsp;&nbsp;<b>','<BR /><b>') WHERE NodeName in ('Site Data')   
 END   
  
 IF EXISTS(SELECT TOP 1 NodeName FROM #Summary WHERE NodeName = 'InstForCare')  
 BEGIN   
  UPDATE #Summary SET NodeName = (SELECT TOP 1 NodeSummary FROM #Summary WHERE NodeName = 'InstForCareHeading')  
   ,NodeSummary = dbo.fnFirstLetterUpper(NodeSummary)  
  WHERE NodeName = 'InstForCare'  
  
  DELETE #Summary WHERE NodeName = 'InstForCareHeading'  
 END  
  
 --Append NPSA alert to end of report section  
 IF (SELECT COUNT(*) FROM #Summary WHERE NodeName = 'Report') > 0  
 BEGIN  
  DECLARE @NPSAalert NVARCHAR(MAX)   
  IF @EpisodeNo > 0  
   SELECT @NPSAalert=CONVERT(NVARCHAR(MAX),[PP_NPSAalert]) FROM  [Upper GI Procedure] WHERE [Patient No] = @PatientComboId AND [Episode No] = @EpisodeNo  
  ELSE IF @ProcedureId IS NOT NULL AND @ProcedureId > 0  
   SELECT @NPSAalert=CONVERT(NVARCHAR(MAX),[PP_NPSAalert]) FROM [ERS_ProceduresReporting] WHERE ProcedureId = @ProcedureId  
  
  IF ISNULL(@NPSAalert,'') <> ''  
   UPDATE #Summary  
   SET NodeSummary = NodeSummary + '<table style="border: 1px solid red;border-radius:10px;-moz-border-radius:10px;-webkit-border-radius:10px;width:95%;"><tr><td style="padding:10px;color:red;">' + @NPSAalert + '</td><td style="width:5%;padding:5px;"><img src="/images/icons/alert.png" style="vertical-align:middle; padding:0px 2px 0px 2px;" /></td></tr></table>'  
   WHERE NodeName = CASE WHEN @EpisodeNo > 0 THEN 'Site Data' ELSE 'Report' END  
 END  
  
	SELECT S.[NodeName], S.[NodeSummary], S.[Group]
	FROM #Summary S
	left outer join #xmlmap x on x.NodeName = S.NodeName
	WHERE S.NodeSummary IS NOT NULL
	order by S.SummaryOrder --x.OrderID 
  
 DROP TABLE #xmlmap  
 DROP TABLE #Summary
Go
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	2885 by Mahfuz
------------------------------------------------------------------------------------------------------------------------
Go

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Steve	On 01 Feb 2024
-- TFS#	3542
-- Description of change
-- Quick Fix for Previous ESD Scar not showing in NED XML, 
--    Changed code from SDESDSCARP3 to SESDSCARP3 in call to diagnoses_control_save for Sigmoid (ProcedureTypeId 4)
-- Updating trigger as quick fix due to time constraints, triggers should be removed in the future
--
-- Updated abnormalities_common_lesions_save to do what the trigger should have been doing on a DELETE but wasn't
--    This will probably need to be tidied up as part of the trigger removal exercise
------------------------------------------------------------------------------------------------------------------------
/****** Object:  Trigger [dbo].[TR_CommonAbnoLesions]    Script Date: 18/01/2024 18:33:49 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

	ALTER TRIGGER [dbo].[TR_CommonAbnoLesions]
	ON [dbo].[ERS_CommonAbnoLesions]
	AFTER INSERT, UPDATE, DELETE
	AS 
		DECLARE @site_id INT, @Polyp VARCHAR(10) = 'False', 
							  @BenignTumour VARCHAR(10) = 'False', 
							  @MalignantTumour VARCHAR(10) = 'False', 
							  @SubmucosalTumour VARCHAR(10) = 'False', 
							  @FocalLesions VARCHAR(10) = 'False',
							  @SubmucoaslLesion VARCHAR(10) = 'False',
							  @FundicGlandPolyp VARCHAR(10) = 'False',
							  @PreviousESDScar VARCHAR(10) = 'False',
				@PolypTypeId INT, @Region VARCHAR(20), @ProcedureTypeId INT, @MatrixCode VARCHAR(50)
	
		IF EXISTS(SELECT * FROM INSERTED)
		BEGIN
			SELECT @site_id=SiteId,
					@Polyp = (CASE WHEN (ISNULL(Polyp,0) = 1) THEN 'True' ELSE 'False' END),
					@FocalLesions = (CASE WHEN (ISNULL(Focal,0) = 1) THEN 'True' ELSE 'False' END),
					@SubmucoaslLesion = (CASE WHEN (ISNULL(Submucosal,0) = 1) THEN 'True' ELSE 'False' END),
					@FundicGlandPolyp = (CASE WHEN (ISNULL(FundicGlandPolyp,0) = 1) THEN 'True' ELSE 'False' END),
					@PolypTypeId = PolypTypeId,
					@PreviousESDScar = (CASE WHEN (ISNULL(PreviousESDScar,0) = 1) THEN 'True' ELSE 'False' END)
				
			FROM INSERTED

			SELECT TOP 1 @ProcedureTypeId =  p.ProcedureType FROM ERS_Sites s INNER JOIN ERS_Procedures p ON p.ProcedureId = s.ProcedureId WHERE s.SiteId = @site_id
			--check if polyps = 1
			IF @Polyp = 'True' 
			BEGIN
				--check for polyp type
				DECLARE @PolypType VARCHAR(200) = (SELECT Description FROM ERS_PolypTypes WHERE UniqueId = @PolypTypeId)

				IF LOWER(@PolypType) = 'sessile'
				BEGIN
					--sessile polyps to produce a gastric tumour outcome depending on the tumour type
					IF EXISTS (SELECT 1 FROM ERS_CommonAbnoPolypDetails WHERE SiteId = @site_id AND Type = (SELECT UniqueId FROM ERS_TumourTypes WHERE Description = 'benign'))
						SET @BenignTumour = 'True'
					ELSE 
						SET @BenignTumour = 'False'

					IF EXISTS (SELECT 1 FROM ERS_CommonAbnoPolypDetails WHERE SiteId = @site_id AND Type = (SELECT UniqueId FROM ERS_TumourTypes WHERE Description = 'malignant'))
						SET @MalignantTumour = 'True'
					ELSE
						SET @MalignantTumour = 'False'
				END
			
				IF LOWER(@PolypType) = 'submucosal'  AND LOWER(@Region) = 'stomach'
					SET @SubmucoaslLesion = 'True'
				ELSE
					SET @SubmucoaslLesion = 'False'

			END
		
			IF @ProcedureTypeId IN (1,6,8)
			BEGIN
				SELECT @Region = dbo.fnSiteRegion(@site_id)

				IF LOWER(@Region) = 'stomach'
				BEGIN
					--SELECT @Polyp = CASE WHEN @FundicGlandPolyp = 'False' AND @BenignTumour = 'False' AND @MalignantTumour = 'False' AND @SubmucosalTumour = 'False' THEN 'True' ELSE 'False' END
					SET @MatrixCode = 'D40P1'
				END
				ELSE IF LOWER(@Region) = 'oesophagus'
					SET @MatrixCode = 'N2013'
				ELSE IF LOWER(@Region) = 'duodenum'
					SET @MatrixCode = 'D58P1'
				ELSE IF LOWER(@Region) = 'colon'
					SET @MatrixCode = 'D58P1'
				
			END
			ELSE IF @ProcedureTypeId IN (3,4,9)
			BEGIN
				SELECT @Region = dbo.fnSiteRegion(@site_id)

				IF @Polyp = 'True' AND @Region IN ('Rectum', 'Anal Margin')
					SET @MatrixCode = 'D4P3'

				IF @Polyp = 'True' AND @Region NOT IN ('Rectum', 'Anal Margin', 'Terminal Ileum')
					SET @MatrixCode = 'D12P3'

				IF @Polyp = 'True' AND @Region IN ('Terminal Ileum', 'Neo-Terminal Ileum')
					SET @MatrixCode = 'DIPOLYPP3'
			END

		END
		ELSE
		BEGIN
			SELECT @site_id=SiteId FROM DELETED
		END

		EXEC abnormalities_common_lesions_summary_update @site_id

		IF @site_id IS NOT NULL AND @ProcedureTypeId IN (1,3,4,6,8,9,2,7)
		BEGIN
			EXEC sites_summary_update @site_id

			EXEC diagnoses_control_save @site_id, @MatrixCode, @Polyp		
			--EXEC diagnoses_control_save @site_id, 'D86P1', @BenignTumour	
			--EXEC diagnoses_control_save @site_id, 'D87P1', @MalignantTumour	
			EXEC diagnoses_control_save @site_id, 'N2001', @FocalLesions
			EXEC diagnoses_control_save @site_id, 'D88P1', @SubmucosalTumour
			EXEC diagnoses_control_save @site_id, 'N2002', @SubmucoaslLesion
			EXEC diagnoses_control_save @site_id, 'N2019', @FundicGlandPolyp

			IF @ProcedureTypeId IN (1,6,8)
			BEGIN
			    EXEC diagnoses_control_save @site_id, 'DSESDSCARP1', @PreviousESDScar		
			END
			ELSE IF @ProcedureTypeId IN (2,7)
			BEGIN
				EXEC diagnoses_control_save @site_id, 'DDESDSCARP2', @PreviousESDScar
			END
			ELSE IF @ProcedureTypeId IN (3,9)
			BEGIN
				EXEC diagnoses_control_save @site_id, 'DESDSCARP3', @PreviousESDScar
			END
			ELSE IF @ProcedureTypeId = 4
			BEGIN
				EXEC diagnoses_control_save @site_id, 'SESDSCARP3', @PreviousESDScar
			END
		END
GO


EXEC dbo.DropIfExist @ObjectName = 'abnormalities_common_lesions_save',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)

GO
CREATE PROCEDURE [dbo].[abnormalities_common_lesions_save]
(
	@SiteId int,
	@None bit,
	@Polyp bit,
	@PolypTypeId int,
	@Tattooed bit,
	@PreviouslyTattooed bit,
	@TattooType int,
	@TattooedQuantity int,
	@TattooedBy int,
	@Submucosal bit,
	@SubmucosalQuantity int,
	@SubmucosalLargest int,
	@SubmucosalProbably bit,
	@SubmucosalTumourTypeId int,
	@Focal bit,
	@FocalQuantity int,
	@FocalLargest int,
	@FocalProbably bit,
	@FocalTumourTypeId int,
	@FundicGlandPolyp BIT,
	@FundicGlandPolypQuantity INT,
	@FundicGlandPolypLargest numeric(18,2),
	@PreviousESDScar BIT,
	@LoggedInUserId int
)
AS

SET NOCOUNT ON

DECLARE @proc_id INT
DECLARE @proc_type INT
DECLARE @Insert BIT = 0

BEGIN TRANSACTION

BEGIN TRY
	SELECT 
		@proc_id = p.ProcedureId,
		@proc_type = p.ProcedureType
	FROM 
		ERS_Sites s
	JOIN 
		ERS_Procedures p ON s.ProcedureId = p.ProcedureId
	WHERE 
		SiteId = @SiteId
	

	IF (@None = 0 AND @Polyp = 0 AND @Submucosal = 0 AND @Focal = 0 AND @FundicGlandPolyp = 0 AND @PreviousESDScar = 0)
	BEGIN
		IF EXISTS (SELECT 1 FROM [ERS_CommonAbnoLesions] WHERE SiteId = @SiteId)
		BEGIN
			DELETE FROM [ERS_CommonAbnoLesions] 
			WHERE SiteId = @SiteId

			DELETE FROM ERS_RecordCount 
			WHERE SiteId = @SiteId
			AND Identifier = 'Lesions'

-- This might need to be tidied up when we remove triggers
			EXEC abnormalities_common_lesions_summary_update @SiteId

			IF @SiteId IS NOT NULL AND @proc_type IN (1,3,4,6,8,9,2,7)
			BEGIN
				EXEC sites_summary_update @SiteId

				EXEC diagnoses_control_save @SiteId, '', 'False'	
				EXEC diagnoses_control_save @SiteId, 'N2001', 'False'
				EXEC diagnoses_control_save @SiteId, 'D88P1', 'False'
				EXEC diagnoses_control_save @SiteId, 'N2002', 'False'
				EXEC diagnoses_control_save @SiteId, 'N2019', 'False'

				IF @proc_type IN (1,6,8)
				BEGIN
					EXEC diagnoses_control_save @SiteId, 'D40P1', 'False'
					EXEC diagnoses_control_save @SiteId, 'N2013', 'False'
					EXEC diagnoses_control_save @SiteId, 'D58P1', 'False'
					EXEC diagnoses_control_save @SiteId, 'D58P1', 'False'
					EXEC diagnoses_control_save @SiteId, 'DSESDSCARP1', @PreviousESDScar		
				END
				ELSE IF @proc_type IN (2,7)
				BEGIN
					EXEC diagnoses_control_save @SiteId, 'DDESDSCARP2', @PreviousESDScar
				END
				ELSE IF @proc_type IN (3,9)
				BEGIN
					EXEC diagnoses_control_save @SiteId, 'D4P3', 'False'
					EXEC diagnoses_control_save @SiteId, 'D12P3', 'False'
					EXEC diagnoses_control_save @SiteId, 'DIPOLYPP3', 'False'
					EXEC diagnoses_control_save @SiteId, 'DESDSCARP3', @PreviousESDScar
				END
				ELSE IF @proc_type = 4
				BEGIN
					EXEC diagnoses_control_save @SiteId, 'D4P3', 'False'
					EXEC diagnoses_control_save @SiteId, 'D12P3', 'False'
					EXEC diagnoses_control_save @SiteId, 'DIPOLYPP3', 'False'
					EXEC diagnoses_control_save @SiteId, 'SESDSCARP3', @PreviousESDScar
				END
			END
		END
	END

	ELSE IF NOT EXISTS (SELECT 1 FROM [ERS_CommonAbnoLesions] WHERE SiteId = @SiteId)
	BEGIN
		INSERT INTO [ERS_CommonAbnoLesions] (
			[SiteId],
			[None],
			[Polyp],
			[PolypTypeId],
			[Tattooed],
			[PreviouslyTattooed],
			[TattooType],
			[TattooedQuantity],
			[TattooedBy],
			[Submucosal],
			[SubmucosalQuantity],
			[SubmucosalLargest],
			[SubmucosalProbably],
			[SubmucosalTumourTypeId],
			[Focal],
			[FocalQuantity],
			[FocalLargest],
			[FocalProbably],
			[FocalTumourTypeId],
			[Granuloma],
			[Dysplastic],
			[PneumatosisColi],
			FundicGlandPolyp,
			FundicGlandPolypQuantity,
			FundicGlandPolypLargest,
			PreviousESDScar,
			[WhoCreatedId],
			[WhenCreated]) 
		VALUES (
			@SiteId,
			@None,
			@Polyp,
			@PolypTypeId,
			@Tattooed,
			@PreviouslyTattooed,
			@TattooType,
			@TattooedQuantity,
			@TattooedBy,
			@Submucosal,
			@SubmucosalQuantity,
			@SubmucosalLargest,
			@SubmucosalProbably,
			@SubmucosalTumourTypeId,
			@Focal,
			@FocalQuantity,
			@FocalLargest,
			@FocalProbably,
			@FocalTumourTypeId,
			0,
			0,
			0,
			@FundicGlandPolyp,
			@FundicGlandPolypQuantity,
			@FundicGlandPolypLargest,
			@PreviousESDScar,
			@LoggedInUserId,
			GETDATE())

		INSERT INTO ERS_RecordCount (
			[ProcedureId],
			[SiteId],
			[Identifier],
			[RecordCount]
		)
		VALUES (
			@proc_id,
			@SiteId,
			'Lesions',
			1)

			SET @Insert = 1
	END

	ELSE
	BEGIN
		UPDATE 
			[ERS_CommonAbnoLesions]
		SET 
			[None]=@None,
			Polyp=@Polyp,
			PolypTypeId = @PolypTypeId,
			Tattooed=@Tattooed,
			PreviouslyTattooed=@PreviouslyTattooed,
			TattooType=@TattooType,
			TattooedQuantity=@TattooedQuantity,
			TattooedBy=@TattooedBy,
			Submucosal=@Submucosal,
			SubmucosalQuantity=@SubmucosalQuantity,
			SubmucosalLargest=@SubmucosalLargest,
			SubmucosalProbably=@SubmucosalProbably,
			SubmucosalTumourTypeId=@SubmucosalTumourTypeId,
			Focal=@Focal,
			FocalQuantity=@FocalQuantity,
			FocalLargest=@FocalLargest,
			FocalProbably=@FocalProbably,
			FocalTumourTypeId=@FocalTumourTypeId,
			FundicGlandPolyp = @FundicGlandPolyp,
			FundicGlandPolypQuantity = @FundicGlandPolypQuantity,
			FundicGlandPolypLargest = @FundicGlandPolypLargest,
			PreviousESDScar = @PreviousESDScar,
			WhoUpdatedId = @LoggedInUserId,
			WhenUpdated = GETDATE()
		WHERE 
			SiteId = @SiteId
	END

	

	--Save Polypectomy in ERS_UpperGITherapeutics
	/*IF (@Insert=1) --only on an insert?.. so if they go and change in Therapeutic types and come back here and alter changes wont be carried across again
	BEGIN
	DECLARE @RemovalType tinyint
	DECLARE @Removal tinyint
	DECLARE @SentToLabs int

		IF @Sessile = 1 OR @Pedunculated = 1 OR @Pseudopolyps = 1
		BEGIN
			IF @Sessile = 1
			BEGIN
				SET @Removal = @SessileRemoval
				SET @RemovalType = @SessileRemovalMethod
				SET @SentToLabs = ISNULL(@SessileToLabs,0)
			END
			ELSE IF @Pedunculated = 1
			BEGIN
				SET @Removal = @PedunculatedRemoval
				SET @RemovalType = @PedunculatedRemovalMethod
				SET @SentToLabs = ISNULL(@PedunculatedToLabs,0)
			END
			ELSE IF @Pseudopolyps = 1
			BEGIN
				SET @Removal = @PseudopolypsRemoval
				SET @RemovalType = @PseudopolypsRemovalMethod
				SET @SentToLabs = ISNULL(@PseudopolypsToLabs,0)
			END	

			IF @Removal > 0 OR @RemovalType > 0 or @Tattooed = 1
			BEGIN
				IF NOT EXISTS (SELECT 1 FROM ERS_UpperGITherapeutics WHERE SiteId = @SiteId)
				BEGIN
					INSERT INTO ERS_UpperGITherapeutics (SiteId, Marking,	MarkingType, MarkedQuantity,	Polypectomy,	PolypectomyRemoval, PolypectomyRemovalType, CarriedOutRole, EndoRole, WhoCreatedId, WhenCreated) 
					VALUES (@SiteId, ISNULL(@Tattooed,0), @TattooType, @TattooedQty,	@Removal,	@Removal, @RemovalType, 1, 1, @LoggedInUserId, GETDATE())

					IF NOT EXISTS (SELECT 1 FROM ERS_RecordCount WHERE ProcedureId = @proc_id AND SiteId = @SiteId AND Identifier = 'Therapeutic Procedures')
					BEGIN
						INSERT INTO ERS_RecordCount ([ProcedureId],	[SiteId], [Identifier], [RecordCount])
						VALUES (@proc_id, @SiteId, 'Therapeutic Procedures', 1)
					END 
				END
				ELSE IF EXISTS (SELECT 1 FROM ERS_UpperGITherapeutics WHERE SiteId = @SiteId AND CarriedOutRole = 1)
				BEGIN
					UPDATE ERS_UpperGITherapeutics
					SET Polypectomy = 1,						
						PolypectomyRemoval = @Removal,
						PolypectomyRemovalType = @RemovalType,
						Marking = ISNULL(@Tattooed,0),	
						MarkingType = @TattooType, 
						MarkedQuantity = @TattooedQty,
						WhoUpdatedId = @LoggedInUserId,
						WhenUpdated = GETDATE()
					WHERE
						SiteId = @SiteId AND
						CarriedOutRole = 1
				END
				ELSE
				BEGIN
					UPDATE ERS_UpperGITherapeutics
					SET Polypectomy = 1,						
						PolypectomyRemoval = @Removal,
						PolypectomyRemovalType = @RemovalType,
						Marking = @Tattooed,	
						MarkingType = @TattooType, 
						MarkedQuantity = @TattooedQty,
						WhoUpdatedId = @LoggedInUserId,
						WhenUpdated = GETDATE()
					WHERE 
						SiteId = @SiteId AND
						CarriedOutRole = 2
				END
			END

			IF @SentToLabs > 0 
			BEGIN
				--update specimens as endo took a polypectomy which is a specimen
				IF NOT EXISTS (SELECT 1 FROM ERS_UpperGISpecimens WHERE SiteId = @SiteId)
				BEGIN
					INSERT INTO ERS_UpperGISpecimens (SiteId, Polypectomy, PolypectomyQty, WhoCreatedId, WhenCreated)
					VALUES (@SiteId, 1, @SentToLabs, @LoggedInUserId, GETDATE())
				END
				ELSE
					UPDATE ERS_UpperGISpecimens 
					SET Polypectomy = 1, 
						PolypectomyQty = (ISNULL(PolypectomyQty, 0) + @SentToLabs), 
						WhoUpdatedId = @LoggedInUserId, 
						WhenUpdated = GETDATE() 
					WHERE SiteId = @SiteId

				IF NOT EXISTS (SELECT 1 FROM ERS_RecordCount WHERE SiteId= @SiteId AND Identifier = 'Specimens Taken')
					INSERT INTO ERS_RecordCount ([ProcedureId],	[SiteId], [Identifier], [RecordCount])
					VALUES (@proc_id, @SiteId, 'Specimens Taken', 1)

				--prefill follow up tab as endo is now awaiting pathology results as a specimen was taken
				IF NOT EXISTS (SELECT 1 FROM ERS_UpperGIFollowUp WHERE ProcedureId = @proc_id)
				BEGIN
					INSERT INTO ERS_UpperGIFollowUp (ProcedureId, AwaitingPathologyResults, WhoCreatedId, WhenCreated)
					VALUES (@proc_id, 1, @LoggedInUserId, GETDATE())
				END
				ELSE
					UPDATE ERS_UpperGIFollowUp 
					SET AwaitingPathologyResults = 1, 
						WhoUpdatedId = @LoggedInUserId, 
						WhenUpdated = GETDATE()  
					WHERE ProcedureId = @proc_id


			END
		END	
	END
*/
END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;

GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	3542 by Steve
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Steve	On 01 Feb 2024
-- TFS#	2065
-- Description of change
-- Mucosal Junction box
--    Fix for error that was being thrown trying to add a varchar and integer when building string for summary
--    Converted integer value to varchar(50) so that the string is concatinated rather than attempting addition on it
------------------------------------------------------------------------------------------------------------------------
GO

EXEC dbo.DropIfExist @ObjectName = 'procedure_upper_extent_save',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)

GO
CREATE PROCEDURE [dbo].[procedure_upper_extent_save]
(
	@ProcedureId int,
	@ExtentId int,
	@AdditionalInfo varchar(max),
	@EndoscopistId int,
	@JManoeuvreId int, 
	@LimitedById int, 
	@WithdrawalMins int,
	@MucosalJunctionDistance int,
	@LimitationOther varchar(max),
	@LoggedInUserId int
)
AS
/*
--	Update History
01.			04 Jan 2023		MH added Order Message Send block while saving Extent of Intubation TFS #2475
							No extra parameter required. ProcedureId will have associated OrderId and Extent Limited By value
02.			21 March 2023	AJ j manouver handled if -1 (not specified)
03.			27 March 2023	AJ Set sections as not entered based on the extent reached
04.			08 June 2023	SG Add call to ogd_diagnoses_summary_update to ensure report gets populated with Normal if no abnormalities are added
05.         08 Nov 2023     MS Add MucosalJunctionDistance column and related logic
							
*/
BEGIN
	Declare @bitHasProcedureFailed as bit
	Set @bitHasProcedureFailed = 0

	IF NOT EXISTS (SELECT 1 FROM ERS_ProcedureUpperExtent WHERE ProcedureId = @ProcedureId AND EndoscopistId = @EndoscopistId)
	BEGIN
		INSERT INTO ERS_ProcedureUpperExtent (ProcedureId, ExtentId, AdditionalInfo, EndoscopistId, JManoeuvreId, LimitationId, MucosalJunctionDistance, WhoUpdatedId, WhenUpdated, LimitationOther)
		VALUES (@ProcedureId, NULLIF(@ExtentId,0), NULLIF(@AdditionalInfo,''), @EndoscopistId, NULLIF(@JManoeuvreId,-1), NULLIF(@LimitedById,0), NULLIF(@MucosalJunctionDistance,0), @LoggedInUserId, getdate(), NULLIF(@LimitationOther,''))
	END
	ELSE
	BEGIN

		/*Check if new values been added for limitations */
		IF ISNULL(@LimitationOther,'') <> ''
		BEGIN
			IF NOT EXISTS (SELECT 1 FROM dbo.ERS_Limitations WHERE Description = @LimitationOther)
			BEGIN
				/*get and set the new items order id so it appears 1 above 'other' we always want other to be last*/

				DECLARE @OtherListOrderBy_l int = (SELECT ListOrderBy FROM ERS_Limitations WHERE Description = 'Other')
				INSERT INTO ERS_Limitations (Description, NEDTerm, ListOrderBy) VALUES (@LimitationOther, 'Other', @OtherListOrderBy_l)
			
				UPDATE dbo.ERS_Limitations SET ListOrderBy = @OtherListOrderBy_l + 1 WHERE Description = 'Other'
		

			SELECT @LimitedById = UniqueId FROM ERS_Limitations WHERE Description = @LimitationOther
		
			DECLARE @ProcTypeId int = (SELECT ProcedureType FROM ERS_Procedures WHERE ProcedureId = @ProcedureId)
			INSERT INTO ERS_LimitationProcedureTypes (ProcedureTypeId, LimitationId) VALUES (@ProcTypeId, @LimitedById)
			END
			ELSE
				SELECT @LimitedById = UniqueId FROM ERS_Limitations WHERE Description = @LimitationOther
		END 

		UPDATE ERS_ProcedureUpperExtent
		SET 
			ExtentId = NULLIF(@ExtentId,0),
			AdditionalInfo = NULLIF(@AdditionalInfo,''),
			EndoscopistId = @EndoscopistId,
			JManoeuvreId = NULLIF(@JManoeuvreId,-1),
			LimitationId = NULLIF(@LimitedById,0),
			MucosalJunctionDistance = NULLIF(@MucosalJunctionDistance,0),
			WhoUpdatedId = @LoggedInUserId,
			WhenUpdated = getdate(),
			LimitationOther = NULLIF(@LimitationOther,'')
		WHERE 
			ProcedureId = @ProcedureId AND
			EndoscopistId = @EndoscopistId
	END

	DECLARE @SectionId int, @ProceureTypeId int, @ExtentIsSuccess bit, @ExtentDescription varchar(200), @SummaryText varchar(max) = ''
	SELECT @SectionID = UISectionId FROM UI_Sections WHERE SectionName = 'Extent'

	SELECT @ProceureTypeId = ProcedureType FROM ERS_Procedures WHERE ProcedureId = @ProcedureId
	
	/*Furthest extent*/
	SELECT TOP 1 @ExtentDescription = ee.Description, @AdditionalInfo = epue.AdditionalInfo, @ExtentIsSuccess = ee.IsSuccess
								FROM dbo.ERS_ProcedureUpperExtent epue 
									INNER JOIN dbo.ERS_Extent ee ON epue.ExtentId = ee.UniqueId
								WHERE epue.ProcedureId=@ProcedureId
								ORDER BY ee.ListOrderBy DESC
	
	/*Handle failed procedures*/
	IF @ExtentDescription IN ('intubation failed','abandoned')
	Begin
		EXEC diagnoses_set_procedure_failed @ProcedureId
		Set @bitHasProcedureFailed = 1
	END
    
	IF ISNULL(@MucosalJunctionDistance,0) > 0
	BEGIN

		SET @SummaryText = 'The apparent mucosal junction: ' + Convert(varchar(50), @MucosalJunctionDistance) + 'cm'
	END

	IF (SELECT COUNT(*) FROM ERS_ProcedureUpperExtent WHERE ProcedureId = @ProcedureId AND NULLIF(JManoeuvreId,-1) IS NOT NULL) > 0
	BEGIN
		DECLARE @JManouvreResult varchar(100)

		/*Overall JManouvre result regardless of who done it, was it done*/
		IF EXISTS (SELECT 1 FROM ERS_ProcedureUpperExtent WHERE ProcedureId = @ProcedureId AND ISNULL(JManoeuvreId,0) = 1)
			SET @JManouvreResult = 'performed. '
		ELSE
			SET @JManouvreResult = 'not carried out. '

		SET @SummaryText = @SummaryText + 'J manoeuvre ' + @JManouvreResult
	END
		
	SET @SummaryText = @SummaryText +   
						CASE LOWER(@ExtentDescription )
							WHEN 'intubation failed' THEN 'Failed intubation' + CASE WHEN ISNULL(@AdditionalInfo,'') <> '' THEN ': ' + @AdditionalInfo ELSE '' END
							WHEN 'abandoned' THEN 'Procedure failed (abandoned)' + CASE WHEN ISNULL(@AdditionalInfo,'') <> '' THEN ': ' + @AdditionalInfo ELSE '' END
							WHEN 'other' THEN  'Procedure failed' + CASE WHEN ISNULL(@AdditionalInfo,'') <> '' THEN ': ' + @AdditionalInfo ELSE '' END
							ELSE 'The procedure was completed successfully to the ' + @ExtentDescription
						END
	--limited by...?
	IF ISNULL(@LimitedById, 0) > 0
	BEGIN
		SET @SummaryText = @SummaryText + ' but limited by ' + (SELECT LOWER(Description) FROM ERS_Limitations WHERE UniqueId = @LimitedById)
	END

	IF ISNULL(@SummaryText,'') <> ''
	BEGIN
		UPDATE ERS_ProcedureUpperExtent
		SET Summary = @SummaryText
		WHERE ProcedureId = @ProcedureId

		EXEC procedure_summary_update @ProcedureId
	END
	
	DECLARE @Summary VARCHAR(max) = 'Extent:'


	--remove complete section entry incase conditions no longer apply. Will get re-evaluated after
	EXEC UI_update_procedure_summary @ProcedureId, 'Extent', @Summary, 0, @EndoscopistId

	--Check if the Extent has reached or exceeded the planned extent, if so mark as success
	IF @ExtentId > 0 
	BEGIN
		DECLARE @ExtentListOrder int = (SELECT ListOrderBy FROM ERS_Extent WHERE UniqueId = @ExtentId)
		DECLARE @PlannedExtentListOrder int = (SELECT e.ListOrderBy FROM ERS_ProcedurePlannedExtent ppe JOIN ERS_Extent e ON e.UniqueId = ppe.ExtentId WHERE ppe.ProcedureId = @ProcedureId)

		IF (@ExtentListOrder >= @PlannedExtentListOrder AND @ExtentListOrder > 0)
				SET @ExtentIsSuccess = 1
	END

	IF @ExtentId > 0 AND @ExtentIsSuccess = 1
		EXEC UI_update_procedure_summary @ProcedureId, 'Extent', 'Extent:', @ExtentId, @EndoscopistId
	ELSE IF @ExtentIsSuccess = 0 AND @LimitedById > 1
	BEGIN
		IF (SELECT LOWER(NEDTerm) FROM dbo.ERS_Limitations WHERE UniqueId = @LimitedById) = 'other'
		BEGIN
			IF ISNULL(@LimitationOther,'') <> ''
			BEGIN
				EXEC UI_update_procedure_summary @ProcedureId, 'Extent', 'Extent:' , @ExtentId, @EndoscopistId
			END
		END
		ELSE
		BEGIN
			EXEC UI_update_procedure_summary @ProcedureId, 'Extent', 'Extent:', @ExtentId, @EndoscopistId
		END
	END

	IF ISNULL(@WithdrawalMins,0) > 0
	BEGIN
		EXEC UI_update_procedure_summary @ProcedureId, 'Total withdrawal time', 'Total withdrawal time:', 1, @EndoscopistId
	END

	IF @JManoeuvreId > -1
	BEGIN
		EXEC UI_update_procedure_summary @ProcedureId, 'JManoevre', 'JManoevre:', 1, @EndoscopistId
	END
	ELSE
	BEGIN
		EXEC UI_update_procedure_summary @ProcedureId, 'JManoevre', 'JManoevre:', 0 , @EndoscopistId
	END
	
	--MH Added on 04 Jan 2023 
	Exec usp_SendIntubationExtentOrderMessageByProcedureId @ProcedureId, @bitHasProcedureFailed, @LoggedInUserId

	EXEC ogd_diagnoses_summary_update @ProcedureID

	--Handle unentered sections
	DECLARE @MatrixCode VARCHAR(100)

	--based on extent reached
	IF LOWER(@ExtentDescription)= 'oesophagus'
	BEGIN
		--if Oesophagus then Stomach and Duodenum not entered
		EXEC dbo.diagnoses_control_save @SiteID = 0,               -- int
		                                @DiagnosesMatrixCode = 'StomachNotEntered', -- varchar(50)
		                                @Value = 'true'                -- varchar(50)
		
		EXEC dbo.diagnoses_control_save @SiteID = 0,               -- int
		                                @DiagnosesMatrixCode = 'DuodenumNotEntered', -- varchar(50)
		                                @Value = 'true'                -- varchar(50)
	END
	IF LOWER(@ExtentDescription)= 'stomach'
	BEGIN
		--if stomach Duodenum not entered
		EXEC dbo.diagnoses_control_save @SiteID = 0,               -- int
		                                @DiagnosesMatrixCode = 'DuodenumNotEntered', -- varchar(50)
		                                @Value = 'true'                -- varchar(50)
		
	END
END

GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	2065 by Steve
------------------------------------------------------------------------------------------------------------------------
GO

--MH Added Indexing on ERS_Sites on 02 Feb 2024
Exec DropIfExist 'IDX_SITE_REGIONID','I'
Go

CREATE NONCLUSTERED INDEX [IDX_SITE_REGIONID] ON [dbo].[ERS_Sites]
(
       [SiteId] ASC,
       [RegionId] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO

update ERS_Indications set Suppressed = 1 where Description = 'FIT Positive'
GO
ALTER PROCEDURE [dbo].[indications_select]
(
	@ProcedureTypeId int
)
AS
BEGIN
	SELECT SectionName, i.IndicationSectionId as SectionId, i.UniqueId, Description, NEDTerm, Suppressed, SubIndicationParent, ISNULL(ParentId, 0) AS ParentId, AdditionalInfo, s.ListOrderBy, JAGAuditable
	FROM ERS_Indications i
		INNER JOIN ERS_IndicationSections s on i.IndicationSectionId = s.IndicationSectionId
		INNER JOIN ERS_IndicationsProcedureTypes ip on i.UniqueId = ip.IndicationId
	WHERE ProcedureTypeId = @ProcedureTypeId AND PlannedProcedure = 0 AND i.Suppressed = 0 --AND ISNULL(NEDTerm, '') <> ''
	ORDER BY ISNULL(s.ListOrderBy,0), ISNULL(i.ListOrderBy, 0), Description
END
GO


-- MH added below drop and create Foreign Keys on 05 Feb 2024 - wrong column was used earlier.

IF (OBJECT_ID('dbo.FK_ERS_ProcedureDamagingDrugs_ERS_Procedures', 'F') IS NOT NULL)
BEGIN
    ALTER TABLE dbo.ERS_ProcedureDamagingDrugs DROP CONSTRAINT FK_ERS_ProcedureDamagingDrugs_ERS_Procedures
END

Go
ALTER TABLE [dbo].[ERS_ProcedureDamagingDrugs]  WITH NOCHECK ADD  CONSTRAINT [FK_ERS_ProcedureDamagingDrugs_ERS_Procedures] FOREIGN KEY([ProcedureId])
REFERENCES [dbo].[ERS_Procedures] ([ProcedureId])
GO

ALTER TABLE [dbo].[ERS_ProcedureDamagingDrugs] CHECK CONSTRAINT [FK_ERS_ProcedureDamagingDrugs_ERS_Procedures]
GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Muhammad Rifat Hasan
-- TFS#	3201
-- Description of change
-- Removal of unneccessary textbox & change dropdown to multiselect for damaging drug & previous surgery.
------------------------------------------------------------------------------------------------------------------------
EXEC dbo.DropIfExist @ObjectName = 'ProcedureIndicationsSummary',      -- varchar(100)
                     @ObjectTypePrefix = 'F' -- varchar(5)
GO

CREATE FUNCTION [dbo].[ProcedureIndicationsSummary]
(
	@ProcedureId int
)
RETURNS varchar(max)
AS
BEGIN

DECLARE @IndicationsString  varchar(max), @ComorbidityString varchar(max), @DamagingDrugsString varchar(max), @PatientAllergiesString varchar(max), @PreviousSurgeryString varchar(max), 
		@PreviousDiseasesString varchar(max), @FamilyDiseaseHistoryString varchar(max), @ImagingString varchar(max), @ImagingOutcomeString varchar(max),
		@RetVal varchar(max)

SELECT @IndicationsString =
	LTRIM(STUFF((SELECT ', ' + CASE WHEN i.AdditionalInfo = 0 THEN [Description] ELSE AdditionalInformation END + CASE WHEN ISNULL(ChildIndicationId, 0) > 0 THEN '-' + (SELECT [Description] FROM ERS_Indications WHERE UniqueId = epi.ChildIndicationId) ELSE '' END AS [text()] 
	FROM ERS_ProcedureIndications epi 
	INNER JOIN ERS_Indications i on i.UniqueId = epi.IndicationId
	WHERE ProcedureId=@ProcedureId
	ORDER BY ISNULL(i.ListOrderBy, 0)
	FOR XML PATH('')),1,1,''))

--rockall and baltchford scoring
SELECT @IndicationsString	= @IndicationsString + CASE WHEN CHARINDEX('melaena', @IndicationsString) > -1 OR CHARINDEX('haematemesis', @IndicationsString) > -1 THEN ' ' + dbo.fnBlatchfordRockallScores(@ProcedureId) ELSE '' END
--SELECT @IndicationsString = dbo.fnCapitalise(dbo.fnAddFullStop(@IndicationsString)) 

IF LEN(@IndicationsString) > 0
BEGIN
	IF charindex(',', reverse(@IndicationsString)) > 0
		SELECT @RetVal = STUFF(@IndicationsString, len(@IndicationsString) - charindex(' ,', reverse(@IndicationsString)) + 1, 2, ' and ')
	ELSE
		SELECT @RetVal = @IndicationsString
END
-------------------CoMorbidity


SELECT @ComorbidityString =
	LTRIM(STUFF((SELECT ', ' + CASE WHEN AdditionalInformation = '' THEN [Description] ELSE AdditionalInformation END + CASE WHEN ISNULL(ChildComorbidityId, 0) > 0 THEN '-' + (SELECT [Description] FROM ERS_CoMorbidity WHERE UniqueId = ChildComorbidityId) ELSE '' END AS [text()] 
	FROM ERS_ProcedureComorbidity epc 
	INNER JOIN ERS_Comorbidity c on c.uniqueid = CoMorbidityId
	WHERE ProcedureId=@ProcedureId
	ORDER BY ISNULL(c.ListOrderBy, 0)
	FOR XML PATH('')),1,1,''))

--SELECT @ComorbidityString = dbo.fnCapitalise(dbo.fnAddFullStop(@ComorbidityString)) 

IF LEN(@ComorbidityString) > 0 
BEGIN
	IF charindex(',', reverse(@ComorbidityString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Co-morbidity: ' + STUFF(@ComorbidityString, len(@ComorbidityString) - charindex(' ,', reverse(@ComorbidityString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Co-morbidity: ' + @ComorbidityString
END

-------------------Damaging drugs

SELECT @DamagingDrugsString =
	LTRIM(STUFF((SELECT ', ' + [Description] AS [text()] 
	FROM ERS_ProcedureDamagingDrugs edd 
	INNER JOIN ERS_PotentialDamagingDrugs d on d.uniqueid = edd.DamagingDrugId
	WHERE edd.ProcedureId=@ProcedureId
	ORDER BY ISNULL(d.ListOrderBy, 0)
	FOR XML PATH('')),1,1,''))

--SELECT @DamagingDrugsString = dbo.fnCapitalise(dbo.fnAddFullStop(@DamagingDrugsString)) 

DECLARE @AntiCoagDrugs bit = (SELECT AntiCoagDrugs FROM ERS_Procedures WHERE ProcedureId = @ProcedureId)
IF @AntiCoagDrugs IS NOT NULL
	If @AntiCoagDrugs = 1 SET @DamagingDrugsString = @DamagingDrugsString + '<br />The patient is taking anti-coagulant or anti-platelet medication.'

IF LEN(@DamagingDrugsString) > 0
BEGIN
	IF charindex(',', reverse(@DamagingDrugsString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Potential damaging drug(s): ' + STUFF(@DamagingDrugsString, len(@DamagingDrugsString) - charindex(' ,', reverse(@DamagingDrugsString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Potential damaging drug(s): ' + @DamagingDrugsString
END
-------------------Allergies

SELECT @PatientAllergiesString =
	CASE AllergyResult 
		WHEN -1 THEN 'unknown'
		WHEN 0 THEN 'none'
		WHEN 1 THEN a.AllergyDescription 
	END
	FROM ERS_PatientAllergies a
		INNER JOIN ERS_Procedures p ON p.PatientId = a.PatientId
	WHERE p.ProcedureId = @ProcedureId

--SELECT @PatientAllergiesString = dbo.fnCapitalise(dbo.fnAddFullStop(@PatientAllergiesString)) 

IF LEN(@PatientAllergiesString) > 0
BEGIN
	IF charindex(',', reverse(@PatientAllergiesString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Allergies: ' + STUFF(@PatientAllergiesString, len(@PatientAllergiesString) - charindex(' ,', reverse(@PatientAllergiesString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Allergies: ' + @PatientAllergiesString
END
-------------------Previous surgery

SELECT @PreviousSurgeryString =
	LTRIM(STUFF((SELECT DISTINCT ', ' + [Description] 
	--+ CASE WHEN ListItemText = 'Unknown' THEN '' ELSE ' ' + ListItemText END 
	as [text()] 
	FROM ERS_PatientPreviousSurgery h
	INNER JOIN ERS_PreviousSurgery r on r.UniqueID = h.PreviousSurgeryID
	--INNER JOIN ERS_Lists l on l.ListItemNo = h.PreviousSurgeryPeriod and ListDescription = 'Follow up disease Period'
	INNER JOIN ERS_Procedures p on p.patientId = h.patientId 
	WHERE p.ProcedureId = @ProcedureId
	--ORDER BY ISNULL(r.ListOrderBy, 0)
	FOR XML PATH('')),1,1,''))

--SELECT @PreviousSurgeryString = dbo.fnCapitalise(dbo.fnAddFullStop(@PreviousSurgeryString)) 

IF LEN(@PreviousSurgeryString) > 0
BEGIN
	IF charindex(',', reverse(@PreviousSurgeryString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Previous surgery: ' + STUFF(@PreviousSurgeryString, len(@PreviousSurgeryString) - charindex(' ,', reverse(@PreviousSurgeryString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Previous surgery: ' + @PreviousSurgeryString
END

-------------------ASA Status
DECLARE @ASAStatusString varchar(max) = 
	(SELECT TOP 1 [description]
	FROM ERS_PatientASAStatus pa 
		INNER JOIN ERS_ASAStatus a on a.uniqueid = pa.asastatusid
		INNER JOIN ERS_Procedures p ON p.PatientId = pa.PatientId
	WHERE ProcedureId = @ProcedureId
	order by isnull(pa.WhenUpdated, pa.WhenCreated))

IF LEN(@ASAStatusString) > 0 
BEGIN
	SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'ASA Status: ' + @ASAStatusString
END
-------------------Previous diseases

SELECT @PreviousDiseasesString =
	LTRIM(STUFF((SELECT DISTINCT ', ' + [Description] as [text()] 
	FROM ERS_PatientPreviousDiseases pd
	INNER JOIN ERS_PreviousDiseases d on d.UniqueID = pd.PreviousDiseaseID
	INNER JOIN ERS_Procedures p on p.patientId = pd.patientId 
	WHERE p.ProcedureId = @ProcedureId
	--ORDER BY ISNULL(r.ListOrderBy, 0)
	FOR XML PATH('')),1,1,''))

--SELECT @PreviousDiseasesString = dbo.fnCapitalise(dbo.fnAddFullStop(@PreviousDiseasesString)) 

IF LEN(@PreviousDiseasesString) > 0
BEGIN
	IF charindex(',', reverse(@PreviousDiseasesString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Previous diseases: ' + STUFF(@PreviousDiseasesString, len(@PreviousDiseasesString) - charindex(' ,', reverse(@PreviousDiseasesString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Previous diseases: ' + @PreviousDiseasesString
END

-------------------Family disease history

SELECT @FamilyDiseaseHistoryString =
	LTRIM(STUFF((SELECT ', ' + CASE WHEN AdditionalInformation = '' THEN [Description] ELSE AdditionalInformation END AS [text()] 
	FROM ERS_PatientFamilyDiseaseHistory epi 
	INNER JOIN ERS_FamilyDiseaseHistory i on i.UniqueId = epi.FamilyDiseaseHistoryId
	INNER JOIN ERS_Procedures p on p.patientId = epi.patientId 
	WHERE ProcedureId=@ProcedureId
	ORDER BY ISNULL(i.ListOrderBy, 999)
	FOR XML PATH('')),1,1,''))

--SELECT @FamilyDiseaseHistoryString = dbo.fnCapitalise(dbo.fnAddFullStop(@FamilyDiseaseHistoryString)) 

IF LEN(@FamilyDiseaseHistoryString) > 0
BEGIN
	IF charindex(',', reverse(@FamilyDiseaseHistoryString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Family history: ' + STUFF(@FamilyDiseaseHistoryString, len(@FamilyDiseaseHistoryString) - charindex(' ,', reverse(@FamilyDiseaseHistoryString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Family history: ' + @FamilyDiseaseHistoryString
END


-------------------Imaging

SELECT @ImagingString =
	LTRIM(STUFF((SELECT ', ' + [Description] AS [text()] 
	FROM ERS_ImagingMethods im 
	INNER JOIN ERS_ProcedureImagingMethod pim on im.uniqueid = pim.ImagingMethodId
	WHERE pim.ProcedureId=@ProcedureId
	FOR XML PATH('')),1,1,''))


IF LEN(@ImagingString) > 0
BEGIN
	IF charindex(',', reverse(@ImagingString)) > 0
		SELECT @ImagingString = STUFF(@ImagingString, len(@ImagingString) - charindex(' ,', reverse(@ImagingString)), 2, ' and ')
END


SELECT @ImagingOutcomeString =
	LTRIM(STUFF((SELECT ', ' + [Description] AS [text()] 
	FROM ERS_ImagingOutcomes imo 
	INNER JOIN ERS_ProcedureImagingOutcome pio on imo.uniqueid = pio.ImagingOutcomeId
	WHERE pio.ProcedureId=@ProcedureId
	FOR XML PATH('')),1,1,''))

IF ISNULL(@ImagingOutcomeString,'') <> ''
BEGIN
	SELECT @ImagingString = CASE WHEN ISNULL(@ImagingString, '') <> '' THEN @ImagingString + ' revealed ' ELSE '' END  + @ImagingOutcomeString
END


--SELECT @ImagingString = dbo.fnCapitalise(dbo.fnAddFullStop(@ImagingString)) 

IF LEN(@ImagingString) > 0
BEGIN
	IF charindex(',', reverse(@ImagingString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Imaging: ' + STUFF(@ImagingString, len(@ImagingString) - charindex(' ,', reverse(@ImagingString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Imaging: ' + @ImagingString
END


DECLARE @SmokingString varchar(max)


SELECT @SmokingString=
	LTRIM(STUFF((SELECT '  ' +SmokingDescription   AS [text()] 
	FROM ERS_ProcedureSmoking epi 
	WHERE ProcedureId=@ProcedureId
	FOR XML PATH('')),1,1,''))

--SELECT @SmokingString = dbo.fnCapitalise(dbo.fnAddFullStop(@SmokingString)) 

IF LEN(@SmokingString) > 0
BEGIN
	IF charindex(',', reverse(@SmokingString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>Smoking:</b> ' + @SmokingString
		--SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>Smoking:</b> ' + STUFF(@SmokingString, len(@SmokingString) - charindex(' ,', reverse(@SmokingString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>Smoking:</b> ' + @SmokingString
END

DECLARE @LUTSIPSSString varchar(max)
DECLARE @LUTSIPSSTotalScoreString varchar(max)

SELECT @LUTSIPSSString=
	LTRIM(STUFF((SELECT ', ' + SectionName+'(Score:'+cast(ls.ScoreValue as varchar(10)) +')'   AS [text()] 
	from  ERS_ProcedureLUTSIPSSSymptoms a ,ERS_LUTSIPSSSymptoms b,ERS_LUTSIPSSSymptomSections s,ERS_IPSSScore ls
	where ProcedureId=@ProcedureId and a.LUTSIPSSSymptomId=b.UniqueId and b.LUTSIPSSSymptomSectionId=s.LUTSIPSSSymptomSectionId and SelectedScoreId>1 and a.SelectedScoreId=ls.ScoreId
	FOR XML PATH('')),1,1,''))

--SELECT @LUTSIPSSString = dbo.fnCapitalise(dbo.fnAddFullStop(@LUTSIPSSString)) 

select top 1  @LUTSIPSSTotalScoreString =  'Total Score :' + cast(TotalScoreValue as varchar(10)) 
from  ERS_ProcedureLUTSIPSSSymptoms where ProcedureId=@ProcedureId
IF LEN(@LUTSIPSSString) > 0
BEGIN
	IF charindex(',', reverse(@LUTSIPSSString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>LUTS\IPSS symptom score:</b>' + STUFF(@LUTSIPSSString, len(@LUTSIPSSString) - charindex(' ,', reverse(@LUTSIPSSString)), 2,  ' ' + @LUTSIPSSTotalScoreString + ' '+'<br />')
	     
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>LUTS\IPSS symptom score:</b> ' + @LUTSIPSSString

	--SELECT @RetVal = ISNULL(@RetVal + '<br />', '') +  @LUTSIPSSTotalScoreString
END

DECLARE @PreviousDiseaseUrologyString varchar(max)

SELECT @PreviousDiseaseUrologyString=
	LTRIM(STUFF((SELECT ', ' +case 
       when a.Description='Other' then b.AdditionalInformation
	   else a.Description
	  end
   AS [text()] 
	from ERS_PreviousDiseasesUrology a, ERS_ProcedurePreviousDiseasesUrology b 
	where a.UniqueId=b.PreviousDiseaseId
	and b.ProcedureId=@ProcedureId
	order by PreviousDiseaseSectionId
	FOR XML PATH('')),1,1,''))

--SELECT @PreviousDiseaseUrologyString = dbo.fnCapitalise(dbo.fnAddFullStop(@PreviousDiseaseUrologyString)) 


IF LEN(@PreviousDiseaseUrologyString) > 0
BEGIN
	IF charindex(',', reverse(@PreviousDiseaseUrologyString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>Past Urological Histrory:</b>' + STUFF(@PreviousDiseaseUrologyString, len(@PreviousDiseaseUrologyString) - charindex(' ,', reverse(@PreviousDiseaseUrologyString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>Past Urological Histrory:</b> ' + @PreviousDiseaseUrologyString

	
END

DECLARE @UrineDipstickCytologyString varchar(max)

SELECT @UrineDipstickCytologyString=
	LTRIM(STUFF((SELECT ', ' + b.Description + ' '+c.Description 
   AS [text()] 
	from ERS_ProcedureUrineDipstickCytology a,ERS_UrineDipstickCytology b,ERS_UrineDipstickCytology c
	where a.ProcedureId=@ProcedureId
	and a.UrineDipstickCytologyId=b.UniqueId
	and a.ChildUrineDipstickCytologyId=c.UniqueId
	order by b.UrineDipstickCytologySectionId,b.ListOrderBy
	FOR XML PATH('')),1,1,''))

--SELECT @UrineDipstickCytologyString = dbo.fnCapitalise(dbo.fnAddFullStop(@UrineDipstickCytologyString)) 


IF LEN(@UrineDipstickCytologyString) > 0
BEGIN
	IF charindex(',', reverse(@UrineDipstickCytologyString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>Urine Dipstick And Cytology:</b>' + STUFF(@UrineDipstickCytologyString, len(@UrineDipstickCytologyString) - charindex(' ,', reverse(@UrineDipstickCytologyString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>Urine Dipstick And Cytology:<b>' + @UrineDipstickCytologyString

	
END


--------------Broncs referral data
DECLARE @BroncoReferralDataString varchar(max), @DateBronchRequested DATETIME,
		@DateOfReferral DATETIME,
		@LCaSuspectedBySpecialist BIT,
		@CTScanAvailable BIT,
		@DateOfScan DATETIME

	SELECT @DateBronchRequested=DateBronchRequested,
		   @DateOfReferral=DateOfReferral,
		   @LCaSuspectedBySpecialist=LCaSuspectedBySpecialist,
		   @CTScanAvailable=CTScanAvailable
	FROM ERS_ProcedureBronchoReferralData
	WHERE ProcedureId = @ProcedureId

	IF @DateBronchRequested IS NOT NULL SET @BroncoReferralDataString  = ISNULL(@BroncoReferralDataString,'') + 'Date bronchoscopy requested ' + CONVERT(VARCHAR, @DateBronchRequested, 105) + '. '
	IF @DateOfReferral IS NOT NULL SET @BroncoReferralDataString  = ISNULL(@BroncoReferralDataString,'') + 'Date of referral ' + CONVERT(VARCHAR, @DateOfReferral, 105) + '. '
	IF @LCaSuspectedBySpecialist = 1 SET @BroncoReferralDataString  = ISNULL(@BroncoReferralDataString,'') + 'Lung Ca suspected by lung Ca specialist' + '. '
	IF @CTScanAvailable = 1 SET @BroncoReferralDataString  = ISNULL(@BroncoReferralDataString,'') + 'CT scan available prior to bronchoscopy' + '. '
	IF @DateOfScan IS NOT NULL SET @BroncoReferralDataString  = ISNULL(@BroncoReferralDataString,'') + 'Date of scan ' + CONVERT(VARCHAR, @DateOfScan, 105) + '. '
	

	IF @BroncoReferralDataString IS NOT NULL SET @BroncoReferralDataString = 'Referal Data (' + RTRIM(@BroncoReferralDataString )+ ')'
	ELSE SET @BroncoReferralDataString = ''
	
	IF LEN(@BroncoReferralDataString) > 0
	BEGIN
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + @BroncoReferralDataString
	END


RETURN @RetVal
END

GO

EXEC dbo.DropIfExist @ObjectName = 'procedure_damaging_drugs_delete',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

EXEC dbo.DropIfExist @ObjectName = 'procedure_damaging_drugs_save',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[procedure_damaging_drugs_save]
(
	@ProcedureId int, 
	@DrugId varchar(255), 
	@LoggedInUserId int
)
AS
BEGIN
	DELETE FROM ERS_ProcedureDamagingDrugs WHERE ProcedureId = @ProcedureId AND DamagingDrugId IN (SELECT UniqueId FROM ERS_PotentialDamagingDrugs WHERE AntiCoag = 0)
	
	DECLARE @SelectedID int;
	DECLARE db_cursor CURSOR FOR  
	SELECT item  FROM fnSplitString( @DrugId, ',')

	OPEN db_cursor   
	FETCH NEXT FROM db_cursor INTO @SelectedID 
	WHILE @@FETCH_STATUS = 0   
	BEGIN

		INSERT INTO [dbo].[ERS_ProcedureDamagingDrugs] (ProcedureId, DamagingDrugId, WhoCreatedId, WhenCreated)
		VALUES (@ProcedureId, @SelectedID, @LoggedInUserId, getdate())
	
		DECLARE @Summary VARCHAR(max) = 'Significant drugs',
				@DamagingDrugsCount int = (SELECT count(*) FROM ERS_ProcedureDamagingDrugs WHERE ProcedureId = @ProcedureId)

		EXEC UI_update_procedure_summary @ProcedureId, 'Significant drugs', @Summary, @DamagingDrugsCount

		--check if is an anticoag drug
		DECLARE @AntiCoagDrugs bit = (SELECT AntiCoagDrugs FROM ERS_Procedures WHERE ProcedureId = @ProcedureId),
				@SectionId int = (SELECT UISectionId FROM UI_Sections WHERE SectionName = 'Anti-coag drugs')

		IF @AntiCoagDrugs IS NOT NULL
		BEGIN
			DELETE FROM ERS_ProcedureSummary WHERE ProcedureId = @ProcedureId AND SectionId = @SectionId

			IF (SELECT count(*) FROM ERS_ProcedureDamagingDrugs WHERE ProcedureId = @ProcedureId AND DamagingDrugId IN (SELECT UniqueId FROM ERS_PotentialDamagingDrugs WHERE AntiCoag = 1)) > 0 
			BEGIN
				INSERT INTO ERS_ProcedureSummary (SectionId, ProcedureId, Summary)
				VALUES (@SectionId, @ProcedureId, 'Anti-Coag drugs')
			END
			ELSE IF @AntiCoagDrugs = 0
			BEGIN
				INSERT INTO ERS_ProcedureSummary (SectionId, ProcedureId, Summary)
				VALUES (@SectionId, @ProcedureId, 'Anti-Coag drugs')
			END
		END

	FETCH NEXT FROM db_cursor INTO @SelectedID   
	END   

	CLOSE db_cursor   
	DEALLOCATE db_cursor

	UPDATE ERS_ProceduresReporting
	SET PP_Indic = dbo.ProcedureIndicationsSummary(@ProcedureId)
	WHERE ProcedureId = @ProcedureId
END
GO

EXEC dbo.DropIfExist @ObjectName = 'patient_previous_surgery_delete',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

EXEC dbo.DropIfExist @ObjectName = 'patient_previous_surgery_save',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[patient_previous_surgery_save]
(
	@PreviousSurgeryId varchar(255),	
	@PreviousSurgeryPeriod int,
	@ProcedureId int,
	@PatientId int,
	@LoggedInUserId int
)
AS
BEGIN
	DELETE FROM ERS_PatientPreviousSurgery WHERE PatientId = @PatientId

	DECLARE @SelectedID int;
	DECLARE db_cursor CURSOR FOR  
	SELECT item  FROM fnSplitString( @PreviousSurgeryId, ',')

	OPEN db_cursor   
	FETCH NEXT FROM db_cursor INTO @SelectedID 
	WHILE @@FETCH_STATUS = 0   
	BEGIN
		INSERT INTO ERS_PatientPreviousSurgery (PatientId, PreviousSurgeryId, PreviousSurgeryPeriod, ProcedureCreatedId, WhoCreatedId, WhenCreated)
		VALUES (@PatientId, @SelectedID, @PreviousSurgeryPeriod, @ProcedureId, @LoggedInUserId, getdate())

		DECLARE @ProcedureTypeId INT
		SELECT @ProcedureTypeId = ProcedureType FROM ERS_Procedures WHERE ProcedureId = @ProcedureId

		--check if previous surgery id exists in the procedure types link table, if not, add for this procedure type
		IF NOT EXISTS (SELECT 1 FROM ERS_PreviousSurgeryProcedureTypes WHERE PreviousSurgeryId = @SelectedID AND ProcedureTypeId = @ProcedureTypeId)
		BEGIN
			INSERT INTO ERS_PreviousSurgeryProcedureTypes (PreviousSurgeryId, ProcedureTypeId) VALUES (@SelectedID, @ProcedureTypeId)
		END

		--DECLARE @ResectionId INT
		--SELECT @ResectionId = ResectionId FROM ERS_PreviousSurgery WHERE UniqueId = @PreviousSurgeryId
		--IF @ResectionId IS NOT NULL
		--BEGIN
		--	UPDATE ERS_Procedures
		--	SET ResectedColonNo = @ResectionId
		--	WHERE ProcedureId = @ProcedureId
		--END

		FETCH NEXT FROM db_cursor INTO @SelectedID   
	END   

	CLOSE db_cursor   
	DEALLOCATE db_cursor

	UPDATE ERS_ProceduresReporting
	SET PP_Indic = dbo.ProcedureIndicationsSummary(@ProcedureId)
	WHERE ProcedureId = @ProcedureId

	DECLARE @Summary VARCHAR(max) = 'Previous surgery',
			@SurgeryCount int = (SELECT count(*) FROM ERS_PatientPreviousSurgery WHERE (ProcedureCreatedId = @ProcedureId or ProcedureUpdatedId = @ProcedureId))

	EXEC UI_update_procedure_summary @ProcedureId, 'Previous surgery', @Summary, @SurgeryCount

END
GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	3201 Ended
------------------------------------------------------------------------------------------------------------------------


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Muhammad Rifat Hasan
-- TFS#	3687
-- Description of change
-- Procedure not carried comment character extended
------------------------------------------------------------------------------------------------------------------------

IF  (EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = 'dbo' AND TABLE_NAME = 'ERS_ProceduresReporting'))
BEGIN
	ALTER TABLE ERS_ProceduresReporting
	ALTER COLUMN PP_DNA nvarchar(max);
END

GO
EXEC dbo.DropIfExist @ObjectName = 'usp_ProcedureNotCarriedOut_UpdateReason',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO
CREATE PROCEDURE [dbo].[usp_ProcedureNotCarriedOut_UpdateReason]
(
	  @ProcedureId	AS INT
	, @DNA_ReasonId	AS TINYINT
	, @PP_DNA		AS NVARCHAR(MAX)=''
)
AS
BEGIN
	SET NOCOUNT ON;
	
	BEGIN -- UPDATE RECORDS IN TWO TABLE-> ERS_Procedures, and ERS_ProceduresReporting
		UPDATE dbo.ERS_Procedures
		   SET 
			   DNA = @DNA_ReasonId,
			   NEDEnabled = 0
		 WHERE ProcedureId = @ProcedureId;

		--## Now the ERS_ProceduresReporting Table- For the PP fields!
		BEGIN		
			UPDATE dbo.ERS_ProceduresReporting
			   SET 
				   PP_DNA = @PP_DNA,
				   PP_DNADate = GETDATE()
			 WHERE ProcedureId = @ProcedureId;

			IF @@ROWCOUNT=0 
				BEGIN
				-- Means No Records found in the dbo.ERS_ProceduresReporting table. So- Insert/Create the record.
					INSERT INTO dbo.ERS_ProceduresReporting (ProcedureId, PP_DNA, PP_DNADate) VALUES (@ProcedureId, @PP_DNA, GETDATE());
				END
		END
		
		EXEC diagnoses_set_procedure_failed @ProcedureId
		EXEC procedure_summary_update @ProcedureId
		SELECT '1' Success; --## Just for the EntityFrame work StoredProc usage! They need this Lollypop!
	END 

END
GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	3687 Ended
------------------------------------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	MOSTAFIZUR RAHMAN
-- TFS#	2961
-- Description of change
-- Added region description as label in media
------------------------------------------------------------------------------------------------------------------------

EXEC dbo.DropIfExist 
    @ObjectName = 'printreport_photos_select', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[printreport_photos_select]
(
	@OperatingHospitalID SMALLINT,
	@ProcedureId INT,
	@EpisodeNo INT = 0,
	@PatientComboId VARCHAR(30) = NULL,
    @ProcedureType TINYINT,
    @ColonType INT = -1
)
AS

SET NOCOUNT ON
--Dependency : sites_select

create table #Photos (RowId INT, PhotoUrl VARCHAR(max), PhotoTitle VARCHAR(MAX), SortedSiteNo INT, Region VARCHAR(max))


	INSERT INTO #Photos
	SELECT 
		ROW_NUMBER() OVER (ORDER BY a.PhotoId) AS RowId,
		convert(varchar(max), REPLACE(PhotoName, '.mp4', '.bmp')) AS PhotoUrl, 
		ISNULL(b.SiteDescription, 'No site associated (Attached to the report)') + 
		CASE 
		WHEN a.PhotoName LIKE '%.mp4' 
		THEN '  (Video)' 
		ELSE '' 
		END AS PhotoTitle ,
		0 AS SortedSiteNo,
		b.Region As Region  --ADDING REGION HERE FOR MEDIA 
		
		
		

	FROM [ERS_Photos] a 
	LEFT JOIN 
		(SELECT SiteId, 
			'Site ' + CONVERT(VARCHAR(200), dbo.fnGetSiteTitle(SiteNo, @OperatingHospitalID	)) + 
			' (' + 
			CASE AntPos WHEN 1 THEN 'Anterior' WHEN 2 THEN 'Posterior' WHEN 3 THEN '' END + 
			' ' + r.Region + 
			')' AS SiteDescription ,
			r.Region --ADDING REGION HERE FOR MEDIA 
		FROM ERS_Sites s 
		JOIN ERS_Regions r ON s.RegionId = r.RegionId 
		WHERE ProcedureId = @ProcedureId) b ON a.SiteId=b.SiteId 
	WHERE ProcedureId = @ProcedureId

	if @ProcedureId >= 6000000
	begin
		INSERT INTO #Photos
		Select ROW_NUMBER() OVER (ORDER BY previmg.ImageId) as RowId,
				'data:image/jpeg;base64,' + PhotoUrl,
				ImageName,
				0 ass
		FROM ERS_PreviousImages previmg
		cross apply (select ImageBinary as '*' for xml path('')) T (PhotoUrl)
		WHERE PreviousProcedureID =  @ProcedureId
	end

SELECT *
FROM #Photos
WHERE RowID >= CASE 
		WHEN @EpisodeNo > 0	-- UGI
			THEN 1  
		ELSE 0				-- ERS
		END
GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	2961 Ended
------------------------------------------------------------------------------------------------------------------------


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	MOSTAFIZUR RAHMAN
-- TFS#	3477
-- Description of change
-- Bronch/EBUS Access Via drop down, showing on report
------------------------------------------------------------------------------------------------------------------------

EXEC dbo.DropIfExist 
    @ObjectName = 'procedure_instruments_save', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[procedure_instruments_save]
(
	@ProcedureId int,
	@Instrument1Id int,
	@Instrument2Id int,
	@ScopeGuideUsed bit
)
AS
BEGIN
	UPDATE ERS_Procedures 
	SET 
		Instrument1 = NULLIF(@Instrument1Id,0), 
		Instrument2 = NULLIF(@Instrument2Id, 0), 
		ScopeGuide = @ScopeGuideUsed
	WHERE ProcedureId = @ProcedureId

	DECLARE @SectionId int, @Summary varchar(max)

	
	/*Scope*/
	SET @Summary = 'Scopes:'
	IF @Instrument1Id > 0 
	BEGIN
		EXEC UI_update_procedure_summary @ProcedureId, 'Scopes', @Summary, @Instrument1Id
	END
	ELSE IF @Instrument2Id > 0 
		EXEC UI_update_procedure_summary @ProcedureId, 'Scopes', @Summary, @Instrument2Id
	ELSE
		EXEC UI_update_procedure_summary @ProcedureId, 'Scopes', @Summary, 0

	--update reporting field for summary report
	DECLARE @InstrumentTxt varchar(200) = '', @Instru1Text varchar(200) = '', @Instru2Text varchar(200) = ''

	IF ISNULL(@Instrument1Id,0) > 0
		SELECT @Instru1Text = ScopeName FROM ERS_Scopes WHERE ScopeId = @Instrument1Id
	
	IF ISNULL(@Instrument2Id,0) > 0
		SELECT @Instru2Text = ScopeName FROM ERS_Scopes WHERE ScopeId = @Instrument2Id 
			
	--accessVia Part

	IF @ProcedureId IN (SELECT @ProcedureId  FROM ERS_Procedures WHERE ProcedureType IN (10, 11))
	BEGIN
		Select @Instru2Text = 'Access Via : ' + ListItemText
	FROM ers_lists WHERE ListItemNo=@Instrument2Id And ListDescription='AccessMethod Thoracic'
	END

	--accessVia Part
	
	If @Instru1Text <> '' 
		SET @InstrumentTxt = @Instru1Text

	
	If @Instru2Text <> '' 
		SET @InstrumentTxt = @InstrumentTxt + '<br /> ' + @Instru2Text

	IF @Instru1Text <> '' OR @Instru2Text <> ''
	BEGIN
		--transnasal check
		IF EXISTS (SELECT 1 FROM dbo.ERS_Procedures WHERE ProcedureId = @ProcedureId AND Transnasal = 1)
		BEGIN	
			SET @InstrumentTxt = @InstrumentTxt + ' (transnasal) '
		END

		UPDATE ERS_ProceduresReporting SET PP_Instrument = @InstrumentTxt WHERE ProcedureId = @ProcedureId
	END
END
GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	3477 Ended
------------------------------------------------------------------------------------------------------------------------
go
ALTER FUNCTION [dbo].[tvfNED_ProcedureIndication]
(
	@ProcedureId AS INT
)
-- =============================================
-- Description:	This will return the list of 'Indication' for each Procedure- required for NED Export!
-- =============================================
RETURNS TABLE 
AS
RETURN 
(
  Select procedureindicationid,ISNULL(NULLIF(dbo.HTMLDecode(EI.NEDTerm),''), 'Other') NEDTerm --any entry that does not have a NED term in the lookup table is to be treated as other
		, CASE WHEN EI.NEDTerm = 'Other' then EI.[Description] ELSE NULL END AS Comment --where the NED term is blank, the description should be included in the other field
		, CASE WHEN EI.NEDTerm = 'Elevated calprotectin' then EPI.AdditionalInformation ELSE NULL END AS elevatedCalprotectinValue
  from ERS_ProcedureIndications EPI
  join ERS_Indications EI on ISNULL(NULLIF(EPI.ChildIndicationId,0), EPI.IndicationId) = EI.UniqueId
  WHERE EPI.ProcedureId = @ProcedureId
);

GO
------------------------------------------------------------------------------------------------------------------------
-- Removing duplicate comorbidities
------------------------------------------------------------------------------------------------------------------------
Print 'Removing duplicate comorbidities'
Declare @OldComorbidity int, @NewComorbidity int
If (Select count(1) from ERS_Comorbidity where Description in ('AF', 'Atrial Fibrillation')) = 2
BEGIN
	Print '    Removing AF, replacing with Atrial Fibrillation'
	Select @OldComorbidity = UniqueId from ERS_Comorbidity where Description = 'AF'
	Select @NewComorbidity = UniqueId from ERS_Comorbidity where Description = 'Atrial Fibrillation'

	Update ERS_ProcedureComorbidity set ComorbidityId = @NewComorbidity where ComorbidityId = @OldComorbidity 
	Delete from ERS_ComorbidityProcedureTypes where ComorbidityId = @OldComorbidity
	Delete from ERS_Comorbidity where UniqueId = @OldComorbidity
END

If (Select count(1) from ERS_Comorbidity where Description = 'TIA/Stroke') > 1
BEGIN
	--Only want one of these, remove the duplicates
	Print '    Removing Duplicates of TIA/Stroke'
	SELECT TOP 1 @NewComorbidity = UniqueId from ERS_Comorbidity where Description = 'TIA/Stroke' ORDER BY UniqueId 
	
	WHILE (Select Count(1) from ERS_Comorbidity where Description = 'TIA/Stroke' and UniqueId != @NewComorbidity) > 0
	BEGIN
		SELECT TOP 1 @OldComorbidity = UniqueId from ERS_Comorbidity where Description = 'TIA/Stroke' and UniqueId != @NewComorbidity
		Update ERS_ProcedureComorbidity set ComorbidityId = @NewComorbidity where ComorbidityId = @OldComorbidity 
		Delete from ERS_ComorbidityProcedureTypes where ComorbidityId = @OldComorbidity
		Delete from ERS_Comorbidity where UniqueId = @OldComorbidity
	END
END

If (Select count(1) from ERS_Comorbidity where Description in ('CVA', 'TIA/Stroke')) = 2
BEGIN
	Print '    Removing CVA, replacing with TIA/Stroke'
	Select @OldComorbidity = UniqueId from ERS_Comorbidity where Description = 'CVA'
	Select @NewComorbidity = UniqueId from ERS_Comorbidity where Description = 'TIA/Stroke'

	Update ERS_ProcedureComorbidity set ComorbidityId = @NewComorbidity where ComorbidityId = @OldComorbidity 
	Delete from ERS_ComorbidityProcedureTypes where ComorbidityId = @OldComorbidity
	Delete from ERS_Comorbidity where UniqueId = @OldComorbidity
END

If (Select count(1) from ERS_Comorbidity where Description in ('Essential HyperTension', 'Hypertension')) = 2
BEGIN
	Print '    Removing Essential HyperTension, replacing with Hypertension'
	Select @OldComorbidity = UniqueId from ERS_Comorbidity where Description = 'Essential HyperTension'
	Select @NewComorbidity = UniqueId from ERS_Comorbidity where Description = 'Hypertension'

	Update ERS_ProcedureComorbidity set ComorbidityId = @NewComorbidity where ComorbidityId = @OldComorbidity 
	Delete from ERS_ComorbidityProcedureTypes where ComorbidityId = @OldComorbidity
	Delete from ERS_Comorbidity where UniqueId = @OldComorbidity
END
Print 'Done Removing duplicate comorbidities'
------------------------------------------------------------------------------------------------------------------------
-- Removing duplicate comorbidities End
------------------------------------------------------------------------------------------------------------------------

GO
------------------------------------------------------------------------------------------------------------------------
-- Removing duplicate Damaging Drugs
------------------------------------------------------------------------------------------------------------------------
IF (SELECT COUNT(1) from ERS_PotentialDamagingDrugs WHERE Description in ('Warfarin and Aspirin', 'Warfarin', 'Aspirin')) = 3
BEGIN
	DECLARE @WandA int, @Warf int, @Asp int
	SELECT @WandA = UniqueId from ERS_PotentialDamagingDrugs WHERE Description = 'Warfarin and Aspirin'
	SELECT @Warf = UniqueId from ERS_PotentialDamagingDrugs WHERE Description = 'Warfarin'
	SELECT @Asp = UniqueId from ERS_PotentialDamagingDrugs WHERE Description = 'Aspirin'

	--Update ERS_ProcedureDamagingDrugs where it has Warfarin and Asprin, replace with the 2 seperatly
	Insert into ERS_ProcedureDamagingDrugs (DamagingDrugId, ProcedureId)
	Select @Warf, ProcedureId from ERS_ProcedureDamagingDrugs where ProcedureDamagingDrugsId = @WandA

	update ERS_ProcedureDamagingDrugs set DamagingDrugId = @Asp where DamagingDrugId = @WandA
END
	-- now delete Warfarin and Aspirin
	Delete from ERS_PotentialDamagingDrugs where UniqueId = @WandA
------------------------------------------------------------------------------------------------------------------------
-- Removing duplicate Damaging Drugs
------------------------------------------------------------------------------------------------------------------------
GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 07.02.24
-- TFS#	
-- Description of change
-- Inline SQL to Stored Proc
------------------------------------------------------------------------------------------------------------------------
GO
EXEC dbo.DropIfExist @ObjectName = 'sch_get_list_diary_details',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE dbo.sch_get_list_diary_details
(
	@DiaryId int
)
AS
BEGIN
	SELECT DISTINCT g.Title AS ListGender, eslr.ListRulesId, eslr.GIProcedure, esdp.OperatingHospitalId, esdp.ListConsultantId, esls.ProcedureTypeId, esls.SlotId AS SlotStatus, r.RoomName, r.RoomId, LTRIM(RTRIM(ISNULL(eu.Title,'') + ' ' + ISNULL(eu.Forename,'') + ' ' + ISNULL(eu.Surname,''))) AS EndoscopistName, LTRIM(RTRIM(ISNULL(lc.Title,'') + ' ' + ISNULL(lc.Forename,'') + ' ' + ISNULL(lc.Surname,''))) AS ListConsultantName, ISNULL(esdp.UserId,0) as EndoscopistId, ISNULL(espm.Minutes,15) AS SlotLength, esdp.DiaryStart, esdp.Training
	FROM dbo.ERS_SCH_DiaryPages esdp 
		INNER JOIN dbo.ERS_SCH_ListRules eslr ON esdp.ListRulesId = eslr.ListRulesId
		INNER JOIN dbo.ERS_SCH_ListSlots esls ON esdp.ListRulesId = esls.ListRulesId
		INNER JOIN ERS_SCH_Rooms r ON r.RoomID = esdp.RoomId
		LEFT JOIN dbo.ERS_Users eu ON eu.UserID = esdp.UserId
		LEFT JOIN dbo.ERS_Users lc ON lc.UserID = esdp.ListConsultantId
		LEFT JOIN dbo.ERS_SCH_PointMappings espm ON esls.ProcedureTypeId = espm.ProceduretypeId AND espm.OperatingHospitalId = esdp.OperatingHospitalId
			AND ESPM.Training = eslr.Training               
			AND espm.NonGI = CASE WHEN GIProcedure = 1 THEN 0 ELSE 1 END
		LEFT JOIN dbo.ERS_GenderTypes g ON g.GenderId = esdp.ListGenderId
	WHERE DiaryId = @DiaryId
END
GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 07.02.24
-- TFS#	
-- Description of change
-- Blocked slot points added to select statement
------------------------------------------------------------------------------------------------------------------------
GO

SET QUOTED_IDENTIFIER ON
SET ANSI_NULLS ON
GO

ALTER PROCEDURE [dbo].[sch_get_diary_details]
(
	@DiaryId INT
)
AS

	SELECT DISTINCT
		d.DiaryId,
		d.DiaryStart, 
		d.[DiaryEnd],
		d.[UserID], 
		d.ListConsultantId,
		d.[RoomID], 
		d.ListRulesId, 
		d.Training,
		d.Subject,
		d.UserId EndoscopistId,
		d.ListConsultantId,
		(CASE WHEN  ISNULL(u.Title,'') <> '' THEN u.Title + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(u.Forename,'') <> '' THEN u.Forename + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(u.Surname,'') <> '' THEN u.Surname + ' ' ELSE '' END) as EndoscopistName,
	  (CASE WHEN  ISNULL(c.Title,'') <> '' THEN c.Title + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(c.Forename,'') <> '' THEN c.Forename + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(c.Surname,'') <> '' THEN c.Surname + ' ' ELSE '' END) as ListConsultant,
	  ls.TotalMinutes,
	  ls.TotalPoints,
	  ls.OverBookedPoints,
	  ISNULL(d.Notes,'') Notes,
	  d.ListGenderId,
	  ISNULL(g.Title,'') ListGender,
	  IsGI,
	  d.Locked,
	  CASE WHEN (SELECT count(a.AppointmentId) FROM ERS_Appointments a LEFT JOIN dbo.ERS_AppointmentStatus s ON s.UniqueId = a.AppointmentStatusId WHERE DiaryId = @DiaryId AND ISNULL(s.HDCKEY,'') <> 'C') > 0 THEN convert(bit,1) ELSE convert(bit,0) END Appointments,
	  ISNULL((SELECT sum(pt.points) FROM ERS_AppointmentProcedureTypes pt INNER JOIN ERS_Appointments a ON a.AppointmentId = pt.AppointmentID LEFT JOIN dbo.ERS_AppointmentStatus s ON s.UniqueId = a.AppointmentStatusId WHERE DiaryId = @DiaryId AND ISNULL(s.HDCKEY,'') <> 'C'),0) AppointmentPoints,
	  ISNULL((SELECT SUM(ls.Points) FROM dbo.ERS_SCH_ListSlots ls WHERE ls.Locked = 1 AND ls.ListRulesId = d.ListRulesId),0) BlockedPoints,
	  CASE WHEN (SELECT count(a.AppointmentId) FROM ERS_Appointments a LEFT JOIN dbo.ERS_AppointmentStatus s ON s.UniqueId = a.AppointmentStatusId WHERE DiaryId = @DiaryId AND ISNULL(s.HDCKEY,'') = 'C') > 0 THEN convert(bit,1) ELSE convert(bit,0) END CancelledAppointments,
	  CASE WHEN ISNULL(RecurrenceParentID, 0) > 0 THEN convert(bit,1) ELSE convert(bit,0) END Recurring,
	  CASE WHEN ISNULL(RecurrenceParentID, 0) > 0 THEN 
		CASE RecurrenceFrequency WHEN 'd' THEN 'daily for ' + convert(varchar(10), RecurrenceCount) + ' day(s)'
							     WHEN 'w' THEN 'weekly for ' + convert(varchar(10), RecurrenceCount) + ' week(s)' 
								 when 'm' THEN 'montly for ' + convert(varchar(10), RecurrenceCount) + ' month(s)' 
		END 
	  END RecurrancePattern
	FROM ERS_SCH_DiaryPages d
		INNER JOIN ERS_Users u ON u.UserID = d.UserId
		LEFT JOIN ERS_Users c ON c.UserID = d.ListConsultantId
		INNER JOIN (SELECT ls.ListRulesId, (SUM(Points) - SUM(CONVERT(INT, IsOverBookedSlot))) TotalPoints, SUM(CONVERT(INT, IsOverBookedSlot)) OverBookedPoints, SUM(SlotMinutes) TotalMinutes FROM ERS_SCH_ListSlots ls WHERE ls.Active = 1 GROUP BY ListRulesId) ls ON ls.ListRulesId = d.ListRulesId
		LEFT JOIN ERS_GenderTypes g on g.GenderId = d.ListGenderId
	WHERE d.DiaryId = @DiaryId
GO


ALTER PROCEDURE [dbo].[sch_diary_overview_select]
(
	@Month int,
	@Year int,
	@OperatingHospitalId int
)
AS
SET NOCOUNT ON

BEGIN TRANSACTION

BEGIN TRY
  SELECT d.DiaryId, d.Subject, d.DiaryStart, d.DiaryEnd, d.RoomID, r.RoomName as Room, d.UserID, e.Title + ' ' + e.Forename + ' ' + e.Surname as Endoscopist, c.Title + ' ' + c.Title + ' ' + c.Forename + ' ' + c.Surname as ListConsultant, 
		l.ListName, l.TotalMins, l.Points PointsAvailable, l.ListRulesId, ISNULL(l.ListName, '') [Description], l.GIProcedure,d.Training, d.OperatingHospitalId,
		NULL RecurrenceRule,
		NULL AS RecurrenceParentID,
		ListGenderId,
		Notes,
		d.IsGI,
		d.Locked,
		ISNULL((SELECT sum(apt.Points) FROM ERS_Appointments a INNER JOIN ERS_AppointmentProcedureTypes apt on apt.AppointmentID = a.AppointmentId LEFT JOIN dbo.ERS_AppointmentStatus aps ON aps.UniqueId = a.AppointmentStatusId WHERE DiaryId = d.DiaryId AND ISNULL(aps.HDCKEY,'') <> 'C'),0) AppointmentPoints,
		ISNULL((SELECT SUM(ls.Points) FROM dbo.ERS_SCH_ListSlots ls WHERE ls.Locked = 1 AND ls.ListRulesId = d.ListRulesId),0) BlockedPoints
  FROM ERS_SCH_DiaryPages d
		INNER JOIN ERS_SCH_Rooms r ON r.RoomId = d.RoomID
	  INNER JOIN ERS_SCH_ListRules l ON l.ListRulesId = d.ListRulesId
	  LEFT JOIN ERS_Users e ON e.UserID = d.UserId
	  LEFT JOIN ERS_Users c ON c.UserID = d.ListConsultantId
  WHERE d.OperatingHospitalId = @OperatingHospitalId AND ( DATEPART(month, d.DiaryStart) = @Month and datepart(year, d.DiaryStart) = @Year)
  ORDER BY d.DiaryStart
END TRY

BEGIN CATCH
       DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

       IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH

IF @@TRANCOUNT > 0 COMMIT TRANSACTION;
GO



------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Steve 08-Feb-2024
-- TFS#	3542
-- Description of change
-- Miscellaneous Site Menu on EUS HPB repeating the menu rather than showing Miscellaneous option
--   Check entry is in the ERS_SiteDetailsMenuUrls table to return the URL for this menu
------------------------------------------------------------------------------------------------------------------------
GO

IF NOT EXISTS(
	SELECT *
	FROM ERS_SiteDetailsMenuUrls
	WHERE ProcedureType = 7
	AND Menu = 'Miscellaneous'
)
BEGIN
	INSERT INTO ERS_SiteDetailsMenuUrls (ProcedureType, Menu, NavigateUrl)
	VALUES (7, 'Miscellaneous', '~/Products/Gastro/Abnormalities/OGD/Miscellaneous.aspx')
END

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	3542
------------------------------------------------------------------------------------------------------------------------
GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Steve 08-Feb-2024
-- TFS#	
-- Description of change
-- Labels for Totals Boxes on Lab Request Form don't match name for area markings
------------------------------------------------------------------------------------------------------------------------
GO
EXEC dbo.DropIfExist @ObjectName = 'printreport_specimens_select',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[printreport_specimens_select]
(
	@ProcedureId INT
)
AS
/***************************************************************************
*****                        Change History                           *****
***************************************************************************
** Rev	Date			Author			Description 
** --	-----------		---------		---------------------------------------
** 1	15 Sep 2021		Adrian (ARS)	New Bronchs section
** 2	21 Sep 2021		Adrian (ARS)	Add new reports for Bronchs
** 3	02 Feb 2024		Steve			Updated to return area description for area marking
**************************************************************************/

SET NOCOUNT ON

DECLARE 
       @procType INT,
       @siteIdentification TINYINT,
       @siteId INT, 
       @siteNo INT,
       @siteTitle VARCHAR(3),
	   @OperatingHospitalID TINYINT
DECLARE 
       @SpecimensSummary TABLE (
              SiteId INT,
              LabRequestReportName VARCHAR(200),
              SpecimenKey VARCHAR(1000),
              Specimen VARCHAR(2000))

SELECT @procType = ProcedureType FROM ERS_Procedures WHERE ProcedureId = @ProcedureId
SELECT @OperatingHospitalID = OperatingHospitalID FROM ERS_Procedures WHERE ProcedureId = @ProcedureId


       SELECT s.SiteNo, Case @procType WHEN 1 THEN ISNULL(m.Area,'') ELSE '' END AS RegionSection, CASE WHEN s.AreaNo > 0 Then dbo.fnSetAreaDescription(@ProcedureId, s.AreaNo, p.ResectedColonNo) ELSE r.Region END AS Region, sp.*, r.RegionId
       INTO #specimens
       FROM ERS_UpperGISpecimens sp
       JOIN ERS_Sites s ON sp.SiteId = s.SiteId
       JOIN ERS_Regions r ON s.RegionId = r.RegionId
       LEFT JOIN ERS_AbnormalitiesMatrixUpperGI m ON r.Region = m.Region AND m.ProcedureType = @procType
       LEFT JOIN [ERS_AbnormalitiesMatrixERCP] n ON r.Region = n.Region AND n.ProcedureType = @procType
       LEFT JOIN [ERS_AbnormalitiesMatrixColon] o ON r.Region = o.Region AND o.ProcedureType = @procType
	   JOIN ERS_Procedures p ON p.ProcedureId = s.ProcedureId
       WHERE s.ProcedureId = @ProcedureId 

UPDATE #specimens SET RegionSection = CASE RegionSection WHEN 'Oesophagus' THEN 'oesophageal' WHEN 'Stomach' THEN 'gastric' WHEN 'Duodenum' THEN 'duodenal' ELSE '' END

--update #specimens SET Region = CASE WHEN RegionId in (SELECT ercr.RegionId FROM dbo.ERS_ResectedColon erc
--															INNER JOIN dbo.ERS_ResectedColonRegions ercr ON erc.ResectedColonID = ercr.ResectedColonID
--															INNER JOIN dbo.ERS_Procedures ep ON erc.ResectedColonID = ep.ResectedColonNo
--															WHERE ep.ProcedureId=@ProcedureId)
--											THEN 'Anastomosis'
--											ELSE Region
--											END



DECLARE Site_Cursor CURSOR FOR
SELECT SiteId, SiteNo FROM #specimens ORDER BY SiteNo
       
OPEN Site_Cursor
FETCH NEXT FROM Site_Cursor INTO @siteId , @siteNo

WHILE @@FETCH_STATUS = 0
BEGIN
       SET @siteTitle = dbo.fnGetSiteTitle(@siteNo, @OperatingHospitalID)

       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Cytology', 
              CONVERT(VARCHAR, @siteId) + 'Brush', 
              LOWER(RegionSection) + ' brushings for cytology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND BrushCytology > 0
              
       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Histology', 
              CONVERT(VARCHAR, @siteId) + 'BiopsyHistology', 
              CONVERT(VARCHAR,BiopsyQtyHistology) + ' ' + LOWER(RegionSection) + CASE WHEN BiopsyQtyHistology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for histology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND BiopsyQtyHistology > 0

       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Microbiology', 
              CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
              CONVERT(VARCHAR,BiopsyQtyMicrobiology) + ' ' + LOWER(RegionSection) + CASE WHEN BiopsyQtyMicrobiology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for microbiology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND Biopsy = 1 AND BiopsyQtyMicrobiology > 0
              
       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Virology', 
              CONVERT(VARCHAR, @siteId) + 'BiopsyVirology', 
              CONVERT(VARCHAR,BiopsyQtyVirology) + ' ' + LOWER(RegionSection) + CASE WHEN BiopsyQtyVirology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for virology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND Biopsy = 1 AND BiopsyQtyVirology > 0
       
       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Histology', 
              CONVERT(VARCHAR, @siteId) + 'Polypectomy', 
              CONVERT(VARCHAR,PolypectomyQty) + ' ' + LOWER(RegionSection) + CASE WHEN PolypectomyQty > 1 THEN ' polyps' ELSE ' polyp' END + ' for histology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND Polypectomy = 1 AND PolypectomyQty > 0

       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Histology', 
              CONVERT(VARCHAR, @siteId) + 'HotBiopsy', 
              LOWER(RegionSection) + ' hot biopsy for histology from (' + LOWER(@siteTitle) + ' ) ' + Region + CASE WHEN HotBiopsyDistance > 0 THEN ' at ' + CONVERT(VARCHAR, HotBiopsyDistance) + 'cm' ELSE '' END 
       FROM #specimens 
       WHERE SiteId = @siteId AND HotBiopsy = 1
       
       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Cytology', 
              CONVERT(VARCHAR, @siteId) + 'NeedleAspirateHistology', 
              LOWER(RegionSection) + ' needle aspirate for cytology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND NeedleAspirate = 1 AND NeedleAspirateHistology = 1

       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Histology', 
              CONVERT(VARCHAR, @siteId) + 'NeedleBiopsyHistology', 
              LOWER(RegionSection) + ' needle biopsy for histology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND FNB = 1 AND NeedleBiopsyHistology = 1

       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Cytology', 
              CONVERT(VARCHAR, @siteId) + 'NeedleBiopsyCytology', 
              LOWER(RegionSection) + ' needle biopsy for cytology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND FNB = 1 AND NeedleBiopsyCytology = 1

       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Microbiology', 
              CONVERT(VARCHAR, @siteId) + 'NeedleBiopsyMicrobiology', 
              LOWER(RegionSection) + ' needle biopsy for microbiology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND FNB = 1 AND NeedleBiopsyMicrobiology = 1

       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Virology', 
              CONVERT(VARCHAR, @siteId) + 'NeedleBiopsyVirology', 
              LOWER(RegionSection) + ' needle biopsy for virology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND FNB = 1 AND NeedleBiopsyVirology = 1


       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Microbiology', 
              CONVERT(VARCHAR, @siteId) + 'NeedleAspirateMicrobiology', 
              LOWER(RegionSection) + ' needle aspirate for microbiology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND NeedleAspirate = 1 AND NeedleAspirateMicrobiology = 1

       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Virology', 
              CONVERT(VARCHAR, @siteId) + 'NeedleAspirateVirology', 
              LOWER(RegionSection) + ' needle aspirate for virology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND NeedleAspirate = 1 AND NeedleAspirateVirology = 1

       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Microbiology', 
              CONVERT(VARCHAR, @siteId) + 'GastricWashing', 
              'gastric washing for microbiology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND GastricWashing = 1

       FETCH NEXT FROM Site_Cursor INTO @siteId, @siteNo
END
CLOSE Site_Cursor;
DEALLOCATE Site_Cursor;

--biopsy series
INSERT INTO @SpecimensSummary
SELECT 
	ess.BiopsySiteId,
	'Histology',
	convert(varchar, ess.BiopsySiteId) + 'BiopsyHistology', 
	convert(varchar, ess.qty) + CASE WHEN ess.qty = 1 THEN ' biopsy' ELSE ' biopsies' END + ' for histology from ' + ebs.Description
FROM dbo.ERS_SiteSpecimens ess
	INNER JOIN dbo.ERS_BiopsySites ebs ON ess.BiopsySiteId = ebs.UniqueId
	INNER JOIN dbo.ERS_Sites es ON ess.SiteId = es.SiteId
WHERE ProcedureId = @ProcedureId


       SELECT s.SiteNo, Case @procType WHEN 1 THEN ISNULL(m.Area,'') ELSE '' END AS RegionSection, r.Region, sp.*, r.RegionId
       INTO #specimensCysto
       FROM ERS_CystoscopySpecimens sp
       JOIN ERS_Sites s ON sp.SiteId = s.SiteId
       JOIN ERS_Regions r ON s.RegionId = r.RegionId
       LEFT JOIN ERS_AbnormalitiesMatrixUpperGI m ON r.Region = m.Region AND m.ProcedureType = @procType
       LEFT JOIN [ERS_AbnormalitiesMatrixERCP] n ON r.Region = n.Region AND n.ProcedureType = @procType
       LEFT JOIN [ERS_AbnormalitiesMatrixColon] o ON r.Region = o.Region AND o.ProcedureType = @procType
       WHERE s.ProcedureId = @ProcedureId 
 
DECLARE Site_Cursor CURSOR FOR
SELECT SiteId, SiteNo FROM #specimensCysto ORDER BY SiteNo
       
OPEN Site_Cursor
FETCH NEXT FROM Site_Cursor INTO @siteId , @siteNo

WHILE @@FETCH_STATUS = 0
BEGIN
		SET @siteTitle = dbo.fnGetSiteTitle(@siteNo, @OperatingHospitalID)

		/****************************************************************
		*							MICROBIOLOGY						*
		****************************************************************/		
		/****************************************************************
		*	Microbiology Sub-section - EBUS Specimen					*
		****************************************************************/		
		INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Histology', 
              CONVERT(VARCHAR, @siteId) + 'BiopsyCystoHistology', 
              CONVERT(VARCHAR,Qunatity) + ' ' + LOWER(RegionSection) + CASE WHEN Qunatity > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for histology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimensCysto
       WHERE SiteId = @siteId AND Qunatity > 0


       FETCH NEXT FROM Site_Cursor INTO @siteId, @siteNo
END
CLOSE Site_Cursor;
DEALLOCATE Site_Cursor;

/****************************************************************
ARS(15/09/21) - Bronchs Section
ARS(21/09/21) - Updated for reports
****************************************************************/
SELECT s.SiteNo, '' AS RegionSection, r.Region, ebs.SiteID AS SiteId, r.RegionId, 
		ebs.EBUSTB, ebs.EBUSCytology, ebs.EBUSHistology, ebs.EBUSBacteriology, ebs.EndobronchialTB, ebs.EndobronchialHistology, ebs.EndobronchialBacteriology,
		ebs.EndobronchialVirology, ebs.EndobronchialMycology, ebs.BrushCytology, ebs.BrushBacteriology, ebs.BrushVirology, ebs.BrushMycology, ebs.DistalBlindTB,
		ebs.DistalBlindHistology, ebs.DistalBlindVirology, ebs.DistalBlindBacteriology, ebs.DistalBlindMycology, ebs.TransbronchialTB, ebs.TransbronchialHistology,
		ebs.TransbronchialBacteriology, ebs.TransbronchialVirology, ebs.TransbronchialMycology, ebs.TranstrachealHistology, ebs.TranstrachealBacteriology,
		ebs.TranstrachealVirology, ebs.TranstrachealMycology, ebs.TrapPCP, ebs.TrapTB, ebs.TrapCytology, ebs.TrapBacteriology, ebs.TrapVirology, ebs.TrapMycology,
		ebs.BALPCP, ebs.BALTB, ebs.BALCytology, ebs.BALBacteriology, ebs.BALVirology, ebs.BALMycology, ebs.BALVolInfused, ebs.BALVolRecovered, ebs.FNATB,
		ebs.FNACytology, ebs.FNABacteriology, ebs.FNAVirology, ebs.FNAMycology, ebs.FNAHistology, ebs.CryoHistology, ebs.FungalCultureMycology, ebs.Summary
       INTO #specimensBRT
       FROM dbo.ERS_BRTSpecimens AS ebs
       JOIN ERS_Sites s ON s.SiteId = ebs.SiteID
       JOIN ERS_Regions r ON s.RegionId = r.RegionId
       LEFT JOIN dbo.ERS_AbnormalitiesMatrixBRT AS eamb ON eamb.Region = r.Region AND eamb.ProcedureType = @procType
       WHERE s.ProcedureId = @ProcedureId 
	   
DECLARE Site_Cursor CURSOR FOR
SELECT SiteId, SiteNo FROM #specimensBRT ORDER BY SiteNo
       
OPEN Site_Cursor
FETCH NEXT FROM Site_Cursor INTO @siteId , @siteNo

WHILE @@FETCH_STATUS = 0
BEGIN
		SET @siteTitle = dbo.fnGetSiteTitle(@siteNo, @OperatingHospitalID)

		/****************************************************************
		*							MICROBIOLOGY						*
		****************************************************************/		
		/****************************************************************
		*	Microbiology Sub-section - EBUS Specimen					*
		****************************************************************/		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'SpecimenMicrobiology', 
            CONVERT(VARCHAR,spec.EBUSTB) + ' ' + LOWER(RegionSection) + CASE WHEN spec.EBUSTB > 1 THEN ' EBUS specimens' ELSE ' EBUS specimen' END + ' for TB bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.EBUSTB > 0
		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'SpecimenMicrobiology', 
            CONVERT(VARCHAR,spec.EBUSBacteriology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.EBUSBacteriology > 1 THEN ' specimens' ELSE ' specimen' END + ' for bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.EBUSBacteriology > 0
			   
		/****************************************************************
		*	Microbiology Sub-section - Endobronchial Biopsy				*
		****************************************************************/		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.EndobronchialTB) + ' ' + LOWER(RegionSection) + CASE WHEN spec.EndobronchialTB > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for TB bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.EndobronchialTB > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.EndobronchialBacteriology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.EndobronchialBacteriology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.EndobronchialBacteriology > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.EndobronchialVirology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.EndobronchialVirology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for virology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.EndobronchialVirology > 0
		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.EndobronchialMycology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.EndobronchialMycology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for mycology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.EndobronchialMycology > 0

		/****************************************************************
		*	Microbiology Sub-section - Brush Biopsy						*
		****************************************************************/		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.BrushBacteriology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.BrushBacteriology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.BrushBacteriology > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.BrushVirology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.BrushVirology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for virology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.BrushVirology > 0
		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.EndobronchialMycology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.EndobronchialMycology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for mycology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.EndobronchialMycology > 0

		/****************************************************************
		*	Microbiology Sub-section - Distal Blind Biopsy				*
		****************************************************************/		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.DistalBlindTB) + ' ' + LOWER(RegionSection) + CASE WHEN spec.DistalBlindTB > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for TB bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.DistalBlindTB > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.DistalBlindBacteriology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.DistalBlindBacteriology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.DistalBlindBacteriology > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.DistalBlindVirology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.DistalBlindVirology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for virology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.DistalBlindVirology > 0
		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.DistalBlindMycology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.DistalBlindMycology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for mycology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.DistalBlindMycology > 0

		/****************************************************************
		*	Microbiology Sub-section - Transbronchial Biopsy			*
		****************************************************************/		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.TransbronchialTB) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TransbronchialTB > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for TB bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TransbronchialTB > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.TransbronchialBacteriology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TransbronchialBacteriology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TransbronchialBacteriology > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.TransbronchialVirology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TransbronchialVirology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for virology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TransbronchialVirology > 0
		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.TransbronchialMycology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TransbronchialMycology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for mycology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TransbronchialMycology > 0

		/****************************************************************
		*	Microbiology Sub-section - Transtracheal Biopsy				*
		****************************************************************/		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.TranstrachealBacteriology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TranstrachealBacteriology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TranstrachealBacteriology > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.TranstrachealVirology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TranstrachealVirology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for virology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TranstrachealVirology > 0
		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.TranstrachealMycology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TranstrachealMycology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for mycology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TranstrachealMycology > 0

		/****************************************************************
		*	Microbiology Sub-section - Trap								*
		****************************************************************/		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.TrapTB) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TrapTB > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for TB bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TrapTB > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.TrapBacteriology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TrapBacteriology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TrapBacteriology > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.TrapVirology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TrapVirology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for virology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TrapVirology > 0
		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.TrapMycology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TrapMycology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for mycology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TrapMycology > 0

		/****************************************************************
		*	Microbiology Sub-section - Bronchoalveolar Lavage (BAL)		*
		****************************************************************/		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.BALTB) + ' ' + LOWER(RegionSection) + CASE WHEN spec.BALTB > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for TB bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.BALTB > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.BALBacteriology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.BALBacteriology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.BALBacteriology > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.BALVirology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.BALVirology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for virology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.BALVirology > 0
		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.BALMycology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.BALMycology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for mycology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.BALMycology > 0

		/****************************************************************
		*	Microbiology Sub-section - Fine Needle Aspirate (FNA)		*
		****************************************************************/		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.FNABacteriology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.FNABacteriology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.FNABacteriology > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.FNAVirology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.FNAVirology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for virology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.FNAVirology > 0
		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.FNAMycology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.FNAMycology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for mycology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.FNAMycology > 0

		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.FungalCultureMycology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.FungalCultureMycology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for mycology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.FungalCultureMycology > 0

		/****************************************************************
		*							HISTOLOGY							*
		****************************************************************/
		/****************************************************************
		*	Histology Sub-section - EBUS Specimen						*
		****************************************************************/
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Histology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyHistology', 
            CONVERT(VARCHAR,spec.EBUSHistology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.EBUSHistology > 1 THEN ' EBUS specimens' ELSE ' EBUS specimen' END + ' for histology from (' + LOWER(@siteTitle) + ') ' + Region			
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.EBUSHistology > 0

		/****************************************************************
		*	Histology Sub-section - Endobronchial Biopsy				*
		****************************************************************/
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Histology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyHistology', 
            CONVERT(VARCHAR,spec.EndobronchialHistology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.EndobronchialHistology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for histology from (' + LOWER(@siteTitle) + ') ' + Region			
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.EndobronchialHistology > 0

		/****************************************************************
		*	Histology Sub-section - Distal Blind Biopsy					*
		****************************************************************/
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Histology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyHistology', 
            CONVERT(VARCHAR,spec.DistalBlindHistology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.DistalBlindHistology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for histology from (' + LOWER(@siteTitle) + ') ' + Region			
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.DistalBlindHistology > 0

		/****************************************************************
		*	Histology Sub-section - Transbronchial Biopsy				*
		****************************************************************/
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Histology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyHistology', 
            CONVERT(VARCHAR,spec.TransbronchialHistology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TransbronchialHistology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for histology from (' + LOWER(@siteTitle) + ') ' + Region			
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TransbronchialHistology > 0

		/****************************************************************
		*	Histology Sub-section - Transtracheal Biopsy				*
		****************************************************************/
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Histology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyHistology', 
            CONVERT(VARCHAR,spec.TranstrachealHistology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TranstrachealHistology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for histology from (' + LOWER(@siteTitle) + ') ' + Region			
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TranstrachealHistology > 0

		/****************************************************************
		*	Histology Sub-section - Fine Needle Aspirate (FNA)			*
		****************************************************************/
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Histology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyHistology', 
            CONVERT(VARCHAR,spec.FNAHistology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.FNAHistology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for histology from (' + LOWER(@siteTitle) + ') ' + Region			
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.FNAHistology > 0

		/****************************************************************
		*	Histology Sub-section - Cryobiopsy							*
		****************************************************************/		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Histology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyHistology', 
            CONVERT(VARCHAR,spec.CryoHistology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.CryoHistology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for histology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.CryoHistology > 0

		/****************************************************************
		*							CYTOLOGY							*
		****************************************************************/
		/****************************************************************
		*	Cytology Sub-section - EBUS Specimen						*
		****************************************************************/
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Cytology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyCytology', 
            CONVERT(VARCHAR,spec.EBUSCytology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.EBUSCytology > 1 THEN ' EBUS specimens' ELSE ' EBUS specimen' END + ' for cytology from (' + LOWER(@siteTitle) + ') ' + Region			
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.EBUSCytology > 0

		/****************************************************************
		*	Cytology Sub-section - Brush Biopsy							*
		****************************************************************/
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Cytology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyCytology', 
            CONVERT(VARCHAR,spec.BrushCytology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.BrushCytology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for cytology from (' + LOWER(@siteTitle) + ') ' + Region			
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.BrushCytology > 0

		/****************************************************************
		*	Cytology Sub-section - Trap									*
		****************************************************************/
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Cytology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyCytology', 
            CONVERT(VARCHAR,spec.TrapCytology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TrapCytology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for cytology from (' + LOWER(@siteTitle) + ') ' + Region			
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TrapCytology > 0

		/****************************************************************
		*	Cytology Sub-section - Bronchoalveolar Lavage (BAL)			*
		****************************************************************/
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Cytology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyCytology', 
            CONVERT(VARCHAR,spec.BALCytology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.BALCytology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for cytology from (' + LOWER(@siteTitle) + ') ' + Region			
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.BALCytology > 0

		/****************************************************************
		*	Cytology Sub-section - Fine Needle Aspirate (FNA)			*
		****************************************************************/
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Cytology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyCytology', 
            CONVERT(VARCHAR,spec.FNACytology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.FNACytology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for cytology from (' + LOWER(@siteTitle) + ') ' + Region			
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.FNACytology > 0
	   
       FETCH NEXT FROM Site_Cursor INTO @siteId, @siteNo
END
CLOSE Site_Cursor;
DEALLOCATE Site_Cursor;

IF OBJECT_ID('tempdb..#specimens') IS NOT NULL DROP TABLE #specimens 
IF OBJECT_ID('tempdb..#specimensBRT') IS NOT NULL DROP TABLE #specimensBRT
SELECT * FROM @SpecimensSummary


------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 09.02.24
-- TFS#	
-- Description of change
-- Add previous diseases to summary based on procedure types
------------------------------------------------------------------------------------------------------------------------
GO

ALTER FUNCTION [dbo].[ProcedureIndicationsSummary]
(
	@ProcedureId int
)
RETURNS varchar(max)
AS
BEGIN

DECLARE @IndicationsString  varchar(max), @ComorbidityString varchar(max), @DamagingDrugsString varchar(max), @PatientAllergiesString varchar(max), @PreviousSurgeryString varchar(max), 
		@PreviousDiseasesString varchar(max), @FamilyDiseaseHistoryString varchar(max), @ImagingString varchar(max), @ImagingOutcomeString varchar(max),
		@RetVal varchar(max), @ProcedureTypeId INT

SELECT @ProcedureTypeId = ProcedureType FROM dbo.ERS_Procedures WHERE ProcedureId = @ProcedureId

SELECT @IndicationsString =
	LTRIM(STUFF((SELECT ', ' + CASE WHEN i.AdditionalInfo = 0 THEN [Description] ELSE AdditionalInformation END + CASE WHEN ISNULL(ChildIndicationId, 0) > 0 THEN '-' + (SELECT [Description] FROM ERS_Indications WHERE UniqueId = epi.ChildIndicationId) ELSE '' END AS [text()] 
	FROM ERS_ProcedureIndications epi 
	INNER JOIN ERS_Indications i on i.UniqueId = epi.IndicationId
	WHERE ProcedureId=@ProcedureId
	ORDER BY ISNULL(i.ListOrderBy, 0)
	FOR XML PATH('')),1,1,''))

--rockall and baltchford scoring
SELECT @IndicationsString	= @IndicationsString + CASE WHEN CHARINDEX('melaena', @IndicationsString) > -1 OR CHARINDEX('haematemesis', @IndicationsString) > -1 THEN ' ' + dbo.fnBlatchfordRockallScores(@ProcedureId) ELSE '' END
--SELECT @IndicationsString = dbo.fnCapitalise(dbo.fnAddFullStop(@IndicationsString)) 

IF LEN(@IndicationsString) > 0
BEGIN
	IF charindex(',', reverse(@IndicationsString)) > 0
		SELECT @RetVal = STUFF(@IndicationsString, len(@IndicationsString) - charindex(' ,', reverse(@IndicationsString)) + 1, 2, ' and ')
	ELSE
		SELECT @RetVal = @IndicationsString
END
-------------------CoMorbidity


SELECT @ComorbidityString =
	LTRIM(STUFF((SELECT ', ' + CASE WHEN AdditionalInformation = '' THEN [Description] ELSE AdditionalInformation END + CASE WHEN ISNULL(ChildComorbidityId, 0) > 0 THEN '-' + (SELECT [Description] FROM ERS_CoMorbidity WHERE UniqueId = ChildComorbidityId) ELSE '' END AS [text()] 
	FROM ERS_ProcedureComorbidity epc 
	INNER JOIN ERS_Comorbidity c on c.uniqueid = CoMorbidityId
	WHERE ProcedureId=@ProcedureId
	ORDER BY ISNULL(c.ListOrderBy, 0)
	FOR XML PATH('')),1,1,''))

--SELECT @ComorbidityString = dbo.fnCapitalise(dbo.fnAddFullStop(@ComorbidityString)) 

IF LEN(@ComorbidityString) > 0 
BEGIN
	IF charindex(',', reverse(@ComorbidityString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Co-morbidity: ' + STUFF(@ComorbidityString, len(@ComorbidityString) - charindex(' ,', reverse(@ComorbidityString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Co-morbidity: ' + @ComorbidityString
END

-------------------Damaging drugs

SELECT @DamagingDrugsString =
	LTRIM(STUFF((SELECT ', ' + [Description] AS [text()] 
	FROM ERS_ProcedureDamagingDrugs edd 
	INNER JOIN ERS_PotentialDamagingDrugs d on d.uniqueid = edd.DamagingDrugId
	WHERE edd.ProcedureId=@ProcedureId
	ORDER BY ISNULL(d.ListOrderBy, 0)
	FOR XML PATH('')),1,1,''))

--SELECT @DamagingDrugsString = dbo.fnCapitalise(dbo.fnAddFullStop(@DamagingDrugsString)) 

DECLARE @AntiCoagDrugs bit = (SELECT AntiCoagDrugs FROM ERS_Procedures WHERE ProcedureId = @ProcedureId)
IF @AntiCoagDrugs IS NOT NULL
	If @AntiCoagDrugs = 1 SET @DamagingDrugsString = @DamagingDrugsString + '<br />The patient is taking anti-coagulant or anti-platelet medication.'

IF LEN(@DamagingDrugsString) > 0
BEGIN
	IF charindex(',', reverse(@DamagingDrugsString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Potential damaging drug(s): ' + STUFF(@DamagingDrugsString, len(@DamagingDrugsString) - charindex(' ,', reverse(@DamagingDrugsString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Potential damaging drug(s): ' + @DamagingDrugsString
END
-------------------Allergies

SELECT @PatientAllergiesString =
	CASE AllergyResult 
		WHEN -1 THEN 'unknown'
		WHEN 0 THEN 'none'
		WHEN 1 THEN a.AllergyDescription 
	END
	FROM ERS_PatientAllergies a
		INNER JOIN ERS_Procedures p ON p.PatientId = a.PatientId
	WHERE p.ProcedureId = @ProcedureId

--SELECT @PatientAllergiesString = dbo.fnCapitalise(dbo.fnAddFullStop(@PatientAllergiesString)) 

IF LEN(@PatientAllergiesString) > 0
BEGIN
	IF charindex(',', reverse(@PatientAllergiesString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Allergies: ' + STUFF(@PatientAllergiesString, len(@PatientAllergiesString) - charindex(' ,', reverse(@PatientAllergiesString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Allergies: ' + @PatientAllergiesString
END
-------------------Previous surgery

SELECT @PreviousSurgeryString =
	LTRIM(STUFF((SELECT DISTINCT ', ' + [Description] 
	--+ CASE WHEN ListItemText = 'Unknown' THEN '' ELSE ' ' + ListItemText END 
	as [text()] 
	FROM ERS_PatientPreviousSurgery h
	INNER JOIN ERS_PreviousSurgery r on r.UniqueID = h.PreviousSurgeryID
	INNER JOIN dbo.ERS_PreviousSurgeryProcedureTypes pspt ON pspt.PreviousSurgeryId = r.UniqueId AND pspt.ProcedureTypeId = @ProcedureTypeId
	--INNER JOIN ERS_Lists l on l.ListItemNo = h.PreviousSurgeryPeriod and ListDescription = 'Follow up disease Period'
	INNER JOIN ERS_Procedures p on p.patientId = h.patientId 
	WHERE p.ProcedureId = @ProcedureId
	--ORDER BY ISNULL(r.ListOrderBy, 0)
	FOR XML PATH('')),1,1,''))

--SELECT @PreviousSurgeryString = dbo.fnCapitalise(dbo.fnAddFullStop(@PreviousSurgeryString)) 

IF LEN(@PreviousSurgeryString) > 0
BEGIN
	IF charindex(',', reverse(@PreviousSurgeryString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Previous surgery: ' + STUFF(@PreviousSurgeryString, len(@PreviousSurgeryString) - charindex(' ,', reverse(@PreviousSurgeryString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Previous surgery: ' + @PreviousSurgeryString
END

-------------------ASA Status
DECLARE @ASAStatusString varchar(max) = 
	(SELECT TOP 1 [description]
	FROM ERS_PatientASAStatus pa 
		INNER JOIN ERS_ASAStatus a on a.uniqueid = pa.asastatusid
		INNER JOIN ERS_Procedures p ON p.PatientId = pa.PatientId
	WHERE ProcedureId = @ProcedureId
	order by isnull(pa.WhenUpdated, pa.WhenCreated))

IF LEN(@ASAStatusString) > 0 
BEGIN
	SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'ASA Status: ' + @ASAStatusString
END
-------------------Previous diseases

SELECT @PreviousDiseasesString =
	LTRIM(STUFF((SELECT DISTINCT ', ' + [Description] as [text()] 
	FROM ERS_PatientPreviousDiseases pd
	INNER JOIN ERS_PreviousDiseases d on d.UniqueID = pd.PreviousDiseaseID
	INNER JOIN dbo.ERS_PreviousDiseaseProcedureTypes ppt ON ppt.PreviousDiseaseId = d.UniqueId AND ppt.ProcedureTypeId = @ProcedureTypeId
	INNER JOIN ERS_Procedures p on p.patientId = pd.patientId 
	WHERE p.ProcedureId = @ProcedureId
	--ORDER BY ISNULL(r.ListOrderBy, 0)
	FOR XML PATH('')),1,1,''))

--SELECT @PreviousDiseasesString = dbo.fnCapitalise(dbo.fnAddFullStop(@PreviousDiseasesString)) 

IF LEN(@PreviousDiseasesString) > 0
BEGIN
	IF charindex(',', reverse(@PreviousDiseasesString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Previous diseases: ' + STUFF(@PreviousDiseasesString, len(@PreviousDiseasesString) - charindex(' ,', reverse(@PreviousDiseasesString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Previous diseases: ' + @PreviousDiseasesString
END

-------------------Family disease history

SELECT @FamilyDiseaseHistoryString =
	LTRIM(STUFF((SELECT ', ' + CASE WHEN AdditionalInformation = '' THEN [Description] ELSE AdditionalInformation END AS [text()] 
	FROM ERS_PatientFamilyDiseaseHistory epi 
	INNER JOIN ERS_FamilyDiseaseHistory i on i.UniqueId = epi.FamilyDiseaseHistoryId
	INNER JOIN ERS_Procedures p on p.patientId = epi.patientId 
	WHERE ProcedureId=@ProcedureId
	ORDER BY ISNULL(i.ListOrderBy, 999)
	FOR XML PATH('')),1,1,''))

--SELECT @FamilyDiseaseHistoryString = dbo.fnCapitalise(dbo.fnAddFullStop(@FamilyDiseaseHistoryString)) 

IF LEN(@FamilyDiseaseHistoryString) > 0
BEGIN
	IF charindex(',', reverse(@FamilyDiseaseHistoryString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Family history: ' + STUFF(@FamilyDiseaseHistoryString, len(@FamilyDiseaseHistoryString) - charindex(' ,', reverse(@FamilyDiseaseHistoryString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Family history: ' + @FamilyDiseaseHistoryString
END


-------------------Imaging

SELECT @ImagingString =
	LTRIM(STUFF((SELECT ', ' + [Description] AS [text()] 
	FROM ERS_ImagingMethods im 
	INNER JOIN ERS_ProcedureImagingMethod pim on im.uniqueid = pim.ImagingMethodId
	WHERE pim.ProcedureId=@ProcedureId
	FOR XML PATH('')),1,1,''))


IF LEN(@ImagingString) > 0
BEGIN
	IF charindex(',', reverse(@ImagingString)) > 0
		SELECT @ImagingString = STUFF(@ImagingString, len(@ImagingString) - charindex(' ,', reverse(@ImagingString)), 2, ' and ')
END


SELECT @ImagingOutcomeString =
	LTRIM(STUFF((SELECT ', ' + [Description] AS [text()] 
	FROM ERS_ImagingOutcomes imo 
	INNER JOIN ERS_ProcedureImagingOutcome pio on imo.uniqueid = pio.ImagingOutcomeId
	WHERE pio.ProcedureId=@ProcedureId
	FOR XML PATH('')),1,1,''))

IF ISNULL(@ImagingOutcomeString,'') <> ''
BEGIN
	SELECT @ImagingString = CASE WHEN ISNULL(@ImagingString, '') <> '' THEN @ImagingString + ' revealed ' ELSE '' END  + @ImagingOutcomeString
END


--SELECT @ImagingString = dbo.fnCapitalise(dbo.fnAddFullStop(@ImagingString)) 

IF LEN(@ImagingString) > 0
BEGIN
	IF charindex(',', reverse(@ImagingString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Imaging: ' + STUFF(@ImagingString, len(@ImagingString) - charindex(' ,', reverse(@ImagingString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Imaging: ' + @ImagingString
END


DECLARE @SmokingString varchar(max)


SELECT @SmokingString=
	LTRIM(STUFF((SELECT '  ' +SmokingDescription   AS [text()] 
	FROM ERS_ProcedureSmoking epi 
	WHERE ProcedureId=@ProcedureId
	FOR XML PATH('')),1,1,''))

--SELECT @SmokingString = dbo.fnCapitalise(dbo.fnAddFullStop(@SmokingString)) 

IF LEN(@SmokingString) > 0
BEGIN
	IF charindex(',', reverse(@SmokingString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>Smoking:</b> ' + @SmokingString
		--SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>Smoking:</b> ' + STUFF(@SmokingString, len(@SmokingString) - charindex(' ,', reverse(@SmokingString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>Smoking:</b> ' + @SmokingString
END

DECLARE @LUTSIPSSString varchar(max)
DECLARE @LUTSIPSSTotalScoreString varchar(max)

SELECT @LUTSIPSSString=
	LTRIM(STUFF((SELECT ', ' + SectionName+'(Score:'+cast(ls.ScoreValue as varchar(10)) +')'   AS [text()] 
	from  ERS_ProcedureLUTSIPSSSymptoms a ,ERS_LUTSIPSSSymptoms b,ERS_LUTSIPSSSymptomSections s,ERS_IPSSScore ls
	where ProcedureId=@ProcedureId and a.LUTSIPSSSymptomId=b.UniqueId and b.LUTSIPSSSymptomSectionId=s.LUTSIPSSSymptomSectionId and SelectedScoreId>1 and a.SelectedScoreId=ls.ScoreId
	FOR XML PATH('')),1,1,''))

--SELECT @LUTSIPSSString = dbo.fnCapitalise(dbo.fnAddFullStop(@LUTSIPSSString)) 

select top 1  @LUTSIPSSTotalScoreString =  'Total Score :' + cast(TotalScoreValue as varchar(10)) 
from  ERS_ProcedureLUTSIPSSSymptoms where ProcedureId=@ProcedureId
IF LEN(@LUTSIPSSString) > 0
BEGIN
	IF charindex(',', reverse(@LUTSIPSSString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>LUTS\IPSS symptom score:</b>' + STUFF(@LUTSIPSSString, len(@LUTSIPSSString) - charindex(' ,', reverse(@LUTSIPSSString)), 2,  ' ' + @LUTSIPSSTotalScoreString + ' '+'<br />')
	     
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>LUTS\IPSS symptom score:</b> ' + @LUTSIPSSString

	--SELECT @RetVal = ISNULL(@RetVal + '<br />', '') +  @LUTSIPSSTotalScoreString
END

DECLARE @PreviousDiseaseUrologyString varchar(max)

SELECT @PreviousDiseaseUrologyString=
	LTRIM(STUFF((SELECT ', ' +case 
       when a.Description='Other' then b.AdditionalInformation
	   else a.Description
	  end
   AS [text()] 
	from ERS_PreviousDiseasesUrology a, ERS_ProcedurePreviousDiseasesUrology b 
	where a.UniqueId=b.PreviousDiseaseId
	and b.ProcedureId=@ProcedureId
	order by PreviousDiseaseSectionId
	FOR XML PATH('')),1,1,''))

--SELECT @PreviousDiseaseUrologyString = dbo.fnCapitalise(dbo.fnAddFullStop(@PreviousDiseaseUrologyString)) 


IF LEN(@PreviousDiseaseUrologyString) > 0
BEGIN
	IF charindex(',', reverse(@PreviousDiseaseUrologyString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>Past Urological Histrory:</b>' + STUFF(@PreviousDiseaseUrologyString, len(@PreviousDiseaseUrologyString) - charindex(' ,', reverse(@PreviousDiseaseUrologyString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>Past Urological Histrory:</b> ' + @PreviousDiseaseUrologyString

	
END

DECLARE @UrineDipstickCytologyString varchar(max)

SELECT @UrineDipstickCytologyString=
	LTRIM(STUFF((SELECT ', ' + b.Description + ' '+c.Description 
   AS [text()] 
	from ERS_ProcedureUrineDipstickCytology a,ERS_UrineDipstickCytology b,ERS_UrineDipstickCytology c
	where a.ProcedureId=@ProcedureId
	and a.UrineDipstickCytologyId=b.UniqueId
	and a.ChildUrineDipstickCytologyId=c.UniqueId
	order by b.UrineDipstickCytologySectionId,b.ListOrderBy
	FOR XML PATH('')),1,1,''))

--SELECT @UrineDipstickCytologyString = dbo.fnCapitalise(dbo.fnAddFullStop(@UrineDipstickCytologyString)) 


IF LEN(@UrineDipstickCytologyString) > 0
BEGIN
	IF charindex(',', reverse(@UrineDipstickCytologyString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>Urine Dipstick And Cytology:</b>' + STUFF(@UrineDipstickCytologyString, len(@UrineDipstickCytologyString) - charindex(' ,', reverse(@UrineDipstickCytologyString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>Urine Dipstick And Cytology:<b>' + @UrineDipstickCytologyString

	
END


--------------Broncs referral data
DECLARE @BroncoReferralDataString varchar(max), @DateBronchRequested DATETIME,
		@DateOfReferral DATETIME,
		@LCaSuspectedBySpecialist BIT,
		@CTScanAvailable BIT,
		@DateOfScan DATETIME

	SELECT @DateBronchRequested=DateBronchRequested,
		   @DateOfReferral=DateOfReferral,
		   @LCaSuspectedBySpecialist=LCaSuspectedBySpecialist,
		   @CTScanAvailable=CTScanAvailable
	FROM ERS_ProcedureBronchoReferralData
	WHERE ProcedureId = @ProcedureId

	IF @DateBronchRequested IS NOT NULL SET @BroncoReferralDataString  = ISNULL(@BroncoReferralDataString,'') + 'Date bronchoscopy requested ' + CONVERT(VARCHAR, @DateBronchRequested, 105) + '. '
	IF @DateOfReferral IS NOT NULL SET @BroncoReferralDataString  = ISNULL(@BroncoReferralDataString,'') + 'Date of referral ' + CONVERT(VARCHAR, @DateOfReferral, 105) + '. '
	IF @LCaSuspectedBySpecialist = 1 SET @BroncoReferralDataString  = ISNULL(@BroncoReferralDataString,'') + 'Lung Ca suspected by lung Ca specialist' + '. '
	IF @CTScanAvailable = 1 SET @BroncoReferralDataString  = ISNULL(@BroncoReferralDataString,'') + 'CT scan available prior to bronchoscopy' + '. '
	IF @DateOfScan IS NOT NULL SET @BroncoReferralDataString  = ISNULL(@BroncoReferralDataString,'') + 'Date of scan ' + CONVERT(VARCHAR, @DateOfScan, 105) + '. '
	

	IF @BroncoReferralDataString IS NOT NULL SET @BroncoReferralDataString = 'Referal Data (' + RTRIM(@BroncoReferralDataString )+ ')'
	ELSE SET @BroncoReferralDataString = ''
	
	IF LEN(@BroncoReferralDataString) > 0
	BEGIN
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + @BroncoReferralDataString
	END


RETURN @RetVal
END

GO



------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Mahfuz	On 09 Feb 2024
-- TFS#	Spreadsheet Item 57
-- Description of change
-- No tfs - V10 release spreadsheet - Displaying details of specimens taken with each biopsy sites
------------------------------------------------------------------------------------------------------------------------
Go

EXEC DropIfExist 'specimens_ogd_summary_update','S';
GO
CREATE PROCEDURE [dbo].[specimens_ogd_summary_update]
(
	@SiteId INT
)
/*
	Update History		:		
						:	09 Feb 2024		MH	added Biopsy sites details for Specimens taken
*/
AS
	SET NOCOUNT ON

	DECLARE 
		@summary VARCHAR (8000),
		@tempsummary VARCHAR(1000),
		@RegionId INT,
		@None BIT,
		@BrushCytology BIT,
		@Biopsy BIT,
		@BiopsiesTakenAtRandom BIT,
		@BiopsiesTakenAtSites BIT,
		@BiopsyQtyHistology INT,
		@BiopsyQtyMicrobiology INT,
		@BiopsyQtyVirology INT,
		@ForcepType SMALLINT,
		@ForcepSerialNo NVARCHAR(50),
		--@ForcepSerialNoDesc VARCHAR(100),
		@Urease BIT,
		@UreaseResult TINYINT,
		@Polypectomy BIT,
		@PolypectomyQty INT,
		@HotBiopsy BIT,
		@NeedleAspirate BIT,	
		@NeedleAspirateHistology BIT,
		@NeedleAspirateMicrobiology BIT, 
		@NeedleAspirateVirology BIT,
		@GastricWashing BIT,
		@Bile_PanJuice BIT,
		@Bile_PanJuiceCytology BIT,
		@Bile_PanJuiceBacteriology BIT,
		@Bile_PanJuiceAnalysis BIT,
		@EUSFNANumberOfPasses INT,
		@EUSFNANeedleGauge INT,
		@FNB BIT,
		@EUSFNBNumberOfPasses INT,
		@EUSFNBNeedleGauge INT,
		@BrushBiopsy BIT,
		@TumourMarkers BIT,
		@AmylaseLipase BIT,
		@CytologyHistology BIT,
		@FullStop VARCHAR(5) = '. ',
		@FNAAssessedAtProc BIT,
		@FNBAssessedAtProc BIT,
		@AdequateFNA BIT,
		@AdequateFNB BIt,
		@NeedleBiopsyHistology BIT,
		@NeedleBiopsyCytology BIT,	
		@NeedleBiopsyMicrobiology BIT,
		@NeedleBiopsyVirology BIT
		,@SpecimensBiopsySitesDetails varchar(max)

	SELECT 
		@summary = '',
		@RegionId = s.RegionId,
		@None=[None],
		@BrushCytology=BrushCytology,
		@Biopsy=Biopsy,
		@BiopsiesTakenAtRandom=BiopsiesTakenAtRandom,
		@BiopsiesTakenAtSites=BiopsiesTakenAtSites,
		@BiopsyQtyHistology=BiopsyQtyHistology,
		@BiopsyQtyMicrobiology=BiopsyQtyMicrobiology,
		@BiopsyQtyVirology=BiopsyQtyVirology,
		@ForcepType = p.ForcepType,
		@ForcepSerialNo = (SELECT isnull(p.ForcepSerialNo, '') as [text()] FOR XML PATH('')),
		--@ForcepSerialNoDesc = l.[ListItemText],
		@Urease=Urease,
		@UreaseResult=UreaseResult,
		@Polypectomy=Polypectomy,
		@PolypectomyQty=PolypectomyQty,
		@HotBiopsy=HotBiopsy,
		@NeedleAspirate=NeedleAspirate,
		@NeedleAspirateHistology=NeedleAspirateHistology,
		@NeedleAspirateMicrobiology=NeedleAspirateMicrobiology,
		@NeedleAspirateVirology=NeedleAspirateVirology,
		@GastricWashing=GastricWashing,
		@Bile_PanJuice = Bile_PanJuice,
		@Bile_PanJuiceCytology = Bile_PanJuiceCytology,
		@Bile_PanJuiceBacteriology = Bile_PanJuiceBacteriology,

		@EUSFNANumberOfPasses = EUSFNANumberOfPasses,
		@EUSFNANeedleGauge = EUSFNANeedleGauge,
		@FNB = FNB,
		@EUSFNBNumberOfPasses = EUSFNBNumberOfPasses,
		@EUSFNBNeedleGauge = EUSFNBNeedleGauge,
		@BrushBiopsy = BrushBiopsy,
		@TumourMarkers = TumourMarkers,
		@AmylaseLipase = AmylaseLipase,
		@CytologyHistology = CytologyHistology,
		@FNAAssessedAtProc = FNASampleAssessedAtProcedure,
		@FNBAssessedAtProc = FNBSampleAssessedAtProcedure,
		@AdequateFNA = AdequateFNA,
		@AdequateFNB = AdequateFNB,
		--@Bile_PanJuiceCytology = Bile_PanJuiceCytology,
		--@Bile_PanJuiceBacteriology = Bile_PanJuiceBacteriology,
		--@Bile_PanJuiceAnalysis = Bile_PanJuiceAnalysis
		@NeedleBiopsyHistology = NeedleBiopsyHistology ,
		@NeedleBiopsyCytology = NeedleBiopsyCytology,	
		@NeedleBiopsyMicrobiology = NeedleBiopsyMicrobiology,
		@NeedleBiopsyVirology = NeedleBiopsyVirology
	FROM
		ERS_UpperGISpecimens sp
	JOIN
		ERS_Sites s ON sp.SiteId = s.SiteId
	JOIN
		ERS_Procedures p ON s.ProcedureId = p.ProcedureId
	--LEFT OUTER JOIN
	--	ERS_Lists l ON p.ForcepSerialNo = l.[ListItemNo] AND l.[ListDescription] = 'Forcep Serial Numbers'
	WHERE 
		sp.SiteId = @SiteId

	
		--MH added on 09 Feb 2024 - Item 57 in V10 release spreadsheet
		Set @SpecimensBiopsySitesDetails = ''
		if exists(Select * from ERS_SiteSpecimens Where SiteId = @SiteId)
		Begin
			SELECT @SpecimensBiopsySitesDetails = isnull(@SpecimensBiopsySitesDetails, '') + (SELECT STUFF((
																					SELECT ',' + BS.Description + ' at ' + cast(Distance as varchar(5)) + ' cm, ' + cast(Qty as varchar(5)) + ' Qty' 
																					from ERS_SiteSpecimens SS
																					inner join ERS_BiopsySites BS on SS.BiopsySiteId =BS.UniqueId
																					Where SiteId = @SiteId
																					FOR XML PATH('')), 1, 1, '') Code )
		End	


	IF @None = 1
		SET @summary = @summary + 'No specimens taken'
	ELSE
	BEGIN

		IF @AmylaseLipase = 1 
		BEGIN
			IF @summary <> '' SET @summary = @summary + @FullStop
			SET @summary = @summary + 'Amylase and lipase'
		END

		IF @Bile_PanJuice = 1
		BEGIN
			DECLARE @BileTxt VARCHAR(30) = 'Bile'

			IF (SELECT 1 FROM ERS_Regions WHERE RegionId = @RegionId AND 
				Region IN ('Uncinate Process', 'Head', 'Neck', 'Body', 'Tail', 'Accessory Pancreatic Duct', 'Main Pancreatic Duct') ) = 1
					SET @BileTxt = 'Pancreatic juice'
		
			IF @Bile_PanJuiceBacteriology = 1 OR @Bile_PanJuiceCytology = 1 
			BEGIN
				SET @tempsummary = ''
				IF @Bile_PanJuiceCytology = 1
					SET @tempsummary = @tempsummary + 'cytology'
				IF @Bile_PanJuiceBacteriology = 1 
						IF @tempsummary = '' SET @tempsummary = 'microbiology'
						ELSE SET @tempsummary = @tempsummary + ', microbiology'
				SET @BileTxt = 	@BileTxt + ' (' + @tempsummary + ')'
			END
			IF @summary <> '' SET @summary = @summary + @FullStop
			SET @summary = @summary + @BileTxt
		END

		IF @Biopsy = 1 
		BEGIN
			IF @summary <> '' SET @summary = @summary + @FullStop
			SET @summary = @summary + 'Biopsy'

			IF @BiopsyQtyHistology > 0 OR @BiopsyQtyMicrobiology > 0 OR @BiopsyQtyVirology > 0
			BEGIN
				SET @tempsummary = ''
				IF @BiopsiesTakenAtRandom = 1
				BEGIN
					SET @tempsummary = CONVERT(VARCHAR, ISNULL(@BiopsyQtyHistology,0) + ISNULL(@BiopsyQtyMicrobiology,0) + ISNULL(@BiopsyQtyVirology,0) )
										+ ' x random'
				END
				ELSE IF @BiopsiesTakenAtSites = 1
				BEGIN
					DECLARE @TotalProtocolSites int = (SELECT COUNT(*) FROM dbo.ERS_SiteSpecimens ess WHERE SiteId = @SiteId AND ProtocolSiteId IS NOT NULL)
					DECLARE @BXTotal int = (SELECT COUNT(Qty) FROM ERS_SiteSpecimens WHERE SiteId = @SiteId)
					SET @tempsummary = CONVERT(VARCHAR, ISNULL(@BiopsyQtyHistology,0) + ISNULL(@BiopsyQtyMicrobiology,0) + ISNULL(@BiopsyQtyVirology,0) )
										+ ' taken ' + CASE WHEN ISNULL(@TotalProtocolSites, 0) > 0 THEN 'using Sydney Protocol ' ELSE '' END + 'from multiple sites'
				END
				ELSE
				BEGIN
					IF @BiopsyQtyHistology > 0 SET @tempsummary = CONVERT(VARCHAR(10), @BiopsyQtyHistology) + ' to histology'
					IF @BiopsyQtyMicrobiology > 0
					BEGIN
						IF @tempsummary <> '' SET @tempsummary = @tempsummary + ', ' + CONVERT(VARCHAR(10), @BiopsyQtyMicrobiology) + ' to microbiology'
						ELSE SET @tempsummary = CONVERT(VARCHAR(10), @BiopsyQtyMicrobiology) + ' to microbiology'
					END
					IF @BiopsyQtyVirology > 0
					BEGIN
						IF @tempsummary <> '' SET @tempsummary = @tempsummary + ', ' + CONVERT(VARCHAR(10), @BiopsyQtyVirology) + ' to virology'
						ELSE SET @tempsummary = CONVERT(VARCHAR(10), @BiopsyQtyVirology) + ' to virology'
					END
				END
				SET @summary = @summary + ' ('
				SET @summary = @summary + @tempsummary
				SET @summary = @summary + ')'
			END
			IF @ForcepType > 0 OR ISNULL(@ForcepSerialNo,'') <> ''
			BEGIN
				IF @ForcepType = 1 
				BEGIN
					SET @summary = @summary + ' with disposable forceps'
					IF ISNULL(@ForcepSerialNo,'') <> '' SET @summary = @summary + ' (serial number: ' + @ForcepSerialNo + ')'
				END
				--ELSE IF @ForcepType = 2 
				--BEGIN
				--	SET @summary = @summary + ' (Forceps - Reusable'
				--	IF @ForcepSerialNo > 0 SET @summary = @summary + ', Serial No: ' + @ForcepSerialNoDesc
				--	SET @summary = @summary + ')'
				--END
			END

		END
		
		IF @BrushCytology = 1 
		BEGIN
			IF @summary <> '' SET @summary = @summary + @FullStop
			SET @summary = @summary + 'Brush cytology'
		END

		IF @BrushBiopsy = 1 
		BEGIN
			IF @summary <> '' SET @summary = @summary + @FullStop
			SET @summary = @summary + 'Brush biopsy'
		END

		IF @CytologyHistology = 1 
		BEGIN
			IF @summary <> '' SET @summary = @summary + @FullStop
			SET @summary = @summary + 'Cytology and histology'
		END

		--FNA
		IF @NeedleAspirate = 1 
		BEGIN
			IF @summary <> '' SET @summary = @summary + @FullStop
			SET @summary = @summary + 'Fine needle aspirate'
			
			IF @NeedleAspirateHistology = 1 OR @NeedleAspirateMicrobiology = 1 OR @NeedleAspirateVirology = 1
			BEGIN
				IF @NeedleAspirateHistology = 1 OR @NeedleAspirateMicrobiology = 1 OR @NeedleAspirateVirology = 1
				BEGIN
					SET @tempsummary = ''
					IF @NeedleAspirateHistology = 1 
						SET @tempsummary = @tempsummary + 'cytology'
					IF @NeedleAspirateMicrobiology = 1 
						IF @tempsummary = '' SET @tempsummary = @tempsummary + 'microbiology'
						ELSE SET @tempsummary = @tempsummary + ', microbiology'
					IF @NeedleAspirateVirology = 1 
						IF @tempsummary = '' SET @tempsummary = @tempsummary + 'virology'
						ELSE SET @tempsummary = @tempsummary + ', virology'
					SET @summary = @summary + ' (' + @tempsummary + ')'
				END
			END

			IF @EUSFNANumberOfPasses > 0 SET @summary = @summary + ' (' + CONVERT(VARCHAR(10), @EUSFNANumberOfPasses) + CASE WHEN @EUSFNANumberOfPasses > 1 THEN ' passes' ELSE ' pass' END
			IF @EUSFNANeedleGauge > 0 
			BEGIN
				IF @EUSFNANumberOfPasses > 0 SET @summary = @summary + ' with ' ELSE SET @summary = @summary + ' (with '
				SET @summary = @summary + CONVERT(VARCHAR(10), @EUSFNANeedleGauge) + ' needle gauge)'
			END
			ELSE
				IF @EUSFNANumberOfPasses > 0 SET @summary = @summary + ')'

			IF @FNAAssessedAtProc = 1
				SET @summary = @summary + ' - assessed at procedure'

			IF @AdequateFNA = 1
				SET @Summary = @Summary + ' - adeqate sample retreived '
		END

		--FNB
		IF @FNB = 1 
		BEGIN
			IF @summary <> '' SET @summary = @summary + @FullStop
			SET @summary = @summary + 'Fine needle biopsy'

			IF @NeedleBiopsyHistology = 1 OR @NeedleBiopsyMicrobiology = 1 OR @NeedleBiopsyVirology = 1
			BEGIN
				IF @NeedleBiopsyHistology = 1 OR @NeedleBiopsyMicrobiology = 1 OR @NeedleBiopsyVirology = 1
				BEGIN
					SET @tempsummary = ''
					IF @NeedleBiopsyHistology = 1 
						SET @tempsummary = 'histology'
					IF @NeedleBiopsyCytology = 1 														
						IF @tempsummary = '' SET @tempsummary = @tempsummary + 'cytology'
						ELSE SET @tempsummary = @tempsummary + ', cytology'
					IF @NeedleBiopsyMicrobiology = 1 
						IF @tempsummary = '' SET @tempsummary = @tempsummary + 'microbiology'
						ELSE SET @tempsummary = @tempsummary + ', microbiology'
					IF @NeedleBiopsyVirology = 1 
						IF @tempsummary = '' SET @tempsummary = @tempsummary + 'virology'
						ELSE SET @tempsummary = @tempsummary + ', virology'
					SET @summary = @summary + ' (' + @tempsummary + ')'
				END
			END

			IF @EUSFNBNumberOfPasses > 0 SET @summary = @summary + ' (' + CONVERT(VARCHAR(10), @EUSFNBNumberOfPasses) + CASE WHEN @EUSFNBNumberOfPasses > 1 THEN ' passes' ELSE ' pass' END
			IF @EUSFNBNeedleGauge > 0 
			BEGIN
				IF @EUSFNBNumberOfPasses > 0 SET @summary = @summary + ' with ' ELSE SET @summary = @summary + ' (with '
				SET @summary = @summary + CONVERT(VARCHAR(10), @EUSFNBNeedleGauge) + ' needle gauge)'
			END
			ELSE
				IF @EUSFNBNumberOfPasses > 0 SET @summary = @summary + ')'

			IF @FNBAssessedAtProc = 1
				SET @summary = @summary + ' - assessed at procedure'

			IF @AdequateFNB = 1
				SET @Summary = @Summary + ' - adeqate sample retreived '
		END

		IF @GastricWashing = 1 
		BEGIN
			IF @summary <> '' SET @summary = @summary + @FullStop
			SET @summary = @summary + 'Gastric Washing'
		END

		IF @HotBiopsy = 1 
		BEGIN
			IF @summary <> '' SET @summary = @summary + @FullStop
			SET @summary = @summary + 'Hot biopsy'
		END
		
		IF @Polypectomy = 1 
		BEGIN
			IF @summary <> '' SET @summary = @summary + @FullStop
			SET @summary = @summary + 'Polypectomy'
			
			IF @PolypectomyQty > 0 
			BEGIN
				SET @summary = @summary + ' (' + CONVERT(VARCHAR(10), @PolypectomyQty) + CASE WHEN @PolypectomyQty > 1 THEN ' biopsies' ELSE ' biopsy' END

				if exists(Select 1 from ERS_UpperGITherapeutics where SiteId = @SiteId and PolypectomyRemovalType in (1,2,3,4,5,6,7))
				BEGIN
					SELECT @summary = @summary + CASE PolypectomyRemovalType 
											WHEN 1 THEN ' by partial Snare'
											WHEN 2 THEN ' by cold snare'
											WHEN 3 THEN ' by hot snare cauterisation'
											WHEN 4 THEN ' by hot biopsy'
											WHEN 5 THEN ' by cold biopsy'
											WHEN 6 THEN ' by hot snare by EMR'
											WHEN 7 THEN ' by cold snare by EMR'
										END
					FROM ERS_UpperGITherapeutics where SiteId = @SiteId
				END
				SET @summary = @summary + ')'
			END
		END
		
		IF @TumourMarkers = 1 
		BEGIN
			IF @summary <> '' SET @summary = @summary + @FullStop
			SET @summary = @summary + 'Tumour markers'
		END

		IF @Urease = 1 
		BEGIN
			IF @summary <> '' SET @summary = @summary + @FullStop

			IF @UreaseResult = 1 SET @summary = @summary + 'Positive urease test for H. pylori'
			ELSE IF @UreaseResult = 2 SET @summary = @summary + 'Urease test for H. pylori proved negative'
			ELSE  SET @summary = @summary + 'Urease test'
		END
	END

	--MH Added on 09 Feb 2024
	if(IsNull(@SpecimensBiopsySitesDetails,'') <> '')
	Begin
		Set @summary = @summary + ', - Biopsy sites: ' + @SpecimensBiopsySitesDetails
	End
	

	-- Finally, update the summary in specimens table
	UPDATE ERS_UpperGISpecimens 
	SET Summary=@summary 
	WHERE SiteId = @SiteId

-------------------------------------------------------------------------------------------------------
Go
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	Spreadsheet Item 57 by Mahfuz
------------------------------------------------------------------------------------------------------------------------
Go

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea
-- TFS#	Support Ticket 11190
-- Description of change
-- Change smallint to int
------------------------------------------------------------------------------------------------------------------------
GO

BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
--ALTER TABLE dbo.ERS_PatientMedication
--	DROP CONSTRAINT DF__ERS_Patie__WhoUp__20389C96
--GO
--ALTER TABLE dbo.ERS_PatientMedication
--	DROP CONSTRAINT DF__ERS_Patie__WhoCr__23150941
--GO
--ALTER TABLE dbo.ERS_PatientMedication
--	DROP CONSTRAINT DF__ERS_Patie__WhenC__212CC0CF
--GO
--ALTER TABLE dbo.ERS_PatientMedication
--	DROP CONSTRAINT DF__ERS_Patie__WhenU__2220E508
--GO
CREATE TABLE dbo.Tmp_ERS_PatientMedication
	(
	PatientMedicationID int NOT NULL IDENTITY (1, 1),
	ProcedureNo int NOT NULL,
	DrugCount int NOT NULL,
	DrugNo smallint NULL,
	DrugDose real NULL,
	Frequency varchar(50) NULL,
	Duration varchar(50) NULL,
	HPyloriDrug smallint NULL,
	WhoPrescribed nvarchar(1) NULL,
	AuthenticationDate datetime NULL,
	AuthenticatedBy nvarchar(50) NULL,
	WhoUpdatedId int NULL,
	WhoCreatedId int NULL,
	WhenCreated datetime NULL,
	WhenUpdated datetime NULL,
	PrescriptionText varchar(MAX) NULL
	)  ON [PRIMARY]
	 TEXTIMAGE_ON [PRIMARY]
GO
--ALTER TABLE dbo.Tmp_ERS_PatientMedication SET (LOCK_ESCALATION = TABLE)
--GO
--ALTER TABLE dbo.Tmp_ERS_PatientMedication ADD CONSTRAINT
--	DF__ERS_Patie__WhoUp__20389C96 DEFAULT ((0)) FOR WhoUpdatedId
--GO
--ALTER TABLE dbo.Tmp_ERS_PatientMedication ADD CONSTRAINT
--	DF__ERS_Patie__WhoCr__23150941 DEFAULT ((0)) FOR WhoCreatedId
--GO
--ALTER TABLE dbo.Tmp_ERS_PatientMedication ADD CONSTRAINT
--	DF__ERS_Patie__WhenC__212CC0CF DEFAULT (getdate()) FOR WhenCreated
--GO
--ALTER TABLE dbo.Tmp_ERS_PatientMedication ADD CONSTRAINT
--	DF__ERS_Patie__WhenU__2220E508 DEFAULT (getdate()) FOR WhenUpdated
--GO
SET IDENTITY_INSERT dbo.Tmp_ERS_PatientMedication ON
GO
IF EXISTS(SELECT * FROM dbo.ERS_PatientMedication)
	 EXEC('INSERT INTO dbo.Tmp_ERS_PatientMedication (PatientMedicationID, ProcedureNo, DrugCount, DrugNo, DrugDose, Frequency, Duration, HPyloriDrug, WhoPrescribed, AuthenticationDate, AuthenticatedBy, WhoUpdatedId, WhoCreatedId, WhenCreated, WhenUpdated, PrescriptionText)
		SELECT PatientMedicationID, CONVERT(int, ProcedureNo), CONVERT(int, DrugCount), DrugNo, DrugDose, Frequency, Duration, HPyloriDrug, WhoPrescribed, AuthenticationDate, AuthenticatedBy, WhoUpdatedId, WhoCreatedId, WhenCreated, WhenUpdated, PrescriptionText FROM dbo.ERS_PatientMedication WITH (HOLDLOCK TABLOCKX)')
GO
SET IDENTITY_INSERT dbo.Tmp_ERS_PatientMedication OFF
GO
DROP TABLE dbo.ERS_PatientMedication
GO
EXECUTE sp_rename N'dbo.Tmp_ERS_PatientMedication', N'ERS_PatientMedication', 'OBJECT' 
GO
ALTER TABLE dbo.ERS_PatientMedication ADD CONSTRAINT
	pk_ERS_PatientMedication PRIMARY KEY CLUSTERED 
	(
	PatientMedicationID,
	ProcedureNo,
	DrugCount
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]

GO
CREATE TRIGGER [dbo].[trg_ERS_PatientMedication_Delete] 
							ON dbo.ERS_PatientMedication 
							AFTER DELETE
						AS 
							SET NOCOUNT ON; 
							INSERT INTO [ERSAudit].[ERS_PatientMedication_Audit] (ProcedureNo, tbl.[PatientMedicationID], tbl.[DrugCount], tbl.[DrugNo], tbl.[DrugDose], tbl.[Frequency], tbl.[Duration], tbl.[HPyloriDrug], tbl.[WhoPrescribed], tbl.[AuthenticationDate], tbl.[AuthenticatedBy],  LastActionId, ActionDateTime, ActionUserId)
							SELECT tbl.ProcedureNo , tbl.[PatientMedicationID], tbl.[DrugCount], tbl.[DrugNo], tbl.[DrugDose], tbl.[Frequency], tbl.[Duration], tbl.[HPyloriDrug], tbl.[WhoPrescribed], tbl.[AuthenticationDate], tbl.[AuthenticatedBy],  3, GETDATE(), tbl.WhoUpdatedId
							FROM deleted tbl
GO
CREATE TRIGGER [dbo].[trg_ERS_PatientMedication_Insert] 
							ON dbo.ERS_PatientMedication 
							AFTER INSERT
						AS 
							SET NOCOUNT ON; 
							INSERT INTO [ERSAudit].[ERS_PatientMedication_Audit] (ProcedureNo, tbl.[PatientMedicationID], tbl.[DrugCount], tbl.[DrugNo], tbl.[DrugDose], tbl.[Frequency], tbl.[Duration], tbl.[HPyloriDrug], tbl.[WhoPrescribed], tbl.[AuthenticationDate], tbl.[AuthenticatedBy],  LastActionId, ActionDateTime, ActionUserId)
							SELECT tbl.ProcedureNo , tbl.[PatientMedicationID], tbl.[DrugCount], tbl.[DrugNo], tbl.[DrugDose], tbl.[Frequency], tbl.[Duration], tbl.[HPyloriDrug], tbl.[WhoPrescribed], tbl.[AuthenticationDate], tbl.[AuthenticatedBy],  1, GETDATE(), tbl.WhoCreatedId
							FROM inserted tbl
GO
CREATE TRIGGER [dbo].[trg_ERS_PatientMedication_Update] 
							ON dbo.ERS_PatientMedication 
							AFTER UPDATE
						AS 
							SET NOCOUNT ON; 
							INSERT INTO [ERSAudit].[ERS_PatientMedication_Audit] (ProcedureNo, tbl.[PatientMedicationID], tbl.[DrugCount], tbl.[DrugNo], tbl.[DrugDose], tbl.[Frequency], tbl.[Duration], tbl.[HPyloriDrug], tbl.[WhoPrescribed], tbl.[AuthenticationDate], tbl.[AuthenticatedBy],  LastActionId, ActionDateTime, ActionUserId)
							SELECT tbl.ProcedureNo , tbl.[PatientMedicationID], tbl.[DrugCount], tbl.[DrugNo], tbl.[DrugDose], tbl.[Frequency], tbl.[Duration], tbl.[HPyloriDrug], tbl.[WhoPrescribed], tbl.[AuthenticationDate], tbl.[AuthenticatedBy],  2, GETDATE(), i.WhoUpdatedId
							FROM deleted tbl INNER JOIN inserted i ON tbl.ProcedureNo = i.ProcedureNo
GO
COMMIT
GO

BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
--ALTER TABLE dbo.ERS_DrugRegime
--	DROP CONSTRAINT DF__ERS_DrugR__WhoCr__38AF44A5
--GO
--ALTER TABLE dbo.ERS_DrugRegime
--	DROP CONSTRAINT DF__ERS_DrugR__WhenC__39A368DE
--GO
CREATE TABLE dbo.Tmp_ERS_DrugRegime
	(
	RegimenNo SMALLINT NOT NULL,
	Description NVARCHAR(100) NULL,
	ProcedureNo INT NULL,
	DrugNo INT NOT NULL,
	DrugDose REAL NULL,
	Frequency VARCHAR(50) NULL,
	Duration VARCHAR(50) NULL,
	DrugCount SMALLINT NOT NULL,
	RegimeText VARCHAR(1000) NULL,
	WhoUpdatedId INT NULL,
	WhoCreatedId INT NULL,
	WhenCreated DATETIME NULL,
	WhenUpdated DATETIME NULL
	)  ON [PRIMARY]
GO
ALTER TABLE dbo.Tmp_ERS_DrugRegime SET (LOCK_ESCALATION = TABLE)
GO
--ALTER TABLE dbo.Tmp_ERS_DrugRegime ADD CONSTRAINT
--	DF__ERS_DrugR__WhoCr__38AF44A5 DEFAULT ((0)) FOR WhoCreatedId
--GO
--ALTER TABLE dbo.Tmp_ERS_DrugRegime ADD CONSTRAINT
--	DF__ERS_DrugR__WhenC__39A368DE DEFAULT (getdate()) FOR WhenCreated
--GO
IF EXISTS(SELECT * FROM dbo.ERS_DrugRegime)
	 EXEC('INSERT INTO dbo.Tmp_ERS_DrugRegime (RegimenNo, Description, ProcedureNo, DrugNo, DrugDose, Frequency, Duration, DrugCount, RegimeText, WhoUpdatedId, WhoCreatedId, WhenCreated, WhenUpdated)
		SELECT RegimenNo, Description, CONVERT(int, ProcedureNo), CONVERT(int, DrugNo), DrugDose, Frequency, Duration, DrugCount, RegimeText, WhoUpdatedId, WhoCreatedId, WhenCreated, WhenUpdated FROM dbo.ERS_DrugRegime WITH (HOLDLOCK TABLOCKX)')
GO
DROP TABLE dbo.ERS_DrugRegime
GO
EXECUTE sp_rename N'dbo.Tmp_ERS_DrugRegime', N'ERS_DrugRegime', 'OBJECT' 
GO
ALTER TABLE dbo.ERS_DrugRegime ADD CONSTRAINT
	PK_Drug_Regimen PRIMARY KEY CLUSTERED 
	(
	RegimenNo,
	DrugNo,
	DrugCount
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]

GO
CREATE TRIGGER [dbo].[trg_ERS_DrugRegime_Delete] 
							ON dbo.ERS_DrugRegime 
							AFTER DELETE
						AS 
							SET NOCOUNT ON; 
							INSERT INTO [ERSAudit].[ERS_DrugRegime_Audit] (RegimenNo, tbl.[Description], tbl.[ProcedureNo], tbl.[DrugNo], tbl.[DrugDose], tbl.[Frequency], tbl.[Duration], tbl.[DrugCount], tbl.[RegimeText],  LastActionId, ActionDateTime, ActionUserId)
							SELECT tbl.RegimenNo , tbl.[Description], tbl.[ProcedureNo], tbl.[DrugNo], tbl.[DrugDose], tbl.[Frequency], tbl.[Duration], tbl.[DrugCount], tbl.[RegimeText],  3, GETDATE(), tbl.WhoUpdatedId
							FROM deleted tbl
GO
CREATE TRIGGER [dbo].[trg_ERS_DrugRegime_Insert] 
							ON dbo.ERS_DrugRegime 
							AFTER INSERT
						AS 
							SET NOCOUNT ON; 
							INSERT INTO [ERSAudit].[ERS_DrugRegime_Audit] (RegimenNo, tbl.[Description], tbl.[ProcedureNo], tbl.[DrugNo], tbl.[DrugDose], tbl.[Frequency], tbl.[Duration], tbl.[DrugCount], tbl.[RegimeText],  LastActionId, ActionDateTime, ActionUserId)
							SELECT tbl.RegimenNo , tbl.[Description], tbl.[ProcedureNo], tbl.[DrugNo], tbl.[DrugDose], tbl.[Frequency], tbl.[Duration], tbl.[DrugCount], tbl.[RegimeText],  1, GETDATE(), tbl.WhoCreatedId
							FROM inserted tbl
GO
CREATE TRIGGER [dbo].[trg_ERS_DrugRegime_Update] 
							ON dbo.ERS_DrugRegime 
							AFTER UPDATE
						AS 
							SET NOCOUNT ON; 
							INSERT INTO [ERSAudit].[ERS_DrugRegime_Audit] (RegimenNo, tbl.[Description], tbl.[ProcedureNo], tbl.[DrugNo], tbl.[DrugDose], tbl.[Frequency], tbl.[Duration], tbl.[DrugCount], tbl.[RegimeText],  LastActionId, ActionDateTime, ActionUserId)
							SELECT tbl.RegimenNo , tbl.[Description], tbl.[ProcedureNo], tbl.[DrugNo], tbl.[DrugDose], tbl.[Frequency], tbl.[Duration], tbl.[DrugCount], tbl.[RegimeText],  2, GETDATE(), i.WhoUpdatedId
							FROM deleted tbl INNER JOIN inserted i ON tbl.RegimenNo = i.RegimenNo
GO
COMMIT
GO

BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE ERSAudit.ERS_DrugRegime_Audit
	DROP CONSTRAINT FK_ERS_DrugRegime_Audit_tblAuditActions
GO
ALTER TABLE ERSAudit.tblAuditActions SET (LOCK_ESCALATION = TABLE)
GO
COMMIT
BEGIN TRANSACTION
GO
CREATE TABLE ERSAudit.Tmp_ERS_DrugRegime_Audit
	(
	AuditedRecordUniqueId int NOT NULL IDENTITY (1, 1),
	RegimenNo int NOT NULL,
	Description nvarchar(100) NULL,
	ProcedureNo int NULL,
	DrugNo int NULL,
	DrugDose real NULL,
	Frequency varchar(50) NULL,
	Duration varchar(50) NULL,
	DrugCount smallint NULL,
	RegimeText varchar(1000) NULL,
	LastActionId int NOT NULL,
	ActionUserId int NULL,
	ActionDateTime datetime NULL
	)  ON [PRIMARY]
GO
ALTER TABLE ERSAudit.Tmp_ERS_DrugRegime_Audit SET (LOCK_ESCALATION = TABLE)
GO
SET IDENTITY_INSERT ERSAudit.Tmp_ERS_DrugRegime_Audit ON
GO
IF EXISTS(SELECT * FROM ERSAudit.ERS_DrugRegime_Audit)
	 EXEC('INSERT INTO ERSAudit.Tmp_ERS_DrugRegime_Audit (AuditedRecordUniqueId, RegimenNo, Description, ProcedureNo, DrugNo, DrugDose, Frequency, Duration, DrugCount, RegimeText, LastActionId, ActionUserId, ActionDateTime)
		SELECT AuditedRecordUniqueId, RegimenNo, Description, CONVERT(int, ProcedureNo), CONVERT(int, DrugNo), DrugDose, Frequency, Duration, DrugCount, RegimeText, LastActionId, ActionUserId, ActionDateTime FROM ERSAudit.ERS_DrugRegime_Audit WITH (HOLDLOCK TABLOCKX)')
GO
SET IDENTITY_INSERT ERSAudit.Tmp_ERS_DrugRegime_Audit OFF
GO
DROP TABLE ERSAudit.ERS_DrugRegime_Audit
GO
EXECUTE sp_rename N'ERSAudit.Tmp_ERS_DrugRegime_Audit', N'ERS_DrugRegime_Audit', 'OBJECT' 
GO
ALTER TABLE ERSAudit.ERS_DrugRegime_Audit ADD CONSTRAINT
	PK_ERS_DrugRegime_Audit PRIMARY KEY CLUSTERED 
	(
	AuditedRecordUniqueId
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]

GO
ALTER TABLE ERSAudit.ERS_DrugRegime_Audit ADD CONSTRAINT
	FK_ERS_DrugRegime_Audit_tblAuditActions FOREIGN KEY
	(
	LastActionId
	) REFERENCES ERSAudit.tblAuditActions
	(
	UniqueId
	) ON UPDATE  NO ACTION 
	 ON DELETE  NO ACTION 
	
GO
COMMIT
GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 13.2.24
-- TFS#	Spreadsheet item 14
-- Description of change
-- Blocked slot is now treated as an appointment
------------------------------------------------------------------------------------------------------------------------
GO

ALTER TABLE ERS_Appointments ALTER COLUMN PatientId INT NULL
GO


IF NOT EXISTS (SELECT 1 FROM dbo.ERS_AppointmentStatus WHERE Description = 'Blocked Slot')
BEGIN
	INSERT INTO dbo.ERS_AppointmentStatus
	(
	    Description,
	    HDCKEY,
	    RequiredLetter
	)
	VALUES
	(   N'Blocked Slot',     -- Description - nvarchar(255)
	    'BS',    -- HDCKEY - varchar(5)
	    0  -- RequiredLetter - bit
	    )
END
GO

SET QUOTED_IDENTIFIER ON
SET ANSI_NULLS ON
GO
ALTER PROCEDURE [dbo].[sch_lock_list_slot]
(
	@ListSlotId INT,
	@Lock BIT,
	@ReasonId INT,
	@ReasonText VARCHAR(MAX),
	@SlotStart AS DATETIME,
	@SlotEnd AS DATETIME,
	@LoggedInUserId INT
)
AS
BEGIN
	UPDATE ERS_SCH_ListSlots
	SET Locked = @Lock
	WHERE ListSlotId = @ListSlotId

	IF NOT EXISTS (SELECT 1 FROM ERS_SCH_LockedSlots WHERE ListSlotId = @ListSlotId)
	BEGIN
		INSERT INTO ERS_SCH_LockedSlots (ListSlotId, Locked, LockedReasonId, LockedReasonText, WhoCreatedId, WhenCreated)
		VALUES (@ListSlotId, @Lock, @ReasonId, @ReasonText, @LoggedInUserId, GETDATE())
	END
	ELSE
	BEGIN
		UPDATE ERS_SCH_LockedSlots 
		SET Locked = @Lock,
			LockedReasonId = CASE WHEN @Lock = 1 THEN @ReasonId ELSE LockedReasonId END,
			LockedReasonText = CASE WHEN @Lock = 1 THEN @ReasonText ELSE LockedReasonText END,
			UnlockedReasonId = CASE WHEN @Lock = 0 THEN @ReasonId ELSE UnlockedReasonId END,
			UnlockedReasonText = CASE WHEN @Lock = 0 THEN @ReasonText ELSE UnlockedReasonText END,
			WhoUpdatedId = @LoggedInUserId,
			WhenUpdated = GETDATE()
		WHERE ListSlotId = @ListSlotId
	END

	DECLARE @AppointmentStatusId INT, @OperatingHospitalId INT, @DiaryId INT, @SlotStatusId INT, @SlotProcedureTypeId INT, @SlotPoints INT, @BlockedSlotAppointmentId INT
	
	--set parameters for appointment
	SELECT @AppointmentStatusId = UniqueId FROM dbo.ERS_AppointmentStatus WHERE Description = 'Blocked Slot'
	SELECT @SlotStatusId = ls.SlotId, @SlotProcedureTypeId = ls.ProcedureTypeId, @SlotPoints = ls.Points, @OperatingHospitalId = ls.OperatingHospitalId, @DiaryId = (SELECT d.DiaryId FROM dbo.ERS_SCH_DiaryPages d WHERE d.ListRulesId = ls.ListRulesId ) FROM dbo.ERS_SCH_ListSlots ls WHERE ls.ListSlotId = @ListSlotId

	IF @Lock = 1
	BEGIN
		--insert blocked slot as an appointment
		IF NOT EXISTS (SELECT 1 FROM dbo.ERS_Appointments WHERE PatientId IS NULL AND DiaryId = @DiaryId AND ListSlotId = @ListSlotId AND AppointmentStatusId = @AppointmentStatusId AND StartDateTime = @SlotStart)
		BEGIN
		    INSERT INTO ERS_Appointments (AppointmentStatusId, PatientId, OperationalHospitaId, DiaryId, SlotStatusID, StartDateTime, AppointmentDuration, StaffEnteredId, DateEntered, BookingTypeId, ListSlotId)
		    VALUES (@AppointmentStatusId, NULL, @OperatingHospitalId, @DiaryId, @SlotStatusId, @SlotStart, DATEDIFF(MINUTE, @SlotStart, @SlotEnd), @LoggedInUserId, GETDATE(), 2, @ListSlotId) 
		    
		    SET @BlockedSlotAppointmentId = SCOPE_IDENTITY()
		    
		    INSERT INTO ERS_AppointmentProcedureTypes (AppointmentID,ProcedureTypeID, Points, Minutes)
		    VALUES (@BlockedSlotAppointmentId, @SlotProcedureTypeId, @SlotPoints, DATEDIFF(MINUTE, @SlotStart, @SlotEnd))
		END
	END
	ELSE
	BEGIN
		SET @BlockedSlotAppointmentId = (SELECT AppointmentId FROM dbo.ERS_Appointments WHERE PatientId IS NULL AND ListSlotId = @ListSlotId AND AppointmentStatusId = @AppointmentStatusId AND StartDateTime = @SlotStart)
		IF @BlockedSlotAppointmentId IS NOT NULL
		BEGIN
			--remove blocked slot as an appointment
			DELETE FROM dbo.ERS_AppointmentProcedureTypes WHERE AppointmentID = @BlockedSlotAppointmentId
			DELETE FROM dbo.ERS_Appointments WHERE AppointmentId = @BlockedSlotAppointmentId
		END
	END
END
GO


SET QUOTED_IDENTIFIER ON
SET ANSI_NULLS ON
GO


ALTER PROCEDURE [dbo].[sch_get_day_diary]
(
	@OperatingHospitalID INT,
	@DiaryDate DATETIME,
	@RoomIds VARCHAR(MAX)
)
AS

	IF OBJECT_ID ('tempdb..#tmpDiaryRooms') IS NOT NULL
		DROP TABLE #tmpDiaryRooms

	SELECT Item
	INTO #tmpDiaryRooms
	FROM dbo.fnSplitString(@RoomIds, ',')

	SELECT DISTINCT
		d.DiaryId,
		d.DiaryStart,
		CASE WHEN (SELECT MAX(DATEADD(MINUTE, CONVERT(int, ersa.AppointmentDuration), StartDateTime)) FROM ERS_Appointments ersa WHERE ersa.DiaryId = d.DiaryId) > d.DiaryEnd THEN (SELECT MAX(DATEADD(MINUTE, CONVERT(int, ersa.AppointmentDuration), StartDateTime)) FROM ERS_Appointments ersa WHERE ersa.DiaryId = d.DiaryId) ELSE d.DiaryEnd END AS DiaryEnd,
		d.[DiaryEnd] ActualDiaryEnd,
		d.[UserID], 
		d.[RoomID], 
		d.ListRulesId, 
		s.SlotMinutes AS [Minutes],
		CASE WHEN ept.ProcedureType IS NULL THEN ss.Description 
		ELSE 'Reserved for ' + ss.Description + ' '+ ept.ProcedureType END AS [Subject],
		ss.Description,
		ISNULL(s.ProcedureTypeID,0) AS ProcedureTypeID,
		s.ListSlotId,
		ss.ForeColor,
		ss.StatusId,
		ISNULL(s.Points, 1) AS Points,
		ISNULL(l.Endoscopist,0) AS EndoscopistId,
		(CASE WHEN  ISNULL(u.Title,'') <> '' THEN u.Title + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(u.Forename,'') <> '' THEN u.Forename + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(u.Surname,'') <> '' THEN u.Surname + ' ' ELSE '' END) as EndoscopistName,
	  (CASE WHEN  ISNULL(c.Title,'') <> '' THEN c.Title + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(c.Forename,'') <> '' THEN c.Forename + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(c.Surname,'') <> '' THEN c.Surname + ' ' ELSE '' END) as ListConsultant,
		l.ListName,
		(CASE WHEN  ISNULL(u.Title,'') <> '' THEN u.Title + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(u.Forename,'') <> '' THEN u.Forename + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(u.Surname,'') <> '' THEN u.Surname + ' ' ELSE '' END) +
	  '  [' + CONVERT(VARCHAR(5),cast(d.DiaryStart as time)) + '-' + CONVERT(VARCHAR(5),cast(d.[DiaryEnd] as time)) + ']' +
	  CASE WHEN  ISNULL(l.Points,0) <> 0 THEN '  [' + CONVERT(VARCHAR, l.Points) + ' slots]' ELSE '' END  AS ListDescription
		,d.suppressed
		,d.SuppressedFromDate
		,d.Training
		,l.GIProcedure
		,ISNULL(apt.AppointmentId, 0) AppointmentId
		,apt.StartDateTime AppointmentStart
		,ISNULL(apt.TotalPoints,0) AppointmentPoints
		,ISNULL(apt.AppointmentDuration,0) AppointmentDuration
		,DATEADD(minute, convert(int, apt.AppointmentDuration), apt.StartDateTime) AppointmentEnd
		,ISNULL(apt.StatusCode,'') AppointmentStatusCode
		,ISNULL(apt.Notes,'') AppointmentNotes
		,p.HospitalNumber + ' - ' + p.Forename1 + ' ' + p.Surname + '<br />' + apt.Description + ' '+ STUFF(REPLACE(apt.Procs, CHAR(10), '+'), LEN(apt.procs),1,'') AS [AppointmentSubject]
		,ISNULL(apt.GeneralInformation, '') GeneralInformation
		,CASE WHEN apt.AppointmentId IS NULL THEN s.Locked ELSE CASE WHEN ISNULL(apt.StatusCode,'') = 'BS' THEN 1 ELSE 0 END END AS Locked
		,d.OperatingHospitalId
		,ISNULL(d.RecurrenceParentID,0)RecurrenceParentID
		,ISNULL(d.locked,0) LockedDiary
		,r.RoomName
	FROM ERS_SCH_DiaryPages d
		INNER JOIN #tmpDiaryRooms tr ON tr.Item = d.RoomID
		INNER JOIN dbo.ERS_SCH_Rooms r ON r.RoomId = tr.Item
		INNER JOIN ERS_SCH_ListRules l ON l.ListRulesId = d.ListRulesId
		INNER JOIN ERS_SCH_ListSlots s ON d.ListRulesId = s.ListRulesId AND s.Active = 1
		INNER JOIN dbo.ERS_SCH_SlotStatus ss ON ss.StatusId = s.SlotId
		LEFT JOIN dbo.ERS_ProcedureTypes ept ON s.ProceduretypeId = ept.ProcedureTypeId
		LEFT JOIN ERS_Users u ON u.UserID = d.UserId
		LEFT JOIN ERS_Users c ON c.UserID = d.ListConsultantId
		LEFT JOIN (SELECT ea.AppointmentId, SUM(eapt.Points) AS TotalPoints, SUM(eapt.Minutes) AS TotalMinutes, ea.ListSlotId, ea.DiaryId, MAX(aps.HDCKEY) StatusCode, ass.Description, ea.PatientId, ea.GeneralInformation, ea.Notes, ea.AppointmentDuration,ea.StartDateTime,
						(SELECT
							AppointmentProcedures + char(10) AS [text()] 
						FROM dbo.SCH_AppointmentProcedures(ea.AppointmentId)
						WHERE AppointmentId = ea.AppointmentId
						FOR XML PATH('')) AS procs
					FROM dbo.ERS_Appointments ea
						INNER JOIN dbo.ERS_AppointmentProcedureTypes eapt ON ea.AppointmentId = eapt.AppointmentID
						INNER JOIN dbo.ERS_SCH_SlotStatus ass ON ea.SlotStatusID = ass.StatusId
						LEFT JOIN ERS_AppointmentStatus aps on aps.UniqueId = ea.AppointmentStatusId
					 WHERE ISNULL(aps.HDCKEY,'') NOT IN ('C')
					GROUP BY ea.AppointmentId, ea.ListSlotId, ea.DiaryId, ass.Description, ea.PatientId,ea.GeneralInformation, ea.Notes, ea.AppointmentDuration,ea.StartDateTime) AS apt 
											ON apt.DiaryId = d.DiaryId and  apt.ListSlotId = s.ListSlotId
		LEFT JOIN ERS_Patients p ON p.patientId = apt.PatientId
	WHERE d.OperatingHospitalId = @OperatingHospitalID AND convert(varchar(10), DiaryStart, 103) = convert(varchar(10), @DiaryDate, 103)
	ORDER BY d.DiaryId, apt.StartDateTime, s.ListSlotId

GO

SET QUOTED_IDENTIFIER ON
SET ANSI_NULLS ON
GO
ALTER PROCEDURE [dbo].[sch_get_diary_appointments]
(
	@DiaryId INT,
	@StartDate datetime
)
AS
SELECT ea.AppointmentId, ed.OperatingHospitalId, CONVERT(VARCHAR(10), ea.StartDateTime, 103), ea.DiaryId, ep.Forename1 + ' ' + ep.Surname AS PatientName, ea.StartDateTime, DATEADD(minute, convert(int, ea.AppointmentDuration), ea.StartDateTime) AS EndDateTime, ISNULL(dept.ProcedureType,'') AS ProcedureType, ISNULL(ett.Description,'') AS TherapeuticType
FROM dbo.ERS_Appointments ea 
	INNER JOIN ERS_SCH_DiaryPages ed ON ed.DiaryId = ea.DiaryId
	LEFT JOIN dbo.ERS_AppointmentProcedureTypes eapt ON ea.AppointmentId = eapt.AppointmentID
	LEFT JOIN dbo.ERS_AppointmentStatus aps ON aps.UniqueId = ea.AppointmentStatusId
	LEFT JOIN dbo.ERS_AppointmentTherapeutics eat ON ea.AppointmentId = eat.AppointmentID
	LEFT JOIN dbo.ERS_ProcedureTypes dept ON dept.ProcedureTypeId = eapt.ProcedureTypeID
	LEFT JOIN dbo.ERS_TherapeuticTypes ett ON eat.TherapeuticTypeID = ett.Id
	INNER JOIN dbo.ERS_Patients ep ON ea.PatientId = ep.PatientId
WHERE ea.diaryid = @DiaryId AND ISNULL(aps.HDCKEY, '') NOT IN ('C','DC', 'BS') AND CONVERT(VARCHAR(10), ea.StartDateTime, 111) >= CONVERT(VARCHAR(10), @StartDate, 111)
ORDER BY StartDateTime
GO

SET QUOTED_IDENTIFIER ON
SET ANSI_NULLS ON
GO

ALTER PROCEDURE [dbo].[sch_get_diary_details]
(
	@DiaryId INT
)
AS

	SELECT DISTINCT
		d.DiaryId,
		d.DiaryStart, 
		d.[DiaryEnd],
		d.[UserID], 
		d.ListConsultantId,
		d.[RoomID], 
		d.ListRulesId, 
		d.Training,
		d.Subject,
		d.UserId EndoscopistId,
		d.ListConsultantId,
		(CASE WHEN  ISNULL(u.Title,'') <> '' THEN u.Title + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(u.Forename,'') <> '' THEN u.Forename + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(u.Surname,'') <> '' THEN u.Surname + ' ' ELSE '' END) as EndoscopistName,
	  (CASE WHEN  ISNULL(c.Title,'') <> '' THEN c.Title + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(c.Forename,'') <> '' THEN c.Forename + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(c.Surname,'') <> '' THEN c.Surname + ' ' ELSE '' END) as ListConsultant,
	  ls.TotalMinutes,
	  ls.TotalPoints,
	  ls.OverBookedPoints,
	  ISNULL(d.Notes,'') Notes,
	  d.ListGenderId,
	  ISNULL(g.Title,'') ListGender,
	  IsGI,
	  d.Locked,
	  CASE WHEN (SELECT count(a.AppointmentId) FROM ERS_Appointments a LEFT JOIN dbo.ERS_AppointmentStatus s ON s.UniqueId = a.AppointmentStatusId WHERE DiaryId = @DiaryId AND ISNULL(s.HDCKEY,'') NOT IN ('C', 'BS')) > 0 THEN convert(bit,1) ELSE convert(bit,0) END Appointments,
	  ISNULL((SELECT sum(pt.points) FROM ERS_AppointmentProcedureTypes pt INNER JOIN ERS_Appointments a ON a.AppointmentId = pt.AppointmentID LEFT JOIN dbo.ERS_AppointmentStatus s ON s.UniqueId = a.AppointmentStatusId WHERE DiaryId = @DiaryId AND ISNULL(s.HDCKEY,'') NOT IN ('C','BS')),0) AppointmentPoints,
	  ISNULL((SELECT sum(pt.points) FROM ERS_AppointmentProcedureTypes pt INNER JOIN ERS_Appointments a ON a.AppointmentId = pt.AppointmentID LEFT JOIN dbo.ERS_AppointmentStatus s ON s.UniqueId = a.AppointmentStatusId WHERE DiaryId = @DiaryId AND ISNULL(s.HDCKEY,'') = 'BS'),0) BlockedPoints,
	  CASE WHEN (SELECT count(a.AppointmentId) FROM ERS_Appointments a LEFT JOIN dbo.ERS_AppointmentStatus s ON s.UniqueId = a.AppointmentStatusId WHERE DiaryId = @DiaryId AND ISNULL(s.HDCKEY,'') = 'C') > 0 THEN convert(bit,1) ELSE convert(bit,0) END CancelledAppointments,
	  CASE WHEN ISNULL(RecurrenceParentID, 0) > 0 THEN convert(bit,1) ELSE convert(bit,0) END Recurring,
	  CASE WHEN ISNULL(RecurrenceParentID, 0) > 0 THEN 
		CASE RecurrenceFrequency WHEN 'd' THEN 'daily for ' + convert(varchar(10), RecurrenceCount) + ' day(s)'
							     WHEN 'w' THEN 'weekly for ' + convert(varchar(10), RecurrenceCount) + ' week(s)' 
								 when 'm' THEN 'montly for ' + convert(varchar(10), RecurrenceCount) + ' month(s)' 
		END 
	  END RecurrancePattern
	FROM ERS_SCH_DiaryPages d
		INNER JOIN ERS_Users u ON u.UserID = d.UserId
		LEFT JOIN ERS_Users c ON c.UserID = d.ListConsultantId
		INNER JOIN (SELECT ls.ListRulesId, (SUM(Points) - SUM(CONVERT(INT, IsOverBookedSlot))) TotalPoints, SUM(CONVERT(INT, IsOverBookedSlot)) OverBookedPoints, SUM(SlotMinutes) TotalMinutes FROM ERS_SCH_ListSlots ls WHERE ls.Active = 1 GROUP BY ListRulesId) ls ON ls.ListRulesId = d.ListRulesId
		LEFT JOIN ERS_GenderTypes g on g.GenderId = d.ListGenderId
	WHERE d.DiaryId = @DiaryId
GO


/****** Object:  StoredProcedure [dbo].[get_worklist_patients]    Script Date: 23/11/2023 11:45:18 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

EXEC dbo.DropIfExist @ObjectName = 'get_worklist_patients',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE  [dbo].[get_worklist_patients]
(
	@OperatingHospitalId INT,
	@StartDate DATETIME = NULL,
	@EndDate DATETIME = NULL,
	@EndoscopistId INT = NULL
)
AS
BEGIN
	IF @StartDate IS NULL
	BEGIN
		SET @StartDate = convert(date, convert(varchar(10), GETDATE(), 102))
	END
	IF @EndDate IS NOT NULL
	BEGIN
		SELECT @EndDate = convert(date, convert(varchar(10), DATEADD(Day, 1, @EndDate), 102))
	END

	SELECT DISTINCT
		ea.AppointmentId AS UniqueId, 
		ea.BookingTypeId AS BookingTypeId,
		ep.Surname, 
		ep.Forename1 as Forename, 
		convert(char(10),ep.DateOfBirth,103) AS DOB, 
		isnull(ep.Title,'') as Title,
		UPPER(SUBSTRING(dbo.fnGender(ep.GenderId),1,1)) AS Gender,
		STUFF((SELECT DISTINCT ', '+ HospitalNumber from ERS_PatientTrusts where PatientId = ep.PatientId for xml path('')), 1, 2, '') AS HospitalNumber,
		ep.NHSNo,
		dbo.fnFullAddress(ep.Address1, ep.Address2, ep.Address3, ep.Address4, '') AS Address,
		isnull(ep.Postcode,'') as Postcode, 
		convert(char(10),ea.StartDateTime,103) as [Date], 
		eapt.ProcedureTypeID AS ProcedureTypeId,
		ept.ProcedureType,
		ep.PatientId,
		1 AS ERSPatient,
		ISNULL(dp.OperatingHospitalId, ea.OperationalHospitaId) as HospitalId,
		ea.StartDateTime,
		ea.TimeOfDay,
		CASE WHEN [as].HDCKEY IS NULL THEN 'Booked'
			 WHEN [as].HDCKEY = 'P' THEN 'Booked'
		ELSE [as].[Description]
		END as AppointmentStatus,
		[as].HDCKEY as AppointmentStatusHDCKEY,
		r.RoomName as RoomName, 
		r.RoomId as RoomId,
		ea.Notes as Alerts,
		ea.GeneralInformation as Notes,
		CASE WHEN ISNULL(ea.DiaryId, 0) = 0 THEN ea.EndoscopistId ELSE dp.UserID END EndoscopistId,
		eu.Title + ' ' + eu.Forename + ' ' + eu.Surname AS Endoscopist,
		CASE ISNULL(ea.TimeOfDay,'') WHEN '' THEN 0 WHEN 'AM' THEN 1 WHEN 'PM' THEN 2 WHEN 'Evening' THEN 3 END AS iTOD,
		CASE WHEN ea.BookingTypeId = 2 THEN CONVERT(varchar(5), ea.StartDateTime, 108) ELSE '' END AS AppointmentTime,
		ISNULL(pip.ProcedureCompleted,0) AS ProcedureCompleted,
		CASE WHEN pj.PatientAdmissionTime IS NULL THEN 0 ELSE 1 END PatientArrived,
		CONVERT(varchar(5), pj.PatientAdmissionTime, 108) as ArrivedTime,
		CONVERT(varchar(5), pj.ProcedureStartTime, 108) as InProgressTime,
		CONVERT(varchar(5), pj.ProcedureEndTime, 108) as RecoveryTime,
		CONVERT(varchar(5), pj.PatientDischargeTime, 108) as DischargeTime,
		CONVERT(varchar(5), ea.DueArrivalTime, 108) as CallInTime,
		ss.Description AS Category
	FROM  ERS_Appointments ea  
		LEFT JOIN dbo.ERS_Patients ep (nolock) ON ea.PatientId = ep.PatientId
		LEFT JOIN ERS_AppointmentStatus [as] (nolock) ON EA.AppointmentStatusId = [as].UniqueId 
		LEFT JOIN ERS_AppointmentProcedureTypes eapt (nolock) ON EA.AppointmentId = eapt.AppointmentID
		LEFT JOIN dbo.ERS_ProcedureTypes ept (nolock) ON eapt.ProcedureTypeID = ept.ProcedureTypeId
		LEFT JOIN ERS_SCH_DiaryPages dp (nolock) on ea.DiaryId = dp.DiaryId
		LEFT JOIN dbo.ERS_Users eu (nolock) ON eu.UserID = CASE WHEN ISNULL(ea.DiaryId,0) = 0 THEN ea.EndoscopistId ELSE dp.UserId END 
		LEFT JOIN ERS_SCH_Rooms r (nolock) on dp.RoomId = r.RoomId
		LEFT JOIN (SELECT ep.ProcedureId, ep.ProcedureType, ep.ProcedureCompleted, ep.PatientId, ep.CreatedOn
						FROM dbo.ERS_Procedures ep (nolock)
					WHERE ep.IsActive= 1 
						AND ISNULL(ep.ProcedureCompleted,0) = 0 
						AND ep.OperatingHospitalID = @OperatingHospitalId
				  ) pip ON ea.PatientId = pip.PatientId AND ISNULL(eapt.ProcedureTypeId, pip.ProcedureType) = pip.ProcedureType
		LEFT JOIN ERS_PatientJourney pj (nolock) on pj.PatientId = ep.PatientId AND pj.AppointmentId = ea.AppointmentId
		LEFT JOIN ERS_SCH_SlotStatus ss (nolock) on ss.StatusId = ea.SlotStatusID
	WHERE ea.BookingTypeId IN (1, 2) /*1 = worklist, 2 = scheduler appointment*/
		AND ea.StartDateTime >= @StartDate 
		AND (@EndDate IS NULL OR ea.StartDateTime < @EndDate)
		AND (ea.IsDeleted IS NULL OR ea.IsDeleted = 0)
		AND (@EndoscopistId IS NULL OR CASE WHEN ISNULL(ea.DiaryId,0) = 0 THEN ea.EndoscopistId ELSE dp.UserId END = @EndoscopistId)
		AND ISNULL([as].HDCKEY,'') <> 'BS'
	order by ea.StartDateTime  
END

GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 13.2.24
-- TFS#	Spreadsheet item 10
-- Description of change
-- New SP to replace inline SQL - only returns endos that can do ALL specified therapeutics 
------------------------------------------------------------------------------------------------------------------------
GO

EXEC dbo.DropIfExist @ObjectName = 'sch_get_thereaputic_consultants',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE sch_get_thereaputic_consultants
(
	@TherapeuticTypeIds VARCHAR(MAX)
)
AS
BEGIN
	SELECT cp.EndoscopistID
	FROM dbo.ERS_ConsultantProcedureTypes cp 
	INNER JOIN dbo.ERS_ConsultantProcedureTherapeutics cpt ON cpt.ConsultantProcedureID = cp.ConsultantProcedureId
	WHERE TherapeuticTypeID IN (SELECT Item FROM dbo.fnSplitString(@TherapeuticTypeIds, ','))
	GROUP BY cpt.ConsultantProcedureID, cp.EndoscopistID
	HAVING COUNT(cpt.ConsultantProcedureID) = (SELECT COUNT(Item) FROM dbo.fnSplitString(@TherapeuticTypeIds, ','))
	ORDER BY cpt.ConsultantProcedureID
END
GO

SET QUOTED_IDENTIFIER ON
SET ANSI_NULLS ON
GO
ALTER PROCEDURE dbo.sch_search_available_slots
(
	@ProcedureTypes varchar(100) = NULL,
	@TherapeuticTypes AS varchar(100) = NULL,
	@Slots varchar(100) = NULL,
	@Endoscopist varchar(100) = NULL,
	@SearchStartDate datetime,
	@OperatingHospitalIDs as varchar(100),
	@ExcludeTraining bit
)
AS



	IF OBJECT_ID('tmpdb..#tmpEndos') IS NOT NULL DROP TABLE #tmpEndos
	SELECT * INTO #tmpEndos FROM fnSplitString(@Endoscopist, ',')

	IF OBJECT_ID('tmpdb..#tmpProcTypes') IS NOT NULL DROP TABLE #tmpProcTypes
	SELECT * INTO #tmpProcTypes FROM fnSplitString(ISNULL(@ProcedureTypes,''), ',')

	IF OBJECT_ID('tmpdb..#tmpProcTherapTypes') IS NOT NULL DROP TABLE #tmpProcTherapTypes
	SELECT * INTO #tmpProcTherapTypes FROM fnSplitString(ISNULL(@TherapeuticTypes,''), ',')

	IF OBJECT_ID('tmpdb..#tmpSlotTypes') IS NOT NULL DROP TABLE #tmpSlotTypes
	SELECT * INTO #tmpSlotTypes FROM fnSplitString(ISNULL(@Slots,''), ',')

	IF OBJECT_ID('tmpdb..#tmpOperatingHospitals') IS NOT NULL DROP TABLE #tmpOperatingHospitals
	SELECT * INTO #tmpOperatingHospitals FROM fnSplitString(ISNULL(@OperatingHospitalIDs,''), ',')



	SELECT DISTINCT
		d.DiaryId,
		d.DiaryStart,
		d.[DiaryEnd],
		d.[UserID], 
		d.[RoomID], 
		d.ListRulesId, 
		s.SlotMinutes AS [Minutes],
		CASE WHEN ept.ProcedureType IS NULL THEN ss.Description 
		ELSE 'Reserved for ' + ss.Description + ' '+ ept.ProcedureType END AS [Subject],
		ss.Description,
		ISNULL(s.ProcedureTypeID,0) AS ProcedureTypeID,
		ISNULL(ept.ProcedureType, '') AS ProcedureType,
		s.ListSlotId,
		ss.ForeColor,
		ss.StatusId,
		ISNULL(s.Points, 1) AS Points,
		ISNULL(d.UserID,0) AS EndoscopistId,
		(CASE WHEN  ISNULL(u.Title,'') <> '' THEN u.Title + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(u.Forename,'') <> '' THEN u.Forename + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(u.Surname,'') <> '' THEN u.Surname + ' ' ELSE '' END) AS EndoscopistName,
	  (CASE WHEN  ISNULL(c.Title,'') <> '' THEN c.Title + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(c.Forename,'') <> '' THEN c.Forename + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(c.Surname,'') <> '' THEN c.Surname + ' ' ELSE '' END) AS ListConsultant,
		l.ListName,
		(CASE WHEN  ISNULL(u.Title,'') <> '' THEN u.Title + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(u.Forename,'') <> '' THEN u.Forename + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(u.Surname,'') <> '' THEN u.Surname + ' ' ELSE '' END) +
	  '  [' + CONVERT(VARCHAR(5),CAST(d.DiaryStart AS TIME)) + '-' + CONVERT(VARCHAR(5),CAST(d.[DiaryEnd] AS TIME)) + ']' +
	  CASE WHEN  ISNULL(l.Points,0) <> 0 THEN '  [' + CONVERT(VARCHAR, l.Points) + ' slots]' ELSE '' END  AS ListDescription
		,d.suppressed
		,d.SuppressedFromDate
		,d.Training
		,l.GIProcedure
		,ISNULL(apt.AppointmentId, 0) AppointmentId
		,apt.StartDateTime AppointmentStart
		,ISNULL(apt.TotalPoints,0) AppointmentPoints
		,ISNULL(apt.AppointmentDuration,0) AppointmentDuration
		,DATEADD(minute, convert(int, apt.AppointmentDuration), apt.StartDateTime) AppointmentEnd
		,ISNULL(apt.StatusCode,'') AppointmentStatusCode
		,ISNULL(apt.Notes,'') AppointmentNotes
		,p.HospitalNumber + ' - ' + p.Forename1 + ' ' + p.Surname + '<br />' + apt.Description + ' '+ STUFF(REPLACE(apt.Procs, CHAR(10), '+'), LEN(apt.procs),1,'') AS [AppointmentSubject]
		,ISNULL(apt.GeneralInformation, '') GeneralInformation
		,s.Locked
		,d.OperatingHospitalId
		,ISNULL(d.RecurrenceParentID,0)RecurrenceParentID
		,ISNULL(d.locked,0) LockedDiary
		,ISNULL(gt.Code, '') ListGender
		,RoomName
	FROM ERS_SCH_DiaryPages d
		INNER JOIN (SELECT DISTINCT r.ListRulesId--, r.Points, r.ListName, s.SlotMinutes, s.ProcedureTypeId
						FROM dbo.ERS_SCH_ListRules r
						INNER JOIN dbo.ERS_SCH_ListSlots s ON s.ListRulesId = r.ListRulesId
						WHERE s.ProcedureTypeId IN (SELECT item FROM #tmpProcTypes) AND s.Active = 1) ls ON ls.ListRulesId = d.ListRulesId
		INNER JOIN ERS_SCH_ListRules l ON l.ListRulesId = ls.ListRulesId
		INNER JOIN ERS_SCH_ListSlots s ON ls.ListRulesId = s.ListRulesId AND s.Active = 1
		INNER JOIN dbo.ERS_SCH_SlotStatus ss ON ss.StatusId = s.SlotId
		LEFT JOIN dbo.ERS_ProcedureTypes ept ON s.ProceduretypeId = ept.ProcedureTypeId
		LEFT JOIN ERS_Users u ON u.UserID = d.UserId
		LEFT JOIN ERS_Users c ON c.UserID = d.ListConsultantId
		LEFT JOIN (SELECT ea.AppointmentId, SUM(eapt.Points) AS TotalPoints, SUM(eapt.Minutes) AS TotalMinutes, ea.ListSlotId, ea.DiaryId, MAX(aps.HDCKEY) StatusCode, ass.Description, ea.PatientId,ea.GeneralInformation, ea.Notes, ea.AppointmentDuration,ea.StartDateTime,
						(SELECT
							AppointmentProcedures + char(10) AS [text()] 
						FROM dbo.SCH_AppointmentProcedures(ea.AppointmentId)
						WHERE AppointmentId = ea.AppointmentId
						FOR XML PATH('')) AS procs
					FROM dbo.ERS_Appointments ea
						INNER JOIN dbo.ERS_AppointmentProcedureTypes eapt ON ea.AppointmentId = eapt.AppointmentID
						INNER JOIN dbo.ERS_SCH_SlotStatus ass ON ea.SlotStatusID = ass.StatusId
						LEFT JOIN ERS_AppointmentStatus aps on aps.UniqueId = ea.AppointmentStatusId
					 WHERE ISNULL(aps.HDCKEY,'') <> 'C'
					GROUP BY ea.AppointmentId, ea.ListSlotId, ea.DiaryId, ass.Description, ea.PatientId,ea.GeneralInformation, ea.Notes, ea.AppointmentDuration,ea.StartDateTime) AS apt 
											ON apt.DiaryId = d.DiaryId and  apt.ListSlotId = s.ListSlotId
		LEFT JOIN ERS_Patients p ON p.patientId = apt.PatientId
		LEFT JOIN dbo.ERS_GenderTypes gt ON gt.GenderId = d.ListGenderId
		INNER JOIN ERS_SCH_Rooms r ON r.RoomId = d.RoomID
	WHERE 
	d.Suppressed = 0 AND
	(d.DiaryStart >= @SearchStartDate) AND d.OperatingHospitalId IN (SELECT item FROM #tmpOperatingHospitals)
		--AND ((s.ProcedureTypeID IN (SELECT item FROM #tmpProcTypes)) OR ((ISNULL(@ProcedureTypes,'') = '' OR ISNULL(@ProcedureTypes,'') = '0') AND 1=1 ))
		AND ((((ISNULL(@Endoscopist,'') <> '' AND d.UserID IN (SELECT item FROM #tmpEndos)) OR (ISNULL(@Endoscopist,'') = '' AND 1=1))) OR ISNULL(d.UserID,'') ='')
		AND (s.SlotId IN (SELECT item FROM #tmpSlotTypes) OR (ISNULL(@Slots,'') = '' AND 1=1)) --if Slot type specified
		AND d.Training = CASE WHEN @ExcludeTraining = 1 THEN 0 ELSE d.Training END
		AND IsNull(d.Locked, 0) = 0  
	ORDER BY d.DiaryId, s.ListSlotId
GO



------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Duncan Stanyon
-- TFS#	XXXX
-- Only copy drugs over that are applicable to the new procedure type
-- 
------------------------------------------------------------------------------------------------------------------------

EXEC dbo.DropIfExist
    @ObjectName = 'usp_Procedure_Replicate',      -- varchar(100)
    @ObjectTypePrefix = 'S' -- varchar(5)
GO
PRINT 'Creating Procedure dbo.usp_Procedure_Replicate'
GO

GO 
CREATE PROCEDURE [dbo].[usp_Procedure_Replicate]
(
	@ProcedureID		INT,
	@ProcedureType		INT
)
AS

SET NOCOUNT ON

DECLARE @newProcId INT

BEGIN TRANSACTION

BEGIN TRY	

	IF EXISTS (Select 1 from ERS_Procedures where FormerProcedureId = @ProcedureID and IsActive = 1 and ProcedureType = @ProcedureType)  
		Select top 1 ProcedureId from ERS_Procedures where FormerProcedureId = @ProcedureID and IsActive = 1 and ProcedureType = @ProcedureType order by ProcedureId desc
	else
	BEGIN
		INSERT INTO [dbo].[ERS_Procedures]
			   ([ProcedureType]							,[CreatedBy]					,[CreatedOn]					,[ModifiedOn]
				,[PatientId]					        ,[OperatingHospitalID]	        ,[DiagramNumber]				,[ListConsultant]
				,[Endoscopist1]							,[Endoscopist2]					,[Assistant]					,[Nurse1]
				,[Nurse2]								,[Nurse3]						--,[Instrument1]					,[Instrument2]
				,[ReferralHospitalNo]					,[ReferralConsultantNo]			,[GPReferralFlag]				,[PatientStatus]
				,[Ward]									,[PatientType]					,[ReferralConsultantSpeciality]	
				,[PatientConsent]						,[GPCode]						,[CategoryListId]				,[EmergencyProcType]				
				,[GPPracticeCode]						,[ListType]						,[Endo1Role]					,[Endo2Role]					
				,[FormerProcedureId]					,[ImagePortId]					,[WhoCreatedId]					,[Points]
				,[ChecklistComplete]					,[ReferrerType]					,[ReferrertypeOther]			,[ProcedureTime] 
				,[ProviderTypeId]						,[ProviderOther]				,[PatientNotes]					,[PatientReferralLetter])
			SELECT 
				@ProcedureType							,p.[CreatedBy]					,p.[CreatedOn]					,GETDATE()
				,p.[PatientId]					        ,p.[OperatingHospitalID]	    ,p.[DiagramNumber]				,p.[ListConsultant]
				,p.[Endoscopist1]						,p.[Endoscopist2]				,p.[Assistant]					,p.[Nurse1]
				,p.[Nurse2]								,p.[Nurse3]						--,p.[Instrument1]				,p.[Instrument2]
				,p.[ReferralHospitalNo]					,p.[ReferralConsultantNo]		,p.[GPReferralFlag]				,p.[PatientStatus]
				,p.[Ward]								,p.[PatientType]				,p.[ReferralConsultantSpeciality]	
				,p.[PatientConsent]						,p.[GPCode]						,p.[CategoryListId]				,p.[EmergencyProcType]
				,p.[GPPracticeCode]						,p.[ListType]					,p.[Endo1Role]					,p.[Endo2Role]					
				,@ProcedureID							,p.[ImagePortId]				,p.[WhoCreatedId]				,p.[Points]
				,p.[ChecklistComplete]					,p.[ReferrerType]				,p.[ReferrertypeOther]			,p.[ProcedureTime] 
				,p.[ProviderTypeId]						,p.[ProviderOther]				,p.[PatientNotes]				,p.[PatientReferralLetter]	
			FROM ERS_Procedures p 
			WHERE p.ProcedureId = @ProcedureID

		SET @newProcId = SCOPE_IDENTITY()

		--Copy ProceduresReporting (PP fields)
		INSERT INTO [dbo].[ERS_ProceduresReporting]
			   ( [PP_PatAddress]						,[PP_RefHosp]					,[PP_CNN]						,[PP_RepDateAndTime]
				,[PP_RepType]							,[PP_GP]						,[PP_PatStatus]					,[PP_Ward]
				,[PP_RefCons]							,[PP_Endos]						,[PP_Premed]
				--,[PP_Indic]								,[PP_MainReportBody]			,[PP_Diagnoses]				,[PP_Instrument]	
				,[PP_Endo1]						
				,[PP_CCRefCons]							,[PP_CCOther]					,[PP_CCPatient]					,[PP_RepHead]					
				,[PP_RepSubHead]						,[PP_OpHosp]					,[PP_Room_ID]					,[PP_Priority]					
				,[PP_GPName]							,[PP_GPAddress]					,[PP_Endo2]
				,ProcedureId							,[PP_PathwayPlan])
			SElECT 	
				 pr.[PP_PatAddress]						,pr.[PP_RefHosp]				,pr.[PP_CNN]					,pr.[PP_RepDateAndTime]
				,pr.[PP_RepType]						,pr.[PP_GP]						,pr.[PP_PatStatus]				,pr.[PP_Ward]
				,pr.[PP_RefCons]						,pr.[PP_Endos]					,pr.[PP_Premed]
				--,pr.[PP_Indic]							,pr.[PP_MainReportBody]			,pr.[PP_Diagnoses]			,pr.[PP_Instrument]	
				,pr.[PP_Endo1]						
				,pr.[PP_CCRefCons]						,pr.[PP_CCOther]				,pr.[PP_CCPatient]				,pr.[PP_RepHead]					
				,pr.[PP_RepSubHead]						,pr.[PP_OpHosp]					,pr.[PP_Room_ID]				,pr.[PP_Priority]					
				,pr.[PP_GPName]							,pr.[PP_GPAddress]				,pr.[PP_Endo2]					
				,@newProcId								,pr.PP_Bowel_Prep
			FROM ERS_ProceduresReporting pr 
			WHERE pr.ProcedureId = @ProcedureID

		--Copy Premedication

		DECLARE @PreMedFieldName VARCHAR(50),
				@sqlString varchar(500)

		Select @PreMedFieldName = CASE @ProcedureType
									WHEN 1 THEN 'UsedInUpperGI' --Gasrto
									WHEN 2 THEN 'UsedInERCP' --ERCP
									WHEN 3 THEN 'UsedInColonSig' --Colon
									WHEN 4 THEN 'UsedInColonSig' --Sig
									WHEN 5 THEN 'UsedInColonSig' -- proct
									WHEN 6 THEN 'UsedInEUS_OGD' --EUS OGD
									WHEN 7 THEN 'UsedInEUS_HPB' --EUS HPB
									WHEN 8 THEN 'UsedInAntigrade' --ENT Anti
									WHEN 9 THEN 'UsedInRetrograde' --ENT Retro
									WHEN 10 THEN 'UsedInBroncho' --Bronchs
									WHEN 11 THEN 'UsedInEBUS' --EBUS
									WHEN 13 THEN 'UsedInFlexiCystoscopy' --Cysto
									ELSE 'UsedInUpperGI' -- Unknown procedure type. Use Gastro.
								  END		
		SET @sqlString = 'INSERT INTO ERS_UpperGIPremedication (ProcedureId, DrugNo, DrugName, Dose, Units, DeliveryMethod) '
		SET @sqlString = @sqlString + 'SELECT ' + CONVERT(VARCHAR, @newProcId) 
		SET @sqlString = @sqlString + ', pre.DrugNo, pre.DrugName, pre.Dose, pre.Units, pre.DeliveryMethod '
		SET @sqlString = @sqlString + ' FROM ERS_UpperGIPremedication pre '
		SET @sqlString = @sqlString + ' JOIN  ERS_DrugList dl on pre.DrugNo = dl.DrugNo WHERE ProcedureId = ' 
		SET @sqlString = @sqlString + CONVERT(VARCHAR, @ProcedureID) + ' AND ' + @PreMedFieldName + ' = 1'

		exec (@sqlString)

		IF @@ROWCOUNT > 0
		BEGIN
			DECLARE @Summary VARCHAR(max) = 'Procedure drugs:', 
					@DrugCount bit = (SELECT count(*) FROM ERS_UpperGIPremedication WHERE ProcedureId = @newProcId)

			EXEC UI_update_procedure_summary @newProcId, 'Procedure drugs', @Summary, @DrugCount	

			EXEC ogd_premedication_summary_update @newProcId
		END 


		--Copy Co-Morbidity
		INSERT INTO ERS_ProcedureComorbidity (ProcedureId, ComorbidityId, ChildComorbidityId, AdditionalInformation, WhoCreatedId, WhenCreated, WhoUpdatedId, WhenUpdated)
		SELECT @newProcId, ComorbidityId, ChildComorbidityId, AdditionalInformation, WhoCreatedId, GETDATE(), WhoUpdatedId, GETDATE() FROM ERS_ProcedureComorbidity WHERE ProcedureId = @ProcedureId
	
	
		IF @@ROWCOUNT > 0
		BEGIN
			DECLARE @Summary_c VARCHAR(max) = 'Comorbidity: ',
				@ComorbidityCount int = (SELECT count(*) FROM ERS_ProcedureComorbidity WHERE ProcedureId = @newProcId)

			EXEC UI_update_procedure_summary @newProcId, 'Comorbidity', @Summary_c, @ComorbidityCount

			UPDATE ERS_ProceduresReporting
			SET PP_Indic = dbo.ProcedureIndicationsSummary(@newProcId)
			WHERE ProcedureId = @newProcId
		END 

		--Copy ASAStatus
		INSERT INTO ERS_PatientASAStatus (PatientId, ProcedureCreatedId, ASAStatusId, WhoCreatedId, WhenCreated, WhoUpdatedId, WhenUpdated)
		SELECT PatientId, @newProcId, ASAStatusId, WhoCreatedId, GETDATE(), WhoUpdatedId, GETDATE() FROM ERS_PatientASAStatus WHERE ISNULL(ProcedureUpdatedId, ProcedureCreatedId) = @ProcedureId
	
	
		IF @@ROWCOUNT > 0
		BEGIN
			DECLARE @Summary_a VARCHAR(max) = 'ASA Status: ',
				@ASAStatusCount int = (SELECT count(*) FROM ERS_PatientASAStatus WHERE ISNULL(ProcedureUpdatedId, ProcedureCreatedId) = @newProcId)

			EXEC UI_update_procedure_summary @newProcId, 'ASA Status', @Summary_a, @ASAStatusCount

			UPDATE ERS_ProceduresReporting
			SET PP_Indic = dbo.ProcedureIndicationsSummary(@newProcId)
			WHERE ProcedureId = @newProcId
		END 


		SELECT @newProcId AS ProcedureId
	END
END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH

IF @@TRANCOUNT > 0 COMMIT TRANSACTION;
GO
------------------------------------------------------------------------------------------------------------------------
-- END usp_Procedure_Replicate
------------------------------------------------------------------------------------------------------------------------
Go

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Muhammad Rifat Hasan
-- TFS#	3201
-- Description of change
-- Removal of unneccessary textbox & change dropdown to multiselect for damaging drug & previous surgery.
------------------------------------------------------------------------------------------------------------------------
EXEC dbo.DropIfExist @ObjectName = 'ProcedureIndicationsSummary',      -- varchar(100)
                     @ObjectTypePrefix = 'F' -- varchar(5)
GO

CREATE FUNCTION [dbo].[ProcedureIndicationsSummary]
(
	@ProcedureId int
)
RETURNS varchar(max)
AS
BEGIN

DECLARE @IndicationsString  varchar(max), @ComorbidityString varchar(max), @DamagingDrugsString varchar(max), @PatientAllergiesString varchar(max), @PreviousSurgeryString varchar(max), 
		@PreviousDiseasesString varchar(max), @FamilyDiseaseHistoryString varchar(max), @ImagingString varchar(max), @ImagingOutcomeString varchar(max),
		@RetVal varchar(max), @ProcedureTypeId INT

SELECT @ProcedureTypeId = ProcedureType FROM dbo.ERS_Procedures WHERE ProcedureId = @ProcedureId

SELECT @IndicationsString =
	LTRIM(STUFF((SELECT ', ' + CASE WHEN i.AdditionalInfo = 0 THEN [Description] ELSE AdditionalInformation END + CASE WHEN ISNULL(ChildIndicationId, 0) > 0 THEN '-' + (SELECT [Description] FROM ERS_Indications WHERE UniqueId = epi.ChildIndicationId) ELSE '' END AS [text()] 
	FROM ERS_ProcedureIndications epi 
	INNER JOIN ERS_Indications i on i.UniqueId = epi.IndicationId
	WHERE ProcedureId=@ProcedureId
	ORDER BY ISNULL(i.ListOrderBy, 0)
	FOR XML PATH('')),1,1,''))

--rockall and baltchford scoring
SELECT @IndicationsString	= @IndicationsString + CASE WHEN CHARINDEX('melaena', @IndicationsString) > -1 OR CHARINDEX('haematemesis', @IndicationsString) > -1 THEN ' ' + dbo.fnBlatchfordRockallScores(@ProcedureId) ELSE '' END
--SELECT @IndicationsString = dbo.fnCapitalise(dbo.fnAddFullStop(@IndicationsString)) 

IF LEN(@IndicationsString) > 0
BEGIN
	IF charindex(',', reverse(@IndicationsString)) > 0
		SELECT @RetVal = STUFF(@IndicationsString, len(@IndicationsString) - charindex(' ,', reverse(@IndicationsString)) + 1, 2, ' and ')
	ELSE
		SELECT @RetVal = @IndicationsString
END
-------------------CoMorbidity


SELECT @ComorbidityString =
	LTRIM(STUFF((SELECT ', ' + CASE WHEN AdditionalInformation = '' THEN [Description] ELSE AdditionalInformation END + CASE WHEN ISNULL(ChildComorbidityId, 0) > 0 THEN '-' + (SELECT [Description] FROM ERS_CoMorbidity WHERE UniqueId = ChildComorbidityId) ELSE '' END AS [text()] 
	FROM ERS_ProcedureComorbidity epc 
	INNER JOIN ERS_Comorbidity c on c.uniqueid = CoMorbidityId
	WHERE ProcedureId=@ProcedureId
	ORDER BY ISNULL(c.ListOrderBy, 0)
	FOR XML PATH('')),1,1,''))

--SELECT @ComorbidityString = dbo.fnCapitalise(dbo.fnAddFullStop(@ComorbidityString)) 

IF LEN(@ComorbidityString) > 0 
BEGIN
	IF charindex(',', reverse(@ComorbidityString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Co-morbidity: ' + STUFF(@ComorbidityString, len(@ComorbidityString) - charindex(' ,', reverse(@ComorbidityString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Co-morbidity: ' + @ComorbidityString
END

-------------------Damaging drugs

SELECT @DamagingDrugsString =
	LTRIM(STUFF((SELECT ', ' + [Description] AS [text()] 
	FROM ERS_ProcedureDamagingDrugs edd 
	INNER JOIN ERS_PotentialDamagingDrugs d on d.uniqueid = edd.DamagingDrugId
	WHERE edd.ProcedureId=@ProcedureId
	ORDER BY ISNULL(d.ListOrderBy, 0)
	FOR XML PATH('')),1,1,''))

--SELECT @DamagingDrugsString = dbo.fnCapitalise(dbo.fnAddFullStop(@DamagingDrugsString)) 

DECLARE @AntiCoagDrugs bit = (SELECT AntiCoagDrugs FROM ERS_Procedures WHERE ProcedureId = @ProcedureId)
IF @AntiCoagDrugs IS NOT NULL
	If @AntiCoagDrugs = 1 SET @DamagingDrugsString = @DamagingDrugsString + '<br />The patient is taking anti-coagulant or anti-platelet medication.'

IF LEN(@DamagingDrugsString) > 0
BEGIN
	IF charindex(',', reverse(@DamagingDrugsString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Potential damaging drug(s): ' + STUFF(@DamagingDrugsString, len(@DamagingDrugsString) - charindex(' ,', reverse(@DamagingDrugsString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Potential damaging drug(s): ' + @DamagingDrugsString
END
-------------------Allergies

SELECT @PatientAllergiesString =
	CASE AllergyResult 
		WHEN -1 THEN 'unknown'
		WHEN 0 THEN 'none'
		WHEN 1 THEN a.AllergyDescription 
	END
	FROM ERS_PatientAllergies a
		INNER JOIN ERS_Procedures p ON p.PatientId = a.PatientId
	WHERE p.ProcedureId = @ProcedureId

--SELECT @PatientAllergiesString = dbo.fnCapitalise(dbo.fnAddFullStop(@PatientAllergiesString)) 

IF LEN(@PatientAllergiesString) > 0
BEGIN
	IF charindex(',', reverse(@PatientAllergiesString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Allergies: ' + STUFF(@PatientAllergiesString, len(@PatientAllergiesString) - charindex(' ,', reverse(@PatientAllergiesString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Allergies: ' + @PatientAllergiesString
END
-------------------Previous surgery

SELECT @PreviousSurgeryString =
	LTRIM(STUFF((SELECT DISTINCT ', ' + [Description] 
	--+ CASE WHEN ListItemText = 'Unknown' THEN '' ELSE ' ' + ListItemText END 
	as [text()] 
	FROM ERS_PatientPreviousSurgery h
	INNER JOIN ERS_PreviousSurgery r on r.UniqueID = h.PreviousSurgeryID
	INNER JOIN dbo.ERS_PreviousSurgeryProcedureTypes pspt ON pspt.PreviousSurgeryId = r.UniqueId AND pspt.ProcedureTypeId = @ProcedureTypeId
	--INNER JOIN ERS_Lists l on l.ListItemNo = h.PreviousSurgeryPeriod and ListDescription = 'Follow up disease Period'
	INNER JOIN ERS_Procedures p on p.patientId = h.patientId 
	WHERE p.ProcedureId = @ProcedureId
	--ORDER BY ISNULL(r.ListOrderBy, 0)
	FOR XML PATH('')),1,1,''))

--SELECT @PreviousSurgeryString = dbo.fnCapitalise(dbo.fnAddFullStop(@PreviousSurgeryString)) 

IF LEN(@PreviousSurgeryString) > 0
BEGIN
	IF charindex(',', reverse(@PreviousSurgeryString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Previous surgery: ' + STUFF(@PreviousSurgeryString, len(@PreviousSurgeryString) - charindex(' ,', reverse(@PreviousSurgeryString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Previous surgery: ' + @PreviousSurgeryString
END

-------------------ASA Status
DECLARE @ASAStatusString varchar(max) = 
	(SELECT TOP 1 [description]
	FROM ERS_PatientASAStatus pa 
		INNER JOIN ERS_ASAStatus a on a.uniqueid = pa.asastatusid
		INNER JOIN ERS_Procedures p ON p.PatientId = pa.PatientId
	WHERE ProcedureId = @ProcedureId
	order by isnull(pa.WhenUpdated, pa.WhenCreated))

IF LEN(@ASAStatusString) > 0 
BEGIN
	SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'ASA Status: ' + @ASAStatusString
END
-------------------Previous diseases

SELECT @PreviousDiseasesString =
	LTRIM(STUFF((SELECT DISTINCT ', ' + [Description] as [text()] 
	FROM ERS_PatientPreviousDiseases pd
	INNER JOIN ERS_PreviousDiseases d on d.UniqueID = pd.PreviousDiseaseID
	INNER JOIN ERS_Procedures p on p.patientId = pd.patientId 
	WHERE p.ProcedureId = @ProcedureId
	--ORDER BY ISNULL(r.ListOrderBy, 0)
	FOR XML PATH('')),1,1,''))

--SELECT @PreviousDiseasesString = dbo.fnCapitalise(dbo.fnAddFullStop(@PreviousDiseasesString)) 

IF LEN(@PreviousDiseasesString) > 0
BEGIN
	IF charindex(',', reverse(@PreviousDiseasesString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Previous diseases: ' + STUFF(@PreviousDiseasesString, len(@PreviousDiseasesString) - charindex(' ,', reverse(@PreviousDiseasesString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Previous diseases: ' + @PreviousDiseasesString
END

-------------------Family disease history

SELECT @FamilyDiseaseHistoryString =
	LTRIM(STUFF((SELECT ', ' + CASE WHEN AdditionalInformation = '' THEN [Description] ELSE AdditionalInformation END AS [text()] 
	FROM ERS_PatientFamilyDiseaseHistory epi 
	INNER JOIN ERS_FamilyDiseaseHistory i on i.UniqueId = epi.FamilyDiseaseHistoryId
	INNER JOIN ERS_Procedures p on p.patientId = epi.patientId 
	WHERE ProcedureId=@ProcedureId
	ORDER BY ISNULL(i.ListOrderBy, 999)
	FOR XML PATH('')),1,1,''))

--SELECT @FamilyDiseaseHistoryString = dbo.fnCapitalise(dbo.fnAddFullStop(@FamilyDiseaseHistoryString)) 

IF LEN(@FamilyDiseaseHistoryString) > 0
BEGIN
	IF charindex(',', reverse(@FamilyDiseaseHistoryString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Family history: ' + STUFF(@FamilyDiseaseHistoryString, len(@FamilyDiseaseHistoryString) - charindex(' ,', reverse(@FamilyDiseaseHistoryString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Family history: ' + @FamilyDiseaseHistoryString
END


-------------------Imaging

SELECT @ImagingString =
	LTRIM(STUFF((SELECT ', ' + [Description] AS [text()] 
	FROM ERS_ImagingMethods im 
	INNER JOIN ERS_ProcedureImagingMethod pim on im.uniqueid = pim.ImagingMethodId
	WHERE pim.ProcedureId=@ProcedureId
	FOR XML PATH('')),1,1,''))


IF LEN(@ImagingString) > 0
BEGIN
	IF charindex(',', reverse(@ImagingString)) > 0
		SELECT @ImagingString = STUFF(@ImagingString, len(@ImagingString) - charindex(' ,', reverse(@ImagingString)), 2, ' and ')
END


SELECT @ImagingOutcomeString =
	LTRIM(STUFF((SELECT ', ' + [Description] AS [text()] 
	FROM ERS_ImagingOutcomes imo 
	INNER JOIN ERS_ProcedureImagingOutcome pio on imo.uniqueid = pio.ImagingOutcomeId
	WHERE pio.ProcedureId=@ProcedureId
	FOR XML PATH('')),1,1,''))

IF ISNULL(@ImagingOutcomeString,'') <> ''
BEGIN
	SELECT @ImagingString = CASE WHEN ISNULL(@ImagingString, '') <> '' THEN @ImagingString + ' revealed ' ELSE '' END  + @ImagingOutcomeString
END


--SELECT @ImagingString = dbo.fnCapitalise(dbo.fnAddFullStop(@ImagingString)) 

IF LEN(@ImagingString) > 0
BEGIN
	IF charindex(',', reverse(@ImagingString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Imaging: ' + STUFF(@ImagingString, len(@ImagingString) - charindex(' ,', reverse(@ImagingString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Imaging: ' + @ImagingString
END


DECLARE @SmokingString varchar(max)


SELECT @SmokingString=
	LTRIM(STUFF((SELECT '  ' +SmokingDescription   AS [text()] 
	FROM ERS_ProcedureSmoking epi 
	WHERE ProcedureId=@ProcedureId
	FOR XML PATH('')),1,1,''))

--SELECT @SmokingString = dbo.fnCapitalise(dbo.fnAddFullStop(@SmokingString)) 

IF LEN(@SmokingString) > 0
BEGIN
	IF charindex(',', reverse(@SmokingString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>Smoking:</b> ' + @SmokingString
		--SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>Smoking:</b> ' + STUFF(@SmokingString, len(@SmokingString) - charindex(' ,', reverse(@SmokingString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>Smoking:</b> ' + @SmokingString
END

DECLARE @LUTSIPSSString varchar(max)
DECLARE @LUTSIPSSTotalScoreString varchar(max)

SELECT @LUTSIPSSString=
	LTRIM(STUFF((SELECT ', ' + SectionName+'(Score:'+cast(ls.ScoreValue as varchar(10)) +')'   AS [text()] 
	from  ERS_ProcedureLUTSIPSSSymptoms a ,ERS_LUTSIPSSSymptoms b,ERS_LUTSIPSSSymptomSections s,ERS_IPSSScore ls
	where ProcedureId=@ProcedureId and a.LUTSIPSSSymptomId=b.UniqueId and b.LUTSIPSSSymptomSectionId=s.LUTSIPSSSymptomSectionId and SelectedScoreId>1 and a.SelectedScoreId=ls.ScoreId
	FOR XML PATH('')),1,1,''))

--SELECT @LUTSIPSSString = dbo.fnCapitalise(dbo.fnAddFullStop(@LUTSIPSSString)) 

select top 1  @LUTSIPSSTotalScoreString =  'Total Score :' + cast(TotalScoreValue as varchar(10)) 
from  ERS_ProcedureLUTSIPSSSymptoms where ProcedureId=@ProcedureId
IF LEN(@LUTSIPSSString) > 0
BEGIN
	IF charindex(',', reverse(@LUTSIPSSString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>LUTS\IPSS symptom score:</b>' + STUFF(@LUTSIPSSString, len(@LUTSIPSSString) - charindex(' ,', reverse(@LUTSIPSSString)), 2,  ' ' + @LUTSIPSSTotalScoreString + ' '+'<br />')
	     
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>LUTS\IPSS symptom score:</b> ' + @LUTSIPSSString

	--SELECT @RetVal = ISNULL(@RetVal + '<br />', '') +  @LUTSIPSSTotalScoreString
END

DECLARE @PreviousDiseaseUrologyString varchar(max)

SELECT @PreviousDiseaseUrologyString=
	LTRIM(STUFF((SELECT ', ' +case 
       when a.Description='Other' then b.AdditionalInformation
	   else a.Description
	  end
   AS [text()] 
	from ERS_PreviousDiseasesUrology a, ERS_ProcedurePreviousDiseasesUrology b 
	where a.UniqueId=b.PreviousDiseaseId
	and b.ProcedureId=@ProcedureId
	order by PreviousDiseaseSectionId
	FOR XML PATH('')),1,1,''))

--SELECT @PreviousDiseaseUrologyString = dbo.fnCapitalise(dbo.fnAddFullStop(@PreviousDiseaseUrologyString)) 


IF LEN(@PreviousDiseaseUrologyString) > 0
BEGIN
	IF charindex(',', reverse(@PreviousDiseaseUrologyString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>Past Urological Histrory:</b>' + STUFF(@PreviousDiseaseUrologyString, len(@PreviousDiseaseUrologyString) - charindex(' ,', reverse(@PreviousDiseaseUrologyString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>Past Urological Histrory:</b> ' + @PreviousDiseaseUrologyString

	
END

DECLARE @UrineDipstickCytologyString varchar(max)

SELECT @UrineDipstickCytologyString=
	LTRIM(STUFF((SELECT ', ' + b.Description + ' '+c.Description 
   AS [text()] 
	from ERS_ProcedureUrineDipstickCytology a,ERS_UrineDipstickCytology b,ERS_UrineDipstickCytology c
	where a.ProcedureId=@ProcedureId
	and a.UrineDipstickCytologyId=b.UniqueId
	and a.ChildUrineDipstickCytologyId=c.UniqueId
	order by b.UrineDipstickCytologySectionId,b.ListOrderBy
	FOR XML PATH('')),1,1,''))

--SELECT @UrineDipstickCytologyString = dbo.fnCapitalise(dbo.fnAddFullStop(@UrineDipstickCytologyString)) 


IF LEN(@UrineDipstickCytologyString) > 0
BEGIN
	IF charindex(',', reverse(@UrineDipstickCytologyString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>Urine Dipstick And Cytology:</b>' + STUFF(@UrineDipstickCytologyString, len(@UrineDipstickCytologyString) - charindex(' ,', reverse(@UrineDipstickCytologyString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>Urine Dipstick And Cytology:<b>' + @UrineDipstickCytologyString

	
END


--------------Broncs referral data
DECLARE @BroncoReferralDataString varchar(max), @DateBronchRequested DATETIME,
		@DateOfReferral DATETIME,
		@LCaSuspectedBySpecialist BIT,
		@CTScanAvailable BIT,
		@DateOfScan DATETIME

	SELECT @DateBronchRequested=DateBronchRequested,
		   @DateOfReferral=DateOfReferral,
		   @LCaSuspectedBySpecialist=LCaSuspectedBySpecialist,
		   @CTScanAvailable=CTScanAvailable
	FROM ERS_ProcedureBronchoReferralData
	WHERE ProcedureId = @ProcedureId

	IF @DateBronchRequested IS NOT NULL SET @BroncoReferralDataString  = ISNULL(@BroncoReferralDataString,'') + 'Date bronchoscopy requested ' + CONVERT(VARCHAR, @DateBronchRequested, 105) + '. '
	IF @DateOfReferral IS NOT NULL SET @BroncoReferralDataString  = ISNULL(@BroncoReferralDataString,'') + 'Date of referral ' + CONVERT(VARCHAR, @DateOfReferral, 105) + '. '
	IF @LCaSuspectedBySpecialist = 1 SET @BroncoReferralDataString  = ISNULL(@BroncoReferralDataString,'') + 'Lung Ca suspected by lung Ca specialist' + '. '
	IF @CTScanAvailable = 1 SET @BroncoReferralDataString  = ISNULL(@BroncoReferralDataString,'') + 'CT scan available prior to bronchoscopy' + '. '
	IF @DateOfScan IS NOT NULL SET @BroncoReferralDataString  = ISNULL(@BroncoReferralDataString,'') + 'Date of scan ' + CONVERT(VARCHAR, @DateOfScan, 105) + '. '
	

	IF @BroncoReferralDataString IS NOT NULL SET @BroncoReferralDataString = 'Referal Data (' + RTRIM(@BroncoReferralDataString )+ ')'
	ELSE SET @BroncoReferralDataString = ''
	
	IF LEN(@BroncoReferralDataString) > 0
	BEGIN
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + @BroncoReferralDataString
	END


RETURN @RetVal
END

GO

EXEC dbo.DropIfExist @ObjectName = 'procedure_damaging_drugs_delete',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

EXEC dbo.DropIfExist @ObjectName = 'patient_anti_coag_drugs_delete',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

EXEC dbo.DropIfExist @ObjectName = 'UI_update_procedure_summary',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[UI_update_procedure_summary]
(
	@ProcedureId int,
	@Section varchar(200),
	@Summary varchar(max),
	@ResultId int,
	@EndoscopistId int = null
)
AS
BEGIN
	DECLARE @SectionId int = (SELECT UISectionId FROM UI_Sections WHERE SectionName = @Section)
	DELETE FROM ERS_ProcedureSummary WHERE ProcedureId = @ProcedureId AND SectionId = @SectionId AND (EndoscopistId IS NULL OR EndoscopistId = ISNULL(@EndoscopistId,0))
	IF @ResultId > 0 
	BEGIN
		INSERT INTO ERS_ProcedureSummary (ProcedureId, SectionId, Summary, EndoscopistId)
		VALUES (@ProcedureId, @SectionId, @Summary, @EndoscopistId)
	END

	UPDATE ERS_Procedures SET ReportUpdated = 1 WHERE ProcedureId = @ProcedureId
END
GO

EXEC dbo.DropIfExist @ObjectName = 'procedure_damaging_drugs_save',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[procedure_damaging_drugs_save]
(
	@ProcedureId int, 
	@DrugId varchar(255), 
	@LoggedInUserId int,
	@AntiCoag bit
)
AS
BEGIN
	--check if is an anticoag drug
	DECLARE @AntiCoagDrugs bit = (SELECT AntiCoagDrugs FROM ERS_Procedures WHERE ProcedureId = @ProcedureId),
				@SectionId int = (SELECT UISectionId FROM UI_Sections WHERE SectionName = 'Anti-coag drugs')

	--delete existing drugs
	DELETE FROM ERS_ProcedureDamagingDrugs WHERE ProcedureId = @ProcedureId AND DamagingDrugId IN (SELECT UniqueId FROM ERS_PotentialDamagingDrugs WHERE AntiCoag = @AntiCoag)

	IF @AntiCoag = 1 
	BEGIN
		IF @AntiCoagDrugs = 1 
			exec UI_update_procedure_summary @ProcedureId, 'Anti-coag drugs', '', 0
		ELSE IF @AntiCoagDrugs = 0
		BEGIN
			exec UI_update_procedure_summary @ProcedureId, 'Anti-coag drugs', '', 1
			exec UI_update_procedure_summary @ProcedureId, 'RX', '', 1
		END

		EXEC patient_anti_coag_drugs_save @ProcedureId, @AntiCoag
	END

	--save existing drugs
	DECLARE @SelectedID int;
	DECLARE db_cursor CURSOR FOR  
	SELECT item  FROM fnSplitString( @DrugId, ',')

	OPEN db_cursor   
	FETCH NEXT FROM db_cursor INTO @SelectedID 
	WHILE @@FETCH_STATUS = 0   
	BEGIN

		INSERT INTO [dbo].[ERS_ProcedureDamagingDrugs] (ProcedureId, DamagingDrugId, WhoCreatedId, WhenCreated)
		VALUES (@ProcedureId, @SelectedID, @LoggedInUserId, getdate())
	
		DECLARE @Summary VARCHAR(max) = 'Significant drugs',
				@DamagingDrugsCount int = (SELECT count(*) FROM ERS_ProcedureDamagingDrugs WHERE ProcedureId = @ProcedureId)

		EXEC UI_update_procedure_summary @ProcedureId, 'Significant drugs', @Summary, @DamagingDrugsCount

		IF @AntiCoagDrugs IS NOT NULL
		BEGIN
			DELETE FROM ERS_ProcedureSummary WHERE ProcedureId = @ProcedureId AND SectionId = @SectionId

			INSERT INTO ERS_ProcedureSummary (SectionId, ProcedureId, Summary) VALUES (@SectionId, @ProcedureId, 'Anti-Coag drugs')
		END

	FETCH NEXT FROM db_cursor INTO @SelectedID   
	END   

	CLOSE db_cursor   
	DEALLOCATE db_cursor

	UPDATE ERS_ProceduresReporting
	SET PP_Indic = dbo.ProcedureIndicationsSummary(@ProcedureId)
	WHERE ProcedureId = @ProcedureId
END
GO

EXEC dbo.DropIfExist @ObjectName = 'patient_previous_surgery_delete',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

EXEC dbo.DropIfExist @ObjectName = 'patient_previous_surgery_save',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[patient_previous_surgery_save]
(
	@PreviousSurgeryId varchar(255),	
	@PreviousSurgeryPeriod int,
	@ProcedureId int,
	@PatientId int,
	@LoggedInUserId int
)
AS
BEGIN
	DELETE FROM ERS_PatientPreviousSurgery WHERE PatientId = @PatientId

	DECLARE @SelectedID int;
	DECLARE db_cursor CURSOR FOR  
	SELECT item  FROM fnSplitString( @PreviousSurgeryId, ',')

	OPEN db_cursor   
	FETCH NEXT FROM db_cursor INTO @SelectedID 
	WHILE @@FETCH_STATUS = 0   
	BEGIN
		INSERT INTO ERS_PatientPreviousSurgery (PatientId, PreviousSurgeryId, PreviousSurgeryPeriod, ProcedureCreatedId, WhoCreatedId, WhenCreated)
		VALUES (@PatientId, @SelectedID, @PreviousSurgeryPeriod, @ProcedureId, @LoggedInUserId, getdate())

		DECLARE @ProcedureTypeId INT
		SELECT @ProcedureTypeId = ProcedureType FROM ERS_Procedures WHERE ProcedureId = @ProcedureId

		--check if previous surgery id exists in the procedure types link table, if not, add for this procedure type
		IF NOT EXISTS (SELECT 1 FROM ERS_PreviousSurgeryProcedureTypes WHERE PreviousSurgeryId = @SelectedID AND ProcedureTypeId = @ProcedureTypeId)
		BEGIN
			INSERT INTO ERS_PreviousSurgeryProcedureTypes (PreviousSurgeryId, ProcedureTypeId) VALUES (@SelectedID, @ProcedureTypeId)
		END

		--DECLARE @ResectionId INT
		--SELECT @ResectionId = ResectionId FROM ERS_PreviousSurgery WHERE UniqueId = @PreviousSurgeryId
		--IF @ResectionId IS NOT NULL
		--BEGIN
		--	UPDATE ERS_Procedures
		--	SET ResectedColonNo = @ResectionId
		--	WHERE ProcedureId = @ProcedureId
		--END

		FETCH NEXT FROM db_cursor INTO @SelectedID   
	END   

	CLOSE db_cursor   
	DEALLOCATE db_cursor

	UPDATE ERS_ProceduresReporting
	SET PP_Indic = dbo.ProcedureIndicationsSummary(@ProcedureId)
	WHERE ProcedureId = @ProcedureId

	DECLARE @Summary VARCHAR(max) = 'Previous surgery',
			@SurgeryCount int = (SELECT count(*) FROM ERS_PatientPreviousSurgery WHERE (ProcedureCreatedId = @ProcedureId or ProcedureUpdatedId = @ProcedureId))

	EXEC UI_update_procedure_summary @ProcedureId, 'Previous surgery', @Summary, @SurgeryCount

END
GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	3201 Ended
------------------------------------------------------------------------------------------------------------------------
GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 14.2.24
-- TFS#	
-- Description of change
-- Scheduler transformation creates additional templates/lists as custom 
------------------------------------------------------------------------------------------------------------------------
GO

SET QUOTED_IDENTIFIER ON
SET ANSI_NULLS ON
GO
ALTER PROCEDURE [dbo].[sys_transformed_diary_add]
(
	@DiaryId INT,
	@Subject VARCHAR(500), 
	@DiaryStart DATETIME, 
	@DiaryEnd DATETIME, 
	@RoomID INT, 
	@UserID INT, 
	@RecurrenceFrequency VARCHAR(500), 
	@RecurrenceCount INT, 
	@RecurrenceParentID int, 
	@ListRulesId int,
	@Description varchar(500),
	@OperatingHospitalId INT,
	@Training bit,
	@ListConsultant int,
	@ListGenderId int,
	@IsGI BIT,
	@ListNotes VARCHAR(max),
	@Add BIT
)
AS
SET NOCOUNT ON

BEGIN TRANSACTION

BEGIN TRY

	--create copy of list rules
	INSERT INTO dbo.ERS_SCH_ListRules
	(
	    Points,
	    PointMins,
	    Endoscopist,
	    ListName,
	    GIProcedure,
	    Training,
	    StartTime,
	    Suppressed,
	    OperatingHospitalId,
	    NonGIProcedureTypeId,
	    NonGIProcedureMinutesPerPoint,
	    NonGIDiagnosticCallInTime,
	    NonGIDiagnosticProcedurePoints,
	    NonGITherapeuticCallInTime,
	    NonGITherapeuticProcedurePoints,
	    WhoUpdatedId,
	    WhoCreatedId,
	    WhenCreated,
	    WhenUpdated,
	    ListConsultantId,
	    TotalMins,
	    IsTemplate,
	    GenderId
	)
	SELECT 
		Points,
	    PointMins,
	    Endoscopist,
	    ListName,
	    GIProcedure,
	    Training,
	    StartTime,
	    Suppressed,
	    OperatingHospitalId,
	    NonGIProcedureTypeId,
	    NonGIProcedureMinutesPerPoint,
	    NonGIDiagnosticCallInTime,
	    NonGIDiagnosticProcedurePoints,
	    NonGITherapeuticCallInTime,
	    NonGITherapeuticProcedurePoints,
	    WhoUpdatedId,
	    WhoCreatedId,
	    WhenCreated,
	    WhenUpdated,
	    ListConsultantId,
	    TotalMins,
	    0,
	    GenderId
	FROM dbo.ERS_SCH_ListRules WHERE ListRulesId = @ListRulesId

	--retrieve list rules id
	DECLARE @NewListRulesId INT = SCOPE_IDENTITY()

	--create copy of list slots
	INSERT INTO dbo.ERS_SCH_ListSlots
	(
	    ListRulesId,
	    SlotId,
	    ProcedureTypeId,
	    StartTime,
	    EndTime,
	    Suppressed,
	    OperatingHospitalId,
	    WhoUpdatedId,
	    WhoCreatedId,
	    WhenCreated,
	    WhenUpdated,
	    ParentListSlotId,
	    SlotMinutes,
	    Active,
	    DeactivatedDateTime,
	    Points,
	    Locked,
	    IsOverBookedSlot
	)
	SELECT 
		@NewListRulesId,
	    SlotId,
	    ProcedureTypeId,
	    StartTime,
	    EndTime,
	    Suppressed,
	    OperatingHospitalId,
	    WhoUpdatedId,
	    WhoCreatedId,
	    WhenCreated,
	    WhenUpdated,
	    ParentListSlotId,
	    SlotMinutes,
	    Active,
	    DeactivatedDateTime,
	    Points,
	    Locked,
	    IsOverBookedSlot
	FROM dbo.ERS_SCH_ListSlots
	WHERE ListRulesId = @ListRulesId AND Active = 1 AND Suppressed = 0

	IF @Add = 1 
	BEGIN
		
		
		INSERT INTO [ERS_SCH_DiaryPages] 
		([Subject], [DiaryStart], [DiaryEnd], [RoomID], [UserID], [ListRulesId], [OperatingHospitalId], [RecurrenceFrequency], [RecurrenceCount], [RecurrenceParentID], [WhenCreated], [Training], [ListConsultantId], ListGenderId, IsGI, Notes) 
		SELECT ListName, @DiaryStart, @DiaryEnd, @RoomId, @UserID, @NewListRulesId, @OperatingHospitalId, @RecurrenceFrequency, @RecurrenceCount, @RecurrenceParentID, GETDATE(), Training, @ListConsultant, @ListGenderId, @IsGI, @ListNotes  
		FROM dbo.ERS_SCH_ListRules WHERE ListRulesId = @ListRulesId
		
		DECLARE @NewDiaryId INT = (SELECT SCOPE_IDENTITY ())

		UPDATE ERS_SCH_DiaryPages
		SET DiaryStart = dateadd(year,-100, DiaryStart),
			DiaryEnd = DATEADD(year, -100, DiaryEnd)
		WHERE DiaryId = @DiaryId and datediff(year, diarystart, getdate())< 50

		SELECT @NewDiaryId DiaryId, @NewListRulesId ListRulesId
	END
	ELSE
	BEGIN
		UPDATE ERS_SCH_DiaryPages
		SET ListGenderId = @ListGenderId,
			Notes = @ListNotes,
			IsGI = @IsGI,
			ListRulesId = @NewListRulesId,
			Suppressed = 0,
			SuppressedFromDate = NULL
		WHERE DiaryId = @DiaryId

		SELECT @DiaryId DiaryId, @NewListRulesId ListRulesId
	END
END TRY

BEGIN CATCH
       DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

       IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH

IF @@TRANCOUNT > 0 COMMIT TRANSACTION;
GO



------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Steve 14-Feb-2024
-- TFS#	3592
-- Description of change
-- Stricture in Oesophagus that blocks scope should set Stomach and Duodenum to Not Entrered unless there is a 
-- Oesophageal Therapeutic that allows the scope to pass 
------------------------------------------------------------------------------------------------------------------------
GO
PRINT N'Begining Updates for Stricture Scope Blocking Fix';

GO
PRINT N'  Altering [dbo].[ogd_diagnoses_summary_update]...';

GO
EXEC dbo.DropIfExist @ObjectName = 'ogd_diagnoses_summary_update',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[ogd_diagnoses_summary_update]
(
	@ProcedureId INT
)
AS

SET NOCOUNT ON

--check for procedure DNA
DECLARE @ProcNotCarriedOut bit = ISNULL((SELECT 1 FROM ERS_Procedures WHERE ProcedureId = @ProcedureId AND DNA IS NOT NULL), 0)

IF @ProcNotCarriedOut = 1
	RETURN --DNA procs do not procude a diagnosis

DECLARE @ProcedureType INT
DECLARE @Summary varchar(MAX)=''
DECLARE @tmpSummary varchar(MAX)=''
DECLARE @XMLlist XML
DECLARE @OperatingHospitalId INT
DECLARE @OGDDiagnosisOption INT
DECLARE @Extent INT
DECLARE @ExtentItem VARCHAR(MAX)
DECLARE @ExtentDescription VARCHAR(MAX)
DECLARE @StomachExtent INT = (SELECT UniqueId FROM ERS_Extent WHERE Description = 'Stomach')
DECLARE @DuodenumExtent INT = (SELECT UniqueId FROM ERS_Extent WHERE Description = 'D1')
DECLARE @FurthestExtentReached INT = 0
DECLARE @BlockingStricure BIT = 0

SELECT 
	@ProcedureType = ProcedureType, 
	@OperatingHospitalId = COALESCE(OperatingHospitalId, 0, OperatingHospitalID)
FROM ERS_Procedures 
WHERE ProcedureId = @ProcedureId

SELECT 
	@OGDDiagnosisOption = OGDDiagnosis
FROM dbo.ERS_SystemConfig 
WHERE OperatingHospitalId = @OperatingHospitalId

--Get furthest recored Extent
SELECT TOP 1 @FurthestExtentReached = ee.UniqueId
FROM dbo.ERS_ProcedureUpperExtent epue 
	INNER JOIN dbo.ERS_Extent ee ON epue.ExtentId = ee.UniqueId
WHERE epue.ProcedureId=@ProcedureId
ORDER BY ee.ListOrderBy DESC

IF (SELECT ugam.SiteId
	FROM ERS_UpperGIAbnoMiscellaneous ugam
	JOIN ERS_Sites s ON s.SiteId = ugam.SiteId
	JOIN ERS_Regions r ON r.RegionId = s.RegionId
	JOIN ERS_AbnormalitiesMatrixUpperGI amug ON amug.Region = r.Region AND amug.ProcedureType = @ProcedureType
	LEFT JOIN ERS_UpperGITherapeutics ugt ON ugt.SiteId = s.SiteId 
	WHERE ugam.SiteId in (SELECT SiteId FROM ERS_Sites WHERE ProcedureId = @ProcedureId)
	AND amug.area = 'Oesophagus'
	AND ugam.StrictureScopeNotPass = 1 
	AND ISNULL(ugt.DilatorScopePass,0) != 1) > 0
BEGIN
	SET @BlockingStricure = 1
END

	 
IF @ProcedureType IN (2, 7)    --For ERCP & EUS_HPB, execute a different SP
BEGIN
	EXEC ercp_diagnoses_summary_update @ProcedureId
	RETURN
END

BEGIN TRANSACTION

BEGIN TRY

SELECT * INTO #tbl_ERS_Diagnoses FROM ERS_Diagnoses WHERE ProcedureId=@ProcedureId 

IF @ProcedureType IN (1,6,8)   --Gastroscopy
BEGIN
	IF OBJECT_ID('tempdb..#Oesophagus') IS NOT NULL DROP TABLE #Oesophagus
	IF OBJECT_ID('tempdb..#Stomach') IS NOT NULL DROP TABLE #Stomach
	IF OBJECT_ID('tempdb..#Duodenum') IS NOT NULL DROP TABLE #Duodenum

    IF OBJECT_ID('tempdb..#OesophagusTemp') IS NOT NULL DROP TABLE #OesophagusTemp
                             create table #OesophagusTemp ([cx] Int null, [Text] varchar(MAX) null)
    IF OBJECT_ID('tempdb..#StomachTemp') IS NOT NULL DROP TABLE #StomachTemp
                             create table #StomachTemp ([cx] Int null, [Text] varchar(MAX) null)
    IF OBJECT_ID('tempdb..#DuodenumTemp') IS NOT NULL DROP TABLE #DuodenumTemp
                             create table #DuodenumTemp ([cx] Int null, [Text] varchar(MAX) null)
	
	IF (SELECT COUNT(*) FROM #tbl_ERS_Diagnoses ted) = 0
	BEGIN
		INSERT INTO ERS_Diagnoses (ProcedureID, MatrixCode, [Value], IsOtherData)
		VALUES (@ProcedureId, 'OverallNormal', '1', 1)
	END
	ELSE
	BEGIN
		/*OESOPHAGUS REGION*/
		IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Region='Oesophagus' AND Value IN ('True', '1') AND MatrixCode NOT IN ('OesophagusNormal', 'OesophagusNotEntered'))
		BEGIN
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'OesophagusNormal') DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'OesophagusNormal' AND Value IN ('True', '1')
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'OesophagusNotEntered')  DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'OesophagusNotEntered' AND Value IN ('True', '1')
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'OverallNormal') DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'OverallNormal'
		END
		ELSE IF NOT EXISTS (SELECT 1 FROM #tbl_ERS_Diagnoses WHERE Region = 'Oesophagus' OR MatrixCode = 'OverallNormal')
		BEGIN
			INSERT INTO [ERS_Diagnoses] (ProcedureId, MatrixCode, Value, Region, IsOtherData) VALUES (@ProcedureId, 'OesophagusNormal', 'True', 'Oesophagus', 1)
		END

		/*STOMACH REGION*/
		IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Region='Stomach' AND Value IN ('True', '1') AND MatrixCode NOT IN ('StomachNormal', 'StomachNotEntered'))
		BEGIN
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'StomachNormal')  DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'StomachNormal' AND Value IN ('True', '1')
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'StomachNotEntered')  DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'StomachNotEntered' AND Value IN ('True', '1')
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'OverallNormal')  DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'OverallNormal'

			/*Oesophagus must've been entered to get a diagnoses*/
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'OesophagusNotEntered')  DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'OesophagusNotEntered' AND Value IN ('True', '1')
		END
		ELSE IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Region='Stomach' AND Value IN ('True', '1') AND MatrixCode IN ('StomachNormal', 'StomachNotEntered'))
		BEGIN
				IF @FurthestExtentReached >= @StomachExtent AND @BlockingStricure = 0
				BEGIN
					DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'StomachNotEntered' AND Value IN ('True', '1')
					IF NOT EXISTS (SELECT 1 FROM #tbl_ERS_Diagnoses WHERE MatrixCode = 'StomachNormal' OR MatrixCode = 'OverallNormal')
					BEGIN
						INSERT INTO [ERS_Diagnoses] (ProcedureId, MatrixCode, Value, Region, IsOtherData) VALUES (@ProcedureId, 'StomachNormal', 'True', 'Stomach', 1)
					END
				END
				ELSE
				BEGIN
					DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'StomachNormal' AND Value IN ('True', '1')
					IF NOT EXISTS (SELECT 1 FROM #tbl_ERS_Diagnoses WHERE MatrixCode = 'StomachNotEntered' OR MatrixCode = 'OverallNormal')
					BEGIN
						INSERT INTO [ERS_Diagnoses] (ProcedureId, MatrixCode, Value, Region, IsOtherData) VALUES (@ProcedureId, 'StomachNotEntered', 'True', 'Stomach', 1)
					END
				END
		END
		ELSE IF NOT EXISTS (SELECT 1 FROM #tbl_ERS_Diagnoses WHERE Region = 'Stomach' OR MatrixCode = 'OverallNormal')
		BEGIN
			INSERT INTO [ERS_Diagnoses] (ProcedureId, MatrixCode, Value, Region, IsOtherData) VALUES (@ProcedureId, 'StomachNormal', 'True', 'Stomach', 1)
		END

		/*DUODENUM REGION*/
		IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Region='Duodenum' AND Value IN ('True', '1') AND MatrixCode NOT IN ('DuodenumNormal', 'DuodenumNotEntered'))
		BEGIN
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'DuodenumNormal')  DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'DuodenumNormal' AND Value IN ('True', '1')
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'DuodenumNotEntered')  DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'DuodenumNotEntered' AND Value IN ('True', '1')
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'OverallNormal')   DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'OverallNormal'

			/*Oesophagus and stomach must've been entered to get a diagnoses*/
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'OesophagusNotEntered')  DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'OesophagusNotEntered' AND Value IN ('True', '1')
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'StomachNotEntered')  DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'StomachNotEntered' AND Value IN ('True', '1')

		END
		ELSE IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Region='Duodenum' AND Value IN ('True', '1') AND MatrixCode IN ('DuodenumNormal', 'DuodenumNotEntered'))
		BEGIN
			IF @FurthestExtentReached >= @DuodenumExtent AND @BlockingStricure = 0
			BEGIN
				DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'DuodenumNotEntered' AND Value IN ('True', '1')
				IF NOT EXISTS (SELECT 1 FROM #tbl_ERS_Diagnoses WHERE MatrixCode = 'DuodenumNormal' OR MatrixCode = 'OverallNormal')
				BEGIN
					INSERT INTO [ERS_Diagnoses] (ProcedureId, MatrixCode, Value, Region, IsOtherData) VALUES (@ProcedureId, 'DuodenumNormal', 'True', 'Duodenum', 1)
				END
			END
			ELSE
			BEGIN
				DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'DuodenumNormal' AND Value IN ('True', '1')
				IF NOT EXISTS (SELECT 1 FROM #tbl_ERS_Diagnoses WHERE MatrixCode = 'DuodenumNotEntered' OR MatrixCode = 'OverallNormal')
				BEGIN
					INSERT INTO [ERS_Diagnoses] (ProcedureId, MatrixCode, Value, Region, IsOtherData) VALUES (@ProcedureId, 'DuodenumNotEntered', 'True', 'Duodenum', 1)
				END
			END
		END
		ELSE IF NOT EXISTS (SELECT 1 FROM #tbl_ERS_Diagnoses WHERE Region = 'Duodenum' OR MatrixCode = 'OverallNormal')
		BEGIN
			INSERT INTO [ERS_Diagnoses] (ProcedureId, MatrixCode, Value, Region, IsOtherData) VALUES (@ProcedureId, 'DuodenumNormal', 'True', 'Duodenum', 1)
		END

	END

	IF EXISTS (SELECT 1 FROM #tbl_ERS_Diagnoses ted WHERE Region = 'Oesophagus' AND MatrixCode = 'OesophagusNormal' AND ted.[Value] IN ('True', '1')) AND
			EXISTS (SELECT 1 FROM #tbl_ERS_Diagnoses ted WHERE Region = 'Stomach' AND MatrixCode = 'StomachNormal' AND ted.[Value] IN ('True', '1')) AND
			EXISTS (SELECT 1 FROM #tbl_ERS_Diagnoses ted WHERE Region = 'Duodenum' AND MatrixCode = 'DuodenumNormal' AND ted.[Value] IN ('True', '1')) AND
			NOT EXISTS (SELECT 1 FROM #tbl_ERS_Diagnoses ted WHERE MatrixCode <> 'Summary' AND MatrixCode NOT IN ('OesophagusNormal','StomachNormal','DuodenumNormal'))
	BEGIN
		DELETE FROM ERS_Diagnoses WHERE MatrixCode IN ('OesophagusNormal','StomachNormal','DuodenumNormal')

		INSERT INTO ERS_Diagnoses (ProcedureID, MatrixCode, [Value], IsOtherData)
		VALUES (@ProcedureId, 'OverallNormal', '1', 1)
	END



	-- Don't repeat diagnoses
	IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE MatrixCode in ('D39P1', 'D84P1')) DELETE FROM ERS_Diagnoses WHERE MatrixCode = 'D49P1' and ProcedureID = @ProcedureId
	IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE MatrixCode in ('D90P1', 'D91P1')) DELETE FROM ERS_Diagnoses WHERE MatrixCode = 'D53P1' and ProcedureID = @ProcedureId

	DELETE FROM #tbl_ERS_Diagnoses
	INSERT INTO #tbl_ERS_Diagnoses
	(
	    ProcedureID,
	    SiteId,
	    MatrixCode,
	    [Value],
	    Region,
	    IsOtherData
	)
	SELECT  
	    ProcedureID,
	    SiteId,
	    MatrixCode,
	    [Value],
	    Region,
	    IsOtherData 
	FROM ERS_Diagnoses WHERE ProcedureId=@ProcedureId 



    SELECT  RowNum = ROW_NUMBER() OVER(ORDER BY [DiagnosesID]),d.*, convert(varchar(Max), m.DisplayName) AS DisplayName	INTO #Oesophagus	FROM #tbl_ERS_Diagnoses d	LEFT JOIN ERS_DiagnosesMatrix m ON d.matrixcode=m.Code WHERE Region='Oesophagus'	AND [Value] IS NOT NULL AND [Value]<>'False' AND [Value]<>'' AND MatrixCode <>'Summary'
    SELECT  RowNum = ROW_NUMBER() OVER(ORDER BY [DiagnosesID]),d.*, convert(varchar(Max), m.DisplayName) AS DisplayName	INTO #Stomach		FROM #tbl_ERS_Diagnoses d	LEFT JOIN ERS_DiagnosesMatrix m ON d.matrixcode=m.Code WHERE Region='Stomach'		AND [Value] IS NOT NULL AND [Value]<>'False' AND [Value]<>'' AND MatrixCode <>'Summary'
    SELECT  RowNum = ROW_NUMBER() OVER(ORDER BY [DiagnosesID]),d.*, convert(varchar(Max), m.DisplayName) AS DisplayName	INTO #Duodenum		FROM #tbl_ERS_Diagnoses d	LEFT JOIN ERS_DiagnosesMatrix m ON d.matrixcode=m.Code WHERE Region='Duodenum'		AND [Value] IS NOT NULL AND [Value]<>'False' AND [Value]<>'' AND MatrixCode <>'Summary'
	

	--Insert Other Abnormality
	If EXISTS(Select 1 from ERS_CommonAbnoOther CAO join ERS_Sites S On CAO.SiteId = s.SiteId where S.ProcedureId = @ProcedureId)
	BEGIN

		Insert into #Oesophagus (DiagnosesID, DisplayName, SiteId, ProcedureID, MatrixCode)
		SELECT 999, STUFF((
			SELECT DISTINCT ', ' + OA.Diagnoses  
			FROM ERS_OtherAbnormalities OA
			JOIN ERS_CommonAbnoOther CAO ON OA.OtherId = CAO.OtherId
			JOIN ERS_Sites S ON CAO.SiteId = s.SiteId
			JOIN ERS_Regions R ON S.RegionId = R.RegionId
			JOIN ERS_AbnormalitiesMatrixUpperGI AMU ON R.Region = AMU.Region
			WHERE S.ProcedureId = @ProcedureId
			AND AMU.Area = 'Oesophagus'
			AND AMU.ProcedureType = @ProcedureType
			FOR XML PATH('')), 1, 1, '') Code, 2, @ProcedureId, 'D999P0'

		Insert into #Stomach (DiagnosesID, DisplayName, SiteId, ProcedureID, MatrixCode)
		SELECT 999, STUFF((
			SELECT DISTINCT ', ' + OA.Diagnoses  
			FROM ERS_OtherAbnormalities OA
			JOIN ERS_CommonAbnoOther CAO ON OA.OtherId = CAO.OtherId
			JOIN ERS_Sites S ON CAO.SiteId = s.SiteId
			JOIN ERS_Regions R ON S.RegionId = R.RegionId
			JOIN ERS_AbnormalitiesMatrixUpperGI AMU ON R.Region = AMU.Region
			WHERE S.ProcedureId = @ProcedureId
			AND AMU.Area = 'Stomach'
			AND AMU.ProcedureType = @ProcedureType
			FOR XML PATH('')), 1, 1, '') Code, 2, @ProcedureId, 'D999P0'

		Insert into #Duodenum (DiagnosesID, DisplayName, SiteId, ProcedureID, MatrixCode)
		SELECT 999, STUFF((
			SELECT DISTINCT ', ' + OA.Diagnoses  
			FROM ERS_OtherAbnormalities OA
			JOIN ERS_CommonAbnoOther CAO ON OA.OtherId = CAO.OtherId
			JOIN ERS_Sites S ON CAO.SiteId = s.SiteId
			JOIN ERS_Regions R ON S.RegionId = R.RegionId
			JOIN ERS_AbnormalitiesMatrixUpperGI AMU ON R.Region = AMU.Region
			WHERE S.ProcedureId = @ProcedureId
			AND AMU.Area = 'Duodenum'
			AND AMU.ProcedureType = @ProcedureType
			FOR XML PATH('')), 1, 1, '') Code, 2, @ProcedureId, 'D999P0'
	END
	--Delete duplicates
	--DELETE FROM #Oesophagus WHERE RowNum NOT IN (SELECT MIN(RowNum) FROM #Oesophagus GROUP BY MatrixCode)
	--DELETE FROM #Stomach	WHERE RowNum NOT IN (SELECT MIN(RowNum) FROM #Stomach	GROUP BY MatrixCode)
	--DELETE FROM #Duodenum	WHERE RowNum NOT IN (SELECT MIN(RowNum) FROM #Duodenum	GROUP BY MatrixCode)
	--Delete duplicates
	
	--OESOPHAGUS
	INSERT INTO #OesophagusTemp ([cx],[Text]) 	--UNION to exclude duplicates for Abnormalities!
		--'Not Entered' or 'Normal' selected from the diagnoses screen
		SELECT 1, 'not entered' FROM #Oesophagus WHERE MatrixCode = 'OesophagusNotEntered'
		UNION
		SELECT 2, 'normal' FROM #Oesophagus WHERE MatrixCode = 'OesophagusNormal'
		UNION
		SELECT 3, CAST([Value] as Varchar(MAX)) FROM #Oesophagus WHERE MatrixCode = 'OesophagusOtherDiagnosis'
		UNION
		SELECT 0, DisplayName FROM #Oesophagus WHERE SiteId > 0 --Abnormalities for each sites 

	
	--STOMACH          
	INSERT INTO #StomachTemp ([cx],[Text]) 	--UNION to exclude duplicates for Abnormalities!
		--'Not Entered' or 'Normal' selected from the diagnoses screen
		SELECT 1, 'not entered' FROM #Stomach WHERE MatrixCode = 'StomachNotEntered'
		UNION
		SELECT 2, 'normal' FROM #Stomach WHERE MatrixCode = 'StomachNormal'
		UNION
		SELECT 3, CAST([Value] as Varchar(MAX)) FROM #Stomach WHERE MatrixCode = 'StomachOtherDiagnosis'
		UNION
		SELECT 0, DisplayName FROM #Stomach WHERE SiteId > 0 --Abnormalities for each sites 


	--DUODENUM      
	INSERT INTO #DuodenumTemp ([cx],[Text]) 	--UNION to exclude duplicates for Abnormalities!
		--'Not Entered' or 'Normal' selected from the diagnoses screen
		SELECT 1, 'not entered' FROM #Duodenum WHERE MatrixCode = 'DuodenumNotEntered'
		UNION
		SELECT 2, 'normal' FROM #Duodenum WHERE MatrixCode = 'DuodenumNormal'
		UNION
		SELECT 4, '2nd part not entered' FROM #Duodenum WHERE MatrixCode = 'Duodenum2ndPartNotEntered'
		UNION
		SELECT 3, CAST([Value] as Varchar(MAX)) FROM #Duodenum WHERE MatrixCode = 'DuodenumOtherDiagnosis'
		UNION
		SELECT 0, DisplayName FROM #Duodenum WHERE SiteId > 0 --Abnormalities for each sites 

--Determining the OGD diagnoses option set in System Settings
-- 0: Whole upper tract normal
-- 1: Individually Oesophagus normal, Stomach normal, Duodenum normal

	DECLARE @overallStatus AS INT
	IF EXISTS(SELECT 1 FROM #tbl_ERS_Diagnoses WHERE Value = 1 AND MatrixCode = 'OverallNormal')
	BEGIN
		SET @overallStatus = 1
	END
	ELSE
	BEGIN
		SET @overallStatus = 0
	END

	IF @OGDDiagnosisOption = 0 AND @overallStatus = 1
    BEGIN	
		SET @Summary = @summary + 'Whole upper gastro-intestinal tract normal.<br/>'			
	END
	ELSE 
	BEGIN
		--Oesophagus
		IF EXISTS(select 1 from #OesophagusTemp)
		BEGIN
			SET @XMLlist = (SELECT [text] AS Val FROM #OesophagusTemp FOR XML  RAW, ELEMENTS, TYPE)
			SET @tmpSummary = dbo.fnBuildString(@XMLlist)
			IF @tmpSummary <> '' SET @Summary = @summary + '<b>Oesophagus: </b>' + @tmpSummary + '.<br/>'
		END
		
		--Stomach 
		IF EXISTS(select 1 from #StomachTemp)
		BEGIN
			SET @XMLlist = (SELECT [text] AS Val FROM #StomachTemp FOR XML  RAW, ELEMENTS, TYPE)
			SET @tmpSummary = dbo.fnBuildString(@XMLlist)
			IF @tmpSummary <> '' SET @Summary = @summary + '<b>Stomach: </b>' + @tmpSummary + '.<br/>'
		END
		
		--Duodenum 
		IF EXISTS(select 1 from #DuodenumTemp) --AND @ExtentLevelReached = 1
		BEGIN
			SET @XMLlist = (SELECT [text] AS Val FROM #DuodenumTemp FOR XML  RAW, ELEMENTS, TYPE)
			SET @tmpSummary = dbo.fnBuildString(@XMLlist)
			IF @tmpSummary <> '' SET @Summary = @summary + '<b>Duodenum: </b>' + @tmpSummary + '.<br/>'
		END
		--ELSE
		--IF EXISTS(select 1 from #DuodenumTemp)
		--BEGIN
		--	SET @XMLlist = (SELECT [text] AS Val FROM #DuodenumTemp FOR XML  RAW, ELEMENTS, TYPE)
		--	SET @tmpSummary = dbo.fnBuildString(@XMLlist)
		--	IF @tmpSummary <> '' SET @Summary = @summary + '<b>Duodenum: </b>' + 'not entered.<br/>'
		--END		
	END	

	--IF EXISTS(SELECT 1 FROM ERS_UpperGIBleeds WHERE ProcedureID = @ProcedureId)
	--BEGIN
	--	SET @Summary = @summary +'<b>RISK OF REBLEED: </b>' + ISNULL((SELECT [OverallRiskAssessment] FROM ERS_UpperGIBleeds WHERE ProcedureID = @ProcedureId),'') + '. <br/> '
	--END

    DROP TABLE #Oesophagus
    DROP TABLE #OesophagusTemp
    DROP TABLE #Stomach
    DROP TABLE #StomachTemp
    DROP TABLE #Duodenum
    DROP TABLE #DuodenumTemp
END
ELSE IF @ProcedureType IN (3,4,5,9) --Colonoscopy, Sigmoidscopy, Proctoscopy
BEGIN
	IF OBJECT_ID('tempdb..#Colon') IS NOT NULL DROP TABLE #Colon
	IF OBJECT_ID('tempdb..#ColonTemp') IS NOT NULL DROP TABLE #ColonTemp
		create table #ColonTemp ([cx] Int null,	[Text] VARCHAR(MAX) null)

	IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True','1') AND MatrixCode <> 'ColonNormal' )
	BEGIN
		DELETE [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'ColonNormal'
		DELETE #tbl_ERS_Diagnoses WHERE MatrixCode = 'ColonNormal'
	END;

	--Select first row in each group (in case there's more than 1 record for a given MatrixCode)
	WITH colSummary AS (
    SELECT p.DiagnosesID, p.MatrixCode, p.Value, p.Region,
           ROW_NUMBER() OVER(PARTITION BY p.MatrixCode ORDER BY p.DiagnosesID DESC) AS rk
    FROM #tbl_ERS_Diagnoses p)

	SELECT d.*, cast(m.DisplayName as varchar(500)) as DisplayName
	INTO #Colon
	FROM colSummary d 
	LEFT JOIN ERS_DiagnosesMatrix m ON d.matrixcode = m.Code AND m.ProcedureTypeID = @ProcedureType
	WHERE rk = 1 -- Get the first record only
	AND Region = 'Colon'	AND [Value] IS NOT NULL	AND [Value] <> 'False'
	AND [Value] <> ''		AND [Value] <> '0'		--AND MatrixCode <> 'Summary'

	If EXISTS(Select 1 from ERS_CommonAbnoOther CAO join ERS_Sites S On CAO.SiteId = s.SiteId where S.ProcedureId = @ProcedureId)
	BEGIN

		Insert into #Colon (DiagnosesID, DisplayName, MatrixCode)
		SELECT 999, STUFF((
			SELECT DISTINCT ', ' + OA.Diagnoses  
			FROM ERS_OtherAbnormalities OA
			JOIN ERS_CommonAbnoOther CAO ON OA.OtherId = CAO.OtherId
			JOIN ERS_Sites S ON CAO.SiteId = s.SiteId
			WHERE S.ProcedureId = @ProcedureId
			FOR XML PATH('')), 1, 1, '') Code, 'D999P3'
	END

	IF ISNULL((SELECT CASE WHEN Abandoned = 1 OR NED_Abandoned = 1 THEN 1 ELSE 0 END FROM ERS_ColonExtentOfIntubation WHERE ProcedureId = @ProcedureId), 0) = 0
	BEGIN
		INSERT INTO #ColonTemp ([cx],[Text]) 
		SELECT 1, CONVERT(VARCHAR(MAX), 'The examination to the point of insertion was normal.') FROM #Colon WHERE MatrixCode = 'ColonNormal'
		UNION
		SELECT 2, 'The rest of the examination to the point of insertion was normal' FROM #Colon WHERE MatrixCode = 'ColonRestNormal'
	END
	ELSE
	BEGIN
		INSERT INTO #ColonTemp ([cx],[Text]) 
		SELECT 300, CONVERT(VARCHAR(MAX), 'Procedure abandoned')
	END

	INSERT INTO #ColonTemp ([cx],[Text])
	SELECT 4, MatrixCode FROM #Colon WHERE MatrixCode = 'Colitis'
	UNION
	SELECT 5, (SELECT m.DisplayName FROM ERS_DiagnosesMatrix m WHERE m.code= d.Value AND m.ProcedureTypeID = @ProcedureType)  FROM #Colon d WHERE d.MatrixCode = 'ColitisType' AND VALUE NOT IN ('D85P3', 'S85P3', 'P85P3') -- '?85P3' = None specified
	UNION
	SELECT 6, (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Diagnoses Colon Extent' AND [ListItemNo] = Value) FROM #Colon WHERE MatrixCode = 'ColitisExtent'
	UNION
	SELECT 7, (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Mayo Score' AND [ListItemNo] = Value) FROM #Colon WHERE MatrixCode = 'MayoScore'
	UNION
	SELECT 8, (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Simple Endoscopic Score  Crohn''s Disease' AND [ListItemNo] = Value) FROM #Colon WHERE MatrixCode = 'SEScore'
	UNION
	SELECT 9, MatrixCode FROM #Colon WHERE MatrixCode = 'Ileitis'
	UNION
	SELECT 10, MatrixCode FROM #Colon WHERE MatrixCode = 'Proctitis'
	UNION
	SELECT 0, LOWER(DisplayName) FROM #Colon WHERE RIGHT(MatrixCode,2) = 'P3'
	UNION
	SELECT 300, Value FROM #Colon WHERE MatrixCode = 'ColonOtherDiagnosis'
	

	IF EXISTS(select 1 from #ColonTemp)
	BEGIN
		SET @Summary = ''

		IF EXISTS(SELECT 1 FROM #ColonTemp WHERE cx =1) -- no need to check further if "point of insertion was normal"
			SET @Summary = (SELECT TOP 1 [text] from #ColonTemp where cx=1)
		ELSE 
		BEGIN
			--IF EXISTS(SELECT 1 FROM #ColonTemp WHERE cx IN (9)) --Ileitis checked
			--BEGIN
			--	SET @Summary = (SELECT TOP 1 [text] from #ColonTemp where cx=9)
			--END

			IF EXISTS(SELECT 1 FROM #ColonTemp WHERE cx IN (4, 9, 10)) --Colitis checked
			BEGIN
				DECLARE @ck varchar(1000) =''
				DECLARE @ms varchar(1000) = ''
				DECLARE @ses varchar(1000) = ''
				DECLARE @ColitisType VARCHAR(200) = ''
				IF EXISTS(SELECT 1 FROM #ColonTemp WHERE cx =6) 
					SET @ck=  (SELECT CASE @ck WHEN '' THEN (SELECT TOP 1 [text] from #ColonTemp where cx=6) ELSE @ck + ' ' + (SELECT TOP 1 [text] from #ColonTemp where cx=6) END)

				IF EXISTS(SELECT 1 FROM #ColonTemp WHERE cx =7) 
					SET @ms=  (SELECT CASE @ms WHEN '' THEN (SELECT TOP 1 [text] from #ColonTemp where cx=7) ELSE @ms + ' ' + (SELECT TOP 1 [text] from #ColonTemp where cx=7) END)

				IF EXISTS(SELECT 1 FROM #ColonTemp WHERE cx =8) 
					SET @ses=  (SELECT CASE @ses WHEN '' THEN (SELECT TOP 1 [text] from #ColonTemp where cx=8) ELSE @ses + ' ' + (SELECT TOP 1 [text] from #ColonTemp where cx=8) END)
				
				IF EXISTS(SELECT 1 FROM #ColonTemp WHERE cx = 9) --Ileitis checked
				BEGIN
					INSERT INTO #ColonTemp ([cx],[Text])  SELECT 50, 'Ileitis'
				END

				IF EXISTS(SELECT 1 FROM #ColonTemp WHERE cx =5) 
				BEGIN
					SET @ColitisType = ISNULL((SELECT TOP 1 [text] from #ColonTemp where cx=5),'')
				
					IF @ColitisType = '' SET @ColitisType = ISNULL((SELECT TOP 1 [text] from #ColonTemp where cx=4),'')

					IF @ms = '' AND @ses = ''
						SET @ColitisType = @ColitisType + (SELECT CASE @ck WHEN '' THEN '' ELSE ' (' + @ck +')' END)
					ELSE
					BEGIN
						IF @ms <> ''
							SET @ColitisType = @ColitisType + LOWER((SELECT CASE @ms WHEN '' THEN '' ELSE ': ' + @ms  END) + (SELECT CASE @ck WHEN '' THEN '' ELSE ', ' + @ck  END))
						
						IF @ses <> ''
							SET @ColitisType = @ColitisType + LOWER((SELECT CASE @ses WHEN '' THEN '' ELSE ': ' + @ses  END) + (SELECT CASE @ck WHEN '' THEN '' ELSE ', ' + @ck END))
					END
				END
				ELSE SET @ColitisType = LOWER((SELECT TOP 1 [text] from #ColonTemp where cx=4))

				--Concatnate text for colitis (4,5,6,7) and insert into #ColonTemp with id 100
				INSERT INTO #ColonTemp ([cx],[Text])  SELECT 100, @ColitisType

				IF EXISTS(SELECT 1 FROM #ColonTemp WHERE cx = 10) --Ileitis checked
				BEGIN
					INSERT INTO #ColonTemp ([cx],[Text])  SELECT 200, 'Proctitis'
				END
			END

			-- 0 = diag matrix ending with 'P3'  ;  100 = colitis   ;  300 = others
			SET @XMLlist = (SELECT [Text] AS Val FROM #ColonTemp WHERE [cx] in (0,50,100,200,300) ORDER BY [cx] FOR XML  RAW, ELEMENTS, TYPE)
			SET @Summary =  dbo.fnBuildString(@XMLlist) 

			SET @Summary = ISNULL((SELECT TOP 1 [text] + '.<br/>' FROM #ColonTemp WHERE cx=2),'')  + 
					CASE WHEN  @Summary <> '' THEN dbo.fnFirstLetterUpper(@Summary) + '.<br/>' ELSE '' END
		END

	END

	DROP TABLE #Colon
	DROP TABLE #ColonTemp
END
ELSE IF @ProcedureType IN (999) --Colonoscopy, Sigmoidscopy, Proctoscopy
BEGIN
	IF OBJECT_ID('tempdb..#Colon') IS NOT NULL DROP TABLE #ENT
	IF OBJECT_ID('tempdb..#ColonTemp') IS NOT NULL DROP TABLE #ENTTemp
		create table #ENTTemp ([cx] Int null,	[Text] VARCHAR(MAX) null)

	IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True','1') AND MatrixCode <> 'ColonNormal' )
	BEGIN
		DELETE [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'ColonNormal'
		DELETE #tbl_ERS_Diagnoses WHERE MatrixCode = 'ColonNormal'
	END;

	--Select first row in each group (in case there's more than 1 record for a given MatrixCode)
	WITH colSummary AS (
    SELECT p.DiagnosesID, p.MatrixCode, p.Value, p.Region,
           ROW_NUMBER() OVER(PARTITION BY p.MatrixCode ORDER BY p.DiagnosesID DESC) AS rk
    FROM #tbl_ERS_Diagnoses p)

	SELECT d.*, cast(m.DisplayName as varchar(500)) as DisplayName
	INTO #ENT
	FROM colSummary d 
	LEFT JOIN ERS_DiagnosesMatrix m ON d.matrixcode = m.Code AND m.ProcedureTypeID = @ProcedureType
	WHERE rk = 1 -- Get the first record only
	AND Region = 'Colon'	AND [Value] IS NOT NULL	AND [Value] <> 'False'
	AND [Value] <> ''		AND [Value] <> '0'		--AND MatrixCode <> 'Summary'

	If EXISTS(Select 1 from ERS_CommonAbnoOther CAO join ERS_Sites S On CAO.SiteId = s.SiteId where S.ProcedureId = @ProcedureId)
	BEGIN

		Insert into #ENT (DiagnosesID, DisplayName, MatrixCode)
		SELECT 999, STUFF((
			SELECT DISTINCT ', ' + OA.Diagnoses  
			FROM ERS_OtherAbnormalities OA
			JOIN ERS_CommonAbnoOther CAO ON OA.OtherId = CAO.OtherId
			JOIN ERS_Sites S ON CAO.SiteId = s.SiteId
			WHERE S.ProcedureId = @ProcedureId
			FOR XML PATH('')), 1, 1, '') Code, 'D999P9'
	END

	IF ISNULL((SELECT CASE WHEN Abandoned = 1 OR NED_Abandoned = 1 THEN 1 ELSE 0 END FROM ERS_ColonExtentOfIntubation WHERE ProcedureId = @ProcedureId), 0) = 0
	BEGIN
		INSERT INTO #ENTTemp ([cx],[Text]) 
		SELECT 1, CONVERT(VARCHAR(MAX), 'The examination to the point of insertion was normal.') FROM #ENT WHERE MatrixCode = 'ColonNormal'
		UNION
		SELECT 2, 'The rest of the examination to the point of insertion was normal' FROM #ENT WHERE MatrixCode = 'ColonRestNormal'
	END
	ELSE
	BEGIN
		INSERT INTO #ENTTemp ([cx],[Text]) 
		SELECT 300, CONVERT(VARCHAR(MAX), 'Procedure abandoned')
	END

	INSERT INTO #ENTTemp ([cx],[Text])
	SELECT 4, MatrixCode FROM #ENT WHERE MatrixCode = 'Colitis'
	UNION
	SELECT 5, (SELECT m.DisplayName FROM ERS_DiagnosesMatrix m WHERE m.code= d.Value AND m.ProcedureTypeID = @ProcedureType)  FROM #ENT d WHERE d.MatrixCode = 'ColitisType' AND VALUE NOT IN ('D85P3', 'S85P3', 'P85P3') -- '?85P3' = None specified
	UNION
	SELECT 6, (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Diagnoses Colon Extent' AND [ListItemNo] = Value) FROM #ENT WHERE MatrixCode = 'ColitisExtent'
	UNION
	SELECT 7, (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Mayo Score' AND [ListItemNo] = Value) FROM #ENT WHERE MatrixCode = 'MayoScore'
	UNION
	SELECT 8, (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Simple Endoscopic Score  Crohn''s Disease' AND [ListItemNo] = Value) FROM #ENT WHERE MatrixCode = 'SEScore'
	UNION
	SELECT 9, MatrixCode FROM #ENT WHERE MatrixCode = 'Ileitis'
	UNION
	SELECT 10, MatrixCode FROM #ENT WHERE MatrixCode = 'Proctitis'
	UNION
	SELECT 0, LOWER(DisplayName) FROM #ENT WHERE RIGHT(MatrixCode,2) = 'P9'
	UNION
	SELECT 300, Value FROM #ENT WHERE MatrixCode = 'ColonOtherDiagnosis'
	

	IF EXISTS(select 1 from #ENTTemp)
	BEGIN
		SET @Summary = ''

		IF EXISTS(SELECT 1 FROM #ENTTemp WHERE cx =1) -- no need to check further if "point of insertion was normal"
			SET @Summary = (SELECT TOP 1 [text] from #ENTTemp where cx=1)
		ELSE 
		BEGIN
			--IF EXISTS(SELECT 1 FROM #ColonTemp WHERE cx IN (9)) --Ileitis checked
			--BEGIN
			--	SET @Summary = (SELECT TOP 1 [text] from #ColonTemp where cx=9)
			--END

			IF EXISTS(SELECT 1 FROM #ENTTemp WHERE cx IN (4, 9, 10)) --Colitis checked
			BEGIN
				SET @ck =''
				SET @ms = ''
				SET @ses = ''
				SET @ColitisType = ''
				IF EXISTS(SELECT 1 FROM #ENTTemp WHERE cx =6) 
					SET @ck=  (SELECT CASE @ck WHEN '' THEN (SELECT TOP 1 [text] from #ENTTemp where cx=6) ELSE @ck + ' ' + (SELECT TOP 1 [text] from #ENTTemp where cx=6) END)

				IF EXISTS(SELECT 1 FROM #ENTTemp WHERE cx =7) 
					SET @ms=  (SELECT CASE @ms WHEN '' THEN (SELECT TOP 1 [text] from #ENTTemp where cx=7) ELSE @ms + ' ' + (SELECT TOP 1 [text] from #ENTTemp where cx=7) END)

				IF EXISTS(SELECT 1 FROM #ENTTemp WHERE cx =8) 
					SET @ses=  (SELECT CASE @ses WHEN '' THEN (SELECT TOP 1 [text] from #ENTTemp where cx=8) ELSE @ses + ' ' + (SELECT TOP 1 [text] from #ENTTemp where cx=8) END)
				
				IF EXISTS(SELECT 1 FROM #ENTTemp WHERE cx = 9) --Ileitis checked
				BEGIN
					INSERT INTO #ENTTemp ([cx],[Text])  SELECT 50, 'Ileitis'
				END

				IF EXISTS(SELECT 1 FROM #ENTTemp WHERE cx =5) 
				BEGIN
					SET @ColitisType = ISNULL((SELECT TOP 1 [text] from #ENTTemp where cx=5),'')
				
					IF @ColitisType = '' SET @ColitisType = ISNULL((SELECT TOP 1 [text] from #ENTTemp where cx=4),'')

					IF @ms = '' AND @ses = ''
						SET @ColitisType = @ColitisType + (SELECT CASE @ck WHEN '' THEN '' ELSE ' (' + @ck +')' END)
					ELSE
					BEGIN
						IF @ms <> ''
							SET @ColitisType = @ColitisType + LOWER((SELECT CASE @ms WHEN '' THEN '' ELSE ': ' + @ms  END) + (SELECT CASE @ck WHEN '' THEN '' ELSE ', ' + @ck  END))
						
						IF @ses <> ''
							SET @ColitisType = @ColitisType + LOWER((SELECT CASE @ses WHEN '' THEN '' ELSE ': ' + @ses  END) + (SELECT CASE @ck WHEN '' THEN '' ELSE ', ' + @ck END))
					END
				END
				ELSE SET @ColitisType = LOWER((SELECT TOP 1 [text] from #ENTTemp where cx=4))

				--Concatnate text for colitis (4,5,6,7) and insert into #ColonTemp with id 100
				INSERT INTO #ENTTemp ([cx],[Text])  SELECT 100, @ColitisType

				IF EXISTS(SELECT 1 FROM #ENTTemp WHERE cx = 10) --Ileitis checked
				BEGIN
					INSERT INTO #ENTTemp ([cx],[Text])  SELECT 200, 'Proctitis'
				END
			END

			-- 0 = diag matrix ending with 'P3'  ;  100 = colitis   ;  300 = others
			SET @XMLlist = (SELECT [Text] AS Val FROM #ENTTemp WHERE [cx] in (0,50,100,200,300) ORDER BY [cx] FOR XML  RAW, ELEMENTS, TYPE)
			SET @Summary =  dbo.fnBuildString(@XMLlist) 

			SET @Summary = ISNULL((SELECT TOP 1 [text] + '.<br/>' FROM #ENTTemp WHERE cx=2),'')  + 
					CASE WHEN  @Summary <> '' THEN dbo.fnFirstLetterUpper(@Summary) + '.<br/>' ELSE '' END
		END

	END

	DROP TABLE #ENT
	DROP TABLE #ENTTemp
END
IF EXISTS(SELECT 1 FROM #tbl_ERS_Diagnoses WHERE MatrixCode='Summary') UPDATE [ERS_Diagnoses] SET [Value] = @summary WHERE Procedureid=@ProcedureID AND MatrixCode='Summary'
ELSE INSERT INTO [ERS_Diagnoses] (ProcedureID,MatrixCode,[Value]) VALUES (@ProcedureID,'Summary', @Summary)

UPDATE ERS_ProceduresReporting SET PP_Diagnoses = @summary WHERE ProcedureId = @ProcedureId

IF ISNULL(@Summary,'') = '' AND NOT EXISTS (SELECT 1 FROM #tbl_ERS_Diagnoses WHERE [Value]<>'False' AND ISNULL([Value],'')<>'' AND MatrixCode <>'Summary')
	DELETE FROM ERS_RecordCount	WHERE [ProcedureId] = @ProcedureId AND [Identifier] = 'Diagnoses'
ELSE
	BEGIN
		IF NOT EXISTS (SELECT 1 FROM ERS_RecordCount WHERE [ProcedureId] = @ProcedureId AND [Identifier] = 'Diagnoses')
			INSERT INTO ERS_RecordCount ([ProcedureId], [SiteId], [Identifier], [RecordCount])
			VALUES (@ProcedureId, NULL, 'Diagnoses', 1)
	END

DROP TABLE #tbl_ERS_Diagnoses

--EXEC procedure_summary_update @procedureID

END TRY

BEGIN CATCH
       DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);
	
       IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;



GO
PRINT N'  Altering [dbo].[therapeutics_ogd_summary_update]...';

GO
EXEC dbo.DropIfExist @ObjectName = 'therapeutics_ogd_summary_update',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO


CREATE PROCEDURE [dbo].[therapeutics_ogd_summary_update]
(
	@TherapeuticId AS INT,
	@SiteId INT
)
AS
	SET NOCOUNT ON
	DECLARE   @msg VARCHAR(1000)
			, @msg2 VARCHAR(1000)
			, @Details VARCHAR(1000)
			, @Summary VARCHAR(4000)=''
			, @Area VARCHAR(500)=''
			, @br VARCHAR(6) = '<br />';

	DECLARE 
		@None BIT,
		@YAGLaser BIT,
		@YAGLaserWatts INT,
		@YAGLaserPulses INT,
		@YAGLaserSecs DECIMAL(8,2),
		@YAGLaserKJ DECIMAL(8,2),
		@ArgonBeamDiathermy BIT,
		@ArgonBeamDiathermyWatts INT,
		@ArgonBeamDiathermyPulses INT,
		@ArgonBeamDiathermySecs DECIMAL(8,2),
		@ArgonBeamDiathermyKJ DECIMAL(8,2),
		@BalloonDilation BIT,
		@BandLigation BIT,
		@BandLigationPerformed INT,
		@BandLigationSuccess INT,
		@BotoxInjection BIT,
		@EndoloopPlacement BIT,
		@HeatProbe BIT,
		@BicapElectro BIT,
		@Diathermy BIT,
		@DiathermyWatt INT,	--Mahfuz added on 30 Jul 2021
		@Coil BIT,
		@CoilQty INT,
		@CoilType INT,
		@Valve BIT,
		@ValveQty INT,
		@ValveType INT,
		@Cryotherapy BIT,
		@PhotoDynamicTherapy BIT,
		@ForeignBody BIT,
		@HotBiopsy BIT,
		@Injection BIT,
		@InjectionType INT,
		@InjectionVolume INT,
		@InjectionNumber INT,
		@OesophagealDilatation BIT,
		@DilatedTo INT,
		@DilatationUnits TINYINT,
		@DilatorType TINYINT,
		@DilatorScopePass BIT,
		@OesoDilNilByMouth BIT,
		@OesoDilNilByMouthHrs INT,
		@OesoDilXRay BIT,
		@OesoDilXRayHrs INT,
		@OesoDilSoftDiet BIT,
		@OesoDilSoftDietDays INT,
		@OesoDilWarmFluids BIT,
		@OesoDilWarmFluidsHrs INT,
		@OesoDilMedicalReview BIT,
		@OesoYAGNilByMouth BIT,
		@OesoYAGNilByMouthHrs INT,
		@OesoYAGWarmFluids BIT,
		@OesoYAGWarmFluidsHrs INT,
		@OesoYAGSoftDiet BIT,
		@OesoYAGSoftDietDays INT,
		@OesoYAGMedicalReview BIT,
		@Polypectomy BIT,
		@PolypectomyRemoval TINYINT,
		@PolypectomyRemovalType TINYINT,
		@BandingPiles BIT,
		@BandingNum INT,
		@GastrostomyInsertion BIT,
		@GastrostomyInsertionSize NUMERIC(9,2),
		@GastrostomyInsertionUnits TINYINT,
		@GastrostomyInsertionType TINYINT,
		@GastrostomyInsertionBatchNo VARCHAR(100),
		@CorrectPEGPlacement TINYINT,
		@PEGPlacementFailureReason VARCHAR(500),
		@NGNJInsertion BIT,
		@NGNJTubeNostril TINYINT,
		@NGNJTubeLength NUMERIC(9,2),
		@NGNJTubeBridle BIT,
		@NGNJTubeBatch VARCHAR(20),
		@NilByMouth BIT,
		@NilByMouthHrs INT,
		@NilByProc BIT,
		@NilByProcHrs INT,
		@FlangePosition NUMERIC(9,2),
		@AttachmentToWard BIT,
		@GastrostomyRemoval BIT,
		@PyloricDilatation BIT,
		@VaricealSclerotherapy BIT,
		@VaricealSclerotherapyInjectionType SMALLINT,
		@VaricealSclerotherapyInjectionVol INT,
		@VaricealSclerotherapyInjectionNum INT,
		@VaricealBanding BIT,
		@VaricealBandingNum INT,
		@VaricealClip BIT,
		@StentInsertion BIT,
		@StentInsertionQty INT,
		@StentInsertionType SMALLINT,
		@StentInsertionLength INT,
		@StentInsertionDiameter INT,
		@StentInsertionDiameterUnits TINYINT,
		@StentInsertionBatchNo VARCHAR(100),
		@CorrectStentPlacement TINYINT,
		@StentPlacementFailureReason VARCHAR(500),
		@StentRemoval BIT,
		@StentRemovalTechnique INT,
		@EMR BIT,
		@EMRType TINYINT,
		@EMRFluid INT,
		@EMRFluidVolume INT,
		@RFA BIT,
		@RFAType TINYINT,
		@RFATreatmentFrom INT,
		@RFATreatmentTo INT,
		@RFAEnergyDel INT,
		@RFANumSegTreated INT,
		@RFANumTimesSegTreated INT,
		@pHProbeInsert BIT,
		@pHProbeInsertAt INT,
		@pHProbeInsertChk BIT,
		@pHProbeInsertChkTopTo INT,
		@Haemospray BIT,
		@Sigmoidopexy BIT,
		@SigmoidopexyQty SMALLINT,
		@SigmoidopexyMake SMALLINT,
		@SigmoidopexyFluidsDays SMALLINT,
		@SigmoidopexyAntibioticsDays SMALLINT,
		@Marking BIT,
		@MarkedQuantity SMALLINT,
		@TattooLocationDistal BIT,
		@TattooLocationProximal BIT,
		@MarkingType INT,
		@Clip BIT,
		@ClipNum INT,
		@Other VARCHAR(1000),
		@EUSProcType SMALLINT,
		@EndoClot BIT,
		@ColonicDecompression BIT,
		@FlatusTubeInsertion BIT,
		@PancolonicDyeSpray BIT,
		@BougieDilation BIT,
		@EndoscopicResection BIT,
		@FineNeedleAspiration BIT,
		@FineNeedleAspirationType TINYINT,
		@FineNeedleBiopsy BIT,
		@Homeostasis BIT,
		@HomeostasisType INT,
		@Diverticulotomy BIT,
		@GastricBalloonInsertion BIT;

	IF OBJECT_ID('tempdb..#tmp_UpperGITherapeutics') IS NOT NULL
        DROP TABLE #tmp_UpperGITherapeutics;

	SELECT * INTO #tmp_UpperGITherapeutics 
	FROM dbo.[ERS_UpperGITherapeutics] 
	WHERE (Id = @TherapeuticId OR SiteID = @SiteId)

--## 1) If 'CarriedOutRole=2 (EE)' record is found for a SiteId in [ERS_UpperGITherapeutics] means it has both EE/ER Entries...
	--IF EXISTS(SELECT 'ER' FROM dbo.[ERS_UpperGITherapeutics] WHERE SiteId=@SiteId AND CarriedOutRole=2)
	--	BEGIN
			--PRINT '[ERS_UpperGITherapeutics] has both EE/ER Entries...';
			;WITH eeRecord AS (
				SELECT * FROM #tmp_UpperGITherapeutics WHERE CarriedOutRole = (SELECT MAX(CarriedOutRole) FROM #tmp_UpperGITherapeutics) --## 2 is EE
				--WHERE SiteId=@SiteId AND CarriedOutRole=2
			)
			SELECT
				@None							= (CASE WHEN ISNULL(ER.[None], 0) = 0 THEN EE.[None] ELSE ER.[None] END),
				@YAGLaser						= (CASE WHEN ISNULL(ER.[YAGLaser], 0) = 0 THEN EE.[YAGLaser] ELSE ER.[YAGLaser] END),
				@YAGLaserWatts					= (CASE WHEN ISNULL(ER.[YAGLaserWatts], 0) = 0 THEN EE.[YAGLaserWatts] ELSE ER.[YAGLaserWatts] END),
				@YAGLaserPulses					= (CASE WHEN ISNULL(ER.[YAGLaserPulses], 0) = 0 THEN EE.[YAGLaserPulses] ELSE ER.[YAGLaserPulses] END),
				@YAGLaserSecs					= (CASE WHEN ISNULL(ER.[YAGLaserSecs], 0) = 0 THEN EE.[YAGLaserSecs] ELSE ER.[YAGLaserSecs] END),
				@YAGLaserKJ						= (CASE WHEN ISNULL(ER.[YAGLaserKJ], 0) = 0 THEN EE.[YAGLaserKJ] ELSE ER.[YAGLaserKJ] END),
				@ArgonBeamDiathermy				= (CASE WHEN ISNULL(ER.[ArgonBeamDiathermy], 0) = 0 THEN EE.[ArgonBeamDiathermy] ELSE ER.[ArgonBeamDiathermy] END),
				@ArgonBeamDiathermyWatts		= (CASE WHEN ISNULL(ER.[ArgonBeamDiathermyWatts], 0) = 0 THEN EE.[ArgonBeamDiathermyWatts] ELSE ER.[ArgonBeamDiathermyWatts] END),
				@ArgonBeamDiathermyPulses		= (CASE WHEN ISNULL(ER.[ArgonBeamDiathermyPulses], 0) = 0 THEN EE.[ArgonBeamDiathermyPulses] ELSE ER.[ArgonBeamDiathermyPulses] END),
				@ArgonBeamDiathermySecs			= (CASE WHEN ISNULL(ER.[ArgonBeamDiathermySecs], 0) = 0 THEN EE.[ArgonBeamDiathermySecs] ELSE ER.[ArgonBeamDiathermySecs] END),
				@ArgonBeamDiathermyKJ			= (CASE WHEN ISNULL(ER.[ArgonBeamDiathermyKJ], 0) = 0 THEN EE.[ArgonBeamDiathermyKJ] ELSE ER.[ArgonBeamDiathermyKJ] END),
				@BalloonDilation				= (CASE WHEN ISNULL(ER.[BalloonDilation], 0) = 0 THEN EE.[BalloonDilation] ELSE ER.[BalloonDilation] END),
				@BandLigation					= (CASE WHEN ISNULL(ER.[BandLigation], 0) = 0 THEN EE.[BandLigation] ELSE ER.[BandLigation] END),
				@BandLigationPerformed			= (CASE WHEN ISNULL(ER.[BandLigationPerformed], 0) = 0 THEN EE.[BandLigationPerformed] ELSE ER.[BandLigationPerformed] END),
				@BandLigationSuccess			= (CASE WHEN ISNULL(ER.[BandLigationSuccessful], 0) = 0 THEN EE.[BandLigationSuccessful] ELSE ER.[BandLigationSuccessful] END),
				@BotoxInjection					= (CASE WHEN ISNULL(ER.[BotoxInjection], 0) = 0 THEN EE.[BotoxInjection] ELSE ER.[BotoxInjection] END),
				@EndoloopPlacement				= (CASE WHEN ISNULL(ER.[EndoloopPlacement], 0) = 0 THEN EE.[EndoloopPlacement] ELSE ER.[EndoloopPlacement] END),
				@HeatProbe						= (CASE WHEN ISNULL(ER.[HeatProbe], 0) = 0 THEN EE.[HeatProbe] ELSE ER.[HeatProbe] END),
				@BicapElectro					= (CASE WHEN ISNULL(ER.[BicapElectro], 0) = 0 THEN EE.[BicapElectro] ELSE ER.[BicapElectro] END),
				@Diathermy						= (CASE WHEN ISNULL(ER.[Diathermy], 0) = 0 THEN EE.[Diathermy] ELSE ER.[Diathermy] END),
				@DiathermyWatt					= (CASE WHEN ISNULL(ER.[DiathermyWatt], 0) = 0 THEN EE.[DiathermyWatt] ELSE ER.[DiathermyWatt] END),  
				@Coil							= (CASE WHEN ISNULL(ER.[Coil], 0) = 0 THEN EE.[Coil] ELSE ER.[Coil] END),
				@CoilQty						= (CASE WHEN ISNULL(ER.[CoilQty], 0) = 0 THEN EE.[CoilQty] ELSE ER.[CoilQty] END),
				@CoilType						= (CASE WHEN ISNULL(ER.[CoilType], 0) = 0 THEN EE.[CoilType] ELSE ER.[CoilType] END),
				@Valve							= (CASE WHEN ISNULL(ER.[Valve], 0) = 0 THEN EE.[Valve] ELSE ER.[Valve] END),
				@ValveQty						= (CASE WHEN ISNULL(ER.[ValveQty], 0) = 0 THEN EE.[ValveQty] ELSE ER.[ValveQty] END),
				@ValveType						= (CASE WHEN ISNULL(ER.[ValveType], 0) = 0 THEN EE.[ValveType] ELSE ER.[ValveType] END),
				@Cryotherapy					= (CASE WHEN ISNULL(ER.[Cryotherapy], 0) = 0 THEN EE.[Cryotherapy] ELSE ER.[Cryotherapy] END),
				@PhotoDynamicTherapy			= (CASE WHEN ISNULL(ER.[PhotoDynamicTherapy], 0) = 0 THEN EE.[PhotoDynamicTherapy] ELSE ER.[PhotoDynamicTherapy] END),
				@ForeignBody					= (CASE WHEN ISNULL(ER.[ForeignBody], 0) = 0 THEN EE.[ForeignBody] ELSE ER.[ForeignBody] END),
				@HotBiopsy						= (CASE WHEN ISNULL(ER.[HotBiopsy], 0) = 0 THEN EE.[HotBiopsy] ELSE ER.[HotBiopsy] END),
				@Injection						= (CASE WHEN ISNULL(ER.[Injection], 0) = 0 THEN EE.[Injection] ELSE ER.[Injection] END),
				@InjectionType					= (CASE WHEN ISNULL(ER.[InjectionType], 0) = 0 THEN EE.[InjectionType] ELSE ER.[InjectionType] END),
				@InjectionVolume				= (CASE WHEN ISNULL(ER.[InjectionVolume], 0) = 0 THEN EE.[InjectionVolume] ELSE ER.[InjectionVolume] END),
				@InjectionNumber				= (CASE WHEN ISNULL(ER.[InjectionNumber], 0) = 0 THEN EE.[InjectionNumber] ELSE ER.[InjectionNumber] END),
				@OesophagealDilatation			= (CASE WHEN ISNULL(ER.[OesophagealDilatation], 0) = 0 THEN EE.[OesophagealDilatation] ELSE ER.[OesophagealDilatation] END),
				@DilatedTo						= (CASE WHEN ISNULL(ER.[DilatedTo], 0) = 0 THEN EE.[DilatedTo] ELSE ER.[DilatedTo] END),
				@DilatationUnits				= (CASE WHEN ISNULL(ER.[DilatationUnits], 0) = 0 THEN EE.[DilatationUnits] ELSE ER.[DilatationUnits] END),
				@DilatorType					= (CASE WHEN ISNULL(ER.[DilatorType], 0) = 0 THEN EE.[DilatorType] ELSE ER.[DilatorType] END),
				@DilatorScopePass				= (CASE WHEN ISNULL(ER.[DilatorScopePass], 0) = 0 THEN EE.[DilatorScopePass] ELSE ER.[DilatorScopePass] END),
				@OesoDilNilByMouth				= (CASE WHEN ISNULL(ER.[OesoDilNilByMouth], 0) = 0 THEN EE.[OesoDilNilByMouth] ELSE ER.[OesoDilNilByMouth] END),
				@OesoDilNilByMouthHrs			= (CASE WHEN ISNULL(ER.[OesoDilNilByMouthHrs], 0) = 0 THEN EE.[OesoDilNilByMouthHrs] ELSE ER.[OesoDilNilByMouthHrs] END),
				@OesoDilXRay					= (CASE WHEN ISNULL(ER.[OesoDilXRay], 0) = 0 THEN EE.[OesoDilXRay] ELSE ER.[OesoDilXRay] END),
				@OesoDilXRayHrs					= (CASE WHEN ISNULL(ER.[OesoDilXRayHrs], 0) = 0 THEN EE.[OesoDilXRayHrs] ELSE ER.[OesoDilXRayHrs] END),
				@OesoDilSoftDiet				= (CASE WHEN ISNULL(ER.[OesoDilSoftDiet], 0) = 0 THEN EE.[OesoDilSoftDiet] ELSE ER.[OesoDilSoftDiet] END),
				@OesoDilSoftDietDays			= (CASE WHEN ISNULL(ER.[OesoDilSoftDietDays], 0) = 0 THEN EE.[OesoDilSoftDietDays] ELSE ER.[OesoDilSoftDietDays] END),
				@OesoDilWarmFluids				= (CASE WHEN ISNULL(ER.[OesoDilWarmFluids], 0) = 0 THEN EE.[OesoDilWarmFluids] ELSE ER.[OesoDilWarmFluids] END),
				@OesoDilWarmFluidsHrs			= (CASE WHEN ISNULL(ER.[OesoDilWarmFluidsHrs], 0) = 0 THEN EE.[OesoDilWarmFluidsHrs] ELSE ER.[OesoDilWarmFluidsHrs] END),
				@OesoDilMedicalReview			= (CASE WHEN ISNULL(ER.[OesoDilMedicalReview], 0) = 0 THEN EE.[OesoDilMedicalReview] ELSE ER.[OesoDilMedicalReview] END),
				@OesoYAGNilByMouth				= (CASE WHEN IsNull(ER.[OesoYAGNilByMouth], 0) = 0 THEN EE.[OesoYAGNilByMouth] ELSE ER.[OesoYAGNilByMouth] END),
				@OesoYAGNilByMouthHrs			= (CASE WHEN IsNull(ER.[OesoYAGNilByMouthHrs], 0) = 0 THEN EE.[OesoYAGNilByMouthHrs] ELSE ER.[OesoYAGNilByMouthHrs] END),
				@OesoYAGWarmFluids				= (CASE WHEN IsNull(ER.[OesoYAGWarmFluids], 0) = 0 THEN EE.[OesoYAGWarmFluids] ELSE ER.[OesoYAGWarmFluids] END),
				@OesoYAGWarmFluidsHrs			= (CASE WHEN IsNull(ER.[OesoYAGWarmFluidsHrs], 0) = 0 THEN EE.[OesoYAGWarmFluidsHrs] ELSE ER.[OesoYAGWarmFluidsHrs] END),
				@OesoYAGSoftDiet				= (CASE WHEN IsNull(ER.[OesoYAGSoftDiet], 0) = 0 THEN EE.[OesoYAGSoftDiet] ELSE ER.[OesoYAGSoftDiet] END),
				@OesoYAGSoftDietDays			= (CASE WHEN IsNull(ER.[OesoYAGSoftDietDays], 0) = 0 THEN EE.[OesoYAGSoftDietDays] ELSE ER.[OesoYAGSoftDietDays] END),
				@OesoYAGMedicalReview			= (CASE WHEN IsNull(ER.[OesoYAGMedicalReview], 0) = 0 THEN EE.[OesoYAGMedicalReview] ELSE ER.[OesoYAGMedicalReview] END),
				@Polypectomy					= (CASE WHEN IsNull(ER.[Polypectomy], 0) = 0 THEN EE.[Polypectomy] ELSE ER.[Polypectomy] END),
				@PolypectomyRemoval				= (CASE WHEN IsNull(ER.[PolypectomyRemoval], 0) = 0 THEN EE.[PolypectomyRemoval] ELSE ER.[PolypectomyRemoval] END),
				@PolypectomyRemovalType			= (CASE WHEN IsNull(ER.[PolypectomyRemovalType], 0) = 0 THEN EE.[PolypectomyRemovalType] ELSE ER.[PolypectomyRemovalType] END),
				@BandingPiles					= (CASE WHEN IsNull(ER.BandingPiles, 0) = 0 THEN EE.BandingPiles ELSE ER.BandingPiles END),
				@BandingNum						= (CASE WHEN IsNull(ER.BandingNum, 0) = 0 THEN EE.BandingNum ELSE ER.BandingNum END),
				@GastrostomyInsertion			= (CASE WHEN IsNull(ER.[GastrostomyInsertion], 0) = 0 THEN EE.[GastrostomyInsertion] ELSE ER.[GastrostomyInsertion] END),
				@GastrostomyInsertionSize		= (CASE WHEN IsNull(ER.[GastrostomyInsertionSize], 0) = 0 THEN EE.[GastrostomyInsertionSize] ELSE ER.[GastrostomyInsertionSize] END),
				@GastrostomyInsertionUnits		= (CASE WHEN IsNull(ER.[GastrostomyInsertionUnits], 0) = 0 THEN EE.[GastrostomyInsertionUnits] ELSE ER.[GastrostomyInsertionUnits] END),
				@GastrostomyInsertionType		= (CASE WHEN IsNull(ER.[GastrostomyInsertionType], 0) = 0 THEN EE.[GastrostomyInsertionType] ELSE ER.[GastrostomyInsertionType] END),
				@GastrostomyInsertionBatchNo	= (SELECT isnull((CASE WHEN IsNull(ER.[GastrostomyInsertionBatchNo], '') = '' THEN EE.[GastrostomyInsertionBatchNo] ELSE ER.[GastrostomyInsertionBatchNo] END), '') as [text()] FOR XML PATH('')),
				@CorrectPEGPlacement			= (CASE WHEN IsNull(ER.[CorrectPEGPlacement], 0) = 0 THEN EE.[CorrectPEGPlacement] ELSE ER.[CorrectPEGPlacement] END),
				@PEGPlacementFailureReason		= (SELECT isnull((CASE WHEN IsNull(ER.[PEGPlacementFailureReason], '') = '' THEN EE.[PEGPlacementFailureReason] ELSE ER.[PEGPlacementFailureReason] END), '') as [text()] FOR XML PATH('')),
				@NGNJInsertion 					= (CASE WHEN IsNull(ER.NGNJTubeInsertion, 0) = 0 THEN EE.NGNJTubeInsertion ELSE ER.NGNJTubeInsertion END),
				@NGNJTubeNostril				= (CASE WHEN IsNull(ER.NGNJTubeNostril, 0) = 0 THEN EE.NGNJTubeNostril ELSE ER.NGNJTubeNostril END),
				@NGNJTubeLength					= (CASE WHEN IsNull(ER.NGNJTubeLength, 0) = 0 THEN EE.NGNJTubeLength ELSE ER.NGNJTubeLength END),
				@NGNJTubeBridle					= (CASE WHEN IsNull(ER.NGNJTubeBridle, 0) = 0 THEN EE.NGNJTubeBridle ELSE ER.NGNJTubeBridle END),
				@NGNJTubeBatch					= (CASE WHEN IsNull(ER.NGNJTubeBatch, '') = '' THEN EE.NGNJTubeBatch ELSE ER.NGNJTubeBatch END),
				@NilByMouth						= (CASE WHEN IsNull(ER.[NilByMouth], 0) = 0 THEN EE.[NilByMouth] ELSE ER.[NilByMouth] END),
				@NilByMouthHrs					= (CASE WHEN IsNull(ER.[NilByMouthHrs], 0) = 0 THEN EE.[NilByMouthHrs] ELSE ER.[NilByMouthHrs] END),
				@NilByProc						= (CASE WHEN IsNull(ER.[NilByProc], 0) = 0 THEN EE.[NilByProc] ELSE ER.[NilByProc] END),
				@NilByProcHrs					= (CASE WHEN IsNull(ER.[NilByProcHrs], 0) = 0 THEN EE.[NilByProcHrs] ELSE ER.[NilByProcHrs] END),
				@FlangePosition					= (CASE WHEN IsNull(ER.[FlangePosition], 0) = 0 THEN EE.[FlangePosition] ELSE ER.[FlangePosition] END),
				@AttachmentToWard				= (CASE WHEN IsNull(ER.[AttachmentToWard], 0) = 0 THEN EE.[AttachmentToWard] ELSE ER.[AttachmentToWard] END),
				@GastrostomyRemoval				= (CASE WHEN IsNull(ER.[GastrostomyRemoval], 0) = 0 THEN EE.[GastrostomyRemoval] ELSE ER.[GastrostomyRemoval] END),
				@PyloricDilatation				= (CASE WHEN IsNull(ER.[PyloricDilatation], 0) = 0 THEN EE.[PyloricDilatation] ELSE ER.[PyloricDilatation] END),
				@VaricealSclerotherapy			= (CASE WHEN IsNull(ER.[VaricealSclerotherapy], 0) = 0 THEN EE.[VaricealSclerotherapy] ELSE ER.[VaricealSclerotherapy] END),
				@VaricealSclerotherapyInjectionType = (CASE WHEN IsNull(ER.[VaricealSclerotherapyInjectionType], 0) = 0 THEN EE.[VaricealSclerotherapyInjectionType] ELSE ER.[VaricealSclerotherapyInjectionType] END),
				@VaricealSclerotherapyInjectionVol  = (CASE WHEN IsNull(ER.[VaricealSclerotherapyInjectionVol], 0) = 0 THEN EE.[VaricealSclerotherapyInjectionVol] ELSE ER.[VaricealSclerotherapyInjectionVol] END),
				@VaricealSclerotherapyInjectionNum  = (CASE WHEN IsNull(ER.[VaricealSclerotherapyInjectionNum], 0) = 0 THEN EE.[VaricealSclerotherapyInjectionNum] ELSE ER.[VaricealSclerotherapyInjectionNum] END),
				@VaricealBanding				= (CASE WHEN IsNull(ER.[VaricealBanding], 0) = 0 THEN EE.[VaricealBanding] ELSE ER.[VaricealBanding] END),
				@VaricealBandingNum				= (CASE WHEN IsNull(ER.[VaricealBandingNum], 0) = 0 THEN EE.[VaricealBandingNum] ELSE ER.[VaricealBandingNum] END),
				@VaricealClip					= (CASE WHEN IsNull(ER.[VaricealClip], 0) = 0 THEN EE.[VaricealClip] ELSE ER.[VaricealClip] END),
				@StentInsertion					= (CASE WHEN IsNull(ER.[StentInsertion], 0) = 0 THEN EE.[StentInsertion] ELSE ER.[StentInsertion] END),
				@StentInsertionQty				= (CASE WHEN IsNull(ER.[StentInsertionQty], 0) = 0 THEN EE.[StentInsertionQty] ELSE ER.[StentInsertionQty] END),
				@StentInsertionType				= (CASE WHEN IsNull(ER.[StentInsertionType], 0) = 0 THEN EE.[StentInsertionType] ELSE ER.[StentInsertionType] END),
				@StentInsertionLength			= (CASE WHEN IsNull(ER.[StentInsertionLength], 0) = 0 THEN EE.[StentInsertionLength] ELSE ER.[StentInsertionLength] END),
				@StentInsertionDiameter			= (CASE WHEN IsNull(ER.[StentInsertionDiameter], 0) = 0 THEN EE.[StentInsertionDiameter] ELSE ER.[StentInsertionDiameter] END),
				@StentInsertionDiameterUnits	= (CASE WHEN IsNull(ER.[StentInsertionDiameterUnits], 0) = 0 THEN EE.[StentInsertionDiameterUnits] ELSE ER.[StentInsertionDiameterUnits] END),
				@StentInsertionBatchNo			= (CASE WHEN IsNull(ER.[StentInsertionBatchNo], '') = '' THEN EE.[StentInsertionBatchNo] ELSE ER.[StentInsertionBatchNo] END),
				@CorrectStentPlacement			= (CASE WHEN IsNull(ER.[CorrectStentPlacement], 0) = 0 THEN EE.[CorrectStentPlacement] ELSE ER.[CorrectStentPlacement] END),
				@StentPlacementFailureReason	= (SELECT isnull((CASE WHEN IsNull(ER.[StentPlacementFailureReason], '') = '' THEN EE.[StentPlacementFailureReason] ELSE ER.[StentPlacementFailureReason] END), '') as [text()] FOR XML PATH('')),
				@StentRemoval					= (CASE WHEN IsNull(ER.[StentRemoval], 0) = 0 THEN EE.[StentRemoval] ELSE ER.[StentRemoval] END),
				@StentRemovalTechnique			= (CASE WHEN IsNull(ER.[StentRemovalTechnique], 0) = 0 THEN EE.[StentRemovalTechnique] ELSE ER.[StentRemovalTechnique] END),
				@EMR							= (CASE WHEN IsNull(ER.[EMR], 0) = 0 THEN EE.[EMR] ELSE ER.[EMR] END),
				@EMRType						= (CASE WHEN IsNull(ER.[EMRType], 0) = 0 THEN EE.[EMRType] ELSE ER.[EMRType] END),
				@EMRFluid						= (CASE WHEN IsNull(ER.[EMRFluid], 0) = 0 THEN EE.[EMRFluid] ELSE ER.[EMRFluid] END),
				@EMRFluidVolume					= (CASE WHEN IsNull(ER.[EMRFluidVolume], 0) = 0 THEN EE.[EMRFluidVolume] ELSE ER.[EMRFluidVolume] END),
				@RFA							= (CASE WHEN IsNull(ER.[RFA], 0) = 0 THEN EE.[RFA] ELSE ER.[RFA] END),
				@RFAType						= (CASE WHEN IsNull(ER.[RFAType], 0) = 0 THEN EE.[RFAType] ELSE ER.[RFAType] END),
				@RFATreatmentFrom				= (CASE WHEN IsNull(ER.[RFATreatmentFrom], 0) = 0 THEN EE.[RFATreatmentFrom] ELSE ER.[RFATreatmentFrom] END),				
				@RFATreatmentTo					= (CASE WHEN IsNull(ER.[RFATreatmentTo], 0) = 0 THEN EE.[RFATreatmentTo] ELSE ER.[RFATreatmentTo] END),				
				@RFAEnergyDel					= (CASE WHEN IsNull(ER.[RFAEnergyDel], 0) = 0 THEN EE.[RFAEnergyDel] ELSE ER.[RFAEnergyDel] END),
				@RFANumSegTreated				= (CASE WHEN IsNull(ER.[RFANumSegTreated], 0) = 0 THEN EE.[RFANumSegTreated] ELSE ER.[RFANumSegTreated] END),
				@RFANumTimesSegTreated			= (CASE WHEN IsNull(ER.[RFANumTimesSegTreated], 0) = 0 THEN EE.[RFANumTimesSegTreated] ELSE ER.[RFANumTimesSegTreated] END),
				@pHProbeInsert					= (CASE WHEN IsNull(ER.[pHProbeInsert], 0) = 0 THEN EE.[pHProbeInsert] ELSE ER.[pHProbeInsert] END),
				@pHProbeInsertAt				= (CASE WHEN IsNull(ER.[pHProbeInsertAt], 0) = 0 THEN EE.[pHProbeInsertAt] ELSE ER.[pHProbeInsertAt] END),
				@pHProbeInsertChk				= (CASE WHEN IsNull(ER.[pHProbeInsertChk], 0) = 0 THEN EE.[pHProbeInsertChk] ELSE ER.[pHProbeInsertChk] END),
				@pHProbeInsertChkTopTo			= (CASE WHEN IsNull(ER.[pHProbeInsertChkTopTo], 0) = 0 THEN EE.[pHProbeInsertChkTopTo] ELSE ER.[pHProbeInsertChkTopTo] END),
				@Haemospray						= (CASE WHEN IsNull(ER.[Haemospray], 0) = 0 THEN EE.[Haemospray] ELSE ER.[Haemospray] END),
				@Sigmoidopexy					= (CASE WHEN IsNull(ER.[Sigmoidopexy], 0) = 0 THEN EE.[Sigmoidopexy] ELSE ER.[Sigmoidopexy] END),
				@SigmoidopexyQty				= (CASE WHEN IsNull(ER.[SigmoidopexyQty], 0) = 0 THEN EE.[SigmoidopexyQty] ELSE ER.[SigmoidopexyQty] END),
				@SigmoidopexyMake				= (CASE WHEN IsNull(ER.[SigmoidopexyMake], 0) = 0 THEN EE.[SigmoidopexyMake] ELSE ER.[SigmoidopexyMake] END),
				@SigmoidopexyFluidsDays			= (CASE WHEN IsNull(ER.[SigmoidopexyFluidsDays], 0) = 0 THEN EE.[SigmoidopexyFluidsDays] ELSE ER.[SigmoidopexyFluidsDays] END),
				@SigmoidopexyAntibioticsDays	= (CASE WHEN IsNull(ER.[SigmoidopexyAntibioticsDays], 0) = 0 THEN EE.[SigmoidopexyAntibioticsDays] ELSE ER.[SigmoidopexyAntibioticsDays] END),
				@Marking						= (CASE WHEN IsNull(ER.[Marking], 0) = 0 THEN EE.[Marking] ELSE ER.[Marking] END),
				--MH added on 19 Oct 2021
				--MH added on 19 Oct 2021 - later changed on 26 Nov 2021
				@TattooLocationDistal      = (CASE WHEN IsNull(ER.[TattooLocationDistal], 0) = 0 THEN EE.[TattooLocationDistal] ELSE ER.[TattooLocationDistal] END), 
				@TattooLocationProximal      = (CASE WHEN IsNull(ER.[TattooLocationProximal], 0) = 0 THEN EE.[TattooLocationProximal] ELSE ER.[TattooLocationProximal] END), 

				--MH added on 20 Oct 2021
				@MarkedQuantity    = (CASE WHEN IsNull(ER.[MarkedQuantity], 0) = 0 THEN EE.[MarkedQuantity] ELSE ER.[MarkedQuantity] END), 

				@MarkingType					= (CASE WHEN IsNull(ER.[MarkingType], 0) = 0 THEN EE.[MarkingType] ELSE ER.[MarkingType] END),
				@Clip							= (CASE WHEN IsNull(ER.[Clip], 0) = 0 THEN EE.[Clip] ELSE ER.[Clip] END),
				@ClipNum						= (CASE WHEN IsNull(ER.[ClipNum], 0) = 0 THEN EE.[ClipNum] ELSE ER.[ClipNum] END),
				@Other							= (SELECT isnull((CASE WHEN IsNull(ER.[Other], '') = '' THEN EE.[Other] ELSE ER.[Other] END), '') as [text()] FOR XML PATH('')),
				@EUSProcType					= (CASE WHEN IsNull(ER.[EUSProcType], 0) = 0 THEN EE.[EUSProcType] ELSE ER.[EUSProcType] END),
				@EndoClot						= (CASE WHEN IsNull(ER.[EndoClot], 0) = 0 THEN EE.[EndoClot] ELSE ER.[EndoClot] END),
				@ColonicDecompression			= (CASE WHEN IsNull(ER.[ColonicDecompression], 0) = 0 THEN EE.[ColonicDecompression] ELSE ER.[ColonicDecompression] END),
				@FlatusTubeInsertion			= (CASE WHEN IsNull(ER.[FlatusTubeInsertion], 0) = 0 THEN EE.[FlatusTubeInsertion] ELSE ER.[FlatusTubeInsertion] END),
				@PancolonicDyeSpray				= (CASE WHEN IsNull(ER.[PancolonicDyeSpray], 0) = 0 THEN EE.[PancolonicDyeSpray] ELSE ER.[PancolonicDyeSpray] END),
				@BougieDilation					= (CASE WHEN IsNull(ER.[BougieDilation], 0) = 0 THEN EE.[BougieDilation] ELSE ER.[BougieDilation] END),
				@EndoscopicResection			= (CASE WHEN IsNull(ER.[EndoscopicResection], 0) = 0 THEN EE.[EndoscopicResection] ELSE ER.[EndoscopicResection] END),
				@FineNeedleAspiration		    = (CASE WHEN IsNull(ER.FineNeedleAspiration, 0) = 0 THEN EE.FineNeedleAspiration ELSE ER.FineNeedleAspiration END),
				@FineNeedleAspirationType	    = (CASE WHEN IsNull(ER.FineNeedleAspirationType, 0) = 0 THEN EE.FineNeedleAspirationType ELSE ER.FineNeedleAspirationType END),
				@FineNeedleBiopsy			    = (CASE WHEN IsNull(ER.FineNeedleBiopsy, 0) = 0 THEN EE.FineNeedleBiopsy ELSE ER.FineNeedleBiopsy END),
				@Homeostasis					= (CASE WHEN ISNULL(ER.[Homeostasis], 0) = 0 THEN EE.[Homeostasis] ELSE ER.[Homeostasis] END),
				@HomeostasisType				= (CASE WHEN ISNULL(ER.[HomeostasisType], 0) = 0 THEN EE.[HomeostasisType] ELSE ER.[HomeostasisType] END),
				@Diverticulotomy				= (CASE WHEN ISNULL(ER.[Diverticulotomy], 0) = 0 THEN EE.[Diverticulotomy] ELSE ER.[Diverticulotomy] END),
				@GastricBalloonInsertion		= ISNULL(EE.[GastricBalloonInsertion], 0)
			FROM eeRecord AS EE
	  INNER JOIN #tmp_UpperGITherapeutics AS ER ON EE.SiteId = ER.SiteId
	 
	SELECT @Area = m.Area FROM dbo.ERS_AbnormalitiesMatrixUpperGI m LEFT JOIN dbo.ERS_Regions r ON m.Region = r.Region LEFT JOIN dbo.ERS_Sites s ON r.RegionId  = s.RegionID  WHERE s.siteId = @SiteId;
	
	IF @None = 1
		SET @summary = @summary + 'No therapeutic procedures'
	ELSE
	BEGIN
		IF @YAGLaser = 1
			BEGIN
			SET @msg =' YAG Laser'
			SET @Details = ''
			IF @YAGLaserWatts > 0 SET @Details = @Details + ' ' + CAST(@YAGLaserWatts as varchar(50)) + 'W'
			IF @YAGLaserSecs > 0 SET @Details = @Details + ' for ' + cast(CAST(@YAGLaserSecs AS FLOAT) as varchar(50)) + CASE WHEN @YAGLaserSecs <= 1 THEN ' second' else ' seconds' END
			IF @YAGLaserPulses > 0 SET @Details = @Details + ' in ' + cast(@YAGLaserPulses as varchar(50)) + CASE WHEN @YAGLaserPulses <= 1 THEN ' pulse' else ' pulses' END
			IF @YAGLaserKJ > 0 SET @Details = @Details + ' ('+ cast(CAST(@YAGLaserKJ AS FLOAT) as varchar(50)) + 'kJ)'
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + @br
			END
		
		IF @ArgonBeamDiathermy= 1
			BEGIN
			SET @msg ='  Argon beam diathermy'
			SET @Details = ''
			IF @ArgonBeamDiathermyWatts > 0 SET @Details = @Details + ' ' + cast(@ArgonBeamDiathermyWatts as varchar(50)) + 'W'
			IF @ArgonBeamDiathermySecs > 0 SET @Details = @Details + ' for ' + cast(CAST(@ArgonBeamDiathermySecs AS FLOAT) as varchar(50)) + CASE WHEN @ArgonBeamDiathermySecs <= 1 THEN ' second' else ' seconds' END
			IF @ArgonBeamDiathermyPulses > 0 SET @Details = @Details + ' in ' + cast(@ArgonBeamDiathermyPulses as varchar(50)) + CASE WHEN @ArgonBeamDiathermyPulses <= 1 THEN ' pulse' else ' pulses' END
			IF @ArgonBeamDiathermyKJ > 0 SET @Details = @Details + ' ('+ cast(CAST(@ArgonBeamDiathermyKJ AS FLOAT) as varchar(50)) + 'kJ)'
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
			END

			
		IF @Injection= 1
			BEGIN
			SET @msg =' Injection therapy'
			SET @Details = ''
			IF @InjectionVolume > 0 SET @Details = @Details + '  ' + cast(@InjectionVolume as varchar(50)) + 'ml'
			IF @InjectionVolume > 0  AND @InjectionType > 0 SET @Details = @Details + ' of'
			IF @InjectionType > 0 SET @Details = @Details + ' ' +   (SELECT [ListItemText] FROM dbo.ERS_Lists WHERE ListDescription = 'Agent Upper GI' AND [ListItemNo] = @InjectionType)
			IF @InjectionVolume> 0  AND @InjectionNumber > 0 SET @Details = @Details + ' via'
			IF @InjectionNumber >0 SET @Details = @Details + ' ' + CASE WHEN @InjectionNumber > 1 THEN cast(@InjectionNumber as varchar(50)) + ' injections' ELSE cast(@InjectionNumber as varchar(50)) + ' injection' END
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
	    IF @Homeostasis = 1
			BEGIN
			SET @msg =' Haemostasis'
			SET @Details = ''
			IF @HomeostasisType > 0 SET @Details = @Details + ' ' +   (SELECT [ListItemText] FROM dbo.ERS_Lists WHERE ListDescription = 'Homeostasis' AND [ListItemNo] = @HomeostasisType)
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
	
		IF @Polypectomy= 1  
			BEGIN
			SET @msg =' Polypectomy'
			SET @Details = ''
			DECLARE @Se bit, @SeExcised int, @Pe bit, @PeExcised int, @Su bit, @SuExcised int, @countExcised int = 0
			SELECT @Se = [Sessile],@SeExcised =[SessileNumExcised], @Pe = [Pedunculated], @PeExcised= [PedunculatedNumExcised], @Su =[Submucosal], @SuExcised = [SubmucosalNumExcised] FROM [ERS_UpperGIAbnoPolyps] WHERE SiteId =@SiteId
			IF @Se =1 AND @SeExcised <> null SET @countExcised= @countExcised + @SeExcised 
			IF  @Pe = 1 AND @PeExcised <> null SET @countExcised= @countExcised + @peExcised
			IF  @Su = 1 AND @suExcised <> null SET @countExcised= @countExcised + @suExcised

			IF @countExcised > 0 SET @Details = @Details + cast(@countExcised as varchar(50)) +' excised '

			IF @PolypectomyRemoval <> 0 OR @PolypectomyRemovalType <> 0
			BEGIN
			SET @Details = @Details + '('
            IF @PolypectomyRemoval = 1 SET @Details = @Details + 'removed entirely ' ELSE IF @PolypectomyRemoval = 2 SET @Details = @Details + 'removed piecemeal '
			IF @PolypectomyRemovalType = 1 SET @Details = @Details + ' using partial snare'
			ELSE IF  @PolypectomyRemovalType = 2 SET @Details = @Details + 'using cold snare'
			ELSE IF  @PolypectomyRemovalType = 3 SET @Details = @Details + 'using hot snare cauterisation'
			ELSE IF  @PolypectomyRemovalType = 4 SET @Details = @Details + 'using hot biopsy'
			ELSE IF  @PolypectomyRemovalType = 5 SET @Details = @Details + 'using cold biopsy'
			ELSE IF  @PolypectomyRemovalType = 6 SET @Details = @Details + 'using hot snare EMR'
			ELSE IF  @PolypectomyRemovalType = 7 SET @Details = @Details + 'using cold snare by EMR'
			SET @Details = @Details + ')'
			END

			If @Details<>'' SET @msg = @msg + ': ' + @Details
				--Add full stop 
				SET @msg = RTrim(LTRIM(@msg))
				IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
				--------------
				SET @summary = @summary + @msg + @br
			exec specimens_ogd_summary_update @SiteId
		END

		IF @BandingPiles= 1
		BEGIN 
			SET @msg = CASE WHEN @BandingNum > 1 THEN ': ' + CAST(@BandingNum as varchar(5)) + ' bands'
							WHEN @BandingNum = 1 THEN ': ' + CAST(@BandingNum as varchar(5)) + ' band'
							ELSE ''
						END
			--Add full stop 
			SET @msg = 'Banding of piles' + RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

	
		IF @Diathermy = 1
		BEGIN
			SET @msg = ' Diathermy'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg 
		--------------  
		if @DiathermyWatt <> 0 Set @msg =   ' ' + @msg + ' ' + cast(@DiathermyWatt as varchar(10)) + ' Watt.'

		SET @summary = @summary + @msg + @br  
		END  

		
		
		IF @Diverticulotomy = 1
			BEGIN
			SET @msg =' Diverticulotomy'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		
		
		IF @GastricBalloonInsertion = 1
			BEGIN
			SET @msg =' Gastric balloon insertion'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
  
	-- ## Valve
	  IF @Valve = 1  
	  BEGIN  
	   SET @msg = 'Valve'  
	   if @ValveQty <> 0 Set @msg2 = ' ' + cast(@ValveQty as varchar(10))
	   if @ValveType <> 0 Set @msg2 = @msg2 + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'BRT Valve Type' AND [ListItemNo] = @ValveType)  
	   Set @msg2 = ltrim(rtrim(@msg2))
	   if @msg2 <> '' Set @msg = @msg2 + ' Valve.' else Set @msg = 'Valve.'

	   SET @summary = @summary + @msg +  @br  
	  END

	  --- ### Cryotherapy and PhotoDynamicTherapy
	  Set @msg = ''
	  set @msg2 = ''
	  if @Cryotherapy = 1 Set @msg2 = 'Cryotherapy'
	  if @PhotoDynamicTherapy = 1 
	  Begin
		if @msg2 <> '' Set @msg = @msg2 + ' and Photodynamic Therapy have been used.' else set @msg = 'Photodynamic Therapy has been used.'
	  end
	  else
	  begin
		if @msg2 <> '' Set @msg = @msg2 + ' has been used.'
	  end
	  if @msg <> '' Set @summary = @summary + @msg + @br

		-- ## Coil
		IF @Coil = 1  
		BEGIN  
		SET @msg = 'Coil'  
		if @CoilQty <> 0 Set @msg2 = ' ' + cast(@CoilQty as varchar(10))
		if @CoilType <> 0 Set @msg2 = @msg2 + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'BRT Coil Type' AND [ListItemNo] = @CoilType)  
		Set @msg2 = ltrim(rtrim(@msg2))
		if @msg2 <> '' Set @msg = @msg2 + ' Coil.' else Set @msg = 'Coil.'

			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @BicapElectro = 1
		BEGIN
			SET @msg = ' Bicap electrocautery'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @HeatProbe = 1
		BEGIN
			SET @msg = ' Heater probe coagulation'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		--IF @BallDil = 1
		--	BEGIN
		--	SET @msg = ' Balloon dilatation'
		--	--Add full stop 
		--	SET @msg = RTrim(LTRIM(@msg))
		--	IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
		--	--------------
		--	SET @summary = @summary + @msg + @br
		--END
		
		IF @HotBiopsy = 1
		BEGIN
			SET @msg = ' Hot biopsy'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
		IF @BandLigation = 1
		BEGIN			
			SET @msg = ' Band ligation'
			IF @BandLigationPerformed > 0 SET @msg = @msg + ' performed ' + CAST(@BandLigationPerformed AS VARCHAR(100)) + CASE WHEN @BandLigationPerformed = 1 THEN ' procedure' ELSE ' procedures' END
			IF @BandLigationPerformed > 0 AND @BandLigationSuccess > 0 SET @msg = @msg + ' and ' + CAST(@BandLigationSuccess AS VARCHAR(100)) + CASE WHEN @BandLigationPerformed = 1 THEN ' was successful.' ELSE ' were successful.' END 
				ELSE IF @BandLigationPerformed = 0 AND @BandLigationSuccess > 0 SET @msg = @msg + ' ' + CAST(@BandLigationSuccess AS VARCHAR(100)) + CASE WHEN @BandLigationPerformed = 1 THEN ' procedure was successful.' ELSE ' procedures were successful.' END 
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br			
		END

		IF @BalloonDilation = 1
		BEGIN
			SET @msg = ' Balloon Dilation'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @BotoxInjection = 1
		BEGIN
			SET @msg = ' Botox injection'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @EndoscopicResection = 1
		BEGIN
			SET @msg = ' Endoscopic resection'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		-------------------------------
        -- FNA
        -------------------------------
		IF @FineNeedleAspiration= 1
		BEGIN
			SET @msg =' FNA'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		-------------------------------
        -- FNB
        -------------------------------
		IF @FineNeedleBiopsy= 1
		BEGIN
			SET @msg =' FNB'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @EndoloopPlacement = 1
		BEGIN
			SET @msg = ' Endoloop placement'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @ForeignBody = 1
		BEGIN
			SET @msg = ' Foreign body removal'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @StentInsertion= 1
			BEGIN
			SET @msg =' Stent insertion'
			SET @Details = ''
			IF @StentInsertionQty > 0 SET @Details = @Details + '  ' + cast(@StentInsertionQty as varchar(50))
			IF @StentInsertionType > 0 
				BEGIN
				IF @Area = 'Oesophagus'	 SET @Details = @Details + ' ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Therapeutic Stent Insertion Types' AND [ListItemNo] = @StentInsertionType)
				ELSE SET @Details = @Details + ' ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Therapeutic Stomach Stent Insertion Types' AND [ListItemNo] = @StentInsertionType)
				END	
			IF @StentInsertionLength > 0 AND @StentInsertionDiameter > 0 
				BEGIN
				SET @Details = @Details + ' (' 
				IF @StentInsertionLength > 0 SET @Details = @Details + ' length ' + cast(@StentInsertionLength as varchar(50)) + 'cm'
				IF @StentInsertionDiameter > 0 SET @Details = @Details + ', ' 
				SET @Details = @Details + ' diameter ' + cast(@StentInsertionDiameter as varchar(50))
				IF @StentInsertionDiameterUnits >= 0 SET @Details = @Details+ ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Oesophageal dilatation units' AND [ListItemNo] = @StentInsertionDiameterUnits)
				SET @Details = @Details + ')' 
				END
			IF @StentInsertionBatchNo <> ''  SET @Details = @Details + ' batch ' + LTRIM(RTRIM(@StentInsertionBatchNo))
			
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @StentRemoval= 1
			BEGIN
			SET @msg =' Stent removal'
			SET @Details = ''
			IF @StentRemovalTechnique > 0  SET @Details = @Details + 'using ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Therapeutic Stent Removal Technique' AND [ListItemNo] = @StentRemovalTechnique)
			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @EMR= 1
			BEGIN
			IF @EMRType = 3
				SET @msg =' Endoscopic full thickness resection'
			ELSE IF @EMRType = 2
				SET @msg =' Endoscopic submucosal dissection'
			ELSE IF @EMRType = 1
				SET @msg =' Endoscopic mucosal resection'
			SET @Details = ''
			IF @EMRFluid > 0  SET @Details = @Details + 'using ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Therapeutic EMR Fluid' AND [ListItemNo] = @EMRFluid)
			IF @EMRFluidVolume >0 
				BEGIN
				IF @EMRFluid >0 SET  @Details = @Details + ', '
				SET  @Details = @Details + 'total volume ' + cast(@emrfluidvolume AS varchar(50)) + 'ml'
				END
			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		
		IF @OesophagealDilatation= 1
			BEGIN
			SET @msg =' Oesophageal dilatation'
			SET @Details = ''
			IF @DilatedTo > 0  SET @Details = @Details + ' dilated to ' + cast(@dilatedto as varchar(50)) +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Oesophageal dilatation units' AND [ListItemNo] = @DilatationUnits)
			IF @DilatorType > 0
				BEGIN
				DECLARE @DilatorStr varchar(500) = (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Oesophageal dilator' AND [ListItemNo] = @DilatorType)
				IF @DilatorStr like 'with%' OR @DilatorStr like 'by%'  SET @Details = @Details + ' ' +  @DilatorStr
				ELSE SET @Details = @Details + ' with ' +  @DilatorStr
				END
			IF @DilatorScopePass = 1 
			BEGIN
				SET @Details = @Details + '(scope could pass)'
			END
			
			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @VaricealSclerotherapy= 1
			BEGIN
			SET @msg =' Oesophagus variceal sclerotherapy'
			SET @Details = ''
			IF @VaricealSclerotherapyInjectionVol > 0  SET @Details = @Details + ' ' + cast(@VaricealSclerotherapyInjectionVol as varchar(50)) + 'ml' 
			IF @VaricealSclerotherapyInjectionVol > 0 AND  @VaricealSclerotherapyInjectiontype > 0  SET @Details = @Details + ' of'
			IF @VaricealSclerotherapyInjectiontype > 0 SET @Details = @Details + ' ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Agent Upper GI' AND [ListItemNo] = @VaricealSclerotherapyInjectiontype)
			IF @VaricealSclerotherapyInjectionVol > 0 AND  @VaricealSclerotherapyInjectionNum > 0  SET @Details = @Details + ' via'
			IF @VaricealSclerotherapyInjectionNum > 0 SET @Details = @Details + ' ' + CASE WHEN @VaricealSclerotherapyInjectionNum >1 THEN CAST(@VaricealSclerotherapyInjectionNum as varchar(50))+' injections' ELSE  CAST(@VaricealSclerotherapyInjectionNum as varchar(50))+' injection' END
			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @VaricealBanding= 1
			BEGIN
			IF @Area ='Oesophagus' SET @msg =' Oesophagus variceal banding' ELSE SET @msg =' Gastric variceal banding'
			SET @Details = ''
			IF @VaricealBandingNum > 0 SET @Details = @Details + ' ' + CASE WHEN @VaricealBandingNum >1 THEN CAST(@VaricealBandingNum as varchar(50))+' bands' ELSE  CAST(@VaricealBandingNum as varchar(50)) + ' band' END
			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @RFA = 1
			BEGIN
			SET @msg =' Radio Frequency Ablation'
			SET @Details = ''
			IF @RFAType = 1	SET @Details = @Details + ' circumferential'
			ELSE IF @RFAType = 2 SET @Details = @Details + ' focal'
			IF ISNULL(@RFAEnergyDel,0) <> 0 SET @Details = @Details + ', ' + cast(@RFAEnergyDel as varchar(50)) + ' joules'
			IF ISNULL(@RFANumSegTreated,0) <> 0
				BEGIN
				SET @Details = @Details + ' delivered to ' + cast(@RFANumSegTreated as varchar(50))
				IF @RFAType =1 SET @Details = @Details + ' x 3cm'
				SET @Details = @Details + ' segment'
				IF @RFANumSegTreated > 1 SET @Details = @Details + 's'
				END
			IF ISNULL(@RFANumTimesSegTreated,0)<>0
				BEGIN
				SET @Details = @Details + ', treated '
				If @RFANumTimesSegTreated = 1 SET @Details = @Details + 'once'
				ELSE SET @Details = @Details + cast(@RFANumTimesSegTreated as varchar(50)) + ' times'
				END
			IF ISNULL(@RFATreatmentFrom,0) <>0 OR ISNULL(@RFATreatmentTo,0) <>0
				BEGIN
				IF ISNULL(@RFATreatmentFrom,0) <> 0  SET @Details = @Details + ', starting at ' + cast(@RFATreatmentFrom as varchar(50)) +' cm'
				IF ISNULL(@RFATreatmentTo,0) <> 0 
				BEGIN
				IF ISNULL(@RFATreatmentFrom,0) <> 0 SET @Details = @Details + ' and ending at ' + cast(@RFATreatmentTo as varchar(50)) +' cm'
				ELSE  SET @Details = @Details + ' ending at ' + cast(@RFATreatmentTo as varchar(50)) +' cm'
				END
				SET @Details = @Details + ' from the incisors'
				END				

			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @GastrostomyInsertion =1
			BEGIN
			DECLARE @G bit, @J bit, @N bit
			SELECT @j = i.[JejunostomyInsertion], @G =i.[GastrostomyInsertion],@N = i.[NasoDuodenalTube] FROM [ERS_UpperGIIndications] i LEFT JOIN [ERS_Sites] s ON i.ProcedureId = s.ProcedureId WHERE s.SiteId = @SiteID
			IF @N = 1 SET @msg =' Nasojejunal tube (NJT)' ELSE IF @J= 1 SET @msg =' Jejunostomy insertion (PEJ)' ELSE SET @msg =' Gastrostomy insertion (PEG)'
			SET @Details = ''

			IF @GastrostomyInsertionType > 0
				BEGIN
				IF @GastrostomyInsertionSize>0
					BEGIN
					SET @Details = @Details + cast(@GastrostomyInsertionSize as varchar(50))
					IF @J=1 SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG units' AND [ListItemNo] = @GastrostomyInsertionUnits)
					ELSE IF @N =1 SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG units' AND [ListItemNo] = @GastrostomyInsertionUnits)
					ELSE SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG units' AND [ListItemNo] = @GastrostomyInsertionUnits)
					END
				END
				IF @GastrostomyInsertionType>0
						BEGIN
						IF @J=1 SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG type' AND [ListItemNo] = @GastrostomyInsertiontype)
						ELSE IF @N =1 SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG type' AND [ListItemNo] = @GastrostomyInsertiontype)
						ELSE SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG type' AND [ListItemNo] = @GastrostomyInsertiontype)
						END
				IF ISNULL(@GastrostomyInsertionBatchNo, '') <> ''  SET @Details = @Details + ' batch ' + @GastrostomyInsertionBatchNo
				
				IF @CorrectPEGPlacement = 2 SET @Details = @Details + ' incorrectly placed ' + isnull(@PEGPlacementFailureReason, '')
				    
				
				IF @Details<>'' SET @msg = @msg + ': ' + @Details
				--Add full stop 
				SET @msg = RTrim(LTRIM(@msg))
				IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
				--------------
				SET @summary = @summary + @msg + @br
				END

		IF @GastrostomyRemoval = 1
		BEGIN
			SET @msg =' Gastrostomy PEG Removal'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		IF @PyloricDilatation= 1
		BEGIN
			SET @msg =' Pyloric dilatation'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @NGNJInsertion = 1 
		BEGIN
			Set @msg = ' NG/NJ tube insertion'
			IF isnull(@NGNJTubeBatch, '') <> '' 
				SET @msg = @msg + ' (batch ' + @NGNJTubeBatch + ')'
			IF isnull(@NGNJTubeLength, 0) > 0
			BEGIN
				SET @msg = @msg + '. Tube length ' + convert(varchar, @NGNJTubeLength) + 'cm'
				IF isnull(@NGNJTubeNostril, 0) > 0
				BEGIN
					SELECT @msg = @msg + CASE WHEN @NGNJTubeNostril = 1 THEN ' at the right nostril'
											  WHEN @NGNJTubeNostril = 2 THEN ' at the left nostril'
										 END
				END
			END
			ELSE
			BEGIN
				IF isnull(@NGNJTubeNostril, 0) > 0
				BEGIN
					SELECT @msg = @msg + CASE WHEN @NGNJTubeNostril = 1 THEN ' via the right nostril'
											  WHEN @NGNJTubeNostril = 2 THEN ' via the left nostril'
										 END
				END
			END
			IF isnull(@NGNJTubeBridle, 0) = 1 
				SET @msg = @msg + ', bridle used'

			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @pHProbeInsert= 1
			BEGIN
			SET @msg =' pH probe insertion'
			SET @Details = ''
			IF @pHProbeInsertAt > 0 SET @Details = @Details + ' inserted at ' + CAST(@pHProbeInsertAt as varchar(50))+' cm'
			IF ISNULL(@pHProbeInsertChkTopTo,0) <> 0 
			BEGIN
				IF @Details <> '' SET @Details = @Details + ', '
				SET @Details = @Details + 'endoscopic check performed, top of probe at ' + CAST(@pHProbeInsertChkTopTo as varchar(50))+' cm'
			END
			--ELSE  SET @Details = @Details + ', insertion checked endoscopically'

			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @Haemospray= 1
		BEGIN
			SET @msg =' Haemospray'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @Sigmoidopexy= 1
		BEGIN
			
			SET @msg =' Sigmoidopexy'
			SET @Details = ''
			IF @SigmoidopexyQty > 0 SET @Details = @Details + CONVERT(VARCHAR, @SigmoidopexyQty)
			IF @SigmoidopexyMake > 0 SET @Details = @Details + ' ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Sigmoidopexy make' AND [ListItemNo] = @SigmoidopexyMake)

			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @Marking= 1
		BEGIN
			--MH added on 19 Oct 2021
			Declare @TattoLocationMessage varchar(50)
			Declare @TattoMessage varchar(100)
			declare @MaxId int, @MinId int, @loopCounter int

			Set @TattoLocationMessage = ''
			Set @TattoMessage = ''
			If @TattooLocationDistal > 0 
			Begin
				Set @TattoLocationMessage = 'Distal'
			End

			If @TattooLocationProximal > 0 
			Begin
				if @TattoLocationMessage = ''			
					begin
						Set @TattoLocationMessage = 'Proximal'
					end
				else
					begin
						Set @TattoLocationMessage = @TattoLocationMessage + ',Proximal'
					end		
			End

			Select @MinId = Min(id),@MaxId=Max(id) from fnSplitString(@TattoLocationMessage,',') 
			Set @loopCounter = @MinId
			While @loopCounter < (@MaxId+1)
			begin
				if @loopCounter = 1
				begin
					Set @TattoMessage = (Select Item from fnSplitString(@TattoLocationMessage,',') Where Id = @loopCounter)
				end
				else
				begin
					if @loopCounter <> @MaxId 
					begin
						Set @TattoMessage = @TattoMessage + ', ' + (Select Item from fnSplitString(@TattoLocationMessage,',') Where Id = @loopCounter)
					end
					else
					begin
						Set @TattoMessage = @TattoMessage + ' and ' + (Select Item from fnSplitString(@TattoLocationMessage,',') Where Id = @loopCounter)
					end

				end

				set @loopCounter = @loopCounter + 1
			END

			SET @msg =' Abnormality marked'
			SET @Details = ''
			IF @MarkingType > 0 SET @Details = @Details + ' by ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Abno marking' AND [ListItemNo] = @MarkingType)

			IF @Details<>'' SET @msg = @msg + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br

		END

		  If @MarkedQuantity > 0
		begin
			IF @summary <> '' SET @summary = @summary
			SET @summary = @summary + 'Total volume used ' + Convert(varchar(5),@MarkedQuantity) + ' ml.' + @br
		end
		
	  --MH added on 19 Oct 2021
	  If @TattoMessage <> ''
	  BEGIN		
		SET @summary = @summary + 'Tattoo located at ' + ISNULL(@TattoMessage, '') + @br		
	  End	  
		IF @Clip= 1
		BEGIN 
			SET @msg = CASE WHEN @ClipNum > 1 THEN  CAST(@ClipNum as varchar(5)) + ' clips'
							WHEN @ClipNum = 1 THEN  CAST(@ClipNum as varchar(5)) + ' clip'
							ELSE 'Clip'
						END
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
		IF @EndoClot = 1
		BEGIN 
			SET @msg = 'EndoClot used'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
		IF @ColonicDecompression = 1
		BEGIN 
			SET @msg = 'Colonic decompression'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
		IF @FlatusTubeInsertion = 1
		BEGIN 
			SET @msg = 'Flatus tube insertion'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
		IF @PancolonicDyeSpray = 1
		BEGIN 
			SET @msg = 'Pancolonic dye spray'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @BougieDilation = 1
		BEGIN 
			SET @msg = 'Bougie dilation'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
		IF LTRIM(RTRIM(@other)) <> ''
			BEGIN
			SET @msg =' ' + LTRIM(RTRIM(@other))
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary =  @summary + @msg  +@br
		END
		
		--Remove last <br />
		IF RIGHT(RTRIM(@summary),6) = '<br />'
		BEGIN
			SET @summary = RTRIM(@summary)
			SET @summary = LEFT(@summary, LEN(@summary) - 6)
		END

	--END
	
	-- Finally, update the summary in Therapeutics  table
	UPDATE dbo.ERS_UpperGITherapeutics 
	SET Summary=@summary 
	WHERE SiteId = @SiteId -- AND CarriedOutRole=1;	--### Summary text is Applicable only for TrainER....
	--WHERE Id = @TherapeuticId
	
	DECLARE @region VARCHAR(100)
	DECLARE @AreaNo INT
	DECLARE @insertionType VARCHAR(100)
	DECLARE @htmlAnchorCode VARCHAR(500)
	DECLARE @SummaryWithLinks VARCHAR(MAX)

	SELECT @region = CASE WHEN s.SiteNo = -77 THEN						--SiteNo is set to -77 for sites By Distance (Col & Sig only)
						CONVERT(VARCHAR,XCoordinate) +  
							CASE WHEN YCoordinate IS NULL OR YCoordinate=0 THEN ' cm' 
							ELSE (' to ' + CONVERT(VARCHAR,YCoordinate) + ' cm' ) 
							END
					ELSE (SELECT r.Region FROM ERS_Regions r WHERE r.RegionId = s.RegionId)
					END, 
			@AreaNo = ISNULL(AreaNo,0)
	FROM ERS_Sites s
	JOIN ERS_Procedures p ON s.ProcedureId = p.ProcedureId
	WHERE SiteId = @SiteId
	
	SET @htmlAnchorCode = '<a href="#" class="sitesummary" onclick="OpenSiteDetails(''' + @region + ''',' + CONVERT(VARCHAR(10),@SiteId) + ',''Therapeutic Procedures'', ''{0}'' , '''+ CONVERT(VARCHAR,@AreaNo) +  ''');">{1}</a>'

	SET @Summary = ''
	SET @SummaryWithLinks = ''
	DECLARE @SummaryHeading VARCHAR(200) = 'Post procedure patient care'
	
	IF @GastrostomyInsertion = 1
	BEGIN
		SET @insertionType = 'PEG'
		SET @SummaryHeading = 'Instructions for PEG care'
		IF @FlangePosition > 0 SET @Summary = 'Flange at ' + CONVERT(varchar, @FlangePosition) + ' cm.'
		IF @NilByMouth = 1
		BEGIN
			IF @Summary <> '' SET @Summary = @Summary + ' Nil by mouth' ELSE SET @Summary = 'Nil by mouth'
			IF @NilByMouthHrs > 0
			BEGIN
				SET @Summary = @Summary + ' for ' + CONVERT(varchar, @NilByMouthHrs)
				IF @NilByMouthHrs = 1
					SET @Summary = @Summary + ' hour'
				ELSE
					SET @Summary = @Summary + ' hours'
			END
		END
		IF @NilByProc = 1
		BEGIN
			IF @Summary <> '' SET @Summary = @Summary + ', nil by PEG' ELSE SET @Summary = 'Nil by PEG'
			IF @NilByProcHrs > 0
			BEGIN
				SET @Summary = @Summary + ' for ' + CONVERT(varchar, @NilByProcHrs)
				IF @NilByProcHrs = 1
					SET @Summary = @Summary + ' hour'
				ELSE
					SET @Summary = @Summary + ' hours'
			END
		END
		IF @Summary <> '' SET @Summary = @Summary + '.'
		IF @AttachmentToWard = 1
		BEGIN
			IF @Summary <> '' SET @Summary = @Summary + ' All attachments for feeding returned to the ward with patient.' ELSE SET @Summary = 'All attachments for feeding returned to the ward with patient.'
		END		
	END	
	ELSE
	BEGIN	
		IF @YAGLaser = 1
		BEGIN
			SET @insertionType = 'YAG'
			IF @OesoYAGNilByMouth = 1
			BEGIN
				SET @Summary = 'Nil by mouth'
				IF @OesoYAGNilByMouthHrs > 0
				BEGIN
					SET @Summary = @Summary + ' for ' + CONVERT(varchar, @OesoYAGNilByMouthHrs)
					IF @OesoYAGNilByMouthHrs = 1
						SET @Summary = @Summary + ' hour'
					ELSE
						SET @Summary = @Summary + ' hours'
				END
			END

			IF @OesoYAGWarmFluids = 1
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ', warm fluids only' ELSE SET @Summary = 'Warm fluids only'
				IF @OesoYAGWarmFluidsHrs > 0
				BEGIN
					SET @Summary = @Summary + ' for ' + CONVERT(varchar, @OesoYAGWarmFluidsHrs)
					IF @OesoYAGWarmFluidsHrs = 1
						SET @Summary = @Summary + ' hour'
					ELSE
						SET @Summary = @Summary + ' hours'
				END
			END

			IF @OesoYAGSoftDiet = 1
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ', soft diet' ELSE SET @Summary = 'Soft diet'
				IF @OesoYAGSoftDietDays > 0
				BEGIN
					SET @Summary = @Summary + ' for ' + CONVERT(varchar, @OesoYAGSoftDietDays)
					IF @OesoYAGSoftDietDays = 1
						SET @Summary = @Summary + ' day'
					ELSE
						SET @Summary = @Summary + ' days'
				END
			END

			IF @Summary <> '' SET @Summary = @Summary + '.'

			IF @OesoYAGMedicalReview = 1
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ' Medical review before discharge.' ELSE SET @Summary = 'Medical review before discharge.'
			END
		END

		IF @OesophagealDilatation = 1 OR @StentInsertion = 1
		BEGIN
			SET @insertionType = 'STENT'
			IF @OesoDilNilByMouth = 1
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ' Nil by mouth' ELSE SET @Summary = 'Nil by mouth'
				IF @OesoDilNilByMouthHrs > 0
				BEGIN
					SET @Summary = @Summary + ' for ' + CONVERT(varchar, @OesoDilNilByMouthHrs)
					IF @OesoDilNilByMouthHrs = 1
						SET @Summary = @Summary + ' hour'
					ELSE
						SET @Summary = @Summary + ' hours'
				END
			END

			IF @OesoDilWarmFluids = 1
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ', warm fluids only' ELSE SET @Summary = 'Warm fluids only'
				IF @OesoDilWarmFluidsHrs > 0
				BEGIN
					SET @Summary = @Summary + ' for ' + CONVERT(varchar, @OesoDilWarmFluidsHrs)
					IF @OesoDilWarmFluidsHrs = 1
						SET @Summary = @Summary + ' hour'
					ELSE
						SET @Summary = @Summary + ' hours'
				END
			END

			IF @OesoDilSoftDiet = 1
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ', soft diet' ELSE SET @Summary = 'Soft diet'
				IF @OesoDilSoftDietDays > 0
				BEGIN
					SET @Summary = @Summary + ' for ' + CONVERT(varchar, @OesoDilSoftDietDays)
					IF @OesoDilSoftDietDays = 1
						SET @Summary = @Summary + ' day'
					ELSE
						SET @Summary = @Summary + ' days'
				END
			END

			IF @OesoDilXRay = 1
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ', chest X-ray' ELSE SET @Summary = 'Chest X-ray'
				IF @OesoDilXRayHrs > 0
				BEGIN
					SET @Summary = @Summary + ' after ' + CONVERT(varchar, @OesoDilXRayHrs)
					IF @OesoDilXRayHrs = 1
						SET @Summary = @Summary + ' hour'
					ELSE
						SET @Summary = @Summary + ' hours'
				END
			END

			IF @Summary <> '' SET @Summary = @Summary + '.'

			IF @OesoDilMedicalReview = 1
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ' Medical review before discharge.' ELSE SET @Summary = 'Medical review before discharge.'
			END
		END

		IF @Sigmoidopexy= 1
		BEGIN
			SET @SummaryHeading = 'Ward instructions'
			IF ISNULL(@SigmoidopexyFluidsDays,0) > 0
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ' '
				SET @Summary = @Summary + 'Clear fluids for ' + CONVERT(varchar, @SigmoidopexyFluidsDays) 
								+ CASE WHEN @SigmoidopexyFluidsDays > 1 THEN ' days.' else ' day.' END
			END
			IF ISNULL(@SigmoidopexyAntibioticsDays,0) > 0
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ' '
				SET @Summary = @Summary + 'Antibiotics for ' + CONVERT(varchar, @SigmoidopexyAntibioticsDays) 
								+ CASE WHEN @SigmoidopexyAntibioticsDays > 1 THEN ' days.' ELSE ' day.' END
			END
		END
	END

	IF @Summary = '' SET @SummaryHeading = ''

	-- Finally, update the summary in PP_InstForCare  table
	UPDATE p
	SET PP_InstForCare = @Summary
		, PP_InstForCareHeading = @SummaryHeading
		, PP_InstForCareWithLinks = REPLACE(REPLACE(@htmlAnchorCode, '{0}', @insertionType), '{1}', @Summary)
	FROM ERS_ProceduresReporting p
	INNER JOIN ERS_Sites s ON p.ProcedureId = s.ProcedureId
	WHERE s.SiteId = @SiteId;

	DROP TABLE #tmp_UpperGITherapeutics;

	DECLARE @ProcedureId INT = (SELECT ProcedureId FROM ERS_Sites WHERE SiteId = @SiteId)
	EXEC ogd_diagnoses_summary_update @ProcedureId
 END

 GO


 GO
PRINT N'  Altering [dbo].[TR_Upper_GI_Therapeutic_Delete]...';

GO
EXEC dbo.DropIfExist @ObjectName = 'TR_Upper_GI_Therapeutic_Delete',      -- varchar(100)
                     @ObjectTypePrefix = 'TR' -- varchar(5)
GO


CREATE TRIGGER [dbo].[TR_Upper_GI_Therapeutic_Delete]
ON [dbo].[ERS_UpperGITherapeutics]
AFTER DELETE
AS 
	--DECLARE @PatientNo VARCHAR(50)
	--DECLARE @EpisodeNo INT
	--DECLARE @SiteNo INT
	DECLARE @site_id INT

	--SELECT @PatientNo=[Patient No], @EpisodeNo=[Episode No], @SiteNo=[Site No] FROM DELETED
	SELECT @site_id=SiteId FROM DELETED

	EXEC ogd_kpi_stricture_perforation @site_id --Update perforation text in QA for OGD KPI

	DECLARE @ProcedureId INT = (SELECT ProcedureId FROM ERS_Sites WHERE SiteId = @site_id)
	IF @ProcedureId > 0
		EXEC ogd_diagnoses_summary_update @ProcedureId
	
	EXEC sites_summary_update @site_id

	UPDATE p
	SET PP_InstForCare = ''
		, PP_InstForCareHeading = ''
		, PP_InstForCareWithLinks = ''
	FROM ERS_ProceduresReporting p
	INNER JOIN ERS_Sites s ON p.ProcedureId = s.ProcedureId
	WHERE s.SiteId = @site_id;

GO
PRINT N'Finished updates for TFS# 3592.';

GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 15.2.24
-- TFS#	
-- Description of change
-- Change to NED sender SP to only get procedures since upgrade to v2
------------------------------------------------------------------------------------------------------------------------
GO

ALTER PROCEDURE [dbo].[usp_NEDI2_Get_Unsent_Procedures]
AS
BEGIN
	select prc.ProcedureId, createdon, prc.operatingHospitalId, ISNULL((SELECT TOP 1 ISNULL(ServiceId,'') FROM dbo.ERS_NedI2FilesLog enil WHERE enil.ProcedureID = prc.ProcedureId AND [Status] = 5),'') AS ServiceId
	From dbo.ERS_Procedures prc 
	INNER JOIN ERS_ProcedureTypes pt ON pt.ProcedureTypeId = prc.ProcedureType, ERS_SystemConfig cnfg 
		--LEFT JOIN (SELECT enil.ProcedureId, ServiceId FROM dbo.ERS_NedI2FilesLog enil WHERE [STATUS] = 5) fp ON fp.ProcedureId = ProcedureId
	where (ProcedureCompleted = 1 and cnfg.NEDEnabled = 1 and prc.operatingHospitalId = cnfg.operatingHospitalId AND pt.NedExportRequired = 1 AND ISNULL(prc.NEDExported,0) = 0) and CreatedOn >= (select min(InstallDate) from DBVersion where VersionNum like '2%')

END
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO
ALTER PROCEDURE [dbo].[patient_anti_coag_drugs_select]
(
	@ProcedureId int
)
AS
BEGIN
	SELECT 1 as AntiCoagDrugs, pd. DamagingDrugId, dd.Description
	FROM ERS_ProcedureDamagingDrugs pd
	LEFT JOIN ERS_PotentialDamagingDrugs dd on dd.UniqueId = pd.DamagingDrugId
	WHERE AntiCoag = 1
	and ProcedureId = @ProcedureID 
END
GO

Go
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Mahfuz	On 16 Feb 2024
-- TFS#	No TFS - Item 49 on V10 Spreadsheet
-- Description of change
-- Diagnoses should show as Normal if no Diagnoses information provided.
------------------------------------------------------------------------------------------------------------------------
Go

EXEC DropIfExist 'usp_PrintReport','S';
GO
CREATE PROCEDURE [dbo].[usp_PrintReport]
(
	@ProcedureId INT,
	@Group VARCHAR(10),
	@EpisodeNo INT = 0,
    @PatientComboId VARCHAR(30) = NULL,
    @ProcedureType INT,
    @ColonType INT
)
AS
/*
	16 Feb 2024			:		MH added Diagnoses Colon normal if no Diagnoses provided
*/
SET NOCOUNT ON

	CREATE TABLE #Summary_Main (NodeName VARCHAR(200), NodeSummary NVARCHAR(MAX) ,[Group] VARCHAR(10))

	INSERT INTO #Summary_Main
	EXEC usp_PrintReport_Select @ProcedureId, @Group, @EpisodeNo, @PatientComboId, @ProcedureType, @ColonType
	
	--FOR EUS-HPB
	IF @Group = 'LS' AND @EpisodeNo > 0 AND @ProcedureType = 7 -- ONLY for EUS-HPB (ERCP Report should include OGD, upper tract findings)
	BEGIN
		CREATE TABLE #Summary_UpperTract (NodeName VARCHAR(200), NodeSummary NVARCHAR(MAX) ,[Group] VARCHAR(10))

		INSERT INTO #Summary_UpperTract
		EXEC usp_PrintReport_Select @ProcedureId, @Group, @EpisodeNo, @PatientComboId, 1, @ColonType

		IF (SELECT COUNT(*) FROM #Summary_UpperTract WHERE LTRIM(RTRIM(NodeSummary)) <> '') > 0
		BEGIN
			INSERT INTO #Summary_Main
			SELECT '', '<br /><u style="color:#bf4040;font-weight:bold;">Within the limitations of a side-viewing scope the following upper tract findings were observed.</u>', @Group
			UNION ALL
			SELECT * FROM #Summary_UpperTract
		END
		DROP TABLE #Summary_UpperTract
	END

	declare @ProcedureTypeId int
	Declare @ProcedureTypeName varchar(100)

	Select @ProcedureTypeId = PR.ProcedureType, @ProcedureTypeName = PT.ProcedureType
		from ERS_Procedures PR
		inner join ERS_ProcedureTypes PT on PR.ProcedureType = PT.ProcedureTypeId
		Where ProcedureId = @ProcedureId
	IF @Group = 'LS' and @ProcedureTypeId = 3 --Can be used for any other Procedure types as well
		declare @DiagnosesNormalText as varchar(50) = @ProcedureTypeName + ' normal'
		Begin
			If not exists(Select * from #Summary_Main Where NodeName = 'Diagnoses')
		Begin
			Insert into #Summary_Main(NodeName,NodeSummary,[Group]) Values('Diagnoses',@DiagnosesNormalText,'LS')
		End
		Else if Exists(Select * from #Summary_Main Where NodeName = 'Diagnoses' and IsNull(NodeSummary,'') = '')
		Begin
			Update #Summary_Main Set NodeSummary = @DiagnosesNormalText
			Where NodeName = 'Diagnoses' and IsNull(NodeSummary,'') = ''
		End
	End

	SELECT * FROM #Summary_Main WHERE NodeSummary IS NOT NULL

	DROP TABLE #Summary_Main
Go
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	No TFS - Item 49 on V10 Spreadsheet by Mahfuz
------------------------------------------------------------------------------------------------------------------------
Go

Go
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Steve	On 19 Feb 2024
-- TFS#	No TFS - Item 8 on V10 Spreadsheet
-- Description of change
-- Scheduler disappearing appointments/slots
------------------------------------------------------------------------------------------------------------------------
GO
EXEC dbo.DropIfExist @ObjectName = 'sch_search_available_slots',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[sch_search_available_slots]
(
	@ProcedureTypes varchar(100) = NULL,
	@TherapeuticTypes AS varchar(100) = NULL,
	@Slots varchar(100) = NULL,
	@Endoscopist varchar(100) = NULL,
	@SearchStartDate datetime,
	@OperatingHospitalIDs as varchar(100),
	@ExcludeTraining bit
)
AS



	IF OBJECT_ID('tmpdb..#tmpEndos') IS NOT NULL DROP TABLE #tmpEndos
	SELECT * INTO #tmpEndos FROM fnSplitString(@Endoscopist, ',')

	IF OBJECT_ID('tmpdb..#tmpProcTypes') IS NOT NULL DROP TABLE #tmpProcTypes
	SELECT * INTO #tmpProcTypes FROM fnSplitString(ISNULL(@ProcedureTypes,''), ',')

	IF OBJECT_ID('tmpdb..#tmpProcTherapTypes') IS NOT NULL DROP TABLE #tmpProcTherapTypes
	SELECT * INTO #tmpProcTherapTypes FROM fnSplitString(ISNULL(@TherapeuticTypes,''), ',')

	IF OBJECT_ID('tmpdb..#tmpSlotTypes') IS NOT NULL DROP TABLE #tmpSlotTypes
	SELECT * INTO #tmpSlotTypes FROM fnSplitString(ISNULL(@Slots,''), ',')

	IF OBJECT_ID('tmpdb..#tmpOperatingHospitals') IS NOT NULL DROP TABLE #tmpOperatingHospitals
	SELECT * INTO #tmpOperatingHospitals FROM fnSplitString(ISNULL(@OperatingHospitalIDs,''), ',')



	SELECT DISTINCT
		d.DiaryId,
		d.DiaryStart,
		d.[DiaryEnd],
		d.[UserID], 
		d.[RoomID], 
		d.ListRulesId, 
		s.SlotMinutes AS [Minutes],
		CASE WHEN ept.ProcedureType IS NULL THEN ss.Description 
		ELSE 'Reserved for ' + ss.Description + ' '+ ept.ProcedureType END AS [Subject],
		ss.Description,
		ISNULL(s.ProcedureTypeID,0) AS ProcedureTypeID,
		ISNULL(ept.ProcedureType, '') AS ProcedureType,
		s.ListSlotId,
		ss.ForeColor,
		ss.StatusId,
		ISNULL(s.Points, 1) AS Points,
		ISNULL(d.UserID,0) AS EndoscopistId,
		(CASE WHEN  ISNULL(u.Title,'') <> '' THEN u.Title + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(u.Forename,'') <> '' THEN u.Forename + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(u.Surname,'') <> '' THEN u.Surname + ' ' ELSE '' END) AS EndoscopistName,
	  (CASE WHEN  ISNULL(c.Title,'') <> '' THEN c.Title + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(c.Forename,'') <> '' THEN c.Forename + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(c.Surname,'') <> '' THEN c.Surname + ' ' ELSE '' END) AS ListConsultant,
		l.ListName,
		(CASE WHEN  ISNULL(u.Title,'') <> '' THEN u.Title + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(u.Forename,'') <> '' THEN u.Forename + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(u.Surname,'') <> '' THEN u.Surname + ' ' ELSE '' END) +
	  '  [' + CONVERT(VARCHAR(5),CAST(d.DiaryStart AS TIME)) + '-' + CONVERT(VARCHAR(5),CAST(d.[DiaryEnd] AS TIME)) + ']' +
	  CASE WHEN  ISNULL(l.Points,0) <> 0 THEN '  [' + CONVERT(VARCHAR, l.Points) + ' slots]' ELSE '' END  AS ListDescription
		,d.suppressed
		,d.SuppressedFromDate
		,d.Training
		,l.GIProcedure
		,ISNULL(apt.AppointmentId, 0) AppointmentId
		,apt.StartDateTime AppointmentStart
		,ISNULL(apt.TotalPoints,0) AppointmentPoints
		,ISNULL(apt.AppointmentDuration,0) AppointmentDuration
		,DATEADD(minute, convert(int, apt.AppointmentDuration), apt.StartDateTime) AppointmentEnd
		,ISNULL(apt.StatusCode,'') AppointmentStatusCode
		,ISNULL(apt.Notes,'') AppointmentNotes
		,p.HospitalNumber + ' - ' + p.Forename1 + ' ' + p.Surname + '<br />' + apt.Description + ' '+ STUFF(REPLACE(apt.Procs, CHAR(10), '+'), LEN(apt.procs),1,'') AS [AppointmentSubject]
		,ISNULL(apt.GeneralInformation, '') GeneralInformation
		,s.Locked
		,d.OperatingHospitalId
		,ISNULL(d.RecurrenceParentID,0)RecurrenceParentID
		,ISNULL(d.locked,0) LockedDiary
		,ISNULL(gt.Code, '') ListGender
		,RoomName
	FROM ERS_SCH_DiaryPages d
		INNER JOIN (SELECT DISTINCT r.ListRulesId--, r.Points, r.ListName, s.SlotMinutes, s.ProcedureTypeId
						FROM dbo.ERS_SCH_ListRules r
						INNER JOIN dbo.ERS_SCH_ListSlots s ON s.ListRulesId = r.ListRulesId
						WHERE s.ProcedureTypeId IN (SELECT item FROM #tmpProcTypes) AND s.Active = 1) ls ON ls.ListRulesId = d.ListRulesId
		INNER JOIN ERS_SCH_ListRules l ON l.ListRulesId = ls.ListRulesId
		INNER JOIN ERS_SCH_ListSlots s ON ls.ListRulesId = s.ListRulesId AND s.Active = 1
		INNER JOIN dbo.ERS_SCH_SlotStatus ss ON ss.StatusId = s.SlotId
		LEFT JOIN dbo.ERS_ProcedureTypes ept ON s.ProceduretypeId = ept.ProcedureTypeId
		LEFT JOIN ERS_Users u ON u.UserID = d.UserId
		LEFT JOIN ERS_Users c ON c.UserID = d.ListConsultantId
		LEFT JOIN (SELECT ea.AppointmentId, SUM(eapt.Points) AS TotalPoints, SUM(eapt.Minutes) AS TotalMinutes, ea.ListSlotId, ea.DiaryId, MAX(aps.HDCKEY) StatusCode, ass.Description, ea.PatientId,ea.GeneralInformation, ea.Notes, ea.AppointmentDuration,ea.StartDateTime,
						(SELECT
							AppointmentProcedures + char(10) AS [text()] 
						FROM dbo.SCH_AppointmentProcedures(ea.AppointmentId)
						WHERE AppointmentId = ea.AppointmentId
						FOR XML PATH('')) AS procs
					FROM dbo.ERS_Appointments ea
						INNER JOIN dbo.ERS_AppointmentProcedureTypes eapt ON ea.AppointmentId = eapt.AppointmentID
						INNER JOIN dbo.ERS_SCH_SlotStatus ass ON ea.SlotStatusID = ass.StatusId
						LEFT JOIN ERS_AppointmentStatus aps on aps.UniqueId = ea.AppointmentStatusId
					 WHERE ISNULL(aps.HDCKEY,'') <> 'C'
					GROUP BY ea.AppointmentId, ea.ListSlotId, ea.DiaryId, ass.Description, ea.PatientId,ea.GeneralInformation, ea.Notes, ea.AppointmentDuration,ea.StartDateTime) AS apt 
											ON apt.DiaryId = d.DiaryId and  apt.ListSlotId = s.ListSlotId
		LEFT JOIN ERS_Patients p ON p.patientId = apt.PatientId
		LEFT JOIN dbo.ERS_GenderTypes gt ON gt.GenderId = d.ListGenderId
		INNER JOIN ERS_SCH_Rooms r ON r.RoomId = d.RoomID
	WHERE 
	d.Suppressed = 0 AND
	(d.DiaryStart >= @SearchStartDate) AND d.OperatingHospitalId IN (SELECT item FROM #tmpOperatingHospitals)
		--AND ((s.ProcedureTypeID IN (SELECT item FROM #tmpProcTypes)) OR ((ISNULL(@ProcedureTypes,'') = '' OR ISNULL(@ProcedureTypes,'') = '0') AND 1=1 ))
		AND ((((ISNULL(@Endoscopist,'') <> '' AND d.UserID IN (SELECT item FROM #tmpEndos)) OR (ISNULL(@Endoscopist,'') = '' AND 1=1))) OR ISNULL(d.UserID,'') ='')
		AND (s.SlotId IN (SELECT item FROM #tmpSlotTypes) OR (ISNULL(@Slots,'') = '' AND 1=1)) --if Slot type specified
		AND d.Training = CASE WHEN @ExcludeTraining = 1 THEN 0 ELSE d.Training END
		AND IsNull(d.Locked, 0) = 0  
	ORDER BY d.DiaryId, apt.StartDateTime ,s.ListSlotId
	
	
Go
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	No TFS - Item 8 on V10 Spreadsheet by Steve
------------------------------------------------------------------------------------------------------------------------
Go
