------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	
-- TFS#	
-- Description of change
-- 
------------------------------------------------------------------------------------------------------------------------
GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO

---------------------------------------------------------
-- Update script for release 2.24.03
---------------------------------------------------------
DECLARE @Version AS VARCHAR(40) = '2.24.03'

IF NOT EXISTS(SELECT * FROM DBversion WHERE VersionNum = @Version)
	BEGIN 
		-- First time the script has been run
		INSERT INTO DBVersion VALUES (@Version, GETDATE())
	END 
ELSE
	BEGIN 
		-- script run more than once
		DECLARE @DBVersionCount as INT 

		SELECT @DBVersionCount = COUNT(*) 
		FROM DBVersion WHERE VersionNum = @Version

		INSERT INTO DBVersion VALUES (@Version + ' (' + CONVERT(VARCHAR, @DBVersionCount) + ')', GETDATE())
	END 
GO
---------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rony
-- TFS#	4075
-- Description of change
-- Discomford score for General anesteic
------------------------------------------------------------------------------------------------------------------------

 IF NOT EXISTS (
        SELECT 1
        FROM INFORMATION_SCHEMA.COLUMNS
        WHERE TABLE_NAME = 'ERS_ProcedureSedationScore' AND
              COLUMN_NAME IN ('GeneralAneathetic')
    )
    BEGIN
		
		ALTER TABLE ERS_ProcedureSedationScore
            ADD GeneralAneathetic Decimal(8,2);
    END
GO
EXEC dbo.DropIfExist 
    @ObjectName = 'procedure_sedation_score_select', 
    @ObjectTypePrefix = 'S' 
GO
CREATE PROCEDURE [dbo].[procedure_sedation_score_select]
(
	@ProcedureId int
)
AS
BEGIN
	SELECT SedationScoreId, ChildId, GeneralAneathetic --Added by rony tfs-4075
	FROM ERS_ProcedureSedationScore 
	WHERE ProcedureId = @ProcedureId
END
GO
EXEC dbo.DropIfExist 
    @ObjectName = 'procedure_sedation_score_save', 
    @ObjectTypePrefix = 'S' 
GO
CREATE PROCEDURE [dbo].[procedure_sedation_score_save]
(
	@ProcedureId int,
	@SedationScoreId int,
	@ChildId int,
	@GeneralAneathetic decimal(18,2), --Added by rony tfs-4075
	@LoggedInUserId int
)
AS
BEGIN
	DECLARE @Summary VARCHAR(max) = 'Patient Sedation - ' + (SELECT Description FROM ERS_SedationScores WHERE UniqueId = @SedationScoreId) + CASE WHEN ISNULL(@ChildId,0) > 0 THEN (SELECT ' ' + Description FROM ERS_SedationScores WHERE UniqueId = @ChildId) ELSE '' END

	IF @SedationScoreId > 0
	BEGIN
		IF NOT EXISTS (SELECT 1 FROM ERS_ProcedureSedationScore WHERE ProcedureId = @ProcedureId)
		BEGIN
			INSERT INTO ERS_ProcedureSedationScore (ProcedureId, SedationScoreId, ChildId, WhoCreatedId, WhenCreated, Summary,GeneralAneathetic)--Added by rony tfs-4075
			VALUES (@ProcedureId, @SedationScoreId, @ChildId, @LoggedInUserId, getdate(), @Summary,@GeneralAneathetic)--Added by rony tfs-4075
		END
		ELSE IF EXISTS (SELECT 1 FROM ERS_ProcedureSedationScore WHERE ProcedureId = @ProcedureId AND SedationScoreId = @SedationScoreId AND ChildId <> @ChildId)
		BEGIN
			UPDATE ERS_ProcedureSedationScore
			SET ChildId = @ChildId, 
				Summary = @Summary
			WHERE ProcedureId = @ProcedureId AND
				  SedationScoreId = @SedationScoreId
		END
		ELSE
		BEGIN
			UPDATE ERS_ProcedureSedationScore
			SET SedationScoreId = @SedationScoreId,
				ChildId = @ChildId, 
				WhoUpdatedId = @LoggedInUserId,--Added by rony tfs-4075
				WhenUpdated = GETDATE(),
				Summary = @Summary,
				GeneralAneathetic = @GeneralAneathetic --Added by rony tfs-4075
			WHERE ProcedureId = @ProcedureId 
		END
	END	
END
GO
EXEC dbo.DropIfExist 
    @ObjectName = 'auditAssessmentOfComfortSummary', 
    @ObjectTypePrefix = 'S' 
GO
CREATE Procedure [dbo].[auditAssessmentOfComfortSummary]
	@UserId int
AS

/*****************************************************************************************************************
Update History:
	01		:		21 May 2024		Mostafiz TFS1811: Filter by Operating Hospital 
******************************************************************************************************************/

BEGIN
	DECLARE @FromDate as Date,
			@ToDate as Date,
			@TrustId as int,
			@OperatingHospitalList as varchar(100)  --added by mostafiz 5/21/24 Filter by Hospital TFS1811

	Select	@FromDate = FromDate,
			@ToDate = ToDate,
			@TrustId = TrustId,
			@OperatingHospitalList=OperatingHospitalList  --added by mostafiz 5/21/24 Filter by Hospital TFS1811
	FROM	ERS_ReportFilter
	where	UserID = @UserId

	Create table #comfortSummary (
		orderBy int,
		ComfortScore varchar(100),
		OGD int,
		ERCP int,
		Col int,
		Sig int,
		Proct int,
		EUSOGD int,
		EUSHPB int,
		ENT int)

	INSERT INTO #comfortSummary (orderBy, ComfortScore)
	values (0, '<b>Assessment Scores</b>')
	
	INSERT INTO #comfortSummary
	SELECT eds.ListOrderBy,
	eds.[Description] 'Comfort Score',
	COUNT(CASE WHEN ep.ProcedureType = 1 THEN ep.ProcedureId END) AS OGD,
	COUNT(CASE WHEN ep.ProcedureType = 2 THEN ep.ProcedureId END) AS ERCP,
	COUNT(CASE WHEN ep.ProcedureType = 3 THEN ep.ProcedureId END) AS Col,
	COUNT(CASE WHEN ep.ProcedureType = 4 THEN ep.ProcedureId END) AS Sig,
	COUNT(CASE WHEN ep.ProcedureType = 5 THEN ep.ProcedureId END) AS Proct,
	COUNT(CASE WHEN ep.ProcedureType = 6 THEN ep.ProcedureId END) AS EUSOGD,
	COUNT(CASE WHEN ep.ProcedureType = 7 THEN ep.ProcedureId END) AS EUDHPB,
	COUNT(CASE WHEN ep.ProcedureType IN (8,9) THEN ep.ProcedureId END) AS ENT
	  FROM dbo.ERS_Procedures ep
	join	ERS_Patients pat on ep.PatientId = pat.PatientId 
	INNER JOIN dbo.ERS_ProcedureDiscomfortScore epds ON ep.ProcedureId = epds.ProcedureId
	INNER JOIN dbo.ERS_DiscomfortScores eds ON epds.DiscomfortScoreId = eds.UniqueId
	join ERS_Users u on u.UserID = ep.Endoscopist1
	join ERS_ReportConsultants rc on u.UserID = rc.ConsultantID 
	where ep.ProcedureCompleted = 1
	and ep.IsActive = 1
	and ep.CreatedOn >= @FromDate AND ep.CreatedOn <= @ToDate
	and rc.UserID = @UserId
	--and pat.PatientId in (Select patientId from ERS_PatientTrusts where TrustId = @TrustId)  --omited by mostafiz 5/21/24 Filter by Hospital TFS1811
	AND ep.OperatingHospitalID IN (SELECT * FROM dbo.splitString(@OperatingHospitalList,',') )  --added by mostafiz 5/21/24 Filter by Hospital TFS1811
	GROUP BY eds.[Description], eds.ListOrderBy
	ORDER BY eds.ListOrderBy

	select 
	ComfortScore,
	OGD,
	ERCP,
	Col,
	Sig,
	Proct,
	EUSOGD,
	EUSHPB,
	ENT from #comfortSummary 

	--Added by rony tfs-4075
	UNION ALL

	SELECT 
	'GA section (%)' AS ComfortScore,
	SUM(CASE WHEN ep.ProcedureType = 1 THEN pss.GeneralAneathetic END) AS OGD,
	SUM(CASE WHEN ep.ProcedureType = 2 THEN pss.GeneralAneathetic END) AS ERCP,
	SUM(CASE WHEN ep.ProcedureType = 3 THEN pss.GeneralAneathetic END) AS Col,
	SUM(CASE WHEN ep.ProcedureType = 4 THEN pss.GeneralAneathetic END) AS Sig,
	SUM(CASE WHEN ep.ProcedureType = 5 THEN pss.GeneralAneathetic END) AS Proct,
	SUM(CASE WHEN ep.ProcedureType = 6 THEN pss.GeneralAneathetic END) AS EUSOGD,
	SUM(CASE WHEN ep.ProcedureType = 7 THEN pss.GeneralAneathetic END) AS EUDHPB,
	SUM(CASE WHEN ep.ProcedureType IN (8,9) THEN pss.GeneralAneathetic END) AS ENT
	FROM 
	ERS_Procedures ep
	JOIN ERS_Patients pat on ep.PatientId = pat.PatientId 
	INNER JOIN ERS_ProcedureSedationScore pss on pss.ProcedureId = ep.ProcedureId
	JOIN ERS_Users u on u.UserID = ep.Endoscopist1
	JOIN ERS_ReportConsultants rc on u.UserID = rc.ConsultantID 
	WHERE 
	ep.ProcedureCompleted = 1 AND 
	cast(ep.CreatedOn as date) BETWEEN @FromDate AND @ToDate
	AND rc.UserID = @UserId
	AND ep.OperatingHospitalID IN (SELECT * FROM dbo.splitString(@OperatingHospitalList,',') )
END
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	4075
------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rony
-- TFS#	3059
-- Description of change
-- deleting a report from - add comments box
------------------------------------------------------------------------------------------------------------------------
 IF NOT EXISTS (
        SELECT 1
        FROM INFORMATION_SCHEMA.COLUMNS
        WHERE TABLE_NAME = 'ERS_Procedures' AND
              COLUMN_NAME IN ('DeletedDate','DeleteText')
    )
    BEGIN
		
		ALTER TABLE ERS_Procedures
            ADD DeletedDate datetime,
			 DeleteText NVARCHAR(max);
    END
GO

------------------------------------------------------------------------------------------------------------------------
-- TFS#	3059 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ahmed Shoud
-- TFS#	2426
-- Description of change
-- SEv2 Bronch / EBUS technique used 
------------------------------------------------------------------------------------------------------------------------
 IF NOT EXISTS (
        SELECT 1
        FROM INFORMATION_SCHEMA.COLUMNS
        WHERE TABLE_NAME = 'ERS_Procedures' AND
              COLUMN_NAME IN ('TechniqueUsed')
    )
    BEGIN
		
		ALTER TABLE ERS_Procedures
            ADD TechniqueUsed varchar(50)
    END
GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	2426
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by : Muhammad Nasim
-- TFS# 2999
-- Description of change: Generate report in HTML
-------------------------------------------------------------------------------------------------------------------------
GO
IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ERS_PrintOptionsGPReport' AND COLUMN_NAME = 'PrintType')
BEGIN
	ALTER TABLE ERS_PrintOptionsGPReport ADD PrintType smallint default 0 null
END
GO
------------------------------------------------------------------------------------------------------------------------
-- TFS# 2999 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by : Rony
-- TFS# 4221
-- Description of change
-- PEG update
------------------------------------------------------------------------------------------------------------------------

GO
IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ERS_UpperGITherapeutics' AND
	COLUMN_NAME IN ('EndoscopistId','NurseId','GastrostomyInsertionTubeBrand','GastrostomyInsertionTubeBrandSize')
)
BEGIN
	ALTER TABLE ERS_UpperGITherapeutics
	ADD EndoscopistId INT,NurseId INT,GastrostomyInsertionTubeBrand TINYINT,GastrostomyInsertionTubeBrandSize NUMERIC(9,2)
END
GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS# 4221
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	MOSTAFIZUR RAHMAN
-- TFS#	1671
-- Description of change
-- SE Bronc return to home page issue
------------------------------------------------------------------------------------------------------------------------

EXEC dbo.DropIfExist 
    @ObjectName = 'CheckProcedureComplete', 
    @ObjectTypePrefix = 'F' 
GO
CREATE  FUNCTION dbo.CheckProcedureComplete
(
    @ProcedureId INT
)
RETURNS TINYINT
AS
BEGIN
    DECLARE @ProcedureCompleted TINYINT

    SELECT @ProcedureCompleted = ProcedureCompleted
    FROM ERS_Procedures
    WHERE ProcedureId = @ProcedureId

    RETURN ISNULL(@ProcedureCompleted, 0)
END

GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	1671 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	MOSTAFIZUR RAHMAN
-- TFS#	4240
-- Description of change
-- BowelScope no longer needed. 
------------------------------------------------------------------------------------------------------------------------

Go
DELETE FROM ERS_IndicationsProcedureTypes WHERE UniqueId IN (SELECT UniqueId FROM ERS_Indications WHERE Description in ('Bowelscope', 'Bowelscope conversion'))


GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	4240 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	: Siddik
-- TFS#	4050
-- Description of change: Add MI to Past Medical History
-------------------------------------------------------------------------------------------------------------------------

IF NOT EXISTS (SELECT 1 FROM ERS_PreviousDiseases WHERE Description = 'MI')
BEGIN
    INSERT INTO ERS_PreviousDiseases (Description, Suppressed)
    VALUES ('MI', 0);

	INSERT INTO ERS_PreviousDiseaseProcedureTypes (PreviousDiseaseId, ProcedureTypeId)
	SELECT SCOPE_IDENTITY(), ProcedureTypeId
	FROM ERS_PreviousDiseaseProcedureTypes
	GROUP BY ProcedureTypeId
END
GO

------------------------------------------------------------------------------------------------------------------------
-- TFS#	4050 END
-------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Siddik
-- TFS#	4172
-- Description of change: Radio Frequency Ablation move to planned procedure 
-------------------------------------------------------------------------------------------------------------------------

UPDATE ERS_Indications
SET IndicationSectionId = 5
WHERE Description = 'Radio frequency ablation (RFA)'
AND IndicationSectionId = 1

GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	4172 END
-------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Siddik
-- TFS#	4177
-- Description of change: Cystoscopy Planned Procedures/Indications 
-------------------------------------------------------------------------------------------------------------------------

DECLARE @CystoscopyId INT = (SELECT ProcedureTypeId FROM ERS_ProcedureTypes WHERE ProcedureType = 'Cystoscopy');
DECLARE @SectionId INT = (SELECT IndicationSectionId FROM ERS_IndicationSections WHERE SectionName = 'Planned procedures');

DECLARE @ToBeInserted TABLE (Description VARCHAR(100))

INSERT INTO @ToBeInserted (Description) 
    VALUES
    ('Incomplete emptying'),
    ('LUTS'),
    ('Haematospermia'),
    ('Sterile Pyuria'),
    ('Irritative LUTS'),
    ('Recurrent UTI and catheter blocks'),
    ('Bladder thickening on CT'),
    ('Recurrent UTI'),
    ('Recurrent suprapubic pain'),
    ('CT detected bladder lesions'),
    ('Microscopic haematuria'),
    ('Macroscopic haematuria'),
    ('Removal of JJ stent'),
    ('Possible abnormality on imaging'),
    ('UTIs recurrent');

IF NOT EXISTS (SELECT 1 FROM ERS_Indications ei INNER JOIN @ToBeInserted tbi ON ei.Description = tbi.Description AND ei.IndicationSectionId = @SectionId)
BEGIN
	INSERT INTO ERS_Indications (Description, NEDTerm, IndicationSectionId)
	OUTPUT inserted.UniqueId, @CystoscopyId INTO ERS_IndicationsProcedureTypes (IndicationId, ProcedureTypeId)
	SELECT Description, Description, @SectionId FROM @ToBeInserted;
END

IF EXISTS (SELECT 1 FROM ERS_Indications ei INNER JOIN @ToBeInserted tbi ON ei.Description = tbi.Description AND ei.IndicationSectionId <> @SectionId)
BEGIN
	DELETE eip 
	FROM ERS_IndicationsProcedureTypes eip
	INNER JOIN ERS_Indications ei ON eip.IndicationId = ei.UniqueId
	INNER JOIN @ToBeInserted tbi ON ei.Description = tbi.Description
	WHERE ei.IndicationSectionId <> @SectionId;

	DELETE ei 
	FROM ERS_Indications ei
	INNER JOIN @ToBeInserted tbi ON ei.Description = tbi.Description
	WHERE ei.IndicationSectionId <> @SectionId;
END

GO

------------------------------------------------------------------------------------------------------------------------
-- TFS#	4177 END
-------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Siddik
-- TFS#	2653
-- Description of change: EUS print report display name
-------------------------------------------------------------------------------------------------------------------------

UPDATE ERS_ProcedureTypes
SET ReportHeader = 'ENDOSCOPIC ULTRASOUND(UGI) REPORT' 
WHERE ReportHeader = 'ENDOSCOPIC ULTRASOUND(OGD) REPORT'
GO

------------------------------------------------------------------------------------------------------------------------
-- TFS#	2653 END
-------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Siddik
-- TFS#	2519
-- Description of change: Cholangioscopy type is not being shown in the report
-- Updated by	:	Rezaul
-- TFS#	2550,2551
-- Description of change: FNA options are not in the report,FNB options are not present in the report
-------------------------------------------------------------------------------------------------------------------------
GO
EXEC dbo.DropIfExist 
    @ObjectName = 'therapeutics_ercp_summary_update', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[therapeutics_ercp_summary_update]
(
	@TherapeuticId AS INT,
	@SiteId INT
)
AS
	SET NOCOUNT ON
	DECLARE	  @msg		VARCHAR(1000)
			, @Details	VARCHAR(1000)
			, @Summary	VARCHAR(4000)=''
			, @Area		VARCHAR(500)=''
			, @br VARCHAR(6) = '<br />';

	DECLARE
	@None BIT,
	@YAGLaser BIT,
	@YAGLaserWatts INT,
	@YAGLaserPulses INT,
	@YAGLaserSecs decimal(8,2),
	@YAGLaserKJ decimal(8,2),
	@ArgonBeamDiathermy BIT,
	@ArgonBeamDiathermyWatts INT,
	@ArgonBeamDiathermyPulses INT,
	@ArgonBeamDiathermySecs decimal(8,2),
	@ArgonBeamDiathermyKJ decimal(8,2),		
	@HeatProbe BIT,					
	@BicapElectro BIT,				
	@Diathermy BIT,						
	@HotBiopsy BIT,
	@BandLigation BIT,
    @BandLigationPerformed INT,
	@BandLigationSuccess INT,
	@BotoxInjection BIT,
    @EndoloopPlacement BIT,
    @ForeignBody BIT,
	@Injection BIT,
	@InjectionType INT,
	@InjectionVolume INT,
	@InjectionNumber INT,
	@GastrostomyInsertion BIT,
	@GastrostomyInsertionSize numeric(9,2),
	@GastrostomyInsertionUnits TINYINT,
	@GastrostomyInsertionType TINYINT,
	@GastrostomyInsertionBatchNo VARCHAR(100),
	@GastrostomyRemoval BIT,
	@NilByMouth BIT,
	@NilByMouthHrs INT,
	@NilByProc BIT,
	@NilByProcHrs INT,
	@AttachmentToWard BIT,
	@PyloricDilatation BIT,	
	@StentInsertion BIT,
	@StentInsertionQty INT,
	@RadioactiveWirePlaced BIT,	
	@StentInsertionBatchNo VARCHAR(100),
	@StentRemoval BIT,
	@StentRemovalTechnique INT,
	@EMR BIT,
	@EMRType TINYINT,
	@EMRFluid INT,
	@EMRFluidVolume INT,
	@Marking BIT,
	@MarkingType INT,
	@Clip BIT,						
	@ClipNum INT,
	@Papillotomy BIT,
	@Sphincterotome TINYINT,
	@PapillotomyLength REAL,
	@PapillotomyAcceptBalloonSize REAL,
	@ReasonForPapillotomy TINYINT,
	@PapillotomyBleeding TINYINT,
	@SphincterDecompressed TINYINT,
	@PanOrificeSphincterotomy BIT,
	@StoneRemoval BIT,
	@RemovalUsing TINYINT,
	@ExtractionOutcome TINYINT,
	@InadequateSphincterotomy BIT,
	@StoneSize BIT,
	@QuantityOfStones BIT,
	@ImpactedStones BIT,
	@OtherReason BIT,
	@OtherReasonText VARCHAR(200),
	@StoneDecompressed TINYINT,
	@StrictureDilatation BIT,
	@DilatedTo REAL,
	@DilatationUnits TINYINT,
	@DilatorType TINYINT,
	@EndoscopicCystPuncture BIT,
	@CystPunctureDevice TINYINT,
	@CystPunctureVia TINYINT,
	@Cannulation BIT,
	@Manometry BIT,
	@Haemostasis BIT,
	@NasopancreaticDrain BIT,
	@RendezvousProcedure BIT,
	@SnareExcision SMALLINT,
	@BalloonDilation BIT,
	@BalloonDilatedTo REAL,
	@BalloonDilatationUnits SMALLINT,
	@BalloonDilatorType SMALLINT,
	@BalloonTrawl BIT,
	@BalloonTrawlDilatorType SMALLINT,
	@BalloonTrawlDilatorSize REAL,
	@BalloonTrawlDilatorUnits SMALLINT,
	@BalloonDecompressed TINYINT,
	@DiagCholangiogram SMALLINT,
	@DiagPancreatogram SMALLINT,
	@EndoscopistRole SMALLINT,
	@Other VARCHAR(1000),
	@EUSProcType SMALLINT,
	@CorrectStentPlacement bit,
	@CorrectStentPlacementNoReason int,
	@BalloonDilatation bit,
	@BougieDilatation bit,
	@BougieDilation bit,
	@BrushCytology bit,
	@Cholangioscopy bit,
	@CholangioscopyType TINYINT,
	@StentChange bit,
	@StentPlacement bit,
	@RadioFrequencyAblation bit,
	@FineNeedleAspiration bit,
	@FineNeedleAspirationType tinyint,
	@FineNeedleBiopsy BIT,
	@Polypectomy BIT,
	@Diverticulotomy BIT,
	@Homeostasis BIT,
	@HomeostasisType INT,
	@FNAPerformed INT, --2550
	@FNARetrieved INT, --2550
	@FNASuccessful INT,  --2550
	@FNBPerformed INT,    --2551
	@FNBRetrieved INT,   --2551
	@FNBSuccessfull INT  --2551

--BEGIN TRY

	SELECT * INTO #tmp_ERCPTherapeutics 
	FROM dbo.ERS_ERCPTherapeutics 
	WHERE (Id = @TherapeuticId OR SiteID = @SiteId)

--## 1) If 'CarriedOutRole=2 (EE)' record is found for a SiteId in [ERS_ERCPTherapeutics] means it has both EE/ER Entries...
	--IF EXISTS(SELECT 'ER' FROM dbo.ERS_ERCPTherapeutics WHERE SiteId=@SiteId AND CarriedOutRole=2)
		BEGIN
			--PRINT '[ERS_ERCPTherapeutics] has both EE/ER Entries...';
			;WITH eeRecord AS(
				SELECT * FROM #tmp_ERCPTherapeutics WHERE CarriedOutRole = (SELECT MAX(CarriedOutRole) FROM #tmp_ERCPTherapeutics) --## 2 is EE
			)
			SELECT
				@None				= (CASE WHEN IsNull(ER.[None], 0) = 0 THEN EE.[None] ELSE ER.[None] END),
				@YAGLaser			= (CASE WHEN IsNull(ER.YAGLaser, 0) = 0 THEN EE.YAGLaser ELSE ER.YAGLaser END),
				@YAGLaserWatts		= (CASE WHEN IsNull(ER.YAGLaserWatts, 0) = 0 THEN EE.YAGLaserWatts ELSE ER.YAGLaserWatts END),
				@YAGLaserPulses		= (CASE WHEN IsNull(ER.YAGLaserPulses, 0) = 0 THEN EE.YAGLaserPulses ELSE ER.YAGLaserPulses END),
				@YAGLaserSecs		= (CASE WHEN IsNull(ER.YAGLaserSecs, 0) = 0 THEN EE.YAGLaserSecs ELSE ER.YAGLaserSecs END),
				@YAGLaserKJ			= (CASE WHEN IsNull(ER.YAGLaserKJ, 0) = 0 THEN EE.YAGLaserKJ ELSE ER.YAGLaserKJ END),
				@ArgonBeamDiathermy	= (CASE WHEN IsNull(ER.ArgonBeamDiathermy, 0) = 0 THEN EE.ArgonBeamDiathermy ELSE ER.ArgonBeamDiathermy END),
				@ArgonBeamDiathermyWatts		= (CASE WHEN IsNull(ER.ArgonBeamDiathermyWatts, 0) = 0 THEN EE.ArgonBeamDiathermyWatts ELSE ER.ArgonBeamDiathermyWatts END),
				@ArgonBeamDiathermyPulses		= (CASE WHEN IsNull(ER.ArgonBeamDiathermyPulses, 0) = 0 THEN EE.ArgonBeamDiathermyPulses ELSE ER.ArgonBeamDiathermyPulses END),
				@ArgonBeamDiathermySecs			= (CASE WHEN IsNull(ER.ArgonBeamDiathermySecs, 0) = 0 THEN EE.ArgonBeamDiathermySecs ELSE ER.ArgonBeamDiathermySecs END),
				@ArgonBeamDiathermyKJ			= (CASE WHEN IsNull(ER.ArgonBeamDiathermyKJ, 0) = 0 THEN EE.ArgonBeamDiathermyKJ ELSE ER.ArgonBeamDiathermyKJ END),
				@HeatProbe			= (CASE WHEN IsNull(ER.HeatProbe, 0) = 0 THEN EE.HeatProbe ELSE ER.HeatProbe END),
				@BicapElectro		= (CASE WHEN IsNull(ER.BicapElectro, 0) = 0 THEN EE.BicapElectro ELSE ER.BicapElectro END),
				@Diathermy			= (CASE WHEN IsNull(ER.Diathermy, 0) = 0 THEN EE.Diathermy ELSE ER.Diathermy END),
				@HotBiopsy			= (CASE WHEN IsNull(ER.HotBiopsy, 0) = 0 THEN EE.HotBiopsy ELSE ER.HotBiopsy END),
				@BandLigation= (CASE WHEN IsNull(ER.BandLigation, 0) = 0 THEN EE.BandLigation ELSE ER.BandLigation END),
				@BandLigationPerformed			= (CASE WHEN ISNULL(ER.[BandLigationPerformed], 0) = 0 THEN ER.[BandLigationPerformed] ELSE EE.[BandLigationPerformed] END),
				@BandLigationSuccess			= (CASE WHEN ISNULL(ER.[BandLigationSuccessful], 0) = 0 THEN ER.[BandLigationSuccessful] ELSE EE.[BandLigationSuccessful] END),
				@BotoxInjection = (CASE WHEN IsNull(ER.BotoxInjection, 0) = 0 THEN EE.BotoxInjection ELSE ER.BotoxInjection END),
				@EndoloopPlacement = (CASE WHEN IsNull(ER.EndoloopPlacement, 0) = 0 THEN EE.EndoloopPlacement ELSE ER.EndoloopPlacement END),
				@ForeignBody= (CASE WHEN IsNull(ER.ForeignBody, 0) = 0 THEN EE.ForeignBody ELSE ER.ForeignBody END),
				@Injection			= (CASE WHEN IsNull(ER.Injection, 0) = 0 THEN EE.Injection ELSE ER.Injection END),
				@InjectionType		= (CASE WHEN IsNull(ER.InjectionType, 0) = 0 THEN EE.InjectionType ELSE ER.InjectionType END),
				@InjectionVolume	= (CASE WHEN IsNull(ER.InjectionVolume, 0) = 0 THEN EE.InjectionVolume ELSE ER.InjectionVolume END),
				@InjectionNumber	= (CASE WHEN IsNull(ER.InjectionNumber, 0) = 0 THEN EE.InjectionNumber ELSE ER.InjectionNumber END),
				@GastrostomyInsertion			= (CASE WHEN IsNull(ER.GastrostomyInsertion, 0) = 0 THEN EE.GastrostomyInsertion ELSE ER.GastrostomyInsertion END),
				@GastrostomyInsertionSize		= (CASE WHEN IsNull(ER.GastrostomyInsertionSize, 0) = 0 THEN EE.GastrostomyInsertionSize ELSE ER.GastrostomyInsertionSize END),
				@GastrostomyInsertionUnits		= (CASE WHEN ER.GastrostomyInsertionUnits IS NULL THEN EE.GastrostomyInsertionUnits ELSE ER.GastrostomyInsertionUnits END),
				@GastrostomyInsertionType		= (CASE WHEN IsNull(ER.GastrostomyInsertionType, 0) = 0 THEN EE.GastrostomyInsertionType ELSE ER.GastrostomyInsertionType END),
				@GastrostomyInsertionBatchNo	= (SELECT isnull((CASE WHEN IsNull(ER.GastrostomyInsertionBatchNo, '') = '' THEN EE.GastrostomyInsertionBatchNo ELSE ER.GastrostomyInsertionBatchNo END), '') as [text()] FOR XML PATH('')),
				@GastrostomyRemoval				= (CASE WHEN IsNull(ER.GastrostomyRemoval, 0) = 0 THEN EE.GastrostomyRemoval ELSE ER.GastrostomyRemoval END),
				@NilByMouth			= (CASE WHEN IsNull(ER.NilByMouth, 0) = 0 THEN EE.NilByMouth ELSE ER.NilByMouth END),
				@NilByMouthHrs		= (CASE WHEN IsNull(ER.NilByMouthHrs, 0) = 0 THEN EE.NilByMouthHrs ELSE ER.NilByMouthHrs END),
				@NilByProc			= (CASE WHEN IsNull(ER.NilByProc, 0) = 0 THEN EE.NilByProc ELSE ER.NilByProc END),
				@NilByProcHrs		= (CASE WHEN IsNull(ER.NilByProcHrs, 0) = 0 THEN EE.NilByProcHrs ELSE ER.NilByProcHrs END),
				@AttachmentToWard	= (CASE WHEN IsNull(ER.AttachmentToWard, 0) = 0 THEN EE.AttachmentToWard ELSE ER.AttachmentToWard END),
				@PyloricDilatation	= (CASE WHEN IsNull(ER.PyloricDilatation, 0) = 0 THEN EE.PyloricDilatation ELSE ER.PyloricDilatation END),
				@StentInsertion		= (CASE WHEN IsNull(ER.StentInsertion, 0) = 0 THEN EE.StentInsertion ELSE ER.StentInsertion END),
				@StentInsertionQty	= (CASE WHEN IsNull(ER.StentInsertionQty, 0) = 0 THEN EE.StentInsertionQty ELSE ER.StentInsertionQty END),
				@RadioactiveWirePlaced			= (CASE WHEN IsNull(ER.RadioactiveWirePlaced, 0) = 0 THEN EE.RadioactiveWirePlaced ELSE ER.RadioactiveWirePlaced END),
				@StentInsertionBatchNo			= (SELECT isnull((CASE WHEN IsNull(ER.StentInsertionBatchNo,'')= '' THEN EE.StentInsertionBatchNo ELSE ER.StentInsertionBatchNo END), '') as [text()] FOR XML PATH('')),
				@StentRemoval					= (CASE WHEN IsNull(ER.StentRemoval, 0) = 0 THEN EE.StentRemoval ELSE ER.StentRemoval END),
				@StentRemovalTechnique			= (CASE WHEN IsNull(ER.StentRemovalTechnique, 0) = 0 THEN EE.StentRemovalTechnique ELSE ER.StentRemovalTechnique END),
				@EMR				= (CASE WHEN IsNull(ER.EMR, 0) = 0 THEN EE.EMR ELSE ER.EMR END),
				@EMRType			= (CASE WHEN IsNull(ER.EMRType, 0) = 0 THEN EE.EMRType ELSE ER.EMRType END),
				@EMRFluid			= (CASE WHEN IsNull(ER.EMRFluid, 0) = 0 THEN EE.EMRFluid ELSE ER.EMRFluid END),
				@EMRFluidVolume		= (CASE WHEN IsNull(ER.EMRFluidVolume, 0) = 0 THEN EE.EMRFluidVolume ELSE ER.EMRFluidVolume END),
				@Marking			= (CASE WHEN IsNull(ER.Marking, 0) = 0 THEN EE.Marking ELSE ER.Marking END),
				@MarkingType		= (CASE WHEN IsNull(ER.MarkingType, 0) = 0 THEN EE.MarkingType ELSE ER.MarkingType END),
				@Clip				= (CASE WHEN IsNull(ER.Clip, 0) = 0 THEN EE.Clip ELSE ER.Clip END),
				@ClipNum			= (CASE WHEN IsNull(ER.ClipNum, 0) = 0 THEN EE.ClipNum ELSE ER.ClipNum END),
				@Papillotomy		= (CASE WHEN IsNull(ER.Papillotomy, 0) = 0 THEN EE.Papillotomy ELSE ER.Papillotomy END),
				@Sphincterotome		= (CASE WHEN IsNull(ER.Sphincterotome, 0) = 0 THEN EE.Sphincterotome ELSE ER.Sphincterotome END),
				@PapillotomyLength	= (CASE WHEN IsNull(ER.PapillotomyLength, 0) = 0 THEN EE.PapillotomyLength ELSE ER.PapillotomyLength END),
				@PapillotomyAcceptBalloonSize	= (CASE WHEN IsNull(ER.PapillotomyAcceptBalloonSize, 0) = 0 THEN EE.PapillotomyAcceptBalloonSize ELSE ER.PapillotomyAcceptBalloonSize END),
				@ReasonForPapillotomy		= (CASE WHEN IsNull(ER.ReasonForPapillotomy, 0) = 0 THEN EE.ReasonForPapillotomy ELSE ER.ReasonForPapillotomy END),
				@PapillotomyBleeding		= (CASE WHEN IsNull(ER.PapillotomyBleeding, 0) = 0 THEN EE.PapillotomyBleeding ELSE ER.PapillotomyBleeding END),
				@SphincterDecompressed		= (CASE WHEN IsNull(ER.SphincterDecompressed, 0) = 0 THEN EE.SphincterDecompressed ELSE ER.SphincterDecompressed END),
				@PanOrificeSphincterotomy	= (CASE WHEN IsNull(ER.PanOrificeSphincterotomy, 0) = 0 THEN EE.PanOrificeSphincterotomy ELSE ER.PanOrificeSphincterotomy END),
				@StoneRemoval				= (CASE WHEN IsNull(ER.StoneRemoval, 0) = 0 THEN EE.StoneRemoval ELSE ER.StoneRemoval END),
				@RemovalUsing				= (CASE WHEN IsNull(ER.RemovalUsing, 0) = 0 THEN EE.RemovalUsing ELSE ER.RemovalUsing END),
				@ExtractionOutcome			= (CASE WHEN IsNull(ER.ExtractionOutcome, 0) = 0 THEN EE.ExtractionOutcome ELSE ER.ExtractionOutcome END),
				@InadequateSphincterotomy	= (CASE WHEN IsNull(ER.InadequateSphincterotomy, 0) = 0 THEN EE.InadequateSphincterotomy ELSE ER.InadequateSphincterotomy END),
				@StoneSize			= (CASE WHEN IsNull(ER.StoneSize, 0) = 0 THEN EE.StoneSize ELSE ER.StoneSize END),
				@QuantityOfStones	= (CASE WHEN IsNull(ER.QuantityOfStones, 0) = 0 THEN EE.QuantityOfStones ELSE ER.QuantityOfStones END),
				@ImpactedStones		= (CASE WHEN IsNull(ER.ImpactedStones, 0) = 0 THEN EE.ImpactedStones ELSE ER.ImpactedStones END),
				@OtherReason		= (CASE WHEN IsNull(ER.OtherReason, 0) = 0 THEN EE.OtherReason ELSE ER.OtherReason END),
				@OtherReasonText	= (SELECT isnull((CASE WHEN IsNull(ER.OtherReasonText, '') = '' THEN EE.OtherReasonText ELSE ER.OtherReasonText END), '') as [text()] FOR XML PATH('')),
				@StoneDecompressed	= (CASE WHEN IsNull(ER.StoneDecompressed, 0) = 0 THEN EE.StoneDecompressed ELSE ER.StoneDecompressed END),
				@StrictureDilatation= (CASE WHEN IsNull(ER.StrictureDilatation, 0) = 0 THEN EE.StrictureDilatation ELSE ER.StrictureDilatation END),
				@DilatedTo			= (CASE WHEN IsNull(ER.DilatedTo, 0) = 0 THEN EE.DilatedTo ELSE ER.DilatedTo END),
				@DilatationUnits	= (CASE WHEN ER.DilatationUnits IS NULL THEN EE.DilatationUnits ELSE ER.DilatationUnits END),
				@DilatorType		= (CASE WHEN IsNull(ER.DilatorType, 0) = 0 THEN EE.DilatorType ELSE ER.DilatorType END),
				@EndoscopicCystPuncture	= (CASE WHEN IsNull(ER.EndoscopicCystPuncture, 0) = 0 THEN EE.EndoscopicCystPuncture ELSE ER.EndoscopicCystPuncture END),
				@CystPunctureDevice		= (CASE WHEN IsNull(ER.CystPunctureDevice, 0) = 0 THEN EE.CystPunctureDevice ELSE ER.CystPunctureDevice END),
				@CystPunctureVia		= (CASE WHEN IsNull(ER.CystPunctureVia, 0) = 0 THEN EE.CystPunctureVia ELSE ER.CystPunctureVia END),
				@Cannulation			= (CASE WHEN IsNull(ER.Cannulation, 0) = 0 THEN EE.Cannulation ELSE ER.Cannulation END),
				@Manometry				= (CASE WHEN IsNull(ER.Manometry, 0) = 0 THEN EE.Manometry ELSE ER.Manometry END),
				@Haemostasis			= (CASE WHEN IsNull(ER.Haemostasis, 0) = 0 THEN EE.Haemostasis ELSE ER.Haemostasis END),
				@NasopancreaticDrain	= (CASE WHEN IsNull(ER.NasopancreaticDrain, 0) = 0 THEN EE.NasopancreaticDrain ELSE ER.NasopancreaticDrain END),
				@RendezvousProcedure	= (CASE WHEN IsNull(ER.RendezvousProcedure, 0) = 0 THEN EE.RendezvousProcedure ELSE ER.RendezvousProcedure END),
				@SnareExcision			= (CASE WHEN IsNull(ER.SnareExcision, 0) = 0 THEN EE.SnareExcision ELSE ER.SnareExcision END),
				@BalloonDilation		= (CASE WHEN IsNull(ER.BalloonDilation, 0) = 0 THEN EE.BalloonDilation ELSE ER.BalloonDilation END),
				@BalloonDilatedTo		= (CASE WHEN IsNull(ER.BalloonDilatedTo, 0) = 0 THEN EE.BalloonDilatedTo ELSE ER.BalloonDilatedTo END),
				@BalloonDilatationUnits	= (CASE WHEN IsNull(ER.BalloonDilatationUnits, 0) = 0 THEN EE.BalloonDilatationUnits ELSE ER.BalloonDilatationUnits END),
				@BalloonDilatorType		= (CASE WHEN IsNull(ER.BalloonDilatorType, 0) = 0 THEN EE.BalloonDilatorType ELSE ER.BalloonDilatorType END),
				@BalloonTrawl			= (CASE WHEN IsNull(ER.BalloonTrawl, 0) = 0 THEN EE.BalloonTrawl ELSE ER.BalloonTrawl END),
				@BalloonTrawlDilatorType	= (CASE WHEN IsNull(ER.BalloonTrawlDilatorType, 0) = 0 THEN EE.BalloonTrawlDilatorType ELSE ER.BalloonTrawlDilatorType END),
				@BalloonTrawlDilatorSize	= (CASE WHEN IsNull(ER.BalloonTrawlDilatorSize, 0) = 0 THEN EE.BalloonTrawlDilatorSize ELSE ER.BalloonTrawlDilatorSize END),
				@BalloonTrawlDilatorUnits	= (CASE WHEN IsNull(ER.BalloonTrawlDilatorUnits, 0) = 0 THEN EE.BalloonTrawlDilatorUnits ELSE ER.BalloonTrawlDilatorUnits END),
				@BalloonDecompressed		= (CASE WHEN IsNull(ER.BalloonDecompressed, 0) = 0 THEN EE.BalloonDecompressed ELSE ER.BalloonDecompressed END),
				@DiagCholangiogram			= (CASE WHEN IsNull(ER.DiagCholangiogram, 0) = 0 THEN EE.DiagCholangiogram ELSE ER.DiagCholangiogram END),
				@DiagPancreatogram			= (CASE WHEN IsNull(ER.DiagPancreatogram, 0) = 0 THEN EE.DiagPancreatogram ELSE ER.DiagPancreatogram END),
				@EndoscopistRole			= (CASE WHEN IsNull(ER.CarriedOutRole, 0) = 0 THEN EE.CarriedOutRole ELSE ER.CarriedOutRole END),
				@Other						= (CASE WHEN IsNull(ER.Other, '') ='' THEN EE.Other ELSE ER.Other END),
				@EUSProcType				= (CASE WHEN IsNull(ER.EUSProcType, 0) = 0 THEN EE.EUSProcType ELSE ER.EUSProcType END),
				@CorrectStentPlacement		= ER.CorrectStentPlacement,
				@CorrectStentPlacementNoReason			= (CASE WHEN IsNull(ER.CorrectStentPlacementNoReason, 0) = 0 THEN EE.CorrectStentPlacementNoReason ELSE ER.CorrectStentPlacementNoReason END),
				@BalloonDilatation			= (CASE WHEN IsNull(ER.BalloonDilatation, 0) = 0 THEN EE.BalloonDilatation ELSE ER.BalloonDilatation END),
				@BougieDilatation			= (CASE WHEN IsNull(ER.BougieDilatation, 0) = 0 THEN EE.BougieDilatation ELSE ER.BougieDilatation END),
				@BougieDilation				= (CASE WHEN IsNull(ER.BougieDilation, 0) = 0 THEN EE.BougieDilation ELSE ER.BougieDilation END),
				@BrushCytology				= (CASE WHEN IsNull(ER.BrushCytology, 0) = 0 THEN EE.BrushCytology ELSE ER.BrushCytology END),
				@Cholangioscopy				= (CASE WHEN IsNull(ER.Cholangioscopy, 0) = 0 THEN EE.Cholangioscopy ELSE ER.Cholangioscopy END),
				@CholangioscopyType			= (CASE WHEN IsNull(ER.CholangioscopyType, 0) = 0 THEN EE.CholangioscopyType ELSE ER.CholangioscopyType END),
				@StentChange				= (CASE WHEN IsNull(ER.StentChange, 0) = 0 THEN EE.StentChange ELSE ER.StentChange END),
				@StentPlacement				= (CASE WHEN IsNull(ER.StentPlacement, 0) = 0 THEN EE.StentPlacement ELSE ER.StentPlacement END),
				@RadioFrequencyAblation		= (CASE WHEN IsNull(ER.RadioFrequencyAblation, 0) = 0 THEN EE.RadioFrequencyAblation ELSE ER.RadioFrequencyAblation END),
				@FineNeedleAspiration		= (CASE WHEN IsNull(ER.FineNeedleAspiration, 0) = 0 THEN EE.FineNeedleAspiration ELSE ER.FineNeedleAspiration END),
				@FineNeedleAspirationType	= (CASE WHEN IsNull(ER.FineNeedleAspirationType, 0) = 0 THEN EE.FineNeedleAspirationType ELSE ER.FineNeedleAspirationType END),
				@FineNeedleBiopsy			= (CASE WHEN IsNull(ER.FineNeedleBiopsy, 0) = 0 THEN EE.FineNeedleBiopsy ELSE ER.FineNeedleBiopsy END),
				@Polypectomy				= (CASE WHEN IsNull(ER.[Polypectomy], 0) = 0 THEN EE.[Polypectomy] ELSE ER.[Polypectomy] END),
				@Diverticulotomy			= (CASE WHEN ISNULL(ER.Diverticulotomy,0) = 0 THEN EE.Diverticulotomy ELSE ER.Diverticulotomy END),
				@Homeostasis				= (CASE WHEN ISNULL(ER.[Homeostasis], 0) = 0 THEN EE.[Homeostasis] ELSE ER.[Homeostasis] END),
				@HomeostasisType			= (CASE WHEN ISNULL(ER.[HomeostasisType], 0) = 0 THEN EE.[HomeostasisType] ELSE ER.[HomeostasisType] END),
				@FNAPerformed				= (CASE WHEN IsNull(ER.[FNAPerformed], 0) = 0 THEN EE.[FNAPerformed] ELSE ER.[FNAPerformed] END),--2550
				@FNASuccessful			    = (CASE WHEN IsNull(ER.[FNASuccessful], 0) = 0 THEN EE.[FNASuccessful] ELSE ER.[FNASuccessful] END),--2550
				@FNARetrieved				= (CASE WHEN IsNull(ER.[FNARetreived], 0) = 0 THEN EE.[FNARetreived] ELSE ER.[FNARetreived] END),--2550
				@FNBPerformed				= (CASE WHEN IsNull(ER.[FNBPerformed], 0) = 0 THEN EE.[FNBPerformed] ELSE ER.[FNBPerformed] END),--2551
				@FNBSuccessfull				= (CASE WHEN IsNull(ER.[FNBSuccessful], 0) = 0 THEN EE.[FNBSuccessful] ELSE ER.[FNBSuccessful] END),--2551
				@FNBRetrieved				= (CASE WHEN IsNull(ER.[FNBRetreived], 0) = 0 THEN EE.[FNBRetreived] ELSE ER.[FNBRetreived] END)--2551
			FROM eeRecord AS EE
	  INNER JOIN #tmp_ERCPTherapeutics AS ER ON EE.SiteId = ER.SiteId;
		END	--## Selecting from Combine
				
	
	IF @None = 1
		SET @summary = @summary + 'No specimens taken'
	ELSE
	BEGIN
		----------------------
        -- Sphincterotomy
        ----------------------
		IF @Papillotomy = 1
		BEGIN
			SET @msg =' Sphincterotomy'
			SET @Details = ''
			IF @ReasonForPapillotomy > 0 
			BEGIN
				SET @Details = @Details + ' ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'ERCP papillotomy reason' AND [ListItemNo] = @ReasonForPapillotomy)

				--Place the word 'for' in front of the reason for the papillotomy if required.
				IF LEFT(UPPER(LTRIM(@Details)),4) <> 'FOR ' SET @Details = ' for ' + @Details
				SET @msg = @msg + ' (' + @Details + ')'
				SET @Details = ''
			END
			IF @PapillotomyLength > 0 SET @Details = @Details + ' ' + CAST(@PapillotomyLength as varchar(50)) + 'mm'
			IF @Sphincterotome > 0 SET @Details = @Details + ' using ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Therapeutic ERCP sphincterotomes' AND [ListItemNo] = @Sphincterotome)
			IF @PapillotomyBleeding > 0 
			BEGIN
				If LEN(RTRIM(LTRIM(@Details))) > 0 SET @Details = @Details + ','
				SET @Details = @Details + CASE @PapillotomyBleeding
											WHEN 1 THEN ' with no bleeding'   
											WHEN 2 THEN ' with minor bleeding'  
											WHEN 3 THEN ' with major bleeding'
											ELSE '' 
										END   
			END
			IF @PapillotomyAcceptBalloonSize > 0 
			BEGIN
				If LEN(RTRIM(LTRIM(@Details))) > 0 SET @Details = @Details + ','
				SET @Details = @Details + ' incision accepted ' + cast(@PapillotomyAcceptBalloonSize as varchar(50)) + 'ml balloon'
			END
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END
		
		----------------------
        -- Pancreatic orifice sphincterotomy
        ----------------------
		IF @PanOrificeSphincterotomy = 1
		BEGIN
			SET @msg =' Pancreatic orifice sphincterotomy'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		----------------------
        -- Stone removal
        ----------------------
		IF @StoneRemoval = 1
		BEGIN
			SET @msg =' Stone removal'
			SET @Details = ''

			IF @ExtractionOutcome > 0 
			BEGIN
				SET @Details = @Details + CASE @ExtractionOutcome
											WHEN 1 THEN ' complete extraction'   
											WHEN 2 THEN ' fragmented'  
											WHEN 3 THEN ' partial extraction'
											WHEN 4 THEN ' unable to extract'
											ELSE '' 
										END   
				DECLARE @cnt bit = 0
				IF @ExtractionOutcome BETWEEN 3 AND 4
				BEGIN
					DECLARE @tmpDiv TABLE(Val VARCHAR(MAX))
					DECLARE @XMLlist XML

					IF @InadequateSphincterotomy > 0
					BEGIN
						INSERT INTO @tmpDiv (Val) VALUES('inadequate sphincterotomy')
					END

					IF @StoneSize > 0
					BEGIN
						INSERT INTO @tmpDiv (Val) VALUES('stone size')
					END

					IF @QuantityOfStones > 0
					BEGIN
						INSERT INTO @tmpDiv (Val) VALUES('quantity of stones')
					END

					IF @ImpactedStones > 0
					BEGIN
						INSERT INTO @tmpDiv (Val) VALUES('impacted stone(s)')
					END

					IF @OtherReason > 0
					BEGIN
						IF LTRIM(RTRIM(ISNULL(@OtherReasonText,''))) <> ''
						BEGIN
							INSERT INTO @tmpDiv (Val) VALUES(@OtherReasonText)
						END
					END

					IF (SELECT COUNT(Val) FROM @tmpDiv) > 0 
					BEGIN
						SET @XMLlist = (SELECT Val FROM @tmpDiv FOR XML  RAW, ELEMENTS, TYPE)
						SET @Details = @Details + ' due to ' + dbo.fnBuildString(@XMLlist)
					END
				END
			END

			IF @RemovalUsing > 0 SET @Details = @Details + ' using ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'ERCP stone removal method' AND [ListItemNo] = @RemovalUsing)


			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		----------------------
        -- Stricture dilatation
        ----------------------
		IF @StrictureDilatation= 1
			BEGIN
			SET @msg =' Stricture dilatation'
			SET @Details = ''

			IF @DilatedTo > 0 
			BEGIN
				SET @Details = @Details + ' dilated to ' + cast(@DilatedTo as varchar(50)) + ' ' + 
									ISNULL((SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Oesophageal dilatation units' AND [ListItemNo] = @DilatationUnits),'')
			END

			--Dilator type
			IF @DilatorType > 0 
			BEGIN
				DECLARE @tmpDilatorType VARCHAR(100) = (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Oesophageal dilator' AND [ListItemNo] = @DilatorType)
				IF UPPER(LEFT(LTRIM(@tmpDilatorType),5)) = 'WITH ' OR UPPER(LEFT(LTRIM(@tmpDilatorType),3)) = 'BY ' 
					SET @Details = @Details + ' ' + @tmpDilatorType
				ELSE
					SET @Details = @Details + ' with ' + @tmpDilatorType
			END	
			
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		----------------------
        -- Endoscopic cyst puncture
        ----------------------
		IF @EndoscopicCystPuncture = 1
		BEGIN
			SET @msg =' Endoscopic cyst puncture'
			SET @Details = ''
			IF @CystPunctureDevice > 0 SET @Details = @Details + ' using ' + 
															(SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'ERCP cyst punct device' AND [ListItemNo] = @CystPunctureDevice)

			SET @Details = @Details + CASE @CystPunctureVia
							WHEN 1 THEN ' via papilla'   
							WHEN 2 THEN ' via medial wall of duodenum (cyst-duodenostomy)'  
							WHEN 3 THEN ' via stomach (cyst-gastrostomy)'
							ELSE '' 
						END   

			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		-------------------------------
        -- Nasobiliary/pancreatic drain
        -------------------------------
		IF @NasopancreaticDrain = 1
		BEGIN
			IF EXISTS ( SELECT r.Region FROM ERS_AbnormalitiesMatrixERCP m 
							LEFT JOIN ERS_Regions r ON m.Region = r.Region 
									AND r.Region IN ('Uncinate Process', 'Head', 'Neck', 'Body', 'Tail', 'Accessory Pancreatic Duct', 'Main Pancreatic Duct')
							LEFT JOIN ERS_Sites s ON r.RegionId  = s.RegionID  
							WHERE s.siteId = @SiteId)
				SET @msg =' Nasopancreatic drain'
			ELSE
				SET @msg =' Nasobiliary drain'


			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		-------------------------------
        -- Combined procedure
        -------------------------------
		IF @RendezvousProcedure = 1
		BEGIN
			SET @msg =' Combined procedure (rendezvous)'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		-------------------------------
        -- Diverticulotomy
        -------------------------------
		IF @Diverticulotomy = 1
		BEGIN
			SET @msg =' Diverticulotomy'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		-------------------------------
        -- Homeostasis
        -------------------------------
		IF @Homeostasis = 1
			BEGIN
			SET @msg =' Haemostasis'
			SET @Details = ''
			IF @HomeostasisType > 0 SET @Details = @Details + ' ' +   (SELECT [ListItemText] FROM dbo.ERS_Lists WHERE ListDescription = 'Homeostasis' AND [ListItemNo] = @HomeostasisType)
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		-------------------------------
        -- Snare excision
        -------------------------------
		IF @SnareExcision = 1
		BEGIN
			SET @msg =' Snare excision'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		----------------------
        -- Balloon sphincteroplasty
        ----------------------
		IF @BalloonDilation= 1
			BEGIN
			SET @msg =' Balloon sphincteroplasty'
			SET @Details = ''

			IF @BalloonDilatedTo > 0 
			BEGIN
				SET @Details = @Details + ' dilated to ' + cast(@BalloonDilatedTo as varchar(50)) + ' ' + 
									(SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Oesophageal dilatation units' AND [ListItemNo] = @BalloonDilatationUnits)
			END

			--Balloon Dilator type
			IF @BalloonDilatorType > 0 
			BEGIN
				DECLARE @tmpBalloonDilatorType VARCHAR(100) = (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'ERCP balloon dilator' AND [ListItemNo] = @BalloonDilatorType)
				IF UPPER(LEFT(LTRIM(@tmpBalloonDilatorType),5)) = 'WITH ' OR UPPER(LEFT(LTRIM(@tmpBalloonDilatorType),3)) = 'BY ' 
					SET @Details = @Details + ' ' + @tmpBalloonDilatorType
				ELSE
					SET @Details = @Details + ' with ' + @tmpBalloonDilatorType
			END	
			
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END


		----------------------
        -- Balloon trawl
        ----------------------
		IF @BalloonTrawl = 1
			BEGIN
			SET @msg =' Balloon trawl'
			SET @Details = ''

			IF @BalloonTrawlDilatorType > 0 
			BEGIN
				DECLARE @DilType VARCHAR(100) = (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'ERCP Balloon dilator' AND [ListItemNo] = @BalloonTrawlDilatorType)
				IF LTRIM(RTRIM(@DilType)) <> ''
				BEGIN
					
					IF UPPER(LEFT(@DilType,1)) in ('A','E','I','O','U') 
						SET @Details = @Details + ' using an' 
					ELSE
						SET @Details = @Details + ' using a'

					SET @Details = @Details + ' ' + @DilType
				END
			END

			IF @BalloonTrawlDilatorUnits >= 0 
			BEGIN
				IF @BalloonTrawlDilatorSize > 0 
				BEGIN
					SET @Details = @Details + ' dilated to ' + cast(@BalloonTrawlDilatorSize as varchar(50)) + ' ' + 
									(SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Oesophageal dilatation units' AND [ListItemNo] = @BalloonTrawlDilatorUnits)
				END
			END
			
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		-------------------------------
        -- Cannulation
        -------------------------------
		IF @Cannulation = 1
		BEGIN
			SET @msg =' Cannulation'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		-------------------------------
        -- Manometry
        -------------------------------
		IF @Manometry = 1
		BEGIN
			SET @msg =' Manometry'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		-------------------------------
        -- Haemostasis
        -------------------------------
		IF @Haemostasis = 1
		BEGIN
			SET @msg =' Haemostasis'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		-------------------------------
        -- Diagnostic cholangiogram
        -------------------------------
		IF @DiagCholangiogram = 1
		BEGIN
			SET @msg =' Diagnostic cholangiogram'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		-------------------------------
        -- Diagnostic pancreatogram
        -------------------------------
		IF @DiagPancreatogram = 1
		BEGIN
			SET @msg =' Diagnostic pancreatogram'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

	-- DUODENUM -----
		IF @YAGLaser = 1
			BEGIN
				SET @msg =' YAG Laser'
				SET @Details = ''
				IF @YAGLaserWatts > 0 SET @Details = @Details + ' ' + CAST(@YAGLaserWatts as varchar(50)) + 'W'
				IF @YAGLaserSecs > 0 SET @Details = @Details + ' for ' + cast(CAST(@YAGLaserSecs AS FLOAT) as varchar(50)) + CASE WHEN @YAGLaserSecs <= 1 THEN ' second' else ' seconds' END
				IF @YAGLaserPulses > 0 SET @Details = @Details + ' in ' + cast(@YAGLaserPulses as varchar(50)) + CASE WHEN @YAGLaserPulses <= 1 THEN ' pulse' else ' pulses' END
				IF @YAGLaserKJ > 0 SET @Details = @Details + ' ('+ cast(CAST(@YAGLaserKJ AS FLOAT) as varchar(50)) + 'kJ)'
				If @Details<>'' SET @msg = @msg + ': ' + @Details
				--Add full stop 
				SET @msg = RTrim(LTRIM(@msg))
				IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
				--------------
				SET @summary = @summary + @msg + '<br/>'
			END
		
		IF @ArgonBeamDiathermy= 1
			BEGIN
			SET @msg ='  Argon beam diathermy'
			SET @Details = ''
			IF @ArgonBeamDiathermyWatts > 0 SET @Details = @Details + ' ' + cast(@ArgonBeamDiathermyWatts as varchar(50)) + 'W'
			IF @ArgonBeamDiathermySecs > 0 SET @Details = @Details + ' for ' + cast(CAST(@ArgonBeamDiathermySecs AS FLOAT) as varchar(50)) + CASE WHEN @ArgonBeamDiathermySecs <= 1 THEN ' second' else ' seconds' END
			IF @ArgonBeamDiathermyPulses > 0 SET @Details = @Details + ' in ' + cast(@ArgonBeamDiathermyPulses as varchar(50)) + CASE WHEN @ArgonBeamDiathermyPulses <= 1 THEN ' pulse' else ' pulses' END
			IF @ArgonBeamDiathermyKJ > 0 SET @Details = @Details + ' ('+ cast(CAST(@ArgonBeamDiathermyKJ AS FLOAT) as varchar(50)) + 'kJ)'
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
			END

			
		IF @Injection= 1
			BEGIN
			SET @msg =' Injection'
			SET @Details = ''
			IF @InjectionVolume > 0 SET @Details = @Details + '  ' + cast(@InjectionVolume as varchar(50)) + 'ml'
			IF @InjectionVolume > 0  AND @InjectionType > 0 SET @Details = @Details + ' of'
			IF @InjectionType > 0 SET @Details = @Details + ' ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Agent Upper GI' AND [ListItemNo] = @InjectionType)
			IF @InjectionVolume> 0  AND @InjectionNumber > 0 SET @Details = @Details + ' via'
			IF @InjectionNumber >0 SET @Details = @Details + ' ' + CASE WHEN @InjectionNumber > 1 THEN cast(@InjectionNumber as varchar(50)) + ' injections' ELSE cast(@InjectionNumber as varchar(50)) + ' injection' END
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END
	
		IF @Diathermy = 1
			BEGIN
			SET @msg = ' Diathermy'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		IF @BicapElectro = 1
			BEGIN
			SET @msg = ' Bicap electrocautery'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		IF @HeatProbe = 1
			BEGIN
			SET @msg = ' Heater probe coagulation'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END
		
		IF @HotBiopsy = 1
			BEGIN
			SET @msg = ' Hot biopsy'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		IF @BandLigation = 1
			BEGIN
			SET @msg = ' Band ligation'
			IF @BandLigationPerformed > 0 SET @msg = @msg + ' performed ' + CAST(@BandLigationPerformed AS VARCHAR(100)) + CASE WHEN @BandLigationPerformed = 1 THEN ' procedure' ELSE ' procedures' END
			IF @BandLigationPerformed > 0 AND @BandLigationSuccess > 0 SET @msg = @msg + ' and ' + CAST(@BandLigationSuccess AS VARCHAR(100)) + CASE WHEN @BandLigationPerformed = 1 THEN ' was successful.' ELSE ' were successful.' END 
				ELSE IF @BandLigationPerformed = 0 AND @BandLigationSuccess > 0 SET @msg = @msg + ' ' + CAST(@BandLigationSuccess AS VARCHAR(100)) + CASE WHEN @BandLigationPerformed = 1 THEN ' procedure was successful.' ELSE ' procedures were successful.' END 
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		IF @BotoxInjection = 1
			BEGIN
			SET @msg = ' Botox injection'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		IF @EndoloopPlacement = 1
			BEGIN
			SET @msg = ' Endoloop placement'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		IF @ForeignBody = 1
			BEGIN
			SET @msg = ' Foreign body removal'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		----------------------
        -- Stent insertion
        ----------------------
		IF @StentInsertion= 1
			BEGIN

			IF @CorrectStentPlacement IS NOT NULL
			BEGIN
				IF @CorrectStentPlacement = 1
				BEGIN
					SET @msg = ' Correct placement across stricture '
				END
				ELSE IF @CorrectStentPlacement = 0
				BEGIN
					SET @msg = ' Incorrect placement across stricture '

					IF @CorrectStentPlacementNoReason >= 0
					BEGIN
						SET @msg = @msg + '(' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Correct Placement Across Stricture' AND [ListItemNo] = @CorrectStentPlacementNoReason) + ')'
					END
				END

				--Add full stop 
				SET @msg = RTrim(LTRIM(@msg))
				IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
				--------------
				SET @summary = @summary + @msg + '<br/>'
			END

			SET @msg =' Stent insertion'
			SET @Details = ''

			--Qty of stents used
			IF @StentInsertionQty > 0 SET @Details = @Details + '  ' + cast(@StentInsertionQty as varchar(50))

			IF @RadioactiveWirePlaced > 0  SET @Details = @Details + ', radiotherapeutic wire placed' 
			IF ISNULL(@StentInsertionBatchNo,'') <> ''  SET @Details = @Details + ', batch ' + LTRIM(RTRIM(@StentInsertionBatchNo))

			SET @Details = @Details + dbo.ercp_stentinsertions_summary(@TherapeuticId)
			
			If @Details<>'' SET @msg = @msg + ': ' + @Details 
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		----------------------
        -- Stent removal
        ----------------------
		IF @StentRemoval= 1
			BEGIN
			SET @msg =' Stent removal'
			SET @Details = ''
			IF @StentRemovalTechnique > 0  SET @Details = @Details + 'using ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Therapeutic Stent Removal Technique' AND [ListItemNo] = @StentRemovalTechnique)
			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		IF @EMR= 1
			BEGIN
			IF @EMRType = 2
				SET @msg =' Endoscopic submucosal dissection'
			ELSE
				SET @msg =' Endoscopic mucosal resection'
			SET @Details = ''
			IF @EMRFluid > 0  SET @Details = @Details + 'using ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Therapeutic EMR Fluid' AND [ListItemNo] = @EMRFluid)
			IF @EMRFluidVolume >0 
				BEGIN
				IF @EMRFluid >0 SET  @Details = @Details + ', '
				SET  @Details = @Details + 'total volume ' + cast(@emrfluidvolume AS varchar(50)) + 'ml'
				END
			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		IF @GastrostomyInsertion =1
		BEGIN
			DECLARE @G bit, @J bit, @N bit
			--SELECT @j = i.[JejunostomyInsertion], @G =i.[GastrostomyInsertion],@N = i.[NasoDuodenalTube] FROM [ERS_UpperGIIndications] i LEFT JOIN [ERS_Sites] s ON i.ProcedureId = s.ProcedureId WHERE s.SiteId = @SiteID
			--IF @N = 1 SET @msg =' Nasojejunal tube (NJT)' ELSE IF @J= 1 SET @msg =' Jejunostomy insertion (PEJ)' ELSE SET @msg =' Gastrostomy insertion (PEG)'
			SET @msg =' Nasojejunal tube (NJT)' -- For ERCP, it is Nasojejunal
			SET @Details = ''

			IF @GastrostomyInsertionType > 0
			BEGIN
				IF @GastrostomyInsertionSize>0
				BEGIN
					SET @Details = @Details + cast(@GastrostomyInsertionSize as varchar(50))
					--IF @J=1 
					SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG units' AND [ListItemNo] = @GastrostomyInsertionUnits)
					--ELSE IF @N =1 SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG units' AND [ListItemNo] = @GastrostomyInsertionUnits)
					--ELSE SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG units' AND [ListItemNo] = @GastrostomyInsertionUnits)
				END
			END
			IF @GastrostomyInsertionType>0
			BEGIN
				IF @J=1 SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG type' AND [ListItemNo] = @GastrostomyInsertiontype)
				ELSE IF @N =1 SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG type' AND [ListItemNo] = @GastrostomyInsertiontype)
				ELSE SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG type' AND [ListItemNo] = @GastrostomyInsertiontype)
			END
			IF @GastrostomyInsertionBatchNo <> null AND @GastrostomyInsertionBatchNo <> ''  SET @Details = @Details + ' batch ' + @GastrostomyInsertionBatchNo
				
			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		IF @GastrostomyRemoval = 1
			BEGIN
			SET @msg = ' Nasojejunal tube (NJT) removal'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END

		IF @Marking= 1
		BEGIN
			SET @msg =' Abnormality marked'
			SET @Details = ''
			IF @MarkingType > 0 SET @Details = @Details + ' by ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Abno marking' AND [ListItemNo] = @MarkingType)

			IF @Details<>'' SET @msg = @msg + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @Clip= 1
		BEGIN 
			SET @msg = CASE WHEN @ClipNum > 1 THEN  CAST(@ClipNum as varchar(5)) + ' clips'
							WHEN @ClipNum = 1 THEN  CAST(@ClipNum as varchar(5)) + ' clip'
							ELSE 'Clip'
						END
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		-------------------------------
        -- Pyloric/duodenal dilatation
        -------------------------------
		IF @PyloricDilatation= 1
		BEGIN
			SET @msg =' Pyloric dilatation'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		-------------------------------
        -- Balloon Dilatation
        -------------------------------
		IF @BalloonDilatation= 1
		BEGIN
			SET @msg =' Balloon dilatation'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		-------------------------------
        -- Bougie Dilatation
        -------------------------------
		IF @BougieDilatation= 1
		BEGIN
			SET @msg =' Bougie dilatation'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		-------------------------------
        -- Bougie Dilation
        -------------------------------
		IF @BougieDilation= 1
		BEGIN
			SET @msg =' Bougie dilation'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		-------------------------------
        -- Brush Cytology
        -------------------------------
		IF @BrushCytology= 1
		BEGIN
			SET @msg =' Brush cytology'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		-------------------------------
        -- Cholangioscopy
        -------------------------------
		IF @Cholangioscopy= 1
		BEGIN
			SET @msg =' Cholangioscopy'

			--edited by siddik tfs# 2519
			IF @CholangioscopyType > 0
			BEGIN
				IF @CholangioscopyType = 1
					SET @msg = @msg + ': lesion assessment'
				ELSE
					SET @msg = @msg + ': visually directed stone therapy'
			END
			--tfs# 2519 end

			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
		-------------------------------
        -- Stent Change
        -------------------------------
		IF @StentChange= 1
		BEGIN
			SET @msg =' Stent change'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
		-------------------------------
        -- Stent Placement
        -------------------------------
		IF @StentPlacement= 1
		BEGIN
			SET @msg =' Stent placement'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
		-------------------------------
        -- Radio Frequency Ablation
        -------------------------------
		IF @RadioFrequencyAblation= 1
		BEGIN
			SET @msg =' Radio frequency ablation'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		-------------------------------
        -- FNA
        -------------------------------
		IF @FineNeedleAspiration= 1
		BEGIN
			SET @msg =' FNA'
			--2550
			IF @FineNeedleAspirationType = 1 
			BEGIN
				SET @msg = @msg + ' (cystic lession) '
			END
			else set @msg = @msg + ' (solid lession) '

			IF @FNAPerformed > 0
			BEGIN
				SET @msg = @msg + ' Performed ' + CAST(@FNAPerformed as varchar(3))
				IF @FNARetrieved > 0 SET @msg =  @msg + ', Retrieved ' + CAST(@FNARetrieved as varchar(3))
				IF @FNASuccessful > 0 SET @msg =  @msg + ', Successful ' + CAST(@FNASuccessful as varchar(3))
			END
			IF @FNAPerformed = 0 AND @FNARetrieved > 0
			BEGIN
				SET @msg = @msg + ' Retrieved ' + CAST(@FNARetrieved as varchar(3))
				IF @FNASuccessful > 0 SET @msg =  @msg + ', Successful ' + CAST(@FNASuccessful as varchar(3))
			END
			IF @FNAPerformed = 0 AND @FNARetrieved = 0 AND @FNASuccessful > 0
			BEGIN
				SET @msg =  @msg + ' Successful ' + CAST(@FNASuccessful as varchar(3))
			END
			--2550
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		-------------------------------
        -- FNB
        -------------------------------
		IF @FineNeedleBiopsy= 1
		BEGIN
			SET @msg =' FNB'
			--2550,2551
			IF @FNBPerformed > 0
			BEGIN
				SET @msg = @msg + ' Performed ' + CAST(@FNBPerformed as varchar(3))
				IF @FNBRetrieved > 0 SET @msg =  @msg + ', Retrieved ' + CAST(@FNBRetrieved as varchar(3))
				IF @FNBSuccessfull > 0 SET @msg =  @msg + ', Successful ' + CAST(@FNBSuccessfull as varchar(3))
			END
			IF @FNBPerformed = 0 AND @FNBRetrieved > 0
			BEGIN
				SET @msg = @msg + ' Retrieved ' + CAST(@FNBRetrieved as varchar(3))
				IF @FNBSuccessfull > 0 SET @msg =  @msg + ', Successful ' + CAST(@FNBSuccessfull as varchar(3))
			END
			IF @FNBPerformed = 0 AND @FNBRetrieved = 0 AND @FNBSuccessfull > 0
			BEGIN
				SET @msg =  @msg + ' Successful ' + CAST(@FNBSuccessfull as varchar(3))
			END
			--2550,2551---
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
		-------------------------------
        -- Polypectomy
        -------------------------------
		IF @Polypectomy= 1
		BEGIN
			SET @msg =' Polypectomy'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
		IF LTRIM(RTRIM(@other)) <> ''
			BEGIN
			SET @msg =' ' + LTRIM(RTRIM(@other))
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary =  @summary + @msg  +'<br/>'
		END

	END;

	UPDATE dbo.ERS_ERCPTherapeutics 
	SET Summary=@summary 
	WHERE SiteID = @SiteId; --Id = @TherapeuticId

	DROP TABLE #tmp_ERCPTherapeutics;

GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	2519,2550,2551 END
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rony
-- TFS#	2267
-- Description of change
-- PEG Care Instructions 
------------------------------------------------------------------------------------------------------------------------
EXEC dbo.DropIfExist 
    @ObjectName = 'usp_TherapeuticRecordDelete', 
    @ObjectTypePrefix = 'S' 
GO
CREATE PROCEDURE [dbo].[usp_TherapeuticRecordDelete]
(
	  @TherapType AS VARCHAR(20)
	, @RecordId AS INTEGER
	, @SiteId	AS INTEGER
)
AS
-- =============================================
-- Description:	This will Delete Therapeutc Record. Applicable for ERCP and UGI.
--				This also DELETEs record from the dbo.ERS_RecordCount Table- if applicable.
-- =============================================
BEGIN TRY
	BEGIN TRANSACTION
		
	--### ERCP Record
	IF LOWER(@TherapType) = 'ercp'
	BEGIN
		--## First Delete from the Therapeutic Table
		DELETE FROM dbo.ERS_ERCPTherapeutics WHERE id=@RecordId;

		--## Now check whether anymore Therapeutic Record left after this DELETE? If NO then DELETE the 'counter record' in dbo.ERS_RecordCount
		IF NOT EXISTS(SELECT 1 FROM dbo.ERS_ERCPTherapeutics WHERE SiteId=@SiteId)
			DELETE FROM dbo.ERS_RecordCount WHERE SiteId=@SiteId AND Identifier='Therapeutic Procedures';

		IF EXISTS (SELECT 1 FROM dbo.ERS_ERCPTherapeuticStentInsertions WHERE TherapeuticId = @RecordId)
			DELETE FROM ERS_ERCPTherapeuticStentInsertions WHERE TherapeuticId = @RecordId

	END
	--### OGD Record	
	IF LOWER(@TherapType) = 'ogd'		
	BEGIN
		DELETE FROM dbo.ERS_UpperGITherapeutics WHERE id= @RecordId;			
		UPDATE ERS_ProceduresReporting SET PP_NPSAalert = '' WHERE ProcedureID = (select ProcedureId from ERS_RecordCount where SiteId=@SiteId) -- Added by tfs-2267
		IF NOT EXISTS(SELECT 1 FROM dbo.ERS_UpperGITherapeutics WHERE SiteId=@SiteId)			
			DELETE FROM dbo.ERS_RecordCount WHERE SiteId=@SiteId AND Identifier='Therapeutic Procedures';
	END

	COMMIT TRANSACTION
END TRY
BEGIN CATCH
	ROLLBACK
END CATCH

GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	2267
------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rony
-- TFS#	4206
-- Description of change
-- Adding additional Demographic info
------------------------------------------------------------------------------------------------------------------------
------------------- Adding New Column ---------------------
 IF NOT EXISTS (
        SELECT 1
        FROM INFORMATION_SCHEMA.COLUMNS
        WHERE TABLE_NAME = 'ERS_Patients' AND
              COLUMN_NAME IN ('KentOfKin','Modalities')
    )
    BEGIN
		ALTER TABLE dbo.ERS_Patients
            ADD KentOfKin  VARCHAR(255),
			Modalities  VARCHAR(255);
    END
GO
EXEC dbo.DropIfExist 
    @ObjectName = 'patients_save', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[patients_save]
(
	@PatientId INT=NULL,
	@CaseNoteNo VARCHAR(100),
	@Title VARCHAR(20),
	@Forename VARCHAR(100),
	@Surname NVARCHAR(100),
	@DateOfBirth DATETIME,
	@NHSNo VARCHAR(20),
	@Address1 NVARCHAR(500),
	@Address2 NVARCHAR(500),
	@Town NVARCHAR(500),
	@County NVARCHAR(500),
	@PostCode VARCHAR(10),
	@PhoneNo VARCHAR(20), --Telephone
	@Gender VARCHAR(1),
	@EthnicOrigin INT=NULL,
	@JustDownloaded BIT=NULL,
	@Notes VARCHAR(200)=NULL,
	@District VARCHAR(50)=NULL,
	@DHACode NVARCHAR(20)=NULL,
	@GPId INT=NULL,
	@PracticeId INT=NULL,
	@DateOfDeath DATETIME=NULL,
	@AdvocateRequired BIT=NULL,
	@DateLastSeenAlive DATETIME=NULL,
	@CauseOfDeath NVARCHAR(500)=NULL,
	@CodeForCauseOfDeath VARCHAR(100)=NULL,
	@CARelatedDeath BIT=NULL,
	@DeathWithinHospital BIT=NULL,
	@Hospitals INT=NULL,
	@ExtraReferral NVARCHAR(100)=NULL,
	@ConsultantNo INT=NULL,
	@HIVRisk INT=NULL,
	@OutcomeNotes NVARCHAR(100)=NULL,
	@UniqueHospitalId INT=NULL,
	@GPReferralFlag BIT=NULL,
	@OwnedBy VARCHAR(100)=NULL,
	@HasImages BIT=NULL,
	@VerificationStatus VARCHAR(4)=NULL,
	@LoggedInUserId INT,
	@TrustId int,
	@Email VARCHAR(100)=NULL, -- Added by rony tfs-4206
	@MobileNo VARCHAR(30)=NULL,
	@KentOfKin VARCHAR(255)=NULL,
	@Modalities VARCHAR(255)=NULL
)
AS

SET NOCOUNT ON

BEGIN TRANSACTION

BEGIN TRY
       IF @PracticeId = 0 SET @PracticeId = NULL

	   IF ISNULL(@GPId,0) = 0  SELECT @GPId = GPId  FROM dbo.ERS_GPS WHERE [Code] = 'G9999998'
	   --If not found
	   IF ISNULL(@GPId,0) = 0 
	   BEGIN
			INSERT INTO ERS_GPS (Code, Name, [NationalCode], [ExternalCode]) 
			VALUES ('G9999998', 'Not Stated', 'G9999998', 'G9999998')

			SET @GPId = @@IDENTITY
	   END

       --While downloading from PAS, we don't have the PatientId. So use CaseNoteNo to check if an insert or an update is required.
       IF @PatientId IS NULL OR @PatientId = 0
       BEGIN
             SELECT @PatientId = [PatientId] FROM ERS_Patients WHERE HospitalNumber = @CaseNoteNo
       END

	IF ISNULL(@PatientId,0)= 0
	BEGIN
		INSERT INTO ERS_Patients (
			HospitalNumber
			,[Title]
			,[Forename1]
			,[Surname]
			,[Dateofbirth]
			,[NHSNo]
			,[Address1]
			,[Address2]
			,[Address3]
			,[Address4]
			,[Postcode]
			,[Telephone]
			,[GenderId]
			,[EthnicId]
			,[RegGpId]
			,[RegGpPracticeId]
			,[Dateofdeath]
			,Deceased
			,[WhoCreatedId]
			,[WhenCreated]
			,[DHACode]
			,[Email]   -- Added by rony tfs-4206
			,[MobileNo]
			,[KentOfKin]
			,[Modalities]
			)
		VALUES (
			@CaseNoteNo,
			@Title,
			@Forename,
			@Surname,
			@DateOfBirth,
			@NHSNo,
			@Address1,
			@Address2,
			@Town,
			@County,
			@PostCode,
			@PhoneNo,
			(SELECT GenderId FROM ERS_GenderTypes WHERE Code = @Gender),
			NULLIF(@EthnicOrigin, 0),
			@GPId,
			@PracticeId,
			@DateOfDeath,
			CASE WHEN @DateOfDeath IS NULL THEN 0 ELSE 1 END,
			@LoggedInUserId,
			GETDATE(),
			@DHACode,
			@Email,  -- Added by rony tfs-4206
			@MobileNo,
			@KentOfKin,
			@Modalities
			)
		SET @PatientId = SCOPE_IDENTITY()
	END
	ELSE
	BEGIN
		UPDATE 
			ERS_Patients
		SET 
			Title = @Title,
			Forename1 = @Forename,
			Surname = @Surname,
			[Dateofbirth] = @DateOfBirth,
			[NHSNo] = @NHSNo,
			[Address1] = @Address1,
			[Address2] = @Address2,
			[Address3] = @Town,
			[Address4] = @County,
			[Postcode] = @PostCode,
			[Telephone] = @PhoneNo,
			GenderId = (SELECT GenderId FROM ERS_GenderTypes WHERE Code = @Gender),
			[EthnicId] = @EthnicOrigin,
			RegGPId = @GPId,
			RegGpPracticeId = @PracticeId,
			[Dateofdeath] = @DateOfDeath,
			Deceased = CASE WHEN @DateOfDeath IS NULL THEN 0 ELSE 1 END,
			WhoUpdatedId = @LoggedInUserId,
			WhenUpdated = GETDATE(),
			DHACode = @DHACode,
			Email = @Email,  -- Added by rony tfs-4206
			MobileNo = @MobileNo,
			KentOfKin = @KentOfKin,
			Modalities= @Modalities
		WHERE 
			[PatientId] = @PatientId
	END

	IF Exists (Select 1 from ERS_PatientTrusts where PatientId = @PatientId and TrustId = @TrustId)
	Begin
		update ERS_PatientTrusts set HospitalNumber = @CaseNoteNo where PatientId = @PatientId and TrustId = @TrustId
	End
	Else
	Begin
		Insert Into ERS_PatientTrusts (PatientId, TrustId, HospitalNumber) values(@PatientId, @TrustId, @CaseNoteNo)
	End

	SELECT @PatientId
END TRY

BEGIN CATCH
       DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;
    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);
       IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH
IF @@TRANCOUNT > 0 COMMIT TRANSACTION;
GO

EXEC dbo.DropIfExist 
    @ObjectName = 'ERS_VW_PatientswithGP', 
    @ObjectTypePrefix = 'V' 
GO
CREATE VIEW [dbo].[ERS_VW_PatientswithGP]
	AS
	SELECT DISTINCT 
		ROW_NUMBER() OVER (ORDER BY p.PatientId) AS PatientRowId,
		p.PatientId AS PatientId, 
		NULL AS UGIPatientId,
		NULL as ComboId,
		1 AS ERSPatient, 
		p.Title AS Title, 
		p.Forename1 AS Forename1, 
		p.Surname AS Surname, 
		dbo.fnGender(p.GenderId) AS Gender, 
		(Select CODE from ERS_GenderTypes where GenderID = p.GenderId) As GenderCode, 
		p.Forename1 + ' ' + p.Surname AS PatientName, 
		dbo.fnFullAddress(p.Address1, p.Address2, p.Address3, p.Address4, p.Postcode) AS Address, 
		p.Address1 AS Address1, 
		p.Address2 AS Address2, 
		p.Address3 AS Town, 
		p.Address4 AS County,
		p.PostCode,
		p.Telephone,
		p.DateOfBirth AS DateOfBirth, 
		STUFF((SELECT DISTINCT ', '+ HospitalNumber from ERS_PatientTrusts where PatientId = P.PatientId  and isnull(IsMinor, 0) = 0 for xml path('')), 1, 2, '') AS HospitalNumber, 
		p.NHSNo AS NHSNo, 
		p.DateAdded AS DateAdded,
		p.DateUpdated AS DateUpdated,
		p.EthnicId AS EthnicId,
		p.RegGpId as GPId,
		g.CompleteName AS GPName,
		p.RegGpPracticeId AS PracticeId,
		ep.name AS PracticeName,
		dbo.fnFullAddress(ep.Address1, ep.Address2, ep.Address3, ep.Address4, ep.PostCode) AS GPAddress,
		dbo.fnFullAddressHTML(ep.Address1, ep.Address2, ep.Address3, ep.Address4, ep.PostCode) AS GPAddressHTML,
		ep.TelNo AS GPTelNo,
		p.DateOfDeath AS DateOfDeath,
		ISNULL(p.Deceased, 0) AS Deceased,
		p.NHSVerificationStatus,
		p.DHACode,
		p.Email,p.MobileNo,p.KentOfKin,p.Modalities--Added by rony tfs-4206
	FROM ERS_Patients p 
		LEFT JOIN ERS_GPs g ON g.GPId = p.RegGpId
		LEFT JOIN dbo.ERS_Practices ep ON p.RegGpPracticeId = ep.PracticeID
GO

EXEC dbo.DropIfExist 
    @ObjectName = 'patient_select', 
    @ObjectTypePrefix = 'S' 
GO
CREATE PROCEDURE [dbo].[patient_select]
(
	@PatientId	INT,
	@UserId		INT = NULL,
	@UserName	NVARCHAR(255) = ''
)
AS

SET NOCOUNT ON

DECLARE @GPid INT 

BEGIN TRANSACTION

BEGIN TRY

	SELECT P.[Title], P.[Forename1] AS Forename, P.[Surname], P.[Address], 
			P.[Postcode], CASE WHEN ISNULL(P.GPName,'') = '' THEN 'Not Stated' ELSE P.GPName END AS GPName, P.PracticeName,
			ISNULL(P.GPAddress,'') AS GPAddress, 
			P.NHSNo + ' ' + isnull(T.NHSTraceDescription, '') as NHSNo, 
			P.Gender, 
			P.DateOfBirth, 
			STUFF((SELECT DISTINCT ', '+ HospitalNumber from ERS_PatientTrusts where PatientId = P.PatientId  and IsMinor = 0 for xml path('')), 1, 2, '')  as CaseNoteNo, 
			dbo.fnEthnicity(P.EthnicId) AS Ethnicity,
			P.[DateAdded] AS CreatedOn, P.DateUpdated AS ModifiedOn, 
			P.Deceased, P.DateOfDeath, P.Address1, P.Address2, P.Town, P.County, P.GenderCode, P.GPId, P.PracticeId, p.DHACode,
			p.Telephone,p.Email,p.MobileNo,p.KentOfKin,p.Modalities --Added by rony tfs-4206
	FROM ERS_VW_PatientswithGP P
	LEFT JOIN ERS_NHSTraceStatus T on P.NHSVerificationStatus = T.NHSTraceStatusNumber
	WHERE PatientId = @PatientId
		
END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT; 
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH

IF @@TRANCOUNT > 0 COMMIT TRANSACTION;

IF @UserId IS NOT NULL
	INSERT INTO ERS_UserActivityAudit
	(
		[UserID],
		[UserName],
		[Action],
		[ActionDetails],
		[PatientId],	
		[When]	
	)
	VALUES
	(
		@UserId,
		UPPER(@UserName),
		'SELECT',
		NULL,
		@PatientId,
		GETDATE()
	)
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	4206
------------------------------------------------------------------------------------------------------------------------

 ------------------------------------------------------------------------------------------------------------------------
-- Updated by	: Siddik
-- TFS#	4225
-- Description of change: Added cysto type and first ercp in reports section
-------------------------------------------------------------------------------------------------------------------------

EXEC dbo.DropIfExist 
    @ObjectName = 'Procedure_CystoscopyType_Select', 
    @ObjectTypePrefix = 'S' 
GO

CREATE  PROCEDURE [dbo].[Procedure_CystoscopyType_Select]
AS
BEGIN
	SELECT DISTINCT CystoscopyTypeText FROM ERS_Procedure_CystoscopyType 
END
GO

EXEC dbo.DropIfExist 
    @ObjectName = 'first_ercp', 
    @ObjectTypePrefix = 'S' 
GO

EXEC dbo.DropIfExist @ObjectName = 'fnFirstERCP', 
                     @ObjectTypePrefix = 'F'
GO

CREATE FUNCTION dbo.fnFirstERCP
(
    @ProcedureId INT
)
RETURNS VARCHAR(20)
AS
BEGIN
    DECLARE @FirstERCP AS TINYINT,
            @FirstERCPText AS VARCHAR(20) = '',
            @PatientID INT

    SELECT TOP 1 @FirstERCP = FirstERCP, @PatientID = PatientID
    FROM ERS_Procedures
    WHERE ProcedureId = @ProcedureId

    IF @FirstERCP = 0 
        SET @FirstERCPText = 'Not first ERCP'
    ELSE IF @FirstERCP = 1
        SET @FirstERCPText = 'First ERCP'
    ELSE IF @FirstERCP IS NULL
    BEGIN
        IF (dbo.fnShouldIncludeUGI() = 1)
        BEGIN
            -- Check if patient has previously done ERCP in UGI
            IF EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = 'dbo' AND TABLE_NAME = 'ERCP Procedure')
            BEGIN
                IF EXISTS(SELECT TOP 1 1 FROM [ERCP Procedure]
                          WHERE [Patient No] = (SELECT [Combo ID] 
                                                FROM Patient 
                                                WHERE [Patient No] = @PatientID)
                          AND NOT PP2_CompiledOn IS NULL) 
                BEGIN
                    SET @FirstERCPText = 'Not first ERCP'
                END
            END
        END

        -- Check if patient has previously done ERCP in ERS
        IF @FirstERCPText <> 'Not first ERCP'
        BEGIN
            IF EXISTS (SELECT TOP 1 1 FROM ERS_Procedures ep
                       WHERE ep.[PatientID] = @PatientID
                       AND ep.[ProcedureType] = 2
                       AND IsActive = 1
                       AND ep.[ProcedureId] <> @ProcedureId)  
            BEGIN
                SET @FirstERCPText = 'Not first ERCP'
            END
            ELSE
            BEGIN
                SET @FirstERCPText = 'First ERCP'
            END
        END
    END

    RETURN @FirstERCPText
END

GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	4225 END
-------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Muhammad Nasim
-- TFS#	4224
-- Description of change: cystoscopy - haematuria indications
-------------------------------------------------------------------------------------------------------------------------
declare @ParentId int,@IndicationSectionId int,@IndicationId int,@ProcedureTypeId int,@Description varchar(20)
--description cursor for High,Medium,Low
declare DescriptionCursor cursor for 
SELECT v.[Description] FROM (VALUES ('Visible'), ('Non-Visible')) AS v([Description])
open DescriptionCursor
fetch next from DescriptionCursor into @Description
while @@FETCH_STATUS=0
begin
	if not exists(select 1 from [dbo].[ERS_Indications] where [Description]=@Description)
	begin
		--UniqueId of each surveillance type indication
		declare IndicationCursor cursor for 
		select UniqueId,IndicationSectionId from ERS_Indications where Description like '%haematuria%'
		open IndicationCursor
		fetch next from IndicationCursor into @ParentId,@IndicationSectionId
		while @@FETCH_STATUS=0
		begin
			INSERT INTO [dbo].[ERS_Indications]([Description],[NEDTerm],[Suppressed],[AdditionalInfo],[SubIndicationParent],[PlannedProcedure],[ParentId],[IndicationSectionId],[JAGAuditable])
			VALUES(@Description,@Description,0,0,0,0,@ParentId,@IndicationSectionId,0)
			set @IndicationId=SCOPE_IDENTITY()
			--ProcedureTypeId of each UniqueId of each surveillance type indication
			declare ProcedureTypeCursor cursor for 
			select distinct ProcedureTypeId from ERS_IndicationsProcedureTypes where IndicationId=@ParentId
			open ProcedureTypeCursor
			fetch next from ProcedureTypeCursor into @ProcedureTypeId
			while @@FETCH_STATUS=0
			begin
				INSERT INTO [dbo].[ERS_IndicationsProcedureTypes]([IndicationId],[ProcedureTypeId])
				VALUES(@IndicationId ,@ProcedureTypeId)
				fetch next from ProcedureTypeCursor into @ProcedureTypeId
			end
			close ProcedureTypeCursor
			deallocate ProcedureTypeCursor
		
			fetch next from IndicationCursor into @ParentId,@IndicationSectionId
		end
		CLOSE IndicationCursor
		DEALLOCATE IndicationCursor
	end
fetch next from DescriptionCursor into @Description
end
CLOSE DescriptionCursor
DEALLOCATE DescriptionCursor
GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	4224 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Siddik
-- TFS#	4161
-- Description of change: Added Report Summary for Default C02
-------------------------------------------------------------------------------------------------------------------------

IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ERS_ProcedureInsufflation' AND COLUMN_NAME = 'Summary')
BEGIN
	ALTER TABLE ERS_ProcedureInsufflation
	ADD Summary VARCHAR(MAX) NULL;
END
GO

EXEC dbo.DropIfExist 
    @ObjectName = 'procedure_insufflation_save', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[procedure_insufflation_save]
(
	@ProcedureId int,
	@InsufflationId int,
	@LoggedInUserId int
)
AS
BEGIN
	IF NOT EXISTS (SELECT 1 FROM ERS_ProcedureInsufflation WHERE ProcedureId = @ProcedureId)
	BEGIN
	INSERT INTO ERS_ProcedureInsufflation (InsufflationId, ProcedureId, WhoCreatedId, WhenCreated)
	VALUES (@InsufflationId, @ProcedureId, @LoggedInUserId, getdate())
	END
	ELSE
	BEGIN
		UPDATE ERS_ProcedureInsufflation
		SET InsufflationId = @InsufflationId,
			WhoUpdatedId = @LoggedInUserId,
			WhenUpdated = GETDATE()
		WHERE ProcedureId = @ProcedureId
	END

	--edited by siddik tfs# 4161
	DECLARE @InsufflationDescription VARCHAR(MAX)
	SELECT @InsufflationDescription = Description 
		FROM ERS_Insufflation ins 
		JOIN ERS_ProcedureInsufflation pins 
		ON ins.UniqueId = pins.InsufflationId
		WHERE pins.ProcedureId = @ProcedureId

	DECLARE @Summary VARCHAR(MAX) = 'Insufflation gas: ' + @InsufflationDescription

	EXEC UI_update_procedure_summary @ProcedureId, 'Insufflation', 'Insufflation:', @InsufflationId	

	UPDATE ERS_ProcedureInsufflation
	SET Summary = @Summary
	WHERE ProcedureId = @ProcedureId
	--tfs# 4161 end
END

GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	4161 Ended
------------------------------------------------------------------------------------------------------------------------


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	MOSTAFIZUR RAHMAN
-- TFS#	4064
-- Description of change
-- Consent Questions - enhancement
------------------------------------------------------------------------------------------------------------------------

---adding 'Patient_Consent' in ers_listsmain

GO 
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.COLUMNS
    WHERE TABLE_NAME = 'ERS_Procedures'
    AND COLUMN_NAME IN ('PatientConsentType','PatientConsentTypeOther')
)
BEGIN
    
   ALTER TABLE ERS_Procedures
    ADD PatientConsentType INT NULL,
        PatientConsentTypeOther VARCHAR(500) NULL;
END

GO 

DECLARE @ListDescription NVARCHAR(50) = 'Patient_Consent';
IF NOT EXISTS (SELECT 1 FROM ers_listsmain WHERE ListDescription = @ListDescription)
BEGIN
    INSERT INTO ers_listsmain
        (ListDescription, AllowAddNewItem, OrderByDesc, FirstItemText, WhoUpdatedId, WhoCreatedId, whenCreated, whenUpdated, ReferenceTable)
    VALUES
        (@ListDescription, 0, 1, '', NULL, NULL, NULL, NULL, NULL);

	DECLARE @ListMainId INT = SCOPE_IDENTITY();
	DECLARE @ListItems NVARCHAR(MAX) = 'Emergency,Consent 4 Done,Other';
	DECLARE @ListItemText NVARCHAR(50);
	DECLARE @ListItemNo INT=0;


	DECLARE curItems CURSOR  FOR
		SELECT Item  FROM fnSplitString(@ListItems, ',');

	OPEN curItems;

	FETCH NEXT FROM curItems INTO @ListItemText;

	WHILE @@FETCH_STATUS = 0
	BEGIN
		IF NOT EXISTS (
			SELECT 1 
			FROM ers_lists 
			WHERE ListDescription = @ListDescription
			  AND ListItemText = @ListItemText
		)
		BEGIN
			INSERT INTO ers_lists
				(ListDescription, ListItemNo, ListItemText, Suppressed, ReadOnly, ListMainId, WhoUpdatedId, WhoCreatedId, whenCreated, whenUpdated)
			VALUES
				(@ListDescription, @ListItemNo, @ListItemText, 0, 0, @ListMainId, 0, 0, GETDATE(), GETDATE());
    
		Set @ListItemNo+=1
		END

		FETCH NEXT FROM curItems INTO @ListItemText;
	END

	CLOSE curItems;
	DEALLOCATE curItems;

End
GO 
------------------------------------------------------------------------------------------------------------------------
-- TFS#	4064 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	: Siddik
-- TFS#	1441
-- Description of change: Colon Resections change
-------------------------------------------------------------------------------------------------------------------------

IF EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ERS_Procedures' 
	AND COLUMN_NAME = 'ResectedColonNo' AND DATA_TYPE = 'SMALLINT')
BEGIN
	ALTER TABLE ERS_Procedures ALTER COLUMN ResectedColonNo NVARCHAR(100);
END
GO

IF EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_SCHEMA = 'ERSAudit' AND TABLE_NAME = 'ERS_Procedures_Audit'  
	AND COLUMN_NAME = 'ResectedColonNo' AND DATA_TYPE = 'SMALLINT')
BEGIN
	ALTER TABLE ERSAudit.ERS_Procedures_Audit ALTER COLUMN ResectedColonNo NVARCHAR(100);
END

GO

EXEC dbo.DropIfExist 
    @ObjectName = 'fnSetAreaDescription', 
    @ObjectTypePrefix = 'F' 
GO

CREATE FUNCTION [dbo].[fnSetAreaDescription] (@ProcedureId INT, @AreaNo INT, @ResectedColonId VARCHAR(100))
RETURNS
  VARCHAR(MAX)
AS
BEGIN
	
	DECLARE @MinRegionID INT, @MaxRegionID INT, @StartRegionId INT, @SiteDesc VARCHAR(MAX)=''
	DECLARE @tmpSites TABLE (SiteId INT, SiteNo INT, RegionId INT, Region VARCHAR(500), IsAnastamosis BIT)

	--Insert site records in temp table
	INSERT INTO @tmpSites
	SELECT MIN(s.SiteId) AS SiteId, s.SiteNo, s.RegionId, 
			CASE 
				WHEN ISNULL(@ResectedColonId, '') <> ''  AND
				EXISTS (SELECT 1 FROM ERS_Regions r 
							JOIN ERS_ResectedColonRegions rcr ON r.RegionId = rcr.RegionId
							WHERE r.RegionId = s.RegionId
							AND rcr.ResectedColonID IN (SELECT Item FROM fnSplitString(@ResectedColonId, ','))) THEN 'anastomosis'	--tfs 1441
				ELSE MIN(LOWER(r.Region))
				END AS Region, 0
	FROM ERS_Sites s 
	INNER JOIN ERS_Regions r ON s.RegionId = r.RegionId AND s.ProcedureId = @ProcedureId AND s.AreaNo = @AreaNo
	GROUP BY s.RegionId, s.SiteNo, s.RegionId
	ORDER BY SiteId

	--Get start site of the area
	SELECT TOP 1 @StartRegionId = RegionId FROM @tmpSites WHERE SiteNo > 0

	--Get minimum & maximum region id of the area to set as the 2 extremity
	SELECT @MinRegionID = MIN(RegionID), @MaxRegionID = MAX(RegionID) FROM @tmpSites 

	--Delete the rest, not to include in the description of the area
	DELETE FROM @tmpSites WHERE RegionID NOT IN (@MinRegionID, @MaxRegionID) AND SiteNo = 0
	DELETE FROM @tmpSites WHERE RegionID = @StartRegionId AND SiteNo = 0
	DELETE FROM @tmpSites WHERE Region = (SELECT TOP 1 Region FROM @tmpSites WHERE RegionID = @StartRegionId) AND SiteNo = 0 

	DECLARE @RowCnt INT = (SELECT COUNT(SiteId) FROM @tmpSites)

	IF @RowCnt = 1
		SELECT TOP 1 @SiteDesc = 'An area wholly within the '  + Region FROM @tmpSites ORDER BY SiteId
	ELSE IF @RowCnt = 2
	BEGIN
		SET @SiteDesc = 'An area extending from the ' + (SELECT TOP 1 Region FROM @tmpSites WHERE SiteNo > 0) 
							+ ' to the ' + (SELECT TOP 1 Region FROM @tmpSites WHERE SiteNo = 0)
	END
	ELSE IF @RowCnt > 2 -- more than 2 rows (max 3 rows)
	BEGIN
		SET @SiteDesc = 'An area extending from the ' + (SELECT TOP 1 Region FROM @tmpSites WHERE RegionId = @StartRegionId) 
							+ ' through the ' + (SELECT TOP 1 Region FROM @tmpSites WHERE RegionId = @MinRegionID)
							+ ' and ' + (SELECT TOP 1 Region FROM @tmpSites WHERE RegionId = @MaxRegionID)
	END

	RETURN @SiteDesc
END

GO

EXEC dbo.DropIfExist 
    @ObjectName = 'Get_Sites_By_Procedure', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[Get_Sites_By_Procedure]
(
	@ProcedureId as int
)
AS

BEGIN
	SELECT s.Siteid, s.SiteNo, s.AreaNo, s.RegionId , CASE WHEN s.SiteNo = -77 THEN CONVERT(VARCHAR, s.XCoordinate) + 
		CASE WHEN s.YCoordinate IS NULL OR s.YCoordinate = 0 THEN ' cm' ELSE ' to ' + CONVERT(VARCHAR, s.YCoordinate) + ' cm' END
	ELSE CASE WHEN rcr.ResectedColonID IS NOT NULL THEN 'Anastomosis'
	WHEN ISNULL(s.EBUSLymphNodeSiteId,0) = 0
	THEN 
	-- TFS 4046 Start
		CASE
			WHEN s.AreaNo > 0 THEN dbo.fnSetAreaDescriptionForGetSitesBYProcedure(@ProcedureId, s.AreaNo, rcr.ResectedColonID)
			ELSE r.Region 
		END 
	-- TFS 4046 End
	ELSE ln.Name END END as Region,
	ISNULL(dbo.fnGetSiteTitle(s.SiteNo, p.OperatingHospitalID),'') as SiteName
	FROM ERS_Procedures p
	join ERS_Sites s on p.ProcedureId = s.ProcedureId 
	join ERS_Regions r on s.RegionId = r.RegionId and r.ProcedureType = p.ProcedureType 
	left JOIN ERS_ResectedColonRegions rcr ON r.RegionId = rcr.RegionId AND rcr.ResectedColonID IN (SELECT Item FROM fnSplitString(p.ResectedColonNo, ','))	--tfs 1441
	left join ERS_EBUSLymphNodes ln on ln.EBUSLymphNodeId = s.EBUSLymphNodeSiteId
	where (s.SiteNo > 0 or s.SiteNo = -77) and p.ProcedureId = @ProcedureId AND ISNULL(s.IsProtocol,0) = 0
	UNION --tfs 1441
	Select s.Siteid, s.SiteNo, s.AreaNo,s.RegionId, CONVERT(VARCHAR, s.XCoordinate) +
	CASE WHEN s.YCoordinate IS NULL OR s.YCoordinate = 0 THEN ' cm' ELSE ' to ' + CONVERT(VARCHAR, s.YCoordinate) + ' cm' END as Region, 
	ISNULL(dbo.fnGetSiteTitle(s.SiteNo, p.OperatingHospitalID),'') as SiteName
	FROM ERS_Procedures p
	join ERS_Sites s on p.ProcedureId = s.ProcedureId 
	where s.SiteNo = -77 and p.ProcedureId = @ProcedureId AND ISNULL(s.IsProtocol,0) = 0;

END
GO

EXEC dbo.DropIfExist 
    @ObjectName = 'patient_previous_surgery_save', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[patient_previous_surgery_save]
(
	@PreviousSurgeryId varchar(255),	
	@PreviousSurgeryPeriod int,
	@ProcedureId int,
	@PatientId int,
	@LoggedInUserId int
)
AS
BEGIN
	DELETE FROM ERS_PatientPreviousSurgery WHERE PatientId = @PatientId
	IF @PreviousSurgeryId != '-1111' --TFS 4483
	BEGIN
		DECLARE @ResectedColon TABLE (colonId VARCHAR(100))
		DECLARE @SelectedID int, @resectionId int;
		DECLARE db_cursor CURSOR FOR  
		SELECT item  FROM fnSplitString( @PreviousSurgeryId, ',')
		--update ERS_Procedures set ResectedColonNo=null WHERE ProcedureID = @ProcedureId
		OPEN db_cursor
		FETCH NEXT FROM db_cursor INTO @SelectedID
		WHILE @@FETCH_STATUS = 0
		BEGIN
			INSERT INTO ERS_PatientPreviousSurgery (PatientId, PreviousSurgeryId, PreviousSurgeryPeriod, ProcedureCreatedId, WhoCreatedId, WhenCreated)
			VALUES (@PatientId, @SelectedID, @PreviousSurgeryPeriod, @ProcedureId, @LoggedInUserId, getdate())

			DECLARE @ProcedureTypeId INT
			SELECT @ProcedureTypeId = ProcedureType FROM ERS_Procedures WHERE ProcedureId = @ProcedureId

			--check if previous surgery id exists in the procedure types link table, if not, add for this procedure type
			IF NOT EXISTS (SELECT 1 FROM ERS_PreviousSurgeryProcedureTypes WHERE PreviousSurgeryId = @SelectedID AND ProcedureTypeId = @ProcedureTypeId)
			BEGIN
				INSERT INTO ERS_PreviousSurgeryProcedureTypes (PreviousSurgeryId, ProcedureTypeId) VALUES (@SelectedID, @ProcedureTypeId)
			END
		
			set @resectionId=(select resectionId from ERS_PreviousSurgery where UniqueId=@SelectedID)
			if @resectionId is not null
			begin
				INSERT INTO @ResectedColon (colonId) VALUES(@resectionId)
			end
			--DECLARE @ResectionId INT
			--SELECT @ResectionId = ResectionId FROM ERS_PreviousSurgery WHERE UniqueId = @PreviousSurgeryId
			--IF @ResectionId IS NOT NULL
			--BEGIN
			--	UPDATE ERS_Procedures
			--	SET ResectedColonNo = @ResectionId
			--	WHERE ProcedureId = @ProcedureId
			--END

			FETCH NEXT FROM db_cursor INTO @SelectedID   
		END   

		CLOSE db_cursor   
		DEALLOCATE db_cursor

	END
		UPDATE ERS_Procedures 
		SET ResectedColonNo = STUFF((SELECT ', ' + colonId FROM @ResectedColon FOR XML PATH('')), 1, 2, '')
		WHERE ProcedureID = @ProcedureId;

		UPDATE ERS_ProceduresReporting
		SET PP_Indic = dbo.ProcedureIndicationsSummary(@ProcedureId)
		WHERE ProcedureId = @ProcedureId;

		DECLARE @Summary VARCHAR(max) = 'Previous surgery',
				@SurgeryCount int = (SELECT count(*) FROM ERS_PatientPreviousSurgery WHERE (ProcedureCreatedId = @ProcedureId or ProcedureUpdatedId = @ProcedureId))

		EXEC UI_update_procedure_summary @ProcedureId, 'Previous surgery', @Summary, @SurgeryCount
	END
GO

------------------------------------------------------------------------------------------------------------------------
-- TFS#	1441 Ended
------------------------------------------------------------------------------------------------------------------------


 ------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ferdowsi 6/25/2024, Mostafiz 9/22/2024 
-- TFS#	3069 ,4064
-- Description of change
--  Consent Questions - enhancement (4064)
-- Updated by	:	Rony
-- TFS#	4326
-- Description of change
-- Bronch Vocal Cord add other

-- Updated by	:	Ahmed Shoud
-- TFS#	4371
-- Description of change
-- Procedure page data not pulling into report

-- TFS#	4431
-- Description of change
-- ENT Retrograde section missing on report

-- TFS#	4438
-- Description of change
-- NED Validation - ERCP Level of complexity should be conditionally mandatory
-- Updated by	:	Rony
-- TFS#	3513
-- Description of change: V2 Transnasal to be Procedure Title  
------------------------------------------------------------------------------------------------------------------------

EXEC dbo.DropIfExist 
    @ObjectName = 'procedure_summary_update', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[procedure_summary_update]
(
	@ProcedureId INT
)
AS

SET NOCOUNT ON

DECLARE @summaryWhole VARCHAR(MAX)=''
DECLARE @summaryWholeWithHyperLinks VARCHAR(MAX)=''
DECLARE @procType INT
DECLARE @Region VARCHAR(150)
DECLARE @ResectedColonId VARCHAR(100)	--tfs 1441
DECLARE @OperatingHospitalID INT 
DECLARE @QuestionMessage   VARCHAR(MAX)=''
DECLARE @ChecklistComplete BIT= 0 
DECLARE @PatientConsent INT = 1 
DECLARE @CystoOrERCPText VARCHAR(50) = ''	--tfs 4225


BEGIN TRANSACTION

BEGIN TRY

	SELECT @ProcType=ProcedureType, @ResectedColonId=ResectedColonNo FROM ERS_Procedures WHERE ProcedureId = @ProcedureId
	SELECT @OperatingHospitalID = OperatingHospitalID FROM ERS_Procedures WHERE ProcedureId = @ProcedureId

	--edited by siddik tfs# 4225
	SET @CystoOrERCPText = 
	CASE 
		WHEN @procType = 2 
			THEN ISNULL(dbo.fnFirstERCP(@ProcedureId), '') 
		WHEN @procType IN (SELECT ProcedureTypeId FROM ERS_ProcedureTypes WHERE ProcedureType = 'Cystoscopy')
			THEN ISNULL((SELECT TOP 1 ISNULL(CystoscopyTypeId + '<br/>' + 'Procedure Type: ' + CystoscopyProcedureType, '') FROM ERS_ProcedureCystoscopyHeader WHERE ProcedureId = @ProcedureId), '') 
	END
		
	 -- Append Procedure qsn at report section  , added by ferdowsi
   SELECT  @PatientConsent = PatientConsent , @ChecklistComplete = ChecklistComplete  FROM ERS_Procedures WHERE ProcedureId =  @ProcedureId
   if @ChecklistComplete <> 0  
     BEGIN
      SET @QuestionMessage = 'Pre-procedure checklist completed </br>'
	 End
   ELSE 
    BEGIN
      SET @QuestionMessage = 'Pre-procedure checklist incomplete </br>'
    END

	--issue 4064

	SELECT @QuestionMessage = @QuestionMessage + 
		CASE 
			WHEN PatientConsent = 1 THEN 
				CASE 
					WHEN PatientConsentType = 2 THEN 'Patient hasn''t given consent due to ' + ISNULL(NULLIF(PatientConsentTypeOther, ''), 'Other') +'.</br>'
					ELSE 'Patient hasn''t given Consent due to ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Patient_Consent' AND [ListItemNo] = patientConsentType) +'.</br>' 
				END
			ELSE 'The patient has given consent.</br>'
		END
	FROM ERS_Procedures
	WHERE ProcedureId = @ProcedureId

	--issue 4064

	SELECT @QuestionMessage =   @QuestionMessage +   -- added by Ferdowsi
		CASE WHEN PatientNotes = 0 AND PatientReferralLetter = 1
              THEN  'Patient notes NOT available but referral letter/documentation WAS available.<br/>'
			 WHEN PatientNotes = 0 AND PatientReferralLetter = 0
              THEN  'Patient notes NOT available.<br />'
			 WHEN PatientNotes = 1
              THEN 'Patient notes available.<br />'
			 ELSE
			  ''
		END
	FROM ERS_Procedures WHERE ProcedureId = @ProcedureId
		
	

 	-- 'SiteNo is set to -77 for sites By Distance (Col & Sig only)
    SELECT CASE WHEN SiteNo = -77 THEN 
						CASE WHEN s.YCoordinate IS NULL OR s.YCoordinate=0 THEN 'At ' + CONVERT(VARCHAR,s.XCoordinate) + ' cm from anus'
						ELSE ('Starting at ' + CONVERT(VARCHAR,s.XCoordinate) + ' extending to ' + CONVERT(VARCHAR,s.YCoordinate) + ' cm from anus' ) END  + SPACE(400)
			ELSE 'Site ' + dbo.fnGetSiteTitle(SiteNo, @OperatingHospitalID) + ':'  + SPACE(400) END AS SiteName,

			CASE AntPos
				WHEN 1 THEN 'Anterior '
				WHEN 2 THEN 'Posterior '
				ELSE ''
			END +
			CASE 
				WHEN SiteNo = -77 THEN '' 
				WHEN AreaNo > 0 THEN dbo.fnSetAreaDescription(@ProcedureId, AreaNo, @ResectedColonId)
				--edited by siddik --tfs 1441
				WHEN AreaNo = 0 AND NOT EXISTS (SELECT 1 FROM ERS_Regions r 
								JOIN ERS_ResectedColonRegions rcr ON r.RegionId = rcr.RegionId
								WHERE r.RegionId = s.RegionId
								AND rcr.ResectedColonID IN (SELECT Item FROM fnSplitString(@ResectedColonId, ','))) 
								THEN ISNULL(iif(s.IsLymphNode=1,(select l.name from ERS_EBUSLymphNodes l where l.EBUSLymphNodeId=s.EBUSLymphNodeSiteId),--TFS 2407
								(SELECT r.Region FROM ERS_Regions r WHERE r.RegionId = s.RegionId)),'') --TFS 4046
				
				WHEN ISNULL(@ResectedColonId, '') <> ''  AND
						 EXISTS (SELECT 1 FROM ERS_Regions r 
								JOIN ERS_ResectedColonRegions rcr ON r.RegionId = rcr.RegionId
								WHERE r.RegionId = s.RegionId
								AND rcr.ResectedColonID IN (SELECT Item FROM fnSplitString(@ResectedColonId, ','))) THEN 'anastomosis'
				ELSE LOWER(ISNULL((SELECT CASE WHEN 6 IN (SELECT Item FROM fnSplitString(@ResectedColonId, ',')) OR 7 IN (SELECT Item FROM fnSplitString(@ResectedColonId, ',')) AND LOWER(Region) = 'terminal ileum' 
									THEN 'neo-terminal ileum' 
									WHEN 9 IN (SELECT Item FROM fnSplitString(@ResectedColonId, ',')) AND LOWER(Region) = 'terminal ileum' 
									THEN 'ileal pouch' 
									ELSE 
										CASE @ProcType WHEN 11 THEN Region  ELSE  eeln2.Name END 
									END 
								FROM ERS_Regions r 
								WHERE r.RegionId = s.RegionId),''))
				--tfs 1441 end
			END AS SiteDesc,
			
            CASE WHEN ISNULL(SiteSummary, '') <> '' THEN SiteSummary END AS FullSummaryAbnormalities,
            CASE WHEN ISNULL(SiteSummarySpecimens, '') <> '' THEN SiteSummarySpecimens END AS FullSummarySepcimens,
            CASE WHEN ISNULL(SiteSummaryTherapeutics, '') <> '' THEN SiteSummaryTherapeutics END AS FullSummaryTherapeutics,
            CASE WHEN ISNULL(SiteSummaryWithLinks, '') <> '' THEN SiteSummaryWithLinks END AS FullSummaryAbnormalitiesWithLinks,
            CASE WHEN ISNULL(SiteSummarySpecimensWithLinks, '') <> '' THEN SiteSummarySpecimensWithLinks END AS FullSummarySepcimensWithLinks,
            CASE WHEN ISNULL(SiteSummaryTherapeuticsWithLinks, '') <> '' THEN SiteSummaryTherapeuticsWithLinks END AS FullSummaryTherapeuticsWithLinks,
			CASE WHEN SiteNo = -77 THEN ISNULL(s.XCoordinate,0) + 5000 ELSE SiteNo END AS OrderBy
    INTO #Sites
    FROM ERS_Sites s
	LEFT JOIN dbo.ERS_EBUSLymphNodes AS eeln2
		ON s.EBUSLymphNodeSiteId = eeln2.EBUSLymphNodeId
    WHERE ProcedureId = @ProcedureId 
    ORDER BY SiteNo
    --AND ISNULL(SiteSummary, '') <> ''
	IF @procType = 11	--EBUS
		UPDATE #Sites SET SiteName = '<b style="color:#606060;">' + RTRIM(SiteName) + ' ' + dbo.fnFirstLastLetterUpper(SiteDesc) +'</b> '
	ELSE
		UPDATE #Sites SET SiteName = '<b style="color:#606060;">' + RTRIM(SiteName) + ' ' + dbo.fnFirstLetterUpper(SiteDesc) +'</b> '
    SELECT 
            CASE WHEN (FullSummaryAbnormalities is not null or FullSummarySepcimens is not null or FullSummaryTherapeutics is not null)
                    THEN SiteName + ISNULL(FullSummaryAbnormalities, '') + ISNULL(FullSummaryTherapeutics, '') + ISNULL(FullSummarySepcimens, '')
            END AS mysummary,
            CASE WHEN (FullSummaryAbnormalitiesWithLinks is not null or FullSummarySepcimensWithLinks is not null or FullSummaryTherapeuticsWithLinks is not null)
                    THEN SiteName + ISNULL(FullSummaryAbnormalitiesWithLinks, '') + ISNULL(FullSummaryTherapeuticsWithLinks, '') + ISNULL(FullSummarySepcimensWithLinks, '')
            END AS mysummaryWithLinks,
			OrderBy
    INTO #Sites2
    FROM #Sites
 

    --select * from #Sites2
 
    SELECT @summaryWhole = COALESCE (
                        --CASE WHEN @summaryWhole = '' THEN ISNULL(mysummary, '')
                        --ELSE 
                        @summaryWhole + CASE WHEN @summaryWhole <> '' THEN '<br />' END
                        --END
                    ,'') + mysummary,
                    @summaryWholeWithHyperLinks = COALESCE (
                        --CASE WHEN @@summaryWholeWithHyperLinks = '' THEN ISNULL(mysummaryWithLinks, '')
                        --ELSE 
                        @summaryWholeWithHyperLinks + CASE WHEN @summaryWholeWithHyperLinks <> '' THEN '<br />' END
                        --END
                    ,'') + mysummaryWithLinks
    FROM #Sites2
    where mysummary is not null
    order by OrderBy
    --SELECT @summaryWhole, @summaryWholeWithHyperLinks 

    --EXTENT OF INTUBATION
    IF @procType IN (3, 4, 9, (SELECT ProcedureTypeId FROM ERS_ProcedureTypes where ProcedureType = 'Transnasal')) -- TFS 4431,3513 
            BEGIN
            DECLARE @tSummary varchar(5000) = ''
            --DECLARE @lSummary varchar(5000) = ''
            --DECLARE @BowelPrepSettings bit
            --DECLARE @smry varchar(5000) = ''

            --DECLARE @oBPrep varchar(4000) = ISNULL((SELECT ISNULL([PP_Bowel_Prep],'') FROM [ERS_ProceduresReporting] WHERE [ProcedureID] = @ProcedureId),'')
			DECLARE @iInsufflationGas_Col VARCHAR(MAX) = ISNULL((SELECT ISNULL(Summary, '') FROM ERS_ProcedureInsufflation WHERE ProcedureId = @ProcedureId), '') --edited by siddik tfs# 4161            
			DECLARE @AccessViaText VARCHAR(MAX) = (Select 'Access Via : ' + ListItemText FROM ers_lists WHERE ListItemNo=(SELECT Instrument2  FROM ERS_Procedures WHERE ProcedureId = @ProcedureId) And ListDescription='AccessMethod Thoracic') --tfs-3513
			DECLARE @oExtent  varchar(4000) = ISNULL((SELECT TOP 1 ISNULL([Summary], '') FROM  ERS_ProcedureLowerExtent WHERE ProcedureId = @ProcedureId),'')
            DECLARE @oComplications varchar(4000) = ISNULL((SELECT ISNULL(Summary,'') FROM ERS_UpperGIQA WHERE ProcedureId = @ProcedureId),'')
			DECLARE @iPatientSedation_Col varchar(4000) = ISNULL((SELECT ISNULL(Summary,'') FROM ERS_ProcedureSedationScore WHERE ProcedureId = @ProcedureId),'')
            DECLARE @iPatientDiscomfort_Col varchar(4000) = ISNULL((SELECT ISNULL(Summary,'') FROM ERS_ProcedureDiscomfortScore WHERE ProcedureId = @ProcedureId),'')
            DECLARE @oAdverseEvents varchar(MAX) = ISNULL((SELECT dbo.ProcedureAdverseEventsSummary(@ProcedureId)), '')
			-- TFS 4371 Start
			DECLARE @iInstrument1 varchar(MAX) = ISNULL((SELECT s.ScopeName FROM ERS_Procedures p INNER JOIN ERS_Scopes s ON p.Instrument1 = s.ScopeId WHERE ProcedureId = @ProcedureId), '')
			DECLARE @iInstrument2 varchar(MAX) = ISNULL((SELECT '2nd Scope - ' + s.ScopeName FROM ERS_Procedures p INNER JOIN ERS_Scopes s ON p.Instrument2 = s.ScopeId WHERE ProcedureId = @ProcedureId), '')
			DECLARE @iScopeGuideUsed varchar(MAX)
			SET @iScopeGuideUsed = 
			CASE 
				WHEN (SELECT ScopeGuide FROM ERS_Procedures WHERE ProcedureId = @ProcedureId) IS NULL THEN ''
				ELSE CAST((SELECT ScopeGuide FROM ERS_Procedures WHERE ProcedureId = @ProcedureId) AS varchar(1))
			END
			DECLARE @iDistalAttachment VARCHAR(MAX) = ISNULL((SELECT [Description] FROM ERS_ProcedureDistalAttachment pda INNER JOIN ERS_DistalAttachments da ON pda.DistalAttachmentId = da.UniqueId WHERE pda.ProcedureId = @ProcedureId), '')
			DECLARE @iDistalAttachmentAdditionalInfo VARCHAR(MAX) = ISNULL((SELECT pda.AdditionalInfo FROM ERS_ProcedureDistalAttachment pda INNER JOIN ERS_DistalAttachments da ON pda.DistalAttachmentId = da.UniqueId WHERE pda.ProcedureId = @ProcedureId), '')
			DECLARE @iAISoftware VARCHAR(MAX) = ISNULL((SELECT [Description] FROM ERS_ProcedureAISoftware pai INNER JOIN  ERS_AISoftware ai on pai.AISoftwareId = ai.UniqueId WHERE pai.ProcedureId = @ProcedureId), '')
			DECLARE @iAISoftwareName VARCHAR(MAX) = ISNULL((SELECT AISoftwareName FROM ERS_ProcedureAISoftware pai INNER JOIN  ERS_AISoftware ai on pai.AISoftwareId = ai.UniqueId WHERE pai.ProcedureId = @ProcedureId), '')
			DECLARE @iAIOtherSoftwareName VARCHAR(MAX) = ISNULL((SELECT AIOtherSoftwareName FROM ERS_ProcedureAISoftware pai INNER JOIN  ERS_AISoftware ai on pai.AISoftwareId = ai.UniqueId WHERE pai.ProcedureId = @ProcedureId), '')
			DECLARE @iChromendosopy VARCHAR(MAX) = ISNULL((SELECT [Description] FROM ERS_ProcedureChromendosopy pc INNER JOIN ERS_Chromendoscopies c ON pc.ChromendoscopyId = c.UniqueId WHERE pc.ProcedureId = @ProcedureId), '')
            DECLARE @iInsertionTechnique VARCHAR(MAX) = ISNULL((SELECT [Description] FROM ERS_ProcedureInsertionTechnique pit INNER JOIN ERS_InsertionTechniques it ON pit.InsertionTechniqueId = it.UniqueId WHERE pit.ProcedureId = @ProcedureId), '')
			-- TFS 4371 END
			-- TFS 4431 Start
			DECLARE @iTechniqueUsedENT_Retro varchar(100) = ISNULL((SELECT et.Description FROM ERS_ProcedureEnteroscopyTechniques pet INNER JOIN ERS_EnteroscopyTechniques et ON pet.TechniqueId = et.UniqueId WHERE pet.ProcedureId = @ProcedureId), '')
			DECLARE @iDepthOfInsertion varchar(100) = ISNULL((SELECT InsertionLength FROM ERS_ProcedureInsertionDepth WHERE ProcedureId = @ProcedureId), '')
			DECLARE @iTattoed varchar(50) = ISNULL((SELECT Tattooed FROM ERS_ProcedureInsertionDepth WHERE ProcedureId = @ProcedureId), '')
			DECLARE @iPlannedExtend varchar(100) = ISNULL((SELECT e.Description FROM ERS_ProcedurePlannedExtent ppe INNER JOIN ERS_Extent e ON ppe.ExtentId = e.UniqueId WHERE ProcedureId = @ProcedureId), '')
			-- TFS 4431 End
            --IF @oBPrep <> '' AND @oBPrep IS NOT NULL SET  @tSummary = @tSummary + @oBPrep + '<br/>'
			-- TFS 4371 Start
			IF @AccessViaText IS NOT NULL AND @AccessViaText <> '' SET @tSummary = @tSummary + @AccessViaText + '.<br/>' -- tfs-3513
			IF @iInstrument1 IS NOT NULL AND @iInstrument1 <> '' SET @tSummary = @tSummary + '1st Scope: ' + @iInstrument1 + '.<br/>'
			IF @iInstrument2 IS NOT NULL AND @iInstrument2 <> '' SET @tSummary = @tSummary + @iInstrument2 + '.<br/>'
			IF @iScopeGuideUsed IS NOT NULL AND @iScopeGuideUsed <> '' SET @tSummary = @tSummary + 'Scope guide used: ' + CASE WHEN @iScopeGuideUsed = 0 THEN 'No' ELSE 'Yes' END + '.<br/>'
			IF @iDistalAttachment IS NOT NULL AND @iDistalAttachment <> '' SET @tSummary = @tSummary + 'Distal Attachment: ' + @iDistalAttachment + '.<br/>'
			IF @iDistalAttachmentAdditionalInfo IS NOT NULL AND @iDistalAttachmentAdditionalInfo <> '' AND @iDistalAttachment IS NOT NULL AND LOWER(@iDistalAttachment) = 'other' SET @tSummary = @tSummary + 'Distal Attachment Additional Info: ' + @iDistalAttachmentAdditionalInfo + '.<br/>'
			IF @iAISoftware IS NOT NULL AND @iAISoftware <> '' SET @tSummary = @tSummary + 'AI Software used: ' + @iAISoftware + '.<br/>'
			IF @iAISoftwareName IS NOT NULL AND @iAISoftwareName <> '' SET @tSummary = @tSummary + 'AI Software Name: ' + @iAISoftwareName + '.<br/>'
			IF @iAIOtherSoftwareName IS NOT NULL AND @iAIOtherSoftwareName <> '' SET @tSummary = @tSummary + 'AI Other Software Name: ' + @iAIOtherSoftwareName + '.<br/>'
			IF @iChromendosopy IS NOT NULL AND @iChromendosopy <> '' SET @tSummary = @tSummary + 'Chromendoscopy used: ' + @iChromendosopy + '.<br/>'
			IF @iInsertionTechnique IS NOT NULL AND @iInsertionTechnique <> '' SET @tSummary = @tSummary + 'Insertion Technique: ' + @iInsertionTechnique + '.<br/>'
            -- TFS 4371 End
			IF @iInsufflationGas_Col IS NOT NULL AND @iInsufflationGas_Col <> '' SET @tSummary = @tSummary + @iInsufflationGas_Col + '.<br/>'
            -- TFS 4431 Start
			IF @iTechniqueUsedENT_Retro IS NOT NULL AND @iTechniqueUsedENT_Retro <> '' SET @tSummary = @tSummary + 'Technique used: ' + @iTechniqueUsedENT_Retro + '.<br/>'
			IF @iDepthOfInsertion IS NOT NULL AND @iDepthOfInsertion <> 0 SET @tSummary = @tSummary + 'Depth of insertion: ' +  @iDepthOfInsertion + ' cm' + '.<br/>'
			IF @iTattoed IS NOT NULL AND @iTattoed <> 0 
				BEGIN
					SET @tSummary = @tSummary + 'Tattoed: ' + 
					(CASE 
						WHEN @iTattoed = 1 THEN 'Yes'
						ELSE 'No'
					END)
					SET @tSummary = @tSummary +  '.<br/>'
				END
			IF @iPlannedExtend IS NOT NULL AND @iPlannedExtend <> '' SET @tSummary = @tSummary + 'Planned extent: ' + @iPlannedExtend + '.<br/>'
			-- TFS 4431 End
			IF @oExtent <> '' SET  @tSummary = @tSummary + @oExtent + '<br/>'
            IF @oComplications <> '' SET  @tSummary = @tSummary + @oComplications + '<br/>'
			IF @iPatientSedation_Col IS NOT NULL AND @iPatientSedation_Col <> '' SET  @tSummary = @tSummary + @iPatientSedation_Col + '.<br/>'
			IF @iPatientDiscomfort_Col IS NOT NULL AND @iPatientDiscomfort_Col <> '' SET  @tSummary = @tSummary + @iPatientDiscomfort_Col + '.<br/>'
			IF @oAdverseEvents IS NOT NULL AND @oAdverseEvents <> '' SET  @tSummary = @tSummary + @oAdverseEvents + '.<br/>'

            SET @summaryWhole = @tSummary + @summaryWhole
            SET @summaryWholeWithHyperLinks = @tSummary + @summaryWholeWithHyperLinks
    END
    ELSE
            BEGIN
			DECLARE @iERCPText VARCHAR(MAX) = ISNULL(dbo.fnFirstERCP(@ProcedureId), '')	--edited by siddik tfs# 4225
			DECLARE @iCystoscopyType VARCHAR(MAX) = ISNULL((SELECT ISNULL(CystoscopyTypeId + '<br/>' + 'Procedure Type: ' + CystoscopyProcedureType, '') FROM ERS_ProcedureCystoscopyHeader WHERE ProcedureId = @ProcedureId), '') --edited by siddik tfs# 4225
			DECLARE @iInsufflationGas VARCHAR(MAX) = ISNULL((SELECT ISNULL(Summary, '') FROM ERS_ProcedureInsufflation WHERE ProcedureId = @ProcedureId), '') --edited by siddik tfs# 4161
			DECLARE @iVisualisation varchar(5000) = ISNULL((SELECT ISNULL(summary,'') FROM ERS_Visualisation WHERE ProcedureId = @ProcedureId),'')
            DECLARE @iExtent  varchar(5000)= ISNULL((SELECT TOP 1 ISNULL(summary,'') FROM ERS_ProcedureUpperExtent WHERE ProcedureId = @ProcedureId),'')
            DECLARE @iNormalDiag varchar(1000) = ISNULL((SELECT CASE WHEN EXISTS(SELECT 1 FROM ERS_Diagnoses WHERE ProcedureID=@ProcedureId AND MatrixCode='OverallNormal' AND Value='True') THEN 'The whole upper gastro-intestinal track was normal' ELSE '' END),'')
            DECLARE @iPatientSedation varchar(4000) = ISNULL((SELECT ISNULL(Summary,'') FROM ERS_ProcedureSedationScore WHERE ProcedureId = @ProcedureId),'')
            DECLARE @iPatientDiscomfort varchar(4000) = ISNULL((SELECT ISNULL(Summary,'') FROM ERS_ProcedureDiscomfortScore WHERE ProcedureId = @ProcedureId),'')
            DECLARE @iComplications varchar(4000) = ISNULL((SELECT ISNULL(Summary,'') FROM ERS_UpperGIQA WHERE ProcedureId = @ProcedureId),'')
			DECLARE @iAdverseEvents varchar(MAX) = ISNULL((SELECT dbo.ProcedureAdverseEventsSummary(@ProcedureId)), '')
			DECLARE @PapillaryAnatomySummary varchar(4000)  = ISNULL((SELECT Summary FROM ERS_ERCPPapillaryAnatomy WHERE ProcedureId = @ProcedureId),'')
            DECLARE @VocalCordParalysis varchar(4000) = ISNULL((SELECT Description FROM ERS_ProcedureVocalCordParalysis pv INNER JOIN ERS_VocalCordParalysis p ON p.UniqueId = pv.VocalCordParalysisId WHERE ProcedureId = @ProcedureId), '')
			DECLARE @VocalCordAdditionalInformation varchar(4000) = ISNULL((SELECT pv.AdditionalInformation FROM ERS_ProcedureVocalCordParalysis pv INNER JOIN ERS_VocalCordParalysis p ON p.UniqueId = pv.VocalCordParalysisId WHERE ProcedureId = @ProcedureId), '') --Added by rony tfs-4326
			-- TFS 4371 Start
			DECLARE @eInstrument1 varchar(MAX) = ISNULL((SELECT s.ScopeName FROM ERS_Procedures p INNER JOIN ERS_Scopes s ON p.Instrument1 = s.ScopeId WHERE ProcedureId = @ProcedureId), '')
			DECLARE @eInstrument2 varchar(MAX) = ISNULL((SELECT '2nd Scope: ' + s.ScopeName FROM ERS_Procedures p INNER JOIN ERS_Scopes s ON p.Instrument2 = s.ScopeId WHERE ProcedureId = @ProcedureId), '')
			IF @ProcedureId IN (SELECT @ProcedureId  FROM ERS_Procedures WHERE ProcedureType IN (10, 11))
				BEGIN
					Select @eInstrument2 = 'Access Via: ' + ListItemText
					FROM ers_lists WHERE ListItemNo=(SELECT instrument2 FROM ERS_Procedures p WHERE ProcedureId = @ProcedureId) And ListDescription='AccessMethod Thoracic'
				END
			--DECLARE @eScopeGuideUsed varchar(MAX)
			--SET @eScopeGuideUsed = 
			--CASE 
			--	WHEN (SELECT ScopeGuide FROM ERS_Procedures WHERE ProcedureId = @ProcedureId) IS NULL THEN ''
			--	ELSE CAST((SELECT ScopeGuide FROM ERS_Procedures WHERE ProcedureId = @ProcedureId) AS varchar(1))
			--END
			DECLARE @eDistalAttachment VARCHAR(MAX) = ISNULL((SELECT [Description] FROM ERS_ProcedureDistalAttachment pda INNER JOIN ERS_DistalAttachments da ON pda.DistalAttachmentId = da.UniqueId WHERE pda.ProcedureId = @ProcedureId), '')
			DECLARE @eDistalAttachmentAdditionalInfo VARCHAR(MAX) = ISNULL((SELECT pda.AdditionalInfo FROM ERS_ProcedureDistalAttachment pda INNER JOIN ERS_DistalAttachments da ON pda.DistalAttachmentId = da.UniqueId WHERE pda.ProcedureId = @ProcedureId), '')
			DECLARE @eAISoftware VARCHAR(MAX) = ISNULL((SELECT [Description] FROM ERS_ProcedureAISoftware pai INNER JOIN  ERS_AISoftware ai on pai.AISoftwareId = ai.UniqueId WHERE pai.ProcedureId = @ProcedureId), '')
			DECLARE @eAISoftwareName VARCHAR(MAX) = ISNULL((SELECT AISoftwareName FROM ERS_ProcedureAISoftware pai INNER JOIN  ERS_AISoftware ai on pai.AISoftwareId = ai.UniqueId WHERE pai.ProcedureId = @ProcedureId), '')
			DECLARE @eAIOtherSoftwareName VARCHAR(MAX) = ISNULL((SELECT AIOtherSoftwareName FROM ERS_ProcedureAISoftware pai INNER JOIN  ERS_AISoftware ai on pai.AISoftwareId = ai.UniqueId WHERE pai.ProcedureId = @ProcedureId), '')
			DECLARE @eChromendosopy VARCHAR(MAX) = ISNULL((SELECT [Description] FROM ERS_ProcedureChromendosopy pc INNER JOIN ERS_Chromendoscopies c ON pc.ChromendoscopyId = c.UniqueId WHERE pc.ProcedureId = @ProcedureId), '')
			-- TFS 4371 End
			-- TFS 4431 Start
			DECLARE @TechniqueUsedENT_Retro varchar(100) = ISNULL((SELECT et.Description FROM ERS_ProcedureEnteroscopyTechniques pet INNER JOIN ERS_EnteroscopyTechniques et ON pet.TechniqueId = et.UniqueId WHERE pet.ProcedureId = @ProcedureId), '')
			DECLARE @DepthOfInsertion varchar(100) = ISNULL((SELECT InsertionLength FROM ERS_ProcedureInsertionDepth WHERE ProcedureId = @ProcedureId), '')
			DECLARE @Tattoed varchar(50) = ISNULL((SELECT Tattooed FROM ERS_ProcedureInsertionDepth WHERE ProcedureId = @ProcedureId), '')
			DECLARE @PlannedExtend varchar(100) = ISNULL((SELECT e.Description FROM ERS_ProcedurePlannedExtent ppe INNER JOIN ERS_Extent e ON ppe.ExtentId = e.UniqueId WHERE ProcedureId = @ProcedureId), '')
			DECLARE @MucosalVisualisation varchar(200) = ISNULL((SELECT [Description] FROM ERS_MucosalVisualisation WHERE UniqueId = (SELECT MucosalVisualisationId FROM ERS_ProcedureMucosalVisualisation WHERE ProcedureId = @ProcedureId)), '')
			DECLARE @MucosalCleaning varchar(200) = ISNULL((SELECT STUFF((SELECT ', ' + [Description] FROM ERS_MucosalCleaning WHERE UniqueId IN (SELECT MucosalCleaningId FROM ERS_ProcedureMucosalCleaning WHERE ProcedureId = @ProcedureId) FOR XML PATH('')), 1, 1, '')), '')
			DECLARE @LevelOfComplexity varchar(500) = ISNULL((SELECT [Description] FROM dbo.ERS_LevelOfComplexity WHERE UniqueId = (SELECT ComplexityId FROM ERS_ProcedureLevelOfComplexity WHERE ProcedureId = @ProcedureId)), '')
			-- TFS 4431 End
			DECLARE @tSumm varchar(5000) = ''
			DECLARE @VocalCordSummary varchar(4000) = CASE WHEN @VocalCordParalysis ='Other' THEN @VocalCordAdditionalInformation ELSE @VocalCordParalysis END  --Added by rony tfs-4326
			
			IF @iERCPText <> '' AND @procType = 2 SET @tSumm = @tSumm + @iERCPText + '<br/>'
			IF @iCystoscopyType IS NOT NULL AND @iCystoscopyType <> '' SET @tSumm = @tSumm + @iCystoscopyType + '<br/>'
			-- TFS 4371 Start
			IF @procType IN (SELECT ProcedureTypeId FROM ERS_ProcedureTypes WHERE ProcedureType IN ('Bronchoscopy', 'EBUS')) -- TFS 2426 Start
			BEGIN
				DECLARE @eInstruementDetails varchar(max) = ISNULL((SELECT ISNULL(PP_Instrument,'') FROM ERS_ProceduresReporting WHERE ProcedureId = @ProcedureId),'')
				IF @eInstruementDetails IS NOT NULL AND @eInstruementDetails<>'' SET @tSumm = @tSumm + @eInstruementDetails +'<br/>'
			END
			IF @procType NOT IN (SELECT ProcedureTypeId FROM ERS_ProcedureTypes WHERE ProcedureType IN ('Bronchoscopy', 'EBUS')) AND @eInstrument1 IS NOT NULL AND @eInstrument1 <> '' SET @tSumm = @tSumm + '1st Scope: ' + @eInstrument1 + '.<br/>'
			IF @procType NOT IN (SELECT ProcedureTypeId FROM ERS_ProcedureTypes WHERE ProcedureType IN ('Bronchoscopy', 'EBUS')) AND @eInstrument2 IS NOT NULL AND @eInstrument2 <> '' SET @tSumm = @tSumm + @eInstrument2 + '.<br/>' -- TFS 2426 End
			--IF @eScopeGuideUsed IS NOT NULL AND @eScopeGuideUsed <> '' SET @tSumm = @tSumm + 'Scope guide used - ' + CASE WHEN @eScopeGuideUsed = 0 THEN 'No' ELSE 'Yes' END + '.<br/>'
			IF @eDistalAttachment IS NOT NULL AND @eDistalAttachment <> '' SET @tSumm = @tSumm + 'Distal Attachment:  ' + @eDistalAttachment + '.<br/>'
			IF @eDistalAttachmentAdditionalInfo IS NOT NULL AND @eDistalAttachmentAdditionalInfo <> '' AND @eDistalAttachment IS NOT NULL AND LOWER(@eDistalAttachment) = 'other' SET @tSumm = @tSumm + 'Distal Attachment Additional Info: ' + @eDistalAttachmentAdditionalInfo + '.<br/>'
			IF @eAISoftware IS NOT NULL AND @eAISoftware <> '' SET @tSumm = @tSumm + 'AI Software used: ' + @eAISoftware + '.<br/>'
			IF @eAISoftwareName IS NOT NULL AND @eAISoftwareName <> '' SET @tSumm = @tSumm + 'AI Software Name: ' + @eAISoftwareName + '.<br/>'
			IF @eAIOtherSoftwareName IS NOT NULL AND @eAIOtherSoftwareName <> '' SET @tSumm = @tSumm + 'AI Other Software Name: ' + @eAIOtherSoftwareName + '.<br/>'
			IF @eChromendosopy IS NOT NULL AND @eChromendosopy <> '' SET @tSumm = @tSumm + 'Chromendoscopy used: ' + @eChromendosopy + '.<br/>'
			-- TFS 4371 End
			IF @iInsufflationGas IS NOT NULL AND @iInsufflationGas <> '' SET @tSumm = @tSumm + @iInsufflationGas + '.<br/>'
			-- TFS 4431 Start
			IF @MucosalVisualisation IS NOT NULL AND @MucosalVisualisation <> '' SET @tSumm = @tSumm + 'Mucosal Visualisation: ' + @MucosalVisualisation + '.<br/>'
			IF @MucosalCleaning IS NOT NULL AND @MucosalCleaning <> '' SET @tSumm = @tSumm + 'Mucosal Cleaning: ' + @MucosalCleaning + '.<br/>'
			IF @TechniqueUsedENT_Retro IS NOT NULL AND @TechniqueUsedENT_Retro <> '' SET @tSumm = @tSumm + 'Technique used: ' + @TechniqueUsedENT_Retro + '.<br/>'
			IF @DepthOfInsertion IS NOT NULL AND @DepthOfInsertion <> 0 SET @tSumm = @tSumm + 'Depth of insertion: ' +  @DepthOfInsertion + ' cm' + '.<br/>'
			IF @Tattoed IS NOT NULL AND @Tattoed <> 0 
				BEGIN
					SET @tSumm = @tSumm + 'Tattoed: ' + 
					(CASE 
						WHEN @Tattoed = 1 THEN 'Yes'
						ELSE 'No'
					END)
					SET @tSumm = @tSumm +  '.<br/>'
				END
			-- TFS 4431 End
			IF @iVisualisation IS NOT NULL AND @iVisualisation<>'' SET @tSumm = @tSumm + @iVisualisation +'<br/>'
			-- TFS 4431 Start
			IF @PlannedExtend IS NOT NULL AND @PlannedExtend <> '' SET @tSumm = @tSumm + 'Planned extent: ' + @PlannedExtend + '.<br/>'
			-- TFS 4431 End
			IF @iExtent IS NOT NULL AND  @iExtent <> '' SET  @tSumm = @tSumm + @iExtent + '.<br/>'
			-- TFS 4438 Start
			IF @LevelOfComplexity IS NOT NULL AND @LevelOfComplexity <> '' SET @tSumm = @tSumm + 'Level of complexity: ' + @LevelOfComplexity + '.<br/>'
			-- TFS 4438 End
			IF @iNormalDiag IS NOT NULL AND @iNormalDiag <> '' SET  @tSumm = @tSumm + @iNormalDiag + '.<br/>'
			IF @iPatientSedation IS NOT NULL AND @iPatientSedation <> '' SET  @tSumm = @tSumm + @iPatientSedation + '.<br/>'
			IF @iPatientDiscomfort IS NOT NULL AND @iPatientDiscomfort <> '' SET  @tSumm = @tSumm + @iPatientDiscomfort + '.<br/>'
			IF @VocalCordParalysis IS NOT NULL AND @VocalCordParalysis <> '' SET @tSumm = @tSumm + 'Vocal cord paralysis: ' + @VocalCordSummary + '.<br />'  --Added by rony tfs-4326
			IF @iComplications IS NOT NULL AND @iComplications <> '' SET  @tSumm = @tSumm + @iComplications + '.<br/>'
			IF @iAdverseEvents IS NOT NULL AND @iAdverseEvents <> '' SET  @tSumm = @tSumm + @iAdverseEvents + '.<br/>'
			IF @PapillaryAnatomySummary <> '' SET  @tSumm = @tSumm + @PapillaryAnatomySummary + '.<br/>'
            
			IF @procType IN (10,11)
			BEGIN
				DECLARE @iAdditionalReportText varchar(max) = ISNULL((SELECT ISNULL(AdditionalNotes,'') FROM ERS_ProcedureAdditionalNotes WHERE ProcedureId = @ProcedureId),'')
				IF @iAdditionalReportText IS NOT NULL AND @iAdditionalReportText<>'' SET @tSumm = @tSumm + @iAdditionalReportText +'<br/>'
			END

			SET @summaryWhole = @tSumm +@summaryWhole			
            SET @summaryWholeWithHyperLinks = @tSumm + @summaryWholeWithHyperLinks
    END
	IF @QuestionMessage <> ''    -- added by Ferdowsi
	BEGIN 
		SET  @summaryWhole = @QuestionMessage  + @summaryWhole    -- added by Ferdowsi
	END 

	IF @CystoOrERCPText <> ''
	BEGIN
		SET @summaryWhole = @CystoOrERCPText + '<br/>' + @summaryWhole	--edited by siddik tfs# 4225
	END
	
	-- Check for urease test and update summary with checkboxes if set in system settings
	If (Select UreaseTestsIncludeTickBoxes from ERS_SystemConfig where OperatingHospitalID = @OperatingHospitalID) = 1
	BEGIN
		-- now need to check for urease test taken and results unknown
		If (Select count(1) from ERS_UpperGISpecimens where SiteId in (Select SiteId from ERS_Sites where ProcedureId = @ProcedureId) and Urease = 1 and UreaseResult = 0) > 0
		BEGIN
			SET @summaryWhole = replace(@summaryWhole, 'Urease test.', 'Urease test +ve &#x25A1; &nbsp; -ve &#x25A1; &nbsp;')
		END
	END
 
	--EDITED BY MOSTAFIZ 3830
		DECLARE @DNA INT;		
		SELECT @DNA = DNA 
		FROM ERS_PROCEDURES 
		WHERE PROCEDUREID = @ProcedureId;

		IF @DNA IS NOT NULL
		BEGIN
			SET @summaryWhole=''
			SET @summaryWholeWithHyperLinks=''
		END		
	--EDITED BY MOSTAFIZ 3830

	UPDATE ERS_ProceduresReporting
    SET Summary = @summaryWhole,
            SummaryWithLinks = @summaryWholeWithHyperLinks
            --PP_MainReportBody = @summaryAbnormalities,
            --PP_SpecimenTaken = @summarySpecimens,
            --PP_Therapies = @summaryTherapeutics
    WHERE
            ProcedureId = @ProcedureId

    DROP TABLE #Sites
    DROP TABLE #Sites2
END TRY

BEGIN CATCH
       DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

       IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;

Go

 ------------------------------------------------------------------------------------------------------------------------
-- END OF TFS# 3069, 4064, 4371, 4431, 4438
--  
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rony
-- TFS#	3489
-- Description of change
-- Setting Colour code for patients previous reports
------------------------------------------------------------------------------------------------------------------------
EXEC dbo.DropIfExist @ObjectName = 'fnProcedureCategoryIcon', 
                     @ObjectTypePrefix = 'F'
GO
CREATE FUNCTION [dbo].[fnProcedureCategoryIcon]
(
	@Description varchar(40)
)
RETURNS varchar(100)
AS
BEGIN
	DECLARE @CategoryIcon varchar(100)

	DECLARE @Emergency VARCHAR(MAX) = '../Images/NEDJAG/Emergency.png';
	DECLARE @Routine VARCHAR(MAX) = '../Images/NEDJAG/Routine.png';
	DECLARE @Surveillance VARCHAR(MAX) = '../Images/NEDJAG/Surveillance.png';
	DECLARE @UrgentNonCancer VARCHAR(MAX) = '../Images/NEDJAG/UrgentNonCancer.png';
	DECLARE @UrgentCancer VARCHAR(MAX) = '../Images/NEDJAG/UrgentCancer.png';
	
	SELECT @CategoryIcon =  
	CASE WHEN @Description = 'Emergency' THEN @Emergency
	     WHEN @Description = 'Routine' THEN @Routine
		 WHEN @Description = 'Surveillance' THEN @Surveillance
		 WHEN @Description = 'Urgent (non suspected cancer pathway)' THEN @UrgentNonCancer
		 WHEN @Description = 'Urgent (suspected cancer pathway)' THEN @UrgentCancer
	END
	FROM dbo.ERS_UrgencyTypes ut WHERE ut.Description=@Description
	
	RETURN @CategoryIcon
END
GO
EXEC dbo.DropIfExist 
    @ObjectName = 'urgency_types_select', 
    @ObjectTypePrefix = 'S' 
GO
CREATE PROCEDURE [dbo].[urgency_types_select]
AS
BEGIN
	SELECT UniqueId,Description,dbo.fnProcedureCategoryIcon(Description) AS Icon --Added by rony tfs-3489
	FROM ERS_UrgencyTypes
	WHERE Suppressed = 0
	ORDER BY ISNULL(ListOrderBy, 9999)
END

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	3489
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rezaul
-- Description of change
-- Pre-Assessment section
------------------------------------------------------------------------------------------------------------------------

IF NOT EXISTS(SELECT 1 FROM ERS_Pages WHERE PageName = 'Admin Utilities -> PreAssessmentSettings' )
	BEGIN
	declare @groupId int, @pageId int, @parentId int
	SET @pageId = (SELECT MAX(PageId)+1 FROM ERS_Pages)
	select @groupId = GroupId from ERS_PageGroups where GroupName = 'Admin Utilities'
	 INSERT INTO ERS_Pages ( PageId,PageName,PageAlias,AppPageName,GroupId ,PageURL,WhoUpdatedId,WhoCreatedId ,WhenCreated ,WhenUpdated) VALUES
	 (@pageId,'Admin Utilities -> PreAssessmentSettings', 'Pre Assessment Settings','products_options_preassessmentsettings_aspx',@groupId,'~/Products/Options/PreAssessmentSettings.aspx',NULL,0,GETDATE(),NULL);

	INSERT INTO [dbo].[ERS_PagesByRole]([RoleId] ,[PageId],[AccessLevel],[WhoUpdatedId],[WhoCreatedId],[WhenCreated],[WhenUpdated])
     VALUES(1,@pageId,9,null,1, GETDATE(), null)

	select @parentId = mapid FROM ERS_MenuMap WHERE NodeName = 'Admin Utilities'

	INSERT INTO [dbo].[ERS_MenuMap]([ParentID],[NodeName] ,[MenuCategory],[MenuUrl],[isViewer] ,[isDemoVersion] ,[PageID],[MenuIcon] ,[MenuTooltip],[Suppressed] ,[WhoUpdatedId] ,[WhoCreatedId],[WhenCreated]
           ,[WhenUpdated]
           ,[SortOrder])
     VALUES(@parentId, 'Pre Assessment', 'Configure', '~/Products/Options/PreAssessmentSettings.aspx', 1, 0 ,@pageId, null,null,0,null, 1, GETDATE(), null, 0 )
    END    
GO

IF NOT EXISTS (SELECT 1 from sys.objects WHERE object_id = OBJECT_ID('ERS_PreAssessmentSections'))
BEGIN
CREATE TABLE [dbo].[ERS_PreAssessmentSections](
	[SectionId] [int] IDENTITY(1,1) NOT NULL,
	[SectionName] [varchar](100) NOT NULL,
	[Suppressed] [bit] NULL,
	[SortOrder] [int] NULL,
	[WhoUpdatedId] [int]NOT NULL,
	[WhenUpdated] [datetime] NULL,
PRIMARY KEY CLUSTERED 
(
	[SectionId] ASC
))

ALTER TABLE [dbo].[ERS_PreAssessmentSections]  WITH CHECK ADD FOREIGN KEY([WhoUpdatedId])
REFERENCES [dbo].[ERS_Users] ([UserID])

END
GO

IF NOT EXISTS (SELECT 1 from sys.objects WHERE object_id = OBJECT_ID('ERS_PreAssessment'))
BEGIN
CREATE TABLE [dbo].[ERS_PreAssessment](
	[PreAssessmentId] [int] IDENTITY(1,1) NOT NULL,
	[PreAssessmentDate] [datetime] NULL,
	[ProcedureTypes] [varchar](100) NOT NULL,
	[WhoCreated] [int] NOT NULL,
	[WhoUpdated] [int] NULL,
	[WhenUpdated] [datetime] NULL,
	[PatientId] [int] NULL,
PRIMARY KEY CLUSTERED 
(
	[PreAssessmentId] ASC
))ON [PRIMARY]

ALTER TABLE [dbo].[ERS_PreAssessment]  WITH CHECK ADD FOREIGN KEY([WhoCreated])
REFERENCES [dbo].[ERS_Users] ([UserID])

ALTER TABLE [dbo].[ERS_PreAssessment]  WITH CHECK ADD FOREIGN KEY([WhoUpdated])
REFERENCES [dbo].[ERS_Users] ([UserID])

ALTER TABLE [dbo].[ERS_PreAssessment]  WITH CHECK ADD  FOREIGN KEY([PatientId])
REFERENCES [dbo].[ERS_Patients] ([PatientId])

END
GO

IF NOT EXISTS (SELECT 1 from sys.objects WHERE object_id = OBJECT_ID('ERS_PreAssessmentQuestions'))
BEGIN
CREATE TABLE [dbo].[ERS_PreAssessmentQuestions](
	[QuestionId] [int] IDENTITY(1,1) NOT NULL,
	[SectionId] [int] NOT NULL,
	[Question] [varchar](250) NOT NULL,
	[Optional] [bit] NOT NULL,
	[FreeText] [bit] NOT NULL,
	[YesNo] [bit] NOT NULL,
	[Suppressed] [bit] NOT NULL,
	[TrustId] [int] NOT NULL,
	[WhoCreated] [int] NOT NULL,
	[WhenCreated] [datetime] NOT NULL,
	[WhoUpdated] [int] NULL,
	[WhenUpdated] [datetime] NULL,
	[DropdownOption] [bit] NULL,
	[DropdownOptionText] [varchar](500) NULL,
	[UnKnownOption] [int] NULL,
	[SortOrder] [int] NULL,
PRIMARY KEY CLUSTERED 
(
	[QuestionId] ASC
))
ALTER TABLE [dbo].[ERS_PreAssessmentQuestions]  WITH CHECK ADD FOREIGN KEY([SectionId])
REFERENCES [dbo].[ERS_PreAssessmentSections] ([SectionId])

ALTER TABLE [dbo].[ERS_PreAssessmentQuestions]  WITH CHECK ADD FOREIGN KEY([TrustId])
REFERENCES [dbo].[ERS_Trusts] ([TrustID])

ALTER TABLE [dbo].[ERS_PreAssessmentQuestions]  WITH CHECK ADD FOREIGN KEY([WhoCreated])
REFERENCES [dbo].[ERS_Users] ([UserID])

ALTER TABLE [dbo].[ERS_PreAssessmentQuestions]  WITH CHECK ADD FOREIGN KEY([WhoUpdated])
REFERENCES [dbo].[ERS_Users] ([UserID])
END
GO

IF NOT EXISTS (SELECT 1 from sys.objects WHERE object_id = OBJECT_ID('ERS_PreAssessmentAnswers'))
BEGIN
CREATE TABLE [dbo].[ERS_PreAssessmentAnswers](
	[AnswerId] [int] IDENTITY(1,1) NOT NULL,
	[PreAssessmentId] [int] NOT NULL,
	[QuestionId] [int] NOT NULL,
	[FreeTextAnswer] [varchar](max) NULL,
	[OptionAnswer] [int] NULL,
	[WhoCreated] [int] NOT NULL,
	[WhenCreated] [datetime] NOT NULL,
	[WhoUpdated] [int] NULL,
	[WhenUpdated] [datetime] NULL,
	[DropdownAnswer] [varchar](100) NULL
PRIMARY KEY CLUSTERED 
(
	[AnswerId] ASC
))
ALTER TABLE [dbo].[ERS_PreAssessmentAnswers]  WITH CHECK ADD  FOREIGN KEY([WhoCreated])
REFERENCES [dbo].[ERS_Users] ([UserID])

ALTER TABLE [dbo].[ERS_PreAssessmentAnswers]  WITH CHECK ADD FOREIGN KEY([PreAssessmentId])
REFERENCES [dbo].[ERS_PreAssessment] ([PreAssessmentId])

ALTER TABLE [dbo].[ERS_PreAssessmentAnswers]  WITH CHECK ADD   FOREIGN KEY([QuestionId])
REFERENCES [dbo].[ERS_PreAssessmentQuestions] ([QuestionId])


ALTER TABLE [dbo].[ERS_PreAssessmentAnswers]  WITH CHECK ADD  FOREIGN KEY([WhoUpdated])
REFERENCES [dbo].[ERS_Users] ([UserID])

END
GO

IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.COLUMNS
    WHERE TABLE_NAME = 'ers_procedures'
    AND COLUMN_NAME IN ('PreAssessmentId')
)
BEGIN

ALTER TABLE ers_procedures
ADD PreAssessmentId INT NULL;

ALTER TABLE ers_procedures
ADD CONSTRAINT FK_ERS_PreAssessment
FOREIGN KEY (PreAssessmentId) REFERENCES ERS_PreAssessment(PreAssessmentId);

END
Go

IF EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.COLUMNS
    WHERE TABLE_NAME = 'ERS_ProcedureCoMorbidity'
    AND COLUMN_NAME IN ('ProcedureId')
)
BEGIN

ALTER TABLE ERS_ProcedureCoMorbidity
ALTER COLUMN ProcedureId INT NULL;
END
GO

IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.COLUMNS
    WHERE TABLE_NAME = 'ERS_ProcedureCoMorbidity'
    AND COLUMN_NAME IN ('PreAssessmentId')
)
BEGIN

ALTER TABLE ERS_ProcedureCoMorbidity
Add  PreAssessmentId INT NULL;

ALTER TABLE ERS_ProcedureCoMorbidity
ADD CONSTRAINT FK_ERS_PreAssessment_Comorbidity
FOREIGN KEY (PreAssessmentId) REFERENCES ERS_PreAssessment(PreAssessmentId);

END
ELSE
BEGIN
	IF EXISTS (SELECT CONSTRAINT_NAME FROM INFORMATION_SCHEMA. TABLE_CONSTRAINTS WHERE TABLE_NAME = 'ERS_ProcedureCoMorbidity' AND CONSTRAINT_TYPE = 'FK_ERS_PreAssessment')
	BEGIN
		ALTER TABLE dbo.ERS_ProcedureCoMorbidity DROP CONSTRAINT FK_ERS_PreAssessment

		ALTER TABLE ERS_ProcedureCoMorbidity
		ADD CONSTRAINT FK_ERS_PreAssessment_Comorbidity
		FOREIGN KEY (PreAssessmentId) REFERENCES ERS_PreAssessment(PreAssessmentId);
	END
END
Go

 IF NOT EXISTS (
        SELECT 1
        FROM INFORMATION_SCHEMA.COLUMNS
        WHERE TABLE_NAME = 'ERS_PreAssessment' AND
              COLUMN_NAME IN ('IsComplete')
    )
    BEGIN
		ALTER TABLE ERS_PreAssessment
            ADD IsComplete  BIT NULL
    END
GO

EXEC dbo.DropIfExist @ObjectName = 'Add_Or_Update_New_Question_Item',  
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[Add_Or_Update_New_Question_Item]
(
	 @SectionId		AS INT
	,@QuestionId		AS INT
	,@Question		AS VARCHAR(500) = NULL
	,@Optional		AS BIT = NULL
	,@FreeText		AS BIT = NULL
	,@YesNo			AS BIT = NULL
	,@DropdownOption	AS BIT = NULL
	,@DropdownOptionText	AS VARCHAR(500) = ''
	,@TrustId		AS INT
	,@IsSuppressed		AS BIT = NULL
	,@LoggedInUserId	AS INT
	,@SortOrder AS INT NULL = null
)
AS
SET NOCOUNT ON

		IF NOT EXISTS (SELECT 1 FROM ERS_PreAssessmentQuestions WHERE QuestionId = @QuestionId )
		BEGIN
			INSERT INTO dbo.ERS_PreAssessmentQuestions
			(
				Question,
				SectionId,
				Optional,
				[FreeText],
				YesNo,
				UnknownOption,
				DropdownOption,
				DropdownOptionText,
				Suppressed,
				TrustId,
				WhoCreated,
				WhenCreated,
				SortOrder
			)
			values(@Question,@SectionId,@Optional,@FreeText,@YesNo,0,@DropdownOption,@DropdownOptionText,0,3,@LoggedInUserId,GETDATE(),@SortOrder)
		END
		else
		BEGIN
			DECLARE @PrevSuppressed bit
			select @PrevSuppressed = Suppressed from ERS_PreAssessmentQuestions where QuestionId = @QuestionId

			If @IsSuppressed is not null and @IsSuppressed <> @PrevSuppressed
				BEGIN
					UPDATE ERS_PreAssessmentQuestions SET Suppressed = @IsSuppressed WHERE @QuestionId = QuestionId
				END
			ELSE
				BEGIN
					UPDATE [dbo].[ERS_PreAssessmentQuestions]
					   SET [Question]=  @Question 
						 , [SectionId]	=  @SectionId 
						 , [TrustId]	= @TrustId 
						 , [Optional]		=  @Optional 
						 , [FreeText]		= @FreeText 
						 , [YesNo]		= @YesNo 
						 , [DropdownOption]		=  @DropdownOption 
						 , [DropdownOptionText]		=  @DropdownOptionText
						 , [WhoUpdated] = @LoggedInUserId
						 , [WhenUpdated] = GETDATE()
						 ,[SortOrder] =  @SortOrder 
					 WHERE [dbo].[ERS_PreAssessmentQuestions].QuestionId = @QuestionId;
				END
		END
 IF @@ROWCOUNT > 0 
		RETURN 1;
	ELSE 
		RETURN 0;
GO

EXEC dbo.DropIfExist @ObjectName = 'Add_Or_Update_New_Section_Item',  
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[Add_Or_Update_New_Section_Item]
(
	@SectionId int ,
	@sectionName varchar(50),
	@order int null,
	@IsSuppressed BIT = NULL,
	@loggedInUserId int
)
AS

	BEGIN
		IF NOT EXISTS (SELECT 1 FROM ERS_PreAssessmentSections WHERE SectionId = @SectionId)
		BEGIN
			INSERT INTO dbo.ERS_PreAssessmentSections
			(
				SectionName,
				SortOrder,
				Suppressed,
				WhenUpdated,
				WhoUpdatedId
			)
			values(@sectionName,@order,0,GETDATE(),@LoggedInUserId)
		END
		ELSE
		BEGIN
			
			DECLARE @prevSuppressed bit
			select @prevSuppressed = Suppressed from ERS_PreAssessmentSections where SectionId = @SectionId

			If @IsSuppressed is not null  and @prevSuppressed <> @IsSuppressed
			BEGIN
				UPDATE ERS_PreAssessmentSections SET Suppressed = @IsSuppressed WHERE SectionId = @SectionId
			END	
			ELSE
			Begin
				UPDATE [dbo].[ERS_PreAssessmentSections]
				   SET [SectionName]= @SectionName
					 , [SortOrder]	= @Order
					 , [WhoUpdatedId] = @LoggedInUserId
					 , [WhenUpdated] = GETDATE()
				 WHERE [dbo].[ERS_PreAssessmentSections].SectionId = @SectionId;
				END
			END
	IF @@ROWCOUNT > 0 
		RETURN 1;
	ELSE 
		RETURN 0;
	END
GO

EXEC dbo.DropIfExist @ObjectName = 'ERS_PreAssessment_Save',  
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[ERS_PreAssessment_Save]
(
	@ProcedureType varchar(100) = '', 
	@LoggedInUserId int,
	@PatientId int,
	@PreAssessmentId int = 0,
	@IsComplete bit = 0,
	@PreAssessmentDate dateTime
)
AS
BEGIN
		declare @PreAssessId int = 0
		IF NOT EXISTS (SELECT 1 FROM ERS_PreAssessment WHERE PreAssessmentId= @PreAssessmentId)
		BEGIN
			INSERT INTO [dbo].[ERS_PreAssessment] (PreAssessmentDate, ProcedureTypes, WhoCreated, PatientId, IsComplete)
			VALUES (getdate(),@ProcedureType, @LoggedInUserId, @PatientId, 0)
			SET @PreAssessId = SCOPE_IDENTITY();
		END
		ELSE
		BEGIN
			UPDATE 
				ERS_PreAssessment 
			SET 
				
				ProcedureTypes = @ProcedureType,
				WhenUpdated = getdate(),
				PreAssessmentDate = @PreAssessmentDate,
				WhoUpdated = @LoggedInUserId,
				IsComplete = case when IsComplete = 1 then 1 else  @IsComplete end
			WHERE 
				PreAssessmentId = @PreAssessmentId
				SET @PreAssessId = @PreAssessmentId;
		END
		SELECT @PreAssessId AS PreAssessmentId;
End
GO

EXEC dbo.DropIfExist @ObjectName = 'Get_PreAssessmentQuestions_list',  
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[Get_PreAssessmentQuestions_list]
AS
select e.SectionName, p.SectionId,p.QuestionId,p.Suppressed, p.Question,p.SortOrder, p.Optional, p.[FreeText], p.YesNo,p.DropdownOption,p.DropdownOptionText from dbo.ERS_PreAssessmentQuestions p
left join ERS_PreAssessmentSections e on p.SectionId = e.SectionId
where e.Suppressed = 0
ORDER BY 
        CASE 
            WHEN p.SortOrder IS NULL THEN 1
            ELSE 0 
        END, 
        p.SortOrder ASC;
GO

EXEC dbo.DropIfExist @ObjectName = 'Get_section_list',  
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[Get_section_list]
AS
BEGIN
SELECT s.sectionid,s.sectionname,s.suppressed,s.sortorder
FROM dbo.ERS_PreAssessmentSections s
ORDER BY SortOrder ASC
end
GO

EXEC dbo.DropIfExist @ObjectName = 'ValidateMandatoryQuestions',  
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[ValidateMandatoryQuestions]
    @PreAssessmentId INT
AS
BEGIN
    DECLARE    @IncompleteSections NVARCHAR(MAX) 
    DECLARE @QuestionName NVARCHAR(MAX)

    SET @IncompleteSections = ''

    DECLARE unansweredCursor CURSOR FOR
    SELECT eppq.Question
    FROM dbo.ERS_PreAssessmentQuestions eppq
    LEFT JOIN ERS_PreAssessmentAnswers pa 
        ON pa.QuestionId = eppq.QuestionId 
        AND pa.PreAssessmentId = @PreAssessmentId
    WHERE eppq.Optional = 1 
    AND eppq.Suppressed = 0
    AND (
        (eppq.YesNo = 1 AND pa.OptionAnswer IS NULL) OR
        (eppq.[FreeText] = 1 AND pa.FreeTextAnswer IS NULL) OR
		(eppq.DropdownOption = 1 AND (pa.DropdownAnswer is null or pa.DropdownAnswer = ''))
    );

    OPEN unansweredCursor

    FETCH NEXT FROM unansweredCursor INTO @QuestionName

    WHILE @@FETCH_STATUS = 0
    BEGIN
        SET @IncompleteSections = @IncompleteSections  + @QuestionName + ' is required.' +  '<br />'
        FETCH NEXT FROM unansweredCursor INTO @QuestionName
    END

    CLOSE unansweredCursor
    DEALLOCATE unansweredCursor
	select @IncompleteSections
END
GO

EXEC dbo.DropIfExist @ObjectName = 'Pre_Assessment_Answers_Save',  
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[Pre_Assessment_Answers_Save]
(
	@PreAssessmentId int,
	@QuestionId	int,
	@AnswerId int NULL,
	@OptionAnswer int = null,
	@FreeTextAnswer varchar(max) = NULL,
	@DropdownAnswer varchar(100) = '',
	@LoggedInUserId int
)
AS
BEGIN
	DECLARE @Optional BIT = (SELECT epq.Optional FROM dbo.ERS_PreAssessmentQuestions epq WHERE epq.QuestionId=@QuestionId)

	IF NOT EXISTS (SELECT 1 FROM ERS_PreAssessmentAnswers WHERE QuestionId = @QuestionId AND PreAssessmentId = @PreAssessmentId)
	BEGIN
		INSERT INTO ERS_PreAssessmentAnswers (PreAssessmentId, QuestionId, OptionAnswer, FreeTextAnswer,DropdownAnswer , WhoCreated, WhenCreated)
		VALUES (@PreAssessmentId, @QuestionId,  @OptionAnswer , @FreeTextAnswer,@DropdownAnswer, @LoggedInUserId, getdate())
	END
	ELSE
	BEGIN
		UPDATE ERS_PreAssessmentAnswers
		SET OptionAnswer= @OptionAnswer, FreeTextAnswer = @FreeTextAnswer,DropdownAnswer = @DropdownAnswer, WhoUpdated = @LoggedInUserId, WhenUpdated = getdate()
		WHERE PreAssessmentId = @PreAssessmentId AND QuestionId = @QuestionId	
	END

END
GO

EXEC dbo.DropIfExist @ObjectName = 'Remove_PreAssessment_And_Comorbidity',  
                     @ObjectTypePrefix = 'S'
GO
CREATE PROCEDURE [dbo].[Remove_PreAssessment_And_Comorbidity]
(
	@preAssessmentId int

)
AS

	BEGIN
		IF EXISTS (SELECT 1 FROM ERS_PreAssessment WHERE PreAssessmentId = @preAssessmentId)
		BEGIN
			Delete from ERS_ProcedureComorbidity where PreAssessmentId =  @PreAssessmentId
			Delete from ERS_PreAssessmentAnswers where PreAssessmentId = @PreAssessmentId
			Delete from ERS_PreAssessment where PreAssessmentId = @PreAssessmentId
			
		END

	IF @@ROWCOUNT > 0 
		RETURN 1;
	ELSE 
		RETURN 0;
	END
GO

EXEC dbo.DropIfExist @ObjectName = 'procedure_comorbidity_save',  
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[procedure_comorbidity_save]
(
	@ProcedureId int  = null, 
	@ComorbidityId int, 
	@ChildComorbidityId int, 
	@Selected bit,
	@AdditionalInfo varchar(max),
	@LoggedInUserId int,
	@PreAssessmentId int  = null
)
AS
BEGIN
	IF @Selected = 1
	BEGIN
		IF NOT EXISTS (SELECT 1 FROM ERS_ProcedureComorbidity WHERE ComorbidityId = @ComorbidityId AND ((ProcedureId = @ProcedureId and @PreAssessmentId is null) or( PreAssessmentId = @PreAssessmentId and @ProcedureId is null)))
		BEGIN
			INSERT INTO [dbo].[ERS_ProcedureComorbidity] (ProcedureId,PreAssessmentId, ComorbidityId, ChildComorbidityId, AdditionalInformation, WhoCreatedId, WhenCreated)
			VALUES (@ProcedureId,@PreAssessmentId, @ComorbidityId, @ChildComorbidityId, @AdditionalInfo, @LoggedInUserId, getdate())

			IF @ComorbidityId = (SELECT UniqueId FROM dbo.ERS_Comorbidity WHERE Description = 'None')
				DELETE FROM dbo.ERS_ProcedureComorbidity WHERE (ProcedureId = @ProcedureId or PreAssessmentId = @PreAssessmentId )AND ComorbidityId <> @ComorbidityId
		END
		ELSE
		BEGIN
			UPDATE 
				ERS_ProcedureComorbidity 
			SET 
				ComorbidityId = @ComorbidityId,
				ChildComorbidityId = @ChildComorbidityId,
				AdditionalInformation = @AdditionalInfo,
				WhenUpdated = getdate(),
				WhoUpdatedId = @LoggedInUserId
				where
			 ComorbidityId = @ComorbidityId
					AND (
						(@ProcedureId > 0 AND ProcedureId = @ProcedureId AND PreAssessmentId IS NULL) 
						OR 
						(@PreAssessmentId > 0 AND PreAssessmentId = @PreAssessmentId AND ProcedureId IS NULL)
					);
		END
	END
	ELSE
	BEGIN
		DELETE FROM ERS_ProcedureComorbidity WHERE (ProcedureId = @ProcedureId or PreAssessmentId = @PreAssessmentId) AND ComorbidityId = @ComorbidityId 
	END
	if @ProcedureId > 0
	BEGIN
		DECLARE @Summary VARCHAR(max) = dbo.ProcedureIndicationsSummary(@ProcedureId),
				@ComorbidityCount int = (SELECT count(*) FROM ERS_ProcedureComorbidity WHERE ProcedureId = @ProcedureId)

		EXEC UI_update_procedure_summary @ProcedureId, 'Comorbidity', @Summary, @ComorbidityCount

		UPDATE ERS_ProceduresReporting
		SET PP_Indic = @Summary
		WHERE ProcedureId = @ProcedureId
	END
END
GO

EXEC dbo.DropIfExist @ObjectName = 'procedure_comorbidity_select',  
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[procedure_comorbidity_select]
(
	@ProcedureId int null,
	@PreAssessmentId int null
)
AS
BEGIN
	SELECT ComorbidityId, ChildComorbidityId, AdditionalInformation
	FROM ERS_ProcedureComorbidity epm
	WHERE (ProcedureId = @ProcedureId and @PreAssessmentId is null) or (PreAssessmentId = @PreAssessmentId and @ProcedureId is null)
END
GO


EXEC dbo.DropIfExist @ObjectName = 'comorbidity_select',      
                     @ObjectTypePrefix = 'S' 
GO
CREATE PROCEDURE [dbo].[comorbidity_select]
(
	@ProcedureTypeId varchar(100)
)
AS
BEGIN
	SELECT DISTINCT c.UniqueId, c.Description, c.NEDTerm,  c.Suppressed, ISNULL(c.ParentId, 0) AS ParentId,  c.AdditionalInfo,
                ISNULL(c.ListOrderBy, 999) AS ListOrderBy FROM ERS_Comorbidity c
			INNER JOIN ERS_ComorbidityProcedureTypes cpt
			ON cpt.ComorbidityId = c.UniqueId
			WHERE cpt.ProcedureTypeId IN (
					SELECT CAST(item AS INT) 
					FROM fnSplitString(@ProcedureTypeId, ',')
				)
				ORDER BY ISNULL(c.ListOrderBy, 999), c.Description
END
GO



IF NOT EXISTS (SELECT 1 FROM ERS_AuditReports WHERE AuditReportDescription = 'Pre Assessment')
BEGIN
INSERT INTO ERS_AuditReports (AuditReportDescription, AuditReportStoredProcedure, ReportModule)
	VALUES ('Pre Assessment', 'Audit_Preassessment_Answers', 'R');
END
GO


EXEC dbo.DropIfExist @ObjectName = 'Audit_Preassessment_Answers',      
                     @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[Audit_Preassessment_Answers]
(
    @UserId INT
)
AS
BEGIN
    DECLARE @FromDate DATE,
            @ToDate DATE,
            @TrustId INT,
            @columns NVARCHAR(MAX) = '',
            @sql NVARCHAR(MAX) = '';

    SELECT @FromDate = FromDate,
           @ToDate = ToDate,
           @TrustId = TrustId
    FROM ERS_ReportFilter
    WHERE UserID = @UserId;

	CREATE TABLE #TempPreAssessmentData (
		PreAssessmentId INT,
		PreAssessmentDate varchar(50),
		ProcedureType VARCHAR(MAX),
		Comorbidity Varchar(500),
		Question VARCHAR(500),
		Answer VARCHAR(MAX)
	);


INSERT INTO #TempPreAssessmentData (PreAssessmentId, PreAssessmentDate, ProcedureType,Comorbidity, Question, Answer)
SELECT
    pa.PreAssessmentId,
    cast(pa.PreAssessmentDate as date),
    STUFF((SELECT ',' + pt.ProcedureType 
           FROM ERS_ProcedureTypes pt
           JOIN fnSplitString(pa.ProcedureTypes, ',') spt ON pt.ProcedureTypeId = spt.item
           FOR XML PATH('')), 1, 1, '') AS ProcedureType,
		   	STUFF((SELECT ', ' + Description FROM ERS_Comorbidity WHERE UniqueId IN (SELECT comorbidityId FROM ERS_ProcedureComorbidity WHERE PreAssessmentId = pa.PreAssessmentId) FOR XML PATH(''), TYPE).value('.', 'NVARCHAR(MAX)'), 1, 2, '')  AS [Comorbidity],
    q.Question,
	 (ISNULL(ans.FreeTextAnswer,'') + 
		case 
			when ISNULL(ans.FreeTextAnswer,'') = '' THEN 
		ISNULL(
			CASE 
					WHEN CAST(ans.OptionAnswer AS VARCHAR(10)) = '1' THEN 'Yes'
					WHEN CAST(ans.OptionAnswer AS VARCHAR(10)) = '0' THEN 'No'
					ELSE ans.DropdownAnswer
				END, 
			'') 
			ELSE
			ISNULL(
			CASE 
					WHEN CAST(ans.OptionAnswer AS VARCHAR(10)) = '1' THEN ' (Yes)'
					WHEN CAST(ans.OptionAnswer AS VARCHAR(10)) = '0' THEN ' (No)'
					ELSE 
					case
						when Isnull(ans.DropdownAnswer ,'') = '' then ''
						else ' (' + ans.DropdownAnswer + ')' 
						end
				END, 
			'')end) AS Answer
	FROM
		ERS_PreAssessmentAnswers ans
	JOIN
		ERS_PreAssessmentQuestions q ON ans.QuestionId = q.QuestionId
	JOIN
		ERS_PreAssessment pa ON ans.PreAssessmentId = pa.PreAssessmentId
	JOIN
		ERS_Patients p ON p.PatientId = pa.PatientId
	WHERE pa.PreAssessmentDate  >= @FromDate AND pa.PreAssessmentDate <= @ToDate and pa.IsComplete = 1

SELECT @columns = STUFF((SELECT DISTINCT ', [' + Question + ']' FROM #TempPreAssessmentData FOR XML PATH('')), 1, 2, '');

SET @sql = '
SELECT  PreAssessmentDate, ProcedureType, Comorbidity, ' + @columns + '
FROM #TempPreAssessmentData
PIVOT (
    MAX(Answer) 
    FOR Question IN (' + @columns + ')
) AS PivotTable
ORDER BY PreAssessmentDate;';


EXEC sp_executesql @sql;

DROP TABLE #TempPreAssessmentData;
END
GO


EXEC dbo.DropIfExist @ObjectName = 'usp_Procedures_SelectByPatient',  
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

SET ANSI_NULLS ON;
GO
SET ANSI_WARNINGS ON;
GO
SET QUOTED_IDENTIFIER ON;
GO

CREATE PROCEDURE [dbo].[usp_Procedures_SelectByPatient]
(
    @UserName Varchar(200),
	@PatientId INT,
	@IncludeOldProcs BIT = 1,
	@ActiveProceduresOnly BIT = 1 -- Only Select the Active Records-> IsActive=True!
)
AS

SET NOCOUNT ON

 
DECLARE @AdminIDs  VARCHAR(100)
DECLARE @Admin Bit
DECLARE @HasRole NVARCHAR(5); 
 
 
	--remove--incomplete-preassessment--
		DECLARE @PreassessmentIds TABLE (PreAssessmentId INT)

		INSERT INTO @PreassessmentIds (PreAssessmentId)
		SELECT preassessmentid 
		FROM ERS_PreAssessment 
		WHERE PatientId = @PatientId AND IsComplete = 0

		DELETE FROM ERS_ProcedureComorbidity 
		WHERE PreAssessmentId IN (SELECT PreAssessmentId FROM @PreassessmentIds)

		DELETE FROM ERS_PreAssessmentAnswers 
		WHERE PreAssessmentId IN (SELECT PreAssessmentId FROM @PreassessmentIds)

		DELETE FROM ERS_PreAssessment 
		WHERE PatientId = @PatientId AND IsComplete = 0
	--end---
		--delete--nurse--module
		DECLARE @NurseModuleIds TABLE (NurseModuleId INT)

		INSERT INTO @NurseModuleIds (NurseModuleId)
		SELECT  NurseModuleId
		FROM ERS_NurseModuleProcedure 
		WHERE PatientId = @PatientId AND IsComplete = 0

		DELETE FROM ERS_NurseModuleAnswers 
		WHERE NurseModuleId IN (SELECT NurseModuleId FROM @NurseModuleIds)

		DELETE FROM ERS_NurseModuleProcedure 
		WHERE PatientId = @PatientId AND IsComplete = 0
	--end--

     SELECT @AdminIDs = COALESCE(@AdminIDs + ', ', '') +  CAST(RoleId AS NVARCHAR)
	 FROM ERS_Roles where RoleName in ('System Administrators','GlobalAdmin')
	  
     SELECT  @HasRole = CASE WHEN Count(T2.[Item]) > 0 THEN 'true' ELSE 'false' END FROM fnSplitString(@AdminIDs,',') AS T1
            LEFT JOIN fnSplitString((SELECT RoleID  FROM ERS_Users WHERE Username =  @UserName),',')
            AS T2 on T1.[Item] = T2.[Item] WHERE T2.[Item] is not null 

	UPDATE ERS_ProcedureEditHistory SET LockedEnd =  GetDATE()  WHERE  LockedBy = @UserName  AND EditId = (SELECT MAX(EditId) from ERS_ProcedureEditHistory where LockedBy = @UserName) --Added by Ferdowsi, lock report, TFS - 3655
	
	--Added by rony tfs-4170
	DECLARE @EPRSuccess VARCHAR(MAX) = '<IMG SRC="../Images/NEDJAG/EPRSuccess.png" style="position:relative;top:4px;padding-right:2px;"/>';
	DECLARE @EPRError VARCHAR(MAX) = '<IMG SRC="../Images/NEDJAG/EPRError.png" style="position:relative;top:1px;padding-right:2px;"/>';
	DECLARE @NEDSuccess VARCHAR(MAX) = '<IMG SRC="../Images/NEDJAG/NEDSuccess.png" style="float:left;padding-top:5px;padding-right:2px;"/>';
	DECLARE @NEDError VARCHAR(MAX) = '<IMG SRC="../Images/NEDJAG/NEDError.png" style="float:left;padding-top:5px;padding-right:2px;"/>';

	SELECT * INTO #procs FROM (
		SELECT 
			p.ProcedureId AS ProcedureId,
			0 AS EpisodeNo,
			0 AS PreviousProcedureId,
			p.PreAssessmentId,
			prea.PreAssessmentDate,
			prea.ProcedureTypes as PreAssessProcTypes,
			p.ProcedureType AS ProcedureType,
			CONVERT(VARCHAR(50),'') AS PatientComboId,
			p.DiagramNumber AS DiagramNumber,
			--Added by rony tfs-3489,4170
			CASE WHEN p.ProcedureId = OPAPI.ProcedureId AND p.ProcedureId = NEDPI.ProcedureID AND NEDPI.Status = 4 THEN
			@NEDSuccess + @EPRSuccess + '<IMG SRC="'+dbo.fnProcedureCategoryIcon(ut.Description)+'" style="position:relative;top:3px;"/> ' + ' '+ CONVERT(VARCHAR(100), CONVERT(VARCHAR, p.CreatedOn, 103) + ' - ' + pt.ProcedureType)
			WHEN p.ProcedureId = OPAPI.ProcedureId AND p.ProcedureId = NEDPI.ProcedureID AND NEDPI.Status = 3 THEN
			@NEDError + @EPRSuccess +'<IMG SRC="'+dbo.fnProcedureCategoryIcon(ut.Description)+'" style="position:relative;top:3px;"/> ' + ' '+ CONVERT(VARCHAR(100), CONVERT(VARCHAR, p.CreatedOn, 103) + ' - ' + pt.ProcedureType)
			WHEN p.ProcedureId = NEDPI.ProcedureId AND NEDPI.Status = 4 THEN 
			@NEDSuccess + @EPRError +'<IMG SRC="'+dbo.fnProcedureCategoryIcon(ut.Description)+'" style="position:relative;top:3px;"/> ' + ' '+ CONVERT(VARCHAR(100), CONVERT(VARCHAR, p.CreatedOn, 103) + ' - ' + pt.ProcedureType)
			WHEN p.ProcedureId = NEDPI.ProcedureId AND NEDPI.Status = 3 THEN 
			@NEDError + @EPRError +'<IMG SRC="'+dbo.fnProcedureCategoryIcon(ut.Description)+'" style="position:relative;top:3px;"/> ' + ' '+ CONVERT(VARCHAR(100), CONVERT(VARCHAR, p.CreatedOn, 103) + ' - ' + pt.ProcedureType)
			ELSE 
			@EPRError +'<IMG SRC="'+dbo.fnProcedureCategoryIcon(ut.Description)+'" style="position:relative;top:3px;"/> ' + ' '+ CONVERT(VARCHAR(100), CONVERT(VARCHAR, p.CreatedOn, 103) + ' - ' + pt.ProcedureType) 
			END AS DisplayName,			
			1 AS ERS,
			p.CreatedOn,
			p.ModifiedOn,
            
            @HasRole AS Administrator,
			ISNULL((SELECT TOP (1) CASE WHEN LockedEnd IS NOT NULL THEN 'false' ELSE
	         CASE WHEN  DATEDIFF(minute, ISNULL(LockedAt,GETDATE()), GETDATE()) <61 then  'true' ELSE 'false' END  END
	        from ERS_ProcedureEditHistory WHERE ProcedureId=p.ProcedureId ORDER BY [EditId] DESC ), 'false')   AS procedureLocked , 

			(SELECT CASE  WHEN ISNULL((SELECT TOP (1) LockedBy FROM ERS_ProcedureEditHistory WHERE ProcedureId = p.ProcedureId), '') <> '' THEN 'true'  ELSE 'false'   END) AS hasHistory,

			ISNULL((SELECT  TOP (1) 	ISNULL( users.[Title] + ' '+users.[Forename] +' '+ users.[Surname],'')  from ERS_ProcedureEditHistory edit  LEFT JOIN ERS_Users users on
			Username = edit.LockedBy WHERE edit.ProcedureId = p.ProcedureId ),'') AS LockedUser,
		
			ISNULL((SELECT  TOP (1) format(LockedAt ,'HH:mm') from ERS_ProcedureEditHistory  WHERE ProcedureId = p.ProcedureId order by LockedAt desc),'') AS LockedAt,
			0 AS Locked,--ISNULL(pa.Locked,0), 
			0 AS LockedBy,--ISNULL(pa.LockedBy,0), 
			NULL AS LockedOn,--pa.LockedOn,
			ISNULL(CAST(SurgicalSafetyCheckListCompleted AS VARCHAR(50)),'') AS SurgicalSafetyCheckListCompleted,
			CASE s.ReportLocking 
			WHEN 1 
			THEN 0
			ELSE
				CASE 
				WHEN p.ModifiedOn <= DATEADD(DAY, 0 - s.LockingDays, DATEADD(HOUR, convert(int,left(isnull(s.LockingTime, '0'), 2)), DATEADD(dd, 0, DATEDIFF(dd, 0, GETDATE()))))
				THEN  CASE WHEN p.ProcedureCompleted = 1 THEN 1 ELSE 0 END
				ELSE 0
				END
			END AS isProcedureLocked
			, -1 AS  ColonType
			, CONVERT(INT,ISNULL(ProcedureCompleted,0)) AS ProcedureCompleted
			, IsNull(P.DNA,'')		AS DNA_Reason	
			, IsNull(PR.PP_DNA,'')	AS DNA_Reason_PP_Text	
			, p.BreathTestResult AS BreathTest
			, CASE WHEN pho.photoCount IS NULL THEN 0 ELSE 1 END HasPhotos,prt.Description as GroupType
		FROM 
			ERS_Procedures p
		INNER JOIN 
			ERS_ProcedureTypes pt ON p.ProcedureType = pt.ProcedureTypeId
		INNER JOIN 
		ERS_ProductTypes prt ON pt.ProductTypeId = prt.ProductTypeId
		INNER JOIN 
			ERS_Patients pa ON p.PatientId = pa.PatientId
		LEFT JOIN ERS_ProceduresReporting AS PR ON p.ProcedureId=PR.ProcedureId
		LEFT JOIN ERS_PreAssessment AS prea ON prea.PreAssessmentId = P.PreAssessmentId
		LEFT JOIN (SELECT count(dbo.ers_photos.PhotoId) AS photoCount, procedureid FROM ers_photos GROUP BY procedureid) as pho ON p.ProcedureId = pho.ProcedureId
		JOIN ERS_SystemConfig s on p.OperatingHospitalID = s.OperatingHospitalID 
		--Added by rony tfs-2964 start
		LEFT JOIN (select top 1 CAST('<x>' + REPLACE(Process,'|','</x><x>') + '</x>' AS XML).value('/x[4]','int') as ProcedureId from ERS_OCS_Process_Audit order by ProcessID desc) OPAPI on OPAPI.ProcedureId = p.ProcedureId
		--Added by rony tfs-3489
		INNER JOIN ERS_UrgencyTypes ut ON ut.UniqueId=p.CategoryListId AND ut.Suppressed = 0
		--Added by rony tfs-4170
		LEFT JOIN ERS_NedI2FilesLog as NEDPI on NEDPI.ProcedureID = p.ProcedureId
		WHERE 
			p.PatientId = @PatientId
			AND p.IsActive  = @ActiveProceduresOnly
	) AS temptemp


	INSERT INTO #procs
		SELECT 
			DISTINCT 0,
			0,
			pp.PreviousProcedureID,
			0,
			0,
			'',
			0,
			'',
			0,
			CONVERT(VARCHAR(100), CONVERT(VARCHAR, pp.ProcedureDate, 103) + 
				' - ' + 
				pp.ProcedureType),
			2,
			pp.ProcedureDate,
			pp.ProcedureDate,
			'',
			0,
			'',
			'',
			'',
			1,0,null,
			'', 1, -1, -1,
			1, '', null, CASE WHEN epi.ImageID IS NULL THEN 0 ELSE 1 END,'' 
		FROM 
			ERS_PreviousProcedures pp
			LEFT OUTER JOIN ERS_PreviousImages epi ON epi.PreviousProcedureID = pp.PreviousProcedureID
		WHERE
			pp.PatientId = @PatientId
			AND pp.IsActive = 1

					INSERT INTO #procs
		SELECT 
			DISTINCT 0,
			0,
			0,
			pp.PreAssessmentId,
			pp.PreAssessmentDate,
			pp.ProcedureTypes,
			0,
			'',
			0,
			'',
			2,
			GETDATE(),
			GETDATE(),
			'',
			0,
			'',
			'',
			'',
			1,0,null,
			'', 1, -1, -1,
			1, '', null, 0,''        
		FROM 
			ERS_PreAssessment pp
		LEFT JOIN 
			ERS_Procedures p ON pp.PreAssessmentId = p.PreAssessmentId
		WHERE 
			p.PreAssessmentId IS NULL       
			AND pp.PatientId = @PatientId;   
	SELECT * FROM #procs ORDER BY CreatedOn DESC, ModifiedOn DESC

	DROP TABLE #procs


Go

Create Table #temp (
    Section VARCHAR(Max),
	Question VARCHAR(Max)
);

Insert Into #temp
Values ('Complete mobility assessment','Reason for Procedure.Referral symptoms'),
('Medical and Surgical History','Respiratory problems.Does patient smoke cigarettes/vape'),
('Cardiac History','History of CVA/TIA.Further details'),
('Diabetes','Type.Has patient hypo awareness.Is patient on insulin or other medication for diabetes.Patient advised to contact diabetes care provider for advice.
Include free text further details box'),
('Medication Details',''),
('Bowel Pattern & Bowel Preparation (lower GI procedures)','BO frequency.Constipation.Loose stools.Assessed as suitable for bowel preparation.
Free text further details box, include relevant details as necessary.Has patient received/collected bowel preparation as prescribed.Moviprep/plenvu/picolax/other.
Are additional laxatives required as part of colonoscopy bowel preparation');

DECLARE Cur_1 CURSOR FOR SELECT Section, Question FROM #temp

OPEN Cur_1
DECLARE @Section VARCHAR(100),@Question VARCHAR(max),@SectionId INT,@order int = 1,@QuestionDetail VARCHAR(100)
FETCH NEXT FROM Cur_1 
INTO @Section, @Question

    WHILE (@@FETCH_STATUS = 0)
        BEGIN
			SET @SectionId = ISNULL((Select SectionId FROM ERS_PreAssessmentSections WHERE SectionName= @Section),0)
			IF @SectionId = 0
				BEGIN
				INSERT INTO [dbo].[ERS_PreAssessmentSections] ( [SectionName], [Suppressed], [SortOrder], [WhoUpdatedId], [WhenUpdated]) 
				Values (@Section, 0, @order, 1, GETDATE())
				SELECT @SectionId = SCOPE_IDENTITY()
			END

			SET @Question = REPLACE(@Question, CHAR(13) + CHAR(10), '')
			DECLARE comCursor CURSOR FOR
			SELECT Item FROM fnSplitString(@Question, '.');

			OPEN comCursor;
			FETCH NEXT FROM comCursor INTO @QuestionDetail;

			WHILE @@FETCH_STATUS = 0
			BEGIN
				IF NOT EXISTS (SELECT 1 FROM ERS_PreAssessmentQuestions WHERE Question = @QuestionDetail AND SectionId = @SectionId)
				BEGIN
					INSERT INTO [dbo].[ERS_PreAssessmentQuestions] ( [SectionId], [Question], [Optional], [FreeText], [YesNo], [Suppressed], [TrustId], [WhoCreated], 
					[WhenCreated], [WhoUpdated], [WhenUpdated], [DropdownOption], [DropdownOptionText], [UnKnownOption], [SortOrder])
					VALUES (@SectionId, @QuestionDetail, 0, 0, 1, 0, 3, 1, getdate(), NULL, NULL, 0, NULL, NULL, NULL)
				END
			FETCH NEXT FROM comCursor INTO @QuestionDetail;
			END

			CLOSE comCursor;
			DEALLOCATE comCursor;

			FETCH NEXT FROM Cur_1 INTO @Section, @Question
			Set @order = @order + 1
        END
CLOSE Cur_1
DEALLOCATE Cur_1
DROP TABLE #temp
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF Pre-Assessment section
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ahmed Shoud
-- TFS#	4391
-- Description of change
-- Add to ASA
------------------------------------------------------------------------------------------------------------------------
GO
IF NOT EXISTS (SELECT 1 FROM ERS_ASAStatus WHERE [Description] = 'Not assessed')
BEGIN
	INSERT INTO ERS_ASAStatus ([Description],NEDTerm,AdditionalInfo,ListOrderBy,Suppressed)
	VALUES ('Not assessed',NULL,0,1,0)
END
GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	4391 Ended
------------------------------------------------------------------------------------------------------------------------


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	MOSTAFIZUR RAHMAN
-- TFS#	4321
-- Description of change
-- Adverse event - Bleeding add drop down
------------------------------------------------------------------------------------------------------------------------
Go
DECLARE @AdverseEventsType VARCHAR(500) = 'Suctioning <1 minute,Suctioning >1 minute,Cold saline,Adrenaline,Intubation/balloon blocker,Other,Other Bleeding Text';
DECLARE @ParentId int = ISNULL((SELECT UniqueId from ERS_AdverseEvents where Description= 'Bleeding'),0);
DECLARE @ChildDesc VARCHAR(500); 
DECLARE comCursor CURSOR FOR
SELECT Item FROM fnSplitString(@AdverseEventsType, ',');

OPEN comCursor;

FETCH NEXT FROM comCursor INTO @ChildDesc;

WHILE @@FETCH_STATUS = 0
BEGIN
    IF NOT EXISTS (SELECT 1 FROM ERS_AdverseEvents WHERE Description = @ChildDesc) and @ParentId>0
    BEGIN
			If @ChildDesc ='Other Bleeding Text' 
			Begin
					INSERT INTO ERS_AdverseEvents (Description, NEDTerm, ListOrderBy, ParentId, AdditionalInfo, Suppressed, WhoCreatedId, WhenCreated, WhoUpdatedId, WhenUpdated, Complication)
					   SELECT @ChildDesc,'Other bleedingText', NULL, 0, 0, 0, NULL, NULL, NULL, NULL, 0;
			End

			Else if @ChildDesc ='Other'
			Begin
					INSERT INTO ERS_AdverseEvents (Description, NEDTerm, ListOrderBy, ParentId, AdditionalInfo, Suppressed, WhoCreatedId, WhenCreated, WhoUpdatedId, WhenUpdated, Complication)
						SELECT @ChildDesc,'Other bleeding', NULL, @ParentId, 0, 0, NULL, NULL, NULL, NULL, 0;
			End 
			else 
				Begin 
					 INSERT INTO ERS_AdverseEvents (Description, NEDTerm, ListOrderBy, ParentId, AdditionalInfo, Suppressed, WhoCreatedId, WhenCreated, WhoUpdatedId, WhenUpdated, Complication)
							SELECT @ChildDesc, ('Bleeding '+LOWER(@ChildDesc)), NULL, @ParentId, 0, 0, NULL, NULL, NULL, NULL, 0;
				end 
       

		INSERT INTO ERS_AdverseEventsProcedureTypes (AdverseEventsId, ProcedureTypeId)
		SELECT SCOPE_IDENTITY(), ProcedureTypeId 
		FROM ERS_ProcedureTypes
		WHERE ProcedureTypeId IN (
			SELECT ProcedureTypeId 
			FROM ERS_AdverseEventsProcedureTypes 
			WHERE AdverseEventsId = @ParentId
		);


    END

    FETCH NEXT FROM comCursor INTO @ChildDesc;
END

CLOSE comCursor;
DEALLOCATE comCursor;

Go

------------------------------------------------------------------------------------------------------------------------
-- TFS#	4321 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ferdowsi 7/9/2024
-- TFS#	 4231 , 2333 
-- Description of change
-- Set Default none at Adverve event
-- Updated by	:	Rezaul 
-- Description of change
-- Pre-Assessment section
-- Updated by	:	Mostafiz 9/22/2024
-- TFS#	 4064
-- Description of change
-- Set Consent Questions - enhancement
-- Updated by	:	Rony
-- TFS#	3513
-- Description of change: V2 Transnasal to be Procedure Title  
------------------------------------------------------------------------------------------------------------------------
GO

EXEC dbo.DropIfExist 
    @ObjectName = 'usp_Procedures_Insert', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[usp_Procedures_Insert]
(
	@ProcedureType		INT,
	--@PatientNo		VARCHAR(24),
	@PatientId			INT,
	@ProcedureDate		DATETIME,
	@ProcedureTime		VARCHAR(2),
	@PatientStatus		INT,
	@PatientWard		INT,
	@PatientType		INT,
	@OperatingHospitalId INT,
	@ListConsultant		INT,
	@Endoscopist1		INT,
	@Endoscopist2		INT,
	@Assistant			INT,
	@Nurse1				INT,
	@Nurse2				INT,
	@Nurse3				INT,
	@Nurse4				INT,
	@ReferralHospitalNo INT,
	@ReferralConsultantNo INT,
	@ReferralConsultantSpeciality INT,
	@PatientConsent		TINYINT,
	@PatientConsentType TINYINT, -- ' issue 4064
	@PatientConsentTypeOther VARCHAR(500), -- ' issue 4064
	@DefaultCheckBox	BIT,
	@UserID				INT,
	@ProductType		TINYINT,
	@ListType			TINYINT,
	@Endo1Role			TINYINT,
	@Endo2Role			TINYINT,
	@CategoryListId		INT,
	@OnWaitingList		BIT,
	@OpenAccessProc		TINYINT,
	@EmergencyProcType	TINYINT,
	@NewProcedureId		INT OUTPUT,	-- This will return the newly created ProcedureId to the GUI! To play
	@ImagePortId		INT,
	@Points				DECIMAL,
	@ChecklistComplete	BIT,
	@ReferrerType		INT,
	@GPReferrer VARCHAR(500) = NULL,
	@ReferrerTypeOther  VARCHAR(500),
	@ProviderId			INT,
	@ProviderOther		VARCHAR(500),
	@PatientNotes		BIT,
	@PatientReferralLetter	BIT,
	@ImageGenderID	int,
	@OrderId	int,
	@PreAssessmentId int Null
)
AS

SET NOCOUNT ON

DECLARE @newProcId INT
DECLARE @ppEndos VARCHAR(2000), @GPName varchar(255), @GPAddress varchar(max), @Endo1 varchar(500), @Endo2 varchar(500), @RefCons varchar(50), @RefHosp varchar(50)

BEGIN TRANSACTION
--sp_help 'dbo.ERS_Procedures'
	BEGIN TRY
		INSERT INTO ERS_Procedures
			(ProcedureType,
			CreatedBy,	
			CreatedOn,			
			ModifiedOn,
			ProcedureTime,
			PatientId,
			CategoryListId,
			OnWaitingList,
			OpenAccessProc,
			EmergencyProcType,
			OperatingHospitalID,
			ListConsultant,
			Endoscopist1,
			Endoscopist2,
			Assistant,
			Nurse1,
			Nurse2,
			Nurse3,
			Nurse4,
			ReferralHospitalNo,
			ReferralConsultantNo,
			ReferralConsultantSpeciality,
			PatientStatus,
			Ward,
			PatientType,
			PatientConsent,
			PatientConsentType,		 -- issue 4064
			PatientConsentTypeOther, -- issue 4064
			ListType,
			Endo1Role,
			Endo2Role,
			ImagePortId,
			WhoCreatedId,
			WhenCreated,
			Points,
			ChecklistComplete,
			ReferrerType,
			GPReferrer,
			ReferrerTypeOther,
			ProviderTypeId,
			ProviderOther,
			PatientNotes,
			PatientReferralLetter,
			ImageGenderID,
			OrderId,
			PreAssessmentId)
	VALUES (
			@ProcedureType,
			@UserID,
			@ProcedureDate, --CASE WHEN CONVERT(DATE, GETDATE()) = @ProcedureDate THEN GETDATE() ELSE @ProcedureDate END, --Insert date and time if Procedure date is current date
			GETDATE(),
			@ProcedureTime,
			@PatientId,
			@CategoryListId,
			@OnWaitingList,
			@OpenAccessProc,
			@EmergencyProcType,
			@OperatingHospitalID,
			@ListConsultant,
			@Endoscopist1,
			@Endoscopist2,
			@Assistant,
			@Nurse1,
			@Nurse2,
			@Nurse3,
			@Nurse4,
			@ReferralHospitalNo,
			@ReferralConsultantNo,
			@ReferralConsultantSpeciality,
			@PatientStatus,
			@PatientWard,
			@PatientType,
			@PatientConsent,
			@PatientConsentType,  -- issue 4064
			@PatientConsentTypeOther,  -- issue 4064
			@ListType,
			@Endo1Role,
			@Endo2Role,
			@ImagePortId,
			@UserID,
			GETDATE(),
			@Points,
			@ChecklistComplete,
			@ReferrerType,
			@GPReferrer,
			@ReferrerTypeOther,
			@ProviderId,
			@ProviderOther,
			@PatientNotes,
			@PatientReferralLetter,
			@ImageGenderID,
			@OrderId,
			@PreAssessmentId)
		SET @newProcId = SCOPE_IDENTITY();

		-- TFS 4391 Start
		if(@ProcedureType NOT IN (select ProcedureTypeId from ers_procedureTypes WHERE ProcedureType IN ('Bronchoscopy','EBUS') ))
		BEGIN
			INSERT INTO ERS_PatientASAStatus (PatientId, ASAStatusId, ProcedureCreatedId, WhoCreatedId, WhenCreated)
			VALUES (@PatientId,(SELECT UniqueId FROM ERS_ASAStatus WHERE [Description] = 'Not assessed'), @newProcId, @UserID, GETDATE())
		END
		-- TFS 4391 End

		-- Set default NONE to Adverse events , TFS# 4231
	    INSERT INTO ERS_ProcedureAdverseEvents (ProcedureId,AdverseEventId,ChildAdverseEventId,AdditionalInformation ,WhoCreatedId,WhenCreated,WhoUpdatedId,WhenUpdated)
        VALUES (  @newProcId,(SELECT UniqueId FROM ERS_AdverseEvents WHERE Description = 'None'),0,'' ,1 ,GETDATE(),NULL,NULL)

		INSERT INTO ERS_ProcedureSummary ([ProcedureId] ,[SectionId],[Summary],[EndoscopistId])
		VALUES (@newProcId, ( SELECT UISectionId FROM UI_Sections where SectionName = 'Adverse events'),'Adverse events',NULL)
		-- Set validation in Adverse events , TFS# 4231
		--TFS# 2333 by Ferdowsi
	    IF @ProcedureType IN (3,4)
	    BEGIN
	      Update ERS_Procedures set ScopeGuide = 1 where ProcedureId =  @newProcId
	    END
		--## Important Work- Insert a Blank Record in the ERS_ProceduresReorting- with this Unique ID! So, you can simply Update the PP fields later..!! 
		INSERT INTO dbo.ERS_ProceduresReporting(ProcedureId)VALUES(@newProcId);

		SET @ppEndos = ''
		--TFS-3513
		IF @CategoryListId > 0 SELECT  @ppEndos = @ppEndos + '$$Priority: ' + Description FROM ERS_UrgencyTypes WHERE UniqueId=@CategoryListId
		IF @ReferrerType > 0 SELECT  @ppEndos = @ppEndos + '$$Referring Cons: ' + Description FROM ERS_ReferrerTypes WHERE UniqueId=@ReferrerType
		IF @ReferralHospitalNo > 0 SELECT @ppEndos = @ppEndos + '$$Referring Cons: ' + HospitalName FROM dbo.ERS_ReferralHospitals WHERE HospitalID = @ReferralHospitalNo

		IF @ListConsultant > 0 SELECT @ppEndos = @ppEndos + '$$List Consultant: ' + Title + ' ' + Forename + ' ' + Surname FROM ERS_Users WHERE UserID = @ListConsultant
		IF @Endoscopist1 > 0 
		BEGIN
			SELECT @Endo1 = Title + ' ' + Forename + ' ' + Surname FROM ERS_Users WHERE UserID = @Endoscopist1
			SELECT @ppEndos = @ppEndos + '$$Endoscopist No1: ' + @Endo1
			SELECT  @Endo1 = Title + ' ' + Forename + ' ' + Surname + 
					CASE WHEN isnull(Qualifications, '') != '' THEN ', ' + Qualifications else '' END + 
					CASE WHEN isnull(u.JobTitleID, 0) > 0 THEN CHAR(13)+CHAR(10) + jt.Description ELSE '' END  
			FROM ERS_Users u
			LEFT JOIN ERS_JobTitles jt on u.JobTitleID = jt.JobTitleID 
			WHERE UserID = @Endoscopist1
		END
		IF @Endoscopist2 > 0 
		BEGIN
			SELECT @Endo2 = Title + ' ' + Forename + ' ' + Surname FROM ERS_Users WHERE UserID = @Endoscopist2
			SELECT @ppEndos = @ppEndos + '$$Endoscopist No2: ' + @Endo2
			SELECT  @Endo2 = Title + ' ' + Forename + ' ' + Surname + 
					CASE WHEN isnull(Qualifications, '') != '' THEN ', ' + Qualifications else '' END + 
					CASE WHEN isnull(u.JobTitleID, 0) > 0 THEN CHAR(13)+CHAR(10) + jt.Description ELSE '' END  
			FROM ERS_Users u
			LEFT JOIN ERS_JobTitles jt on u.JobTitleID = jt.JobTitleID 		
			WHERE UserID = @Endoscopist2
		END
		IF @Nurse1 > 0 OR @Nurse2 > 0 OR @Nurse3 > 0 OR @Nurse4 > 0 
		BEGIN
			SELECT @ppEndos = @ppEndos + '$$' + 'Nurses: '
			IF @Nurse1 > 0 SELECT @ppEndos = @ppEndos + '##' + Title + ' ' + Forename + ' ' + Surname FROM ERS_Users WHERE UserID = @Nurse1
			IF @Nurse2 > 0 SELECT @ppEndos = @ppEndos + '##' + Title + ' ' + Forename + ' ' + Surname FROM ERS_Users WHERE UserID = @Nurse2
			IF @Nurse3 > 0 SELECT @ppEndos =  @ppEndos + '##' + Title + ' ' + Forename + ' ' + Surname FROM ERS_Users WHERE UserID = @Nurse3
			IF @Nurse4 > 0 SELECT @ppEndos =  @ppEndos + '##' + Title + ' ' + Forename + ' ' + Surname FROM ERS_Users WHERE UserID = @Nurse4
		END
		IF CHARINDEX('$$', @ppEndos) > 0 SET @ppEndos = REPLACE(STUFF(@ppEndos, charindex('$$', @ppEndos), 2, ''), '$$', '<br/>')
		IF CHARINDEX('##', @ppEndos) > 0 SET @ppEndos = REPLACE(STUFF(@ppEndos, charindex('##', @ppEndos), 2, ''), '##', '<br/>')
	
		IF @PreAssessmentId IS NOT NULL AND @PreAssessmentId > 0
		BEGIN
			INSERT INTO ers_procedureComorbidity (ProcedureId, ComorbidityId, ChildComorbidityId, AdditionalInformation, WhoCreatedId, WhoUpdatedId, WhenUpdated, PreAssessmentId)
					SELECT @newProcId, p.ComorbidityId, p.ChildComorbidityId, p.AdditionalInformation, p.WhoCreatedId, p.WhoUpdatedId, p.WhenUpdated, null 
					FROM 
						ers_procedureComorbidity p
					INNER JOIN 
						ERS_ComorbidityProcedureTypes e 
						ON e.ComorbidityId = p.ComorbidityId 
						AND e.ProcedureTypeId = @ProcedureType
					WHERE 
						p.PreAssessmentId = @PreAssessmentId;
		END

		SET @RefCons=''
		IF @ReferrerType = 1
		BEGIN
			SET @RefCons = 'GP'
		END
		ELSE IF @ReferrerType = 5
		BEGIN
			SET @RefCons = @ReferrerTypeOther
		END
		ELSE
		BEGIN
			SELECT @RefCons = Upper(ec.Forename) FROM dbo.ERS_Consultant ec WHERE ec.ConsultantID = @ReferralConsultantNo --ADDED BY MOSTAFIZ 4184
		END	
		--SELECT @GPName = p.[GP Name] , @GPAddress = p.[GP Address] FROM Patient p left join  ERS_Procedures pr ON p.[Patient No]= pr.PatientId WHERE pr.ProcedureId = @newProcId
		--SELECT @GPName = p.[GP Name] , @GPAddress = p.[GP Address] FROM ERS_Patients p WHERE p.[Patient No]= @PatientId

		SET @RefHosp = ''
		SELECT @RefHosp = rh.HospitalName FROM dbo.ERS_ReferralHospitals rh WHERE rh.HospitalID = @ReferralHospitalNo

		--Get GP practice name and address
		SELECT 	TOP 1 
			@GPName		= g.CompleteName,
			@GPAddress	= replace(dbo.fnFullAddress(ep.[Name], ep.Address1, ep.Address2, CASE WHEN ep.Address3 Is null THEN EP.Address4 ELSE ep.Address3 + ' ' + EP.Address4 END, ep.PostCode), ',', ', <br />')
		FROM ERS_Patients p 
		LEFT JOIN ERS_GPs g ON g.GPId = p.RegGpId
		LEFT JOIN dbo.ERS_Practices ep ON p.RegGpPracticeId = ep.PracticeID
		where p.PatientId = @PatientId 

		UPDATE ERS_ProceduresReporting SET PP_Endos = @ppEndos, PP_GPName = @GPName, PP_GPAddress = @GPAddress, PP_Endo1 = @Endo1, PP_Endo2 = @Endo2, PP_RefCons = @RefCons, PP_RefHosp = @RefHosp WHERE ProcedureId = @newProcId

		UPDATE ERS_Consultant SET SortOrder = ISNULL(SortOrder,0) + 1 WHERE ConsultantID = @ReferralConsultantNo

		EXEC procedure_summary_update @newProcId

		--SELECT @newProcId AS ProcedureId
		SELECT @NewProcedureId=@newProcId;

	END TRY

	BEGIN CATCH
		DECLARE @ErrorMessage NVARCHAR(4000);
		DECLARE @ErrorSeverity INT;
		DECLARE @ErrorState INT;

		SELECT @ErrorMessage = ERROR_MESSAGE(),
			   @ErrorSeverity = ERROR_SEVERITY(),
			   @ErrorState = ERROR_STATE();
    
		RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

		IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
	END CATCH


	IF @@TRANCOUNT > 0 COMMIT TRANSACTION;
GO

EXEC dbo.DropIfExist 
    @ObjectName = 'TR_Procedure_Updated', 
    @ObjectTypePrefix = 'TR' 
GO

CREATE TRIGGER [dbo].[TR_Procedure_Updated]
   ON  [dbo].[ERS_Procedures]
   AFTER INSERT, UPDATE, DELETE
AS 
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    DECLARE @ReportUpdated bit, @ProcedureId int, @PatientId int, @ProcedureType tinyint, @pancreasDivisum VARCHAR(10) = 'False' , @WhoCreatedId int
	SELECT @ReportUpdated = ReportUpdated, @ProcedureId = ProcedureId, 
			@PatientId = PatientId, @ProcedureType = ProcedureType, 
			@pancreasDivisum = (CASE WHEN pancreasDivisum = 1 THEN 'True' ELSE 'False' END)
	FROM INSERTED

	IF ISNULL(@ReportUpdated,0) <> 0
	BEGIN
		UPDATE ERS_Procedures SET ReportUpdated = 1 WHERE ProcedureID = @ProcedureID AND ISNULL(ReportUpdated, 0) <> 1
	END

	-- check expected patients for match on patientid, procedure type and date
	IF EXISTS(SELECT 1 FROM dbo.ERS_ExpectedPatients eep 
				WHERE PatientId = @PatientId 
					AND (eep.ProcedureType IS NULL OR eep.ProcedureType = @ProcedureType) 
					AND CONVERT(varchar(10),eep.ExpectedDateTime, 103) = CONVERT(varchar(10),GETDATE(), 103)
					AND ISNULL(eep.STATUS, 0) = 0)
	BEGIN
		UPDATE ERS_ExpectedPatients
		SET [Status] = 1
		WHERE PatientId = @PatientId 
				AND (ProcedureType IS NULL OR ProcedureType = @ProcedureType) 
				AND CONVERT(varchar(10),ExpectedDateTime, 103) = CONVERT(varchar(10),GETDATE(), 103)
	END

	IF @ProcedureType IN (2,7)
	BEGIN
		IF @pancreasDivisum = 'True'
		BEGIN
			IF NOT EXISTS (SELECT 1 FROM ERS_Diagnoses WHERE ProcedureId = @ProcedureId AND MatrixCode = 'D97P2' AND Value = 'True')
				INSERT INTO ERS_Diagnoses (ProcedureId, MatrixCode, Value, Region, IsOtherData) VALUES (@ProcedureId, 'D97P2', 'True', 'Pancreas',1)
			ELSE
				UPDATE ERS_Diagnoses SET Value = 'True', IsOtherData = 1 WHERE MatrixCode = 'D97P2' --incase code exists  but with a value of false

			exec ercp_diagnoses_summary_update @Procedureid
		END
		ELSE
		BEGIN
			IF EXISTS (SELECT 1 FROM ERS_Diagnoses WHERE ProcedureId = @ProcedureId AND MatrixCode = 'D97P2')
			BEGIN
				DELETE FROM ERS_Diagnoses WHERE MatrixCode = 'D97P2' --incase code exists  but with a value of false
				exec ercp_diagnoses_summary_update @Procedureid
			END

		END
	END

 
	
END
GO

Go
EXEC dbo.DropIfExist 
    @ObjectName = 'procedure_adverse_events_save', 
    @ObjectTypePrefix = 'S' 
GO

 
CREATE PROCEDURE [dbo].[procedure_adverse_events_save] 
(
	@ProcedureId int, 
	@AdverseEventId int, 
	@ChildAdverseEventId int, 
	@Selected bit,
	@AdditionalInfo varchar(max),
	@LoggedInUserId int
)
AS
BEGIN

	IF @Selected = 1
	BEGIN
		IF NOT EXISTS (SELECT 1 FROM ERS_ProcedureAdverseEvents WHERE AdverseEventId = @AdverseEventId AND ProcedureId = @ProcedureId)
		BEGIN
			INSERT INTO [dbo].[ERS_ProcedureAdverseEvents] (ProcedureId, AdverseEventId, ChildAdverseEventId, AdditionalInformation, WhoCreatedId, WhenCreated)
			VALUES (@ProcedureId, @AdverseEventId, @ChildAdverseEventId, @AdditionalInfo, @LoggedInUserId, getdate())

			IF @AdverseEventId = (SELECT UniqueId FROM dbo.ERS_AdverseEvents WHERE NEDTerm = 'None')
				DELETE FROM dbo.ERS_ProcedureAdverseEvents WHERE ProcedureId = @ProcedureId AND AdverseEventId <> @AdverseEventId
		END
		ELSE
		BEGIN
			UPDATE 
				ERS_ProcedureAdverseEvents 
			SET 
				AdverseEventId = @AdverseEventId,
				ChildAdverseEventId = @ChildAdverseEventId,
				AdditionalInformation = @AdditionalInfo,
				WhoUpdatedId = @LoggedInUserId,
				WhenUpdated = getdate()
			WHERE 
				ProcedureId = @ProcedureId AND AdverseEventId = @AdverseEventId 
		END

		exec UI_update_procedure_summary   @ProcedureId, 'Adverse events', '', 1
	END
	ELSE
	BEGIN
		DELETE FROM ERS_ProcedureAdverseEvents WHERE ProcedureId = @ProcedureId AND AdverseEventId = @AdverseEventId 
	END


	/*Check if theres any indications that require child indications to be filled out NED requirement, upload will fail otherwise*/
	DECLARE @Summary varchar(200) = 'Adverse events:'

	SELECT ep.AdverseEventId, 
				ei.ParentId, 
				CASE WHEN ep.AdverseEventId IN (SELECT ParentId FROM dbo.ERS_AdverseEvents ei2) AND ISNULL(ep.ChildAdverseEventId,0) = 0 THEN 0 
					 WHEN ep.AdverseEventId IN (SELECT UniqueId FROM dbo.ERS_AdverseEvents ei2 WHERE ei2.AdditionalInfo = 1) AND ISNULL(ep.AdditionalInformation,'') = '' THEN 0 
					 WHEN ep.AdverseEventId IN (SELECT UniqueId FROM dbo.ERS_AdverseEvents ei2 WHERE ei2.NEDTerm = 'Other BleedingText') AND ISNULL(ep.AdditionalInformation,'') = '' THEN 0 --tfs 4321
					 ELSE 1 END 'Complete'
		INTO #tempAdverse FROM dbo.ERS_ProcedureAdverseEvents ep  -- insert into a temp table by Ferdowsi , TFS 4231
			INNER JOIN dbo.ERS_AdverseEvents ei ON ei.UniqueId = ep.AdverseEventId
		WHERE procedureid = @ProcedureId  
	IF NOT EXISTS(Select 1 from  #tempAdverse ) -- added by ferdowsi, TFS 4231
	BEGIN 
			EXEC UI_update_procedure_summary @ProcedureId, 'Adverse events', @Summary, 0
	END
	ELSE IF (SELECT COUNT(*) FROM (SELECT * FROM #tempAdverse  ) inds WHERE inds.Complete = 0) = 0
	BEGIN
		EXEC UI_update_procedure_summary @ProcedureId, 'Adverse events', @Summary, 1
	END
	ELSE
	BEGIN
		EXEC UI_update_procedure_summary @ProcedureId, 'Adverse events', @Summary, 0
	END
    EXEC procedure_summary_update @procedureID
	DROP table #tempAdverse

END
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS# 	 4231, 2333,4064
--  Pre-Assessment section
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ferdowsi 7/9/2024
-- TFS#	 4160
-- Description of change
--  get data for time
--------------------------------------------------------------------------------------------------------------------------
 GO
EXEC dbo.DropIfExist 
    @ObjectName = 'procedure_timings_select', 
    @ObjectTypePrefix = 'S' 
GO


CREATE PROCEDURE [dbo].[procedure_timings_select]
(	
	@ProcedureId int
)
AS
BEGIN
	SELECT pro.StartDateTime, pro.EndDateTime,ProcLower.WithdrawalMins,  ProcLower.CaecumIntubationStart,ProcUpper.WithdrawalMins As UpperWithdrawalMins
	FROM ERS_Procedures pro 
	Left JOIN ERS_ProcedureLowerExtent ProcLower ON pro.ProcedureId = ProcLower.ProcedureId
	Left JOIN ERS_ProcedureUpperExtent ProcUpper ON pro.ProcedureId = ProcUpper.ProcedureId
	WHERE pro.ProcedureId = @ProcedureId
END
GO



 GO
EXEC dbo.DropIfExist 
    @ObjectName = 'procedure_upper_extent_save', 
    @ObjectTypePrefix = 'S' 
GO


CREATE  PROCEDURE [dbo].[procedure_upper_extent_save]
(
	@ProcedureId int,
	@ExtentId int,
	@AdditionalInfo varchar(max),
	@EndoscopistId int,
	@JManoeuvreId int, 
	@LimitedById int, 
	
	@MucosalJunctionDistance int,
	@LimitationOther varchar(max),
	@LoggedInUserId int
)
AS
/*
--	Update History
01.			04 Jan 2023		MH added Order Message Send block while saving Extent of Intubation TFS #2475
							No extra parameter required. ProcedureId will have associated OrderId and Extent Limited By value
02.			21 March 2023	AJ j manouver handled if -1 (not specified)
03.			27 March 2023	AJ Set sections as not entered based on the extent reached
04.			08 June 2023	SG Add call to ogd_diagnoses_summary_update to ensure report gets populated with Normal if no abnormalities are added
05.         08 Nov 2023     MS Add MucosalJunctionDistance column and related logic
06.         12 July 2024    AJ Diagnoses set based on the extent
							
*/
BEGIN
	Declare @bitHasProcedureFailed as bit
	Set @bitHasProcedureFailed = 0

	IF NOT EXISTS (SELECT 1 FROM ERS_ProcedureUpperExtent WHERE ProcedureId = @ProcedureId AND EndoscopistId = @EndoscopistId)
	BEGIN
		INSERT INTO ERS_ProcedureUpperExtent (ProcedureId, ExtentId, AdditionalInfo, EndoscopistId, JManoeuvreId, LimitationId, MucosalJunctionDistance, WhoUpdatedId, WhenUpdated, LimitationOther)
		VALUES (@ProcedureId, NULLIF(@ExtentId,0), NULLIF(@AdditionalInfo,''), @EndoscopistId, NULLIF(@JManoeuvreId,-1), NULLIF(@LimitedById,0), NULLIF(@MucosalJunctionDistance,0), @LoggedInUserId, getdate(), NULLIF(@LimitationOther,''))
	END
	ELSE
	BEGIN

		/*Check if new values been added for limitations */
		IF ISNULL(@LimitationOther,'') <> ''
		BEGIN
			IF NOT EXISTS (SELECT 1 FROM dbo.ERS_Limitations WHERE Description = @LimitationOther)
			BEGIN
				/*get and set the new items order id so it appears 1 above 'other' we always want other to be last*/

				DECLARE @OtherListOrderBy_l int = (SELECT ListOrderBy FROM ERS_Limitations WHERE Description = 'Other')
				INSERT INTO ERS_Limitations (Description, NEDTerm, ListOrderBy) VALUES (@LimitationOther, 'Other', @OtherListOrderBy_l)
			
				UPDATE dbo.ERS_Limitations SET ListOrderBy = @OtherListOrderBy_l + 1 WHERE Description = 'Other'
		

			SELECT @LimitedById = UniqueId FROM ERS_Limitations WHERE Description = @LimitationOther
		
			DECLARE @ProcTypeId int = (SELECT ProcedureType FROM ERS_Procedures WHERE ProcedureId = @ProcedureId)
			INSERT INTO ERS_LimitationProcedureTypes (ProcedureTypeId, LimitationId) VALUES (@ProcTypeId, @LimitedById)
			END
			ELSE
				SELECT @LimitedById = UniqueId FROM ERS_Limitations WHERE Description = @LimitationOther
		END 

		UPDATE ERS_ProcedureUpperExtent
		SET 
			ExtentId = NULLIF(@ExtentId,0),
			AdditionalInfo = NULLIF(@AdditionalInfo,''),
			EndoscopistId = @EndoscopistId,
			JManoeuvreId = NULLIF(@JManoeuvreId,-1),
			LimitationId = NULLIF(@LimitedById,0),
			MucosalJunctionDistance = NULLIF(@MucosalJunctionDistance,0),
			WhoUpdatedId = @LoggedInUserId,
			WhenUpdated = getdate(),
			LimitationOther = NULLIF(@LimitationOther,'')
		WHERE 
			ProcedureId = @ProcedureId AND
			EndoscopistId = @EndoscopistId
	END

	DECLARE @SectionId int, @ProceureTypeId int, @ExtentIsSuccess bit, @ExtentDescription varchar(200), @SummaryText varchar(max) = ''
	SELECT @SectionID = UISectionId FROM UI_Sections WHERE SectionName = 'Extent'

	SELECT @ProceureTypeId = ProcedureType FROM ERS_Procedures WHERE ProcedureId = @ProcedureId
	
	/*Furthest extent*/
	SELECT TOP 1 @ExtentDescription = ee.Description, @AdditionalInfo = epue.AdditionalInfo
								FROM dbo.ERS_ProcedureUpperExtent epue 
									INNER JOIN dbo.ERS_Extent ee ON epue.ExtentId = ee.UniqueId
								WHERE epue.ProcedureId=@ProcedureId
								ORDER BY ee.ListOrderBy DESC
	
	/*Handle failed procedures*/
	
	IF @ExtentDescription IN ('intubation failed','abandoned')
	Begin
	
		EXEC diagnoses_set_procedure_failed @ProcedureId
		Set @bitHasProcedureFailed = 1
	END
    
	IF ISNULL(@MucosalJunctionDistance,0) > 0
	BEGIN

		SET @SummaryText = 'The apparent mucosal junction: ' + Convert(varchar(50), @MucosalJunctionDistance) + ' cm ' -- edited by mostafiz 4084
	END

	IF (SELECT COUNT(*) FROM ERS_ProcedureUpperExtent WHERE ProcedureId = @ProcedureId AND NULLIF(JManoeuvreId,-1) IS NOT NULL) > 0
	BEGIN
		DECLARE @JManouvreResult varchar(100)

		/*Overall JManouvre result regardless of who done it, was it done*/
		IF EXISTS (SELECT 1 FROM ERS_ProcedureUpperExtent WHERE ProcedureId = @ProcedureId AND ISNULL(JManoeuvreId,0) = 1)
			SET @JManouvreResult = 'performed. '
		ELSE
			SET @JManouvreResult = 'not carried out. '

		SET @SummaryText = @SummaryText + 'J manoeuvre ' + @JManouvreResult
	END
		
	SET @SummaryText = @SummaryText +   
						CASE LOWER(@ExtentDescription )
							WHEN 'intubation failed' THEN 'Failed intubation' + CASE WHEN ISNULL(@AdditionalInfo,'') <> '' THEN ': ' + @AdditionalInfo ELSE '' END
							WHEN 'abandoned' THEN 'Procedure failed (abandoned)' + CASE WHEN ISNULL(@AdditionalInfo,'') <> '' THEN ': ' + @AdditionalInfo ELSE '' END
							WHEN 'other' THEN  'Procedure failed' + CASE WHEN ISNULL(@AdditionalInfo,'') <> '' THEN ': ' + @AdditionalInfo ELSE '' END
							ELSE 'The procedure was completed successfully to the ' + @ExtentDescription
						END
	
	--limited by...?
	IF ISNULL(@LimitedById, 0) > 0
	BEGIN
		SET @SummaryText = @SummaryText + ' but limited by ' + (SELECT LOWER(Description) FROM ERS_Limitations WHERE UniqueId = @LimitedById)
	END

	IF ISNULL(@SummaryText,'') <> ''
	BEGIN
		UPDATE ERS_ProcedureUpperExtent
		SET Summary = @SummaryText
		WHERE ProcedureId = @ProcedureId

		EXEC procedure_summary_update @ProcedureId
	END
	
	DECLARE @Summary VARCHAR(max) = 'Extent:'


	--remove complete section entry incase conditions no longer apply. Will get re-evaluated after
	EXEC UI_update_procedure_summary @ProcedureId, 'Extent', @Summary, 0, @EndoscopistId

	--Check if the Extent has reached or exceeded the planned extent, if so mark as success
	IF @ExtentId > 0 
	BEGIN
		DECLARE @ExtentListOrder INT
		SELECT @ExtentListOrder = ListOrderBy, @ExtentIsSuccess = IsSuccess FROM ERS_Extent WHERE UniqueId = @ExtentId
		DECLARE @PlannedExtentListOrder int = (SELECT e.ListOrderBy FROM ERS_ProcedurePlannedExtent ppe JOIN ERS_Extent e ON e.UniqueId = ppe.ExtentId WHERE ppe.ProcedureId = @ProcedureId)

		IF (@ExtentListOrder >= @PlannedExtentListOrder AND @ExtentListOrder > 0)
				SET @ExtentIsSuccess = 1
	END
	
	IF @ExtentId > 0 AND @ExtentIsSuccess = 1
		EXEC UI_update_procedure_summary @ProcedureId, 'Extent', 'Extent:', @ExtentId, @EndoscopistId
	ELSE IF @ExtentIsSuccess = 0 AND @LimitedById > 1
	BEGIN
		IF (SELECT LOWER(NEDTerm) FROM dbo.ERS_Limitations WHERE UniqueId = @LimitedById) = 'other'
		BEGIN
			IF ISNULL(@LimitationOther,'') <> ''
			BEGIN
				EXEC UI_update_procedure_summary @ProcedureId, 'Extent', 'Extent:' , @ExtentId, @EndoscopistId
			END
		END
		ELSE
		BEGIN
			EXEC UI_update_procedure_summary @ProcedureId, 'Extent', 'Extent:', @ExtentId, @EndoscopistId
		END
	END

	--IF ISNULL(@WithdrawalMins,0) > 0
	--BEGIN
	--	EXEC UI_update_procedure_summary @ProcedureId, 'Total withdrawal time', 'Total withdrawal time:', 1, @EndoscopistId
	--END

	IF @JManoeuvreId > -1
	BEGIN
		EXEC UI_update_procedure_summary @ProcedureId, 'JManoevre', 'JManoevre:', 1, @EndoscopistId
	END
	ELSE
	BEGIN
		EXEC UI_update_procedure_summary @ProcedureId, 'JManoevre', 'JManoevre:', 0 , @EndoscopistId
	END
	
	--MH Added on 04 Jan 2023 
	Exec usp_SendIntubationExtentOrderMessageByProcedureId @ProcedureId, @bitHasProcedureFailed, @LoggedInUserId

	EXEC ogd_diagnoses_summary_update @ProcedureID

	--Handle unentered sections
	DECLARE @MatrixCode VARCHAR(100)

	--based on extent reached
	IF LOWER(@ExtentDescription)= 'oesophagus'
	BEGIN
		--check if a diagnoses is present or not (will say OverallNorml if nothing's been found)
		IF EXISTS (SELECT 1 FROM dbo.ERS_Diagnoses WHERE ProcedureID = @ProcedureId AND LOWER(MatrixCode) = 'overallnormal')
		BEGIN
		    --if its overallnormal delete it
			DELETE FROM dbo.ERS_Diagnoses WHERE ProcedureID = @ProcedureId AND LOWER(MatrixCode) = 'overallnormal'

			--add oesophagus normal
			INSERT INTO [ERS_Diagnoses] (ProcedureID, SiteID, MatrixCode, [Value], [Region]) 
			VALUES (@ProcedureID, 0, 'OesophagusNormal','true','Oesophagus') 
		END

		--Stomach region is not updated if a abnormality/diagnoses is present
		IF EXISTS (SELECT 1 FROM dbo.ERS_Diagnoses WHERE @ProcedureId = @ProcedureId AND Region = 'Stomach')
		BEGIN
			IF EXISTS (SELECT 1 FROM dbo.ERS_Diagnoses WHERE @ProcedureId = @ProcedureId AND Region = 'Stomach' AND MatrixCode = 'StomachNormal') 
			BEGIN
				DELETE FROM dbo.ERS_Diagnoses WHERE ProcedureID = @ProcedureId AND Region = 'Stomach' AND MatrixCode = 'StomachNormal'

				INSERT INTO [ERS_Diagnoses] (ProcedureID, SiteID, MatrixCode, [Value], [Region]) 
				VALUES (@ProcedureID, 0, 'StomachNotEntered','true','Stomach') 
			END
		END
		ELSE
		BEGIN
		    INSERT INTO [ERS_Diagnoses] (ProcedureID, SiteID, MatrixCode, [Value], [Region]) 
		    VALUES (@ProcedureID, 0, 'StomachNotEntered','true','Stomach') 
		END

		--Duodenum region is not updated if a abnormality/diagnoses is present
		IF EXISTS (SELECT 1 FROM dbo.ERS_Diagnoses WHERE @ProcedureId = @ProcedureId AND Region = 'Duodenum')
		BEGIN
		     IF EXISTS (SELECT 1 FROM dbo.ERS_Diagnoses WHERE @ProcedureId = @ProcedureId AND Region = 'Duodenum' AND MatrixCode = 'DuodenumNormal')
			 BEGIN
				DELETE FROM dbo.ERS_Diagnoses WHERE ProcedureID = @ProcedureId AND Region = 'Duodenum' AND MatrixCode = 'DuodenumNormal'

				INSERT INTO [ERS_Diagnoses] (ProcedureID, SiteID, MatrixCode, [Value], [Region]) 
				VALUES (@ProcedureID, 0, 'DuodenumNotEntered','true','Duodenum')
			 END
		END
		ELSE	
		BEGIN
		    INSERT INTO [ERS_Diagnoses] (ProcedureID, SiteID, MatrixCode, [Value], [Region]) 
		    VALUES (@ProcedureID, 0, 'DuodenumNotEntered','true','Duodenum')
		END

		

		EXEC dbo.ogd_diagnoses_summary_update @ProcedureId
	END
	IF LOWER(@ExtentDescription)= 'stomach'
	BEGIN
		--check if a diagnoses is present or not (will say OverallNorml if nothing's been found)
		IF EXISTS (SELECT 1 FROM dbo.ERS_Diagnoses WHERE ProcedureID = @ProcedureId AND LOWER(MatrixCode) = 'overallnormal')
		BEGIN
		    --if its overallnormal delete it
			DELETE FROM dbo.ERS_Diagnoses WHERE ProcedureID = @ProcedureId AND LOWER(MatrixCode) = 'overallnormal'

			--add oesophagus normal
			INSERT INTO [ERS_Diagnoses] (ProcedureID, SiteID, MatrixCode, [Value], [Region]) 
			VALUES (@ProcedureID, 0, 'OesophagusNormal','true','Oesophagus') 

			--add stomach normal
			INSERT INTO [ERS_Diagnoses] (ProcedureID, SiteID, MatrixCode, [Value], [Region]) 
			VALUES (@ProcedureID, 0, 'StomachNormal','true','Stomach') 
		END
		
		--Stomach region is not updated if a abnormality/diagnoses is present
		IF EXISTS (SELECT 1 FROM dbo.ERS_Diagnoses WHERE @ProcedureId = @ProcedureId AND Region = 'Oesophagus' AND MatrixCode = 'OesophagusNotEntered')
		BEGIN
			DELETE FROM dbo.ERS_Diagnoses WHERE ProcedureID = @ProcedureId AND Region = 'Oesophagus' AND MatrixCode = 'OesophagusNotEntered'
			
			--add Oesophagus normal
			INSERT INTO [ERS_Diagnoses] (ProcedureID, SiteID, MatrixCode, [Value], [Region]) 
			VALUES (@ProcedureID, 0, 'OesophagusNormal','true','Oesophagus') 
		END

		--Stomach region is not updated if a abnormality/diagnoses is present
		IF NOT EXISTS (SELECT 1 FROM dbo.ERS_Diagnoses WHERE @ProcedureId = @ProcedureId AND Region = 'Stomach')
		BEGIN
			--add stomach normal
			INSERT INTO [ERS_Diagnoses] (ProcedureID, SiteID, MatrixCode, [Value], [Region]) 
			VALUES (@ProcedureID, 0, 'StomachNormal','true','Stomach') 
		END

		--Duodenum region is not updated if a abnormality/diagnoses is present
		IF EXISTS (SELECT 1 FROM dbo.ERS_Diagnoses WHERE @ProcedureId = @ProcedureId AND Region = 'Duodenum')
		BEGIN
		     IF EXISTS (SELECT 1 FROM dbo.ERS_Diagnoses WHERE @ProcedureId = @ProcedureId AND Region = 'Duodenum' AND MatrixCode = 'DuodenumNormal')
			 BEGIN
				DELETE FROM dbo.ERS_Diagnoses WHERE ProcedureID = @ProcedureId AND Region = 'Duodenum' AND MatrixCode = 'DuodenumNormal'

				INSERT INTO [ERS_Diagnoses] (ProcedureID, SiteID, MatrixCode, [Value], [Region]) 
				VALUES (@ProcedureID, 0, 'DuodenumNotEntered','true','Duodenum')
			 END
		END
		ELSE	
		BEGIN
		    INSERT INTO [ERS_Diagnoses] (ProcedureID, SiteID, MatrixCode, [Value], [Region]) 
		    VALUES (@ProcedureID, 0, 'DuodenumNotEntered','true','Duodenum')
		END
		
		EXEC dbo.ogd_diagnoses_summary_update @ProcedureId
	END
END
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS# 	 4160
--  
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ferdowsi 7/9/2024
-- TFS#	 3578
-- Description of change
--  insert data
--------------------------------------------------------------------------------------------------------------------------
IF NOT EXISTS (SELECT 1 FROM UI_Sections WHERE SectionName ='Patient Management')
 BEGIN
   INSERT INTO UI_Sections (SectionName,SectionControl,ItemOrder,ReferenceTableName,DataTableName,DisplayOnReport,NEDRequired,DNAExempt,PageId)
 VALUES ('Patient Management','Management.ascx',0,NULL,NULL,1,1,1,2)
END

EXEC dbo.DropIfExist 
    @ObjectName = 'TR_UpperGIQA_Insert', 
    @ObjectTypePrefix = 'TR' 
GO

CREATE TRIGGER [dbo].[TR_UpperGIQA_Insert]
ON [dbo].[ERS_UpperGIQA]
AFTER INSERT, UPDATE 
AS 
	DECLARE @procedure_id INT	DECLARE @summary Varchar(500)
	SELECT @procedure_id=ProcedureId FROM INSERTED
	EXEC ogd_qa_summary_update @procedure_id
	SELECT  @summary = Summary FROM  ERS_UpperGIQA where ProcedureId =  @procedure_id 
	if (@summary<> '')
	BEGIN 
	   EXEC UI_update_procedure_summary   @procedure_id, 'Patient Management', 'Patient Management', 1  -- added by Ferdowsi
	END
	ELSE 
	BEGIN 
	DELETE FROM ERS_ProcedureSummary where Summary = 'Patient Management' AND ProcedureId = @procedure_id
	END
 GO
  ------------------------------------------------------------------------------------------------------------------------
-- END OF TFS# 	 3578
--  
------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ferdowsi 7/9/2024
-- TFS#	4086
-- Description of change
--  Add Nissen's Fundoplication to Previous Surgery for OGD
 
------------------------------------------------------------------------------------------------------------------------
GO
DECLARE @PreviousSurgeryID AS INT = ISNULL((SELECT UniqueId FROM ERS_PreviousSurgery WHERE Description = 'Nissen''s Fundoplication'),0)
DECLARE @ProcedureTypeID AS INT = (SELECT ProcedureTypeId FROM ERS_ProcedureTypes WHERE ProcedureType ='Gastroscopy')

IF @PreviousSurgeryID > 0
	Update ERS_PreviousSurgeryProcedureTypes SET ProcedureTypeId = @ProcedureTypeID WHERE PreviousSurgeryId = @PreviousSurgeryID

ELSE
BEGIN
	INSERT INTO ERS_PreviousSurgery (Description,NEDTerm,ListOrderBy ,Suppressed,WhoCreatedId,WhenCreated,WhoUpdatedId ,WhenUpdated,ResectionId )
	VALUES ('Nissen''s Fundoplication',NULL,NULL, 0,NULL,GETDATE(),NULL,NULL,NULL)

	INSERT INTO ERS_PreviousSurgeryProcedureTypes (PreviousSurgeryId,ProcedureTypeId) VALUES (SCOPE_IDENTITY(), @ProcedureTypeID)
END
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS# 4086
--  
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ahmed Shoud
-- TFS#	3148
-- Description of change
-- ERCP attempts sphincterotomy
------------------------------------------------------------------------------------------------------------------------

GO
 IF NOT EXISTS (
        SELECT 1
        FROM INFORMATION_SCHEMA.COLUMNS
        WHERE TABLE_NAME = 'ERS_Visualisation' AND
              COLUMN_NAME IN ('SphincterotomyAttempts', 'SphincterotomyAttemptsOtherText')
    )
    BEGIN
		
		ALTER TABLE ERS_Visualisation
            ADD SphincterotomyAttempts smallint NULL, SphincterotomyAttemptsOtherText varchar(max) NULL
    END
GO

------------------------------------------------------------------------------------------------------------------------
-- TFS#	3148 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ferdowsi 6/25/2024
-- TFS#	3141 , 	4152
-- Description of change
--  Coorected the  phrased of ERCP Extent of hepatobiliary , 4152
-- Visualization  added in the summary report , TFS# 3141

-- Updated by	:	Ahmed Shoud
-- TFS#	3148
-- Description of change
-- ERCP attempts sphincterotomy  
------------------------------------------------------------------------------------------------------------------------

EXEC dbo.DropIfExist 
    @ObjectName = 'Otherdata_Visualisation_Summary_Update', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[Otherdata_Visualisation_Summary_Update]
(
	@ProcedureID	AS INT
)
AS

SET NOCOUNT ON

BEGIN TRANSACTION

BEGIN TRY

	DECLARE
		@ProcedureAbandoned					bit,
		@AccessVia							int,
		@AccessViaOtherText					varchar(500),		
		@MajorPapillaBile_ER				smallint ,
		@MajorPapillaBileReason_ER			varchar(50) ,
		@MajorPapillaPancreatic_ER			smallint ,
		@MajorPapillaPancreaticReason_ER	varchar(50) ,
		@MajorPapillaBile					smallint ,
		@MajorPapillaBileReason				varchar(50) ,
		@MajorPapillaPancreatic				smallint ,
		@MajorPapillaPancreaticReason		varchar(50) ,
		@MinorPapilla						smallint ,
		@MinorPapillaReason					varchar(50) ,
		@MinorPapilla_ER					smallint ,
		@MinorPapillaReason_ER				varchar(50) ,
		@HepatobiliaryNotVisualised			bit ,
		@HepatobiliaryWholeBiliary			bit ,
		@ExceptBileDuct						bit ,
		@ExceptGallBladder					bit ,
		@ExceptCommonHepaticDuct			bit ,
		@ExceptRightHepaticDuct				bit ,
		@ExceptLeftHepaticDuct				bit ,
		@HepatobiliaryAcinarFilling			bit ,
		@HepatobiliaryLimitedBy				smallint ,
		@HepatobiliaryLimitedByOtherText	varchar(500) ,
		@PancreaticNotVisualised			bit ,
		@PancreaticDivisum					bit ,
		@PancreaticWhole					bit ,
		@ExceptAccesoryPancreatic			bit ,
		@ExceptMainPancreatic				bit ,
		@ExceptUncinate						bit ,
		@ExceptHead							bit ,
		@ExceptNeck							bit ,
		@ExceptBody							bit ,
		@ExceptTail							bit ,
		@PancreaticAcinar					bit ,
		@PancreaticLimitedBy				smallint ,
		@PancreaticLimitedByOtherText		varchar(500) ,
		@HepatobiliaryFirst					smallint ,
		@HepatobiliaryFirstML				varchar(50) ,
		@HepatobiliarySecond				smallint ,
		@HepatobiliarySecondML				varchar(50) ,
		@HepatobiliaryBalloon				bit ,
		@PancreaticFirst					smallint ,
		@PancreaticFirstML					varchar(50) ,
		@PancreaticSecond					smallint ,
		@PancreaticSecondML					varchar(50) ,
		@PancreaticBalloon					bit,
		@DuodenumNormal						bit,
		@DuodenumNotEntered					bit,
		@Duodenum2ndPartNotEntered			bit,
		@AmpullaNotVisualised				bit,
	    @IntendedMessage    				varchar(100) ,
		@IntendedBileDuct                   bit,  -- added by Ferdowsi , TFS - 3141
		@IntendedPancreaticDuct             bit, -- added by Ferdowsi , TFS - 3141
		@SphincterotomyAttempts				smallint, -- TFS 3148
		@SphincterotomyAttemptsOtherText	varchar(max); -- TFS 3148

		SELECT 
			@ProcedureAbandoned				= COALESCE(Abandoned_ER, Abandoned),
			@AccessVia						= AccessVia,
			@AccessViaOtherText				= AccessViaOtherText,
			--@MajorPapillaBile				= CASE WHEN (case when isnull(MajorPapillaBile_ER, 5) = 3 then 5 else MajorPapillaBile_ER end) < (case when isnull(MajorPapillaBile, 5) = 3 then 5 else MajorPapillaBile end) THEN MajorPapillaBile_ER ELSE MajorPapillaBile END,
			--@MajorPapillaBileReason		= CASE WHEN (case when isnull(MajorPapillaBile_ER, 5) = 3 then 5 else MajorPapillaBile_ER end) < (case when isnull(MajorPapillaBile, 5) = 3 then 5 else MajorPapillaBile end) THEN ISNULL(MajorPapillaBileReason_ER, 0) ELSE ISNULL(MajorPapillaBileReason, 0) END,
			--@MajorPapillaPancreatic		= CASE WHEN (case when isnull(MajorPapillaPancreatic_ER, 5) = 3 then 5 else MajorPapillaPancreatic_ER end) < (case when isnull(MajorPapillaPancreatic, 5) = 3 then 5 else MajorPapillaPancreatic end) THEN MajorPapillaPancreatic_ER ELSE MajorPapillaPancreatic END,
			--@MajorPapillaPancreaticReason	= CASE WHEN (case when isnull(MajorPapillaPancreatic_ER, 5) = 3 then 5 else MajorPapillaPancreatic_ER end) < (case when isnull(MajorPapillaPancreatic, 5) = 3 then 5 else MajorPapillaPancreatic end) THEN ISNULL(MajorPapillaPancreaticReason_ER, 0) ELSE ISNULL(MajorPapillaPancreaticReason, 0) END,
			@MajorPapillaBile_ER			= MajorPapillaBile_ER,
			@MajorPapillaBileReason_ER		= MajorPapillaBileReason_ER,
			@MajorPapillaPancreatic_ER		= MajorPapillaPancreatic_ER,
			@MajorPapillaPancreaticReason_ER= MajorPapillaPancreaticReason_ER,
			@MajorPapillaBile				= MajorPapillaBile,
			@MajorPapillaBileReason			= MajorPapillaBileReason,
			@MajorPapillaPancreatic			= MajorPapillaPancreatic,
			@MajorPapillaPancreaticReason	= MajorPapillaPancreaticReason,
			@MinorPapilla					= MinorPapilla,
			@MinorPapillaReason				= MinorPapillaReason,
			@MinorPapilla_ER				= MinorPapilla_ER,
			@MinorPapillaReason_ER			= MinorPapillaReason_ER,
			@HepatobiliaryNotVisualised		= HepatobiliaryNotVisualised,
			@HepatobiliaryWholeBiliary		= HepatobiliaryWholeBiliary,
			@ExceptBileDuct					= ExceptBileDuct,
			@ExceptGallBladder				= ExceptGallBladder,
			@ExceptCommonHepaticDuct		= ExceptCommonHepaticDuct,
			@ExceptRightHepaticDuct			= ExceptRightHepaticDuct,
			@ExceptLeftHepaticDuct			= ExceptLeftHepaticDuct,
			@HepatobiliaryAcinarFilling		= HepatobiliaryAcinarFilling,
			@HepatobiliaryLimitedBy			= HepatobiliaryLimitedBy,
			@HepatobiliaryLimitedByOtherText = HepatobiliaryLimitedByOtherText,
			@PancreaticNotVisualised		= PancreaticNotVisualised,
			@PancreaticDivisum				= PancreaticDivisum,
			@PancreaticWhole				= PancreaticWhole,
			@ExceptAccesoryPancreatic		= ExceptAccesoryPancreatic,
			@ExceptMainPancreatic			= ExceptMainPancreatic,
			@ExceptUncinate					= ExceptUncinate,
			@ExceptHead						= ExceptHead,
			@ExceptNeck						= ExceptNeck,
			@ExceptBody						= ExceptBody,
			@ExceptTail						= ExceptTail,
			@PancreaticAcinar				= PancreaticAcinar,
			@PancreaticLimitedBy			= PancreaticLimitedBy,
			@PancreaticLimitedByOtherText	= PancreaticLimitedByOtherText,
			@HepatobiliaryFirst				= HepatobiliaryFirst,
			@HepatobiliaryFirstML			= HepatobiliaryFirstML,
			@HepatobiliarySecond			= HepatobiliarySecond,
			@HepatobiliarySecondML			= HepatobiliarySecondML,
			@HepatobiliaryBalloon			=HepatobiliaryBalloon,
			@PancreaticFirst				= PancreaticFirst,
			@PancreaticFirstML				= PancreaticFirstML,
			@PancreaticSecond				= PancreaticSecond,
			@PancreaticSecondML				= PancreaticSecondML,
			@PancreaticBalloon				= PancreaticBalloon,
			@DuodenumNormal					= DuodenumNormal,
			@DuodenumNotEntered				= DuodenumNotEntered,
			@Duodenum2ndPartNotEntered		= Duodenum2ndPartNotEntered,
			@AmpullaNotVisualised			= AmpullaNotVisualised,
			@IntendedBileDuct               = IntendedBileDuct_ER,
		    @IntendedPancreaticDuct         = IntendedPancreaticDuct_ER,
			@SphincterotomyAttempts			= SphincterotomyAttempts, -- TFS 3148
			@SphincterotomyAttemptsOtherText= SphincterotomyAttemptsOtherText -- TFS 3148
		FROM [ERS_Visualisation] 
		WHERE ProcedureID = @ProcedureId;



        DECLARE @A varchar(2000)='', @B varchar(2000)='' , @C varchar(2000)='', @AR1 varchar(2000)='', @AR2 varchar(2000)=''
        DECLARE @C1 varchar(500) =''
        DECLARE @Reasons1 varchar(2000)='', @Reasons2 varchar(2000) ='', @Reasons3 varchar(2000), @Reasons4 varchar(2000)
        DECLARE @tmp1 TABLE(Val VARCHAR(MAX))
        DECLARE @tmp2 TABLE(Val VARCHAR(MAX))
        DECLARE @NoHepExcept bit=0,  @NoPanExcept bit =0
		DECLARE @vMajorPapillaBile smallint, @vMajorPapillaBileReason varchar(50), @vMajorPapillaPancreatic smallint, @vMajorPapillaPancreaticReason varchar(50)
		DECLARE @vMinorPapilla smallint, @vMinorPapillaReason varchar(50)
		
		IF ISNULL(@MajorPapillaBile_ER, 5) < ISNULL(@MajorPapillaBile, 5)
		BEGIN
			 SET @vMajorPapillaBile = @MajorPapillaBile_ER
			 SET @vMajorPapillaBileReason = @MajorPapillaBileReason_ER
		END
		ELSE
		BEGIN
			SET @vMajorPapillaBile = @MajorPapillaBile		
			SET @vMajorPapillaBileReason = @MajorPapillaBileReason
		END

		IF ISNULL(@MajorPapillaPancreatic_ER, 5) < ISNULL(@MajorPapillaPancreatic, 5)
		BEGIN
			 SET @vMajorPapillaPancreatic = @MajorPapillaPancreatic_ER
			 SET @vMajorPapillaPancreaticReason = @MajorPapillaPancreaticReason_ER
		END
		ELSE
		BEGIN
			SET @vMajorPapillaPancreatic = @MajorPapillaPancreatic		
			SET @vMajorPapillaPancreaticReason = @MajorPapillaPancreaticReason
		END
        IF @IntendedBileDuct > 0 OR @IntendedPancreaticDuct>0   --TFS 3141 , By ferdowsi
		BEGIN 
		SET @IntendedMessage ='Intended duct(s) for cannulation ';
		  IF @IntendedBileDuct > 0
		    BEGIN 
		      SET @IntendedMessage = @IntendedMessage + 'Bile duct'
 		    END 
          IF @IntendedPancreaticDuct>0 
		   BEGIN
		     IF @IntendedBileDuct > 0
		      BEGIN 
		       SET @IntendedMessage = @IntendedMessage + ' and '
 		      END 
			   SET @IntendedMessage = @IntendedMessage + 'Pancreatic duct'		     
		   END 
		END -- end TFS 3141 , By ferdowsi
  
        IF @AccessVia > 0 
            BEGIN
            IF ISNULL(@AccessViaOtherText,0) > 0 SET @A = ISNULL((SELECT ListItemText + '. ' FROM ERS_Lists where ListDescription='ERCP other access point' AND  ListItemNo = ISNULL(@AccessViaOtherText,0)  AND LOWER(ListItemText) <> '(none)'),'') 
            END
        SET @B='Cannulation via the major papilla to the bile and pancreatic ducts was unsuccessful '

        IF @vMajorPapillaBile =1 AND @vMajorPapillaPancreatic =1
        BEGIN
            SET @A = @A + 'Cannulation via the major papilla to the bile and pancreatic ducts was successful '
            SET @B= ''    
            DECLARE @CannDev VARCHAR(50) = ''               
            IF ISNULL(@vMajorPapillaBileReason,0)<>0 SET @B = ISNULL((SELECT ISNULL(ListItemText,'') FROM ERS_Lists where ListDescription='ERCP via major to bile successful using' AND  ListItemNo = ISNULL(@vMajorPapillaBileReason,0) AND LOWER(ListItemText) <> '(none)'),'')
            IF @B <> '' IF LEFT(@B, 1) IN ('a','e','i','o','u') SET @B= 'an ' + @B ELSE SET @B= 'a '+ @B
            IF LEN(LTRIM(RTRIM(@B)))  > 0 SET @CannDev = 'using ' + @B
            DECLARE @B1 varchar(50) =''

            IF ISNULL(@vMajorPapillaPancreaticReason,0)<>0 SET @B1 = ISNULL((SELECT ISNULL(ListItemText,'') FROM ERS_Lists where ListDescription='ERCP via major to pancreatic successful using' AND  ListItemNo = ISNULL(@vMajorPapillaPancreaticReason,0) AND LOWER(ListItemText) <> '(none)'),'')
            IF @B1 <> '' IF LEFT(@B1, 1) IN ('a','e','i','o','u') SET @B1= 'an ' + @B1 ELSE SET @B1= 'a '+ @B1
            IF LEN(LTRIM(RTRIM(@B1)))  > 0
                    BEGIN
                    IF LEN(@CannDev)>0
                            BEGIN 
                            IF LTRIM(RTRIM(@B)) <> LTRIM(RTRIM(@B1)) SET @CannDev = @CannDev + ' and  ' + @B1
                            END
                    ELSE IF @B1 <> '' SET @CannDev = 'using '+ @B1
                    END
            IF LEN(LTRIM(RTRIM(@CannDev)))>0 SET @A = @A + @CannDev + '. '
            ELSE SET @A = LTRIM(RTRIM(@A)) + '. '
        END
        ELSE IF @vMajorPapillaBile =3 AND @vMajorPapillaPancreatic =3
        BEGIN
            SET @A = @A + 'Cannulation via the major papilla to the bile and pancreatic ducts was not attempted. '
        END
        ELSE
        BEGIN
            SET @Reasons1 = ISNULL((SELECT ISNULL(ListItemText,'') FROM ERS_Lists where ListDescription='ERCP via major to bile successful using' AND  ListItemNo = ISNULL(@vMajorPapillaBileReason,0) AND LOWER(ListItemText) <> '(none)'),'')
            SET @Reasons2 = ISNULL((SELECT ISNULL(ListItemText,'') FROM ERS_Lists where ListDescription='ERCP via major to pancreatic successful using' AND  ListItemNo = ISNULL(@vMajorPapillaPancreaticReason,0) AND LOWER(ListItemText) <> '(none)'),'')
            IF @vMajorPapillaBile =4 AND @vMajorPapillaPancreatic =4 AND @Reasons1 = @Reasons2 
                    BEGIN
                    IF ISNULL(@vMajorPapillaBileReason,0)=0 AND ISNULL(@vMajorPapillaBileReason,0)=0 SET @A = @A + @B
                    ELSE SET @A = @A + LTRIM(RTRIM(@B)) + ', limited by ' + @Reasons1
                    SET @A = LTRIM(RTRIM(@A) ) + '. '
                    END
            ELSE
                    BEGIN
                    DECLARE @CAN varchar(1000)='', @AndBut varchar(50)=''
                    SET @B= 'Cannulation via the major papilla to the bile duct was '
                    SET @C= ''
                    SET @AndBut='and'
                    IF (@vMajorPapillaBile=1 AND (@vMajorPapillaPancreatic=4 OR @vMajorPapillaPancreatic=2 )) OR ( @vMajorPapillaPancreatic=1 AND (@vMajorPapillaBile=4 OR @vMajorPapillaBile=2)) SET @AndBut='but'
                    IF @vMajorPapillaBile =1
                        BEGIN
							SET @C= @B + 'successful'
							SET @B=''
							SET @B= ISNULL((SELECT ListItemText FROM ERS_Lists where ListDescription='ERCP via major to bile successful using' AND  ListItemNo = ISNULL(@vMajorPapillaBileReason,0) AND LOWER(ListItemText) <> '(none)'),'')
							IF @B<>'' 
								IF LEFT(@B, 1) IN ('a','e','i','o','u') 
									SET @C= @C + ' using an ' + @B 
								ELSE 
									SET @C= @C + ' using a ' + @B
                        END
                    ELSE IF @vMajorPapillaBile =3 SET @C= @B + 'not attempted'
                    ELSE IF @vMajorPapillaBile =4
                        BEGIN
                            SET @Reasons1=ISNULL((SELECT ListItemText FROM ERS_Lists where ListDescription='ERCP via major to bile unsuccessful due to' AND  ListItemNo = ISNULL(@vMajorPapillaBileReason,0) AND LOWER(ListItemText) <> '(none)'),'')
                            IF @Reasons1='' SET @C = @B + 'unsuccessful'
                            ELSE 
                            BEGIN 
								SET @C= @B + 'unsuccessful due to ' + @Reasons1
								SET @CAN = ' cannulation '
                            END
                        END
                    ELSE IF @vMajorPapillaBile =2
                            BEGIN
                            SET @Reasons1=ISNULL((SELECT ListItemText FROM ERS_Lists where ListDescription='ERCP via major to bile partially successful reason' AND  ListItemNo = ISNULL(@vMajorPapillaBileReason,0) AND LOWER(ListItemText) <> '(none)'),'')
                            IF @Reasons1='' SET @C = @B + 'partially successful'
                            ELSE 
                                BEGIN 
                                SET @C= @B + 'partially successful due to ' + @Reasons1
                                SET @CAN = ' cannulation '
                                END
                            END

                            DECLARE @Comma varchar(50)=''
                            IF @C ='' SET @B = 'cannulation via the major papilla to pancreatic duct was '
                            ELSE 
                                BEGIN
                                SET @Reasons1 = ISNULL((SELECT ListItemText FROM ERS_Lists where ListDescription='ERCP via major to bile unsuccessful due to' AND  ListItemNo = ISNULL(@vMajorPapillaBileReason,0) AND LOWER(ListItemText) <> '(none)'),'')
                                SET @Reasons2 = ISNULL((SELECT ListItemText FROM ERS_Lists where ListDescription='ERCP via major to pancreatic unsuccessful due to' AND  ListItemNo = ISNULL(@vMajorPapillaPancreatic,0) AND LOWER(ListItemText) <> '(none)'),'')
                                IF (@vMajorPapillaBile=1 AND @vMajorPapillaPancreatic=1) AND (@Reasons1 <>'' AND @Reasons2 <> '') SET @CAN = ' also ' + @CAN
                                SET @B = @AndBut + @CAN + ' to the pancreatic duct was '
                                SET @Comma = ', '
                                END
						IF @MajorPapillaPancreatic=1
                        BEGIN
							SET @C= @C + @Comma + @B + 'successful '
							SET @B = ISNULL((SELECT ListItemText FROM ERS_Lists where ListDescription='ERCP via major to pancreatic successful using' AND  ListItemNo = ISNULL(@vMajorPapillaPancreaticReason,0) AND LOWER(ListItemText) <> '(none)'),'')
							IF @B<>'' 
								IF ISNULL(@vMajorPapillaBileReason,0) >0  
									IF LEFT(@B, 1) IN ('a','e','i','o','u') 
										SET @C= @C + ' using an ' + @B + ' ' 
									ELSE 
										SET @C= @C + ' using a ' + @B + ' '
                        END
                    ELSE IF @vMajorPapillaPancreatic=3 SET @C= @C + @Comma + @B + 'not attempted '
                    ELSE IF @vMajorPapillaPancreatic=4
                        BEGIN
							SET @Reasons1 = ISNULL((SELECT ListItemText FROM ERS_Lists where ListDescription='ERCP via major to pancreatic unsuccessful due to' AND  ListItemNo = ISNULL(@vMajorPapillaPancreaticReason,0) AND LOWER(ListItemText) <> '(none)'),'')
							IF @Reasons1 = '' SET @C= @C + @Comma + @B + 'unsuccessful '
							ELSE SET @C= @C + @Comma + @B + 'unsuccessful due to ' + @Reasons1
                        END
                    ELSE IF @vMajorPapillaPancreatic=2
                        BEGIN
                            SET @Reasons1 = ISNULL((SELECT ListItemText FROM ERS_Lists where ListDescription='ERCP via major to pancreatic partially successful reason' AND  ListItemNo = ISNULL(@vMajorPapillaPancreaticReason,0) AND LOWER(ListItemText) <> '(none)'),'')
                            IF @Reasons1 ='' SET @C = @C + @Comma + @B + 'partially successful'
                            ELSE 
                                BEGIN
                                SET @C = @C + @Comma + @B + 'partially successful due to ' + @Reasons1
                                SET @CAN = ' cannulation '
                                END
						 IF @C<>'' SET @A = @A + LTRIM(RTRIM(@C)) + '. '
                        END
                       
                    END    
        END

		IF @MinorPapilla_ER = 1 OR @MinorPapilla = 1
		BEGIN
			SET @vMinorPapilla = 1
			BEGIN
				IF @MinorPapilla_ER = 1				
					SET @vMinorPapillaReason = @MinorPapillaReason_ER
				ELSE				
					SET @vMinorPapillaReason = @MinorPapillaReason		
			END
			
			SET @A = @A + 'Cannulation via the minor papilla was successful '
			SET @B =  ISNULL((SELECT ListItemText FROM ERS_Lists where ListDescription='ERCP via minor successful using to' AND  ListItemNo = ISNULL(@vMinorPapillaReason,0) AND LOWER(ListItemText) <> '(none)'),'')
			IF @B <> '' IF LEFT(@B, 1) IN ('a','e','i','o','u') SET @A= @A + ' using an ' + @B  ELSE SET @A= @A + ' using a ' + @B 
			SET @A = LTRIM(RTRIM(@A)) + '.'
		END
		ELSE IF @MinorPapilla_ER = 2 OR @MinorPapilla = 2
		BEGIN
			SET @vMinorPapilla = 2
			BEGIN
				IF @MinorPapilla_ER = 2
					SET @vMinorPapillaReason = @MinorPapillaReason_ER
				ELSE				
					SET @vMinorPapillaReason = @MinorPapillaReason		
			END
			
			SET @B = 'Cannulation via the minor papilla was partially successful '
			SET @Reasons1 = ISNULL((SELECT ListItemText FROM ERS_Lists where ListDescription='ERCP via minor partially successful reason' AND  ListItemNo = ISNULL(@vMinorPapillaReason,0) AND LOWER(ListItemText) <> '(none)'),'')
            IF @Reasons1 = '' SET @A = @A + @B
            ELSE SET @A = @A + @B + 'due to ' + @Reasons1
            SET @A = LTRIM(RTRIM(@A)) + '.'
		END	
		ELSE IF @MinorPapilla_ER = 4 OR @MinorPapilla = 4
		BEGIN
			SET @vMinorPapilla = 4
			BEGIN
				IF @MinorPapilla_ER = 4
					SET @vMinorPapillaReason = @MinorPapillaReason_ER
				ELSE				
					SET @vMinorPapillaReason = @MinorPapillaReason		
			END
			
			SET @B ='Cannulation via the minor papilla was unsuccessful ' 
            SET @Reasons1 = ISNULL((SELECT ListItemText FROM ERS_Lists where ListDescription='ERCP via minor unsuccessful due to' AND  ListItemNo = ISNULL(@vMinorPapillaReason,0) AND LOWER(ListItemText) <> '(none)'),'')
            IF @Reasons1 = '' SET @A = @A + @B
            ELSE SET @A = @A + @B + 'due to ' + @Reasons1
            SET @A = LTRIM(RTRIM(@A)) + '.'
		END
		ELSE IF @MinorPapilla_ER = 3 OR @MinorPapilla = 3
		BEGIN
			SET @minorPapilla = 3
			BEGIN
				IF @MinorPapilla_ER = 3
					SET @minorPapillaReason = @MinorPapillaReason_ER
				ELSE				
					SET @minorPapillaReason = @MinorPapillaReason		
			END
			
			SET @B ='Cannulation via the minor papilla was not attempted ' 
            SET @Reasons1 = ISNULL((SELECT ListItemText FROM ERS_Lists where ListDescription='ERCP via minor unsuccessful due to' AND  ListItemNo = ISNULL(@vMinorPapillaReason,0) AND LOWER(ListItemText) <> '(none)'),'')
            IF @Reasons1 = '' SET @A = @A + @B
            ELSE SET @A = @A + @B + 'due to ' + @Reasons1
            SET @A = LTRIM(RTRIM(@A)) + '.'
		END
		-- TFS 3148 Start
		IF @SphincterotomyAttempts IS NOT NULL AND @SphincterotomyAttempts  <> ''
		SET @B = 'Number of attempts of sphincterotomy - '
		BEGIN
			IF @SphincterotomyAttempts = 1
				BEGIN
					SET @B = @B + 'Single'
				END
			IF @SphincterotomyAttempts = 2
				BEGIN
					SET @B = @B + 'Few'
				END
			IF @SphincterotomyAttempts = 3
				BEGIN
					SET @B = @B + 'Prolonged'
				END
			IF @SphincterotomyAttempts = 4 AND @SphincterotomyAttemptsOtherText IS NULL
				BEGIN
					SET @B = @B + 'Other'
				END
			ELSE IF @SphincterotomyAttempts = 4 AND @SphincterotomyAttemptsOtherText IS NOT NULL
				BEGIN
					SET @B = @B + @SphincterotomyAttemptsOtherText
				END
		SET @A = @A + @B
		SET @A = LTRIM(RTRIM(@A)) + '.'
		END
		-- TFS 3148 End
		IF @A <> '' SET @A = dbo.fnFirstLetterUpper(@A)
		IF @ExceptBileDuct = 1 INSERT INTO @tmp1 (Val) VALUES('common bile duct')
		IF @ExceptGallBladder= 1 INSERT INTO @tmp1 (Val) VALUES('gall bladder')
		IF @ExceptCommonHepaticDuct = 1 INSERT INTO @tmp1 (Val) VALUES('common hepatic duct')
		IF @ExceptRightHepaticDuct = 1 INSERT INTO @tmp1 (Val) VALUES('right hepatic duct')
		IF @ExceptLeftHepaticDuct = 1 INSERT INTO @tmp1 (Val) VALUES('left hepatic duct')

		IF @ExceptAccesoryPancreatic = 1 INSERT INTO @tmp2 (Val) VALUES('accessory pancreatic duct')
		IF @ExceptMainPancreatic = 1 INSERT INTO @tmp2 (Val) VALUES('main pancreatic duct')
		IF @ExceptUncinate = 1 INSERT INTO @tmp2 (Val) VALUES('uncinate process')
		IF @ExceptHead  = 1 INSERT INTO @tmp2 (Val) VALUES('head')
		IF @ExceptNeck  = 1 INSERT INTO @tmp2 (Val) VALUES('neck')
		IF @ExceptBody  = 1 INSERT INTO @tmp2 (Val) VALUES('body')
		IF @ExceptTail  = 1 INSERT INTO @tmp2 (Val) VALUES('tail')

		IF (SELECT COUNT(Val) FROM @tmp1)=0 SET @NoHepExcept = 1
		IF (SELECT COUNT(Val) FROM @tmp2)=0 SET @NoPanExcept = 1

		SET @Reasons1 = ISNULL((SELECT ListItemText FROM ERS_Lists where ListDescription='ERCP extent of visualisation limited by other' AND  ListItemNo = ISNULL(@HepatobiliaryLimitedByOtherText,0) AND LOWER(ListItemText) <> '(none)'),'')
		SET @Reasons2 = ISNULL((SELECT ListItemText FROM ERS_Lists where ListDescription='ERCP extent of visualisation limited by other' AND  ListItemNo = ISNULL(@PancreaticLimitedByOtherText,0) AND LOWER(ListItemText) <> '(none)'),'')

		SET @AndBut = 'and '

		DECLARE @XMLlist1 XML, @XMLlist2 XML
		SET @XMLlist1 = (SELECT Val FROM @tmp1 FOR XML  RAW, ELEMENTS, TYPE)
		SET @AR1 =     dbo.fnBuildString(@XMLlist1)
       
		SET @XMLlist2 = (SELECT Val FROM @tmp2 FOR XML  RAW, ELEMENTS, TYPE)
		SET @AR2 = dbo.fnBuildString(@XMLlist2) 
		 -- Visulization start from here 


		IF @HepatobiliaryNotVisualised = 1 AND @PancreaticNotVisualised= 1
        BEGIN 
		 
            SEt @B = 'Visualisation: Neither the biliary nor pancreatic systems were visualised ' -- modified by Ferdowsi, TFS 4152
            IF @HepatobiliaryLimitedBy = 1 AND @PancreaticLimitedBy= 1 SET @A = @A + @B + 'due to insufficient contrast. '
            ELSE IF (@HepatobiliaryLimitedBy = 2 AND @PancreaticLimitedBy= 2) AND  (@Reasons1 = @Reasons2)
                    BEGIN
                    IF @Reasons1='' SET @A = @A + @B + '. '
                    ELSE SET @A = @A + @B + 'due to ' + @Reasons1 + '. '
                    END
            ELSE IF @HepatobiliaryLimitedBy<> @PancreaticLimitedBy
            BEGIN
            SET @A = @A + 'Visualisation: The biliary system was not visualised '
            IF @HepatobiliaryLimitedBy= 1 SET @A = @A + 'due to insufficient contrast '
            IF @HepatobiliaryLimitedBy= 2 AND @Reasons1<>'' SET @A = @A + 'due to ' + @Reasons1 + ' '
            SET @A = @A + 'nor was the pancreatic system visualised '
            IF @PancreaticLimitedBy = 1 SET @A = @A + 'due to insufficient contrast '
            IF @PancreaticLimitedBy = 2 AND @Reasons2<>'' SET @A = @A + ' due to ' + @Reasons2 + ' '
            SET @A = @A   
            END
            ELSE IF ISNULL(@HepatobiliaryLimitedBy,0)=0 AND ISNULL(@PancreaticLimitedBy,0)=0 SET @A = @A + LTRIM(RTRIM(@B)) + '. ' 
		END
		ELSE IF ISNULL(@HepatobiliaryNotVisualised,0) <>1 AND @PancreaticNotVisualised= 1
        BEGIN
            SET @B=''
            IF @HepatobiliaryWholeBiliary=1
                    BEGIN
                    SET @B = 'Visualisation: The whole biliary system '
                    IF @NoHepExcept=1 SET @A = @A + @B
                    ELSE 
                        BEGIN            
							SET @A = @A + @B + 'except the ' + @AR1
							IF @HepatobiliaryLimitedBy =1 SET @A = @A + ', limited by insufficient contrast '
							IF @HepatobiliaryLimitedBy =2 SET @A = @A + ', limited by ' + @Reasons1 + ' '
                        END
                    END
                    IF @B <> '' 
                        BEGIN
                        SET @B='but not the pancreatic system  '
                        SET @Comma = ' '
                        END
                    ELSE
                        BEGIN
                        SET @B= 'Visualisation: The pancreatic system was not visualised '
                        SET @Comma = ''
                        END
            IF @PancreaticLimitedBy= 1 SET @B = @B + 'due to insufficient contrast '
            IF @PancreaticLimitedBy= 2 AND @Reasons2<>'' SET @B = @B + ' due to ' + @Reasons2 + ' '
            SET @A = LTRIM(RTRIM(@A)) + @Comma + LTRIM(RTRIM(@B)) + '. '  
			
        	  
        END
              
		ELSE IF ISNULL(@HepatobiliaryNotVisualised,0) =1 AND ISNULL(@PancreaticNotVisualised,0) <> 1
        BEGIN
            DECLARE @Vis varchar(50)=''
            SET @B = 'Visualisation: The biliary system was not visualised '
            SET @AndBut ='but '
            IF @HepatobiliaryLimitedBy = 1
                    BEGIN
                    SET @B = @B + 'due to insufficient contrast '
                    SET @Vis = 'Visualisation: '
                    END
            IF @HepatobiliaryLimitedBy = 2 AND @Reasons1 <> ''
                    BEGIN
                    SET @B = @B + 'due to ' + @Reasons1 + ' '
                    SET @Vis = 'Visualisation: '
                    END
           SET @C = ''
            IF @PancreaticWhole = 1 OR @PancreaticDivisum = 1  -- added by Ferdowsi , TFS - 4152
                    BEGIN
					  SET @C = @AndBut + 'the whole pancreatic system '      
                     SET @C1 = @AndBut + 'the pancreas divisum '
                    IF @PancreaticDivisum= 1 SET @C = @C1
                    IF @NoPanExcept= 1 SET @C = @C + 'was visualised'
                    ELSE
                        BEGIN
                        SET @C = @C  + 'except the ' + @AR2 + ' was visualised'
                        IF @PancreaticLimitedBy = 1 SET @C = @C + ', limited by insufficient contrast '
                        IF @PancreaticLimitedBy =2 AND @Reasons2<>'' SET @C = @C + ', limited by '+ @Reasons2 + ' '
                        END
                    END
            IF @Vis ='' SET @B = dbo.fnFirstLetterUpper(@B)
            SET @A = @A +  @B + @C
			
        	SET @A = LTRIM(RTRIM(@A)) + '. '  
        END
		ELSE IF ISNULL(@HepatobiliaryNotVisualised,0) <>1 AND ISNULL(@PancreaticNotVisualised,0)<>1
        BEGIN
            SET @B= 'The whole biliary system visualised '
            SET @C = 'the whole pancreatic system visualised '
            SET @C1 = 'the pancreas divisum '
            IF ISNULL(@HepatobiliaryWholeBiliary,0)=1 AND (ISNULL(@PancreaticWhole,0)=1 OR ISNULL(@PancreaticDivisum,0)=1)
            BEGIN
                IF @PancreaticDivisum=1 SET @C = @C1
                IF ISNULL(@NoHepExcept,0) = 1 AND ISNULL(@NoPanExcept,0)=1
                BEGIN
                    IF @PancreaticWhole = 1 SET @A = @A + ' Visualisation: The complete biliary and pancreatic systems were visualised '
                    ELSE SET @A = @A + 'The complete biliary and pancreas divisum were visualised '
                END
                ELSE IF ISNULL(@NoHepExcept,0) = 1 AND ISNULL(@NoPanExcept,0)<>1
                BEGIN
                    SET @A = @A + 'Visualisation: ' + @B + ' and ' + @C + 'except the ' + @AR2 + ' was visualised'
                    IF @PancreaticLimitedBy=1 SET @A = @A + ', limited by insufficient contrast '
                    IF @PancreaticLimitedBy=2 AND @Reasons2 <>'' SET @A = @A + ', limited by ' + @Reasons2+ ' '
                END
                ELSE IF ISNULL(@NoHepExcept,0) <>1 AND ISNULL(@NoPanExcept,0)=1
                BEGIN
					SET @A= @A + 'Visualisation: ' + @B +' except the '+ @AR1 + ' '
					IF @HepatobiliaryLimitedBy=1 SET @A = LTRIM(RTRIM(@A)) + ', limited by insufficient contrast'
					IF @HepatobiliaryLimitedBy=2 AND @Reasons1 <>'' SET @A = LTRIM(RTRIM(@A)) + ', limited by ' + @Reasons1
					SET @A = LTRIM(RTRIM(@A)) + ' and '+ @C
				END
                ELSE IF ISNULL(@NoHepExcept,0) <>1 AND ISNULL(@NoPanExcept,0)<>1
                BEGIN
                    SET @A = @A + 'Visualisation: ' + @B + ' except the '+ @AR1 + ' '
                    IF @HepatobiliaryLimitedBy=1 SET @A = LTRIM(RTRIM(@A)) + ', limited by insufficient contrast'
                    IF @HepatobiliaryLimitedBy=2 AND @Reasons1 <>'' SET @A = LTRIM(RTRIM(@A)) + ', limited by ' + @Reasons1+ ' '
                    SET @A = LTRIM(RTRIM(@A)) + ' and '+ @C + 'except the '+ @AR2
                    IF @PancreaticLimitedBy=1 SET @A = @A + ', limited by insufficient contrast '
                    IF @PancreaticLimitedBy=2 AND @Reasons2 <>'' SET @A = @A + ', limited by ' + @Reasons2
                END
 
			END
            ELSE IF ISNULL(@HepatobiliaryWholeBiliary,0)=1 AND ISNULL(@PancreaticWhole,0)<>1 AND ISNULL(@PancreaticDivisum,0)<>1
            BEGIN
				SET @A = @A + 'Visualisation: ' + @B
				IF @NoHepExcept=1 SET @A = @A + ' '
				ELSE 
				BEGIN
					SET @A = @A + 'except the '+ @AR1 + ' '
					IF @HepatobiliaryLimitedBy=1 SET @A = @A + ', limited by insufficient contrast, '
					IF @HepatobiliaryLimitedBy=2 AND @Reasons1<>'' SET @A = @A + ', limited by ' + @Reasons1 + ', '                         
				END
				if ISNULL(@PancreaticWhole,0)<>0  -- condition added by Ferdowsi, TFS 4152
				SET @A = @A + 'but not the pancreatic system. '
            END
            ELSE IF ISNULL(@HepatobiliaryWholeBiliary,0)<>1  AND (ISNULL(@PancreaticWhole,0)=1 OR ISNULL(@PancreaticDivisum,0)=1)
            BEGIN
				SET @A = @A + 'Visualisation: '
	 
				IF @NoPanExcept=1 SET @A = @A +  @c  
				ELSE 
				BEGIN
					SET @A = @A + @c +' except the ' + @AR2  
					IF @PancreaticLimitedBy=1 SET @A = @A + ', limited by insufficient contrast '
					IF @PancreaticLimitedBy=2 AND @Reasons2 <>'' SET @A = @A + ', limited by ' + @Reasons2
				END
	 
			END
            --ELSE IF ISNULL(@HepatobiliaryWholeBiliary,0)<>1 AND ISNULL(@PancreaticWhole,0)<>1 AND ISNULL(@PancreaticDivisum,0)<>1
                    --BEGIN
                    --SET @A = @A + 'Neither the biliary nor the pancreatic systems were visualised.'
            --END
        END
		SET @A = LTRIM(RTRIM(@A)) + '. '
		IF @ProcedureAbandoned = 1 SET @A = @A + 'The procedure was abandoned. '   

		IF @HepatobiliaryAcinarFilling    = 1 AND @PancreaticAcinar=1  SET @A = @A + '</br>There was evidence of acinar filling of the liver and the pancreas. '
		ELSE IF @HepatobiliaryAcinarFilling      = 1 AND @PancreaticAcinar<>1 SET @A = @A + '</br>There was evidence of acinar filling of the liver. '
		ELSE IF @HepatobiliaryAcinarFilling      <> 1 AND @PancreaticAcinar=1 SET @A = @A  +'</br>There was evidence of acinar filling of the pancreas. '
       
		DELETE FROM @tmp1
		DELETE FROM @tmp2
		SET @AR1= ''
		SET @AR2 = ''
		DECLARE @Vol varchar(500)='', @CM varchar(500)=''

		IF ISNULL(@HepatobiliaryFirstML,0) > 0 SET @Vol = ISNULL(@HepatobiliaryFirstML,0) + ' ml'
		IF ISNULL(@HepatobiliaryFirst,0) > 0 SET @CM = ISNULL((SELECT ListItemText FROM ERS_Lists where ListDescription='ERCP contrast media used' AND  ListItemNo = ISNULL(@HepatobiliaryFirst,0) AND LOWER(ListItemText) <> '(none)'),'')
		IF @CM <>'' OR ISNULL(@HepatobiliaryFirstML,'')<>'' INSERT INTO @tmp1 (VAl) VALUES (@Vol+ (CASE WHEN (@Vol)<>'' THEN ' ' + @CM ELSE @CM END ))

		SET @Vol='' ; SET @CM= ''

		IF ISNULL(@HepatobiliarySecondML,0) > 0 SET @Vol = ISNULL(@HepatobiliarySecondML,0) + ' ml'
		IF ISNULL(@HepatobiliarySecond,0) > 0 SET @CM = ISNULL((SELECT ListItemText FROM ERS_Lists where ListDescription='ERCP contrast media used' AND  ListItemNo = ISNULL(@HepatobiliarySecond,0) AND LOWER(ListItemText) <> '(none)'),'')
		IF @CM <>'' OR ISNULL(@HepatobiliarySecondML,'')<>'' INSERT INTO @tmp1 (VAl) VALUES (@Vol+ (CASE WHEN (@Vol)<>'' THEN ' ' + @CM ELSE @CM END ))

		SET @Vol='' ; SET @CM= ''


		IF ISNULL(@PancreaticFirstML,0) > 0 SET @Vol = ISNULL(@PancreaticFirstML,0) + ' ml'
		IF ISNULL(@PancreaticFirst,0) > 0 SET @CM = ISNULL((SELECT ListItemText FROM ERS_Lists where ListDescription='ERCP contrast media used' AND  ListItemNo = ISNULL(@PancreaticFirst,0) AND LOWER(ListItemText) <> '(none)'),'')
		IF @CM <>'' OR ISNULL(@PancreaticFirstML,'')<>'' INSERT INTO @tmp2 (VAl) VALUES (@Vol+ (CASE WHEN (@Vol)<>'' THEN ' ' + @CM ELSE @CM END ))

		SET @Vol='' ; SET @CM= ''

		IF ISNULL(@PancreaticSecondML,0) > 0 SET @Vol = ISNULL(@PancreaticSecondML,0) + ' ml'
		IF ISNULL(@PancreaticSecond,0) > 0 SET @CM = ISNULL((SELECT ListItemText FROM ERS_Lists where ListDescription='ERCP contrast media used' AND  ListItemNo = ISNULL(@PancreaticSecond,0) AND LOWER(ListItemText) <> '(none)'),'')
		IF @CM <>'' OR ISNULL(@PancreaticSecondML,'')<>'' INSERT INTO @tmp2 (VAl) VALUES (@Vol+ (CASE WHEN (@Vol)<>'' THEN ' ' + @CM ELSE @CM END ))

		SET @B=''
		SET @C = ''

		
		IF @HepatobiliaryBalloon= 1 SET @B = '(occlusion cholangiography) '
		IF     @PancreaticBalloon = 1 SET @C = '(occlusion pancreatography) '

		SET @A = LTRIM(RTRIM(@A))

		DECLARE @XMLlist01 XML, @ic1 int=0
		SET @ic1 = ISNULL((SELECT Count(Val) FROM @tmp1 WHERE LTRIM(RTRIM(Val))<> ''),0)
		SET @XMLlist01 = (SELECT Val FROM @tmp1 FOR XML  RAW, ELEMENTS, TYPE)
		SET @AR1 = dbo.fnBuildString(@XMLlist01)
       

		DECLARE @XMLlist02 XML, @ic2 int=0
		SET @ic2 = ISNULL((SELECT Count(Val) FROM @tmp2 WHERE LTRIM(RTRIM(Val))<> ''),0)
		SET @XMLlist02 = (SELECT Val FROM @tmp2 FOR XML  RAW, ELEMENTS, TYPE)
		SET @AR2 = dbo.fnBuildString(@XMLlist02)
       
		IF @ic1> 0 AND @ic2>0
        BEGIN
			SET @A = @A  + ' Contrast media used: hepatobiliary; ' + @AR1 + ' ' + @B
			SET @A = LTRIM(RTRIM(@A)) + ': pancreatic; ' + @AR2 + ' ' + @C
			SET @A = LTRIM(RTRIM(@A)) + '. '
        END    
		ELSE IF @ic1> 0 AND @ic2=0
        BEGIN
            SET @A = @A  + ' Contrast media used: hepatobiliary; ' + @AR1 + ' ' + @B
            SET @A = LTRIM(RTRIM(@A)) + '. '
        END
		ELSE IF @ic1= 0 AND @ic2>0
        BEGIN
            SET @A = @A + ' Contrast media used: pancreatic; ' + @AR2 + ' ' + @C
            SET @A = LTRIM(RTRIM(@A)) + '. '
        END


		--IF @DuodenumNormal = 1 SET @A = @A + ' Duodenum normal. '
		--ELSE 
		IF @DuodenumNotEntered = 1 SET @A = @A + '</br> Duodenum not entered. '
		ELSE IF @Duodenum2ndPartNotEntered = 1 SET @A = @A  +' Duodenum 2nd part not entered. '
		ELSE IF @AmpullaNotVisualised = 1 SET @A = @A  +' Ampulla not visualised. '

		SET @A = LTRIM(RTRIM(@A))
		IF @IntendedMessage <> ''
		BEGIN
		 SET @A = @IntendedMessage + '</br>' +  @A  --TFS 3141 , By ferdowsi
		END 
	 

	 UPDATE  [ERS_Visualisation] SET Summary = @A WHERE ProcedureID=@ProcedureID;
	 EXEC [procedure_summary_update] @ProcedureID;
	 EXEC ercp_diagnoses_summary_update @ProcedureID;
END TRY


BEGIN CATCH
    DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

       IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;
GO
 ------------------------------------------------------------------------------------------------------------------------
-- END OF TFS# 3141	,	4152, 3148
--  
------------------------------------------------------------------------------------------------------------------------


------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 05.09.24
-- TFS#	4387
-- Description of change
-- prevent the removal of the last character of the report string


-- Updated by	:	Ferdowsi
-- TFS#	3124 , 4325
-- Description of change
-- Duplicate oedema removed
--Added additiaonal options to Obsructions in Bronch Abnormality , 4325
------------------------------------------------------------------------------------------------------------------------

EXEC dbo.DropIfExist 
    @ObjectName = 'brt_abno_descrip_summary_update', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[brt_abno_descrip_summary_update]
(
	@SiteId INT
)
AS
	SET NOCOUNT ON

	DECLARE 
		@summary VARCHAR(8000),
		@tmpsummary VARCHAR(2000),
		@none					BIT,
		@Normal					BIT,
		@Carinal				TINYINT,
		@Vocal					TINYINT,
		@Compression			BIT,
		@CompressionGeneral		BIT,
		@CompressionFromLeft	BIT,
		@CompressionFromRight	BIT,
		@CompressionFromAnterior	BIT,
		@CompressionFromPosterior	BIT,
		@Stenosis				TINYINT,
		@Obstruction			TINYINT,
		@Mucosal				BIT,
		@MucosalOedema			BIT,
		@MucosalErythema		BIT,
		@MucosalPits			BIT,
		@MucosalAnthracosis		BIT,
		@MucosalInfiltration	BIT,
		@MucosalIrregularity	TINYINT,
		@ExcessiveSecretions	TINYINT,
		@Bleeding				TINYINT

	DECLARE @tblsummary TABLE (summary VARCHAR(500))

	SELECT 
		@Normal = Normal,
		@Carinal = Carinal,
		@Vocal = Vocal,
		@Compression = [Compression],
		@CompressionGeneral = CompressionGeneral,
		@CompressionFromLeft = CompressionFromLeft,
		@CompressionFromRight = CompressionFromRight,
		@CompressionFromAnterior = CompressionFromAnterior,
		@CompressionFromPosterior = CompressionFromPosterior,
		@Stenosis = Stenosis,
		@Obstruction = Obstruction,
		@Mucosal = Mucosal,
		@MucosalOedema = MucosalOedema,
		@MucosalErythema = MucosalErythema,
		@MucosalPits = MucosalPits,
		@MucosalAnthracosis = MucosalAnthracosis,
		@MucosalInfiltration = MucosalInfiltration,
		@MucosalIrregularity = MucosalIrregularity,
		@ExcessiveSecretions = ExcessiveSecretions,
		@Bleeding = Bleeding
	FROM 
		ERS_BRTAbnoDescriptions p
	WHERE
		SiteId = @SiteId

	SET @summary = '<br /> '
	
	IF ISNULL(@Bleeding,0) > 0 
	BEGIN
		SET @tmpSummary = 'Bleeding: '
		IF @Bleeding = 1
			SET @tmpSummary = @tmpSummary + ' fresh'
		IF @Bleeding = 2
			SET @tmpSummary = @tmpSummary + ' old'

		SET @Summary = @Summary + @tmpSummary + '.<br /> '
	END

	IF ISNULL(@Carinal,0) > 0 
	BEGIN
		SET @tmpSummary = 'Carinal: '
		IF @Carinal = 1 
			SET @tmpSummary = @tmpSummary + ' normal'
		IF @Carinal = 2 
			SET @tmpSummary = @tmpSummary + ' widened'
		
		SET @Summary = @Summary + @tmpSummary + '.<br />'
	END

	IF @Compression	= 1 OR @CompressionFromAnterior	= 1 OR @CompressionFromLeft	= 1 OR @CompressionFromPosterior =1 OR @CompressionFromRight = 1 OR @CompressionGeneral	 = 1
	BEGIN
		SET @tmpSummary = 'Compression:'

		IF @CompressionGeneral = 1
		BEGIN
			SET @tmpsummary	= @tmpsummary + ' general,'
		END

		IF @CompressionFromAnterior = 1
		BEGIN
			SET @tmpsummary	= @tmpsummary + ' from anterior,'
		END

		IF @CompressionFromLeft = 1
		BEGIN
			SET @tmpsummary	= @tmpsummary + ' from left,'
		END

		IF @CompressionFromPosterior = 1
		BEGIN
			SET @tmpsummary	= @tmpsummary + ' from posterior,'
		END

		IF @CompressionFromRight = 1
		BEGIN
			SET @tmpsummary	= @tmpsummary + ' from right,'
		END

		--replace last , with and
		--SET @tmpsummary = STUFF(@tmpSummary, charindex(',', REVERSE(@tmpSummary),1),1,'and')
		SET @tmpSummary = REVERSE(STUFF(REVERSE(@tmpSummary),1,1,''))
		SET @Summary = @Summary + @tmpSummary + '.<br />'
	END

	IF ISNULL(@ExcessiveSecretions,0) > 0 
	BEGIN
		SET @tmpSummary = 'Excessive secretions: '
		IF @ExcessiveSecretions = 1
			SET @tmpSummary = @tmpSummary + ' Purulent'
		IF @ExcessiveSecretions = 2
			SET @tmpSummary = @tmpSummary + ' Non-purulent'

		SET @Summary = @Summary + @tmpSummary + '.<br /> '
	END

	IF @Mucosal = 1 OR @MucosalOedema = 1 OR @MucosalErythema = 1 OR @MucosalPits = 1 OR @MucosalAnthracosis = 1 OR @MucosalInfiltration =1 OR @MucosalIrregularity = 1
	BEGIN
		SET @tmpSummary = 'Mucosal: '
		IF @MucosalOedema = 1 
		BEGIN
			SET @tmpSummary = @tmpSummary + ' oedema,'
		END

		IF @MucosalErythema = 1 
		BEGIN
			SET @tmpSummary = @tmpSummary + ' erythema,'
		END		
		IF @MucosalPits = 1 
		BEGIN
			SET @tmpSummary = @tmpSummary + ' pits,'
		END
		
		IF @MucosalAnthracosis = 1 
		BEGIN
			SET @tmpSummary = @tmpSummary + ' anthracosis,'
		END
		
		IF @MucosalInfiltration = 1 
		BEGIN
			SET @tmpSummary = @tmpSummary + ' infiltration,'
		END


		SET @tmpSummary = REVERSE(STUFF(REVERSE(@tmpSummary),1,1,''))
		SET @Summary = @Summary + @tmpSummary + '.<br /> '
	END
	
	IF ISNULL(@MucosalIrregularity,0) > 0 
	BEGIN
		SET @tmpSummary = 'Mucosal irregularity: '
		IF @MucosalIrregularity = 1
			SET @tmpSummary = @tmpSummary + ' Unknown'
		IF @MucosalIrregularity = 2
			SET @tmpSummary = @tmpSummary + ' Possible tumour'
		IF @MucosalIrregularity = 3
			SET @tmpSummary = @tmpSummary + ' Definite tumour'

		SET @Summary = @Summary + @tmpSummary + '.<br /> '
	END

	IF ISNULL(@Obstruction,0) > 0 
		BEGIN
		SET @tmpSummary = 'Obstruction: '
		IF @Obstruction = 1
			SET @tmpSummary = @tmpSummary + ' Partial'
		IF @Obstruction = 2
			SET @tmpSummary = @tmpSummary + ' Complete'
		IF @Obstruction = 3
			SET @tmpSummary = @tmpSummary + ' intrinsic'   -- Added by Ferdowsi , TFS 4325
		IF @Obstruction = 4
			SET @tmpSummary = @tmpSummary + ' extrinsic'
		IF @Obstruction = 5
			SET @tmpSummary = @tmpSummary + ' mixed'  -- Added by Ferdowsi , TFS 4325

		SET @Summary = @Summary + @tmpSummary + '.<br /> '
	END

	IF ISNULL(@Stenosis,0) > 0 
	BEGIN
		SET @tmpSummary = 'Stenosis: '
		IF @Stenosis = 1
			SET @tmpSummary = @tmpSummary + ' Partial'
		IF @Stenosis = 2
			SET @tmpSummary = @tmpSummary + ' Complete'

		SET @Summary = @Summary + @tmpSummary + '.<br /> '
	END

	IF ISNULL(@Vocal,0) > 0 
	BEGIN
		SET @tmpSummary = 'Vocal cord paralysis: '
		IF @Vocal = 1
			SET @tmpSummary = @tmpSummary + ' Partial'
		IF @Vocal = 2
			SET @tmpSummary = @tmpSummary + ' Complete'

		SET @Summary = @Summary + @tmpSummary + '.<br /> '
	END

	EXEC sites_summary_update @SiteId



	-- Finally update the summary in abnormalities table
	UPDATE ERS_BRTAbnoDescriptions	
	SET Summary = @Summary--REVERSE(STUFF(REVERSE(@Summary),1,1,''))   TFS#	4387
	WHERE SiteId = @siteId 
GO

 ------------------------------------------------------------------------------------------------------------------------
-- END OF TFS# 3124
--  
------------------------------------------------------------------------------------------------------------------------


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ferdowsi 7/9/2024
-- TFS#	 4048
-- Description of change
--    Add Sleep Apnoea to co-morbities
 
------------------------------------------------------------------------------------------------------------------------
GO  
IF NOT EXISTS (SELECT 1 from ERS_Comorbidity where Description = 'Sleep Apnoea')
BEGIN  
    INSERT INTO ERS_Comorbidity (Description,NEDTerm,ListOrderBy,ParentId,AdditionalInfo,Suppressed,WhoCreatedId,
	WhenCreated,WhoUpdatedId,WhenUpdated) VAlUES ('Sleep Apnoea','',NULL,NULL,0,0,NULL,GETDATE(),NULL,GETDATE())

	INSERT INTO ERS_ComorbidityProcedureTypes (ComorbidityId, ProcedureTypeId)
	(SELECT Scope_Identity(),ProcedureTypeId from ERS_ComorbidityProcedureTypes group by ProcedureTypeId)

END;
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#  	 4048
--  
------------------------------------------------------------------------------------------------------------------------


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ferdowsi 7/9/2024
-- TFS#	 4273
-- Description of change
-- Increased column size
--------------------------------------------------------------------------------------------------------------------------
GO
IF EXISTS (
	SELECT 1
	FROM INFORMATION_SCHEMA.COLUMNS
	WHERE TABLE_NAME = 'ERS_UpperGIRx'
	AND COLUMN_NAME = 'MedicationText'
)
BEGIN 
 ALTER TABLE ERS_UpperGIRx ALTER COLUMN MedicationText nvarchar(MAX)
 ALTER TABLE ERS_UpperGIRx ALTER COLUMN Summary nvarchar(MAX)

 ALTER TABLE [ERSAudit].[ERS_UpperGIRx_Audit]  ALTER COLUMN MedicationText nvarchar(MAX)
 ALTER TABLE [ERSAudit].[ERS_UpperGIRx_Audit]  ALTER COLUMN Summary nvarchar(MAX)
END


IF EXISTS (
	SELECT 1
	FROM INFORMATION_SCHEMA.COLUMNS
	WHERE TABLE_NAME = 'ERS_ProceduresReporting'
	AND COLUMN_NAME = 'PP_Rx'
)
BEGIN 
 ALTER TABLE ERS_ProceduresReporting  ALTER COLUMN PP_Rx nvarchar(MAX)
END
GO

EXEC dbo.DropIfExist 
    @ObjectName = 'ogd_rx_save', 
    @ObjectTypePrefix = 'S' 
GO
CREATE PROCEDURE [dbo].[ogd_rx_save]
(
	@ProcedureId INT,
    @ContMedication BIT,
    @ContMedicationByGP BIT,
    @ContPrescribeMedication BIT,
    @SuggestPrescribe BIT,
    @MedicationText NVARCHAR(Max),
	@IsUserModified BIT,
	@LoggedInUserId INT,
	@setComplete TINYINT

)
AS

SET NOCOUNT ON

BEGIN TRANSACTION

BEGIN TRY
			
	IF NOT EXISTS (SELECT 1 FROM ERS_UpperGIRx WHERE ProcedureId = @ProcedureId)
	BEGIN
		INSERT INTO ERS_UpperGIRx (
			ProcedureId,
			ContMedication,
			ContMedicationByGP,
			ContPrescribeMedication,
			SuggestPrescribe,
			MedicationText,
			Summary,
			WhoCreatedId,
			WhenCreated,
			IsUserModified)
		VALUES (
			@ProcedureId,
			@ContMedication,
			@ContMedicationByGP,
			@ContPrescribeMedication,
			@SuggestPrescribe,
			@MedicationText,
			@MedicationText,
			@LoggedInUserId,
			GETDATE(),
			@IsUserModified)

	END

	ELSE IF (@ContMedication=0 AND @ContMedicationByGP=0 AND @ContPrescribeMedication=0 AND @SuggestPrescribe=0)
	BEGIN
		IF @IsUserModified = 0 OR @IsUserModified IS NULL
			BEGIN
				SELECT @IsUserModified = ISNULL(IsUserModified, 0) FROM ERS_UpperGIRx WHERE ProcedureId = @ProcedureId
			END
		if @IsUserModified = 0
			BEGIN
				DELETE FROM ERS_UpperGIRx 
				WHERE ProcedureId = @ProcedureId 

				UPDATE ERS_ProceduresReporting
				SET PP_Rx = NULL
				WHERE ProcedureId = @ProcedureId
			END
		 Else
			Begin
				UPDATE 
				ERS_UpperGIRx
				SET 
					ContMedication = @ContMedication
					,ContMedicationByGP = @ContMedicationByGP
					,ContPrescribeMedication = @ContPrescribeMedication
					,SuggestPrescribe = @SuggestPrescribe
					,MedicationText = @MedicationText
					,Summary = @MedicationText
					,WhoUpdatedId = @LoggedInUserId
					,WhenUpdated = GETDATE()
					,IsUserModified = @IsUserModified
				WHERE 
					ProcedureId = @ProcedureId
			 END 
	END

	ELSE
	BEGIN
		IF @IsUserModified = 0 OR @IsUserModified IS NULL
			BEGIN
				SELECT @IsUserModified = ISNULL(IsUserModified, 0) FROM ERS_UpperGIRx WHERE ProcedureId = @ProcedureId
			END
		UPDATE 
			ERS_UpperGIRx
		SET 
			ContMedication = @ContMedication
			,ContMedicationByGP = @ContMedicationByGP
			,ContPrescribeMedication = @ContPrescribeMedication
			,SuggestPrescribe = @SuggestPrescribe
			,MedicationText = @MedicationText
			,Summary = @MedicationText
			,WhoUpdatedId = @LoggedInUserId
			,WhenUpdated = GETDATE()
			,IsUserModified = @IsUserModified
		WHERE 
			ProcedureId = @ProcedureId
	END

	--check for anti-coag vs damaging drug vs RX result and set complete if conditions met
	DECLARE @AntiCoagDrugs BIT = (SELECT AntiCoagDrugs FROM ERS_Procedures WHERE ProcedureId = @ProcedureId)
	DECLARE  @SectionId int = (SELECT UISectionId FROM UI_Sections WHERE SectionName = 'Anti-coag drugs')
	    
	IF @AntiCoagDrugs = 1 AND 
	    	((SELECT count(*) FROM ERS_ProcedureDamagingDrugs WHERE ProcedureId = @ProcedureId AND DamagingDrugId IN (SELECT UniqueId FROM ERS_PotentialDamagingDrugs WHERE AntiCoag = 1)) > 0 
	    AND (SELECT count(*) FROM ERS_UpperGIRx WHERE ProcedureId = @ProcedureId AND Summary <> '') > 0)
	BEGIN
	    exec UI_update_procedure_summary @ProcedureId, 'RX', 'RX', 1
	END
	ELSE IF @AntiCoagDrugs = 1 AND 
	    	((SELECT count(*) FROM ERS_ProcedureDamagingDrugs WHERE ProcedureId = @ProcedureId AND DamagingDrugId IN (SELECT UniqueId FROM ERS_PotentialDamagingDrugs WHERE AntiCoag = 1)) = 0 
	    OR (SELECT count(*) FROM ERS_UpperGIRx WHERE ProcedureId = @ProcedureId AND Summary <> '') =0)
	BEGIN
	    exec UI_update_procedure_summary @ProcedureId, 'RX', 'RX', 0
	END
	ELSE IF @AntiCoagDrugs = 0
	BEGIN
		exec UI_update_procedure_summary @ProcedureId, 'RX', 'RX', 1
	END

	IF @setComplete = 1 and NOT EXISTS(SELECT 1 FROM ERS_RecordCount WHERE ProcedureId = @ProcedureId AND [Identifier] = 'Rx')
	BEGIN
		INSERT INTO ERS_RecordCount (
			[ProcedureId],
			[SiteId],
			[Identifier],
			[RecordCount]
		)
		VALUES (
			@ProcedureId,
			NULL,
			'Rx',
			1)
	END

END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;



GO


  ------------------------------------------------------------------------------------------------------------------------
-- END OF TFS# 	 4273
--  
------------------------------------------------------------------------------------------------------------------------


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ferdowsi 7/9/2024
-- TFS#	 4243
-- Description of change
-- Count added
 
---------------------------------------------------------------------------------------------------------------

Go

EXEC dbo.DropIfExist 
    @ObjectName = 'report_JAGCOL', 
    @ObjectTypePrefix = 'S' 
GO
CREATE PROCEDURE [dbo].[report_JAGCOL] 
	@UserID INT
AS
/* Update History		:		08 Dec 2021		MH added filter out to elimiate Cancelled (DNA ) Procedures-
				:       17/05/2024     Partha  Filter by Hospital TFS1811

*/


BEGIN
	DECLARE @ProcedureTypeId INT
	SET @ProcedureTypeId = 3

	DECLARE @FromDate as Date,
		@ToDate as Date,
		@ConsultantId as int,
			@TrustId as int,
			@OperatingHospitalList as varchar(100)



	SELECT rc.ConsultantID , con.Title + ' ' + con.Forename + ' ' + con.Surname AS Endoscopist, rc.AnonimizedID
	INTO #Consultants
	FROM ERS_ReportConsultants rc
	JOIN ERS_Users con on rc.ConsultantID = con.UserID 
	WHERE rc.UserID = @UserId

	Select	@FromDate = FromDate,
			@ToDate = ToDate,
			@TrustId = TrustId,
			@OperatingHospitalList=OperatingHospitalList
	FROM	ERS_ReportFilter
	where	UserID = @UserId

	SELECT  con.AnonimizedID AS AnonimizedID
				, con.Endoscopist as Endoscopist1
				, con.ConsultantId AS ReportID
				, con.Endoscopist AS Consultant
				, COUNT(DISTINCT p.ProcedureId) AS NumberOfProcedures
				, COUNT(DISTINCT CASE WHEN ISNULL(ple.RectalExamPerformed, 0) = 1 THEN p.ProcedureId END) * 1.0 / NULLIF(COUNT(DISTINCT P.ProcedureId), 0) AS DigiRectalExaminationP
				, COUNT(DISTINCT CASE WHEN ISNULL(ple.RetroflectionPerformed, 0) = 1 THEN p.ProcedureId END) * 1.0 / NULLIF(COUNT(DISTINCT P.ProcedureId), 0) AS RectalRetoversionRateP
				, COUNT(DISTINCT CASE WHEN eds.NEDTerm IN ('Moderate','Severe') THEN p.ProcedureId END) * 1.0 / NULLIF(COUNT(DISTINCT P.ProcedureId), 0) AS ComfortLevelModerateSevereDiscomfort
				, COUNT(DISTINCT CASE WHEN eds.NEDTerm IN ('Moderate','Severe') THEN p.ProcedureId END) * 1.0 / NULLIF(COUNT(DISTINCT P.ProcedureId), 0) AS ComfortLevelModerateSevereDiscomfortNurse
				, (SUM(DISTINCT ple.WithdrawalMins)/COUNT(DISTINCT p.ProcedureId)) AS MeanWithdrawalTime
				, ISNULL(COUNT(DISTINCT CASE WHEN e.ListOrderBy <= 90 THEN s.SiteId END) * 1.0 / NULLIF(COUNT(CASE WHEN e.ListOrderBy <= 90 THEN s.SiteId END), 0),0) AS PolypDetectionRate
				, COUNT(DISTINCT CASE WHEN e.ListOrderby <= 90 THEN p.ProcedureId END) * 1.0 / NULLIF(COUNT(DISTINCT P.ProcedureId), 0) AS UnadjustedCaecalIntubationRate
				, COUNT(DISTINCT CASE WHEN e.ListOrderby IN (60,70) THEN p.ProcedureId END)* 1.0 / NULLIF(COUNT(DISTINCT P.ProcedureId), 0) AS TerminalIlealIntubationRate
				
				,(SELECT COUNT(DISTINCT p.ProcedureId )  from [ERS_Procedures] p join [ERS_ProcedureIndications] pi ON pi.ProcedureId =  p.ProcedureId   -- added by Ferdowsi , TFS 4243
                 join ERS_Sites site ON p.ProcedureId = site.ProcedureId Join ERS_UpperGISpecimens s ON s.SiteId = site.SiteId  
                 JOIN ERS_Indications indi ON indi.UniqueId = pi.IndicationId WHERE( indi.Description like '%Looser or more frequent stool%') AND   s.Biopsy= 1  AND p.Endoscopist1 = con.ConsultantId ) AS DiagnosticRectalBiopsiesForUnexplainedDiarrohea -- added by Ferdowsi , TFS 4243

				, COUNT(DISTINCT CASE WHEN tl.Region NOT IN ('Rectum', 'Caecum') AND tl.TattooedId IN (2,3) THEN tl.RowId END)  * 1.0 / NULLIF(COUNT(DISTINCT tl.RowId),0) AS TattooingOfAllLesionsP
				, SUM(CASE WHEN pd.Retreived <> 0 AND pd.Successful <> 0 THEN convert(int,pd.Successful) END) * 1.0 / NULLIF(COUNT(pd.PolypDetailId),0) AS PolypRetrievalRateP
				, COUNT(CASE WHEN eds.NEDTerm IN ('Moderate','Severe') THEN '' END) * 1.0 / NULLIF(COUNT(DISTINCT P.ProcedureId), 0) AS ComfortLevelModerateSevereDiscomfort
				, COUNT(CASE WHEN eds.NEDTerm IN ('Moderate','Severe') THEN '' END) * 1.0 / NULLIF(COUNT(DISTINCT P.ProcedureId), 0) AS ComfortLevelModerateSevereDiscomfortNurse
				, dbo.CalcAnalgesiaLT70_New(con.ConsultantId, 'Midazolam', 0.5, 10.0, 1, min(@FromDate), max(@ToDate), @OperatingHospitalList) AS MedianSedationRateLT70Years_Midazolam
				, dbo.CalcAnalgesiaLT70_New(con.ConsultantId, 'Pethidine', 12.5, 200.0, 1, min(@FromDate), max(@ToDate), @OperatingHospitalList) AS MedianAnalgesiaRateLT70Years_Pethidine
				, dbo.CalcAnalgesiaLT70_New(con.ConsultantId, 'Fentanyl', 12.5, 200.0, 1, min(@FromDate), max(@ToDate), @OperatingHospitalList) AS MedianAnalgesiaRateLT70Years_Fentanyl
				, dbo.CalcAnalgesiaGT70_New(con.ConsultantId, 'Midazolam', 0.5, 10.0, 1, min(@FromDate), max(@ToDate), @OperatingHospitalList) AS MedianSedationRateGE70Years_Midazolam
				, dbo.CalcAnalgesiaGT70_New(con.ConsultantId, 'Pethidine', 12.5, 200.0, 1, min(@FromDate), max(@ToDate), @OperatingHospitalList) AS MedianAnalgesiaRateGE70Years_Pethidine
				, dbo.CalcAnalgesiaGT70_New(con.ConsultantId, 'Fentanyl', 12.5, 200.0, 1, min(@FromDate), max(@ToDate), @OperatingHospitalList) AS MedianAnalgesiaRateGE70Years_Fentanyl
				/*NO SEDATION*/
				, COUNT(distinct prof.ProcedureId) * 1.0 / NULLIF(COUNT( distinct p.procedureId), 0) as PropofolP
							, COUNT(DISTINCT CASE WHEN dru.Pethidine is null and dru.midazolam is null and dru.Fentanyl is null and dru.GeneralAnaesthetic is null THEN P.ProcedureId END) 
				* 1.0 / NULLIF(COUNT(DISTINCT CASE WHEN dru.GeneralAnaesthetic is null then P.ProcedureId END), 0) AS NoSedationP		
				--/* GTRecommededDose */
				, COUNT(DISTINCT CASE 
									WHEN (
											(P.Endoscopist1 = con.ConsultantId OR P.Endoscopist2 = con.ConsultantId) AND 
											(
												((CONVERT(int,CONVERT(char(8),GETDATE(),112))-CONVERT(char(8),pat.DateOfBirth,112))/10000 < 70 AND (
													(	(dru.Pethidine > 50) OR
														(dru.midazolam > 5) OR
														(dru.Fentanyl > 100))
													)
												) OR 
												(	
													((CONVERT(int,CONVERT(char(8),GETDATE(),112))-CONVERT(char(8),pat.DateOfBirth,112))/10000 >= 70 AND (
														(dru.Pethidine > 25) OR
														(dru.midazolam > 2.5) OR
														(dru.Fentanyl > 50))
													)	
												)
											)
										) THEN P.ProcedureId
								END) * 1.0 / NULLIF(COUNT(DISTINCT P.ProcedureId), 0) AS GTRecommededDose
	FROM #Consultants con
	JOIN ERS_Procedures p ON (con.ConsultantId = p.Endoscopist1 or (con.ConsultantId = p.Endoscopist2 and P.Endo2Role in (2, 3)))
	JOIN ERS_Patients pat on p.PatientId = pat.PatientId
	LEFT JOIN ERS_UpperGIPremedication prof on p.ProcedureId = prof.ProcedureId AND prof.DrugName = 'propofol' AND prof.Dose > 0
	LEFT JOIN ERS_UpperGIPremedication midazolam on p.ProcedureId = midazolam.ProcedureId AND midazolam.DrugName = 'midazolam'
	LEFT JOIN fw_ERS_Drugs as dru on P.ProcedureID = dru.ProcId
	LEFT JOIN ERS_ProcedureLowerExtent ple ON ple.ProcedureId = p.ProcedureId AND ple.EndoscopistId = CASE WHEN p.Endoscopist2 = con.ConsultantId AND p.Endo2Role IN (2,3) THEN con.ConsultantId ELSE ple.EndoscopistId END
	LEFT JOIN ERS_Extent e ON e.UniqueId = ple.ExtentId
	LEFT JOIN ERS_ExtentProcedureTypes ept ON ept.ExtentId = e.UniqueId AND ept.ProcedureTypeId = 3
	LEFT JOIN dbo.ERS_ProcedureDiscomfortScore epds ON p.ProcedureId = epds.ProcedureId
	LEFT JOIN dbo.ERS_DiscomfortScores eds ON epds.DiscomfortScoreId = eds.UniqueId
	LEFT JOIN ERS_ProcedureIndications pri ON pri.ProcedureId = p.ProcedureId
	LEFT JOIN ERS_Indications i ON i.UniqueId = pri.IndicationId
	LEFT JOIN ERS_Sites s ON s.ProcedureId = p.ProcedureId
	LEFT JOIN (SELECT S.ProcedureId, PolypDetailId, Retreived, Successful, Size, TattooedId, r.Region, s.SiteId
				FROM ERS_CommonAbnoPolypDetails pd 
					INNER JOIN ERS_Sites s ON pd.SiteId = s.SiteId 
					INNER JOIN ERS_PolypTypes pt ON pt.UniqueId = pd.PolypTypeId 
					INNER JOIN ERS_Regions r ON r.RegionId = s.RegionId
				WHERE LOWER(pt.[Description]) IN ('sessile','pedunculated','pseudo')) pd ON pd.ProcedureId = p.ProcedureId
	LEFT JOIN dbo.fw_TattooedLesions tl ON tl.SiteId = s.SiteId
	WHERE p.ProcedureType = @ProcedureTypeId
		and p.ProcedureCompleted = 1
		and p.IsActive = 1
		and p.CreatedOn >= @FromDate AND p.CreatedOn <= @ToDate
		--MH added on 08 Dec 2021
		and IsNull(p.DNA,0) = 0
		AND P.OperatingHospitalID IN (SELECT * FROM dbo.splitString(@OperatingHospitalList,',') )--Partha , 17/05/2024 TFS1811
		--and pat.PatientId in (Select patientId from ERS_PatientTrusts where TrustId = @TrustId)
	GROUP BY con.Endoscopist, con.ConsultantId, con.AnonimizedID--, p.ProcedureId
	ORDER BY con.AnonimizedID 
END

GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS# 	 4243
--  
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ferdowsi 7/9/2024
-- TFS#	2264
-- Description of change
-- Removed patient filter , Added DNA filter
 
------------------------------------------------------------------------------------------------------------------------
GO

EXEC dbo.DropIfExist 
    @ObjectName = 'auditSummaryByQuarter', 
    @ObjectTypePrefix = 'S' 
GO

CREATE Procedure [dbo].[auditSummaryByQuarter]
	@UserId int
AS
BEGIN

	DECLARE @FromDate as Date,
			@ToDate as Date,
			@ConsultantId as int,
			@columns NVARCHAR(MAX) = '', 
			@sql     NVARCHAR(MAX) = '',
			@TrustId as int

	SELECT rc.ConsultantID , con.Title + ' ' + con.Forename + ' ' + con.Surname AS Endoscopist, rc.AnonimizedID
	INTO #Consultants
	FROM ERS_ReportConsultants rc
	JOIN ERS_Users con on rc.ConsultantID = con.UserID 
	WHERE rc.UserID = @UserId

	Select	@FromDate = FromDate,
			@ToDate = ToDate,
			@TrustId = TrustId
	FROM	ERS_ReportFilter
	where	UserID = @UserId

	Create table #ByQuarterReport (ProcedureType varchar(20), quarterDate datetime, ProcedureCount int)

	insert into #ByQuarterReport 
	select pt.ProcedureType, DATEADD(quarter,DATEDIFF(quarter,0,p.CreatedOn),0) , COUNT(1)
	from ERS_Procedures p
	join	ERS_Patients pat on p.PatientId = pat.PatientId
	join #Consultants con ON con.ConsultantId = p.Endoscopist1
	join ERS_ProcedureTypes pt on pt.ProcedureTypeId = p.ProcedureType 
	where p.IsActive = 1 and p.ProcedureCompleted = 1
	and pat.PatientId in (Select patientId from ERS_PatientTrusts where TrustId = @TrustId)
	and p.CreatedOn >= @FromDate AND p.CreatedOn <= @ToDate  AND IsNull(DNA,0) = 0
	group by pt.ProcedureType, DATEADD(quarter,DATEDIFF(quarter,0,CreatedOn),0)

	SELECT 
		@columns+=QUOTENAME(ProcedureType) + ','
	FROM 
		ERS_ProcedureTypes
	where ProcedureType in (Select distinct ProcedureType from #ByQuarterReport)
	ORDER BY 
		ProcedureType;

	-- remove the last comma
	if isnull(@columns, '') != ''
	BEGIN
		SET @columns = LEFT(@columns, LEN(@columns) - 1);

		set @sql = '
			Select * from 
			(Select ProcedureType, 
				convert(varchar, DATEPART(year,quarterDate)) + '' Q'' +
				convert(varchar, DATEPART(quarter,quarterDate)) as Quarter,
				   ProcedureCount
				   from #ByQuarterReport
			union 
				select ProcedureType, convert(varchar, DATEPART(year,quarterDate)) + '' Total'', SUM(ProcedureCount)
			from #ByQuarterReport
			group by ProcedureType, convert(varchar, DATEPART(year,quarterDate)) + '' Total''
			union 
				select ProcedureType, ''Total'', SUM(ProcedureCount)
			from #ByQuarterReport
			group by ProcedureType
			) q
			PIVOT (sum(ProcedureCount)
				for ProcedureType IN (' + @columns + ')
				)
				as pt'

		EXECUTE sp_executesql @sql;

	END	
	ELSE
		Select 'No data to display'

	drop table #ByQuarterReport
	drop table #Consultants
END

GO


EXEC dbo.DropIfExist 
    @ObjectName = 'report_procedure_yearly', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[report_procedure_yearly] (
        @operatingHospitalsIds varchar(500),
         @TrustId  INT 
)
AS
/*
	--			Update History		:		07 Sept 2022 MH copied from SE1 - Eliminate Cancelled Procedures from begin calculated
*/
BEGIN
	Create Table #Years(
		   [ProcedureYear] varchar(10),
		   [Count] int
	)
	Create Table #YearsResult(
		   [Type] varchar(50),
		   [ProcedureYear] varchar(10),
		   [Count] int
	)
	DECLARE @includeUGI BIT = 0
	DECLARE @sql NVARCHAR(MAX) = ''

	IF (EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = 'dbo' AND TABLE_NAME = 'Colon Procedure'))
		SET @includeUGI = 1

	SET @sql = '
	INSERT INTO #Years
	SELECT DISTINCT(ProcYear.ProcedureYear), 0 as [Count] FROM ('

	SET @sql = @sql + ' SELECT  year(CreatedOn) as ProcedureYear  FROM ERS_Procedures where IsNull(DNA,0) = 0 And ProcedureCompleted = 1 and year(CreatedOn) IS NOT NULL AND
	CreatedOn > DATEADD(year, -10, GetDate()) AND IsActive=1 GROUP BY year(CreatedOn)'
	SET @sql = @sql + ' ) as ProcYear'

	EXEC sp_executesql @sql 
	-- join with user table , by Ferdowsi #TFS- 2264
	SET @sql = '
	INSERT INTO #YearsResult
	SELECT [Type],[ProcedureYear], sum([Count]) as [Count] FROM ('

	

	SET @sql = @sql + ' SELECT CASE ProcedureType WHEN 1 THEN ''UpperGI'' WHEN 3 THEN ''Colon'' WHEN 2 THEN ''ERCP'' WHEN 6 THEN ''EUS'' WHEN 7 THEN ''EUS'' ELSE ''Others'' END AS [Type],
	year(CreatedOn) as ProcedureYear, Count(ProcedureId) as [Count] FROM ERS_Procedures
	Join ERS_Users u on Endoscopist1 = u.UserID
	where IsNull(DNA,0) = 0 And ProcedureCompleted = 1 and year(CreatedOn) IS NOT NULL 
	AND (u.IsListConsultant = 1 OR IsEndoscopist1= 1 OR IsEndoscopist2 = 1)
	and PatientId in (Select patientId from ERS_PatientTrusts where TrustId = @TrustId)
	AND  CreatedOn > DATEADD(year, -10, GetDate()) AND IsActive=1  and OperatingHospitalId in (' + @operatingHospitalsIds + ')  GROUP BY year(CreatedOn),(CASE ProcedureType WHEN 1 THEN ''UpperGI'' WHEN 3 THEN ''Colon'' WHEN 2 THEN ''ERCP''
	WHEN 6 THEN ''EUS'' WHEN 7 THEN ''EUS'' ELSE ''Others'' END)'
	SET @sql = @sql + ') as S GROUP BY [Type],[ProcedureYear]'
	EXEC sp_executesql @sql , N'@TrustId INT', @TrustId;

	ALTER TABLE #YearsResult ADD [cOrder] int
	UPDATE #YearsResult SET [cOrder] = (CASE [Type] WHEN 'UpperGI' THEN 1 WHEN 'Colon' THEN 2 WHEN 'ERCP' THEN 3 WHEN 'EUS' THEN 4 WHEN 'Others' THEN 10 ELSE 5 END)
	UPDATE #YearsResult SET [Count] = NULL WHERE [Count]=0

	SELECT * from #YearsResult ORDER BY [ProcedureYear],[cOrder] 

	If(OBJECT_ID('tempdb..#Years') Is Not Null)
	Begin
		Drop Table #Years
	End
	If(OBJECT_ID('tempdb..#YearsResult') Is Not Null)
	Begin
		Drop Table #YearsResult
	End
END


GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	: Raihanul	
-- TFS#	2264
-- Description of change
-- Fixed Dashboard Graphs - figures not correct
------------------------------------------------------------------------------------------------------------------------

EXEC dbo.DropIfExist 
    @ObjectName = 'report_procedure_monthly', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[report_procedure_monthly] (@ProcedureYear varchar(50),@operatingHospitalsIds varchar(200),  @TrustId INT)
AS
/*
	--			Update History		:		07 Sept 2022 MH copied from SE1 - Eliminate Cancelled Procedures from begin calculated
*/
BEGIN
CREATE TABLE #Months ([Month] varchar(10), [Count] int);
CREATE TABLE #Val ([Type] varchar(20), [Month] varchar(10), [Count] int, [cOrder] int);
DECLARE @includeUGI BIT = 0;
DECLARE @sql NVARCHAR(MAX) = '';

IF (EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = 'dbo' AND TABLE_NAME = 'Colon Procedure'))
    SET @includeUGI = 1;

-- Insert initial month values
INSERT INTO #Months([Month], [Count]) VALUES 
    ('Jan', 0), ('Feb', 0), ('Mar', 0), ('Apr', 0),
    ('May', 0), ('Jun', 0), ('Jul', 0), ('Aug', 0),
    ('Sep', 0), ('Oct', 0), ('Nov', 0), ('Dec', 0);

-- Prepare the dynamic SQL to get procedure counts
SET @sql = '
    INSERT INTO #Val([Type], [Month], [Count])
    SELECT [Type], [Month], ISNULL(SUM([Count]), 0) AS [Count]
    FROM (
        SELECT 
            CASE p.ProcedureType 
                WHEN 1 THEN ''UpperGI'' 
                WHEN 3 THEN ''Colon'' 
                WHEN 2 THEN ''ERCP'' 
                WHEN 6 THEN ''EUS'' 
                WHEN 7 THEN ''Others'' 
                ELSE ''Others'' 
            END AS [Type], 
            CONVERT(varchar(3), DATENAME(month, p.[CreatedOn])) AS [Month], 
            COUNT(p.ProcedureId) AS [Count]
        FROM 
            ERS_Procedures p
        JOIN 
            ERS_Users u ON Endoscopist1 = u.UserID
        WHERE 
            YEAR(p.[CreatedOn]) = ' + CONVERT(VARCHAR, @ProcedureYear) + ' 
            AND IsActive = 1 
            AND operatingHospitalId IN (' + @operatingHospitalsIds + ') 
            AND ISNULL(DNA, 0) = 0 
            AND p.ProcedureCompleted = 1
            AND (u.IsListConsultant = 1 OR IsEndoscopist1 = 1 OR IsEndoscopist2 = 1)
            AND PatientId IN (SELECT patientId FROM ERS_PatientTrusts WHERE TrustId = @TrustId)
        GROUP BY 
            DATENAME(month, p.[CreatedOn]), 
            p.ProcedureType
    ) AS rp 
    GROUP BY rp.[Type], rp.[Month];';

EXEC sp_executesql @sql, N'@TrustId INT', @TrustId;

-- Add cOrder and set it according to Type
UPDATE #Val 
SET [cOrder] = (CASE 
    WHEN [Type] = 'UpperGI' THEN 1 
    WHEN [Type] = 'Colon' THEN 2 
    WHEN [Type] = 'ERCP' THEN 3 
    WHEN [Type] = 'EUS' THEN 4 
    WHEN [Type] = 'Others' THEN 10 
    ELSE 5 
END);

-- Ensure all types for all months are included with cOrder as 0 for missing entries
INSERT INTO #Val ([Type], [Month], [Count], [cOrder])
SELECT 
    at.[Type], am.[Month], 0, 
    (CASE 
        WHEN at.[Type] = 'UpperGI' THEN 1 
        WHEN at.[Type] = 'Colon' THEN 2 
        WHEN at.[Type] = 'ERCP' THEN 3 
        WHEN at.[Type] = 'EUS' THEN 4 
        WHEN at.[Type] = 'Others' THEN 10 
        ELSE 5 
    END)  -- Set cOrder based on Type
FROM 
    (VALUES ('UpperGI'), ('Colon'), ('ERCP'), ('EUS'), ('Others')) AS at([Type])
CROSS JOIN 
    (SELECT [Month] FROM #Months) AS am
WHERE NOT EXISTS (
    SELECT 1 
    FROM #Val v 
    WHERE v.[Type] = at.[Type] AND v.[Month] = am.[Month]
);

-- Final select from #Val, maintaining order
SELECT 
    [Type], 
    [Month], 
    ISNULL([Count], 0) AS [Count],
    ISNULL([cOrder], 0) AS [cOrder]  -- Ensure cOrder is 0 if not available
FROM 
    #Val 
ORDER BY 
    [cOrder],  -- First order by cOrder
    DATEPART(mm, CAST([Month] + ' 1900' AS datetime));  -- Then by Month

DROP TABLE #Val;

IF (OBJECT_ID('tempdb..#Months') IS NOT NULL)
BEGIN
    DROP TABLE #Months;
END;


END;


GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS# 	2264
--  
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ferdowsi 7/9/2024
-- TFS#	3753
-- Description of change
--  add cysto 
 
------------------------------------------------------------------------------------------------------------------------
GO
    UPDATE ERS_ProcedureTypes SET SchedulerDiagnostic= 1 , SchedulerTherapeutic= 1 , Suppressed= 0 WHERE  ProcedureType = 'Cystoscopy'
 	 
GO
 
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS# 	3753
--  
------------------------------------------------------------------------------------------------------------------------


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ferdowsi 7/9/2024
-- TFS#	 4199
-- Description of change
--   INSERT VALUE
--------------------------------------------------------------------------------------------------------------------------
GO
  IF NOT EXISTS (SELECT 1 from ERS_PagesByRole where PageId =  (SELECT PageId FROM ERS_Pages WHERE PageName = 'Edit Procedure') )
  BEGIN   
      INSERT INTO ERS_PagesByRole ([RoleId], [PageId], [AccessLevel], [WhoUpdatedId], [WhoCreatedId], [WhenCreated], [WhenUpdated])
      SELECT r.RoleId, p.PageId, 9, NULL, NULL, NULL, NULL
      FROM ERS_Roles r
      JOIN ERS_Pages p ON p.PageName = 'Edit Procedure'
      WHERE r.RoleName IN ('System Administrators', 'GlobalAdmin', 'System Admin');
 END
    Update ERS_Pages set PageAlias = 'Create Procedure' where PageName = 'Create Procedure'
	Update ERS_Pages set AppPageName = 'Edit Procedure',GroupId = 8 where PageName = 'Edit Procedure'
 GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS# 	 4199
--  
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ferdowsi 7/9/2024
-- TFS#	 1897
-- Description of change
--  TrustId added
--------------------------------------------------------------------------------------------------------------------------
 GO
EXEC dbo.DropIfExist 
    @ObjectName = 'common_hospital_save', 
    @ObjectTypePrefix = 'S' 
GO
CREATE PROCEDURE [dbo].[common_hospital_save]
(
	@HospitalName varchar(100),
	@TrustId INT
)
AS

SET NOCOUNT ON

BEGIN TRANSACTION

BEGIN TRY

	IF NOT EXISTS(SELECT 1 FROM [ERS_ReferralHospitals] WHERE [HospitalName] = @HospitalName )
	BEGIN
	INSERT INTO [ERS_ReferralHospitals] ([HospitalName] , TrustId) VALUES (@HospitalName, @TrustId)
	END

END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;
GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS# 	1897
--  
------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ferdowsi 8/18/2024
-- TFS#	4210
-- Description of change
-- condition added
--------------------------------------------------------------------------------------------------------------------------
GO
EXEC dbo.DropIfExist 
    @ObjectName = 'sch_get_thereaputic_consultants', 
    @ObjectTypePrefix = 'S' 
GO
 
CREATE PROCEDURE [dbo].[sch_get_thereaputic_consultants]
(
	@TherapeuticTypeIds VARCHAR(MAX),
	@ProcedureTypeID VARCHAR(MAX)
)
AS
BEGIN
	SELECT cp.EndoscopistID
	FROM dbo.ERS_ConsultantProcedureTypes cp 
	INNER JOIN dbo.ERS_ConsultantProcedureTherapeutics cpt ON cpt.ConsultantProcedureID = cp.ConsultantProcedureId
    WHERE cpt.TherapeuticTypeID IN (SELECT Item FROM dbo.fnSplitString(@TherapeuticTypeIds, ',')) AND ProcedureTypeID IN (SELECT Item FROM dbo.fnSplitString(@ProcedureTypeID, ','))
	GROUP BY cpt.ConsultantProcedureID, cp.EndoscopistID
	ORDER BY cpt.ConsultantProcedureID
END
 GO
  ------------------------------------------------------------------------------------------------------------------------
-- END OF TFS# 	 4210
--  
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	: Siddik
-- TFS#	2232
-- Description of change: SEv2 Other Box in Miscellaneous
-- Updated by	:	Rony
-- TFS#	3513
-- Description of change: V2 Transnasal to be Procedure Title  
-------------------------------------------------------------------------------------------------------------------------

EXEC dbo.DropIfExist 
    @ObjectName = 'diagnoses_control_save', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[diagnoses_control_save]
(
       @SiteID int, 
       @DiagnosesMatrixCode varchar(50),
	   @Value varchar(50)
)
AS

SET NOCOUNT ON

BEGIN TRANSACTION

BEGIN TRY
	DECLARE @DiagCount int, @ProcedureID int,  @Region varchar(50), @ProcedureType int, @MatrixSection varchar(50),
		@SiteNo int, @XCoordinate int

	SELECT @ProcedureID =p.ProcedureID, @ProcedureType = p.ProcedureType, @SiteNo = SiteNo, @XCoordinate=XCoordinate
	FROM ers_sites s INNER JOIN ers_procedures p ON s.ProcedureId = p.ProcedureId 
	WHERE SiteId = @SiteID

	--Change the @DiagnosesMatrixCode if procedure type is 2 (ERCP) for Duodenum
	IF @ProcedureType in (2, 7) AND RIGHT(@DiagnosesMatrixCode,2) <> 'P2'
	BEGIN 
		SET @DiagnosesMatrixCode = STUFF(@DiagnosesMatrixCode, LEN(@DiagnosesMatrixCode) - 1, 2, 'P2')
	END
	
	IF @ProcedureType IN (3,4,5,9)   ---------- Colonoscopy, Sigmoidscopy, Proctoscopy ----------------------
	BEGIN
		IF @ProcedureType = 9
		BEGIN
			SET @Region=(select x.Region from [dbo].[ERS_AbnormalitiesMatrixRetrograde] x inner join ERS_Regions r on x.region = r.Region AND r.ProcedureType= x.ProcedureType inner join ers_sites s on r.RegionId = s.RegionId where s.SiteId = @siteID )
		END
		ELSE
		BEGIN
		    SET @Region=(select x.Region from [ERS_AbnormalitiesMatrixColon] x inner join ERS_Regions r on x.region = r.Region AND r.ProcedureType= x.ProcedureType inner join ers_sites s on r.RegionId = s.RegionId where s.SiteId = @siteID )
		END

		SET @MatrixSection= 'Colon'

		--ColonicPolyp (D12P3) should not be in region 'Rectum'
		--RectalPolyp (D4P3) should be in region 'Rectum'
		IF @DiagnosesMatrixCode IN ('D12P3') AND @Region in ('Rectum', 'Anal Margin')		SET @ProcedureID = NULL
		ELSE IF @DiagnosesMatrixCode IN ('D4P3') AND @Region not in ('Rectum', 'Anal Margin')		SET @ProcedureID = NULL
		ELSE IF @DiagnosesMatrixCode = 'D8P3' AND @Region in ('Rectum', 'Anal Margin')	SET @DiagnosesMatrixCode = 'D13P3' -- D8P3 for 'Malignant colonic tumour', D13P3 for Malignant rectal tumour
		ELSE IF @DiagnosesMatrixCode IN ('D6P3') 
			BEGIN
				IF @SiteNo = -77	AND @XCoordinate >= 17		SET @DiagnosesMatrixCode = 'D11P3' -- D6P3 for 'Benign colonic tumour', D11P3 for Benign rectal tumour
				ELSE IF @SiteNo > 0 AND @Region in ('Rectum', 'Anal Margin')		SET @DiagnosesMatrixCode = 'D11P3' -- D6P3 for 'Benign colonic tumour', D11P3 for Benign rectal tumour
			END
		ELSE IF @DiagnosesMatrixCode IN ('D15P3') 
			BEGIN
				IF @SiteNo = -77	AND @XCoordinate >= 17		SET @ProcedureID = NULL -- By distance, "Redundant anterior rectal mucosa" should be in region 'Rectum' and rectal is if the site is < 17 cm
				ELSE IF @SiteNo > 0 AND @Region not in ('Rectum', 'Anal Margin')		SET @ProcedureID = NULL -- Redundant anterior rectal mucosa (D15P3) should be in region 'Rectum'
			END
		ELSE IF @DiagnosesMatrixCode IN ('D80P3') 
			BEGIN
				IF @SiteNo = -77	AND @XCoordinate >= 17		SET @DiagnosesMatrixCode = 'D83P3' -- By distance, D80P3 for 'Rectal ulcer(s)', D83P3 for 'Colonic ulcer(s)'
				ELSE IF @SiteNo > 0 AND @Region = 'Terminal Ileum'	SET @DiagnosesMatrixCode = 'D100P3'   --D80P3 for 'Rectal ulcer(s)', D83P3 for 'Colonic ulcer(s)'
				ELSE IF @SiteNo > 0 AND @Region not in ('Rectum', 'Anal Margin')	SET @DiagnosesMatrixCode = 'D83P3'   --D80P3 for 'Rectal ulcer(s)', D83P3 for 'Colonic ulcer(s)'
			END	
		IF @ProcedureType = 4 AND LEFT(@DiagnosesMatrixCode,1) <> 'S'
		BEGIN
			SET @DiagnosesMatrixCode = STUFF(@DiagnosesMatrixCode, 1, 1, 'S')
		END
	END
	ELSE IF @ProcedureType IN (1, 6, 8, (SELECT ProcedureTypeId FROM ERS_ProcedureTypes where ProcedureType = 'Transnasal'))	--------------- Gastroscopy, EUS (OGD),Transnasal TFS-3513  ------------------------
	BEGIN
		SET @Region = (
			SELECT x.area
			FROM ERS_AbnormalitiesMatrixUpperGI x
			INNER JOIN ERS_Regions r ON x.region = r.Region AND x.ProcedureType = r.ProcedureType AND x.ProcedureType =  @ProcedureType
			INNER JOIN ers_sites s ON r.RegionId = s.RegionId AND SiteId = @siteid  
		)
		--SET @Region = (select x.area from ERS_AbnormalitiesMatrixUpperGI x inner join ERS_Regions r on x.region = r.Region inner join ers_sites s on r.RegionId = s.RegionId where SiteId =@siteid)
		IF @DiagnosesMatrixCode = 'D20P1' AND @Region <> 'Oesophagus'	SET @DiagnosesMatrixCode = 'D61P1'
		SET @MatrixSection= ISNULL((SELECT top(1) Section FROM [ERS_DiagnosesMatrix] WHERE ProcedureTypeID = @ProcedureType AND Code = @DiagnosesMatrixCode AND Section = @Region), @Region) --edited by siddik tfs# 2232

		--Varices (D30P1) should be in region 'Oesophagus'
		--StomachVarices (D47P1) should be in region 'Stomach'
		--TelangiectasiaAngioma (D59P1) should be in region 'Duodenum'
		IF @DiagnosesMatrixCode = 'D30P1' AND @Region <> 'Oesophagus'		SET @ProcedureID = NULL
		ELSE IF @DiagnosesMatrixCode = 'D31P1' AND @Region <> 'Oesophagus'	SET @ProcedureID = NULL
		ELSE IF @DiagnosesMatrixCode = 'D47P1' AND @Region <> 'Stomach'		SET @ProcedureID = NULL
		ELSE IF @DiagnosesMatrixCode = 'D59P1' AND @Region <> 'Duodenum'	SET @ProcedureID = NULL

		--Remove noraml procedure diagnoses entry where applicapble
		IF LOWER(@Value) IN ('true', '1')
		BEGIN
			IF EXISTS (SELECT 1 FROM ERS_Diagnoses WHERE ProcedureId = @ProcedureID AND MatrixCode = 'OverallNormal')
				DELETE FROM ERS_Diagnoses WHERE ProcedureId = @ProcedureID AND MatrixCode = 'OverallNormal'
		END			

	END
	ELSE IF @ProcedureType IN (2, 7)	------------ ERCP, EUS(HPB) --------------------------
	BEGIN
		SET @Region = (
			SELECT x.area
			FROM ERS_AbnormalitiesMatrixERCP x
			INNER JOIN ERS_Regions r ON x.region = r.Region AND x.ProcedureType = r.ProcedureType AND x.ProcedureType =  @ProcedureType
			INNER JOIN ers_sites s ON r.RegionId = s.RegionId AND SiteId = @siteid  
		)
		--SET @Region = (select x.area from ERS_AbnormalitiesMatrixERCP x inner join ERS_Regions r on x.region = r.Region inner join ers_sites s on r.RegionId = s.RegionId where SiteId =@siteid)
		SET @MatrixSection= ISNULL((SELECT top(1)  Section FROM [ERS_DiagnosesMatrix] WHERE ProcedureTypeID = @ProcedureType AND Code=@DiagnosesMatrixCode),@Region)
	END

	IF @ProcedureID IS NULL GOTO RETURN_NULL

	--Check for correct Procedure Type
	IF CHARINDEX('notentered',LOWER(@DiagnosesMatrixCode)) = 0 
	AND NOT (EXISTS (SELECT 1 
					FROM ERS_DiagnosesMatrix 
					WHERE ProcedureTypeID = @ProcedureType 
					AND Code = @DiagnosesMatrixCode) OR @DiagnosesMatrixCode IN ('D999P0', 'S999P0'))
		GOTO RETURN_NULL

	--Set correct region for not entered codes
	IF CHARINDEX('notentered',LOWER(@DiagnosesMatrixCode)) > 0
	BEGIN
		SET @siteid = NULL
		SELECT @MatrixSection = 
		CASE LOWER(@DiagnosesMatrixCode)
			WHEN 'oesophagusnotentered' THEN 'Oesophagus'
			WHEN 'stomachnotentered' THEN 'Stomach'
			WHEN 'duodenumnotentered' THEN 'Duodenum'
		END
	END
	
	IF LOWER(@Value) NOT IN ('true', '1') SET @Value = 'False'


	IF @Value = 'False'
	BEGIN
		DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode= @DiagnosesMatrixCode AND (SiteId = @siteid OR ISNULL(@siteid,'') = '')
	END
	ELSE
	BEGIN
		UPDATE [ERS_Diagnoses] SET [Value] = @Value, Region = @MatrixSection 
		WHERE ProcedureID = @ProcedureID AND MatrixCode= @DiagnosesMatrixCode
		AND (SiteId = @siteid OR ISNULL(@siteid,'') = '')

		IF @@ROWCOUNT=0 
		BEGIN
			--No records found in ERS_Diagnoses when updating, go ahead and insert it
			INSERT INTO [ERS_Diagnoses] (ProcedureID, SiteID, MatrixCode, [Value], [Region]) 
			VALUES (@ProcedureID, @SiteID, @DiagnosesMatrixCode,@Value,@MatrixSection) 
		END
	END

	EXEC ogd_diagnoses_summary_update @ProcedureID

	RETURN_NULL:
END TRY

BEGIN CATCH
    DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

    IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH

IF @@TRANCOUNT > 0 COMMIT TRANSACTION;

GO

EXEC dbo.DropIfExist 
    @ObjectName = 'ogd_diagnoses_summary_update', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[ogd_diagnoses_summary_update]
(
	@ProcedureId INT
)
AS

SET NOCOUNT ON

--check for procedure DNA
DECLARE @ProcNotCarriedOut bit = ISNULL((SELECT 1 FROM ERS_Procedures WHERE ProcedureId = @ProcedureId AND DNA IS NOT NULL), 0)

IF @ProcNotCarriedOut = 1
	RETURN --DNA procs do not procude a diagnosis

DECLARE @ProcedureType INT
DECLARE @Summary varchar(MAX)=''
DECLARE @tmpSummary varchar(MAX)=''
DECLARE @XMLlist XML
DECLARE @OperatingHospitalId INT
DECLARE @OGDDiagnosisOption INT
DECLARE @Extent INT
DECLARE @ExtentItem VARCHAR(MAX)
DECLARE @ExtentDescription VARCHAR(MAX)
DECLARE @StomachExtent INT = (SELECT UniqueId FROM ERS_Extent WHERE Description = 'Stomach')
DECLARE @DuodenumExtent INT = (SELECT UniqueId FROM ERS_Extent WHERE Description = 'D1')
DECLARE @FurthestExtentReached INT = 0
DECLARE @BlockingStricure BIT = 0
Declare @checkedOesophagusNotEntered INT =0

SELECT 
	@ProcedureType = ProcedureType, 
	@OperatingHospitalId = COALESCE(OperatingHospitalId, 0, OperatingHospitalID)
FROM ERS_Procedures 
WHERE ProcedureId = @ProcedureId

SELECT 
	@OGDDiagnosisOption = OGDDiagnosis
FROM dbo.ERS_SystemConfig 
WHERE OperatingHospitalId = @OperatingHospitalId

--Get furthest recored Extent
SELECT TOP 1 @FurthestExtentReached = ee.UniqueId
FROM dbo.ERS_ProcedureUpperExtent epue 
	INNER JOIN dbo.ERS_Extent ee ON epue.ExtentId = ee.UniqueId
WHERE epue.ProcedureId=@ProcedureId
ORDER BY ee.ListOrderBy DESC

IF (SELECT ugam.SiteId
	FROM ERS_UpperGIAbnoMiscellaneous ugam
	JOIN ERS_Sites s ON s.SiteId = ugam.SiteId
	JOIN ERS_Regions r ON r.RegionId = s.RegionId
	JOIN ERS_AbnormalitiesMatrixUpperGI amug ON amug.Region = r.Region AND amug.ProcedureType = @ProcedureType
	LEFT JOIN ERS_UpperGITherapeutics ugt ON ugt.SiteId = s.SiteId 
	WHERE ugam.SiteId in (SELECT SiteId FROM ERS_Sites WHERE ProcedureId = @ProcedureId)
	AND amug.area = 'Oesophagus'
	AND ugam.StrictureScopeNotPass = 1 
	AND ISNULL(ugt.DilatorScopePass,0) != 1) > 0
BEGIN
	SET @BlockingStricure = 1
END

	 
IF @ProcedureType IN (2, 7)    --For ERCP & EUS_HPB, execute a different SP
BEGIN
	EXEC ercp_diagnoses_summary_update @ProcedureId
	RETURN
END

BEGIN TRANSACTION

BEGIN TRY

SELECT * INTO #tbl_ERS_Diagnoses FROM ERS_Diagnoses WHERE ProcedureId=@ProcedureId 

IF @ProcedureType IN (1,6,8,(SELECT ProcedureTypeId FROM ERS_ProcedureTypes where ProcedureType = 'Transnasal'))   --Gastroscopy, Transnasal TFS-3513 
BEGIN
	IF OBJECT_ID('tempdb..#Oesophagus') IS NOT NULL DROP TABLE #Oesophagus
	IF OBJECT_ID('tempdb..#Stomach') IS NOT NULL DROP TABLE #Stomach
	IF OBJECT_ID('tempdb..#Duodenum') IS NOT NULL DROP TABLE #Duodenum

    IF OBJECT_ID('tempdb..#OesophagusTemp') IS NOT NULL DROP TABLE #OesophagusTemp
                             create table #OesophagusTemp ([cx] Int null, [Text] varchar(MAX) null)
    IF OBJECT_ID('tempdb..#StomachTemp') IS NOT NULL DROP TABLE #StomachTemp
                             create table #StomachTemp ([cx] Int null, [Text] varchar(MAX) null)
    IF OBJECT_ID('tempdb..#DuodenumTemp') IS NOT NULL DROP TABLE #DuodenumTemp
                             create table #DuodenumTemp ([cx] Int null, [Text] varchar(MAX) null)
	
	IF (SELECT COUNT(*) FROM #tbl_ERS_Diagnoses ted) = 0
	BEGIN
		INSERT INTO ERS_Diagnoses (ProcedureID, MatrixCode, [Value], IsOtherData)
		VALUES (@ProcedureId, 'OverallNormal', '1', 1)
	END
	ELSE
	BEGIN
		/*OESOPHAGUS REGION*/
		IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Region='Oesophagus' AND Value IN ('True', '1') AND MatrixCode NOT IN ('OesophagusNormal', 'OesophagusNotEntered'))
		BEGIN
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'OesophagusNormal') DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'OesophagusNormal' AND Value IN ('True', '1')
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'OesophagusNotEntered')  DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'OesophagusNotEntered' AND Value IN ('True', '1')
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'OverallNormal') DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'OverallNormal'
		END
		ELSE IF NOT EXISTS (SELECT 1 FROM #tbl_ERS_Diagnoses WHERE Region = 'Oesophagus' OR MatrixCode = 'OverallNormal')
		BEGIN
			INSERT INTO [ERS_Diagnoses] (ProcedureId, MatrixCode, Value, Region, IsOtherData) VALUES (@ProcedureId, 'OesophagusNormal', 'True', 'Oesophagus', 1)
		END
		
		--edited by Mostafizur 3831
	 
	
		IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Region='Oesophagus' AND Value IN ('True', '1') AND MatrixCode = 'OesophagusNotEntered')
			set @checkedOesophagusNotEntered=1
			SELECT TOP 1 @ExtentDescription = ee.Description
								FROM dbo.ERS_ProcedureUpperExtent epue 
									INNER JOIN dbo.ERS_Extent ee ON epue.ExtentId = ee.UniqueId
								WHERE epue.ProcedureId=@ProcedureId
								ORDER BY ee.ListOrderBy DESC

		--edited by Mostafizur 3831

		/*STOMACH REGION*/
		IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Region='Stomach' AND Value IN ('True', '1') AND MatrixCode NOT IN ('StomachNormal', 'StomachNotEntered'))
		BEGIN
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'StomachNormal')  DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'StomachNormal' AND Value IN ('True', '1')
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'StomachNotEntered')  DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'StomachNotEntered' AND Value IN ('True', '1')
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'OverallNormal')  DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'OverallNormal'

			/*Oesophagus must've been entered to get a diagnoses*/
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'OesophagusNotEntered')  DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'OesophagusNotEntered' AND Value IN ('True', '1')
		END
		ELSE IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Region='Stomach' AND Value IN ('True', '1') AND MatrixCode IN ('StomachNormal', 'StomachNotEntered'))
		BEGIN
				IF @FurthestExtentReached >= @StomachExtent AND @BlockingStricure = 0
				and  @ExtentDescription Not IN ('intubation failed','abandoned')  --only this edited by Mostafizur 3831
				BEGIN
					DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'StomachNotEntered' AND Value IN ('True', '1')
					IF NOT EXISTS (SELECT 1 FROM #tbl_ERS_Diagnoses WHERE MatrixCode = 'StomachNormal' OR MatrixCode = 'OverallNormal')
					BEGIN
						INSERT INTO [ERS_Diagnoses] (ProcedureId, MatrixCode, Value, Region, IsOtherData) VALUES (@ProcedureId, 'StomachNormal', 'True', 'Stomach', 1)
					END
				END
				ELSE
				BEGIN
					DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'StomachNormal' AND Value IN ('True', '1')
					IF NOT EXISTS (SELECT 1 FROM #tbl_ERS_Diagnoses WHERE MatrixCode = 'StomachNotEntered' OR MatrixCode = 'OverallNormal')
					BEGIN
						INSERT INTO [ERS_Diagnoses] (ProcedureId, MatrixCode, Value, Region, IsOtherData) VALUES (@ProcedureId, 'StomachNotEntered', 'True', 'Stomach', 1)
					END
				END
		END
		ELSE IF NOT EXISTS (SELECT 1 FROM #tbl_ERS_Diagnoses WHERE Region = 'Stomach' OR MatrixCode = 'OverallNormal')
		BEGIN
			INSERT INTO [ERS_Diagnoses] (ProcedureId, MatrixCode, Value, Region, IsOtherData) VALUES (@ProcedureId, 'StomachNormal', 'True', 'Stomach', 1)
		END

		/*DUODENUM REGION*/
		IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Region='Duodenum' AND Value IN ('True', '1') AND MatrixCode NOT IN ('DuodenumNormal', 'DuodenumNotEntered'))
		BEGIN
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'DuodenumNormal')  DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'DuodenumNormal' AND Value IN ('True', '1')
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'DuodenumNotEntered')  DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'DuodenumNotEntered' AND Value IN ('True', '1')
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'OverallNormal')   DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'OverallNormal'

			/*Oesophagus and stomach must've been entered to get a diagnoses*/
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'OesophagusNotEntered')  DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'OesophagusNotEntered' AND Value IN ('True', '1')
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'StomachNotEntered')  DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'StomachNotEntered' AND Value IN ('True', '1')

		END
		ELSE IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Region='Duodenum' AND Value IN ('True', '1') AND MatrixCode IN ('DuodenumNormal', 'DuodenumNotEntered'))
		BEGIN
			IF @FurthestExtentReached >= @DuodenumExtent AND @BlockingStricure = 0
			and  @ExtentDescription Not IN ('intubation failed','abandoned')  --only this edited by Mostafizur 3831
			BEGIN
				DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'DuodenumNotEntered' AND Value IN ('True', '1')
				IF NOT EXISTS (SELECT 1 FROM #tbl_ERS_Diagnoses WHERE MatrixCode = 'DuodenumNormal' OR MatrixCode = 'OverallNormal')
				BEGIN
					INSERT INTO [ERS_Diagnoses] (ProcedureId, MatrixCode, Value, Region, IsOtherData) VALUES (@ProcedureId, 'DuodenumNormal', 'True', 'Duodenum', 1)
				END
			END
			ELSE
			BEGIN
				DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'DuodenumNormal' AND Value IN ('True', '1')
				IF NOT EXISTS (SELECT 1 FROM #tbl_ERS_Diagnoses WHERE MatrixCode = 'DuodenumNotEntered' OR MatrixCode = 'OverallNormal')
				BEGIN
					INSERT INTO [ERS_Diagnoses] (ProcedureId, MatrixCode, Value, Region, IsOtherData) VALUES (@ProcedureId, 'DuodenumNotEntered', 'True', 'Duodenum', 1)
				END
			END
		END
		ELSE IF NOT EXISTS (SELECT 1 FROM #tbl_ERS_Diagnoses WHERE Region = 'Duodenum' OR MatrixCode = 'OverallNormal')
		BEGIN
			INSERT INTO [ERS_Diagnoses] (ProcedureId, MatrixCode, Value, Region, IsOtherData) VALUES (@ProcedureId, 'DuodenumNormal', 'True', 'Duodenum', 1)
		END

	END

	IF EXISTS (SELECT 1 FROM #tbl_ERS_Diagnoses ted WHERE Region = 'Oesophagus' AND MatrixCode = 'OesophagusNormal' AND ted.[Value] IN ('True', '1')) AND
			EXISTS (SELECT 1 FROM #tbl_ERS_Diagnoses ted WHERE Region = 'Stomach' AND MatrixCode = 'StomachNormal' AND ted.[Value] IN ('True', '1')) AND
			EXISTS (SELECT 1 FROM #tbl_ERS_Diagnoses ted WHERE Region = 'Duodenum' AND MatrixCode = 'DuodenumNormal' AND ted.[Value] IN ('True', '1')) AND
			NOT EXISTS (SELECT 1 FROM #tbl_ERS_Diagnoses ted WHERE MatrixCode <> 'Summary' AND MatrixCode NOT IN ('OesophagusNormal','StomachNormal','DuodenumNormal'))
	BEGIN
		DELETE FROM ERS_Diagnoses WHERE MatrixCode IN ('OesophagusNormal','StomachNormal','DuodenumNormal')

		INSERT INTO ERS_Diagnoses (ProcedureID, MatrixCode, [Value], IsOtherData)
		VALUES (@ProcedureId, 'OverallNormal', '1', 1)

	END
	

	-- Don't repeat diagnoses
	IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE MatrixCode in ('D39P1', 'D84P1')) DELETE FROM ERS_Diagnoses WHERE MatrixCode = 'D49P1' and ProcedureID = @ProcedureId
	IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE MatrixCode in ('D90P1', 'D91P1')) DELETE FROM ERS_Diagnoses WHERE MatrixCode = 'D53P1' and ProcedureID = @ProcedureId

	DELETE FROM #tbl_ERS_Diagnoses
	INSERT INTO #tbl_ERS_Diagnoses
	(
	    ProcedureID,
	    SiteId,
	    MatrixCode,
	    [Value],
	    Region,
	    IsOtherData
	)
	SELECT  
	    ProcedureID,
	    SiteId,
	    MatrixCode,
	    [Value],
	    Region,
	    IsOtherData 
	FROM ERS_Diagnoses WHERE ProcedureId=@ProcedureId 

	--edited by siddik tfs# 2232
    SELECT  RowNum = ROW_NUMBER() OVER(ORDER BY [DiagnosesID]),d.*, CASE WHEN m.DisplayName = 'Other' THEN ISNULL(u.MiscOther, 'Other') ELSE m.DisplayName END AS DisplayName	INTO #Oesophagus	FROM #tbl_ERS_Diagnoses d	LEFT JOIN ERS_UpperGIAbnoMiscellaneous u ON d.SiteId = u.SiteId	LEFT JOIN ERS_DiagnosesMatrix m ON d.matrixcode=m.Code WHERE Region='Oesophagus'	AND [Value] IS NOT NULL AND [Value]<>'False' AND [Value]<>'' AND MatrixCode <>'Summary'
    SELECT  RowNum = ROW_NUMBER() OVER(ORDER BY [DiagnosesID]),d.*, CASE WHEN m.DisplayName = 'Other' THEN ISNULL(u.MiscOther, 'Other') ELSE m.DisplayName END AS DisplayName	INTO #Stomach		FROM #tbl_ERS_Diagnoses d	LEFT JOIN ERS_UpperGIAbnoMiscellaneous u ON d.SiteId = u.SiteId LEFT JOIN ERS_DiagnosesMatrix m ON d.matrixcode=m.Code WHERE Region='Stomach'		AND [Value] IS NOT NULL AND [Value]<>'False' AND [Value]<>'' AND MatrixCode <>'Summary'
    SELECT  RowNum = ROW_NUMBER() OVER(ORDER BY [DiagnosesID]),d.*, CASE WHEN m.DisplayName = 'Other' THEN ISNULL(u.MiscOther, 'Other') ELSE m.DisplayName END AS DisplayName	INTO #Duodenum		FROM #tbl_ERS_Diagnoses d	LEFT JOIN ERS_UpperGIAbnoMiscellaneous u ON d.SiteId = u.SiteId LEFT JOIN ERS_DiagnosesMatrix m ON d.matrixcode=m.Code WHERE Region='Duodenum'		AND [Value] IS NOT NULL AND [Value]<>'False' AND [Value]<>'' AND MatrixCode <>'Summary'
	--tfs# 2232 end

	--Insert Other Abnormality
	If EXISTS(Select 1 from ERS_CommonAbnoOther CAO join ERS_Sites S On CAO.SiteId = s.SiteId where S.ProcedureId = @ProcedureId)
	BEGIN

		Insert into #Oesophagus (DiagnosesID, DisplayName, SiteId, ProcedureID, MatrixCode)
		SELECT 999, STUFF((
			SELECT DISTINCT ', ' + OA.Diagnoses  
			FROM ERS_OtherAbnormalities OA
			JOIN ERS_CommonAbnoOther CAO ON OA.OtherId = CAO.OtherId
			JOIN ERS_Sites S ON CAO.SiteId = s.SiteId
			JOIN ERS_Regions R ON S.RegionId = R.RegionId
			JOIN ERS_AbnormalitiesMatrixUpperGI AMU ON R.Region = AMU.Region
			WHERE S.ProcedureId = @ProcedureId
			AND AMU.Area = 'Oesophagus'
			AND AMU.ProcedureType = @ProcedureType
			FOR XML PATH('')), 1, 1, '') Code, 2, @ProcedureId, 'D999P0'

		Insert into #Stomach (DiagnosesID, DisplayName, SiteId, ProcedureID, MatrixCode)
		SELECT 999, STUFF((
			SELECT DISTINCT ', ' + OA.Diagnoses  
			FROM ERS_OtherAbnormalities OA
			JOIN ERS_CommonAbnoOther CAO ON OA.OtherId = CAO.OtherId
			JOIN ERS_Sites S ON CAO.SiteId = s.SiteId
			JOIN ERS_Regions R ON S.RegionId = R.RegionId
			JOIN ERS_AbnormalitiesMatrixUpperGI AMU ON R.Region = AMU.Region
			WHERE S.ProcedureId = @ProcedureId
			AND AMU.Area = 'Stomach'
			AND AMU.ProcedureType = @ProcedureType
			FOR XML PATH('')), 1, 1, '') Code, 2, @ProcedureId, 'D999P0'

		Insert into #Duodenum (DiagnosesID, DisplayName, SiteId, ProcedureID, MatrixCode)
		SELECT 999, STUFF((
			SELECT DISTINCT ', ' + OA.Diagnoses  
			FROM ERS_OtherAbnormalities OA
			JOIN ERS_CommonAbnoOther CAO ON OA.OtherId = CAO.OtherId
			JOIN ERS_Sites S ON CAO.SiteId = s.SiteId
			JOIN ERS_Regions R ON S.RegionId = R.RegionId
			JOIN ERS_AbnormalitiesMatrixUpperGI AMU ON R.Region = AMU.Region
			WHERE S.ProcedureId = @ProcedureId
			AND AMU.Area = 'Duodenum'
			AND AMU.ProcedureType = @ProcedureType
			FOR XML PATH('')), 1, 1, '') Code, 2, @ProcedureId, 'D999P0'
	END
	--Delete duplicates
	--DELETE FROM #Oesophagus WHERE RowNum NOT IN (SELECT MIN(RowNum) FROM #Oesophagus GROUP BY MatrixCode)
	--DELETE FROM #Stomach	WHERE RowNum NOT IN (SELECT MIN(RowNum) FROM #Stomach	GROUP BY MatrixCode)
	--DELETE FROM #Duodenum	WHERE RowNum NOT IN (SELECT MIN(RowNum) FROM #Duodenum	GROUP BY MatrixCode)
	--Delete duplicates
	
	--OESOPHAGUS
	INSERT INTO #OesophagusTemp ([cx],[Text]) 	--UNION to exclude duplicates for Abnormalities!
		--'Not Entered' or 'Normal' selected from the diagnoses screen
		SELECT 1, 'not entered' FROM #Oesophagus WHERE MatrixCode = 'OesophagusNotEntered'
		UNION
		SELECT 2, 'normal' FROM #Oesophagus WHERE MatrixCode = 'OesophagusNormal'
		UNION
		SELECT 3, CAST([Value] as Varchar(MAX)) FROM #Oesophagus WHERE MatrixCode = 'OesophagusOtherDiagnosis'
		UNION
		SELECT 0, DisplayName FROM #Oesophagus WHERE SiteId > 0 --Abnormalities for each sites 

	
	--STOMACH          
	INSERT INTO #StomachTemp ([cx],[Text]) 	--UNION to exclude duplicates for Abnormalities!
		--'Not Entered' or 'Normal' selected from the diagnoses screen
		SELECT 1, 'not entered' FROM #Stomach WHERE MatrixCode = 'StomachNotEntered'
		UNION
		SELECT 2, 'normal' FROM #Stomach WHERE MatrixCode = 'StomachNormal'
		UNION
		SELECT 3, CAST([Value] as Varchar(MAX)) FROM #Stomach WHERE MatrixCode = 'StomachOtherDiagnosis'
		UNION
		SELECT 0, DisplayName FROM #Stomach WHERE SiteId > 0 --Abnormalities for each sites 

	--DUODENUM      
	INSERT INTO #DuodenumTemp ([cx],[Text]) 	--UNION to exclude duplicates for Abnormalities!
		--'Not Entered' or 'Normal' selected from the diagnoses screen
		SELECT 1, 'not entered' FROM #Duodenum WHERE MatrixCode = 'DuodenumNotEntered'
		UNION
		SELECT 2, 'normal' FROM #Duodenum WHERE MatrixCode = 'DuodenumNormal'
		UNION
		SELECT 4, '2nd part not entered' FROM #Duodenum WHERE MatrixCode = 'Duodenum2ndPartNotEntered'
		UNION
		SELECT 3, CAST([Value] as Varchar(MAX)) FROM #Duodenum WHERE MatrixCode = 'DuodenumOtherDiagnosis'
		UNION
		SELECT 0, DisplayName FROM #Duodenum WHERE SiteId > 0 --Abnormalities for each sites 

--Determining the OGD diagnoses option set in System Settings
-- 0: Whole upper tract normal
-- 1: Individually Oesophagus normal, Stomach normal, Duodenum normal

	DECLARE @overallStatus AS INT
	IF EXISTS(SELECT 1 FROM #tbl_ERS_Diagnoses WHERE Value = 1 AND MatrixCode = 'OverallNormal')
	BEGIN
		SET @overallStatus = 1
	END
	ELSE
	BEGIN
		SET @overallStatus = 0
	END

	IF @OGDDiagnosisOption = 0 AND @overallStatus = 1
    BEGIN	
		SET @Summary = @Summary + 'Whole upper gastro-intestinal tract normal.<br/>'			
	END
	--edited by mostafiz 2983
	Else If @OGDDiagnosisOption = 1 AND @overallStatus = 1
	Begin

	SET @Summary = @Summary + '<b>Oesophagus: </b>' + 'normal' + '.<br/>'
	SET @Summary = @Summary + '<b>Stomach: </b>' + 'normal' + '.<br/>'
	SET @Summary = @Summary + '<b>Duodenum: </b>' + 'normal' + '.<br/>'
	End 
	--edited by mostafiz 2983

	ELSE 
	BEGIN
		--Oesophagus
		IF EXISTS(select 1 from #OesophagusTemp)
		BEGIN
			SET @XMLlist = (SELECT [text] AS Val FROM #OesophagusTemp FOR XML  RAW, ELEMENTS, TYPE)
			SET @tmpSummary = dbo.fnBuildString(@XMLlist)
			IF @tmpSummary <> '' SET @Summary = @Summary + '<b>Oesophagus: </b>' + @tmpSummary + '.<br/>'
		END
		
		--Stomach 
		DELETE FROM #StomachTemp WHERE Text = 'Duodenum not examined' AND EXISTS (SELECT 1 FROM #DuodenumTemp WHERE Text <> 'not entered' AND Text <> 'normal')	--edited by siddik tfs# 4215		
		IF EXISTS(select 1 from #StomachTemp)
		BEGIN
			SET @XMLlist = (SELECT [text] AS Val FROM #StomachTemp FOR XML  RAW, ELEMENTS, TYPE)
			SET @tmpSummary = dbo.fnBuildString(@XMLlist)
			IF @tmpSummary <> '' SET @Summary = @Summary + '<b>Stomach: </b>' + @tmpSummary + '.<br/>'
		END
		ELSE
		BEGIN
			INSERT INTO #StomachTemp ([cx],[Text]) VALUES(1, 'not entered')
			SET @XMLlist = (SELECT [text] AS Val FROM #StomachTemp FOR XML  RAW, ELEMENTS, TYPE)
			SET @tmpSummary = dbo.fnBuildString(@XMLlist)
			IF @tmpSummary <> '' SET @Summary = @Summary + '<b>Stomach: </b>' + @tmpSummary + '.<br/>'
		END
		
		--Duodenum 
		IF EXISTS(select 1 from #DuodenumTemp) --AND @ExtentLevelReached = 1
		BEGIN
			SET @XMLlist = (SELECT [text] AS Val FROM #DuodenumTemp FOR XML  RAW, ELEMENTS, TYPE)
			SET @tmpSummary = dbo.fnBuildString(@XMLlist)
			IF @tmpSummary <> '' SET @Summary = @Summary + '<b>Duodenum: </b>' + @tmpSummary + '.<br/>'
		END
		--ELSE
		--IF EXISTS(select 1 from #DuodenumTemp)
		--BEGIN
		--	SET @XMLlist = (SELECT [text] AS Val FROM #DuodenumTemp FOR XML  RAW, ELEMENTS, TYPE)
		--	SET @tmpSummary = dbo.fnBuildString(@XMLlist)
		--	IF @tmpSummary <> '' SET @Summary = @Summary + '<b>Duodenum: </b>' + 'not entered.<br/>'
		--END		
	END	

	--IF EXISTS(SELECT 1 FROM ERS_UpperGIBleeds WHERE ProcedureID = @ProcedureId)
	--BEGIN
	--	SET @Summary = @Summary +'<b>RISK OF REBLEED: </b>' + ISNULL((SELECT [OverallRiskAssessment] FROM ERS_UpperGIBleeds WHERE ProcedureID = @ProcedureId),'') + '. <br/> '
	--END

    DROP TABLE #Oesophagus
    DROP TABLE #OesophagusTemp
    DROP TABLE #Stomach
    DROP TABLE #StomachTemp
    DROP TABLE #Duodenum
    DROP TABLE #DuodenumTemp
END
ELSE IF @ProcedureType IN (3,4,5,9) --Colonoscopy, Sigmoidscopy, Proctoscopy
BEGIN
	IF OBJECT_ID('tempdb..#Colon') IS NOT NULL DROP TABLE #Colon
	IF OBJECT_ID('tempdb..#ColonTemp') IS NOT NULL DROP TABLE #ColonTemp
		create table #ColonTemp ([cx] Int null,	[Text] VARCHAR(MAX) null)

	IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True','1') AND MatrixCode <> 'ColonNormal' )
	BEGIN
		DELETE [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'ColonNormal'
		DELETE #tbl_ERS_Diagnoses WHERE MatrixCode = 'ColonNormal'
	END;

	--Select first row in each group (in case there's more than 1 record for a given MatrixCode)
	WITH colSummary AS (
    SELECT p.DiagnosesID, p.MatrixCode, p.Value, p.Region,
           ROW_NUMBER() OVER(PARTITION BY p.MatrixCode ORDER BY p.DiagnosesID DESC) AS rk
    FROM #tbl_ERS_Diagnoses p)

	SELECT d.*, cast(m.DisplayName as varchar(500)) as DisplayName
	INTO #Colon
	FROM colSummary d 
	LEFT JOIN ERS_DiagnosesMatrix m ON d.matrixcode = m.Code AND m.ProcedureTypeID = @ProcedureType
	WHERE rk = 1 -- Get the first record only
	AND Region = 'Colon'	AND [Value] IS NOT NULL	AND [Value] <> 'False'
	AND [Value] <> ''		AND [Value] <> '0'		--AND MatrixCode <> 'Summary'

	If EXISTS(Select 1 from ERS_CommonAbnoOther CAO join ERS_Sites S On CAO.SiteId = s.SiteId where S.ProcedureId = @ProcedureId)
	BEGIN

		Insert into #Colon (DiagnosesID, DisplayName, MatrixCode)
		SELECT 999, STUFF((
			SELECT DISTINCT ', ' + OA.Diagnoses  
			FROM ERS_OtherAbnormalities OA
			JOIN ERS_CommonAbnoOther CAO ON OA.OtherId = CAO.OtherId
			JOIN ERS_Sites S ON CAO.SiteId = s.SiteId
			WHERE S.ProcedureId = @ProcedureId
			FOR XML PATH('')), 1, 1, '') Code, 'D999P3'
	END

	IF ISNULL((SELECT CASE WHEN Abandoned = 1 OR NED_Abandoned = 1 THEN 1 ELSE 0 END FROM ERS_ColonExtentOfIntubation WHERE ProcedureId = @ProcedureId), 0) = 0
	BEGIN
		INSERT INTO #ColonTemp ([cx],[Text]) 
		SELECT 1, CONVERT(VARCHAR(MAX), 'The examination to the point of insertion was normal.') FROM #Colon WHERE MatrixCode = 'ColonNormal'
		UNION
		SELECT 2, 'The rest of the examination to the point of insertion was normal' FROM #Colon WHERE MatrixCode = 'ColonRestNormal'
	END
	ELSE
	BEGIN
		INSERT INTO #ColonTemp ([cx],[Text]) 
		SELECT 300, CONVERT(VARCHAR(MAX), 'Procedure abandoned')
	END

	INSERT INTO #ColonTemp ([cx],[Text])
	SELECT 4, MatrixCode FROM #Colon WHERE MatrixCode = 'Colitis'
	UNION
	SELECT 5, (SELECT m.DisplayName FROM ERS_DiagnosesMatrix m WHERE m.code= d.Value AND m.ProcedureTypeID = @ProcedureType)  FROM #Colon d WHERE d.MatrixCode = 'ColitisType' AND VALUE NOT IN ('D85P3', 'S85P3', 'P85P3') -- '?85P3' = None specified
	UNION
	SELECT 6, (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Diagnoses Colon Extent' AND [ListItemNo] = Value) FROM #Colon WHERE MatrixCode = 'ColitisExtent'
	UNION
	SELECT 7, (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Mayo Score' AND [ListItemNo] = Value) FROM #Colon WHERE MatrixCode = 'MayoScore'
	UNION
	SELECT 8, (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Simple Endoscopic Score  Crohn''s Disease' AND [ListItemNo] = Value) FROM #Colon WHERE MatrixCode = 'SEScore'
	UNION
	SELECT 9, MatrixCode FROM #Colon WHERE MatrixCode = 'Ileitis'
	UNION
	SELECT 10, MatrixCode FROM #Colon WHERE MatrixCode = 'Proctitis'
	UNION
	SELECT 0, LOWER(DisplayName) FROM #Colon WHERE RIGHT(MatrixCode,2) = 'P3'
	UNION
	SELECT 300, Value FROM #Colon WHERE MatrixCode = 'ColonOtherDiagnosis'
	

	IF EXISTS(select 1 from #ColonTemp)
	BEGIN
		SET @Summary = ''

		IF EXISTS(SELECT 1 FROM #ColonTemp WHERE cx =1) -- no need to check further if "point of insertion was normal"
			SET @Summary = (SELECT TOP 1 [text] from #ColonTemp where cx=1)
		ELSE 
		BEGIN
			--IF EXISTS(SELECT 1 FROM #ColonTemp WHERE cx IN (9)) --Ileitis checked
			--BEGIN
			--	SET @Summary = (SELECT TOP 1 [text] from #ColonTemp where cx=9)
			--END

			IF EXISTS(SELECT 1 FROM #ColonTemp WHERE cx IN (4, 9, 10)) --Colitis checked
			BEGIN
				DECLARE @ck varchar(1000) =''
				DECLARE @ms varchar(1000) = ''
				DECLARE @ses varchar(1000) = ''
				DECLARE @ColitisType VARCHAR(200) = ''
				IF EXISTS(SELECT 1 FROM #ColonTemp WHERE cx =6) 
					SET @ck=  (SELECT CASE @ck WHEN '' THEN (SELECT TOP 1 [text] from #ColonTemp where cx=6) ELSE @ck + ' ' + (SELECT TOP 1 [text] from #ColonTemp where cx=6) END)

				IF EXISTS(SELECT 1 FROM #ColonTemp WHERE cx =7) 
					SET @ms=  (SELECT CASE @ms WHEN '' THEN (SELECT TOP 1 [text] from #ColonTemp where cx=7) ELSE @ms + ' ' + (SELECT TOP 1 [text] from #ColonTemp where cx=7) END)

				IF EXISTS(SELECT 1 FROM #ColonTemp WHERE cx =8) 
					SET @ses=  (SELECT CASE @ses WHEN '' THEN (SELECT TOP 1 [text] from #ColonTemp where cx=8) ELSE @ses + ' ' + (SELECT TOP 1 [text] from #ColonTemp where cx=8) END)
				
				IF EXISTS(SELECT 1 FROM #ColonTemp WHERE cx = 9) --Ileitis checked
				BEGIN
					INSERT INTO #ColonTemp ([cx],[Text])  SELECT 50, 'Ileitis'
				END

				IF EXISTS(SELECT 1 FROM #ColonTemp WHERE cx =5) 
				BEGIN
					SET @ColitisType = ISNULL((SELECT TOP 1 [text] from #ColonTemp where cx=5),'')
				
					IF @ColitisType = '' SET @ColitisType = ISNULL((SELECT TOP 1 [text] from #ColonTemp where cx=4),'')

					IF @ms = '' AND @ses = ''
						SET @ColitisType = @ColitisType + (SELECT CASE @ck WHEN '' THEN '' ELSE ' (' + @ck +')' END)
					ELSE
					BEGIN
						IF @ms <> ''
							SET @ColitisType = @ColitisType + LOWER((SELECT CASE @ms WHEN '' THEN '' ELSE ': ' + @ms  END) + (SELECT CASE @ck WHEN '' THEN '' ELSE ', ' + @ck  END))
						
						IF @ses <> ''
							SET @ColitisType = @ColitisType + LOWER((SELECT CASE @ses WHEN '' THEN '' ELSE ': ' + @ses  END) + (SELECT CASE @ck WHEN '' THEN '' ELSE ', ' + @ck END))
					END
				END
				ELSE SET @ColitisType = LOWER((SELECT TOP 1 [text] from #ColonTemp where cx=4))

				--Concatnate text for colitis (4,5,6,7) and insert into #ColonTemp with id 100
				INSERT INTO #ColonTemp ([cx],[Text])  SELECT 100, @ColitisType

				IF EXISTS(SELECT 1 FROM #ColonTemp WHERE cx = 10) --Ileitis checked
				BEGIN
					INSERT INTO #ColonTemp ([cx],[Text])  SELECT 200, 'Proctitis'
				END
			END

			-- 0 = diag matrix ending with 'P3'  ;  100 = colitis   ;  300 = others
			SET @XMLlist = (SELECT [Text] AS Val FROM #ColonTemp WHERE [cx] in (0,50,100,200,300) ORDER BY [cx] FOR XML  RAW, ELEMENTS, TYPE)
			SET @Summary =  dbo.fnBuildString(@XMLlist) 

			SET @Summary = ISNULL((SELECT TOP 1 [text] + '.<br/>' FROM #ColonTemp WHERE cx=2),'')  + 
					CASE WHEN  @Summary <> '' THEN dbo.fnFirstLetterUpper(@Summary) + '.<br/>' ELSE '' END
			IF ISNULL((SELECT ResectedColonNo FROM ers_procedures WHERE ProcedureId = @ProcedureId), '') NOT IN ('0', '')-- tfs 3828
			BEGIN
				SET @Summary = '(post-surgical anatomy) - ' + @Summary;
			END;
		END

	END

	DROP TABLE #Colon
	DROP TABLE #ColonTemp
END
ELSE IF @ProcedureType IN (999) --Colonoscopy, Sigmoidscopy, Proctoscopy
BEGIN
	IF OBJECT_ID('tempdb..#Colon') IS NOT NULL DROP TABLE #ENT
	IF OBJECT_ID('tempdb..#ColonTemp') IS NOT NULL DROP TABLE #ENTTemp
		create table #ENTTemp ([cx] Int null,	[Text] VARCHAR(MAX) null)

	IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True','1') AND MatrixCode <> 'ColonNormal' )
	BEGIN
		DELETE [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'ColonNormal'
		DELETE #tbl_ERS_Diagnoses WHERE MatrixCode = 'ColonNormal'
	END;

	--Select first row in each group (in case there's more than 1 record for a given MatrixCode)
	WITH colSummary AS (
    SELECT p.DiagnosesID, p.MatrixCode, p.Value, p.Region,
           ROW_NUMBER() OVER(PARTITION BY p.MatrixCode ORDER BY p.DiagnosesID DESC) AS rk
    FROM #tbl_ERS_Diagnoses p)

	SELECT d.*, cast(m.DisplayName as varchar(500)) as DisplayName
	INTO #ENT
	FROM colSummary d 
	LEFT JOIN ERS_DiagnosesMatrix m ON d.matrixcode = m.Code AND m.ProcedureTypeID = @ProcedureType
	WHERE rk = 1 -- Get the first record only
	AND Region = 'Colon'	AND [Value] IS NOT NULL	AND [Value] <> 'False'
	AND [Value] <> ''		AND [Value] <> '0'		--AND MatrixCode <> 'Summary'

	If EXISTS(Select 1 from ERS_CommonAbnoOther CAO join ERS_Sites S On CAO.SiteId = s.SiteId where S.ProcedureId = @ProcedureId)
	BEGIN

		Insert into #ENT (DiagnosesID, DisplayName, MatrixCode)
		SELECT 999, STUFF((
			SELECT DISTINCT ', ' + OA.Diagnoses  
			FROM ERS_OtherAbnormalities OA
			JOIN ERS_CommonAbnoOther CAO ON OA.OtherId = CAO.OtherId
			JOIN ERS_Sites S ON CAO.SiteId = s.SiteId
			WHERE S.ProcedureId = @ProcedureId
			FOR XML PATH('')), 1, 1, '') Code, 'D999P9'
	END

	IF ISNULL((SELECT CASE WHEN Abandoned = 1 OR NED_Abandoned = 1 THEN 1 ELSE 0 END FROM ERS_ColonExtentOfIntubation WHERE ProcedureId = @ProcedureId), 0) = 0
	BEGIN
		INSERT INTO #ENTTemp ([cx],[Text]) 
		SELECT 1, CONVERT(VARCHAR(MAX), 'The examination to the point of insertion was normal.') FROM #ENT WHERE MatrixCode = 'ColonNormal'
		UNION
		SELECT 2, 'The rest of the examination to the point of insertion was normal' FROM #ENT WHERE MatrixCode = 'ColonRestNormal'
	END
	ELSE
	BEGIN
		INSERT INTO #ENTTemp ([cx],[Text]) 
		SELECT 300, CONVERT(VARCHAR(MAX), 'Procedure abandoned')
	END

	INSERT INTO #ENTTemp ([cx],[Text])
	SELECT 4, MatrixCode FROM #ENT WHERE MatrixCode = 'Colitis'
	UNION
	SELECT 5, (SELECT m.DisplayName FROM ERS_DiagnosesMatrix m WHERE m.code= d.Value AND m.ProcedureTypeID = @ProcedureType)  FROM #ENT d WHERE d.MatrixCode = 'ColitisType' AND VALUE NOT IN ('D85P3', 'S85P3', 'P85P3') -- '?85P3' = None specified
	UNION
	SELECT 6, (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Diagnoses Colon Extent' AND [ListItemNo] = Value) FROM #ENT WHERE MatrixCode = 'ColitisExtent'
	UNION
	SELECT 7, (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Mayo Score' AND [ListItemNo] = Value) FROM #ENT WHERE MatrixCode = 'MayoScore'
	UNION
	SELECT 8, (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Simple Endoscopic Score  Crohn''s Disease' AND [ListItemNo] = Value) FROM #ENT WHERE MatrixCode = 'SEScore'
	UNION
	SELECT 9, MatrixCode FROM #ENT WHERE MatrixCode = 'Ileitis'
	UNION
	SELECT 10, MatrixCode FROM #ENT WHERE MatrixCode = 'Proctitis'
	UNION
	SELECT 0, LOWER(DisplayName) FROM #ENT WHERE RIGHT(MatrixCode,2) = 'P9'
	UNION
	SELECT 300, Value FROM #ENT WHERE MatrixCode = 'ColonOtherDiagnosis'
	

	IF EXISTS(select 1 from #ENTTemp)
	BEGIN
		SET @Summary = ''

		IF EXISTS(SELECT 1 FROM #ENTTemp WHERE cx =1) -- no need to check further if "point of insertion was normal"
			SET @Summary = (SELECT TOP 1 [text] from #ENTTemp where cx=1)
		ELSE 
		BEGIN
			--IF EXISTS(SELECT 1 FROM #ColonTemp WHERE cx IN (9)) --Ileitis checked
			--BEGIN
			--	SET @Summary = (SELECT TOP 1 [text] from #ColonTemp where cx=9)
			--END

			IF EXISTS(SELECT 1 FROM #ENTTemp WHERE cx IN (4, 9, 10)) --Colitis checked
			BEGIN
				SET @ck =''
				SET @ms = ''
				SET @ses = ''
				SET @ColitisType = ''
				IF EXISTS(SELECT 1 FROM #ENTTemp WHERE cx =6) 
					SET @ck=  (SELECT CASE @ck WHEN '' THEN (SELECT TOP 1 [text] from #ENTTemp where cx=6) ELSE @ck + ' ' + (SELECT TOP 1 [text] from #ENTTemp where cx=6) END)

				IF EXISTS(SELECT 1 FROM #ENTTemp WHERE cx =7) 
					SET @ms=  (SELECT CASE @ms WHEN '' THEN (SELECT TOP 1 [text] from #ENTTemp where cx=7) ELSE @ms + ' ' + (SELECT TOP 1 [text] from #ENTTemp where cx=7) END)

				IF EXISTS(SELECT 1 FROM #ENTTemp WHERE cx =8) 
					SET @ses=  (SELECT CASE @ses WHEN '' THEN (SELECT TOP 1 [text] from #ENTTemp where cx=8) ELSE @ses + ' ' + (SELECT TOP 1 [text] from #ENTTemp where cx=8) END)
				
				IF EXISTS(SELECT 1 FROM #ENTTemp WHERE cx = 9) --Ileitis checked
				BEGIN
					INSERT INTO #ENTTemp ([cx],[Text])  SELECT 50, 'Ileitis'
				END

				IF EXISTS(SELECT 1 FROM #ENTTemp WHERE cx =5) 
				BEGIN
					SET @ColitisType = ISNULL((SELECT TOP 1 [text] from #ENTTemp where cx=5),'')
				
					IF @ColitisType = '' SET @ColitisType = ISNULL((SELECT TOP 1 [text] from #ENTTemp where cx=4),'')

					IF @ms = '' AND @ses = ''
						SET @ColitisType = @ColitisType + (SELECT CASE @ck WHEN '' THEN '' ELSE ' (' + @ck +')' END)
					ELSE
					BEGIN
						IF @ms <> ''
							SET @ColitisType = @ColitisType + LOWER((SELECT CASE @ms WHEN '' THEN '' ELSE ': ' + @ms  END) + (SELECT CASE @ck WHEN '' THEN '' ELSE ', ' + @ck  END))
						
						IF @ses <> ''
							SET @ColitisType = @ColitisType + LOWER((SELECT CASE @ses WHEN '' THEN '' ELSE ': ' + @ses  END) + (SELECT CASE @ck WHEN '' THEN '' ELSE ', ' + @ck END))
					END
				END
				ELSE SET @ColitisType = LOWER((SELECT TOP 1 [text] from #ENTTemp where cx=4))

				--Concatnate text for colitis (4,5,6,7) and insert into #ColonTemp with id 100
				INSERT INTO #ENTTemp ([cx],[Text])  SELECT 100, @ColitisType

				IF EXISTS(SELECT 1 FROM #ENTTemp WHERE cx = 10) --Ileitis checked
				BEGIN
					INSERT INTO #ENTTemp ([cx],[Text])  SELECT 200, 'Proctitis'
				END
			END

			-- 0 = diag matrix ending with 'P3'  ;  100 = colitis   ;  300 = others
			SET @XMLlist = (SELECT [Text] AS Val FROM #ENTTemp WHERE [cx] in (0,50,100,200,300) ORDER BY [cx] FOR XML  RAW, ELEMENTS, TYPE)
			SET @Summary =  dbo.fnBuildString(@XMLlist) 

			SET @Summary = ISNULL((SELECT TOP 1 [text] + '.<br/>' FROM #ENTTemp WHERE cx=2),'')  + 
					CASE WHEN  @Summary <> '' THEN dbo.fnFirstLetterUpper(@Summary) + '.<br/>' ELSE '' END
		END

	END

	DROP TABLE #ENT
	DROP TABLE #ENTTemp
END

--edited by Mostafizur 3774
--IF @ProcedureType IN (13,14)
--BEGIN
--	IF EXISTS (SELECT 1 FROM ers_sites WHERE ProcedureID = @ProcedureID AND (SiteSummary IS NULL OR SiteSummary = ''))
--	BEGIN
--		Set @Summary='Normal Cystoscopy'
		
--		IF EXISTS(SELECT 1 FROM #tbl_ERS_Diagnoses WHERE MatrixCode='Summary') UPDATE [ERS_Diagnoses] SET [Value] = @Summary WHERE Procedureid=@ProcedureID AND MatrixCode='Summary'
--		ELSE INSERT INTO [ERS_Diagnoses] (ProcedureID,MatrixCode,[Value]) VALUES (@ProcedureID,'Summary', @Summary)
--	END
--	ELSE 
--	BEGIN
--	IF EXISTS(SELECT 1 FROM #tbl_ERS_Diagnoses WHERE MatrixCode='Summary') UPDATE [ERS_Diagnoses] SET [Value] = @Summary WHERE Procedureid=@ProcedureID AND MatrixCode='Summary'
--	ELSE INSERT INTO [ERS_Diagnoses] (ProcedureID,MatrixCode,[Value]) VALUES (@ProcedureID,'Summary', @Summary)

--	END
	
--END

--ELSE 
--BEGIN
--IF EXISTS(SELECT 1 FROM #tbl_ERS_Diagnoses WHERE MatrixCode='Summary') UPDATE [ERS_Diagnoses] SET [Value] = @Summary WHERE Procedureid=@ProcedureID AND MatrixCode='Summary'
--ELSE INSERT INTO [ERS_Diagnoses] (ProcedureID,MatrixCode,[Value]) VALUES (@ProcedureID,'Summary', @Summary)

--END
--edited by Mostafizur 3774

UPDATE ERS_ProceduresReporting SET PP_Diagnoses = @Summary WHERE ProcedureId = @ProcedureId

print @Summary

IF ISNULL(@Summary,'') = '' AND NOT EXISTS (SELECT 1 FROM #tbl_ERS_Diagnoses WHERE [Value]<>'False' AND ISNULL([Value],'')<>'' AND MatrixCode <>'Summary')
	DELETE FROM ERS_RecordCount	WHERE [ProcedureId] = @ProcedureId AND [Identifier] = 'Diagnoses'
ELSE
	BEGIN
		IF NOT EXISTS (SELECT 1 FROM ERS_RecordCount WHERE [ProcedureId] = @ProcedureId AND [Identifier] = 'Diagnoses')
			INSERT INTO ERS_RecordCount ([ProcedureId], [SiteId], [Identifier], [RecordCount])
			VALUES (@ProcedureId, NULL, 'Diagnoses', 1)
	END

DROP TABLE #tbl_ERS_Diagnoses

--EXEC procedure_summary_update @procedureID

END TRY

BEGIN CATCH
       DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);
	
       IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;

GO

------------------------------------------------------------------------------------------------------------------------
-- TFS#	2232 END
-------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Siddik
-- TFS#	2539
-- Description of change: PEG outcome do not appear in the report

-- Updated by	:	Ahmed Shoud
-- TFS#	4166
-- Description of change: Abnormalities Tree Save Function

-- Updated by	:	Ahmed Shoud
-- TFS#	4498
-- Description of change: FNA and FNB wrong info can be entered
-------------------------------------------------------------------------------------------------------------------------

--Added by siddik tfs# 2541
IF EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ERS_UpperGITherapeutics' AND COLUMN_NAME = 'PyloricLeadingToPerforation' AND DATA_TYPE != 'tinyint')
BEGIN
	ALTER TABLE ERS_UpperGITherapeutics DROP CONSTRAINT DF_UpperGITherapeutics_Pyloric_LeadingToPerforation;

	ALTER TABLE ERS_UpperGITherapeutics ALTER COLUMN PyloricLeadingToPerforation TINYINT;

	ALTER TABLE ERS_UpperGITherapeutics ADD CONSTRAINT DF_UpperGITherapeutics_Pyloric_LeadingToPerforation DEFAULT 0 FOR PyloricLeadingToPerforation;
END

GO
--tfs# 2541 end

EXEC dbo.DropIfExist 
    @ObjectName = 'therapeutics_ogd_summary_update', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[therapeutics_ogd_summary_update]
(
	@TherapeuticId AS INT,
	@SiteId INT
)
AS
	SET NOCOUNT ON
	DECLARE   @msg VARCHAR(1000)
			, @msg2 VARCHAR(1000)
			, @Details VARCHAR(1000)
			, @Summary VARCHAR(4000)=''
			, @Area VARCHAR(500)=''
			, @br VARCHAR(6) = '<br />'
			, @dilatationPerforationTxt VARCHAR(30); -- TFS-3833

	DECLARE 
		@None BIT,
		@YAGLaser BIT,
		@YAGLaserWatts INT,
		@YAGLaserPulses INT,
		@YAGLaserSecs DECIMAL(8,2),
		@YAGLaserKJ DECIMAL(8,2),
		@ArgonBeamDiathermy BIT,
		@ArgonBeamDiathermyWatts INT,
		@ArgonBeamDiathermyPulses INT,
		@ArgonBeamDiathermySecs DECIMAL(8,2),
		@ArgonBeamDiathermyKJ DECIMAL(8,2),
		@BalloonDilation BIT,
		--added by mostafiz tsf:2743
		@BalloonDilationType SMALLINT,
		@BalloonDilationDiameter INT,
		@BalloonDilationDiameterUnits TINYINT,
		--added by mostafiz tsf:2743
		@BandLigation BIT,
		@BandLigationPerformed INT,
		@BandLigationSuccess INT,
		@BotoxInjection BIT,
		@EndoloopPlacement BIT,
		@HeatProbe BIT,
		@BicapElectro BIT,
		@Diathermy BIT,
		@DiathermyWatt INT,	--Mahfuz added on 30 Jul 2021
		@Coil BIT,
		@CoilQty INT,
		@CoilType INT,
		@Valve BIT,
		@ValveQty INT,
		@ValveType INT,
		@Cryotherapy BIT,
		@PhotoDynamicTherapy BIT,
		@ForeignBody BIT,
		@HotBiopsy BIT,
		@Injection BIT,
		@InjectionType INT,
		@InjectionVolume INT,
		@InjectionNumber INT,
		@OesophagealDilatation BIT,
		@DilatedTo DECIMAL(8,2), --Added by rony tfs-4085
		@DilatationUnits TINYINT,
		@DilatorType TINYINT,
		@DilatorScopePass BIT,
		@OesoDilNilByMouth BIT,
		@OesoDilNilByMouthHrs INT,
		@OesoDilXRay BIT,
		@OesoDilXRayHrs INT,
		@OesoDilSoftDiet BIT,
		@OesoDilSoftDietDays INT,
		@OesoDilWarmFluids BIT,
		@OesoDilWarmFluidsHrs INT,
		@OesoDilMedicalReview BIT,
		@OesoYAGNilByMouth BIT,
		@OesoYAGNilByMouthHrs INT,
		@OesoYAGWarmFluids BIT,
		@OesoYAGWarmFluidsHrs INT,
		@OesoYAGSoftDiet BIT,
		@OesoYAGSoftDietDays INT,
		@OesoYAGMedicalReview BIT,
		@Polypectomy BIT,
		@PolypectomyRemoval TINYINT,
		@PolypectomyRemovalType TINYINT,
		@BandingPiles BIT,
		@BandingNum INT,
		@GastrostomyInsertion BIT,
		@GastrostomyInsertionSize NUMERIC(9,2),
		@GastrostomyInsertionUnits TINYINT,
		@GastrostomyInsertionType TINYINT,
		@GastrostomyInsertionBatchNo VARCHAR(100),
		@CorrectPEGPlacement TINYINT,
		@GastrostomyPEGOutcome TINYINT,
		@PEGPlacementFailureReason VARCHAR(500),
		@NGNJInsertion BIT,
		@NGNJTubeNostril TINYINT,
		@NGNJTubeLength NUMERIC(9,2),
		@NGNJTubeBridle BIT,
		@NGNJTubeBatch VARCHAR(20),
		@NilByMouth BIT,
		@NilByMouthHrs INT,
		@NilByProc BIT,
		@NilByProcHrs INT,
		@FlangePosition NUMERIC(9,2),
		@AttachmentToWard BIT,
		@GastrostomyRemoval BIT,
		@PyloricDilatation BIT,
		@PyloricLeadingToPerforation TINYINT, --edited by siddik tfs# 2541
		@VaricealSclerotherapy BIT,
		@VaricealSclerotherapyInjectionType SMALLINT,
		@VaricealSclerotherapyInjectionVol INT,
		@VaricealSclerotherapyInjectionNum INT,
		@VaricealBanding BIT,
		@VaricealBandingNum INT,
		@VaricealClip BIT,
		@StentInsertion BIT,
		@StentInsertionQty INT,
		@StentInsertionType SMALLINT,
		@StentInsertionLength INT,
		@StentInsertionDiameter INT,
		@StentInsertionDiameterUnits TINYINT,
		@StentInsertionBatchNo VARCHAR(100),
		@CorrectStentPlacement TINYINT,
		@StentPlacementFailureReason VARCHAR(500),
		@StentRemoval BIT,
		@StentRemovalTechnique INT,
		@EMR BIT,
		@EMRType TINYINT,
		@EMRFluid INT,
		@EMRFluidVolume INT,
		@RFA BIT,
		@RFAType TINYINT,
		@RFATreatmentFrom INT,
		@RFATreatmentTo INT,
		@RFAEnergyDel INT,
		@RFANumSegTreated INT,
		@RFANumTimesSegTreated INT,
		@pHProbeInsert BIT,
		@pHProbeInsertAt INT,
		@pHProbeInsertChk BIT,
		@pHProbeInsertChkTopTo INT,
		@Haemospray BIT,
		@Sigmoidopexy BIT,
		@SigmoidopexyQty SMALLINT,
		@SigmoidopexyMake SMALLINT,
		@SigmoidopexyFluidsDays SMALLINT,
		@SigmoidopexyAntibioticsDays SMALLINT,
		@Marking BIT,
		@MarkedQuantity SMALLINT,
		@TattooLocationDistal BIT,
		@TattooLocationProximal BIT,
		@MarkingType INT,
		@Clip BIT,
		@ClipNum INT,
		@ClipSuccess  INT, --tfs 4359
		@Other VARCHAR(1000),
		@EUSProcType SMALLINT,
		@EndoClot BIT,
		@ColonicDecompression BIT,
		@FlatusTubeInsertion BIT,
		@PancolonicDyeSpray BIT,
		@BougieDilation BIT,
		@EndoscopicResection BIT,
		@FineNeedleAspiration BIT,
		@FineNeedleAspirationType TINYINT,
		@FNAPerformed INT, --tfs 2550, 2551
		@FNARetrieved INT, --tfs 2550, 2551
		@FNASuccessful INT,  --tfs 2550, 2551
		@FineNeedleBiopsy BIT,
		@FNBPerformed INT,    --tfs 2550, 2551
		@FNBRetrieved INT,   --tfs 2550, 2551
		@FNBSuccessfull INT,  --tfs 2550, 2551
		@Homeostasis BIT,
		@HomeostasisType INT,
		@Diverticulotomy BIT,
		@BicapElectroType INT, -- TFS 3209
		@GastricBalloonInsertion BIT,
		@DilatationPerforation BIT; -- TFS-3833

	IF OBJECT_ID('tempdb..#tmp_UpperGITherapeutics') IS NOT NULL
        DROP TABLE #tmp_UpperGITherapeutics;

	SELECT * INTO #tmp_UpperGITherapeutics 
	FROM dbo.[ERS_UpperGITherapeutics] 
	WHERE (Id = @TherapeuticId OR SiteID = @SiteId)

--## 1) If 'CarriedOutRole=2 (EE)' record is found for a SiteId in [ERS_UpperGITherapeutics] means it has both EE/ER Entries...
	--IF EXISTS(SELECT 'ER' FROM dbo.[ERS_UpperGITherapeutics] WHERE SiteId=@SiteId AND CarriedOutRole=2)
	--	BEGIN
			--PRINT '[ERS_UpperGITherapeutics] has both EE/ER Entries...';
			;WITH eeRecord AS (
				SELECT * FROM #tmp_UpperGITherapeutics WHERE CarriedOutRole = (SELECT MAX(CarriedOutRole) FROM #tmp_UpperGITherapeutics) --## 2 is EE
				--WHERE SiteId=@SiteId AND CarriedOutRole=2
			)
			SELECT
				@None							= (CASE WHEN ISNULL(ER.[None], 0) = 0 THEN EE.[None] ELSE ER.[None] END),
				@YAGLaser						= (CASE WHEN ISNULL(ER.[YAGLaser], 0) = 0 THEN EE.[YAGLaser] ELSE ER.[YAGLaser] END),
				@YAGLaserWatts					= (CASE WHEN ISNULL(ER.[YAGLaserWatts], 0) = 0 THEN EE.[YAGLaserWatts] ELSE ER.[YAGLaserWatts] END),
				@YAGLaserPulses					= (CASE WHEN ISNULL(ER.[YAGLaserPulses], 0) = 0 THEN EE.[YAGLaserPulses] ELSE ER.[YAGLaserPulses] END),
				@YAGLaserSecs					= (CASE WHEN ISNULL(ER.[YAGLaserSecs], 0) = 0 THEN EE.[YAGLaserSecs] ELSE ER.[YAGLaserSecs] END),
				@YAGLaserKJ						= (CASE WHEN ISNULL(ER.[YAGLaserKJ], 0) = 0 THEN EE.[YAGLaserKJ] ELSE ER.[YAGLaserKJ] END),
				@ArgonBeamDiathermy				= (CASE WHEN ISNULL(ER.[ArgonBeamDiathermy], 0) = 0 THEN EE.[ArgonBeamDiathermy] ELSE ER.[ArgonBeamDiathermy] END),
				@ArgonBeamDiathermyWatts		= (CASE WHEN ISNULL(ER.[ArgonBeamDiathermyWatts], 0) = 0 THEN EE.[ArgonBeamDiathermyWatts] ELSE ER.[ArgonBeamDiathermyWatts] END),
				@ArgonBeamDiathermyPulses		= (CASE WHEN ISNULL(ER.[ArgonBeamDiathermyPulses], 0) = 0 THEN EE.[ArgonBeamDiathermyPulses] ELSE ER.[ArgonBeamDiathermyPulses] END),
				@ArgonBeamDiathermySecs			= (CASE WHEN ISNULL(ER.[ArgonBeamDiathermySecs], 0) = 0 THEN EE.[ArgonBeamDiathermySecs] ELSE ER.[ArgonBeamDiathermySecs] END),
				@ArgonBeamDiathermyKJ			= (CASE WHEN ISNULL(ER.[ArgonBeamDiathermyKJ], 0) = 0 THEN EE.[ArgonBeamDiathermyKJ] ELSE ER.[ArgonBeamDiathermyKJ] END),
				@BalloonDilation				= (CASE WHEN ISNULL(ER.[BalloonDilation], 0) = 0 THEN EE.[BalloonDilation] ELSE ER.[BalloonDilation] END),
				--added by mostafiz tsf:2743
				@BalloonDilationType			= (CASE WHEN IsNull(ER.[BalloonDilationType], 0) = 0 THEN EE.[BalloonDilationType] ELSE ER.[BalloonDilationType] END),
				@BalloonDilationDiameter		= (CASE WHEN IsNull(ER.[BalloonDilationDiameter], 0) = 0 THEN EE.[BalloonDilationDiameter] ELSE ER.[BalloonDilationDiameter] END),
				@BalloonDilationDiameterUnits	= (CASE WHEN IsNull(ER.[BalloonDilationDiameterUnits], 0) = 0 THEN EE.[BalloonDilationDiameterUnits] ELSE ER.[BalloonDilationDiameterUnits] END),
				--added by mostafiz tsf:2743
				@BandLigation					= (CASE WHEN ISNULL(ER.[BandLigation], 0) = 0 THEN EE.[BandLigation] ELSE ER.[BandLigation] END),
				@BandLigationPerformed			= (CASE WHEN ISNULL(ER.[BandLigationPerformed], 0) = 0 THEN EE.[BandLigationPerformed] ELSE ER.[BandLigationPerformed] END),
				@BandLigationSuccess			= (CASE WHEN ISNULL(ER.[BandLigationSuccessful], 0) = 0 THEN EE.[BandLigationSuccessful] ELSE ER.[BandLigationSuccessful] END),
				@BotoxInjection					= (CASE WHEN ISNULL(ER.[BotoxInjection], 0) = 0 THEN EE.[BotoxInjection] ELSE ER.[BotoxInjection] END),
				@EndoloopPlacement				= (CASE WHEN ISNULL(ER.[EndoloopPlacement], 0) = 0 THEN EE.[EndoloopPlacement] ELSE ER.[EndoloopPlacement] END),
				@HeatProbe						= (CASE WHEN ISNULL(ER.[HeatProbe], 0) = 0 THEN EE.[HeatProbe] ELSE ER.[HeatProbe] END),
				@BicapElectro					= (CASE WHEN ISNULL(ER.[BicapElectro], 0) = 0 THEN EE.[BicapElectro] ELSE ER.[BicapElectro] END),
				@Diathermy						= (CASE WHEN ISNULL(ER.[Diathermy], 0) = 0 THEN EE.[Diathermy] ELSE ER.[Diathermy] END),
				@DiathermyWatt					= (CASE WHEN ISNULL(ER.[DiathermyWatt], 0) = 0 THEN EE.[DiathermyWatt] ELSE ER.[DiathermyWatt] END),  
				@Coil							= (CASE WHEN ISNULL(ER.[Coil], 0) = 0 THEN EE.[Coil] ELSE ER.[Coil] END),
				@CoilQty						= (CASE WHEN ISNULL(ER.[CoilQty], 0) = 0 THEN EE.[CoilQty] ELSE ER.[CoilQty] END),
				@CoilType						= (CASE WHEN ISNULL(ER.[CoilType], 0) = 0 THEN EE.[CoilType] ELSE ER.[CoilType] END),
				@Valve							= (CASE WHEN ISNULL(ER.[Valve], 0) = 0 THEN EE.[Valve] ELSE ER.[Valve] END),
				@ValveQty						= (CASE WHEN ISNULL(ER.[ValveQty], 0) = 0 THEN EE.[ValveQty] ELSE ER.[ValveQty] END),
				@ValveType						= (CASE WHEN ISNULL(ER.[ValveType], 0) = 0 THEN EE.[ValveType] ELSE ER.[ValveType] END),
				@Cryotherapy					= (CASE WHEN ISNULL(ER.[Cryotherapy], 0) = 0 THEN EE.[Cryotherapy] ELSE ER.[Cryotherapy] END),
				@PhotoDynamicTherapy			= (CASE WHEN ISNULL(ER.[PhotoDynamicTherapy], 0) = 0 THEN EE.[PhotoDynamicTherapy] ELSE ER.[PhotoDynamicTherapy] END),
				@ForeignBody					= (CASE WHEN ISNULL(ER.[ForeignBody], 0) = 0 THEN EE.[ForeignBody] ELSE ER.[ForeignBody] END),
				@HotBiopsy						= (CASE WHEN ISNULL(ER.[HotBiopsy], 0) = 0 THEN EE.[HotBiopsy] ELSE ER.[HotBiopsy] END),
				@Injection						= (CASE WHEN ISNULL(ER.[Injection], 0) = 0 THEN EE.[Injection] ELSE ER.[Injection] END),
				@InjectionType					= (CASE WHEN ISNULL(ER.[InjectionType], 0) = 0 THEN EE.[InjectionType] ELSE ER.[InjectionType] END),
				@InjectionVolume				= (CASE WHEN ISNULL(ER.[InjectionVolume], 0) = 0 THEN EE.[InjectionVolume] ELSE ER.[InjectionVolume] END),
				@InjectionNumber				= (CASE WHEN ISNULL(ER.[InjectionNumber], 0) = 0 THEN EE.[InjectionNumber] ELSE ER.[InjectionNumber] END),
				@OesophagealDilatation			= (CASE WHEN ISNULL(ER.[OesophagealDilatation], 0) = 0 THEN EE.[OesophagealDilatation] ELSE ER.[OesophagealDilatation] END),
				@DilatedTo						= (CASE WHEN ISNULL(ER.[DilatedTo], 0) = 0 THEN EE.[DilatedTo] ELSE ER.[DilatedTo] END),
				@DilatationUnits				= (CASE WHEN ISNULL(ER.[DilatationUnits], 0) = 0 THEN EE.[DilatationUnits] ELSE ER.[DilatationUnits] END),
				@DilatorType					= (CASE WHEN ISNULL(ER.[DilatorType], 0) = 0 THEN EE.[DilatorType] ELSE ER.[DilatorType] END),
				@DilatorScopePass				= (CASE WHEN ISNULL(ER.[DilatorScopePass], 0) = 0 THEN EE.[DilatorScopePass] ELSE ER.[DilatorScopePass] END),
				@OesoDilNilByMouth				= (CASE WHEN ISNULL(ER.[OesoDilNilByMouth], 0) = 0 THEN EE.[OesoDilNilByMouth] ELSE ER.[OesoDilNilByMouth] END),
				@OesoDilNilByMouthHrs			= (CASE WHEN ISNULL(ER.[OesoDilNilByMouthHrs], 0) = 0 THEN EE.[OesoDilNilByMouthHrs] ELSE ER.[OesoDilNilByMouthHrs] END),
				@OesoDilXRay					= (CASE WHEN ISNULL(ER.[OesoDilXRay], 0) = 0 THEN EE.[OesoDilXRay] ELSE ER.[OesoDilXRay] END),
				@OesoDilXRayHrs					= (CASE WHEN ISNULL(ER.[OesoDilXRayHrs], 0) = 0 THEN EE.[OesoDilXRayHrs] ELSE ER.[OesoDilXRayHrs] END),
				@OesoDilSoftDiet				= (CASE WHEN ISNULL(ER.[OesoDilSoftDiet], 0) = 0 THEN EE.[OesoDilSoftDiet] ELSE ER.[OesoDilSoftDiet] END),
				@OesoDilSoftDietDays			= (CASE WHEN ISNULL(ER.[OesoDilSoftDietDays], 0) = 0 THEN EE.[OesoDilSoftDietDays] ELSE ER.[OesoDilSoftDietDays] END),
				@OesoDilWarmFluids				= (CASE WHEN ISNULL(ER.[OesoDilWarmFluids], 0) = 0 THEN EE.[OesoDilWarmFluids] ELSE ER.[OesoDilWarmFluids] END),
				@OesoDilWarmFluidsHrs			= (CASE WHEN ISNULL(ER.[OesoDilWarmFluidsHrs], 0) = 0 THEN EE.[OesoDilWarmFluidsHrs] ELSE ER.[OesoDilWarmFluidsHrs] END),
				@OesoDilMedicalReview			= (CASE WHEN ISNULL(ER.[OesoDilMedicalReview], 0) = 0 THEN EE.[OesoDilMedicalReview] ELSE ER.[OesoDilMedicalReview] END),
				@OesoYAGNilByMouth				= (CASE WHEN IsNull(ER.[OesoYAGNilByMouth], 0) = 0 THEN EE.[OesoYAGNilByMouth] ELSE ER.[OesoYAGNilByMouth] END),
				@OesoYAGNilByMouthHrs			= (CASE WHEN IsNull(ER.[OesoYAGNilByMouthHrs], 0) = 0 THEN EE.[OesoYAGNilByMouthHrs] ELSE ER.[OesoYAGNilByMouthHrs] END),
				@OesoYAGWarmFluids				= (CASE WHEN IsNull(ER.[OesoYAGWarmFluids], 0) = 0 THEN EE.[OesoYAGWarmFluids] ELSE ER.[OesoYAGWarmFluids] END),
				@OesoYAGWarmFluidsHrs			= (CASE WHEN IsNull(ER.[OesoYAGWarmFluidsHrs], 0) = 0 THEN EE.[OesoYAGWarmFluidsHrs] ELSE ER.[OesoYAGWarmFluidsHrs] END),
				@OesoYAGSoftDiet				= (CASE WHEN IsNull(ER.[OesoYAGSoftDiet], 0) = 0 THEN EE.[OesoYAGSoftDiet] ELSE ER.[OesoYAGSoftDiet] END),
				@OesoYAGSoftDietDays			= (CASE WHEN IsNull(ER.[OesoYAGSoftDietDays], 0) = 0 THEN EE.[OesoYAGSoftDietDays] ELSE ER.[OesoYAGSoftDietDays] END),
				@OesoYAGMedicalReview			= (CASE WHEN IsNull(ER.[OesoYAGMedicalReview], 0) = 0 THEN EE.[OesoYAGMedicalReview] ELSE ER.[OesoYAGMedicalReview] END),
				@Polypectomy					= (CASE WHEN IsNull(ER.[Polypectomy], 0) = 0 THEN EE.[Polypectomy] ELSE ER.[Polypectomy] END),
				@PolypectomyRemoval				= (CASE WHEN IsNull(ER.[PolypectomyRemoval], 0) = 0 THEN EE.[PolypectomyRemoval] ELSE ER.[PolypectomyRemoval] END),
				@PolypectomyRemovalType			= (CASE WHEN IsNull(ER.[PolypectomyRemovalType], 0) = 0 THEN EE.[PolypectomyRemovalType] ELSE ER.[PolypectomyRemovalType] END),
				@BandingPiles					= (CASE WHEN IsNull(ER.BandingPiles, 0) = 0 THEN EE.BandingPiles ELSE ER.BandingPiles END),
				@BandingNum						= (CASE WHEN IsNull(ER.BandingNum, 0) = 0 THEN EE.BandingNum ELSE ER.BandingNum END),
				@GastrostomyInsertion			= (CASE WHEN IsNull(ER.[GastrostomyInsertion], 0) = 0 THEN EE.[GastrostomyInsertion] ELSE ER.[GastrostomyInsertion] END),
				@GastrostomyInsertionSize		= (CASE WHEN IsNull(ER.[GastrostomyInsertionSize], 0) = 0 THEN EE.[GastrostomyInsertionSize] ELSE ER.[GastrostomyInsertionSize] END),
				@GastrostomyInsertionUnits		= (CASE WHEN IsNull(ER.[GastrostomyInsertionUnits], 0) = 0 THEN EE.[GastrostomyInsertionUnits] ELSE ER.[GastrostomyInsertionUnits] END),
				@GastrostomyInsertionType		= (CASE WHEN IsNull(ER.[GastrostomyInsertionType], 0) = 0 THEN EE.[GastrostomyInsertionType] ELSE ER.[GastrostomyInsertionType] END),
				@GastrostomyInsertionBatchNo	= (SELECT isnull((CASE WHEN IsNull(ER.[GastrostomyInsertionBatchNo], '') = '' THEN EE.[GastrostomyInsertionBatchNo] ELSE ER.[GastrostomyInsertionBatchNo] END), '') as [text()] FOR XML PATH('')),
				@CorrectPEGPlacement			= (CASE WHEN IsNull(ER.[CorrectPEGPlacement], 0) = 0 THEN EE.[CorrectPEGPlacement] ELSE ER.[CorrectPEGPlacement] END),
				@GastrostomyPEGOutcome			= (CASE WHEN IsNull(ER.[GastrostomyPEGOutcome], 0) = 0 THEN EE.[GastrostomyPEGOutcome] ELSE ER.[GastrostomyPEGOutcome] END),
				@PEGPlacementFailureReason		= (SELECT isnull((CASE WHEN IsNull(ER.[PEGPlacementFailureReason], '') = '' THEN EE.[PEGPlacementFailureReason] ELSE ER.[PEGPlacementFailureReason] END), '') as [text()] FOR XML PATH('')),
				@NGNJInsertion 					= (CASE WHEN IsNull(ER.NGNJTubeInsertion, 0) = 0 THEN EE.NGNJTubeInsertion ELSE ER.NGNJTubeInsertion END),
				@NGNJTubeNostril				= (CASE WHEN IsNull(ER.NGNJTubeNostril, 0) = 0 THEN EE.NGNJTubeNostril ELSE ER.NGNJTubeNostril END),
				@NGNJTubeLength					= (CASE WHEN IsNull(ER.NGNJTubeLength, 0) = 0 THEN EE.NGNJTubeLength ELSE ER.NGNJTubeLength END),
				@NGNJTubeBridle					= (CASE WHEN IsNull(ER.NGNJTubeBridle, 0) = 0 THEN EE.NGNJTubeBridle ELSE ER.NGNJTubeBridle END),
				@NGNJTubeBatch					= (CASE WHEN IsNull(ER.NGNJTubeBatch, '') = '' THEN EE.NGNJTubeBatch ELSE ER.NGNJTubeBatch END),
				@NilByMouth						= (CASE WHEN IsNull(ER.[NilByMouth], 0) = 0 THEN EE.[NilByMouth] ELSE ER.[NilByMouth] END),
				@NilByMouthHrs					= (CASE WHEN IsNull(ER.[NilByMouthHrs], 0) = 0 THEN EE.[NilByMouthHrs] ELSE ER.[NilByMouthHrs] END),
				@NilByProc						= (CASE WHEN IsNull(ER.[NilByProc], 0) = 0 THEN EE.[NilByProc] ELSE ER.[NilByProc] END),
				@NilByProcHrs					= (CASE WHEN IsNull(ER.[NilByProcHrs], 0) = 0 THEN EE.[NilByProcHrs] ELSE ER.[NilByProcHrs] END),
				@FlangePosition					= (CASE WHEN IsNull(ER.[FlangePosition], 0) = 0 THEN EE.[FlangePosition] ELSE ER.[FlangePosition] END),
				@AttachmentToWard				= (CASE WHEN IsNull(ER.[AttachmentToWard], 0) = 0 THEN EE.[AttachmentToWard] ELSE ER.[AttachmentToWard] END),
				@GastrostomyRemoval				= (CASE WHEN IsNull(ER.[GastrostomyRemoval], 0) = 0 THEN EE.[GastrostomyRemoval] ELSE ER.[GastrostomyRemoval] END),
				@PyloricDilatation				= (CASE WHEN IsNull(ER.[PyloricDilatation], 0) = 0 THEN EE.[PyloricDilatation] ELSE ER.[PyloricDilatation] END),
				@PyloricLeadingToPerforation	= (CASE WHEN IsNull(ER.[PyloricLeadingToPerforation], 0) = 0 THEN EE.[PyloricLeadingToPerforation] ELSE ER.[PyloricLeadingToPerforation] END),	--edited by siddik tfs# 2541
				@VaricealSclerotherapy			= (CASE WHEN IsNull(ER.[VaricealSclerotherapy], 0) = 0 THEN EE.[VaricealSclerotherapy] ELSE ER.[VaricealSclerotherapy] END),
				@VaricealSclerotherapyInjectionType = (CASE WHEN IsNull(ER.[VaricealSclerotherapyInjectionType], 0) = 0 THEN EE.[VaricealSclerotherapyInjectionType] ELSE ER.[VaricealSclerotherapyInjectionType] END),
				@VaricealSclerotherapyInjectionVol  = (CASE WHEN IsNull(ER.[VaricealSclerotherapyInjectionVol], 0) = 0 THEN EE.[VaricealSclerotherapyInjectionVol] ELSE ER.[VaricealSclerotherapyInjectionVol] END),
				@VaricealSclerotherapyInjectionNum  = (CASE WHEN IsNull(ER.[VaricealSclerotherapyInjectionNum], 0) = 0 THEN EE.[VaricealSclerotherapyInjectionNum] ELSE ER.[VaricealSclerotherapyInjectionNum] END),
				@VaricealBanding				= (CASE WHEN IsNull(ER.[VaricealBanding], 0) = 0 THEN EE.[VaricealBanding] ELSE ER.[VaricealBanding] END),
				@VaricealBandingNum				= (CASE WHEN IsNull(ER.[VaricealBandingNum], 0) = 0 THEN EE.[VaricealBandingNum] ELSE ER.[VaricealBandingNum] END),
				@VaricealClip					= (CASE WHEN IsNull(ER.[VaricealClip], 0) = 0 THEN EE.[VaricealClip] ELSE ER.[VaricealClip] END),
				@StentInsertion					= (CASE WHEN IsNull(ER.[StentInsertion], 0) = 0 THEN EE.[StentInsertion] ELSE ER.[StentInsertion] END),
				@StentInsertionQty				= (CASE WHEN IsNull(ER.[StentInsertionQty], 0) = 0 THEN EE.[StentInsertionQty] ELSE ER.[StentInsertionQty] END),
				@StentInsertionType				= (CASE WHEN IsNull(ER.[StentInsertionType], 0) = 0 THEN EE.[StentInsertionType] ELSE ER.[StentInsertionType] END),
				@StentInsertionLength			= (CASE WHEN IsNull(ER.[StentInsertionLength], 0) = 0 THEN EE.[StentInsertionLength] ELSE ER.[StentInsertionLength] END),
				@StentInsertionDiameter			= (CASE WHEN IsNull(ER.[StentInsertionDiameter], 0) = 0 THEN EE.[StentInsertionDiameter] ELSE ER.[StentInsertionDiameter] END),
				@StentInsertionDiameterUnits	= (CASE WHEN IsNull(ER.[StentInsertionDiameterUnits], 0) = 0 THEN EE.[StentInsertionDiameterUnits] ELSE ER.[StentInsertionDiameterUnits] END),
				@StentInsertionBatchNo			= (CASE WHEN IsNull(ER.[StentInsertionBatchNo], '') = '' THEN EE.[StentInsertionBatchNo] ELSE ER.[StentInsertionBatchNo] END),
				@CorrectStentPlacement			= (CASE WHEN IsNull(ER.[CorrectStentPlacement], 0) = 0 THEN EE.[CorrectStentPlacement] ELSE ER.[CorrectStentPlacement] END),
				@StentPlacementFailureReason	= (SELECT isnull((CASE WHEN IsNull(ER.[StentPlacementFailureReason], '') = '' THEN EE.[StentPlacementFailureReason] ELSE ER.[StentPlacementFailureReason] END), '') as [text()] FOR XML PATH('')),
				@StentRemoval					= (CASE WHEN IsNull(ER.[StentRemoval], 0) = 0 THEN EE.[StentRemoval] ELSE ER.[StentRemoval] END),
				@StentRemovalTechnique			= (CASE WHEN IsNull(ER.[StentRemovalTechnique], 0) = 0 THEN EE.[StentRemovalTechnique] ELSE ER.[StentRemovalTechnique] END),
				@EMR							= (CASE WHEN IsNull(ER.[EMR], 0) = 0 THEN EE.[EMR] ELSE ER.[EMR] END),
				@EMRType						= (CASE WHEN IsNull(ER.[EMRType], 0) = 0 THEN EE.[EMRType] ELSE ER.[EMRType] END),
				@EMRFluid						= (CASE WHEN IsNull(ER.[EMRFluid], 0) = 0 THEN EE.[EMRFluid] ELSE ER.[EMRFluid] END),
				@EMRFluidVolume					= (CASE WHEN IsNull(ER.[EMRFluidVolume], 0) = 0 THEN EE.[EMRFluidVolume] ELSE ER.[EMRFluidVolume] END),
				@RFA							= (CASE WHEN IsNull(ER.[RFA], 0) = 0 THEN EE.[RFA] ELSE ER.[RFA] END),
				@RFAType						= (CASE WHEN IsNull(ER.[RFAType], 0) = 0 THEN EE.[RFAType] ELSE ER.[RFAType] END),
				@RFATreatmentFrom				= (CASE WHEN IsNull(ER.[RFATreatmentFrom], 0) = 0 THEN EE.[RFATreatmentFrom] ELSE ER.[RFATreatmentFrom] END),				
				@RFATreatmentTo					= (CASE WHEN IsNull(ER.[RFATreatmentTo], 0) = 0 THEN EE.[RFATreatmentTo] ELSE ER.[RFATreatmentTo] END),				
				@RFAEnergyDel					= (CASE WHEN IsNull(ER.[RFAEnergyDel], 0) = 0 THEN EE.[RFAEnergyDel] ELSE ER.[RFAEnergyDel] END),
				@RFANumSegTreated				= (CASE WHEN IsNull(ER.[RFANumSegTreated], 0) = 0 THEN EE.[RFANumSegTreated] ELSE ER.[RFANumSegTreated] END),
				@RFANumTimesSegTreated			= (CASE WHEN IsNull(ER.[RFANumTimesSegTreated], 0) = 0 THEN EE.[RFANumTimesSegTreated] ELSE ER.[RFANumTimesSegTreated] END),
				@pHProbeInsert					= (CASE WHEN IsNull(ER.[pHProbeInsert], 0) = 0 THEN EE.[pHProbeInsert] ELSE ER.[pHProbeInsert] END),
				@pHProbeInsertAt				= (CASE WHEN IsNull(ER.[pHProbeInsertAt], 0) = 0 THEN EE.[pHProbeInsertAt] ELSE ER.[pHProbeInsertAt] END),
				@pHProbeInsertChk				= (CASE WHEN IsNull(ER.[pHProbeInsertChk], 0) = 0 THEN EE.[pHProbeInsertChk] ELSE ER.[pHProbeInsertChk] END),
				@pHProbeInsertChkTopTo			= (CASE WHEN IsNull(ER.[pHProbeInsertChkTopTo], 0) = 0 THEN EE.[pHProbeInsertChkTopTo] ELSE ER.[pHProbeInsertChkTopTo] END),
				@Haemospray						= (CASE WHEN IsNull(ER.[Haemospray], 0) = 0 THEN EE.[Haemospray] ELSE ER.[Haemospray] END),
				@Sigmoidopexy					= (CASE WHEN IsNull(ER.[Sigmoidopexy], 0) = 0 THEN EE.[Sigmoidopexy] ELSE ER.[Sigmoidopexy] END),
				@SigmoidopexyQty				= (CASE WHEN IsNull(ER.[SigmoidopexyQty], 0) = 0 THEN EE.[SigmoidopexyQty] ELSE ER.[SigmoidopexyQty] END),
				@SigmoidopexyMake				= (CASE WHEN IsNull(ER.[SigmoidopexyMake], 0) = 0 THEN EE.[SigmoidopexyMake] ELSE ER.[SigmoidopexyMake] END),
				@SigmoidopexyFluidsDays			= (CASE WHEN IsNull(ER.[SigmoidopexyFluidsDays], 0) = 0 THEN EE.[SigmoidopexyFluidsDays] ELSE ER.[SigmoidopexyFluidsDays] END),
				@SigmoidopexyAntibioticsDays	= (CASE WHEN IsNull(ER.[SigmoidopexyAntibioticsDays], 0) = 0 THEN EE.[SigmoidopexyAntibioticsDays] ELSE ER.[SigmoidopexyAntibioticsDays] END),
				@Marking						= (CASE WHEN IsNull(ER.[Marking], 0) = 0 THEN EE.[Marking] ELSE ER.[Marking] END),
				--MH added on 19 Oct 2021
				--MH added on 19 Oct 2021 - later changed on 26 Nov 2021
				@TattooLocationDistal      = (CASE WHEN IsNull(ER.[TattooLocationDistal], 0) = 0 THEN EE.[TattooLocationDistal] ELSE ER.[TattooLocationDistal] END), 
				@TattooLocationProximal      = (CASE WHEN IsNull(ER.[TattooLocationProximal], 0) = 0 THEN EE.[TattooLocationProximal] ELSE ER.[TattooLocationProximal] END), 

				--MH added on 20 Oct 2021
				@MarkedQuantity    = (CASE WHEN IsNull(ER.[MarkedQuantity], 0) = 0 THEN EE.[MarkedQuantity] ELSE ER.[MarkedQuantity] END), 

				@MarkingType					= (CASE WHEN IsNull(ER.[MarkingType], 0) = 0 THEN EE.[MarkingType] ELSE ER.[MarkingType] END),
				@Clip							= (CASE WHEN IsNull(ER.[Clip], 0) = 0 THEN EE.[Clip] ELSE ER.[Clip] END),
				@ClipNum						= (CASE WHEN IsNull(ER.[ClipNum], 0) = 0 THEN EE.[ClipNum] ELSE ER.[ClipNum] END),
				@ClipSuccess                    = (CASE WHEN ISNULL(ER.ClipNumSuccess, 0) = 0 THEN EE.ClipNumSuccess ELSE ER.ClipNumSuccess END),	--tfs 4359
				@Other							= (SELECT isnull((CASE WHEN IsNull(ER.[Other], '') = '' THEN EE.[Other] ELSE ER.[Other] END), '') as [text()] FOR XML PATH('')),
				@EUSProcType					= (CASE WHEN IsNull(ER.[EUSProcType], 0) = 0 THEN EE.[EUSProcType] ELSE ER.[EUSProcType] END),
				@EndoClot						= (CASE WHEN IsNull(ER.[EndoClot], 0) = 0 THEN EE.[EndoClot] ELSE ER.[EndoClot] END),
				@ColonicDecompression			= (CASE WHEN IsNull(ER.[ColonicDecompression], 0) = 0 THEN EE.[ColonicDecompression] ELSE ER.[ColonicDecompression] END),
				@FlatusTubeInsertion			= (CASE WHEN IsNull(ER.[FlatusTubeInsertion], 0) = 0 THEN EE.[FlatusTubeInsertion] ELSE ER.[FlatusTubeInsertion] END),
				@PancolonicDyeSpray				= (CASE WHEN IsNull(ER.[PancolonicDyeSpray], 0) = 0 THEN EE.[PancolonicDyeSpray] ELSE ER.[PancolonicDyeSpray] END),
				@BougieDilation					= (CASE WHEN IsNull(ER.[BougieDilation], 0) = 0 THEN EE.[BougieDilation] ELSE ER.[BougieDilation] END),
				@EndoscopicResection			= (CASE WHEN IsNull(ER.[EndoscopicResection], 0) = 0 THEN EE.[EndoscopicResection] ELSE ER.[EndoscopicResection] END),
				@FineNeedleAspiration		    = (CASE WHEN IsNull(ER.FineNeedleAspiration, 0) = 0 THEN EE.FineNeedleAspiration ELSE ER.FineNeedleAspiration END),
				@FineNeedleAspirationType	    = (CASE WHEN IsNull(ER.FineNeedleAspirationType, 0) = 0 THEN EE.FineNeedleAspirationType ELSE ER.FineNeedleAspirationType END),
				@FineNeedleBiopsy			    = (CASE WHEN IsNull(ER.FineNeedleBiopsy, 0) = 0 THEN EE.FineNeedleBiopsy ELSE ER.FineNeedleBiopsy END),
				@Homeostasis					= (CASE WHEN ISNULL(ER.[Homeostasis], 0) = 0 THEN EE.[Homeostasis] ELSE ER.[Homeostasis] END),
				@HomeostasisType				= (CASE WHEN ISNULL(ER.[HomeostasisType], 0) = 0 THEN EE.[HomeostasisType] ELSE ER.[HomeostasisType] END),
				@Diverticulotomy				= (CASE WHEN ISNULL(ER.[Diverticulotomy], 0) = 0 THEN EE.[Diverticulotomy] ELSE ER.[Diverticulotomy] END),
				@GastricBalloonInsertion		= ISNULL(EE.[GastricBalloonInsertion], 0),
				@BicapElectroType			= (CASE WHEN ISNULL(ER.[BicapElectroType], 0) = 0 THEN EE.[BicapElectroType] ELSE ER.[BicapElectroType] END), -- TFS 3209
				@DilatationPerforation		= ISNULL(ER.DilatationPerforation, 0), -- TFS-3833
				@FNAPerformed					= (CASE WHEN IsNull(ER.[FNAPerformed], 0) = 0 THEN EE.[FNAPerformed] ELSE ER.[FNAPerformed] END), --tfs 2550, 2551
				@FNASuccessful					= (CASE WHEN IsNull(ER.[FNASuccessful], 0) = 0 THEN EE.[FNASuccessful] ELSE ER.[FNASuccessful] END), --tfs 2550, 2551
				@FNARetrieved					= (CASE WHEN IsNull(ER.[FNARetreived], 0) = 0 THEN EE.[FNARetreived] ELSE ER.[FNARetreived] END), --tfs 2550, 2551
				@FNBPerformed					= (CASE WHEN IsNull(ER.[FNBPerformed], 0) = 0 THEN EE.[FNBPerformed] ELSE ER.[FNBPerformed] END), --tfs 2550, 2551
				@FNBSuccessfull					= (CASE WHEN IsNull(ER.[FNBSuccessful], 0) = 0 THEN EE.[FNBSuccessful] ELSE ER.[FNBSuccessful] END), --tfs 2550, 2551
				@FNBRetrieved					= (CASE WHEN IsNull(ER.[FNBRetreived], 0) = 0 THEN EE.[FNBRetreived] ELSE ER.[FNBRetreived] END) --tfs 2550, 2551
			FROM eeRecord AS EE
	  INNER JOIN #tmp_UpperGITherapeutics AS ER ON EE.SiteId = ER.SiteId

	 
	 
	SELECT @Area = m.Area FROM dbo.ERS_AbnormalitiesMatrixUpperGI m LEFT JOIN dbo.ERS_Regions r ON m.Region = r.Region LEFT JOIN dbo.ERS_Sites s ON r.RegionId  = s.RegionID  WHERE s.siteId = @SiteId;
	
	IF @None = 1
		SET @summary = @summary + 'No therapeutic procedures'
	ELSE
	BEGIN

	
------------------------------------------------------------------------------------------------------------------------
-- TFS#	No TFS - Item 4072
-- clip added
------------------------------------------------------------------------------------------------------------------------

	   IF @Clip = 1
			BEGIN
			SET @msg =' Clip :'

			--tfs 4359 started
			IF @ClipNum > 0 SET @msg = @msg + ' performed ' + CAST(@ClipNum AS VARCHAR(100)) + CASE WHEN @ClipNum = 1 THEN ' procedure' ELSE ' procedures' END
			IF @ClipNum > 0 AND @ClipSuccess > 0 SET @msg = @msg + ' and ' + CAST(@ClipSuccess AS VARCHAR(100)) + CASE WHEN @ClipNum = 1 THEN ' was successful.' ELSE ' were successful.' END 
				ELSE IF @ClipNum = 0 AND @ClipSuccess > 0 SET @msg = @msg + ' ' + CAST(@ClipSuccess AS VARCHAR(100)) + CASE WHEN @ClipNum = 1 THEN ' procedure was successful.' ELSE ' procedures were successful.' END 
			--tfs 4359 ended
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			SET @summary = @summary + @msg + @br	
	    	END			
------------------------------------------------------------------------------------------------------------------------
-- END TFS#	No TFS - Item 4072
------------------------------------------------------------------------------------------------------------------------
		IF @YAGLaser = 1
			BEGIN
			SET @msg =' YAG Laser'
			SET @Details = ''
			IF @YAGLaserWatts > 0 SET @Details = @Details + ' ' + CAST(@YAGLaserWatts as varchar(50)) + 'W'
			IF @YAGLaserSecs > 0 SET @Details = @Details + ' for ' + cast(CAST(@YAGLaserSecs AS FLOAT) as varchar(50)) + CASE WHEN @YAGLaserSecs <= 1 THEN ' second' else ' seconds' END
			IF @YAGLaserPulses > 0 SET @Details = @Details + ' in ' + cast(@YAGLaserPulses as varchar(50)) + CASE WHEN @YAGLaserPulses <= 1 THEN ' pulse' else ' pulses' END
			IF @YAGLaserKJ > 0 SET @Details = @Details + ' ('+ cast(CAST(@YAGLaserKJ AS FLOAT) as varchar(50)) + 'kJ)'
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + @br
			END
		
		IF @ArgonBeamDiathermy= 1
			BEGIN
			SET @msg ='  Argon beam diathermy'
			SET @Details = ''
			IF @ArgonBeamDiathermyWatts > 0 SET @Details = @Details + ' ' + cast(@ArgonBeamDiathermyWatts as varchar(50)) + 'W'
			IF @ArgonBeamDiathermySecs > 0 SET @Details = @Details + ' for ' + cast(CAST(@ArgonBeamDiathermySecs AS FLOAT) as varchar(50)) + CASE WHEN @ArgonBeamDiathermySecs <= 1 THEN ' second' else ' seconds' END
			IF @ArgonBeamDiathermyPulses > 0 SET @Details = @Details + ' in ' + cast(@ArgonBeamDiathermyPulses as varchar(50)) + CASE WHEN @ArgonBeamDiathermyPulses <= 1 THEN ' pulse' else ' pulses' END
			IF @ArgonBeamDiathermyKJ > 0 SET @Details = @Details + ' ('+ cast(CAST(@ArgonBeamDiathermyKJ AS FLOAT) as varchar(50)) + 'kJ)'
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
			END

			
		IF @Injection= 1
			BEGIN
			SET @msg =' Injection therapy'
			SET @Details = ''
			IF @InjectionVolume > 0 SET @Details = @Details + '  ' + cast(@InjectionVolume as varchar(50)) + 'ml'
			IF @InjectionVolume > 0  AND @InjectionType > 0 SET @Details = @Details + ' of'
			IF @InjectionType > 0 SET @Details = @Details + ' ' +   (SELECT [ListItemText] FROM dbo.ERS_Lists WHERE ListDescription = 'Agent Upper GI' AND [ListItemNo] = @InjectionType)
			IF @InjectionVolume> 0  AND @InjectionNumber > 0 SET @Details = @Details + ' via'
			IF @InjectionNumber >0 SET @Details = @Details + ' ' + CASE WHEN @InjectionNumber > 1 THEN cast(@InjectionNumber as varchar(50)) + ' injections' ELSE cast(@InjectionNumber as varchar(50)) + ' injection' END
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
	    IF @Homeostasis = 1
			BEGIN
			SET @msg =' Haemostasis'
			SET @Details = ''
			IF @HomeostasisType > 0 SET @Details = @Details + ' ' +   (SELECT [ListItemText] FROM dbo.ERS_Lists WHERE ListDescription = 'Homeostasis' AND [ListItemNo] = @HomeostasisType)
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
	
		IF @Polypectomy= 1  
			BEGIN
			SET @msg =' Polypectomy'
			SET @Details = ''
			DECLARE @Se bit, @SeExcised int, @Pe bit, @PeExcised int, @Su bit, @SuExcised int, @countExcised int = 0
			SELECT @Se = [Sessile],@SeExcised =[SessileNumExcised], @Pe = [Pedunculated], @PeExcised= [PedunculatedNumExcised], @Su =[Submucosal], @SuExcised = [SubmucosalNumExcised] FROM [ERS_UpperGIAbnoPolyps] WHERE SiteId =@SiteId
			IF @Se =1 AND @SeExcised <> null SET @countExcised= @countExcised + @SeExcised 
			IF  @Pe = 1 AND @PeExcised <> null SET @countExcised= @countExcised + @peExcised
			IF  @Su = 1 AND @suExcised <> null SET @countExcised= @countExcised + @suExcised

			IF @countExcised > 0 SET @Details = @Details + cast(@countExcised as varchar(50)) +' excised '

			IF @PolypectomyRemoval <> 0 OR @PolypectomyRemovalType <> 0
			BEGIN
			SET @Details = @Details + '('
            IF @PolypectomyRemoval = 1 SET @Details = @Details + 'removed entirely ' ELSE IF @PolypectomyRemoval = 2 SET @Details = @Details + 'removed piecemeal '
			IF @PolypectomyRemovalType = 1 SET @Details = @Details + ' using partial snare'
			ELSE IF  @PolypectomyRemovalType = 2 SET @Details = @Details + 'using cold snare'
			ELSE IF  @PolypectomyRemovalType = 3 SET @Details = @Details + 'using hot snare cauterisation'
			ELSE IF  @PolypectomyRemovalType = 4 SET @Details = @Details + 'using hot biopsy'
			ELSE IF  @PolypectomyRemovalType = 5 SET @Details = @Details + 'using cold biopsy'
			ELSE IF  @PolypectomyRemovalType = 6 SET @Details = @Details + 'using hot snare EMR'
			ELSE IF  @PolypectomyRemovalType = 7 SET @Details = @Details + 'using cold snare by EMR'
			SET @Details = @Details + ')'
			END

			If @Details<>'' SET @msg = @msg + ': ' + @Details
				--Add full stop 
				SET @msg = RTrim(LTRIM(@msg))
				IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
				--------------
				SET @summary = @summary + @msg + @br
			exec specimens_ogd_summary_update @SiteId
		END

		IF @BandingPiles= 1
		BEGIN 
			SET @msg = CASE WHEN @BandingNum > 1 THEN ': ' + CAST(@BandingNum as varchar(5)) + ' bands'
							WHEN @BandingNum = 1 THEN ': ' + CAST(@BandingNum as varchar(5)) + ' band'
							ELSE ''
						END
			--Add full stop 
			SET @msg = 'Banding of piles' + RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

	
		IF @Diathermy = 1
		BEGIN
			SET @msg = ' Diathermy'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg 
		--------------  
		if @DiathermyWatt <> 0 Set @msg =   ' ' + @msg + ' ' + cast(@DiathermyWatt as varchar(10)) + ' Watt.'

		SET @summary = @summary + @msg + @br  
		END  

		
		
		IF @Diverticulotomy = 1
			BEGIN
			SET @msg =' Diverticulotomy'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		
		
		IF @GastricBalloonInsertion = 1
			BEGIN
			SET @msg =' Gastric balloon insertion'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
  
	-- ## Valve
	  IF @Valve = 1  
	  BEGIN  
	   SET @msg = 'Valve'  
	   if @ValveQty <> 0 Set @msg2 = ' ' + cast(@ValveQty as varchar(10))
	   if @ValveType <> 0 Set @msg2 = @msg2 + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'BRT Valve Type' AND [ListItemNo] = @ValveType)  
	   Set @msg2 = ltrim(rtrim(@msg2))
	   if @msg2 <> '' Set @msg = @msg2 + ' Valve.' else Set @msg = 'Valve.'

	   SET @summary = @summary + @msg +  @br  
	  END

	  --- ### Cryotherapy and PhotoDynamicTherapy
	  Set @msg = ''
	  set @msg2 = ''
	  if @Cryotherapy = 1 Set @msg2 = 'Cryotherapy'
	  if @PhotoDynamicTherapy = 1 
	  Begin
		if @msg2 <> '' Set @msg = @msg2 + ' and Photodynamic Therapy have been used.' else set @msg = 'Photodynamic Therapy has been used.'
	  end
	  else
	  begin
		if @msg2 <> '' Set @msg = @msg2 + '.' -- TFS# 2430
	  end
	  if @msg <> '' Set @summary = @summary + @msg + @br

		-- ## Coil
		IF @Coil = 1  
		BEGIN  
		SET @msg = 'Coil'  
		if @CoilQty <> 0 Set @msg2 = ' ' + cast(@CoilQty as varchar(10))
		if @CoilType <> 0 Set @msg2 = @msg2 + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'BRT Coil Type' AND [ListItemNo] = @CoilType)  
		Set @msg2 = ltrim(rtrim(@msg2))
		if @msg2 <> '' Set @msg = @msg2 + ' Coil.' else Set @msg = 'Coil.'

			--------------
			SET @summary = @summary + @msg + @br
		END

		-- START TFS 3209
		IF @BicapElectro = 1
		BEGIN
			SET @msg = ' Bicap electrocautery'
			SET @Details = ''
			IF @BicapElectroType >= 0 SET @Details = @Details + ' ' +   (SELECT [ListItemText] FROM dbo.ERS_Lists WHERE ListDescription = 'Bicap Electrocautery' AND [ListItemNo] = @BicapElectroType)
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END
		-- END TFS 3209

		IF @HeatProbe = 1
		BEGIN
			SET @msg = ' Heater probe coagulation'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		--IF @BallDil = 1
		--	BEGIN
		--	SET @msg = ' Balloon dilatation'
		--	--Add full stop 
		--	SET @msg = RTrim(LTRIM(@msg))
		--	IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
		--	--------------
		--	SET @summary = @summary + @msg + @br
		--END
		
		IF @HotBiopsy = 1
		BEGIN
			SET @msg = ' Hot biopsy'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
		IF @BandLigation = 1
		BEGIN			
			SET @msg = ' Band ligation'
			IF @BandLigationPerformed > 0 SET @msg = @msg + ' performed ' + CAST(@BandLigationPerformed AS VARCHAR(100)) + CASE WHEN @BandLigationPerformed = 1 THEN ' procedure' ELSE ' procedures' END
			IF @BandLigationPerformed > 0 AND @BandLigationSuccess > 0 SET @msg = @msg + ' and ' + CAST(@BandLigationSuccess AS VARCHAR(100)) + CASE WHEN @BandLigationPerformed = 1 THEN ' was successful.' ELSE ' were successful.' END 
				ELSE IF @BandLigationPerformed = 0 AND @BandLigationSuccess > 0 SET @msg = @msg + ' ' + CAST(@BandLigationSuccess AS VARCHAR(100)) + CASE WHEN @BandLigationPerformed = 1 THEN ' procedure was successful.' ELSE ' procedures were successful.' END 
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br			
		END

		IF @BalloonDilation = 1
		BEGIN
			SET @msg = ' Balloon Dilation'
			--added by mostafiz tsf:2743
			SET @Details = ''
			
			IF @BalloonDilationType > 0 
				BEGIN
					SET @Details = @Details + ' ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Therapeutic Balloon Dilation Types' AND [ListItemNo] = @BalloonDilationType)
				END	

			IF  @BalloonDilationDiameter > 0 
				BEGIN
					SET @Details = @Details + ' (' 
					--IF @BalloonDilationDiameter > 0 SET @Details = @Details + ', ' 
					SET @Details = @Details + ' diameter ' + cast(@BalloonDilationDiameter as varchar(50))
					IF @BalloonDilationDiameterUnits >= 0 SET @Details = @Details+ ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Balloon dilatation units' AND [ListItemNo] = @BalloonDilationDiameterUnits)
					SET @Details = @Details + ' )' 
				END

			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--added by mostafiz tsf:2743
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
			
			
		END

		IF @BotoxInjection = 1
		BEGIN
			SET @msg = ' Botox injection'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @EndoscopicResection = 1
		BEGIN
			SET @msg = ' Endoscopic resection'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		-------------------------------
        -- FNA
        -------------------------------
		IF @FineNeedleAspiration= 1
		BEGIN
			SET @msg =' FNA'

			--edited by siddik tfs# 2550, 2551
			IF @FineNeedleAspirationType = 1 
			BEGIN
				SET @msg = @msg + ' (cystic lession) '
			END
			ELSE IF @FineNeedleAspirationType = 2 SET @msg = @msg + ' (solid lession) ' -- TFS 4498

			IF @FNAPerformed > 0
			BEGIN
				SET @msg = @msg + ' Performed ' + CAST(@FNAPerformed as varchar(3))
				IF @FNARetrieved > 0 SET @msg =  @msg + ', Retrieved ' + CAST(@FNARetrieved as varchar(3))
				IF @FNASuccessful > 0 SET @msg =  @msg + ', Successful ' + CAST(@FNASuccessful as varchar(3))
			END
			IF @FNAPerformed = 0 AND @FNARetrieved > 0
			BEGIN
				SET @msg = @msg + ' Retrieved ' + CAST(@FNARetrieved as varchar(3))
				IF @FNASuccessful > 0 SET @msg =  @msg + ', Successful ' + CAST(@FNASuccessful as varchar(3))
			END
			IF @FNBPerformed = 0 AND @FNARetrieved = 0 AND @FNASuccessful > 0
			BEGIN
				SET @msg =  @msg + ' Successful ' + CAST(@FNASuccessful as varchar(3))
			END
			--tfs 2550, 2551 end

			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		-------------------------------
        -- FNB
        -------------------------------
		IF @FineNeedleBiopsy= 1
		BEGIN
			SET @msg =' FNB'

			--edited by siddik tfs# 2550, 2551
			IF @FNBPerformed > 0
			BEGIN
				SET @msg = @msg + ' Performed ' + CAST(@FNBPerformed as varchar(3))
				IF @FNBRetrieved > 0 SET @msg =  @msg + ', Retrieved ' + CAST(@FNBRetrieved as varchar(3))
				IF @FNBSuccessfull > 0 SET @msg =  @msg + ', Successful ' + CAST(@FNBSuccessfull as varchar(3))
			END
			IF @FNBPerformed = 0 AND @FNBRetrieved > 0
			BEGIN
				SET @msg = @msg + ' Retrieved ' + CAST(@FNBRetrieved as varchar(3))
				IF @FNBSuccessfull > 0 SET @msg =  @msg + ', Successful ' + CAST(@FNBSuccessfull as varchar(3))
			END
			IF @FNBPerformed = 0 AND @FNBRetrieved = 0 AND @FNBSuccessfull > 0
			BEGIN
				SET @msg =  @msg + ' Successful ' + CAST(@FNBSuccessfull as varchar(3))
			END
			--tfs 2550, 2551 end

			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @EndoloopPlacement = 1
		BEGIN
			SET @msg = ' Endoloop placement'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @ForeignBody = 1
		BEGIN
			SET @msg = ' Foreign body removal'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @StentInsertion= 1
			BEGIN
			SET @msg =' Stent insertion'
			SET @Details = ''
			IF @StentInsertionQty > 0 SET @Details = @Details + '  ' + cast(@StentInsertionQty as varchar(50))
			IF @StentInsertionType > 0 
				BEGIN
				IF @Area = 'Oesophagus'	 SET @Details = @Details + ' ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Therapeutic Stent Insertion Types' AND [ListItemNo] = @StentInsertionType)
				ELSE SET @Details = @Details + ' ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Therapeutic Stomach Stent Insertion Types' AND [ListItemNo] = @StentInsertionType)
				END	
			IF @StentInsertionLength > 0 AND @StentInsertionDiameter > 0 
				BEGIN
				SET @Details = @Details + ' (' 
				IF @StentInsertionLength > 0 SET @Details = @Details + ' length ' + cast(@StentInsertionLength as varchar(50)) + 'cm'
				IF @StentInsertionDiameter > 0 SET @Details = @Details + ', ' 
				SET @Details = @Details + ' diameter ' + cast(@StentInsertionDiameter as varchar(50))
				IF @StentInsertionDiameterUnits >= 0 SET @Details = @Details+ ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Oesophageal dilatation units' AND [ListItemNo] = @StentInsertionDiameterUnits)
				SET @Details = @Details + ')' 
				END
			IF @StentInsertionBatchNo <> ''  SET @Details = @Details + ' batch ' + LTRIM(RTRIM(@StentInsertionBatchNo))
			
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @StentRemoval= 1
			BEGIN
			SET @msg =' Stent removal'
			SET @Details = ''
			IF @StentRemovalTechnique > 0  SET @Details = @Details + 'using ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Therapeutic Stent Removal Technique' AND [ListItemNo] = @StentRemovalTechnique)
			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @EMR= 1
			BEGIN
			IF @EMRType = 3
				SET @msg =' Endoscopic full thickness resection'
			ELSE IF @EMRType = 2
				SET @msg =' Endoscopic submucosal dissection'
			ELSE IF @EMRType = 1
				SET @msg =' Endoscopic mucosal resection'
			SET @Details = ''
			IF @EMRFluid > 0  SET @Details = @Details + 'using ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Therapeutic EMR Fluid' AND [ListItemNo] = @EMRFluid)
			IF @EMRFluidVolume >0 
				BEGIN
				IF @EMRFluid >0 SET  @Details = @Details + ', '
				SET  @Details = @Details + 'total volume ' + cast(@emrfluidvolume AS varchar(50)) + 'ml'
				END
			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		
		IF @OesophagealDilatation= 1
			BEGIN
			SET @msg =' Oesophageal dilatation'
			SET @Details = ''
			--Added by rony tfs-4085
			IF @DilatedTo > 0  SET @Details = @Details + ' dilated to ' + cast(CAST(@dilatedto AS FLOAT) as varchar(50)) +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Oesophageal dilatation units' AND [ListItemNo] = @DilatationUnits)
			IF @DilatorType > 0
				BEGIN
				DECLARE @DilatorStr varchar(500) = (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Oesophageal dilator' AND [ListItemNo] = @DilatorType)
				IF @DilatorStr like 'with%' OR @DilatorStr like 'by%'  SET @Details = @Details + ' ' +  @DilatorStr
				ELSE SET @Details = @Details + ' with ' +  @DilatorStr
				END
			IF @DilatorScopePass = 1 
			BEGIN
				SET @Details = @Details + ' (scope could pass)'
			END
			-- TFS-3833 start
			IF @DilatationPerforation = 1
			BEGIN
				SET @dilatationPerforationTxt = 'Complication: perforation'
			END
			ELSE 
				BEGIN
				SET @dilatationPerforationTxt = ''
			END
			-- TFS-3833 End
			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br + @dilatationPerforationTxt -- TFS-3833
		END

		IF @VaricealSclerotherapy= 1
			BEGIN
			SET @msg =' Oesophagus variceal sclerotherapy'
			SET @Details = ''
			IF @VaricealSclerotherapyInjectionVol > 0  SET @Details = @Details + ' ' + cast(@VaricealSclerotherapyInjectionVol as varchar(50)) + 'ml' 
			IF @VaricealSclerotherapyInjectionVol > 0 AND  @VaricealSclerotherapyInjectiontype > 0  SET @Details = @Details + ' of'
			IF @VaricealSclerotherapyInjectiontype > 0 SET @Details = @Details + ' ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Agent Upper GI' AND [ListItemNo] = @VaricealSclerotherapyInjectiontype)
			IF @VaricealSclerotherapyInjectionVol > 0 AND  @VaricealSclerotherapyInjectionNum > 0  SET @Details = @Details + ' via'
			IF @VaricealSclerotherapyInjectionNum > 0 SET @Details = @Details + ' ' + CASE WHEN @VaricealSclerotherapyInjectionNum >1 THEN CAST(@VaricealSclerotherapyInjectionNum as varchar(50))+' injections' ELSE  CAST(@VaricealSclerotherapyInjectionNum as varchar(50))+' injection' END
			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @VaricealBanding= 1
			BEGIN
			IF @Area ='Oesophagus' SET @msg =' Oesophagus variceal banding' ELSE SET @msg =' Gastric variceal banding'
			SET @Details = ''
			IF @VaricealBandingNum > 0 SET @Details = @Details + ' ' + CASE WHEN @VaricealBandingNum >1 THEN CAST(@VaricealBandingNum as varchar(50))+' bands' ELSE  CAST(@VaricealBandingNum as varchar(50)) + ' band' END
			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @RFA = 1
			BEGIN
			SET @msg =' Radio Frequency Ablation'
			SET @Details = ''
			IF @RFAType = 1	SET @Details = @Details + ' circumferential'
			ELSE IF @RFAType = 2 SET @Details = @Details + ' focal'
			IF ISNULL(@RFAEnergyDel,0) <> 0 SET @Details = @Details + ', ' + cast(@RFAEnergyDel as varchar(50)) + ' joules'
			IF ISNULL(@RFANumSegTreated,0) <> 0
				BEGIN
				SET @Details = @Details + ' delivered to ' + cast(@RFANumSegTreated as varchar(50))
				IF @RFAType =1 SET @Details = @Details + ' x 3cm'
				SET @Details = @Details + ' segment'
				IF @RFANumSegTreated > 1 SET @Details = @Details + 's'
				END
			IF ISNULL(@RFANumTimesSegTreated,0)<>0
				BEGIN
				SET @Details = @Details + ', treated '
				If @RFANumTimesSegTreated = 1 SET @Details = @Details + 'once'
				ELSE SET @Details = @Details + cast(@RFANumTimesSegTreated as varchar(50)) + ' times'
				END
			IF ISNULL(@RFATreatmentFrom,0) <>0 OR ISNULL(@RFATreatmentTo,0) <>0
				BEGIN
				IF ISNULL(@RFATreatmentFrom,0) <> 0  SET @Details = @Details + ', starting at ' + cast(@RFATreatmentFrom as varchar(50)) +' cm'
				IF ISNULL(@RFATreatmentTo,0) <> 0 
				BEGIN
				IF ISNULL(@RFATreatmentFrom,0) <> 0 SET @Details = @Details + ' and ending at ' + cast(@RFATreatmentTo as varchar(50)) +' cm'
				ELSE  SET @Details = @Details + ' ending at ' + cast(@RFATreatmentTo as varchar(50)) +' cm'
				END
				SET @Details = @Details + ' from the incisors'
				END				

			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @GastrostomyInsertion =1
			BEGIN
			DECLARE @G bit, @J bit, @N bit
			SELECT @j = i.[JejunostomyInsertion], @G =i.[GastrostomyInsertion],@N = i.[NasoDuodenalTube] FROM [ERS_UpperGIIndications] i LEFT JOIN [ERS_Sites] s ON i.ProcedureId = s.ProcedureId WHERE s.SiteId = @SiteID
			IF @N = 1 SET @msg =' Nasojejunal tube (NJT)' ELSE IF @J= 1 SET @msg =' Jejunostomy insertion (PEJ)' ELSE SET @msg =' Gastrostomy insertion (PEG)'
			SET @Details = ''

			IF @GastrostomyInsertionType > 0
				BEGIN
				IF @GastrostomyInsertionSize>0
					BEGIN
					SET @Details = @Details + cast(@GastrostomyInsertionSize as varchar(50))
					IF @J=1 SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG units' AND [ListItemNo] = @GastrostomyInsertionUnits)
					ELSE IF @N =1 SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG units' AND [ListItemNo] = @GastrostomyInsertionUnits)
					ELSE SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG units' AND [ListItemNo] = @GastrostomyInsertionUnits)
					END
				END
				IF @GastrostomyInsertionType>0
						BEGIN
						IF @J=1 SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG type' AND [ListItemNo] = @GastrostomyInsertiontype)
						ELSE IF @N =1 SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG type' AND [ListItemNo] = @GastrostomyInsertiontype)
						ELSE SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG type' AND [ListItemNo] = @GastrostomyInsertiontype)
						END
				IF ISNULL(@GastrostomyInsertionBatchNo, '') <> ''  SET @Details = @Details + ' batch ' + @GastrostomyInsertionBatchNo
				
				--edited by siddik tfs# 2539
				IF @CorrectPEGPlacement > 0
				BEGIN
					IF @CorrectPEGPlacement = 1 
						SET @Details = @Details + ' correctly placed'
					ELSE 
						SET @Details = @Details + ' incorrectly placed' + CASE WHEN isnull(@PEGPlacementFailureReason, '') = '' THEN '' ELSE ' (' + @PEGPlacementFailureReason + ')' END
				END
				
				IF @GastrostomyPEGOutcome > 0
				BEGIN
					SET @Details = CASE WHEN @Details <> '' THEN  @Details + ', ' ELSE '' END + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'PEG Outcome' AND [ListItemNo] = @GastrostomyPEGOutcome)
				END
				--tfs# 2539 end
				    				
				IF @Details<>'' SET @msg = @msg + ': ' + @Details
				--Add full stop 
				SET @msg = RTrim(LTRIM(@msg))
				IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
				--------------
				SET @summary = @summary + @msg + @br
				END

		IF @GastrostomyRemoval = 1
		BEGIN
			SET @msg =' Gastrostomy PEG Removal'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		IF @PyloricDilatation= 1
		BEGIN
			SET @msg =' Pyloric dilatation'

			--edited by siddik tfs# 2541
			IF @PyloricLeadingToPerforation > 0
			BEGIN
				SET @msg = @msg + ': '
				IF @PyloricLeadingToPerforation = 1
					SET @msg = @msg + 'Leading to perforation'
				ELSE
					SET @msg = @msg + 'Not leading to perforation'
			END
			--tfs# 2541 end

			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @NGNJInsertion = 1 
		BEGIN
			Set @msg = ' NG/NJ tube insertion'
			IF isnull(@NGNJTubeBatch, '') <> '' 
				SET @msg = @msg + ' (batch ' + @NGNJTubeBatch + ')'
			IF isnull(@NGNJTubeLength, 0) > 0
			BEGIN
				SET @msg = @msg + '. Tube length ' + convert(varchar, @NGNJTubeLength) + 'cm'
				IF isnull(@NGNJTubeNostril, 0) > 0
				BEGIN
					SELECT @msg = @msg + CASE WHEN @NGNJTubeNostril = 1 THEN ' at the right nostril'
											  WHEN @NGNJTubeNostril = 2 THEN ' at the left nostril'
										 END
				END
			END
			ELSE
			BEGIN
				IF isnull(@NGNJTubeNostril, 0) > 0
				BEGIN
					SELECT @msg = @msg + CASE WHEN @NGNJTubeNostril = 1 THEN ' via the right nostril'
											  WHEN @NGNJTubeNostril = 2 THEN ' via the left nostril'
										 END
				END
			END
			IF isnull(@NGNJTubeBridle, 0) = 1 
				SET @msg = @msg + ', bridle used'

			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @pHProbeInsert= 1
			BEGIN
			SET @msg =' pH probe insertion'
			SET @Details = ''
			IF @pHProbeInsertAt > 0 SET @Details = @Details + ' inserted at ' + CAST(@pHProbeInsertAt as varchar(50))+' cm'
			IF ISNULL(@pHProbeInsertChkTopTo,0) <> 0 
			BEGIN
				IF @Details <> '' SET @Details = @Details + ', '
				SET @Details = @Details + 'endoscopic check performed, top of probe at ' + CAST(@pHProbeInsertChkTopTo as varchar(50))+' cm'
			END
			--ELSE  SET @Details = @Details + ', insertion checked endoscopically'

			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @Haemospray= 1
		BEGIN
			SET @msg =' Haemospray'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @Sigmoidopexy= 1
		BEGIN
			
			SET @msg =' Sigmoidopexy'
			SET @Details = ''
			IF @SigmoidopexyQty > 0 SET @Details = @Details + CONVERT(VARCHAR, @SigmoidopexyQty)
			IF @SigmoidopexyMake > 0 SET @Details = @Details + ' ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Sigmoidopexy make' AND [ListItemNo] = @SigmoidopexyMake)

			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @Marking= 1
		BEGIN
			--MH added on 19 Oct 2021
			Declare @TattoLocationMessage varchar(50)
			Declare @TattoMessage varchar(100)
			declare @MaxId int, @MinId int, @loopCounter int

			Set @TattoLocationMessage = ''
			Set @TattoMessage = ''
			If @TattooLocationDistal > 0 
			Begin
				Set @TattoLocationMessage = 'Distal'
			End

			If @TattooLocationProximal > 0 
			Begin
				if @TattoLocationMessage = ''			
					begin
						Set @TattoLocationMessage = 'Proximal'
					end
				else
					begin
						Set @TattoLocationMessage = @TattoLocationMessage + ',Proximal'
					end		
			End

			Select @MinId = Min(id),@MaxId=Max(id) from fnSplitString(@TattoLocationMessage,',') 
			Set @loopCounter = @MinId
			While @loopCounter < (@MaxId+1)
			begin
				if @loopCounter = 1
				begin
					Set @TattoMessage = (Select Item from fnSplitString(@TattoLocationMessage,',') Where Id = @loopCounter)
				end
				else
				begin
					if @loopCounter <> @MaxId 
					begin
						Set @TattoMessage = @TattoMessage + ', ' + (Select Item from fnSplitString(@TattoLocationMessage,',') Where Id = @loopCounter)
					end
					else
					begin
						Set @TattoMessage = @TattoMessage + ' and ' + (Select Item from fnSplitString(@TattoLocationMessage,',') Where Id = @loopCounter)
					end

				end

				set @loopCounter = @loopCounter + 1
			END

			SET @msg ='Abnormality marked '
			SET @Details = ''			
			IF @MarkingType > 0 SET @Details = ISNULL(@TattoMessage, '') + ' by ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Abno marking' AND [ListItemNo] = @MarkingType) -- tfs-2970

			IF @Details<>'' SET @msg = @msg + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br

		END

		  If @MarkedQuantity > 0
		begin
			IF @summary <> '' SET @summary = @summary
			SET @summary = @summary + 'Number of spots marked ' + Convert(varchar(5),@MarkedQuantity) + '.' + @br -- tfs-2970
		end		
		
		IF @EndoClot = 1
		BEGIN 
			SET @msg = 'EndoClot used'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
		IF @ColonicDecompression = 1
		BEGIN 
			SET @msg = 'Colonic decompression'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
		IF @FlatusTubeInsertion = 1
		BEGIN 
			SET @msg = 'Flatus tube insertion'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
		IF @PancolonicDyeSpray = 1
		BEGIN 
			SET @msg = 'Pancolonic dye spray'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @BougieDilation = 1
		BEGIN 
			SET @msg = 'Bougie dilation'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
		IF LTRIM(RTRIM(@other)) <> ''
			BEGIN
			SET @msg =' ' + LTRIM(RTRIM(@other))
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary =  @summary + @msg  +@br
		END
		
		--Remove last <br />
		IF RIGHT(RTRIM(@summary),6) = '<br />'
		BEGIN
			SET @summary = RTRIM(@summary)
			SET @summary = LEFT(@summary, LEN(@summary) - 6)
		END

	--END
	
	
 END
 -- TFS 4166 Start

 -- Finally, update the summary in Therapeutics  table
	UPDATE dbo.ERS_UpperGITherapeutics 
	SET Summary=@summary 
	WHERE SiteId = @SiteId -- AND CarriedOutRole=1;	--### Summary text is Applicable only for TrainER....
	--WHERE Id = @TherapeuticId
	
	DECLARE @region VARCHAR(100)
	DECLARE @AreaNo INT
	DECLARE @insertionType VARCHAR(100)
	DECLARE @htmlAnchorCode VARCHAR(500)
	DECLARE @SummaryWithLinks VARCHAR(MAX)

	SELECT @region = CASE WHEN s.SiteNo = -77 THEN						--SiteNo is set to -77 for sites By Distance (Col & Sig only)
						CONVERT(VARCHAR,XCoordinate) +  
							CASE WHEN YCoordinate IS NULL OR YCoordinate=0 THEN ' cm' 
							ELSE (' to ' + CONVERT(VARCHAR,YCoordinate) + ' cm' ) 
							END
					ELSE (SELECT r.Region FROM ERS_Regions r WHERE r.RegionId = s.RegionId)
					END, 
			@AreaNo = ISNULL(AreaNo,0)
	FROM ERS_Sites s
	JOIN ERS_Procedures p ON s.ProcedureId = p.ProcedureId
	WHERE SiteId = @SiteId
	
	SET @htmlAnchorCode = '<a href="#" class="sitesummary" onclick="OpenSiteDetails(''' + @region + ''',' + CONVERT(VARCHAR(10),@SiteId) + ',''Therapeutic Procedures'', ''{0}'' , '''+ CONVERT(VARCHAR,@AreaNo) +  ''');">{1}</a>'

	SET @Summary = ''
	SET @SummaryWithLinks = ''
	DECLARE @SummaryHeading VARCHAR(200) = 'Post procedure patient care'
	
	IF @GastrostomyInsertion = 1
	BEGIN
		SET @insertionType = 'PEG'
		SET @SummaryHeading = 'Instructions for PEG care'
		IF @FlangePosition > 0 SET @Summary = 'Flange at ' + CONVERT(varchar, @FlangePosition) + ' cm.'
		IF @NilByMouth = 1
		BEGIN
			IF @Summary <> '' SET @Summary = @Summary + ' Nil by mouth' ELSE SET @Summary = 'Nil by mouth'
			IF @NilByMouthHrs > 0
			BEGIN
				SET @Summary = @Summary + ' for ' + CONVERT(varchar, @NilByMouthHrs)
				IF @NilByMouthHrs = 1
					SET @Summary = @Summary + ' hour'
				ELSE
					SET @Summary = @Summary + ' hours'
			END
		END
		IF @NilByProc = 1
		BEGIN
			IF @Summary <> '' SET @Summary = @Summary + ', nil by PEG' ELSE SET @Summary = 'Nil by PEG'
			IF @NilByProcHrs > 0
			BEGIN
				SET @Summary = @Summary + ' for ' + CONVERT(varchar, @NilByProcHrs)
				IF @NilByProcHrs = 1
					SET @Summary = @Summary + ' hour'
				ELSE
					SET @Summary = @Summary + ' hours'
			END
		END
		IF @Summary <> '' SET @Summary = @Summary + '.'
		IF @AttachmentToWard = 1
		BEGIN
			IF @Summary <> '' SET @Summary = @Summary + ' All attachments for feeding returned to the ward with patient.' ELSE SET @Summary = 'All attachments for feeding returned to the ward with patient.'
		END		
	END	
	ELSE
	BEGIN	
		IF @YAGLaser = 1
		BEGIN
			SET @insertionType = 'YAG'
			IF @OesoYAGNilByMouth = 1
			BEGIN
				SET @Summary = 'Nil by mouth'
				IF @OesoYAGNilByMouthHrs > 0
				BEGIN
					SET @Summary = @Summary + ' for ' + CONVERT(varchar, @OesoYAGNilByMouthHrs)
					IF @OesoYAGNilByMouthHrs = 1
						SET @Summary = @Summary + ' hour'
					ELSE
						SET @Summary = @Summary + ' hours'
				END
			END

			IF @OesoYAGWarmFluids = 1
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ', warm fluids only' ELSE SET @Summary = 'Warm fluids only'
				IF @OesoYAGWarmFluidsHrs > 0
				BEGIN
					SET @Summary = @Summary + ' for ' + CONVERT(varchar, @OesoYAGWarmFluidsHrs)
					IF @OesoYAGWarmFluidsHrs = 1
						SET @Summary = @Summary + ' hour'
					ELSE
						SET @Summary = @Summary + ' hours'
				END
			END

			IF @OesoYAGSoftDiet = 1
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ', soft diet' ELSE SET @Summary = 'Soft diet'
				IF @OesoYAGSoftDietDays > 0
				BEGIN
					SET @Summary = @Summary + ' for ' + CONVERT(varchar, @OesoYAGSoftDietDays)
					IF @OesoYAGSoftDietDays = 1
						SET @Summary = @Summary + ' day'
					ELSE
						SET @Summary = @Summary + ' days'
				END
			END

			IF @Summary <> '' SET @Summary = @Summary + '.'

			IF @OesoYAGMedicalReview = 1
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ' Medical review before discharge.' ELSE SET @Summary = 'Medical review before discharge.'
			END
		END

		IF @OesophagealDilatation = 1 OR @StentInsertion = 1
		BEGIN
			SET @insertionType = 'STENT'
			IF @OesoDilNilByMouth = 1
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ' Nil by mouth' ELSE SET @Summary = 'Nil by mouth'
				IF @OesoDilNilByMouthHrs > 0
				BEGIN
					SET @Summary = @Summary + ' for ' + CONVERT(varchar, @OesoDilNilByMouthHrs)
					IF @OesoDilNilByMouthHrs = 1
						SET @Summary = @Summary + ' hour'
					ELSE
						SET @Summary = @Summary + ' hours'
				END
			END

			IF @OesoDilWarmFluids = 1
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ', warm fluids only' ELSE SET @Summary = 'Warm fluids only'
				IF @OesoDilWarmFluidsHrs > 0
				BEGIN
					SET @Summary = @Summary + ' for ' + CONVERT(varchar, @OesoDilWarmFluidsHrs)
					IF @OesoDilWarmFluidsHrs = 1
						SET @Summary = @Summary + ' hour'
					ELSE
						SET @Summary = @Summary + ' hours'
				END
			END

			IF @OesoDilSoftDiet = 1
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ', soft diet' ELSE SET @Summary = 'Soft diet'
				IF @OesoDilSoftDietDays > 0
				BEGIN
					SET @Summary = @Summary + ' for ' + CONVERT(varchar, @OesoDilSoftDietDays)
					IF @OesoDilSoftDietDays = 1
						SET @Summary = @Summary + ' day'
					ELSE
						SET @Summary = @Summary + ' days'
				END
			END

			IF @OesoDilXRay = 1
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ', chest X-ray' ELSE SET @Summary = 'Chest X-ray'
				IF @OesoDilXRayHrs > 0
				BEGIN
					SET @Summary = @Summary + ' after ' + CONVERT(varchar, @OesoDilXRayHrs)
					IF @OesoDilXRayHrs = 1
						SET @Summary = @Summary + ' hour'
					ELSE
						SET @Summary = @Summary + ' hours'
				END
			END

			IF @Summary <> '' SET @Summary = @Summary + '.'

			IF @OesoDilMedicalReview = 1
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ' Medical review before discharge.' ELSE SET @Summary = 'Medical review before discharge.'
			END
		END
		IF @GastrostomyInsertion = 0
		BEGIN
		declare @procsId int = (select procedureid from ERS_Sites where SiteId = @SiteId)
		declare @gastromyInsertion bit

			SELECT top 1 @GastrostomyInsertion = GastrostomyInsertion FROM ERS_UpperGITherapeutics u
			inner join ERS_Sites e on e.SiteId = u.SiteId 
			where GastrostomyInsertion = 1 and e.ProcedureId = @procsId
		END
		IF @Sigmoidopexy= 1
		BEGIN
			SET @SummaryHeading = 'Ward instructions'
			IF ISNULL(@SigmoidopexyFluidsDays,0) > 0
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ' '
				SET @Summary = @Summary + 'Clear fluids for ' + CONVERT(varchar, @SigmoidopexyFluidsDays) 
								+ CASE WHEN @SigmoidopexyFluidsDays > 1 THEN ' days.' else ' day.' END
			END
			IF ISNULL(@SigmoidopexyAntibioticsDays,0) > 0
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ' '
				SET @Summary = @Summary + 'Antibiotics for ' + CONVERT(varchar, @SigmoidopexyAntibioticsDays) 
								+ CASE WHEN @SigmoidopexyAntibioticsDays > 1 THEN ' days.' ELSE ' day.' END
			END
		END
	END

	IF @Summary = '' SET @SummaryHeading = ''

	-- Finally, update the summary in PP_InstForCare  table
	UPDATE p
	SET PP_InstForCare = @Summary
		, PP_InstForCareHeading = @SummaryHeading
		, PP_InstForCareWithLinks = REPLACE(REPLACE(@htmlAnchorCode, '{0}', @insertionType), '{1}', @Summary), p.PP_NPSAalert = case when @GastrostomyInsertion = 0 then '' else p.PP_NPSAalert end
	FROM ERS_ProceduresReporting p
	INNER JOIN ERS_Sites s ON p.ProcedureId = s.ProcedureId and s.SiteId = @SiteId;

	DROP TABLE #tmp_UpperGITherapeutics;

	DECLARE @ProcedureId INT = (SELECT ProcedureId FROM ERS_Sites WHERE SiteId = @SiteId)
	EXEC ogd_diagnoses_summary_update @ProcedureId

 -- TFS 4166 End
GO

------------------------------------------------------------------------------------------------------------------------
-- TFS#	2539, 4166, 4498 END
-------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ahmed Shoud
-- TFS#	4440
-- Description of change
-- Anti-Coag Free Text Box
------------------------------------------------------------------------------------------------------------------------

IF NOT EXISTS (SELECT 1 FROM ERS_PotentialDamagingDrugs WHERE [Description] = 'Other') 
BEGIN
    INSERT INTO ERS_PotentialDamagingDrugs
        ([Description], WhoCreatedId, WhenCreated, AntiCoag)
    VALUES
        ('Other', 1, GETDATE(), 1);
END
------------------------------------------------------------------------------------------------------------------------
-- TFS#	4440 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ahmed Shoud
-- TFS#	4440
-- Description of change
-- Anti-Coag Free Text Box
------------------------------------------------------------------------------------------------------------------------
GO
 IF NOT EXISTS (
        SELECT 1
        FROM INFORMATION_SCHEMA.COLUMNS
        WHERE TABLE_NAME = 'ERS_ProcedureDamagingDrugs' AND
              COLUMN_NAME IN ('AdditionalInfo')
    )
    BEGIN
		ALTER TABLE dbo.ERS_ProcedureDamagingDrugs
            ADD AdditionalInfo  VARCHAR(255);
    END
GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	4440 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rony
-- TFS#	4171
-- Description of change
-- potentially significant drugs question - update 

-- Updated by	:	Ahmed Shoud
-- TFS#	4440
-- Description of change
-- Anti-Coag Free Text Box
------------------------------------------------------------------------------------------------------------------------

 IF NOT EXISTS (
        SELECT 1
        FROM INFORMATION_SCHEMA.COLUMNS
        WHERE TABLE_NAME = 'ERS_Procedures' AND
              COLUMN_NAME IN ('PotentialSignificantDrugs')
    )
    BEGIN
		
		ALTER TABLE ERS_Procedures
            ADD PotentialSignificantDrugs BIT;
    END
GO
EXEC dbo.DropIfExist 
    @ObjectName = 'patient_anti_coag_drugs_select', 
    @ObjectTypePrefix = 'S' 
GO
CREATE PROCEDURE [dbo].[patient_anti_coag_drugs_select]
(
	@ProcedureId int
)
AS
BEGIN
	SELECT p.AntiCoagDrugs, ac.DamagingDrugId, ac.Description, ac.AdditionalInfo -- TFS 4440 
	FROM ERS_Procedures p
		LEFT JOIN (SELECT pd. DamagingDrugId, dd.Description, pd.ProcedureId, pd.AdditionalInfo -- TFS 4440 
					FROM ERS_ProcedureDamagingDrugs pd
					LEFT JOIN ERS_PotentialDamagingDrugs dd on dd.UniqueId = pd.DamagingDrugId
					WHERE AntiCoag = 1) ac on ac.ProcedureId = p.ProcedureId
	WHERE p.ProcedureId = @ProcedureID 
END
GO
EXEC dbo.DropIfExist 
    @ObjectName = 'patient_anti_coag_drugs_save', 
    @ObjectTypePrefix = 'S' 
GO
CREATE PROCEDURE [dbo].[patient_anti_coag_drugs_save]
(
	@ProcedureId int,
	@AntiCoagDrugs bit,
	@PotentialSignificantDrugs bit --Added by rony tfs-4171
)
AS
BEGIN
	BEGIN
	    UPDATE ERS_Procedures SET AntiCoagDrugs = @AntiCoagDrugs,PotentialSignificantDrugs=@PotentialSignificantDrugs WHERE ProcedureId = @ProcedureId --Added by rony tfs-4171
	    	DECLARE  @SectionId int = (SELECT UISectionId FROM UI_Sections WHERE SectionName = 'Anti-coag drugs')
	    
	    	DELETE FROM ERS_ProcedureSummary WHERE ProcedureId = @ProcedureId AND SectionId = @SectionId
	    	IF @AntiCoagDrugs = 1 AND 
	    			(SELECT count(*) FROM ERS_ProcedureDamagingDrugs WHERE ProcedureId = @ProcedureId AND DamagingDrugId IN (SELECT UniqueId FROM ERS_PotentialDamagingDrugs WHERE AntiCoag = 1)) > 0 
	    	BEGIN
	    		exec UI_update_procedure_summary @ProcedureId, 'Anti-coag drugs', 'Anti-coag drugs', 1
				--check RX status incase this was an update
				IF (SELECT count(*) FROM ERS_UpperGIRx WHERE ProcedureId = @ProcedureId AND Summary <> '') = 0
				BEGIN
					exec UI_update_procedure_summary @ProcedureId, 'RX', 'RX', 0
				END
	    	END
	    	ELSE IF @AntiCoagDrugs = 1 AND 
	    			(SELECT count(*) FROM ERS_ProcedureDamagingDrugs WHERE ProcedureId = @ProcedureId AND DamagingDrugId IN (SELECT UniqueId FROM ERS_PotentialDamagingDrugs WHERE AntiCoag = 1)) = 0 
	    	BEGIN
	    		exec UI_update_procedure_summary @ProcedureId, 'Anti-coag drugs', 'Anti-coag drugs', 0
				--check RX status incase this was an update
				IF (SELECT count(*) FROM ERS_UpperGIRx WHERE ProcedureId = @ProcedureId AND Summary <> '') = 0
				BEGIN
					exec UI_update_procedure_summary @ProcedureId, 'RX', 'RX', 0
				END
	    	END
	    	ELSE IF @AntiCoagDrugs = 0
	    	BEGIN
			
				Delete FROM ERS_ProcedureDamagingDrugs WHERE ProcedureId = @ProcedureId AND DamagingDrugId IN  
				(SELECT UniqueId FROM ERS_PotentialDamagingDrugs WHERE AntiCoag = 1) --edited by mostafiz 4090

	    		exec UI_update_procedure_summary @ProcedureId, 'Anti-coag drugs', 'Anti-coag drugs', 1
				exec UI_update_procedure_summary @ProcedureId, 'RX', 'RX', 1

				UPDATE ERS_ProceduresReporting 
				SET PP_Indic = dbo.ProcedureIndicationsSummary(@ProcedureId)
				WHERE ProcedureId = @ProcedureId --edited by mostafiz 4090
	    	END
			--Added by rony tfs-4171
			IF @PotentialSignificantDrugs = 1
			BEGIN
			UPDATE ERS_ProceduresReporting 
				SET PP_Indic = dbo.ProcedureIndicationsSummary(@ProcedureId)
				WHERE ProcedureId = @ProcedureId
			END
			ELSE IF @PotentialSignificantDrugs = 0
	    	BEGIN
				DELETE FROM ERS_ProcedureDamagingDrugs WHERE ProcedureId = @ProcedureId AND DamagingDrugId IN  
				(SELECT UniqueId FROM ERS_PotentialDamagingDrugs WHERE AntiCoag = 0) 

				UPDATE ERS_ProceduresReporting 
				SET PP_Indic = dbo.ProcedureIndicationsSummary(@ProcedureId)
				WHERE ProcedureId = @ProcedureId 
	    	END
	END
END
GO
EXEC dbo.DropIfExist 
    @ObjectName = 'procedure_damaging_drugs_select', 
    @ObjectTypePrefix = 'S' 
GO
CREATE PROCEDURE [dbo].[procedure_damaging_drugs_select]
(
	 @ProcedureId int
)
AS
BEGIN
	--Added by rony tfs-4171
	SELECT PotentialSignificantDrugs, ac. DamagingDrugId, ac.Description 
	FROM ERS_Procedures p
		LEFT JOIN (SELECT pd. DamagingDrugId, dd.Description, pd.ProcedureId 
					FROM ERS_ProcedureDamagingDrugs pd
					LEFT JOIN ERS_PotentialDamagingDrugs dd on dd.UniqueId = pd.DamagingDrugId
					WHERE AntiCoag = 0) ac on ac.ProcedureId = p.ProcedureId
	WHERE p.ProcedureId = @ProcedureID 
END
GO
EXEC dbo.DropIfExist 
    @ObjectName = 'procedure_damaging_drugs_save', 
    @ObjectTypePrefix = 'S' 
GO
CREATE PROCEDURE [dbo].[procedure_damaging_drugs_save]
(
	@ProcedureId int, 
	@DrugId varchar(255), 
	@LoggedInUserId int,
	@AntiCoag bit,
	@SectionName varchar(200), 
	@NewItem varchar(200),
	@PotentialSignificantDrugs bit, --Added by rony tfs-4171
	@antiCoagOtherText varchar(255) = '' -- TFS 4440
)
AS
BEGIN
	--check if is an anticoag drug
	DECLARE @AntiCoagDrugs bit = (SELECT AntiCoagDrugs FROM ERS_Procedures WHERE ProcedureId = @ProcedureId),
				@SectionId int = (SELECT UISectionId FROM UI_Sections WHERE SectionName = 'Anti-coag drugs'),
				@NewAntiCoagId int

	--delete existing drugs
	DELETE FROM ERS_ProcedureDamagingDrugs WHERE ProcedureId = @ProcedureId AND DamagingDrugId IN (SELECT UniqueId FROM ERS_PotentialDamagingDrugs WHERE AntiCoag = @AntiCoag)

	IF @AntiCoag = 1 
	BEGIN
		--TFS 3708 Start
		IF @SectionName IS NOT NULL AND @NewItem IS NOT NULL AND LTRIM(RTRIM(@NewItem)) <> '' AND @NewItem NOT IN (SELECT [Description] FROM dbo.ERS_PotentialDamagingDrugs) -- TFS 4440
		BEGIN
			EXEC add_new_reference_item @SectionName,@NewItem,@LoggedInUserId,@NewAntiCoagId output
			SET @DrugId = @DrugId + ',' + CONVERT(VARCHAR(100), @NewAntiCoagId)
		END
		--TFS 3708 End
		IF @AntiCoagDrugs = 1 
			exec UI_update_procedure_summary @ProcedureId, 'Anti-coag drugs', '', 0
		ELSE IF @AntiCoagDrugs = 0
		BEGIN
			exec UI_update_procedure_summary @ProcedureId, 'Anti-coag drugs', '', 1
			exec UI_update_procedure_summary @ProcedureId, 'RX', '', 1
		END
		--Added by rony tfs-4171
		EXEC patient_anti_coag_drugs_save @ProcedureId, @AntiCoag, @PotentialSignificantDrugs
	END

	--save existing drugs
	DECLARE @damagingDrugID INT = (SELECT UniqueId FROM ERS_PotentialDamagingDrugs WHERE [Description] = 'Other') -- TFS 4440
	DECLARE @otherValRequired BIT = 0 -- TFS 4440
	DECLARE @SelectedID int;
	DECLARE db_cursor CURSOR FOR  
	SELECT item  FROM fnSplitString( @DrugId, ',')

	OPEN db_cursor   
	FETCH NEXT FROM db_cursor INTO @SelectedID 
	WHILE @@FETCH_STATUS = 0   
	BEGIN
		-- TFS 4440 Start
		IF(@damagingDrugID IS NOT NULL AND @damagingDrugID = @SelectedID AND (@antiCoagOtherText IS NOT NULL AND @antiCoagOtherText <> ''))
			INSERT INTO [dbo].[ERS_ProcedureDamagingDrugs] (ProcedureId, DamagingDrugId, WhoCreatedId, WhenCreated, AdditionalInfo)
			VALUES (@ProcedureId, @SelectedID, @LoggedInUserId, getdate(), @antiCoagOtherText)
		ELSE
			INSERT INTO [dbo].[ERS_ProcedureDamagingDrugs] (ProcedureId, DamagingDrugId, WhoCreatedId, WhenCreated)
			VALUES (@ProcedureId, @SelectedID, @LoggedInUserId, getdate())
		-- TFS 4440 End
		DECLARE @Summary VARCHAR(max) = 'Significant drugs',
				@DamagingDrugsCount int = (SELECT count(*) FROM ERS_ProcedureDamagingDrugs WHERE ProcedureId = @ProcedureId)

		EXEC UI_update_procedure_summary @ProcedureId, 'Significant drugs', @Summary, @DamagingDrugsCount

		IF @AntiCoagDrugs IS NOT NULL
		BEGIN
			DELETE FROM ERS_ProcedureSummary WHERE ProcedureId = @ProcedureId AND SectionId = @SectionId

			INSERT INTO ERS_ProcedureSummary (SectionId, ProcedureId, Summary) VALUES (@SectionId, @ProcedureId, 'Anti-Coag drugs')
		END
	
	-- TFS 4440 Start
		IF(@damagingDrugID IS NOT NULL AND @damagingDrugID = @SelectedID AND (@antiCoagOtherText IS NULL OR @antiCoagOtherText = '')) 
			SET @otherValRequired = 1
	-- TFS 4440 End
	FETCH NEXT FROM db_cursor INTO @SelectedID   
	END   

	CLOSE db_cursor   
	DEALLOCATE db_cursor
	-- TFS 4440 Start
	IF @otherValRequired = 1
			DELETE FROM ERS_ProcedureSummary WHERE ProcedureId = @ProcedureId AND SectionId = @SectionId
	-- TFS 4440 End
	UPDATE ERS_ProceduresReporting
	SET PP_Indic = dbo.ProcedureIndicationsSummary(@ProcedureId)
	WHERE ProcedureId = @ProcedureId
	Return @NewAntiCoagId -- TFS 4440
END
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	4171, 4440
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Siddik
-- TFS#	4327
-- Description of change: Repeat Procedure Question for Bronch / EBUS
-------------------------------------------------------------------------------------------------------------------------

IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'ERS_RepeatProcedureValue' AND schema_id = SCHEMA_ID('dbo'))
BEGIN
    CREATE TABLE [dbo].[ERS_RepeatProcedureValue] (
        [UniqueId] [int] IDENTITY(1,1) NOT NULL,
        [ProcedureId] [int] NOT NULL,
        [Answer] [bit] NULL,
        [RepeatUnknownId] [int] NULL,
        [OtherTextValue] [varchar](max) NULL,
        [WhoCreatedId] [int] NULL,
        [WhenCreated] [datetime] NOT NULL,
        [WhoUpdatedId] [int] NULL,
        [WhenUpdated] [datetime] NULL
    );
END;
GO


IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'ERS_RepeatUnknownReasons' AND schema_id = SCHEMA_ID('dbo'))
BEGIN
	CREATE TABLE [dbo].[ERS_RepeatUnknownReasons](
		[UniqueId] [int] IDENTITY(1,1) NOT NULL,
		[Description] [varchar](500) NOT NULL,
		[NEDTerm] [varchar](500) NOT NULL,
		[AdditionalInfo] [bit] NOT NULL DEFAULT 0,
		[ListOrderBy] [int] NULL,
		[Suppressed] [bit] NOT NULL DEFAULT 0
	)
END
GO

INSERT INTO ERS_RepeatUnknownReasons (Description, NEDTerm, AdditionalInfo, ListOrderBy)
SELECT * FROM (VALUES
    ('Tissue for diagnosis', 'Tissue for diagnosis', 0, 1),
    ('Tissue for staging', 'Tissue for staging', 0, 2),
    ('Tissue for molecular analysis', 'Tissue for molecular analysis', 0, 3),
    ('Abandoned procedure', 'Abandoned procedure', 0, 4),
    ('Surveillance', 'Surveillance', 0, 5),
    ('Other', 'Other', 1, 999)
) AS NewValues(Description, NEDTerm, AdditionalInfo, ListOrderBy)
WHERE NOT EXISTS (
    SELECT 1 
    FROM ERS_RepeatUnknownReasons 
    WHERE ERS_RepeatUnknownReasons.Description = NewValues.Description
);
GO

EXEC dbo.DropIfExist 
    @ObjectName = 'repeat_procedure_save', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[repeat_procedure_save]
(	
	@ProcedureId INT,
	@SelectedAnswer BIT,
	@RepeatUnknownId INT,
	@OtherTextValue VARCHAR(MAX),
	@LoggedInUserId INT
)
AS
BEGIN

	DECLARE @ReportSummaryText VARCHAR(MAX)
	IF NOT EXISTS (SELECT 1 FROM [ERS_RepeatProcedureValue] WHERE ProcedureId = @ProcedureId)
	BEGIN
		INSERT INTO [ERS_RepeatProcedureValue] (ProcedureId, Answer, RepeatUnknownId, OtherTextValue, WhoCreatedId, WhenCreated)
		VALUES (@ProcedureId, @SelectedAnswer, NULLIF(@RepeatUnknownId, 0), @OtherTextValue, @LoggedInUserId, GETDATE())
	END
	ELSE
	BEGIN
		UPDATE [ERS_RepeatProcedureValue]	    
		SET Answer = @SelectedAnswer,
			RepeatUnknownId = NULLIF(@RepeatUnknownId, 0),
			OtherTextValue = @OtherTextValue,
			WhoUpdatedId = @LoggedInUserId,
			WhenUpdated = GETDATE()
		WHERE ProcedureId = @ProcedureId
	END	

	DECLARE @Summary VARCHAR(max) = dbo.ProcedureIndicationsSummary(@ProcedureId),
		@RepeatProcedureCount int = (SELECT count(*) FROM [ERS_RepeatProcedureValue] WHERE ProcedureId = @ProcedureId);

	EXEC UI_update_procedure_summary @ProcedureId, 'Indications', 'Indications: ', @RepeatProcedureCount

	UPDATE ERS_ProceduresReporting
	SET PP_Indic = @Summary
	WHERE ProcedureId = @ProcedureId;
END

GO


EXEC dbo.DropIfExist 
    @ObjectName = 'repeat_procedure_select', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[repeat_procedure_select]
(
	@ProcedureId INT
)
AS
BEGIN
	SELECT UniqueId, Answer, ISNULL(RepeatUnknownId, 0) AS RepeatUnknownId, OtherTextValue
	FROM ERS_RepeatProcedureValue
	WHERE ProcedureId = @ProcedureId
END

GO

EXEC dbo.DropIfExist 
    @ObjectName = 'repeat_unknown_reasons_select', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[repeat_unknown_reasons_select]
AS
BEGIN
   SELECT UniqueId, [Description], NEDTerm 
   FROM ERS_RepeatUnknownReasons
   WHERE Suppressed = 0
   ORDER BY ListOrderBy
END

GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	4327 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Muhammad Nasim
-- TFS#	3810
-- Description of change: ERCP imaging free text bos

-- Updated by	:	Rony Bhowmick
-- TFS#	4309
-- CT scan date not showing on Bronch or EBUS reprots 

-- Updated by	:	Rony Bhowmick
-- TFS#	4171
-- potentially significant drugs question - update

-- Updated by	:	MOSTAFIZUR RAHMAN
-- TFS#	4430
-- ASA Status for Bronchs

-- Updated by	:	Ahmed Shoud
-- TFS#	4440
-- Description of change
-- Anti-Coag Free Text Box
-------------------------------------------------------------------------------------------------------------------------
GO
IF NOT EXISTS (
    SELECT * 
    FROM INFORMATION_SCHEMA.COLUMNS 
    WHERE TABLE_NAME = 'ERS_PatientPreviousDiseases' 
      AND COLUMN_NAME = 'AdditionalInformation'
)
BEGIN
    ALTER TABLE ERS_PatientPreviousDiseases
    ADD AdditionalInformation varchar(max) null
END;
GO
 
 update [ERS_Indications] set IndicationSectionId=0 where Description in 
  ('Acute pancreatitis',
  'Ampullary mass',
  'Bile duct injury',
  'Bile leak',
  'Chronic pancreatitis',
  'Gallbladder mass',
  'Gallbladder polyp',
  'Hepatobiliary mass',
  'Pancreatic mass',
  'Suspected CBD stones',
  'Suspected gallbladder stones',
  'Obstructed CBD/CHD')
if not exists(select 1 from ERS_ImagingMethods where Description ='Acute pancreatitis')
  begin
		insert into ERS_ImagingMethods (Description,AdditionalInfo,Suppressed) values
		('Acute pancreatitis',0,0),
		('Ampullary mass',0,0),
		('Bile duct injury',0,0),
		('Bile leak',0,0),
		('Chronic pancreatitis',0,0),
		('Gallbladder mass',0,0),
		('Gallbladder polyp',0,0),
		('Gallbladder stones',0,0),
		('Hepatobiliary mass',0,0),
		('Pancreatic mass',0,0),
		('Obstructed CBD/CHD',0,0),
		('Dilated bile ducts',0,0),
		('Dilated pancreatic duct',0,0),
		('Extrahepatic',0,0),
		('Intrahepatic',0,0),
		('Fluid collection',0,0),				
		('Hepatic mass',0,0),
		('Stone(s) in bilary tree',0,0),
		('Other',1,0)		
  end

IF NOT EXISTS (
    SELECT * 
    FROM INFORMATION_SCHEMA.COLUMNS 
    WHERE TABLE_NAME = 'ERS_ProcedureImagingMethod' 
      AND COLUMN_NAME = 'AdditionalInformation'
)
BEGIN
    ALTER TABLE ERS_ProcedureImagingMethod
    ADD AdditionalInformation varchar(max) null
END;
GO
dbo.DropIfExist
    @ObjectName = 'procedure_imaging_method_save',      -- varchar(100)
    @ObjectTypePrefix = 'S' -- varchar(5)
GO
CREATE PROCEDURE [dbo].[procedure_imaging_method_save]
(
	@ImagingMethodId int,
	@ProcedureId int,
	@Selected bit,
	@LoggedInUserId int,
	@AdditionalInfo varchar(max)
)
AS
BEGIN
	IF @Selected = 1
	BEGIN
		IF NOT EXISTS(select 1 from ERS_ProcedureImagingMethod where ProcedureId=@ProcedureId and ImagingMethodId=@ImagingMethodId)
		begin
			INSERT INTO ERS_ProcedureImagingMethod (ImagingMethodId, ProcedureId, WhoCreatedId, WhenCreated,AdditionalInformation)
			VALUES (@ImagingMethodId, @ProcedureId, @LoggedInUserId, getdate(),@AdditionalInfo)
		end
		else
		begin
			update ERS_ProcedureImagingMethod set AdditionalInformation=@AdditionalInfo where ProcedureId=@ProcedureId and ImagingMethodId=@ImagingMethodId
		end
	END
	ELSE
	BEGIN
		DELETE FROM ERS_ProcedureImagingMethod WHERE ImagingMethodId = @ImagingMethodId AND ProcedureId = @ProcedureId
	END
	if (select AdditionalInfo from ERS_ImagingMethods where UniqueId=@ImagingMethodId)=1 and len(@AdditionalInfo)=0
	begin
		DELETE FROM ERS_ProcedureImagingMethod WHERE ImagingMethodId = @ImagingMethodId AND ProcedureId = @ProcedureId
	end

	UPDATE ERS_ProceduresReporting
	SET PP_Indic = dbo.ProcedureIndicationsSummary(@ProcedureId)
	WHERE ProcedureId = @ProcedureId
END
GO
dbo.DropIfExist
    @ObjectName = 'procedure_imaging_method_select',      -- varchar(100)
    @ObjectTypePrefix = 'S' -- varchar(5)
GO
CREATE PROCEDURE [dbo].[procedure_imaging_method_select]
(
	@ProcedureId int
)
AS
BEGIN
	SELECT
		UniqueId, [Description], AdditionalInformation
	FROM ERS_ProcedureImagingMethod p
		INNER JOIN ERS_ImagingMethods i on p.ImagingMethodId = i.UniqueId 
	WHERE ProcedureId = @ProcedureId AND Suppressed = 0
END
GO
dbo.DropIfExist
    @ObjectName = 'imaging_method_select',      -- varchar(100)
    @ObjectTypePrefix = 'S' -- varchar(5)
GO
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[imaging_method_select]
AS
BEGIN
	SELECT UniqueId, [Description],AdditionalInfo
	FROM ERS_ImagingMethods
	WHERE Suppressed = 0
	ORDER BY ISNULL(ListOrderBy, 999)
END
GO

EXEC dbo.DropIfExist @ObjectName = 'ProcedureIndicationsSummary',      -- varchar(100)
                     @ObjectTypePrefix = 'F' -- varchar(5)
GO

CREATE FUNCTION [dbo].[ProcedureIndicationsSummary]
(
	@ProcedureId int
)
RETURNS varchar(max)
AS
BEGIN

DECLARE @StageString  varchar(max),@IndicationsString  varchar(max), @ComorbidityString varchar(max), @DamagingDrugsString varchar(max), @PatientAllergiesString varchar(max), @PreviousSurgeryString varchar(max), 
		@PreviousDiseasesString varchar(max), @FamilyDiseaseHistoryString varchar(max), @ImagingString varchar(max), @ImagingOutcomeString varchar(max),
		@RetVal varchar(max), @ProcedureTypeId INT, @RepeatProcedurString varchar(max)

SELECT @ProcedureTypeId = ProcedureType FROM dbo.ERS_Procedures WHERE ProcedureId = @ProcedureId

--TFS 4327 Start
-------------------Repeat Procedure
DECLARE @Bronch INT, @Ebus INT, @SelectedAnswer BIT, @OtherTextValue VARCHAR(MAX), @RepeatUnknownId INT, @Other INT;

SELECT @Other = UniqueId FROM ERS_RepeatUnknownReasons WHERE Description = 'Other'
SELECT @Bronch = ProcedureTypeId FROM ERS_ProcedureTypes WHERE ProcedureType = 'Bronchoscopy';
SELECT @Ebus = ProcedureTypeId FROM ERS_ProcedureTypes WHERE ProcedureType = 'EBUS'
SELECT @SelectedAnswer = Answer, @OtherTextValue = OtherTextValue, @RepeatUnknownId = RepeatUnknownId FROM ERS_RepeatProcedureValue WHERE ProcedureId = @ProcedureId;

SELECT @RepeatProcedurString = 'This is ' + 
	CASE WHEN @SelectedAnswer = 1 THEN 'a repeat procedure because of ' + 
	ISNULL(ISNULL(NULLIF(@OtherTextValue, ''), (SELECT Description FROM ERS_RepeatUnknownReasons WHERE UniqueId = @RepeatUnknownId) + '.'),  @OtherTextValue)
	WHEN @SelectedAnswer = 0 THEN 'not a repeat procedure.' END;

IF LEN(@RepeatProcedurString) > 0 AND @ProcedureTypeId IN (@Bronch, @Ebus) 
	AND NOT EXISTS (SELECT 1 FROM ERS_RepeatProcedureValue WHERE ProcedureId = @ProcedureId AND @SelectedAnswer = 1 AND ISNULL(RepeatUnknownId, 0) = 0)
	AND NOT EXISTS (SELECT 1 FROM ERS_RepeatProcedureValue WHERE ProcedureId = @ProcedureId AND RepeatUnknownId = @Other AND ISNULL(OtherTextValue, '') = '')
BEGIN
	IF charindex(',', reverse(@RepeatProcedurString)) > 0
	SELECT @RetVal = STUFF(@RepeatProcedurString, len(@RepeatProcedurString) - charindex(' ,', reverse(@RepeatProcedurString)) + 0, 1, ' and ')
	ELSE
	SELECT @RetVal = @RepeatProcedurString
END

-------------------Indications
SELECT @IndicationsString =
	LTRIM(STUFF((SELECT ', ' + CASE WHEN i.AdditionalInfo = 0 THEN [Description] ELSE AdditionalInformation END + 
	CASE WHEN ISNULL(ChildIndicationId, 0) > 0 THEN '- ' + (SELECT [Description] FROM ERS_Indications WHERE UniqueId = epi.ChildIndicationId) ELSE '' END + 
	CASE WHEN i.AdditionalInfo = 0 AND ISNULL(AdditionalInformation, '') <> '' THEN ' ' + AdditionalInformation ELSE '' END AS [text()] 
	FROM ERS_ProcedureIndications epi 
	INNER JOIN ERS_Indications i on i.UniqueId = epi.IndicationId
	WHERE ProcedureId=@ProcedureId
	ORDER BY ISNULL(i.ListOrderBy, 0)
	FOR XML PATH('')),1,1,''))

--rockall and baltchford scoring
--changed by mostafiz 3702

SELECT @IndicationsString	= @IndicationsString + CASE WHEN CHARINDEX('melaena', @IndicationsString) > 0 OR CHARINDEX('haematemesis', @IndicationsString) > 0 THEN ' ' + dbo.fnBlatchfordRockallScores(@ProcedureId) ELSE '' END
--SELECT @IndicationsString = dbo.fnCapitalise(dbo.fnAddFullStop(@IndicationsString)) 

IF LEN(@IndicationsString) > 0
BEGIN
	IF charindex(',', reverse(@RepeatProcedurString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + STUFF(@IndicationsString, len(@IndicationsString) - charindex(' ,', reverse(@IndicationsString)) + 0, 1, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + @IndicationsString
END

--TFS 4327 End
--changed by mostafiz 3702

-------------------CoMorbidity
SELECT @ComorbidityString =
	LTRIM(STUFF((SELECT ', ' + CASE WHEN AdditionalInformation = '' THEN [Description] ELSE AdditionalInformation END + CASE WHEN ISNULL(ChildComorbidityId, 0) > 0 THEN '-' + (SELECT [Description] FROM ERS_CoMorbidity WHERE UniqueId = ChildComorbidityId) ELSE '' END AS [text()] 
	FROM ERS_ProcedureComorbidity epc 
	INNER JOIN ERS_Comorbidity c on c.uniqueid = CoMorbidityId
	WHERE ProcedureId=@ProcedureId
	ORDER BY ISNULL(c.ListOrderBy, 0)
	FOR XML PATH('')),1,1,''))

--SELECT @ComorbidityString = dbo.fnCapitalise(dbo.fnAddFullStop(@ComorbidityString)) 

IF LEN(@ComorbidityString) > 0 
BEGIN
	IF charindex(',', reverse(@ComorbidityString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Co-morbidity: ' + STUFF(@ComorbidityString, len(@ComorbidityString) - charindex(' ,', reverse(@ComorbidityString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Co-morbidity: ' + @ComorbidityString
END

-------------------Damaging drugs

--TFS 3544 Start

DECLARE @AntiCoagDrugs bit = (SELECT AntiCoagDrugs FROM ERS_Procedures WHERE ProcedureId = @ProcedureId)
IF @AntiCoagDrugs IS NOT NULL
	If @AntiCoagDrugs = 0 SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'The patient is not taking anti-coagulant or anti-platelet medication.' -- TFS 4440

SELECT @DamagingDrugsString =
	LTRIM(STUFF((SELECT ', ' + CASE WHEN LOWER([Description]) <> 'other' THEN [Description] WHEN LOWER([Description]) = 'other' AND [AdditionalInfo] IS NOT NULL AND LOWER([AdditionalInfo]) <> '' THEN [AdditionalInfo] ELSE '' END AS [text()]   -- TFS 4440
	FROM ERS_ProcedureDamagingDrugs edd 
	INNER JOIN ERS_PotentialDamagingDrugs d on d.uniqueid = edd.DamagingDrugId AND d.AntiCoag = 1
	WHERE edd.ProcedureId=@ProcedureId
	ORDER BY ISNULL(d.ListOrderBy, 0)
	FOR XML PATH('')),1,1,''))

IF LEN(@DamagingDrugsString) > 0
BEGIN
	IF charindex(',', reverse(@DamagingDrugsString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Anti-Coagulant drug(s): ' + STUFF(@DamagingDrugsString, len(@DamagingDrugsString) - charindex(' ,', reverse(@DamagingDrugsString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Anti-Coagulant drug(s): ' + @DamagingDrugsString
END
--Added by rony tfs-4171
DECLARE @PotentialSignificantDrugs bit = (SELECT PotentialSignificantDrugs FROM ERS_Procedures WHERE ProcedureId = @ProcedureId)
IF @PotentialSignificantDrugs IS NOT NULL
	If @PotentialSignificantDrugs = 0 SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'The patient is not taking potentially significant medication.' -- TFS 4440

SELECT @DamagingDrugsString =
	LTRIM(STUFF((SELECT ', ' + [Description] AS [text()] 
	FROM ERS_ProcedureDamagingDrugs edd 
	INNER JOIN ERS_PotentialDamagingDrugs d on d.uniqueid = edd.DamagingDrugId AND d.AntiCoag = 0
	WHERE edd.ProcedureId=@ProcedureId
	ORDER BY ISNULL(d.ListOrderBy, 0)
	FOR XML PATH('')),1,1,''))

IF LEN(@DamagingDrugsString) > 0
BEGIN
	IF charindex(',', reverse(@DamagingDrugsString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Potentially Significant drug(s): ' + STUFF(@DamagingDrugsString, len(@DamagingDrugsString) - charindex(' ,', reverse(@DamagingDrugsString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Potentially Significant drug(s): ' + @DamagingDrugsString
END

--TFS 3544 End

-------------------Allergies

SELECT @PatientAllergiesString =
	CASE AllergyResult 
		WHEN -1 THEN 'unknown'
		WHEN 0 THEN 'none'
		WHEN 1 THEN a.AllergyDescription 
	END
	FROM ERS_PatientAllergies a
		INNER JOIN ERS_Procedures p ON p.PatientId = a.PatientId
	WHERE a.ProcedureCreatedId = @ProcedureId	--edited by siddik tfs# 4384

--SELECT @PatientAllergiesString = dbo.fnCapitalise(dbo.fnAddFullStop(@PatientAllergiesString)) 

IF LEN(@PatientAllergiesString) > 0
BEGIN
	IF charindex(',', reverse(@PatientAllergiesString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Allergies: ' + STUFF(@PatientAllergiesString, len(@PatientAllergiesString) - charindex(' ,', reverse(@PatientAllergiesString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Allergies: ' + @PatientAllergiesString
END
------------------- Staging
--TFS#	3866
	SELECT @StageString=
  (SELECT   CONCAT(
	  --Staging Investigations
		CASE 
          WHEN StagingInvestigations <> 0 THEN 
			 (CASE WHEN [ClinicalGrounds] = 1 THEN 'Clinical Grounds only' ELSE '' END) +
			
			 (CASE WHEN [ImagingOfThorax] = 1 THEN 
			  CASE WHEN [ClinicalGrounds] = 1 THEN ', Cross sectional imaging of thorax' ELSE 'Cross sectional imaging of thorax' END
			  ELSE '' END) +
			
			 (CASE WHEN [PleuralHistology] = 1 THEN
			 CASE WHEN [ClinicalGrounds] = 1 OR [ImagingOfThorax] = 1 THEN ', Pleural cytology / histology' ELSE 'Pleural cytology / histology' END
			 ELSE '' END) +
			 (CASE WHEN [MediastinalSampling] = 1 THEN 
			 CASE WHEN [ClinicalGrounds] = 1 OR [ImagingOfThorax] = 1 OR [PleuralHistology] = 1 THEN ', Mediastinal Sampling' ELSE 'Mediastinal Sampling' END
			 ELSE '' END) +
			 (CASE WHEN [Metastases] = 1 THEN 
			 CASE WHEN [ClinicalGrounds] = 1 OR [ImagingOfThorax] = 1 OR [PleuralHistology] = 1 OR [MediastinalSampling] = 1 THEN ', Diagnostic tests for metastases' ELSE 'Diagnostic tests for metastases' END
			 ELSE '' END) + 
			 (CASE WHEN [Bronchoscopy] = 1 THEN 
			 CASE WHEN [ClinicalGrounds] = 1 OR [ImagingOfThorax] = 1 OR [PleuralHistology] = 1 OR [MediastinalSampling] = 1 OR [Metastases] = 1 THEN ', Bronchoscopy' ELSE 'Bronchoscopy' END
			 ELSE '' END)
         ELSE ''
       END,
	   CASE WHEN ([ClinicalGrounds] = 1 OR [ImagingOfThorax] = 1 OR [PleuralHistology] = 1 OR [MediastinalSampling] = 1 OR [Metastases] = 1 OR Bronchoscopy = 1 ) AND [Stage] = 1  THEN   ' <br/> '  ELSE ''END,
		--stage
		CASE WHEN [Stage] = 1 THEN
		     CONCAT (		 
			 CASE WHEN StageLocation <> 0 then 
			 CONCAT ('Location of primary tumour - ' , CASE WHEN StageLocation = 1 THEN 'Oesophagus' 
	         WHEN StageLocation = 2 THEN 'Oesophagogastric junction' 
	         WHEN StageLocation = 3 THEN 'Stomach' 
             ELSE ''
	         END)
	    ELSE '' END,
			 	 
	 CASE WHEN StageLocation <> 0  AND (StageT <> 0 OR StageN <> 0 OR StageM <> 0 ) THEN ' and ' ELSE ''END,	 
	 CASE WHEN StageT <> 0 then
	 CONCAT ('T - ', CASE WHEN StageT = 1 THEN 'TX' 
	      WHEN StageT = 2 THEN 'T0' 
	      WHEN StageT = 3 THEN 'Tis' 
		  WHEN StageT = 4 THEN 'T1' 
		  WHEN StageT = 5 THEN 'T1a' 
		  WHEN StageT = 6 THEN 'T1b' 
		  WHEN StageT = 7 THEN 'T2' 
	      WHEN StageT = 8 THEN 'T3'
	      WHEN StageT = 9 THEN 'T4'
	      WHEN StageT = 10 THEN 'T4a'
	      WHEN StageT = 11 THEN 'T4b'
	 ELSE ''
	 END )


	 ELSE '' END,
	 CASE WHEN (StageT <> 0  )  AND StageN <> 0 THEN ', ' ELSE ''END,
	 CASE WHEN StageN <> 0 THEN 
	 CONCAT ('N - ', CASE WHEN StageN = 1 THEN 'NX' 
	      WHEN StageN = 2 THEN 'N0' 
	      WHEN StageN = 3 THEN 'N1' 
		  WHEN StageN = 4 THEN 'N2' 
		  WHEN StageN = 5 THEN 'N3' 
	 ELSE ''
	 END)
	 ELSE '' END,
	 CASE WHEN (StageN <> 0 or StageT <> 0  ) AND StageM <> 0 THEN ', ' ELSE ''END,
	 	 CASE WHEN StageM <> 0 THEN
		    CONCAT ('M - ', CASE WHEN StageM = 1 THEN 'MX' 
	        WHEN StageM = 2 THEN 'M0' 
	        WHEN StageM = 3 THEN 'M1' 
	        ELSE ''
	        END)
	    ELSE '' end
           )
	ELSE '' END,
   CASE WHEN StagingInvestigations <> 0  OR [Stage] <> 0 THEN   '<br/> Performance Status - '  ELSE 'Performance Status - 'END,
   -- Performance Status
		CASE WHEN [PerformanceStatus] = 1 THEN
		CASE
		WHEN [PerformanceStatusType] = 1 THEN 'normal activity'
		WHEN [PerformanceStatusType] = 2 THEN 'able to carry out light work'
		WHEN [PerformanceStatusType] = 3 THEN 'unable to carry out any work'
		WHEN [PerformanceStatusType] = 4 THEN 'limited self care'
		WHEN [PerformanceStatusType] = 5 THEN 'completely disabled'
		ELSE ''
		END
		ELSE NULL
		END)
	FROM [ERS_ProcedureStaging] where ProcedureId = @ProcedureId
	 )
 
	IF LEN(@StageString) > 0
	BEGIN

	SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Staging: ' + @StageString
	END


	--   End of TFS#	3866
-------------------Previous surgery

SELECT @PreviousSurgeryString =
	LTRIM(STUFF((SELECT DISTINCT ', ' + [Description] 
	--+ CASE WHEN ListItemText = 'Unknown' THEN '' ELSE ' ' + ListItemText END 
	as [text()] 
	FROM ERS_PatientPreviousSurgery h
	INNER JOIN ERS_PreviousSurgery r on r.UniqueID = h.PreviousSurgeryID
	INNER JOIN dbo.ERS_PreviousSurgeryProcedureTypes pspt ON pspt.PreviousSurgeryId = r.UniqueId AND pspt.ProcedureTypeId = @ProcedureTypeId
	--INNER JOIN ERS_Lists l on l.ListItemNo = h.PreviousSurgeryPeriod and ListDescription = 'Follow up disease Period'
	INNER JOIN ERS_Procedures p on p.patientId = h.patientId 
	WHERE p.ProcedureId = @ProcedureId
	--ORDER BY ISNULL(r.ListOrderBy, 0)
	FOR XML PATH('')),1,1,''))

--SELECT @PreviousSurgeryString = dbo.fnCapitalise(dbo.fnAddFullStop(@PreviousSurgeryString)) 

IF LEN(@PreviousSurgeryString) > 0
BEGIN
	IF charindex(',', reverse(@PreviousSurgeryString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Previous surgery: ' + STUFF(@PreviousSurgeryString, len(@PreviousSurgeryString) - charindex(' ,', reverse(@PreviousSurgeryString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Previous surgery: ' + @PreviousSurgeryString
END

-------------------ASA Status
DECLARE @ASAStatusString varchar(max) = 
	(SELECT TOP 1 [description]
	FROM ERS_PatientASAStatus pa 
		INNER JOIN ERS_ASAStatus a on a.uniqueid = pa.asastatusid
		INNER JOIN ERS_Procedures p ON p.PatientId = pa.PatientId
	WHERE ProcedureId = @ProcedureId and p.ProcedureType NOT IN (select ProcedureTypeId from ers_procedureTypes WHERE ProcedureType IN ('Bronchoscopy','EBUS') ) -- 4430
	order by isnull(pa.WhenUpdated, pa.WhenCreated))

IF LEN(@ASAStatusString) > 0 
BEGIN
	SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'ASA Status: ' + @ASAStatusString
END
-------------------Previous diseases

SELECT @PreviousDiseasesString =
	LTRIM(STUFF((SELECT DISTINCT ', ' + CASE WHEN AdditionalInformation = '' THEN [Description] ELSE AdditionalInformation END AS [text()] --TFS 3072
	FROM ERS_PatientPreviousDiseases pd
	INNER JOIN ERS_PreviousDiseases d on d.UniqueID = pd.PreviousDiseaseID
	INNER JOIN dbo.ERS_PreviousDiseaseProcedureTypes ppt ON ppt.PreviousDiseaseId = d.UniqueId AND ppt.ProcedureTypeId = @ProcedureTypeId
	INNER JOIN ERS_Procedures p on p.patientId = pd.patientId 
	WHERE p.ProcedureId = @ProcedureId
	--ORDER BY ISNULL(r.ListOrderBy, 0)
	FOR XML PATH('')),1,1,''))

--SELECT @PreviousDiseasesString = dbo.fnCapitalise(dbo.fnAddFullStop(@PreviousDiseasesString)) 

IF LEN(@PreviousDiseasesString) > 0
BEGIN
	IF charindex(',', reverse(@PreviousDiseasesString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Previous diseases: ' + STUFF(@PreviousDiseasesString, len(@PreviousDiseasesString) - charindex(' ,', reverse(@PreviousDiseasesString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Previous diseases: ' + @PreviousDiseasesString
END

-------------------Family disease history

SELECT @FamilyDiseaseHistoryString =
	LTRIM(STUFF((SELECT ', ' + CASE WHEN AdditionalInformation = '' THEN [Description] ELSE AdditionalInformation END AS [text()] 
	FROM ERS_PatientFamilyDiseaseHistory epi 
	INNER JOIN ERS_FamilyDiseaseHistory i on i.UniqueId = epi.FamilyDiseaseHistoryId
	INNER JOIN ERS_Procedures p on p.ProcedureId = epi.ProcedureCreatedId	--edited by siddik tfs# 4318
	WHERE p.ProcedureId = @ProcedureId
	ORDER BY ISNULL(i.ListOrderBy, 999)
	FOR XML PATH('')),1,1,''))

--SELECT @FamilyDiseaseHistoryString = dbo.fnCapitalise(dbo.fnAddFullStop(@FamilyDiseaseHistoryString)) 

IF LEN(@FamilyDiseaseHistoryString) > 0 AND @ProcedureTypeId NOT IN(10, 11) -- TFS 4061
BEGIN
	IF charindex(',', reverse(@FamilyDiseaseHistoryString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Family history: ' + STUFF(@FamilyDiseaseHistoryString, len(@FamilyDiseaseHistoryString) - charindex(' ,', reverse(@FamilyDiseaseHistoryString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Family history: ' + @FamilyDiseaseHistoryString
END


-------------------Imaging

SELECT @ImagingString =
	LTRIM(STUFF((SELECT ', ' +iif(im.AdditionalInfo=1,CONCAT([Description],': ', pim.AdditionalInformation), [Description]) AS [text()] --TFS#	3810
	FROM ERS_ImagingMethods im 
	INNER JOIN ERS_ProcedureImagingMethod pim on im.uniqueid = pim.ImagingMethodId
	WHERE pim.ProcedureId=@ProcedureId
	FOR XML PATH('')),1,1,''))


--IF LEN(@ImagingString) > 0--Unnecessary
--BEGIN
--	IF charindex(',', reverse(@ImagingString)) > 0
--		SELECT @ImagingString = STUFF(@ImagingString, len(@ImagingString) - charindex(' ,', reverse(@ImagingString)), 2, ' and ')
--END


SELECT @ImagingOutcomeString =
	LTRIM(STUFF((SELECT ', ' + [Description] AS [text()] 
	FROM ERS_ImagingOutcomes imo 
	INNER JOIN ERS_ProcedureImagingOutcome pio on imo.uniqueid = pio.ImagingOutcomeId
	WHERE pio.ProcedureId=@ProcedureId
	FOR XML PATH('')),1,1,''))

IF ISNULL(@ImagingOutcomeString,'') <> ''
BEGIN
	SELECT @ImagingString = CASE WHEN ISNULL(@ImagingString, '') <> '' THEN @ImagingString + ' revealed ' ELSE '' END  + @ImagingOutcomeString
END


--SELECT @ImagingString = dbo.fnCapitalise(dbo.fnAddFullStop(@ImagingString)) 

IF LEN(@ImagingString) > 0
BEGIN
	IF charindex(',', reverse(@ImagingString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Imaging: ' + STUFF(@ImagingString, len(@ImagingString) - charindex(' ,', reverse(@ImagingString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Imaging: ' + @ImagingString
END


DECLARE @SmokingString varchar(max)


SELECT @SmokingString=
	LTRIM(STUFF((SELECT '  ' +SmokingDescription   AS [text()] 
	FROM ERS_ProcedureSmoking epi 
	WHERE ProcedureId=@ProcedureId
	FOR XML PATH('')),1,1,''))

--SELECT @SmokingString = dbo.fnCapitalise(dbo.fnAddFullStop(@SmokingString)) 

IF LEN(@SmokingString) > 0
BEGIN
	IF charindex(',', reverse(@SmokingString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>Smoking:</b> ' + @SmokingString
		--SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>Smoking:</b> ' + STUFF(@SmokingString, len(@SmokingString) - charindex(' ,', reverse(@SmokingString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>Smoking:</b> ' + @SmokingString
END
--tfs 2132
DECLARE @AlcoholingString varchar(max)


SELECT @AlcoholingString=
	LTRIM(STUFF((SELECT '  ' +AlcoholingDescription   AS [text()] 
	FROM ERS_ProcedureAlcoholing epi 
	WHERE ProcedureId=@ProcedureId
	FOR XML PATH('')),1,1,''))

--SELECT @SmokingString = dbo.fnCapitalise(dbo.fnAddFullStop(@SmokingString)) 

IF LEN(@AlcoholingString) > 0
BEGIN
	IF charindex(',', reverse(@AlcoholingString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>Alcohol:</b> ' + @AlcoholingString
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>Alcohol:</b> ' + @AlcoholingString
END
--end --tfs 2132

DECLARE @LUTSIPSSString varchar(max)
DECLARE @LUTSIPSSTotalScoreString varchar(max)
-- edited by mostafiz issue 3892
SELECT @LUTSIPSSString =
    LTRIM(STUFF((SELECT ', ' + 
                        CASE 
                            WHEN SectionName <> 'Quality of life due to urinary symptoms' THEN SectionName + '(Score:' + CAST(ls.ScoreValue AS VARCHAR(10)) + ')' -- TFS 3892
                        END AS [text()]
                FROM ERS_ProcedureLUTSIPSSSymptoms a
                INNER JOIN ERS_LUTSIPSSSymptoms b ON a.LUTSIPSSSymptomId = b.UniqueId
                INNER JOIN ERS_LUTSIPSSSymptomSections s ON b.LUTSIPSSSymptomSectionId = s.LUTSIPSSSymptomSectionId
                INNER JOIN ERS_IPSSScore ls ON a.SelectedScoreId = ls.ScoreId
                WHERE ProcedureId = @ProcedureId AND SelectedScoreId > 1
                FOR XML PATH('')), 1, 1, ''))
-- edited by mostafiz issue 3892
--SELECT @LUTSIPSSString = dbo.fnCapitalise(dbo.fnAddFullStop(@LUTSIPSSString)) 

select top 1  @LUTSIPSSTotalScoreString =  'Total Score :' + cast(TotalScoreValue as varchar(10)) 
from  ERS_ProcedureLUTSIPSSSymptoms where ProcedureId=@ProcedureId
IF LEN(@LUTSIPSSString) > 0
BEGIN
	IF charindex(',', reverse(@LUTSIPSSString)) > 0
		--TFS 3892 Start
		BEGIN
			SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>LUTS\IPSS symptom score:</b>' + @LUTSIPSSString
			SET @RetVal = @RetVal + ' ' + @LUTSIPSSTotalScoreString + ' '+'<br />'
		END 
		--TFS 3892 End
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>LUTS\IPSS symptom score:</b> ' + @LUTSIPSSString

	--SELECT @RetVal = ISNULL(@RetVal + '<br />', '') +  @LUTSIPSSTotalScoreString
END

-- TFS 3892 Start

DECLARE @QualityOfLife varchar(max)

SELECT @QualityOfLife =
    LTRIM(STUFF((SELECT ', ' + 
                        CASE
                            WHEN SectionName = 'Quality of life due to urinary symptoms' THEN (SectionName + '(Score:' + CAST(ls.ScoreValue AS VARCHAR(10)) + ' - ' + (SELECT ScoreDescription FROM ERS_IPSSScoreQuality WHERE ScoreId = ls.ScoreId)+')')
                        END AS [text()]
                FROM ERS_ProcedureLUTSIPSSSymptoms a
                INNER JOIN ERS_LUTSIPSSSymptoms b ON a.LUTSIPSSSymptomId = b.UniqueId
                INNER JOIN ERS_LUTSIPSSSymptomSections s ON b.LUTSIPSSSymptomSectionId = s.LUTSIPSSSymptomSectionId
                INNER JOIN ERS_IPSSScore ls ON a.SelectedScoreId = ls.ScoreId
                WHERE ProcedureId = @ProcedureId AND SelectedScoreId >= 1
                FOR XML PATH('')), 1, 1, ''))
IF LEN(@QualityOfLife) > 0
BEGIN
	SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + @QualityOfLife
END

DECLARE @PreviousDiseaseUrologyString varchar(max)

SELECT @PreviousDiseaseUrologyString=
	LTRIM(STUFF((SELECT ', ' +case 
       when a.Description='Other' then b.AdditionalInformation
	   else a.Description
	  end
   AS [text()] 
	from ERS_PreviousDiseasesUrology a, ERS_ProcedurePreviousDiseasesUrology b 
	where a.UniqueId=b.PreviousDiseaseId
	and b.ProcedureId=@ProcedureId
	order by PreviousDiseaseSectionId
	FOR XML PATH('')),1,1,''))

--SELECT @PreviousDiseaseUrologyString = dbo.fnCapitalise(dbo.fnAddFullStop(@PreviousDiseaseUrologyString)) 


IF LEN(@PreviousDiseaseUrologyString) > 0
BEGIN
	IF charindex(',', reverse(@PreviousDiseaseUrologyString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>Past Urological Histrory:</b>' + STUFF(@PreviousDiseaseUrologyString, len(@PreviousDiseaseUrologyString) - charindex(' ,', reverse(@PreviousDiseaseUrologyString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>Past Urological Histrory:</b> ' + @PreviousDiseaseUrologyString

	
END

DECLARE @UrineDipstickCytologyString varchar(max)

SELECT @UrineDipstickCytologyString=
	LTRIM(STUFF((SELECT ', ' + b.Description + ' '+c.Description 
   AS [text()] 
	from ERS_ProcedureUrineDipstickCytology a,ERS_UrineDipstickCytology b,ERS_UrineDipstickCytology c
	where a.ProcedureId=@ProcedureId
	and a.UrineDipstickCytologyId=b.UniqueId
	and a.ChildUrineDipstickCytologyId=c.UniqueId
	order by b.UrineDipstickCytologySectionId,b.ListOrderBy
	FOR XML PATH('')),1,1,''))

--SELECT @UrineDipstickCytologyString = dbo.fnCapitalise(dbo.fnAddFullStop(@UrineDipstickCytologyString)) 


IF LEN(@UrineDipstickCytologyString) > 0
BEGIN
	IF charindex(',', reverse(@UrineDipstickCytologyString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>Urine Dipstick And Cytology:</b>' + STUFF(@UrineDipstickCytologyString, len(@UrineDipstickCytologyString) - charindex(' ,', reverse(@UrineDipstickCytologyString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>Urine Dipstick And Cytology:</b>' + @UrineDipstickCytologyString --MH closed bold tag </b> here on 18 Apr 2024
END


--------------Broncs referral data
DECLARE @BroncoReferralDataString varchar(max), @DateBronchRequested DATETIME,
		@DateOfReferral DATETIME,
		@LCaSuspectedBySpecialist BIT,
		@CTScanAvailable BIT,
		@DateOfScan DATETIME

	SELECT @DateBronchRequested=DateBronchRequested,
		   @DateOfReferral=DateOfReferral,
		   @LCaSuspectedBySpecialist=LCaSuspectedBySpecialist,
		   @CTScanAvailable=CTScanAvailable,
		   @DateOfScan = DateOfScan --Added by rony tfs-4309
	FROM ERS_ProcedureBronchoReferralData
	WHERE ProcedureId = @ProcedureId

	IF @DateBronchRequested IS NOT NULL SET @BroncoReferralDataString  = ISNULL(@BroncoReferralDataString,'') + 'Date bronchoscopy requested ' + CONVERT(VARCHAR, @DateBronchRequested, 105) + '. '
	IF @DateOfReferral IS NOT NULL SET @BroncoReferralDataString  = ISNULL(@BroncoReferralDataString,'') + 'Date of referral ' + CONVERT(VARCHAR, @DateOfReferral, 105) + '. '
	IF @LCaSuspectedBySpecialist = 1 SET @BroncoReferralDataString  = ISNULL(@BroncoReferralDataString,'') + 'Lung Ca suspected by lung Ca specialist' + '. '
	IF @CTScanAvailable = 1 SET @BroncoReferralDataString  = ISNULL(@BroncoReferralDataString,'') + 'CT scan available prior to bronchoscopy' + '. '
	IF @DateOfScan IS NOT NULL SET @BroncoReferralDataString  = ISNULL(@BroncoReferralDataString,'') + 'Date of scan ' + CONVERT(VARCHAR, @DateOfScan, 105) + '. '
	

	IF @BroncoReferralDataString IS NOT NULL SET @BroncoReferralDataString = 'Referal Data (' + RTRIM(@BroncoReferralDataString )+ ')'
	ELSE SET @BroncoReferralDataString = ''
	
	IF LEN(@BroncoReferralDataString) > 0
	BEGIN
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + @BroncoReferralDataString
	END


RETURN @RetVal
END
GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	3810, 4309, 4430, 4440 Ended
------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Muhammad Nasim
-- TFS#	3217
-- Description of change: Surveillance high/medium/ low radio button(Risk: High / Medium / Low)
-------------------------------------------------------------------------------------------------------------------------
declare @ParentId int,@IndicationSectionId int,@IndicationId int,@ProcedureTypeId int,@Description varchar(20)
--description cursor for High,Medium,Low
declare DescriptionCursor cursor for 
SELECT v.[Description] FROM (VALUES ('High'), ('Medium'), ('Low')) AS v([Description])
open DescriptionCursor
fetch next from DescriptionCursor into @Description
while @@FETCH_STATUS=0
begin
	if not exists(select 1 from [dbo].[ERS_Indications] where [Description]=@Description)
	begin
		--UniqueId of each surveillance type indication
		declare IndicationCursor cursor for 
		select UniqueId,IndicationSectionId from ERS_Indications where Description like '%surveillance%'
		open IndicationCursor
		fetch next from IndicationCursor into @ParentId,@IndicationSectionId
		while @@FETCH_STATUS=0
		begin
			INSERT INTO [dbo].[ERS_Indications]([Description],[NEDTerm],[Suppressed],[AdditionalInfo],[SubIndicationParent],[PlannedProcedure],[ParentId],[IndicationSectionId],[JAGAuditable])
			VALUES(@Description,@Description,0,0,0,0,@ParentId,@IndicationSectionId,0)
			set @IndicationId=SCOPE_IDENTITY()
			--ProcedureTypeId of each UniqueId of each surveillance type indication
			declare ProcedureTypeCursor cursor for 
			select distinct ProcedureTypeId from ERS_IndicationsProcedureTypes where IndicationId=@ParentId
			open ProcedureTypeCursor
			fetch next from ProcedureTypeCursor into @ProcedureTypeId
			while @@FETCH_STATUS=0
			begin
				INSERT INTO [dbo].[ERS_IndicationsProcedureTypes]([IndicationId],[ProcedureTypeId])
				VALUES(@IndicationId ,@ProcedureTypeId)
				fetch next from ProcedureTypeCursor into @ProcedureTypeId
			end
			close ProcedureTypeCursor
			deallocate ProcedureTypeCursor
		
			fetch next from IndicationCursor into @ParentId,@IndicationSectionId
		end
		CLOSE IndicationCursor
		DEALLOCATE IndicationCursor
	end
fetch next from DescriptionCursor into @Description
end
CLOSE DescriptionCursor
DEALLOCATE DescriptionCursor
GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	3217 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Muhammad Nasim
-- TFS#	3851 & 3911 & 4078
-- Description of change: the system will allow you to move forward without a further value in indications other than FIT & Patient DNA Reprot -  Follow up section not needed & Validation for Other sub indications free text box
-------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ferdowsi
-- TFS#	4380
-- Description of change: Start & finish time - Bronch, EBUS & Cystoscopy
-------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 14.6.24
-- TFS#	
-- Description of change
-- Removed FIT validation, Set to DNA exempt so will get excluded from the check when procedure is DNA
------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 25.6.24
-- TFS#	(Spreadsheet item 16)
-- Description of change
-- Start and end time validation fails if both are the same time
------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 25.6.24
-- TFS#	(Spreadsheet item )
-- Description of change
-- Extent checked for both endoscopists for training lists
------------------------------------------------------------------------------------------------------------------------
GO
EXEC dbo.DropIfExist
    @ObjectName = 'check_requiredfields',      -- varchar(100)
    @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[check_requiredfields]
(
	@ProcedureId INT,
	@PageId INT,
	@LoggedInUserId INT,
	@OperatingHospitalId INT
)
AS
BEGIN
	DECLARE @ProcedureTypeId INT,@NEDEnabled int, @ProcedureDNA INT, @UISectionId INT, @SectionName VARCHAR(50), @SectionPageId INT, @SectionControl VARCHAR(50), @IncompleteSections VARCHAR(MAX) = '', @ProcedureModifiedDate DATETIME, @ProcedureCompleted BIT, @FITValue int,@ReportUpdated BIT
	SELECT @ProcedureTypeId = ProcedureType, @ProcedureDNA = ISNULL(DNA,0), @ProcedureModifiedDate = ModifiedOn, @ProcedureCompleted = ISNULL(ProcedureCompleted,0),@ReportUpdated = ReportUpdated FROM ERS_Procedures WHERE ProcedureId = @ProcedureId
	
	DECLARE @ProcedureEndoCount INT
	IF EXISTS (SELECT 1 FROM ERS_Procedures WHERE ProcedureId = @ProcedureId AND Endoscopist2 IS NOT NULL)
		SET @ProcedureEndoCount = 2
	ELSE
		SET @ProcedureEndoCount = 1

	IF @ReportUpdated = 1 AND @ProcedureModifiedDate >= (SELECT TOP 1 InstallDate
																FROM DBVersion
																WHERE SUBSTRING(VersionNum,1,1) = '2'
																ORDER BY InstallDate ASC)
	

	BEGIN
	IF @ProcedureTypeId NOT IN (Select ProcedureTypeId From ERS_ProcedureTypes Where ProcedureType in ('Cystoscopy','Bronchoscopy','EBUS')) 
		BEGIN
		
	
			DECLARE cur CURSOR FOR (SELECT DISTINCT us.UISectionId, SectionName, PageId, SectionControl
									FROM UI_sections us
										LEFT JOIN UI_SectionProcedureTypes spt ON spt.UISectionId = us.UISectionId
									WHERE NEDRequired = 1 
									AND ISNULL(ProcedureTypeId,0) IN (0,@ProcedureTypeId) 
									AND DNAExempt = CASE WHEN @ProcedureDNA > 0 THEN 0 ELSE DNAExempt END 
									AND (PageId = @PageId OR @PageId = 0))
								
			SET @IncompleteSections = ''
			OPEN cur
			FETCH NEXT FROM cur INTO @UISectionId, @SectionName, @SectionPageId, @SectionControl

			WHILE @@FETCH_STATUS = 0
			BEGIN
				IF NOT EXISTS (SELECT 1 FROM dbo.ERS_ProcedureSummary WHERE ProcedureId = @ProcedureId AND SectionId = @UISectionId)
				BEGIN
					SET @IncompleteSections =@IncompleteSections + '&bull;' + @SectionName + '<br />'
				END
		
				IF LOWER(@SectionName) = 'extent' AND CHARINDEX('extent',@IncompleteSections) = 0 /*no point validating if its not complete*/
				BEGIN
					IF (SELECT COUNT(*) FROM dbo.ERS_ProcedureSummary WHERE ProcedureId = @ProcedureId AND SectionId = @UISectionId) < @ProcedureEndoCount
					BEGIN
						SET @IncompleteSections = @IncompleteSections + '&bull;' + @SectionName + ' is incomplete. Both ensocopists must record their result<br />'
					END
				END
		
				IF LOWER(@SectionName) = 'jmanoevre' AND CHARINDEX('jmanoevre',@IncompleteSections) = 0 /*no point validating if its not complete*/
				BEGIN
					IF (SELECT COUNT(*) FROM dbo.ERS_ProcedureSummary WHERE ProcedureId = @ProcedureId AND SectionId = @UISectionId) < @ProcedureEndoCount
					BEGIN
						SET @IncompleteSections = @IncompleteSections + '&bull;' + @SectionName + ' is incomplete. Both ensocopists must record their result<br />'
					END
				END

				IF LOWER(@SectionName) = 'procedure timing' AND CHARINDEX('',@IncompleteSections) = 0 /*no point validating if its not complete*/
				BEGIN
					DECLARE @StartTime DATETIME, @EndTime DATETIME
					SELECT @StartTime= StartDateTime, @EndTime = EndDateTime FROM ERS_Procedures WHERE ProcedureId= @ProcedureId
					IF @StartTime > @EndTime OR @StartTime = @EndTime
					BEGIN
						SET @IncompleteSections = @IncompleteSections + '&bull;' + @SectionName + ' is incorrect. Check start is not after end date/time<br />'
					END
				END

				IF LOWER(@SectionName) = 'indications'
				BEGIN
					--'check sub indications'
					IF (SELECT COUNT(*) 
					FROM 
						(SELECT CASE WHEN ei.SubIndicationParent = 0 THEN 1 WHEN ei.SubIndicationParent = 1 AND EXISTS (SELECT 1 FROM dbo.ERS_ProcedureSubIndications epsi WHERE epsi.ProcedureId = ep.ProcedureId) THEN 1 ELSE 0 END AS 'Complete'
						FROM dbo.ERS_ProcedureIndications ep
							INNER JOIN dbo.ERS_Indications ei ON ei.UniqueId = ep.IndicationId
						WHERE procedureid = @ProcedureId) inds
						WHERE inds.Complete = 0) > 0
					BEGIN
						SET @IncompleteSections = @IncompleteSections + '&bull;Subindications<br />'
					END
					else if exists (select 1 from ERS_ProcedureSubIndications where procedureid=@ProcedureId and SubIndicationId=(select UniqueId from ERS_SubIndications where [Description]='Other') and len(AdditionalInfo)=0)--TFS 4078
					begin
						SET @IncompleteSections = @IncompleteSections + '&bull;Subindications<br />'
					end
				END

				IF LOWER(@SectionName) = 'rx'
				BEGIN
					--check if anti coag has been marked as yes.. if so perform checks 
					DECLARE @AntiCoagDrugs BIT
					SELECT @AntiCoagDrugs = AntiCoagDrugs FROM ERS_Procedures WHERE ProcedureId = @ProcedureId
					IF @AntiCoagDrugs = 1 
					BEGIN
						IF NOT EXISTS (SELECT 1 FROM ERS_ProcedureSummary WHERE ProcedureId = @ProcedureId AND SectionId = @UISectionId)
						BEGIN
							SET @IncompleteSections = REVERSE(SUBSTRING(REVERSE(@IncompleteSections), CHARINDEX('<br />', REVERSE(@IncompleteSections)) + 7, LEN(@IncompleteSections))) + '<small><em> - RX drugs must be complete for patients that are taking Anti-coag or Anti-platelet Medication</em></small><br />'
							SELECT @IncompleteSections
						END
					END
				END

				FETCH NEXT FROM cur INTO @UISectionId, @SectionName, @SectionPageId, @SectionControl
			END

			CLOSE cur
			DEALLOCATE cur

			--edited by siddik #TFS 3779
			DECLARE @PacemakerId INT = (SELECT UniqueId FROM ERS_Comorbidity WHERE Description = 'Pacemaker')
			DECLARE @DiabetesMellitusId INT = (SELECT UniqueId FROM ERS_Comorbidity WHERE Description = 'Diabetes Mellitus')
			IF @PageId IN (0, 1)
			BEGIN
				IF EXISTS (SELECT 1 FROM ERS_ProcedureComorbidity WHERE ProcedureId = @ProcedureId AND ChildComorbidityId = 0 AND ComorbidityId IN (@PacemakerId, @DiabetesMellitusId))
				BEGIN
					SET @IncompleteSections = @IncompleteSections + '&bull;Comorbidity<br />'
				END
			END
	
			--tfs# 3779 end
			
			--edited by siddik tfs# 3909
			IF EXISTS (SELECT 1 FROM ERS_UrgencyTypes c LEFT JOIN ERS_Procedures p ON c.UniqueId = p.CategoryListId WHERE p.ProcedureId = @ProcedureId AND c.Description = 'Urgent (suspected cancer pathway)')
				AND @PageId IN (0,3)
				AND @ProcedureDNA = 0
			BEGIN
				DECLARE @QuestionId INT = (SELECT QuestionId FROM ERS_PathwayPlanQuestions WHERE Question LIKE '%Evidence of cancer?%' AND ProcedureType = @ProcedureTypeId AND OperatingHospital = @OperatingHospitalId AND Suppressed = 0)

				IF @QuestionId > 0 AND NOT EXISTS (SELECT 1 FROM ERS_ProcedurePathwayPlanAnswers WHERE ProcedureId = @ProcedureId AND QuestionId = @QuestionId)
				BEGIN
					INSERT INTO ERS_ProcedurePathwayPlanAnswers (ProcedureId, QuestionId, OptionAnswer, WhoCreatedId, WhenCreated)
					VALUES (@ProcedureId, @QuestionId, 1, @LoggedInUserId, getdate())
				END
			
				IF EXISTS (SELECT 1 FROM ERS_ProcedurePathwayPlanAnswers WHERE ProcedureId = @ProcedureId AND QuestionId = @QuestionId AND OptionAnswer = 1 AND ISNULL(EvidenceOfCancer, 0) = 0)
				BEGIN
					SET @IncompleteSections = @IncompleteSections + '&bull;Pathway Plan<br />'		
				END
			END
			--tfs# 3909 end
		END

		--Edited by siddik tfs# 4327
		IF @ProcedureTypeId IN (SELECT ProcedureTypeId FROM ERS_ProcedureTypes WHERE ProcedureType IN ('Bronchoscopy', 'EBUS'))
		BEGIN
			DECLARE @SelectedAnswer BIT, @Other INT;
			SELECT @Other = UniqueId FROM ERS_RepeatUnknownReasons WHERE Description = 'Other'
			SELECT @SelectedAnswer = Answer FROM ERS_RepeatProcedureValue WHERE ProcedureId = @ProcedureId;
			IF @PageId IN (0, 1)
			BEGIN
				IF EXISTS (SELECT 1 FROM ERS_RepeatProcedureValue WHERE ProcedureId = @ProcedureId AND @SelectedAnswer = 1 AND ISNULL(RepeatUnknownId, 0) = 0)
					OR EXISTS (SELECT 1 FROM ERS_RepeatProcedureValue WHERE ProcedureId = @ProcedureId AND RepeatUnknownId = @Other AND ISNULL(OtherTextValue, '') = '')
				BEGIN
					SET @IncompleteSections = @IncompleteSections + '&bull;Repeat procedure<br />'
				END
			END
		END
		--tfs# 4327 end

		--Updated by	:	Muhammad Nasim tfs--4217
		--Add Anticoag validation for Cystoscopy
		IF @ProcedureTypeId=(Select ProcedureTypeId From ERS_ProcedureTypes Where ProcedureType in ('Cystoscopy'))
			begin
				IF (SELECT AntiCoagDrugs FROM ERS_Procedures WHERE ProcedureId = @ProcedureId)=1
				BEGIN
					IF NOT EXISTS (SELECT 1 FROM ERS_ProcedureSummary a left join UI_Sections b on a.SectionId=b.UISectionId WHERE a.ProcedureId = @ProcedureId AND b.SectionName = 'Anti-coag drugs')
					BEGIN
						SET @IncompleteSections = '&bull;Anti-coag drugs<br />'						
					END
				END
				else if (SELECT AntiCoagDrugs FROM ERS_Procedures WHERE ProcedureId = @ProcedureId) is null
				begin
					SET @IncompleteSections =  '&bull;Anti-coag drugs<br />'	
				end
			end

		---- added by Ferdowsi , TFS 4380

		IF  @ProcedureTypeId  IN (Select ProcedureTypeId From ERS_ProcedureTypes Where ProcedureType in ('Cystoscopy','Bronchoscopy','EBUS')) AND  @PageId in (2,3)
			BEGIN
			    SELECT DISTINCT  @SectionName =  SectionName  , @UISectionId = UISectionId FROM UI_sections us WHERE NEDRequired = 1  AND SectionName = 'Procedure timing' AND DNAExempt = CASE 
                WHEN 0 > 0 THEN 0 ELSE DNAExempt END AND (PageId = 2 ) 


				IF NOT EXISTS (SELECT 1 FROM dbo.ERS_ProcedureSummary WHERE ProcedureId = @ProcedureId AND SectionId = @UISectionId)
					SET @IncompleteSections =@IncompleteSections + '&bull;' + @SectionName + '<br />'
				ELSE  
				BEGIN
					SELECT @StartTime= StartDateTime, @EndTime = EndDateTime FROM ERS_Procedures WHERE ProcedureId= @ProcedureId
					IF @StartTime > @EndTime OR @StartTime = @EndTime
						SET @IncompleteSections = @IncompleteSections + '&bull;' + @SectionName + ' is incorrect. Check start is not after end date/time<br />'
				END
			END

		---- END , TFS 4380
		--End of Anticoag validation
		--All required fields entered, update flag ProcedureCompleted
		IF @PageId = 0 AND @IncompleteSections	 = ''
		BEGIN
			IF (SELECT ISNULL(ProcedureCompleted,0) FROM ERS_Procedures WHERE ProcedureId = @ProcedureId)  = 0
			BEGIN
				UPDATE ERS_Procedures SET ProcedureCompleted = 1 WHERE ProcedureId = @ProcedureId
			END
		END
		ELSE IF @IncompleteSections <> ''
		BEGIN
				UPDATE ERS_Procedures SET ProcedureCompleted = 0 WHERE ProcedureId = @ProcedureId
		END

		SELECT @IncompleteSections
	END
END
GO
----------------------------------------------------------------------------------------------------
--END TFS# 4217,4380
----------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Muhammad Nasim
-- TFS#	2407
-- Description of change: SEv2 EBUS - lymph node sites (multi on one)

-- Updated by	:	Ahmed Shoud
-- TFS#	4166
-- Description of change: Abnormalities Tree Save Function
------------------------------------------------------------------------------------------------------------------------
GO
	update ERS_SiteDetailsMenuUrls set NavigateUrl='~/Products/Broncho/Abnormalities/EBUSAbnormality.aspx' where NavigateUrl like '%~/Products/Broncho/Abnormalities/EBUSAbnoDescriptions.aspx%'
	IF EXISTS (SELECT 1 
           FROM sys.indexes 
           WHERE name = 'UQ_EBUSAbnoDescriptions_SiteId' 
             AND object_id = OBJECT_ID('dbo.ERS_EBUSAbnoDescriptions'))
	BEGIN
		Alter table dbo.ERS_EBUSAbnoDescriptions drop constraint UQ_EBUSAbnoDescriptions_SiteId
	END
	alter table ERS_EBUSAbnoDescriptions alter column Size Decimal(18,1) null
GO
dbo.DropIfExist
    @ObjectName = 'abnormalities_ebus_descriptions_select_by_side',      -- varchar(100)
    @ObjectTypePrefix = 'S' -- varchar(5)
GO
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE PROCEDURE [dbo].[abnormalities_ebus_descriptions_select_by_side]
(
	@SiteId INT	
)
AS

SET NOCOUNT ON

SELECT ROW_NUMBER() OVER(ORDER BY EBUSAbnoDescId ASC) as EBSample ,
	EBUSAbnoDescId,
	[SiteId],
	ISNULL([Normal], 0) AS Normal,
	ISNULL([Size], 0) AS Size,
	ISNULL([SizeNum], 0) AS SizeNum,
	ISNULL([Shape], 0) AS Shape,
	ISNULL([Margin], 0) AS Margin,
	ISNULL([Echogenecity], 0) AS Echogenecity,
	ISNULL([CHS], 0) AS CHS,
	ISNULL([CNS], 0) AS CNS,
	ISNULL([Vascular], 0) AS Vascular,
	ISNULL([BxType], 0) AS BxType,
	ISNULL([NoBxTaken], 0) AS NoBxTaken,
	ISNULL([BxNeedleType], 0) AS BxNeedleType,
	ISNULL([BxNeedleSize], 0) AS BxNeedleSize,
	ISNULL([BxNeedleSizeUnits], 0) AS BxNeedleSizeUnits,
	ISNULL([Summary], 0) AS Summary,
	[WhoUpdatedId],
	[WhoCreatedId],
	[WhenCreated],
	[WhenUpdated]
FROM 
	[dbo].[ERS_EBUSAbnoDescriptions]
WHERE 
	SiteId = @SiteId
GO
GO
dbo.DropIfExist
    @ObjectName = 'abnormalities_ebus_descriptions_select',      -- varchar(100)
    @ObjectTypePrefix = 'S' -- varchar(5)
GO
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE PROCEDURE [dbo].[abnormalities_ebus_descriptions_select]
(
	@EBUSAbnoDescId INT	
)
AS

SET NOCOUNT ON

SELECT
	EBUSAbnoDescId,
	[SiteId],
	ISNULL([Normal], 0) AS Normal,
	ISNULL([Size], 0) AS Size,
	ISNULL([SizeNum], 0) AS SizeNum,
	ISNULL([Shape], 0) AS Shape,
	ISNULL([Margin], 0) AS Margin,
	ISNULL([Echogenecity], 0) AS Echogenecity,
	ISNULL([CHS], 0) AS CHS,
	ISNULL([CNS], 0) AS CNS,
	ISNULL([Vascular], 0) AS Vascular,
	ISNULL([BxType], 0) AS BxType,
	ISNULL([NoBxTaken], 0) AS NoBxTaken,
	ISNULL([BxNeedleType], 0) AS BxNeedleType,
	ISNULL([BxNeedleSize], 0) AS BxNeedleSize,
	ISNULL([BxNeedleSizeUnits], 0) AS BxNeedleSizeUnits,
	ISNULL([Summary], 0) AS Summary,
	[WhoUpdatedId],
	[WhoCreatedId],
	[WhenCreated],
	[WhenUpdated]
FROM 
	[dbo].[ERS_EBUSAbnoDescriptions]
WHERE 
	EBUSAbnoDescId = @EBUSAbnoDescId
GO
dbo.DropIfExist
    @ObjectName = 'abnormalities_ebus_descriptions_save',      -- varchar(100)
    @ObjectTypePrefix = 'S' -- varchar(5)
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[abnormalities_ebus_descriptions_save]
(
	@EBUSAbnoDescId INT,
    @SiteId INT,
    @Normal BIT,
    @Size decimal(18,1),
    @SizeNum REAL,
    @Shape TINYINT,
    @Margin TINYINT,
    @Echogenecity TINYINT,
    @CHS TINYINT,
    @CNS TINYINT,
    @Vascular TINYINT,
    @BxType TINYINT,
    @NoBxTaken SMALLINT,
    @BxNeedleType TINYINT,
    @BxNeedleSize REAL,
    @BxNeedleSizeUnits TINYINT,
    @LoggedInUserId INT
)
AS
SET NOCOUNT ON;

DECLARE @proc_id INT;
DECLARE @proc_type INT;	

BEGIN TRANSACTION;

BEGIN TRY
        UPDATE
            ERS_EBUSAbnoDescriptions
        SET
            Normal = @Normal,
            Size = ISNULL(@Size, Size),
            SizeNum = ISNULL(@SizeNum, SizeNum),
            Shape = ISNULL(@Shape, Shape),
            Margin = ISNULL(@Margin, Margin),
            Echogenecity = ISNULL(@Echogenecity, Echogenecity),
            CHS = ISNULL(@CHS, CHS),
            CNS = ISNULL(@CNS, CNS),
            Vascular = ISNULL(@Vascular, Vascular),
            BxType = ISNULL(@BxType, BxType),
            NoBxTaken = ISNULL(@NoBxTaken, NoBxTaken),
            BxNeedleType = ISNULL(@BxNeedleType, BxNeedleType),
            BxNeedleSize = ISNULL(@BxNeedleSize, BxNeedleSize),
            BxNeedleSizeUnits = ISNULL(@BxNeedleSizeUnits, BxNeedleSizeUnits),
            WhoCreatedId = @LoggedInUserId,
            WhenCreated = GETDATE()
        WHERE
            EBUSAbnoDescId=@EBUSAbnoDescId AND SiteId = @SiteId;
END TRY
BEGIN CATCH
    DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT
        @ErrorMessage = ERROR_MESSAGE(),
        @ErrorSeverity = ERROR_SEVERITY(),
        @ErrorState = ERROR_STATE();

    RAISERROR(@ErrorMessage, @ErrorSeverity, @ErrorState);

    IF @@TRANCOUNT > 0
        ROLLBACK TRANSACTION;
END CATCH;


IF @@TRANCOUNT > 0
    COMMIT TRANSACTION;

GO
dbo.DropIfExist
    @ObjectName = 'abnormalities_ebus_descriptions_delete',      -- varchar(100)
    @ObjectTypePrefix = 'S' -- varchar(5)
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[abnormalities_ebus_descriptions_delete]
(
	@EBUSAbnoDescId INT,
	@SiteId int
)
as
begin
	delete from ERS_EBUSAbnoDescriptions where EBUSAbnoDescId=@EBUSAbnoDescId
	DECLARE @proc_id INT, @proc_type INT, @recordcount int;
    SELECT @proc_id = p.ProcedureId, @proc_type = p.ProcedureType FROM ERS_Sites s
    INNER JOIN ERS_Procedures p ON s.ProcedureId = p.ProcedureId WHERE SiteId = @SiteId;

	if not exists(select 1 from ERS_EBUSAbnoDescriptions where SiteId = @SiteId)
	begin
		DELETE FROM ERS_RecordCount WHERE ProcedureId=@proc_id and SiteId=@SiteId 
	end
	else
	begin
		set @recordcount =(select sum(RecordCount) from ERS_RecordCount where ProcedureId=@proc_id and SiteId=@SiteId)
		update ERS_RecordCount set RecordCount= @recordcount-1 where ProcedureId=@proc_id and SiteId=@SiteId 
	end
	--Update summary for serialize sample
	declare UpdateSummaryCursor cursor for select EBUSAbnoDescId from ERS_EBUSAbnoDescriptions where SiteId=@SiteId
	open UpdateSummaryCursor fetch next from UpdateSummaryCursor into @EBUSAbnoDescId
	while @@FETCH_STATUS=0
	begin
		exec [dbo].[ebus_abno_descrip_summary_update] @EBUSAbnoDescId
		fetch next from UpdateSummaryCursor into @EBUSAbnoDescId
	end
	close UpdateSummaryCursor
	deallocate UpdateSummaryCursor
end
GO
dbo.DropIfExist
    @ObjectName = 'abnormalities_ebus_descriptions_insert',      -- varchar(100)
    @ObjectTypePrefix = 'S' -- varchar(5)
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[abnormalities_ebus_descriptions_insert]
(
	@EBUSAbnoDescId INT,
    @SiteId INT,
    @Normal BIT,
    @Size decimal(18,1),
    @SizeNum REAL,
    @Shape TINYINT,
    @Margin TINYINT,
    @Echogenecity TINYINT,
    @CHS TINYINT,
    @CNS TINYINT,
    @Vascular TINYINT,
    @BxType TINYINT,
    @NoBxTaken SMALLINT,
    @BxNeedleType TINYINT,
    @BxNeedleSize REAL,
    @BxNeedleSizeUnits TINYINT,
    @LoggedInUserId INT,
	@PrimaryKey int OUTPUT
)
AS
SET NOCOUNT ON;

DECLARE @proc_id INT;
DECLARE @proc_type INT;	

BEGIN TRANSACTION;

BEGIN TRY
    SELECT
        @proc_id = p.ProcedureId,
        @proc_type = p.ProcedureType
    FROM
        ERS_Sites s
        INNER JOIN ERS_Procedures p
            ON s.ProcedureId = p.ProcedureId
    WHERE
        SiteId = @SiteId;

    IF NOT EXISTS
    (
        SELECT
            1
        FROM
            ERS_EBUSAbnoDescriptions
        WHERE
            EBUSAbnoDescId=@EBUSAbnoDescId AND SiteId = @SiteId
    )
    BEGIN
        INSERT INTO
            ERS_EBUSAbnoDescriptions
        (
            SiteId,
            Normal,
            Size,
            SizeNum,
            Shape,
            Margin,
            Echogenecity,
            CHS,
            CNS,
            Vascular,
            BxType,
            NoBxTaken,
            BxNeedleType,
            BxNeedleSize,
            BxNeedleSizeUnits,
            WhoCreatedId,
            WhenCreated
        )
        VALUES
        (@SiteId, @Normal, @Size, @SizeNum, @Shape, @Margin, @Echogenecity, @CHS, @CNS, @Vascular, @BxType, @NoBxTaken,
         @BxNeedleType, @BxNeedleSize, @BxNeedleSizeUnits, @LoggedInUserId, GETDATE());
		set @PrimaryKey=SCOPE_IDENTITY()
		if not exists(select 1 from ERS_RecordCount where ProcedureId=@proc_id and SiteId=@SiteId)
		begin
			INSERT INTO ERS_RecordCount([ProcedureId],[SiteId],[Identifier],[RecordCount])
			VALUES(@proc_id, @SiteId, 'EBUS Abnormality Descriptions', 1);
		end
		else
		begin
			declare @recordcount as int=(select sum(RecordCount) from ERS_RecordCount where ProcedureId=@proc_id and SiteId=@SiteId)
			update ERS_RecordCount set RecordCount= @recordcount+1 where ProcedureId=@proc_id and SiteId=@SiteId 
		end
        
    END;
END TRY
BEGIN CATCH
    DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT
        @ErrorMessage = ERROR_MESSAGE(),
        @ErrorSeverity = ERROR_SEVERITY(),
        @ErrorState = ERROR_STATE();

    RAISERROR(@ErrorMessage, @ErrorSeverity, @ErrorState);

    IF @@TRANCOUNT > 0
        ROLLBACK TRANSACTION;
END CATCH;


IF @@TRANCOUNT > 0
    COMMIT TRANSACTION;
GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
GO
IF OBJECT_ID('dbo.TR_EBUS_AbnoDesrip', 'TR') IS NOT NULL
BEGIN
    DROP TRIGGER [dbo].[TR_EBUS_AbnoDesrip];
END
GO
CREATE TRIGGER [dbo].[TR_EBUS_AbnoDesrip]
ON [dbo].[ERS_EBUSAbnoDescriptions]
AFTER INSERT, UPDATE, DELETE
AS 
	DECLARE @site_id INT, 
	@EBUSAbnoDescId int,
	@Action CHAR(1) = 'I',
	@none varchar(10),
	@summary varchar(max),
	@Size Decimal(18,1),
	@SizeNum REAL ,
	@Shape TINYINT,
	@Margin TINYINT,
	@Echogenecity TINYINT,
	@CHS TINYINT,
	@CNS TINYINT,
	@Vascular TINYINT,
	@BxType TINYINT,
	@NoBxTaken SMALLINT,
	@BxNeedleType TINYINT,
	@BxNeedleSize REAL,
	@BxNeedleSizeUnits TINYINT
	
    IF EXISTS(SELECT * FROM DELETED) SET @Action = CASE WHEN EXISTS(SELECT * FROM INSERTED) THEN 'U' ELSE 'D' END

	-- INSERTED OR UPDATED
	IF @Action IN ('I', 'U') 
	BEGIN
		SELECT 
			@site_id=SiteId ,
			@EBUSAbnoDescId=EBUSAbnoDescId
			--@Size = (CASE WHEN (Inserted.Size = 1) THEN 'True' ELSE 'False' END),
			--@SizeNum = (CASE WHEN (Inserted.SizeNum = 1) THEN 'True' ELSE 'False' END),
			--@Shape = (CASE WHEN (Inserted.Shape = 1) THEN 'True' ELSE 'False' END),
			--@Margin = (CASE WHEN (Inserted.Margin = 1) THEN 'True' ELSE 'False' END),
			--@Echogenecity = (CASE WHEN (Inserted.Echogenecity = 1) THEN 'True' ELSE 'False' END),
			--@CHS = (CASE WHEN (Inserted.CHS = 1) THEN 'True' ELSE 'False' END),
			--@CNS = (CASE WHEN (Inserted.CNS = 1) THEN 'True' ELSE 'False' END),
			--@Vascular = (CASE WHEN (Inserted.Vascular = 1) THEN 'True' ELSE 'False' END),
			--@BxType = (CASE WHEN (Inserted.BxType = 1) THEN 'True' ELSE 'False' END),
			--@NoBxTaken = (CASE WHEN (Inserted.NoBxTaken = 1) THEN 'True' ELSE 'False' END),
			--@BxNeedleType = (CASE WHEN (Inserted.BxNeedleType = 1) THEN 'True' ELSE 'False' END),
			--@BxNeedleSize = (CASE WHEN (Inserted.BxNeedleSize = 1) THEN 'True' ELSE 'False' END),
			--@BxNeedleSizeUnits = (CASE WHEN (Inserted.BxNeedleSizeUnits = 1) THEN 'True' ELSE 'False' END)				
		FROM INSERTED

		
	END

	-- DELETED
	IF @Action = 'D'
	BEGIN
		SELECT @site_id=SiteId,@EBUSAbnoDescId=EBUSAbnoDescId FROM DELETED
	END
	
	EXEC ebus_abno_descrip_summary_update @EBUSAbnoDescId
	EXEC sites_summary_update @site_id
GO
GO
dbo.DropIfExist
    @ObjectName = 'ebus_abno_descrip_summary_update',      -- varchar(100)
    @ObjectTypePrefix = 'S' -- varchar(5)
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[ebus_abno_descrip_summary_update]
(
	@EBUSAbnoDescId INT
)
AS
	SET NOCOUNT ON

	DECLARE 
		@summary VARCHAR(8000),
		@tmpsummary VARCHAR(2000),
		@none BIT,
		@Normal BIT,
		@Size decimal(18,1),
		@SizeNum REAL ,
		@Shape TINYINT,
		@Margin TINYINT,
		@Echogenecity TINYINT,
		@CHS TINYINT,
		@CNS TINYINT,
		@Vascular TINYINT,
		@BxType TINYINT,
		@NoBxTaken SMALLINT,
		@BxNeedleType TINYINT,
		@BxNeedleSize REAL,
		@BxNeedleSizeUnits TINYINT
		
	SELECT 
		@Normal = Normal,
		@Size = Size,
		@SizeNum = SizeNum ,
		@Shape = Shape,
		@Margin = Margin,
		@Echogenecity = Echogenecity,
		@CHS = CHS,
		@CNS = CNS,
		@Vascular = Vascular,
		@BxType = BxType,
		@NoBxTaken = NoBxTaken,
		@BxNeedleType = BxNeedleType,
		@BxNeedleSize = BxNeedleSize,
		@BxNeedleSizeUnits = BxNeedleSizeUnits		
	FROM 
		dbo.ERS_EBUSAbnoDescriptions
	WHERE
		EBUSAbnoDescId = @EBUSAbnoDescId
	
	SET @summary =(select CONCAT('<br /><b>Sample: ', EBSample,'</b><br/>') from 
	(select ROW_NUMBER() OVER(ORDER BY EBUSAbnoDescId ASC) as EBSample, EBUSAbnoDescId from dbo.ERS_EBUSAbnoDescriptions
	where SiteId=(select siteid from dbo.ERS_EBUSAbnoDescriptions where EBUSAbnoDescId=@EBUSAbnoDescId))A where EBUSAbnoDescId=@EBUSAbnoDescId)
	
	IF ISNULL(@Size,0) > 0 
	BEGIN
		SET @tmpSummary = 'Size: '
		--IF @Size = 1
		--	SET @tmpSummary = @tmpSummary + ' <=10mm'
		--IF @Size = 2
		--	SET @tmpSummary = @tmpSummary + ' >10mm'
		SET @tmpSummary =CONCAT( @tmpSummary,@Size, ' mm')
		SET @Summary = @Summary + @tmpSummary + '.<br />'
	END

	IF ISNULL(@Shape,0) > 0 
	BEGIN
		SET @tmpSummary = 'Shape: '
		IF @Shape = 1 
			SET @tmpSummary = @tmpSummary + ' oval'
		IF @Shape = 2 
			SET @tmpSummary = @tmpSummary + ' round'
		IF @Shape = 3 
			SET @tmpSummary = @tmpSummary + ' triangular'

		SET @Summary = @Summary + @tmpSummary + '.<br />'
	END

	IF ISNULL(@Margin,0) > 0 
	BEGIN
		SET @tmpSummary = 'Margin: '
		IF @Margin = 1 
			SET @tmpSummary = @tmpSummary + ' indistinct'
		IF @Margin = 2 
			SET @tmpSummary = @tmpSummary + ' distinct'
		
		SET @Summary = @Summary + @tmpSummary + '.<br />'
	END

	IF ISNULL(@Echogenecity,0) > 0 
	BEGIN
		SET @tmpSummary = 'Echogenecity: '
		IF @Echogenecity = 1
			SET @tmpSummary = @tmpSummary + ' homogeneous'
		IF @Echogenecity = 2 
			SET @tmpSummary = @tmpSummary + ' heterogeneous'
		
		SET @Summary = @Summary + @tmpSummary + '.<br />'
	END

	IF ISNULL(@CHS,0) > 0 
	BEGIN
		SET @tmpSummary = 'Central hilar structure: '
		IF @CHS = 1
			SET @tmpSummary = @tmpSummary + ' present'
		IF @CHS = 2 
			SET @tmpSummary = @tmpSummary + ' absent'
		
		SET @Summary = @Summary + @tmpSummary + '.<br />'
	END

	IF ISNULL(@CNS,0) > 0 
	BEGIN
		SET @tmpSummary = 'Coagulation necrosis sign: '
		IF @CNS = 1
			SET @tmpSummary = @tmpSummary + ' present'
		IF @CNS = 2 
			SET @tmpSummary = @tmpSummary + ' absent'
		
		SET @Summary = @Summary + @tmpSummary + '.<br />'
	END

	IF ISNULL(@Vascular,0) > 0 
	BEGIN
		SET @tmpSummary = 'Vascular: '
		IF @Vascular = 1
			SET @tmpSummary = @tmpSummary + ' yes'
		IF @Vascular = 2 
			SET @tmpSummary = @tmpSummary + ' no'
		
		SET @Summary = @Summary + @tmpSummary + '.<br />'
	END

	DECLARE @tmpSummaryBiopsyHeader VARCHAR(30) = '<br /><b>Biopsies taken</b>';
	DECLARE @biopsyPerformedFlag BIT = 0;
	DECLARE @biospySummary VARCHAR(MAX) = '';

	SET @biospySummary = @tmpSummaryBiopsyHeader + '<br />'
	
	IF ISNULL(@NoBxTaken,0) > 0 
	BEGIN		
		SET @biopsyPerformedFlag = 1
		SET @tmpSummary = 'Number taken: '
		SET @tmpSummary = @tmpSummary + CAST(ISNULL(@NoBxTaken, 0) AS VARCHAR(10))
		SET @biospySummary = @biospySummary + @tmpSummary + '.<br />'
	END

	IF ISNULL(@BxType,0) > 0 
	BEGIN		
		SET @biopsyPerformedFlag = 1
		SET @tmpSummary = 'Biopsy type: '
		SELECT @tmpSummary = @tmpSummary +  ListItemText from ERS_Lists where ListDescription = 'EBUS Abnormalities Biopsy Type' and ListItemNo =  ISNULL(@BxType, 0)
		SET @biospySummary = @biospySummary + @tmpSummary + '.<br />'
	END

	IF ISNULL(@BxNeedleType,0) > 0 
	BEGIN		
		SET @biopsyPerformedFlag = 1
		SET @tmpSummary = 'Needle type: '
		SELECT @tmpSummary = @tmpSummary +  ListItemText from ERS_Lists where ListDescription = 'EBUS Abnormalities Biopsy Needle Type' and ListItemNo =  ISNULL(@BxNeedleType, 0) 			
		SET @biospySummary = @biospySummary + @tmpSummary + '.<br />'
	END

	IF ISNULL(@BxNeedleSize,0) > 0 
	BEGIN
		SET @biopsyPerformedFlag = 1
		SET @tmpSummary = 'Needle size: '
		SELECT @tmpSummary = @tmpSummary + convert(varchar,@BxNeedleSize) + ' ' +  ListItemText from ERS_Lists where ListDescription = 'EBUS Abnormalities Biopsy Needle Size Units' and ListItemNo =  ISNULL(@BxNeedleSizeUnits, 0)
		SET @biospySummary = @biospySummary + @tmpSummary + '.<br />'
	END
	
	IF @biopsyPerformedFlag = 1
	BEGIN
		SET @Summary = @Summary + @biospySummary
	END

	
		
	-- Finally update the summary in abnormalities table
	UPDATE ERS_EBUSAbnoDescriptions
	SET Summary = REVERSE(STUFF(REVERSE(@Summary  + ' '),1,1,'')) 
	WHERE EBUSAbnoDescId = @EBUSAbnoDescId

	--EXEC sites_summary_update @SiteId
GO
dbo.DropIfExist
    @ObjectName = 'sites_summary_update',      -- varchar(100)
    @ObjectTypePrefix = 'S' -- varchar(5)
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[sites_summary_update]
(
	@SiteId INT,
	@RefreshReport BIT = 1
)
AS
/*

-- Updated by	:	Ferdowsi 9/24/2024
-- TFS#	3859
-- Description of change
--  Clicking the summary link it takes to the page in abno
-- Update History:
-- 10 Nov 2023		MH		replaced table reference ERS_ColonAbnoLesions with ERS_CommonAbnoLesions	TFS #3556
-- 15 Nov 2023		MH/Andrea		after finding the sp could updated from older version - the script has been taken from release 2_23_05_03 and then added some required refreshsummary works done by Steve, Polyp details are fixed here for Colon,Gastro etc
--							
*/
SET NOCOUNT ON

DECLARE @TrustId int
SELECT @TrustId = oh.TrustId
FROM ERS_Procedures p
JOIN ERS_Sites s ON s.ProcedureId = p.ProcedureId AND s.SiteId = @SiteId
JOIN ERS_OperatingHospitals oh ON oh.OperatingHospitalId = p.OperatingHospitalID

DECLARE @ReportSummaryRefresh int
SELECT @ReportSummaryRefresh = CAST([dbo].[fn_ShouldRefreshSummary](@TrustId) AS INT)

IF (@ReportSummaryRefresh + CAST(@RefreshReport AS INT) > 0)
BEGIN
	DECLARE @summaryAbnormalities VARCHAR(MAX)
			,@summarySpecimens VARCHAR(MAX)
			,@summaryTherapeutics VARCHAR(MAX)
			,@summaryWhole VARCHAR(MAX)
			,@summaryAbnormalitiesWithHyperLinks VARCHAR(MAX)
			,@summarySpecimensWithHyperLinks VARCHAR(MAX)
			,@summaryTherapeuticsWithHyperLinks VARCHAR(MAX)
			,@procType INT
			,@procId INT
			,@none TINYINT
			,@region VARCHAR(500)
			,@htmlAnchorCode VARCHAR(500)
			,@siteIdStr VARCHAR(15)
			,@indent VARCHAR(15) 
			,@br VARCHAR(10)
			,@opDiv VARCHAR(150)
			,@clDiv VARCHAR(50)
			,@opBold VARCHAR(5)
			,@clBold VARCHAR(5)
			,@fullStop VARCHAR(1)
			,@colon VARCHAR(2)
			,@fldNone VARCHAR(20)
			,@emptyStr VARCHAR(1)
			,@abnoTheraPresent BIT = 0
			,@tmpSummaryAbno VARCHAR(MAX)
			,@tmpSummaryAbnoLinks VARCHAR(MAX)
			,@SiteNo INT
			,@regionID INT
			,@AreaNo INT
			,@AbnormalProcedure BIT = 0


	BEGIN TRANSACTION

	BEGIN TRY

		SET	@summaryAbnormalities = ''
		SET	@summarySpecimens = ''
		SET	@summaryTherapeutics = ''
		SET	@summaryAbnormalitiesWithHyperLinks = ''
		SET	@summarySpecimensWithHyperLinks = ''
		SET	@summaryTherapeuticsWithHyperLinks = ''
		SET @siteIdStr = CONVERT(VARCHAR(10),@SiteId)
		SET @AbnormalProcedure = 0

		DECLARE @IsLymphNode VARCHAR(10) = 'False'

		SELECT @procId = p.ProcedureId,@procType = p.ProcedureType, @regionID = s.RegionId, @SiteNo = s.SiteNo, @AreaNo = ISNULL(AreaNo,0),
				@region = CASE WHEN s.SiteNo = -77 THEN						--SiteNo is set to -77 for sites By Distance (Col & Sig only)
							CONVERT(VARCHAR,XCoordinate) +  
								CASE WHEN YCoordinate IS NULL OR YCoordinate=0 THEN ' cm' 
								ELSE (' to ' + CONVERT(VARCHAR,YCoordinate) + ' cm' ) 
								END
						ELSE (SELECT r.Region FROM ERS_Regions r WHERE r.RegionId = s.RegionId)
						END
				,@IsLymphNode = CASE WHEN s.IsLymphNode = 1 THEN 'True' ELSE 'False' END
		FROM ERS_Sites s
		JOIN ERS_Procedures p ON s.ProcedureId = p.ProcedureId
		--JOIN ERS_Regions r ON s.RegionId = r.RegionId
		WHERE SiteId = @SiteId
		--SELECT @region = Region FROM ERS_Regions WHERE RegionId = @regionID

		SET @htmlAnchorCode = '<a href="#" class="sitesummary" onclick="OpenSiteDetails(''''' + @region + ''''',' + @siteIdStr + ',''''{0}'''',''''' + CONVERT(VARCHAR,@AreaNo) + ''''');">{1}</a>'
		--{0} is the name of the menu and {1} is the summary text

	
		DECLARE @SQLString NVARCHAR(MAX), @QryString NVARCHAR(MAX), @AbnoCheck BIT
		DECLARE @ProcedureType INT, @TableName VARCHAR(50), @AbnoNodeName VARCHAR(50), @Identifier VARCHAR(50)

		CREATE TABLE #QueryDetails (ProcType INT, TableName VARCHAR(50), AbnoNodeName VARCHAR(50), Identifier VARCHAR(50));

		--Notes to appear on the report just after the Site X heading, before the abnormalities.
		INSERT INTO #QueryDetails SELECT @procType,	'ERS_Sites',		'',		'Additional notes'
		IF @procType IN (1,6, (SELECT ProcedureTypeId FROM ERS_ProcedureTypes where ProcedureType = 'Transnasal')) --Gastroscopy / EUS(OGD), Transnasal tfs-3513
		BEGIN
			INSERT INTO #QueryDetails VALUES 
			(@procType,	'ERS_CommonAbnoAtrophic',			'Atrophic duodenum','Atrophic Duodenum')
			,(@procType,	'ERS_UpperGIAbnoAchalasia',		'Achalasia',		'Achalasia')
			,(@procType,	'ERS_UpperGIAbnoBarrett',		'',					'Barretts Epithelium')
			,(@procType,	'ERS_UpperGIAbnoDeformity',		'Deformity',		'Deformity')
			,(@procType,	'ERS_CommonAbnoDiverticulum',	'Diverticulum',		'Diverticulum/Other')
			,(@procType,	'ERS_CommonAbnoDuodenalUlcer',	'',					CASE WHEN @region = 'Jejunum' THEN 'Jejunal Ulcer' WHEN @region = 'Ileum' THEN 'Ileal Ulcer' ELSE 'Duodenal Ulcer' END)
			,(@procType,	'ERS_CommonAbnoDuodenitis',		'',					CASE WHEN @region = 'Jejunum' THEN 'Jejunitis' WHEN @region = 'Ileum' THEN 'Ileitis' ELSE 'Duodenitis' END)
			,(@procType,	'ERS_UpperGIAbnoGastricUlcer',	'Gastric ulcer',	'Gastric Ulcer')
			,(@procType,	'ERS_UpperGIAbnoGastritis',		'Gastritis',		'Gastritis')
			,(@procType,	'ERS_UpperGIAbnoHiatusHernia',	'Hiatus hernia',	'Hiatus Hernia')
			,(@procType,	'ERS_UpperGIAbnoLumen',			'Lumen',			'Lumen')
			,(@procType,	'ERS_UpperGIAbnoMalignancy',	'Malignancy',		'Malignancy')
			,(@procType,	'ERS_UpperGIAbnoMiscellaneous',	'',					'Miscellaneous')
			,(@procType,	'ERS_UpperGIAbnoOesophagitis',	'Oesophagitis',		'Oesophagitis')
			,(@procType,	'ERS_CommonAbnoLesions',		'Lesions',			'Lesions')
			,(@procType,	'ERS_CommonAbnoPolypDetails',		'Polyp',			'Lesions')--ERS_CommonAbnoPolypDetails --newly added for 4069
			,(@procType,	'ERS_UpperGIAbnoPostSurgery',	'Post surgery',		'Post Surgery')
			,(@procType,	'ERS_CommonAbnoScaring',		'',					'Scarring/Stenosis')
			,(@procType,	'ERS_CommonAbnoTumour',			'',					'Tumour')
			,(@procType,	'ERS_UpperGIAbnoVarices',		CASE WHEN (Select isnull(Quantity, 0) from ERS_UpperGIAbnoVarices where SiteId = @SiteId) = 1 then 'Varix' ELSE 'Varices' END ,			'Varices')
			,(@procType,	'ERS_CommonAbnoVascularLesions','Vascular lesions',	'Vascular Lesions')
			,(@procType,	'ERS_EUSAbnoMediastinal',		'Mediastinal',		'Mediastinal')
			,(@procType,	'ERS_UpperGITherapeutics',		'Therapeutic procedure(s)',	'Therapeutic Procedures')
			,(@procType,	'ERS_UpperGISpecimens',			'Specimens taken',	'Specimens Taken')
		END
		ELSE IF @procType IN (2,7) --ERCP / / EUS(HPB)
		BEGIN
			INSERT INTO #QueryDetails VALUES 
			(@procType,		'ERS_ERCPAbnoAppearance',		'Appearance',		'Appearance')
			,(@procType,	'ERS_CommonAbnoAtrophic',		'Atrophic duodenum','Atrophic Duodenum')
			,(@procType,	'ERS_CommonAbnoDiverticulum',	'Diverticulum',		'Diverticulum/Other')
			,(@procType,	'ERS_ERCPAbnoDiverticulum',		'Diverticulum',		CASE WHEN @region IN ('Major Papilla', 'Minor Papilla') THEN 'Diverticulum' ELSE 'Diverticulum/Other' END)
			,(@procType,	'ERS_ERCPAbnoDuct',				'Duct',				CASE WHEN @region = 'Gall Bladder' THEN 'Gall Bladder' ELSE 'Duct' END)
			,(@procType,	'ERS_CommonAbnoDuodenalUlcer',	'',					CASE WHEN @region = 'Jejunum' THEN 'Jejunal Ulcer' WHEN @region = 'Ileum' THEN 'Ileal Ulcer' ELSE 'Duodenal Ulcer' END)
			,(@procType,	'ERS_CommonAbnoDuodenitis',		'',					CASE WHEN @region = 'Jejunum' THEN 'Jejunitis' WHEN @region = 'Ileum' THEN 'Ileitis' ELSE 'Duodenitis' END)
			,(@procType,	'ERS_ERCPAbnoParenchyma',		'Parenchyma',		'Parenchyma')
			,(@procType,	'ERS_CommonAbnoScaring',		'',					'Scarring/Stenosis')
			,(@procType,	'ERS_UpperGIAbnoMiscellaneous',	'',					'Miscellaneous')
			,(@procType,	'ERS_CommonAbnoTumour',			'',					'Tumour')
			,(@procType,	'ERS_ERCPAbnoTumour',			'Tumour',			'Tumour')
			,(@procType,	'ERS_ERCPAbnoIntrahepatic',		'Intrahepatic',		'Intrahepatic')
			,(@procType,	'ERS_CommonAbnoVascularLesions','Vascular lesions',	'Vascular Lesions')
			,(@procType,	'ERS_EUSAbnoMediastinal',		'Mediastinal',		'Mediastinal')
			,(@procType,	'ERS_CommonAbnoLesions',		'Lesions',			'Lesions')
			,(@procType,	'ERS_CommonAbnoPolypDetails',		'Polyp',			'Lesions')--ERS_CommonAbnoPolypDetails --newly added for 4069
			,(@procType,	'ERS_UpperGIAbnoVarices',		CASE WHEN (Select isnull(Quantity, 0) from ERS_UpperGIAbnoVarices where SiteId = @SiteId) = 1 then 'Varix' ELSE 'Varices' END ,			'Varices')
			,(@procType,	'ERS_ERCPTherapeutics',			'Therapeutic procedure(s)',	'Therapeutic Procedures')
			,(@procType,	'ERS_UpperGISpecimens',			'Specimens taken',	'Specimens Taken')
		END
		ELSE IF @procType IN (3,4,5) --Colon/Sigmo/Procto
		BEGIN
			INSERT INTO #QueryDetails VALUES
			(@procType,		'ERS_ColonAbnoCalibre',			'Calibre',			'Calibre')
			,(@procType,	'ERS_ColonAbnoDiverticulum',	'Diverticulum',		'Diverticulum')
			,(@procType,	'ERS_ColonAbnoHaemorrhage',		'Haemorrhage',		'Haemorrhage')
			,(@procType,	'ERS_CommonAbnoLesions',			'Lesions',			'Lesions')
			,(@procType,	'ERS_CommonAbnoPolypDetails',		'Polyp',			'Lesions')--ERS_CommonAbnoPolypDetails --newly added for 4069
			,(@procType,	'ERS_ColonAbnoTumour',			'Tumour',			'Tumour')
			,(@procType,	'ERS_ColonAbnoMiscellaneous',	'',					'Miscellaneous')
			,(@procType,	'ERS_ColonAbnoMucosa',			'Mucosa & Colitides',			'Mucosa')
			,(@procType,	'ERS_ColonAbnoperianallesions',	'Perianal lesions',	'Perianal Lesions')
			,(@procType,	'ERS_ColonAbnoVascularity',		'Vascularity',		'Vascularity')
			,(@procType,	'ERS_UpperGIAbnoVarices',		CASE WHEN (Select isnull(Quantity, 0) from ERS_UpperGIAbnoVarices where SiteId = @SiteId) = 1 then 'Varix' ELSE 'Varices' END ,			'Varices')
			,(@procType,	'ERS_UpperGITherapeutics',		'Therapeutic procedure(s)',	'Therapeutic Procedures')
			,(@procType,	'ERS_UpperGISpecimens',			'Specimens taken',	'Specimens Taken')
		END
		ELSE IF @procType IN (8) --Antegrade
		BEGIN
			INSERT INTO #QueryDetails VALUES 
			(@procType,		'ERS_UpperGIAbnoAchalasia',		'Achalasia',		'Achalasia')
			,(@procType,	'ERS_UpperGIAbnoBarrett',		'',					'Barretts Epithelium')
			,(@procType,	'ERS_UpperGIAbnoDeformity',		'Deformity',		'Deformity')
			,(@procType,	'ERS_CommonAbnoAtrophic',		'Atrophic duodenum','Atrophic Duodenum')
			,(@procType,	'ERS_CommonAbnoDiverticulum',	'Diverticulum',		'Diverticulum/Other')
			,(@procType,	'ERS_ColonAbnoDiverticulum',	'Diverticulum',		'Diverticulum')
			,(@procType,	'ERS_CommonAbnoDuodenalUlcer',	'',					CASE WHEN @region = 'Jejunum' THEN 'Jejunal Ulcer' WHEN @region = 'Ileum' THEN 'Ileal Ulcer' ELSE 'Duodenal Ulcer' END)
			,(@procType,	'ERS_CommonAbnoDuodenitis',		'',					CASE WHEN @region = 'Jejunum' THEN 'Jejunitis' WHEN @region = 'Ileum' THEN 'Ileitis' ELSE 'Duodenitis' END)
			,(@procType,	'ERS_ColonAbnoLesions',			'Lesions',			'Lesions')
			,(@procType,	'ERS_CommonAbnoScaring',		'',					'Scarring/Stenosis')
			,(@procType,	'ERS_CommonAbnoTumour',			'',					'Tumour')
			,(@procType,	'ERS_CommonAbnoVascularLesions','Vascular lesions',	'Vascular Lesions')
			,(@procType,	'ERS_UpperGIAbnoGastricUlcer',	'Gastric ulcer',	'Gastric Ulcer')
			,(@procType,	'ERS_UpperGIAbnoGastritis',		'Gastritis',		'Gastritis')
			,(@procType,	'ERS_UpperGIAbnoHiatusHernia',	'Hiatus hernia',	'Hiatus Hernia')
			,(@procType,	'ERS_UpperGIAbnoLumen',			'Lumen',			'Lumen')
			,(@procType,	'ERS_UpperGIAbnoMalignancy',	'Malignancy',		'Malignancy')
			,(@procType,	'ERS_UpperGIAbnoMiscellaneous',	'',					'Miscellaneous')
			,(@procType,	'ERS_UpperGIAbnoOesophagitis',	'Oesophagitis',		'Oesophagitis')
			,(@procType,	'ERS_UpperGIAbnoPostSurgery',	'Post surgery',		'Post Surgery')
			,(@procType,	'ERS_CommonAbnoLesions',		'Lesions',			'Lesions')			
			,(@procType,	'ERS_CommonAbnoPolypDetails',		'Polyp',			'Lesions')--ERS_CommonAbnoPolypDetails --newly added for 4069
			,(@procType,	'ERS_UpperGIAbnoVarices',		CASE WHEN (Select isnull(Quantity, 0) from ERS_UpperGIAbnoVarices where SiteId = @SiteId) = 1 then 'Varix' ELSE 'Varices' END ,			'Varices')
			,(@procType,	'ERS_UpperGITherapeutics',		'Therapeutic procedure(s)',	'Therapeutic Procedures')
			,(@procType,	'ERS_UpperGISpecimens',			'Specimens taken',	'Specimens Taken')
		END
		ELSE IF @procType IN (9) --Retrograde
		BEGIN
			INSERT INTO #QueryDetails VALUES
			(@procType,		'ERS_ColonAbnoCalibre',			'Calibre',			'Calibre')
			,(@procType,	'ERS_ColonAbnoDiverticulum',	'Diverticulum',		'Diverticulum')
			,(@procType,	'ERS_ColonAbnoHaemorrhage',		'Haemorrhage',		'Haemorrhage')
			,(@procType,	'ERS_CommonAbnoLesions',			'Lesions',			'Lesions')	
			,(@procType,	'ERS_CommonAbnoPolypDetails',		'Polyp',			'Lesions')--ERS_CommonAbnoPolypDetails --newly added for 4069
			,(@procType,	'ERS_ColonAbnoTumour',			'Tumour',			'Tumour')
			,(@procType,	'ERS_ColonAbnoMiscellaneous',	'',					'Miscellaneous')
			,(@procType,	'ERS_ColonAbnoMucosa',			'Mucosa & Colitides',			'Mucosa')
			,(@procType,	'ERS_ColonAbnoperianallesions',	'Perianal lesions',	'Perianal Lesions')
			,(@procType,	'ERS_ColonAbnoVascularity',		'Vascularity',		'Vascularity')
			,(@procType,	'ERS_CommonAbnoDuodenalUlcer',	'',					CASE WHEN @region = 'Jejunum' THEN 'Jejunal Ulcer' WHEN @region = 'Ileum' THEN 'Ileal Ulcer' ELSE 'Duodenal Ulcer' END)
			,(@procType,	'ERS_CommonAbnoDuodenitis',		'',					CASE WHEN @region = 'Jejunum' THEN 'Jejunitis' WHEN @region = 'Ileum' THEN 'Ileitis' ELSE 'Duodenitis' END)
			,(@procType,	'ERS_CommonAbnoScaring',		'',					'Scarring/Stenosis')
			,(@procType,	'ERS_UpperGIAbnoVarices',		CASE WHEN (Select isnull(Quantity, 0) from ERS_UpperGIAbnoVarices where SiteId = @SiteId) = 1 then 'Varix' ELSE 'Varices' END ,			'Varices')
			,(@procType,	'ERS_UpperGITherapeutics',			'Therapeutic procedure(s)',	'Therapeutic Procedures')
			,(@procType,	'ERS_UpperGISpecimens',			'Specimens taken',	'Specimens Taken')
		END
		ELSE IF @procType IN (13) --Cystoscopy
		BEGIN
			INSERT INTO #QueryDetails VALUES
			(@procType,		'ERS_CystoscopyAbnoBladder',	'Bladder',			'Bladder')
			,(@procType,	'ERS_CystoscopyAbnoProstate',	'Prostate',		    'Prostate')
			,(@procType,	'ERS_CystoscopyAbnoUrethra',	'Urethra',		    'Urethra')
			,(@procType,	'ERS_CystoscopyTherapeutics',	'Therapeutic procedure(s)',	'Therapeutic Procedures')
			,(@procType,	'ERS_CystoscopySpecimens',		'Specimens taken',	'Specimens Taken')
		END
		ELSE IF @procType IN (10,12) --Bronchoscopy, Thoracoscopy
		BEGIN
			INSERT INTO #QueryDetails
			VALUES (
				@procType
				,'ERS_BRTSpecimens'
				,'Specimens taken'
				,'Specimens Taken'
				),
				(
				@procType
				,'ERS_UpperGITherapeutics'
				,'Therapeutic procedure(s)'
				,'Therapeutic Procedures'
				),
				 
				(@procType,'ERS_BRTAbnoDescriptions','Bleeding','Bleeding')  -- added by Ferdowsi,  TFS# 3859
				,(@procType,'ERS_BRTAbnoDescriptions','Carinal Abnormality','Carinal')
			    ,(@procType,'ERS_BRTAbnoDescriptions','Stenosis','Stenosis')
				,(@procType,'ERS_BRTAbnoDescriptions','Obstruction','Obstruction')
				,(@procType,'ERS_BRTAbnoDescriptions','Compression','Compression')
				,(@procType,'ERS_BRTAbnoDescriptions','Mucosal','Mucosal')
				,(@procType,'ERS_BRTAbnoDescriptions','Mucosal Irregularity','Mucosal Irregularity')
				,(@procType,'ERS_BRTAbnoDescriptions','Excessive secretions','Excessive secretions') --end
	

		END
		ELSE IF @procType IN (
				11
				) --EBUS			
				BEGIN
					INSERT INTO #QueryDetails
					VALUES (
						@procType
						,'ERS_BRTSpecimens'
						,'Specimens taken'
						,'Specimens Taken'
						),
						(
						@procType
						,'ERS_UpperGITherapeutics'
						,'Therapeutic procedure(s)'
						,'Therapeutic Procedures'
						)
			
					IF @IsLymphNode = 'True'
					BEGIN
						INSERT INTO #QueryDetails
						VALUES 
							(
							@procType
							,'ERS_EBUSAbnoDescriptions'
							,'<strong>Abnormalities</strong>'
							,'EBUS Abnormality Descriptions'
							)
					END
					ELSE
					BEGIN
						INSERT INTO #QueryDetails
						VALUES 
			 				 (@procType,'ERS_BRTAbnoDescriptions','Bleeding','Bleeding')   -- added by Ferdowsi,  TFS# 3859
							,(@procType,'ERS_BRTAbnoDescriptions','Carinal Abnormality','Carinal')
							,(@procType,'ERS_BRTAbnoDescriptions','Stenosis','Stenosis')
							,(@procType,'ERS_BRTAbnoDescriptions','Obstruction','Obstruction')
							,(@procType,'ERS_BRTAbnoDescriptions','Compression','Compression')
							,(@procType,'ERS_BRTAbnoDescriptions','Mucosal','Mucosal')
							,(@procType,'ERS_BRTAbnoDescriptions','Mucosal Irregularity','Mucosal Irregularity')
							,(@procType,'ERS_BRTAbnoDescriptions','Excessive secretions','Excessive secretions') --end
					END
				END


		DECLARE qry_cursor CURSOR FOR 
		SELECT ProcType, TableName, AbnoNodeName, Identifier FROM #QueryDetails

		OPEN qry_cursor 
		FETCH NEXT FROM qry_cursor INTO @ProcType, @TableName, @AbnoNodeName, @Identifier

		WHILE @@FETCH_STATUS = 0
		BEGIN
			SET @summaryWhole = ''
			SET @none = NULL
			SET @opDiv = '''<table><tr><td style="padding-left:25px;padding-right:50px; font-size:12px;"><span>'' + ' 
			SET @clDiv = ' + ''</span></td></tr></table>'''
			SET @indent = '&nbsp;- ';		SET @br = '<br />'
			SET @opBold = '<b>';			SET @clBold = '</b>'
			SET @fullStop = '.';			SET @colon = ': '
			SET @fldNone = 'None';			SET @emptyStr = ''
		
			IF @TableName = 'ERS_UpperGIAbnoLumen' SET @fldNone = 'NoBlood'
			ELSE IF @TableName = 'ERS_ERCPAbnoIntrahepatic' SET @fldNone = 'NormalIntraheptic'
			ELSE IF @TableName IN ('ERS_ERCPAbnoDuct', 'ERS_ERCPAbnoParenchyma', 'ERS_ERCPAbnoAppearance', 'ERS_ERCPAbnoDiverticulum','ERS_CystoscopyAbnoBladder','ERS_CystoscopyAbnoProstate','ERS_CystoscopyAbnoUrethra','ERS_EBUSAbnoDescriptions') SET @fldNone = 'Normal'
			ELSE SET @fldNone = 'None'
			--Get Summary from respective table
			IF @TableName = 'ERS_Sites'
				BEGIN
					SET @SQLString = 'SELECT @summaryWhole = AdditionalNotes FROM ' + @TableName + '  
								WHERE SiteId =  ' + CONVERT(VARCHAR,@SiteId) + ' AND ISNULL(AdditionalNotes,'''') <> '''' '
					SET @fullStop = @emptyStr
				END
	        ELSE IF @TableName = 'ERS_BRTAbnoDescriptions'  -- added by Ferdowsi,  TFS# 3859
				BEGIN 
				     SET @SQLString = 'SELECT @summaryWhole = SUBSTRING( Summary, CHARINDEX(''' + @Identifier + ':'', Summary) + LEN(''' + @Identifier + ':''), CHARINDEX(''.'', Summary, CHARINDEX(''' + @Identifier + ':'', Summary)) - (CHARINDEX(''' + @Identifier + ':'', Summary) 
					 + LEN(''' + @Identifier + ':'')) )   FROM ' + @TableName + '  
								WHERE SiteId =  ' + CONVERT(VARCHAR,@SiteId) + ' AND Summary LIKE ''%' + @Identifier + ':%'''
								
				  END  --end


			else if @TableName = 'ERS_CommonAbnoPolypDetails' or @TableName= 'ERS_EBUSAbnoDescriptions'  --newly added for 4069
				begin
					SET @SQLString='
                 SELECT @summaryWhole=(SELECT '+CHAR(13)+' t2.summary
                                             FROM '+@TableName+' t2
                                             WHERE t2.SiteId = t1.SiteId
                                             FOR XML PATH(''''), TYPE).value(''.'', ''NVARCHAR(MAX)''), 
                        @none = 0 
                 FROM '+@TableName+' t1 
                 where t1.SiteId='+CONVERT(VARCHAR,@SiteId)+' 
                 group by t1.SiteId; 
                 '

					--SET @SQLString = 'SELECT @summaryWhole = Summary, @none = 0 FROM ' + @TableName + '  
					--			WHERE SiteId =  ' + CONVERT(VARCHAR,@SiteId) + ' AND ISNULL(Summary,'''') <> '''' '
				end --newly added for 4069
			ELSE
				BEGIN
					SET @SQLString = 'SELECT @summaryWhole = Summary, @none = [' + @fldNone + '] FROM ' + @TableName + '  
								WHERE SiteId =  ' + CONVERT(VARCHAR,@SiteId) + ' AND ISNULL(Summary,'''') <> '''' '
				END
			EXECUTE sp_executesql @SQLString, N'@summaryWhole VARCHAR(MAX) OUTPUT, @none TINYINT OUTPUT', @summaryWhole OUTPUT, @none OUTPUT

			IF @Identifier = 'Therapeutic Procedures' 
			BEGIN
				IF LEN(@summaryWhole) > 0 -- TFS 4166
				BEGIN
					SET @fullStop = @emptyStr
					SET @abnoTheraPresent = 1
			END
			ELSE 
			BEGIN
					SET @opDiv = @emptyStr;		SET @clDiv = @emptyStr
					SET @opBold = @emptyStr;	SET @clBold = @emptyStr
			END
			END
			ELSE 
			BEGIN
				IF @Identifier = 'Specimens Taken' 
				BEGIN
					--IF therapeutics present, remove line before specimens
					IF @abnoTheraPresent = 1 SET @br = @emptyStr
				END
				ELSE 
				BEGIN
					SET @opBold = @emptyStr;	SET @clBold = @emptyStr
				END
				SET @opDiv = @emptyStr ;		SET @clDiv = @emptyStr
			END

			IF ISNULL(@summaryWhole,'') <> ''
			BEGIN
				SET @summaryWhole = REPLACE(@summaryWhole,'''','''''')

				--If None is clicked, prefix not required (e.g "Oesophagitis : No Oesophagitis." should be "No Oesophagitis.")
				--Prefix (@AbnoNodeName) is required for Lumen even if None (Blood free) is selected
				IF (@AbnoNodeName = '') AND @TableName <> 'ERS_UpperGIAbnoLumen' -- TFS 4166
				BEGIN	
					SET @AbnoNodeName = '';		SET @colon = ''
				END
				ELSE
				BEGIN
					SET @colon = ': '
				END
		        IF @Identifier = 'Carinal'   -- added by Ferdowsi,  TFS# 3859
				  BEGIN 
				     SET @Identifier = 'Carinal Abnormality'
				  END --end
				SET @tmpSummaryAbno = ' CASE WHEN ''' + @summaryWhole + ''' IN ('''', ''' + @AbnoNodeName + ''') THEN ''' +  @indent + @AbnoNodeName + '' + @fullStop + '''' +
										' ELSE  ''' + @indent + @opBold + @AbnoNodeName + @clBold + @colon + ''' + ' + @opDiv + '''' + @summaryWhole + @fullStop + '''' + @clDiv +
									' END'

				--TFS#	3776
				SET @tmpSummaryAbnoLinks = 'CASE WHEN ''' + @summaryWhole + ''' IN ('''', ''' + @AbnoNodeName + ''') THEN ''' +  @indent + @AbnoNodeName + ''' + REPLACE(REPLACE(''' + @htmlAnchorCode + ''',''{0}'',''' + @Identifier + '''),''{1}'',''' + @AbnoNodeName + ''') + ''' + @fullStop + '''' +
											' ELSE  ''' +  @indent + @opBold + @AbnoNodeName + @clBold + @colon + ''' + REPLACE(REPLACE(''' + @htmlAnchorCode + ''',''{0}'',''' + @Identifier + '''),''{1}'',' +  @opDiv + '''' + @summaryWhole  + '''' +	 @clDiv +')  ' +
										' END'
				--TFS#	3776

			SET @SQLString = 'SELECT ' +
								CASE WHEN @Identifier = 'Specimens Taken'			THEN '@summarySpecimens = @summarySpecimens '
									 WHEN @Identifier = 'Therapeutic Procedures'	THEN '@summaryTherapeutics = @summaryTherapeutics '
									 ELSE '@summaryAbnormalities = @summaryAbnormalities ' END +
											' + ''' + @br  + ''' + '  + @tmpSummaryAbno + ', ' +

								CASE WHEN @Identifier = 'Specimens Taken'			THEN '@summarySpecimensWithHyperLinks = @summarySpecimensWithHyperLinks '
									 WHEN @Identifier = 'Therapeutic Procedures'	THEN '@summaryTherapeuticsWithHyperLinks = @summaryTherapeuticsWithHyperLinks '
									 ELSE '@summaryAbnormalitiesWithHyperLinks = @summaryAbnormalitiesWithHyperLinks ' END +
												' + ''' + @br  + ''' + '  + @tmpSummaryAbnoLinks 						
			--Perform abno check to determine normal procedure
			IF @none = 0  and @TableName <> 'ERS_UpperGISpecimens' AND @AbnormalProcedure <> 1  SET @AbnormalProcedure = 1

			IF @Identifier = 'Specimens Taken'
				EXECUTE sp_executesql @SQLString, N'@summarySpecimens VARCHAR(MAX) OUTPUT,@summarySpecimensWithHyperLinks VARCHAR(MAX) OUTPUT', 
							@summarySpecimens = @summarySpecimens OUTPUT, @summarySpecimensWithHyperLinks=@summarySpecimensWithHyperLinks OUTPUT
			ELSE IF @Identifier = 'Therapeutic Procedures'
				EXECUTE sp_executesql @SQLString, N'@summaryTherapeutics VARCHAR(MAX) OUTPUT,@summaryTherapeuticsWithHyperLinks VARCHAR(MAX) OUTPUT', 
							@summaryTherapeutics = @summaryTherapeutics OUTPUT, @summaryTherapeuticsWithHyperLinks=@summaryTherapeuticsWithHyperLinks OUTPUT
			ELSE
				EXECUTE sp_executesql @SQLString, N'@summaryAbnormalities VARCHAR(MAX) OUTPUT,@summaryAbnormalitiesWithHyperLinks VARCHAR(MAX) OUTPUT', 
							@summaryAbnormalities = @summaryAbnormalities OUTPUT, @summaryAbnormalitiesWithHyperLinks=@summaryAbnormalitiesWithHyperLinks OUTPUT
			END

			FETCH NEXT FROM qry_cursor INTO @ProcType, @TableName, @AbnoNodeName, @Identifier
		END

		CLOSE qry_cursor
		DEALLOCATE qry_cursor

		DROP TABLE #QueryDetails

		if exists(select 1 from ERS_CommonAbnoOther where SiteId = @SiteId)
		BEGIN
			SELECT @summaryAbnormalities = isnull(@summaryAbnormalities, '') + (SELECT STUFF((
																					SELECT ', ' + OA.Summary 
																					FROM ERS_OtherAbnormalities OA
																					JOIN ERS_CommonAbnoOther CAO ON OA.OtherId = CAO.OtherId
																					WHERE CAO.SiteId = @SiteId
																					FOR XML PATH('')), 1, 1, '') Code ),
				 @summaryAbnormalitiesWithHyperLinks = isnull(@summaryAbnormalitiesWithHyperLinks, '') + '<table><tr><td style="padding-right:50px;">- Other:' +
				 REPLACE(REPLACE(REPLACE(@htmlAnchorCode,'''{0}''','Other'),'{1}',
																					(SELECT STUFF((
																					SELECT ', ' + OA.Summary 
																					FROM ERS_OtherAbnormalities OA
																					JOIN ERS_CommonAbnoOther CAO ON OA.OtherId = CAO.OtherId
																					WHERE CAO.SiteId = @SiteId
																					FOR XML PATH('')), 1, 1, '') Code )), '''''', '''')
														+ '</td></tr></table>'
		END
		-- Update the current site's summary
		UPDATE ERS_Sites 
		SET	
			SiteSummary = @summaryAbnormalities,
			SiteSummarySpecimens = @summarySpecimens,
			SiteSummaryTherapeutics = @summaryTherapeutics,
			SiteSummaryWithLinks = @summaryAbnormalitiesWithHyperLinks,
			SiteSummarySpecimensWithLinks = @summarySpecimensWithHyperLinks,
			SiteSummaryTherapeuticsWithLinks = @summaryTherapeuticsWithHyperLinks,
			HasAbnormalities = @AbnormalProcedure
		WHERE 
			SiteId = @siteId

		-- Update the summary of the procedure (all the sites)
		EXEC procedure_summary_update @procId

	END TRY

	BEGIN CATCH
		DECLARE @ErrorMessage NVARCHAR(4000);
		DECLARE @ErrorSeverity INT;
		DECLARE @ErrorState INT;

		SELECT @ErrorMessage = ERROR_MESSAGE(),
			   @ErrorSeverity = ERROR_SEVERITY(),
			   @ErrorState = ERROR_STATE();
    
		RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

		IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
	END CATCH


	IF @@TRANCOUNT > 0 COMMIT TRANSACTION;
END
Go
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Muhammad Nasim
-- TFS#	4307
-- Description of change: brush for cytology lab request
------------------------------------------------------------------------------------------------------------------------
GO
dbo.DropIfExist
    @ObjectName = 'printreport_specimens_select',      -- varchar(100)
    @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[printreport_specimens_select]
(
	@ProcedureId INT
)
AS
/***************************************************************************
*****                        Change History                           *****
***************************************************************************
** Rev	Date			Author			Description 
** --	-----------		---------		---------------------------------------
** 1	15 Sep 2021		Adrian (ARS)	New Bronchs section
** 2	21 Sep 2021		Adrian (ARS)	Add new reports for Bronchs
** 3	02 Feb 2024		Steve			Updated to return area description for area marking
**************************************************************************/

SET NOCOUNT ON

DECLARE 
       @procType INT,
       @siteIdentification TINYINT,
       @siteId INT, 
       @siteNo INT,
       @siteTitle VARCHAR(3),
	   @OperatingHospitalID TINYINT
DECLARE 
       @SpecimensSummary TABLE (
              SiteId INT,
              LabRequestReportName VARCHAR(200),
              SpecimenKey VARCHAR(1000),
              Specimen VARCHAR(2000))

SELECT @procType = ProcedureType FROM ERS_Procedures WHERE ProcedureId = @ProcedureId
SELECT @OperatingHospitalID = OperatingHospitalID FROM ERS_Procedures WHERE ProcedureId = @ProcedureId


       SELECT s.SiteNo, Case @procType WHEN 1 THEN ISNULL(m.Area,'') ELSE '' END AS RegionSection, CASE WHEN s.AreaNo > 0 Then dbo.fnSetAreaDescription(@ProcedureId, s.AreaNo, p.ResectedColonNo) ELSE r.Region END AS Region, sp.*, r.RegionId
       INTO #specimens
       FROM ERS_UpperGISpecimens sp
       JOIN ERS_Sites s ON sp.SiteId = s.SiteId
       JOIN ERS_Regions r ON s.RegionId = r.RegionId
       LEFT JOIN ERS_AbnormalitiesMatrixUpperGI m ON r.Region = m.Region AND m.ProcedureType = @procType
       LEFT JOIN [ERS_AbnormalitiesMatrixERCP] n ON r.Region = n.Region AND n.ProcedureType = @procType
       LEFT JOIN [ERS_AbnormalitiesMatrixColon] o ON r.Region = o.Region AND o.ProcedureType = @procType
	   JOIN ERS_Procedures p ON p.ProcedureId = s.ProcedureId
       WHERE s.ProcedureId = @ProcedureId 

UPDATE #specimens SET RegionSection = CASE RegionSection WHEN 'Oesophagus' THEN 'oesophageal' WHEN 'Stomach' THEN 'gastric' WHEN 'Duodenum' THEN 'duodenal' ELSE '' END

--update #specimens SET Region = CASE WHEN RegionId in (SELECT ercr.RegionId FROM dbo.ERS_ResectedColon erc
--															INNER JOIN dbo.ERS_ResectedColonRegions ercr ON erc.ResectedColonID = ercr.ResectedColonID
--															INNER JOIN dbo.ERS_Procedures ep ON erc.ResectedColonID = ep.ResectedColonNo
--															WHERE ep.ProcedureId=@ProcedureId)
--											THEN 'Anastomosis'
--											ELSE Region
--											END



DECLARE Site_Cursor CURSOR FOR
SELECT SiteId, SiteNo FROM #specimens ORDER BY SiteNo
       
OPEN Site_Cursor
FETCH NEXT FROM Site_Cursor INTO @siteId , @siteNo

WHILE @@FETCH_STATUS = 0
BEGIN
       SET @siteTitle = dbo.fnGetSiteTitle(@siteNo, @OperatingHospitalID)

       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Cytology', 
              CONVERT(VARCHAR, @siteId) + 'Brush', 
              LOWER(RegionSection) + ' brushings for cytology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND BrushCytology > 0
              
       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Histology', 
              CONVERT(VARCHAR, @siteId) + 'BiopsyHistology', 
              CONVERT(VARCHAR,BiopsyQtyHistology) + ' ' + LOWER(RegionSection) + CASE WHEN BiopsyQtyHistology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for histology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND BiopsyQtyHistology > 0

       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Microbiology', 
              CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
              CONVERT(VARCHAR,BiopsyQtyMicrobiology) + ' ' + LOWER(RegionSection) + CASE WHEN BiopsyQtyMicrobiology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for microbiology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND Biopsy = 1 AND BiopsyQtyMicrobiology > 0
              
       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Virology', 
              CONVERT(VARCHAR, @siteId) + 'BiopsyVirology', 
              CONVERT(VARCHAR,BiopsyQtyVirology) + ' ' + LOWER(RegionSection) + CASE WHEN BiopsyQtyVirology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for virology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND Biopsy = 1 AND BiopsyQtyVirology > 0
       
       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Histology', 
              CONVERT(VARCHAR, @siteId) + 'Polypectomy', 
              CONVERT(VARCHAR,PolypectomyQty) + ' ' + LOWER(RegionSection) + CASE WHEN PolypectomyQty > 1 THEN ' polyps' ELSE ' polyp' END + ' for histology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND Polypectomy = 1 AND PolypectomyQty > 0

       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Histology', 
              CONVERT(VARCHAR, @siteId) + 'HotBiopsy', 
              LOWER(RegionSection) + ' hot biopsy for histology from (' + LOWER(@siteTitle) + ' ) ' + Region + CASE WHEN HotBiopsyDistance > 0 THEN ' at ' + CONVERT(VARCHAR, HotBiopsyDistance) + 'cm' ELSE '' END 
       FROM #specimens 
       WHERE SiteId = @siteId AND HotBiopsy = 1
       
       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Cytology', 
              CONVERT(VARCHAR, @siteId) + 'NeedleAspirateHistology', 
              LOWER(RegionSection) + ' needle aspirate for cytology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND NeedleAspirate = 1 AND NeedleAspirateHistology = 1

       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Histology', 
              CONVERT(VARCHAR, @siteId) + 'NeedleBiopsyHistology', 
              LOWER(RegionSection) + ' needle biopsy for histology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND FNB = 1 AND NeedleBiopsyHistology = 1

       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Cytology', 
              CONVERT(VARCHAR, @siteId) + 'NeedleBiopsyCytology', 
              LOWER(RegionSection) + ' needle biopsy for cytology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND FNB = 1 AND NeedleBiopsyCytology = 1

       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Microbiology', 
              CONVERT(VARCHAR, @siteId) + 'NeedleBiopsyMicrobiology', 
              LOWER(RegionSection) + ' needle biopsy for microbiology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND FNB = 1 AND NeedleBiopsyMicrobiology = 1

       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Virology', 
              CONVERT(VARCHAR, @siteId) + 'NeedleBiopsyVirology', 
              LOWER(RegionSection) + ' needle biopsy for virology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND FNB = 1 AND NeedleBiopsyVirology = 1


       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Microbiology', 
              CONVERT(VARCHAR, @siteId) + 'NeedleAspirateMicrobiology', 
              LOWER(RegionSection) + ' needle aspirate for microbiology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND NeedleAspirate = 1 AND NeedleAspirateMicrobiology = 1

       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Virology', 
              CONVERT(VARCHAR, @siteId) + 'NeedleAspirateVirology', 
              LOWER(RegionSection) + ' needle aspirate for virology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND NeedleAspirate = 1 AND NeedleAspirateVirology = 1

       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Microbiology', 
              CONVERT(VARCHAR, @siteId) + 'GastricWashing', 
              'gastric washing for microbiology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND GastricWashing = 1

       FETCH NEXT FROM Site_Cursor INTO @siteId, @siteNo
END
CLOSE Site_Cursor;
DEALLOCATE Site_Cursor;

--biopsy series
INSERT INTO @SpecimensSummary
SELECT 
	ess.BiopsySiteId,
	'Histology',
	convert(varchar, ess.BiopsySiteId) + 'BiopsyHistology', 
	convert(varchar, ess.qty) + CASE WHEN ess.qty = 1 THEN ' biopsy' ELSE ' biopsies' END + ' for histology from ' + ebs.Description
FROM dbo.ERS_SiteSpecimens ess
	INNER JOIN dbo.ERS_BiopsySites ebs ON ess.BiopsySiteId = ebs.UniqueId
	INNER JOIN dbo.ERS_Sites es ON ess.SiteId = es.SiteId
WHERE ProcedureId = @ProcedureId


       SELECT s.SiteNo, Case @procType WHEN 1 THEN ISNULL(m.Area,'') ELSE '' END AS RegionSection, r.Region, sp.*, r.RegionId
       INTO #specimensCysto
       FROM ERS_CystoscopySpecimens sp
       JOIN ERS_Sites s ON sp.SiteId = s.SiteId
       JOIN ERS_Regions r ON s.RegionId = r.RegionId
       LEFT JOIN ERS_AbnormalitiesMatrixUpperGI m ON r.Region = m.Region AND m.ProcedureType = @procType
       LEFT JOIN [ERS_AbnormalitiesMatrixERCP] n ON r.Region = n.Region AND n.ProcedureType = @procType
       LEFT JOIN [ERS_AbnormalitiesMatrixColon] o ON r.Region = o.Region AND o.ProcedureType = @procType
       WHERE s.ProcedureId = @ProcedureId 
 
DECLARE Site_Cursor CURSOR FOR
SELECT SiteId, SiteNo FROM #specimensCysto ORDER BY SiteNo
       
OPEN Site_Cursor
FETCH NEXT FROM Site_Cursor INTO @siteId , @siteNo

WHILE @@FETCH_STATUS = 0
BEGIN
		SET @siteTitle = dbo.fnGetSiteTitle(@siteNo, @OperatingHospitalID)

		/****************************************************************
		*							MICROBIOLOGY						*
		****************************************************************/		
		/****************************************************************
		*	Microbiology Sub-section - EBUS Specimen					*
		****************************************************************/		
		INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Histology', 
              CONVERT(VARCHAR, @siteId) + 'BiopsyCystoHistology', 
              CONVERT(VARCHAR,Qunatity) + ' ' + LOWER(RegionSection) + CASE WHEN Qunatity > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for histology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimensCysto
       WHERE SiteId = @siteId AND Qunatity > 0

	   -- TFS 3216 Start
	   INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Cytology', 
              CONVERT(VARCHAR, @siteId) + 'BiopsyCystoCytology', 
              CONVERT(VARCHAR,QunatityCytology) + ' ' + LOWER(RegionSection) + CASE WHEN QunatityCytology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for cytology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimensCysto
       WHERE SiteId = @siteId AND QunatityCytology > 0
	   -- TFS 3216 End

       FETCH NEXT FROM Site_Cursor INTO @siteId, @siteNo
END
CLOSE Site_Cursor;
DEALLOCATE Site_Cursor;

/****************************************************************
ARS(15/09/21) - Bronchs Section
ARS(21/09/21) - Updated for reports
****************************************************************/
SELECT s.SiteNo, '' AS RegionSection, iif(s.IsLymphNode=1,(select l.name from ERS_EBUSLymphNodes l where l.EBUSLymphNodeId=s.EBUSLymphNodeSiteId), r.Region) as Region, --2407
		ebs.SiteID AS SiteId, r.RegionId, ebs.EBUSTB, ebs.EBUSCytology, ebs.EBUSHistology, ebs.EBUSBacteriology, ebs.EndobronchialTB, ebs.EndobronchialHistology, ebs.EndobronchialBacteriology,
		ebs.EndobronchialVirology, ebs.EndobronchialMycology, ebs.BrushCytology, ebs.BrushBacteriology, ebs.BrushVirology, ebs.BrushMycology, ebs.DistalBlindTB,
		ebs.DistalBlindHistology, ebs.DistalBlindVirology, ebs.DistalBlindBacteriology, ebs.DistalBlindMycology, ebs.TransbronchialTB, ebs.TransbronchialHistology,
		ebs.TransbronchialBacteriology, ebs.TransbronchialVirology, ebs.TransbronchialMycology, ebs.TranstrachealHistology, ebs.TranstrachealBacteriology,
		ebs.TranstrachealVirology, ebs.TranstrachealMycology, ebs.TrapPCP, ebs.TrapTB, ebs.TrapCytology, ebs.TrapBacteriology, ebs.TrapVirology, ebs.TrapMycology,
		ebs.BALPCP, ebs.BALTB, ebs.BALCytology, ebs.BALBacteriology, ebs.BALVirology, ebs.BALMycology, ebs.BALVolInfused, ebs.BALVolRecovered, ebs.FNATB,
		ebs.FNACytology, ebs.FNABacteriology, ebs.FNAVirology, ebs.FNAMycology, ebs.FNAHistology, ebs.CryoHistology, ebs.FungalCultureMycology, ebs.Summary
       INTO #specimensBRT
       FROM dbo.ERS_BRTSpecimens AS ebs
       JOIN ERS_Sites s ON s.SiteId = ebs.SiteID
       JOIN ERS_Regions r ON s.RegionId = r.RegionId
       LEFT JOIN dbo.ERS_AbnormalitiesMatrixBRT AS eamb ON eamb.Region = r.Region AND eamb.ProcedureType = @procType
       WHERE s.ProcedureId = @ProcedureId 
	   
DECLARE Site_Cursor CURSOR FOR
SELECT SiteId, SiteNo FROM #specimensBRT ORDER BY SiteNo
       
OPEN Site_Cursor
FETCH NEXT FROM Site_Cursor INTO @siteId , @siteNo

WHILE @@FETCH_STATUS = 0
BEGIN
		SET @siteTitle = dbo.fnGetSiteTitle(@siteNo, @OperatingHospitalID)

		/****************************************************************
		*							MICROBIOLOGY						*
		****************************************************************/		
		/****************************************************************
		*	Microbiology Sub-section - EBUS Specimen					*
		****************************************************************/		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'SpecimenMicrobiology', 
            CONVERT(VARCHAR,spec.EBUSTB) + ' ' + LOWER(RegionSection) + CASE WHEN spec.EBUSTB > 1 THEN ' EBUS specimens' ELSE ' EBUS specimen' END + ' for TB bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.EBUSTB > 0
		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'SpecimenMicrobiology', 
            CONVERT(VARCHAR,spec.EBUSBacteriology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.EBUSBacteriology > 1 THEN ' specimens' ELSE ' specimen' END + ' for bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.EBUSBacteriology > 0
			   
		/****************************************************************
		*	Microbiology Sub-section - Endobronchial Biopsy				*
		****************************************************************/		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.EndobronchialTB) + ' ' + LOWER(RegionSection) + CASE WHEN spec.EndobronchialTB > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for TB bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.EndobronchialTB > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.EndobronchialBacteriology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.EndobronchialBacteriology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.EndobronchialBacteriology > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.EndobronchialVirology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.EndobronchialVirology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for virology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.EndobronchialVirology > 0
		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.EndobronchialMycology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.EndobronchialMycology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for mycology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.EndobronchialMycology > 0

		/****************************************************************
		*	Microbiology Sub-section - Brush Biopsy						*
		****************************************************************/		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.BrushBacteriology) + ' ' + LOWER(RegionSection) --+ CASE WHEN spec.BrushBacteriology > 1 THEN ' biopsies' ELSE ' biopsy' END --#tfs 4307
			+ 'brush for bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.BrushBacteriology > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.BrushVirology) + ' ' + LOWER(RegionSection) --+ CASE WHEN spec.BrushVirology > 1 THEN ' biopsies' ELSE ' biopsy' END --#tfs 4307
			+ 'brush for virology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.BrushVirology > 0
		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.EndobronchialMycology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.EndobronchialMycology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for mycology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.EndobronchialMycology > 0

		/****************************************************************
		*	Microbiology Sub-section - Distal Blind Biopsy				*
		****************************************************************/		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.DistalBlindTB) + ' ' + LOWER(RegionSection) + CASE WHEN spec.DistalBlindTB > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for TB bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.DistalBlindTB > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.DistalBlindBacteriology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.DistalBlindBacteriology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.DistalBlindBacteriology > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.DistalBlindVirology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.DistalBlindVirology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for virology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.DistalBlindVirology > 0
		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.DistalBlindMycology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.DistalBlindMycology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for mycology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.DistalBlindMycology > 0

		/****************************************************************
		*	Microbiology Sub-section - Transbronchial Biopsy			*
		****************************************************************/		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.TransbronchialTB) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TransbronchialTB > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for TB bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TransbronchialTB > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.TransbronchialBacteriology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TransbronchialBacteriology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TransbronchialBacteriology > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.TransbronchialVirology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TransbronchialVirology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for virology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TransbronchialVirology > 0
		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.TransbronchialMycology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TransbronchialMycology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for mycology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TransbronchialMycology > 0

		/****************************************************************
		*	Microbiology Sub-section - Transtracheal Biopsy				*
		****************************************************************/		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.TranstrachealBacteriology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TranstrachealBacteriology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TranstrachealBacteriology > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.TranstrachealVirology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TranstrachealVirology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for virology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TranstrachealVirology > 0
		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.TranstrachealMycology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TranstrachealMycology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for mycology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TranstrachealMycology > 0

		/****************************************************************
		*	Microbiology Sub-section - Trap								*
		****************************************************************/
		
		------------------------------------------------------------------------------------------------------------------------
		-- TFS#	1880
		-- Description of change: Fixed Bronch TRAP Biopsy naming on lab form
		-------------------------------------------------------------------------------------------------------------------------
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            'Trap sample(s)' + ' '  + CONVERT(VARCHAR,spec.TrapTB) + ' ' + 'from TB bacteriology'
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TrapTB > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
			'Trap sample(s)' + ' '  + CONVERT(VARCHAR,spec.TrapBacteriology) + ' ' + 'from bacteriology'
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TrapBacteriology > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
			'Trap sample(s)' + ' '  + CONVERT(VARCHAR,spec.TrapVirology) + ' ' + 'from virology'
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TrapVirology > 0
		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
			'Trap sample(s)' + ' '  + CONVERT(VARCHAR,spec.TrapMycology) + ' ' + 'from mycology'
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TrapMycology > 0

		------------------------------------------------------------------------------------------------------------------------
		-- TFS#	1880 Ended
		------------------------------------------------------------------------------------------------------------------------

		/****************************************************************
		*	Microbiology Sub-section - Bronchoalveolar Lavage (BAL)		*
		****************************************************************/		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.BALTB) + ' ' + LOWER(RegionSection) + CASE WHEN spec.BALTB > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for TB bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.BALTB > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.BALBacteriology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.BALBacteriology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.BALBacteriology > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.BALVirology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.BALVirology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for virology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.BALVirology > 0
		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.BALMycology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.BALMycology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for mycology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.BALMycology > 0

		/****************************************************************
		*	Microbiology Sub-section - Fine Needle Aspirate (FNA)		*
		****************************************************************/		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.FNABacteriology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.FNABacteriology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.FNABacteriology > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.FNAVirology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.FNAVirology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for virology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.FNAVirology > 0
		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.FNAMycology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.FNAMycology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for mycology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.FNAMycology > 0

		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.FungalCultureMycology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.FungalCultureMycology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for mycology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.FungalCultureMycology > 0

		/****************************************************************
		*							HISTOLOGY							*
		****************************************************************/
		/****************************************************************
		*	Histology Sub-section - EBUS Specimen						*
		****************************************************************/
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Histology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyHistology', 
            CONVERT(VARCHAR,spec.EBUSHistology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.EBUSHistology > 1 THEN ' EBUS specimens' ELSE ' EBUS specimen' END + ' for histology from (' + LOWER(@siteTitle) + ') ' + Region			
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.EBUSHistology > 0

		/****************************************************************
		*	Histology Sub-section - Endobronchial Biopsy				*
		****************************************************************/
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Histology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyHistology', 
            CONVERT(VARCHAR,spec.EndobronchialHistology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.EndobronchialHistology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for histology from (' + LOWER(@siteTitle) + ') ' + Region			
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.EndobronchialHistology > 0

		/****************************************************************
		*	Histology Sub-section - Distal Blind Biopsy					*
		****************************************************************/
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Histology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyHistology', 
            CONVERT(VARCHAR,spec.DistalBlindHistology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.DistalBlindHistology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for histology from (' + LOWER(@siteTitle) + ') ' + Region			
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.DistalBlindHistology > 0

		/****************************************************************
		*	Histology Sub-section - Transbronchial Biopsy				*
		****************************************************************/
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Histology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyHistology', 
            CONVERT(VARCHAR,spec.TransbronchialHistology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TransbronchialHistology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for histology from (' + LOWER(@siteTitle) + ') ' + Region			
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TransbronchialHistology > 0

		/****************************************************************
		*	Histology Sub-section - Transtracheal Biopsy				*
		****************************************************************/
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Histology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyHistology', 
            CONVERT(VARCHAR,spec.TranstrachealHistology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TranstrachealHistology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for histology from (' + LOWER(@siteTitle) + ') ' + Region			
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TranstrachealHistology > 0

		/****************************************************************
		*	Histology Sub-section - Fine Needle Aspirate (FNA)			*
		****************************************************************/
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Histology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyHistology', 
            CONVERT(VARCHAR,spec.FNAHistology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.FNAHistology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for histology from (' + LOWER(@siteTitle) + ') ' + Region			
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.FNAHistology > 0

		/****************************************************************
		*	Histology Sub-section - Cryobiopsy							*
		****************************************************************/		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Histology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyHistology', 
            CONVERT(VARCHAR,spec.CryoHistology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.CryoHistology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for histology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.CryoHistology > 0

		/****************************************************************
		*							CYTOLOGY							*
		****************************************************************/
		/****************************************************************
		*	Cytology Sub-section - EBUS Specimen						*
		****************************************************************/
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Cytology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyCytology', 
            CONVERT(VARCHAR,spec.EBUSCytology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.EBUSCytology > 1 THEN ' EBUS specimens' ELSE ' EBUS specimen' END + ' for cytology from (' + LOWER(@siteTitle) + ') ' + Region			
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.EBUSCytology > 0

		/****************************************************************
		*	Cytology Sub-section - Brush Biopsy							*
		****************************************************************/
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Cytology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyCytology', 
            CONVERT(VARCHAR,spec.BrushCytology) + ' ' + LOWER(RegionSection) --+ CASE WHEN spec.BrushCytology > 1 THEN ' biopsies' ELSE ' biopsy' END --#tfs 4307
			+ 'brush for cytology from (' + LOWER(@siteTitle) + ') ' + Region			
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.BrushCytology > 0

		/****************************************************************
		*	Cytology Sub-section - Trap									*
		****************************************************************/
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Cytology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyCytology', 
            CONVERT(VARCHAR,spec.TrapCytology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TrapCytology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for cytology from (' + LOWER(@siteTitle) + ') ' + Region			
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TrapCytology > 0

		/****************************************************************
		*	Cytology Sub-section - Bronchoalveolar Lavage (BAL)			*
		****************************************************************/
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Cytology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyCytology', 
            CONVERT(VARCHAR,spec.BALCytology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.BALCytology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for cytology from (' + LOWER(@siteTitle) + ') ' + Region			
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.BALCytology > 0

		/****************************************************************
		*	Cytology Sub-section - Fine Needle Aspirate (FNA)			*
		****************************************************************/
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Cytology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyCytology', 
            CONVERT(VARCHAR,spec.FNACytology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.FNACytology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for cytology from (' + LOWER(@siteTitle) + ') ' + Region			
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.FNACytology > 0
	   
       FETCH NEXT FROM Site_Cursor INTO @siteId, @siteNo
END
CLOSE Site_Cursor;
DEALLOCATE Site_Cursor;

IF OBJECT_ID('tempdb..#specimens') IS NOT NULL DROP TABLE #specimens 
IF OBJECT_ID('tempdb..#specimensBRT') IS NOT NULL DROP TABLE #specimensBRT
SELECT * FROM @SpecimensSummary
GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	4307
------------------------------------------------------------------------------------------------------------------------
go
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Muhammad Nasim
-- TFS#	3200
-- Description of change: Filter indications my procedure Category
------------------------------------------------------------------------------------------------------------------------
GO
Update ERS_Indications set Description='Cancer risk surveillance' where Description='High cancer risk surveillance'
update ERS_Indications set IndicationSectionId=6 where Description in ('IBD surveillance','IBD assessment','Post polypectomy surveillance','Tumour assessment','Cancer risk surveillance')
update ERS_Indications set IndicationSectionId=6 where ParentId in (select UniqueId from ERS_Indications where Description in ('IBD surveillance','IBD assessment','Post polypectomy surveillance','Tumour assessment','Cancer risk surveillance'))
if not exists(select 1 from [dbo].[ERS_Indications] where NEDTerm='Other Surveillance')
begin
	INSERT INTO [dbo].[ERS_Indications]([Description],[NEDTerm],[Suppressed],[AdditionalInfo],[SubIndicationParent],[PlannedProcedure],[IndicationSectionId],[JAGAuditable])
	VALUES('Other','Other Surveillance',0,1,0,0,6,0)
	Declare @indicationId int=SCOPE_IDENTITY()
	INSERT INTO [dbo].[ERS_IndicationsProcedureTypes]([IndicationId],[ProcedureTypeId])
	VALUES(@indicationId ,3),(@indicationId ,4),(@indicationId ,5),(@indicationId ,8),(@indicationId ,9)--3,4,5,8,9
end
GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	3200 Ended
------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Muhammad Nasim
-- TFS#	4233
-- Description of change: Other indications for EBUS
------------------------------------------------------------------------------------------------------------------------
GO
	if not exists(select 1 from ERS_IndicationsProcedureTypes where IndicationId=53 and ProcedureTypeId=11)
	begin
	 INSERT INTO [dbo].[ERS_IndicationsProcedureTypes]([IndicationId],[ProcedureTypeId]) VALUES(53 ,11)
	end

GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	4233 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Siddik
-- TFS#	3904
-- Description of change: Capsule placement   
-------------------------------------------------------------------------------------------------------------------------

DELETE eip FROM ERS_IndicationsProcedureTypes eip
INNER JOIN ERS_Indications ei
ON eip.IndicationId = ei.UniqueId
WHERE ei.Description = 'Capsule placement'
AND eip.ProcedureTypeId = 3
GO

------------------------------------------------------------------------------------------------------------------------
-- TFS#	3904 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Siddik
-- TFS#	2897
-- Description of change: Mucosa diagnose of Pigmented (melanosis)
-------------------------------------------------------------------------------------------------------------------------

IF NOT EXISTS (SELECT 1 FROM ERS_DiagnosesMatrix WHERE DisplayName = 'Mucosal Pigmentation')
BEGIN
	INSERT INTO ERS_DiagnosesMatrix (DisplayName, NED_Name, ProcedureTypeID, Section, OrderByNumber, Code, NED_Include)
    VALUES ('Mucosal Pigmentation', 'Melanosis', 3, 'Colon', 0, 'DPigmentedP3', 1),
		   ('Mucosal Pigmentation', 'Melanosis', 4, 'Colon', 0, 'DPigmentedP4', 1),
		   ('Mucosal Pigmentation', 'Melanosis', 9, 'Colon', 0, 'DPigmentedP9', 1)
END
GO

EXEC dbo.DropIfExist 
    @ObjectName = 'TR_ColonAbnoMucosa', 
    @ObjectTypePrefix = 'TR' 
GO

CREATE TRIGGER [dbo].[TR_ColonAbnoMucosa]
ON [dbo].[ERS_ColonAbnoMucosa]
AFTER INSERT, UPDATE, DELETE
AS 
	DECLARE @site_id INT, @RedundantRectal VARCHAR(10), @HasUlcer VARCHAR(10), @UserID as int, @Mucosa VARCHAR(10), @UlcerativeMucosa VARCHAR(10), @Action CHAR(1) ='I', @ProcedureTypeId INT
	DECLARE @MucosalInflammation VARCHAR(10), @Ulcerative VARCHAR(10), @Pigmented VARCHAR(10), @Region varchar(50)

    IF EXISTS(SELECT * FROM DELETED) SET @Action = CASE WHEN EXISTS(SELECT * FROM INSERTED) THEN 'U' ELSE 'D' END

	IF @Action IN ('I', 'U') 
	BEGIN
		SELECT @site_id=SiteId, 
			@RedundantRectal = (CASE WHEN (RedundantRectal=1) THEN 'True' ELSE 'False' END),
			@HasUlcer = (CASE WHEN (SmallUlcers=1 OR LargeUlcers=1 OR PleomorphicUlcers=1 OR SerpiginousUlcers=1 
									OR AphthousUlcers=1 OR ConfluentUlceration=1 OR DeepUlceration=1 OR SolitaryUlcer=1)
									THEN 'True' ELSE 'False' END),
			@UserID = (CASE WHEN ISNULL(WhoUpdatedId,0) = 0 THEN WhoCreatedId ELSE WhoUpdatedId END),
			@Mucosa = (CASE WHEN ([None] = 0 AND InflammatoryColitis = 0 AND InflammatoryIleitis = 0 AND InflammatoryProctitis = 0) THEN 'True' ELSE 'False' END),
			@UlcerativeMucosa = (CASE WHEN (CobblestoneMucosa = 1) THEN 'True' ELSE 'False' END),
			@Ulcerative = (CASE WHEN (Inserted.Ulcerative = 1) THEN 'True' ELSE 'False' END),
			@Pigmented = (CASE WHEN (Inserted.Pigmented = 1) THEN 'True' ELSE 'False' END),		--TFS 2897
			@MucosalInflammation = CASE WHEN (Atrophic = 1 OR Congested = 1 OR Erythematous = 1 OR Granular = 1 OR Exudate = 1) THEN 'True' ELSE 'False' END		--TFS 2897

		FROM INSERTED
	END
	
	--insert into ERS_ErrorLog(ErrorMessage, ErrorTimestamp, ProductId, ProductVersion, UserId, HospitalId, OperatingHospitalId) 
	--		VALUES (	
	--					'RedundantRectal: ' + @RedundantRectal + ', ' + 
	--					'HasUlcer: ' + @HasUlcer + ', ' +	--					
	--					'UlcerativeMucosa: ' + @UlcerativeMucosa + ', ' + 
	--					'MucosalInflammation: ' + @MucosalInflammation,
	--					GETDATE(), 1, '1', 1, 1, 1)	

	IF @MucosalInflammation = 'True'
		SET @Mucosa = 'False'
		
	IF @HasUlcer = 'True' 	
		SET @Ulcerative = 'False'	-- Ulcerative checkbox only	
	ELSE IF @UlcerativeMucosa = 'True'
		SET @Ulcerative = 'False'	-- Ulcerative checkbox only	
	
	-- DELETED
	IF @Action = 'D'
	BEGIN
		SELECT @site_id=SiteId FROM DELETED
	END
	
	EXEC infer_mucosa_diagnoses @site_id, @UserID

	--insert into ERS_ErrorLog(ErrorMessage, ErrorTimestamp, ProductId, ProductVersion, UserId, HospitalId, OperatingHospitalId) 
	--		VALUES (	
	--					'RedundantRectal: ' + @RedundantRectal + ', ' + 
	--					'HasUlcer: ' + @HasUlcer + ', ' +	
	--					'UlcerativeMucosa: ' + @UlcerativeMucosa + ', ' + 
	--					'MucosalInflammation: ' + @MucosalInflammation,
	--					GETDATE(), 1, '1', 1, 1, 1)	

	SELECT @ProcedureTypeId = ep.ProcedureType FROM dbo.ERS_Procedures AS ep WHERE ep.ProcedureId IN (SELECT es.ProcedureId FROM dbo.ERS_Sites AS es WHERE es.SiteId = @site_id)
	SET @Region=(select x.Region from [ERS_AbnormalitiesMatrixColon] x inner join ERS_Regions r on x.region = r.Region AND r.ProcedureType= x.ProcedureType inner join ers_sites s on r.RegionId = s.RegionId where s.SiteId = @site_id )

	IF @ProcedureTypeId = 3	--COL
	BEGIN
		EXEC diagnoses_control_save @site_id, 'D15P3', @RedundantRectal			-- 'Redundant anterior rectal mucosa'
		
		IF @MucosalInflammation = 'True'
		BEGIN						
			--EXEC diagnoses_control_save @site_id, 'D21P3', 'False'				-- 'Mucosa'
			EXEC diagnoses_control_save @site_id, 'D26P3', 'False'				-- 'Rectal mucosa'			

			IF  @Region not in ('Rectum', 'Anal Margin', 'Terminal Ileum') --TFS 3673
			BEGIN				
				EXEC diagnoses_control_save @site_id, 'D80P3', 'False'			-- 'Rectal ulcer(s)'
				EXEC diagnoses_control_save @site_id, 'D83P3', @HasUlcer		-- 'Colonic ulcer(s)'
			END
			ELSE
			BEGIN				
				EXEC diagnoses_control_save @site_id, 'D80P3', @HasUlcer		-- 'Rectal ulcer(s)'				
			END
		END
		ELSE	--@MucosalInflammation = 'False'
		BEGIN						
			IF  @Region not in ('Rectum', 'Anal Margin', 'Terminal Ileum') --TFS 3673
			BEGIN
				--EXEC diagnoses_control_save @site_id, 'D21P3', 'True'			-- 'Mucosa'
				EXEC diagnoses_control_save @site_id, 'D26P3', 'False'			-- 'Rectal mucosa'				
				EXEC diagnoses_control_save @site_id, 'D80P3', 'False'			-- 'Rectal ulcer(s)'
				EXEC diagnoses_control_save @site_id, 'D83P3', @HasUlcer		-- 'Colonic ulcer(s)'
			END
			ELSE
			BEGIN
				--EXEC diagnoses_control_save @site_id, 'D21P3', 'False'			-- 'Mucosa'
				EXEC diagnoses_control_save @site_id, 'D26P3', 'False'			-- 'Rectal mucosa'		-- TFS 3673		
				EXEC diagnoses_control_save @site_id, 'D80P3', @HasUlcer		-- 'Rectal ulcer(s)'
				EXEC diagnoses_control_save @site_id, 'D83P3', 'False'			-- 'Colonic ulcer(s)'
			END
		END
		EXEC diagnoses_control_save @site_id, 'D25P3', @UlcerativeMucosa
		EXEC diagnoses_control_save @site_id, 'DUlcerativeP3', @Ulcerative	-- Ulcerative checkbox only
		EXEC diagnoses_control_save @site_id, 'DPigmentedP3', @Pigmented	-- Pigmented checkbox only		--TFS 2897
		EXEC diagnoses_control_save @site_id, 'DMucInfAllP3', @MucosalInflammation	-- Mucosal inflammation
	END
	ELSE IF @ProcedureTypeId = 4	--SIG
	BEGIN
		EXEC diagnoses_control_save @site_id, 'S15P3', @RedundantRectal		-- 'Redundant anterior rectal mucosa'
		
		IF @MucosalInflammation = 'True'
		BEGIN						
			--EXEC diagnoses_control_save @site_id, 'S21P3', 'False'				-- 'Mucosa'
			EXEC diagnoses_control_save @site_id, 'S26P3', 'False'				-- 'Rectal mucosa'			

			IF  @Region not in ('Rectum', 'Anal Margin')
			BEGIN				
				EXEC diagnoses_control_save @site_id, 'S80P3', 'False'			-- 'Rectal ulcer(s)'
				EXEC diagnoses_control_save @site_id, 'S83P3', @HasUlcer		-- 'Colonic ulcer(s)'
			END
			ELSE
			BEGIN				
				EXEC diagnoses_control_save @site_id, 'S80P3', @HasUlcer		-- 'Rectal ulcer(s)'				
			END
		END
		ELSE	--@MucosalInflammation = 'False'
		BEGIN						
			IF  @Region not in ('Rectum', 'Anal Margin')
			BEGIN
				--EXEC diagnoses_control_save @site_id, 'S21P3', 'True'			-- 'Mucosa'
				EXEC diagnoses_control_save @site_id, 'S26P3', 'False'			-- 'Rectal mucosa'				
				EXEC diagnoses_control_save @site_id, 'S80P3', 'False'			-- 'Rectal ulcer(s)'
				EXEC diagnoses_control_save @site_id, 'S83P3', @HasUlcer		-- 'Colonic ulcer(s)'
			END
			ELSE
			BEGIN
				--EXEC diagnoses_control_save @site_id, 'S21P3', 'False'			-- 'Mucosa'
				EXEC diagnoses_control_save @site_id, 'S26P3', 'False'			-- 'Rectal mucosa'				
				EXEC diagnoses_control_save @site_id, 'S80P3', @HasUlcer		-- 'Rectal ulcer(s)'
				EXEC diagnoses_control_save @site_id, 'S83P3', 'False'			-- 'Colonic ulcer(s)'
			END
		END

		EXEC diagnoses_control_save @site_id, 'S25P3', @UlcerativeMucosa
		EXEC diagnoses_control_save @site_id, 'DUlcerativeP4', @Ulcerative	-- Ulcerative checkbox only
		EXEC diagnoses_control_save @site_id, 'DPigmentedP4', @Pigmented	-- Pigmented checkbox only		--TFS 2897
		EXEC diagnoses_control_save @site_id, 'DMucInfAllP4', @MucosalInflammation	-- Mucosal inflammation
	END
	ELSE IF @ProcedureTypeId = 5	--PROCT
	BEGIN
		EXEC diagnoses_control_save @site_id, 'P15P3', @RedundantRectal			-- 'Redundant anterior rectal mucosa'
		
		IF @MucosalInflammation = 'True'
		BEGIN						
			--EXEC diagnoses_control_save @site_id, 'P21P3', 'False'				-- 'Mucosa'
			EXEC diagnoses_control_save @site_id, 'P26P3', 'False'				-- 'Rectal mucosa'			

			IF  @Region NOT IN ('Rectum', 'Anal Margin')
			BEGIN				
				EXEC diagnoses_control_save @site_id, 'P80P3', 'False'			-- 'Rectal ulcer(s)'
				EXEC diagnoses_control_save @site_id, 'P83P3', @HasUlcer		-- 'Colonic ulcer(s)'
			END
			ELSE
			BEGIN				
				EXEC diagnoses_control_save @site_id, 'P80P3', @HasUlcer		-- 'Rectal ulcer(s)'				
			END
		END
		ELSE	--@MucosalInflammation = 'False'
		BEGIN						
			IF  @Region NOT IN ('Rectum', 'Anal Margin')
			BEGIN
				--EXEC diagnoses_control_save @site_id, 'P21P3', 'True'			-- 'Mucosa'
				EXEC diagnoses_control_save @site_id, 'P26P3', 'False'			-- 'Rectal mucosa'				
				EXEC diagnoses_control_save @site_id, 'P80P3', 'False'			-- 'Rectal ulcer(s)'
				EXEC diagnoses_control_save @site_id, 'P83P3', @HasUlcer		-- 'Colonic ulcer(s)'
			END
			ELSE
			BEGIN
				--EXEC diagnoses_control_save @site_id, 'P21P3', 'False'			-- 'Mucosa'
				EXEC diagnoses_control_save @site_id, 'P26P3', 'True'			-- 'Rectal mucosa'				
				EXEC diagnoses_control_save @site_id, 'P80P3', @HasUlcer		-- 'Rectal ulcer(s)'
				EXEC diagnoses_control_save @site_id, 'P83P3', 'False'			-- 'Colonic ulcer(s)'
			END
		END

		EXEC diagnoses_control_save @site_id, 'P25P3', @UlcerativeMucosa
		EXEC diagnoses_control_save @site_id, 'DUlcerativeP5', @Ulcerative	-- Ulcerative checkbox only
		EXEC diagnoses_control_save @site_id, 'DMucInfAllP5', @MucosalInflammation	-- Mucosal inflammation
	END
	ELSE IF @ProcedureTypeId = 9	--ENT RETRO
	BEGIN
		EXEC diagnoses_control_save @site_id, 'D15P9', @RedundantRectal		-- 'Redundant anterior rectal mucosa'

		IF @MucosalInflammation = 'True'
		BEGIN
			EXEC diagnoses_control_save @site_id, 'D80P9', 'False'			-- 'Rectal ulcer(s)', D83P9 for 'Colonic ulcer(s)'
			EXEC diagnoses_control_save @site_id, 'D83P9', 'True'			-- 'Rectal ulcer(s)', D83P9 for 'Colonic ulcer(s)'
		END
		ELSE
			EXEC diagnoses_control_save @site_id, 'D80P9', @HasUlcer			-- 'Rectal ulcer(s)', D83P9 for 'Colonic ulcer(s)'
							
		EXEC diagnoses_control_save @site_id, 'D26P9', @Mucosa
		EXEC diagnoses_control_save @site_id, 'D25P9', @UlcerativeMucosa
		EXEC diagnoses_control_save @site_id, 'DUlcerativeP9', @Ulcerative	-- Ulcerative checkbox only
		EXEC diagnoses_control_save @site_id, 'DPigmentedP9', @Pigmented	-- Pigmented checkbox only		--TFS 2897
		EXEC diagnoses_control_save @site_id, 'DMucInfAllP9', @MucosalInflammation	-- Mucosal inflammation
	END

	EXEC abnormalities_mucosa_summary_update @site_id
	EXEC sites_summary_update @site_id

GO

------------------------------------------------------------------------------------------------------------------------
-- TFS#	2897 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Siddik
-- TFS#	4329
-- Description of change: angiodysplasia incorrect diagnoses 
-------------------------------------------------------------------------------------------------------------------------

UPDATE ERS_DiagnosesMatrix
SET DisplayName = 'Angiodysplasia'
WHERE DisplayName = 'Angioma'
GO

UPDATE ERS_DiagnosesMatrix
SET DisplayName = 'Telangiectasia'
WHERE DisplayName = 'Telangiectasia/angioma'
GO

EXEC dbo.DropIfExist 
    @ObjectName = 'TR_CommonAbnoVascularLesions', 
    @ObjectTypePrefix = 'TR' 
GO

CREATE TRIGGER [dbo].[TR_CommonAbnoVascularLesions]
ON [dbo].[ERS_CommonAbnoVascularLesions]
AFTER INSERT, UPDATE, DELETE
AS 
	DECLARE @site_id INT, @Telangiectasia VARCHAR(10) = 'False', @Angioma VARCHAR(10) = 'False', 
			@StomachTelangiectasia VARCHAR(10) = 'False', @PortalHypertensiveGastropathy VARCHAR(10) = 'False', 
			@TelangiectasiaAngioma VARCHAR(10) = 'False', @Angiodysplasia VARCHAR(10) = 'False', 
			@Action CHAR(1) = 'I' , @DieulafoyLesion VARCHAR(10) = 'False', @DuodenumVarices VARCHAR(10) = 'False',
			@WatermelonStomach VARCHAR(10) = 'False',
			@DuoTelangiectasia VARCHAR(10)

    IF EXISTS(SELECT * FROM DELETED) SET @Action = CASE WHEN EXISTS(SELECT * FROM INSERTED) THEN 'U' ELSE 'D' END

	-- INSERTED OR UPDATED
	IF @Action IN ('I', 'U') 
	BEGIN
		SELECT @site_id=SiteId,
				-- START TFS 2978
				@Telangiectasia = (CASE WHEN ([Type] = 1 AND [Area] = 'Oesophagus'  AND [Area] != 'Duodenum') THEN 'True' ELSE 'False' END),
				@DuoTelangiectasia = (CASE WHEN ([Type] = 1 AND [Area] = 'Duodenum') THEN 'True' ELSE 'False' END),
				@Angioma = (CASE WHEN ([Type] IN (2, 3, 4) AND Area IN ('Stomach', 'Duodenum')) THEN 'True' ELSE 'False' END),	--TFS 4329
				@StomachTelangiectasia = (CASE WHEN ([Type]=1 AND [Area]='Stomach') THEN 'True' ELSE 'False' END),
				@PortalHypertensiveGastropathy = (CASE WHEN (Area='Stomach' AND [Type]=5) THEN 'True' ELSE 'False' END),
				@DuodenumVarices = (CASE WHEN (Area='Duodenum' AND [Type]=5) THEN 'True' ELSE 'False' END),
				@TelangiectasiaAngioma = (CASE WHEN ( Area = 'Duodenum' AND [Type] = 1) THEN 'True' ELSE 'False' END),	--TFS 4329
				@Angiodysplasia = (CASE WHEN ([Type] BETWEEN 2 AND 5) THEN 'True' ELSE 'False' END),
				@DieulafoyLesion = (CASE WHEN [Type] = 7 AND [Area] = 'Stomach'  THEN 'True' ELSE 'False' END), --TFS--4190
				-- END TFS 2978
				@WatermelonStomach = (CASE WHEN ([Type] = 6 AND [Area] = 'Stomach') THEN 'True' ELSE 'False' END)
		FROM INSERTED

		EXEC abnormalities_vascular_lesions_summary_update @site_id
	END

	-- DELETED
	IF @Action = 'D'
	BEGIN
		SELECT @site_id=SiteId FROM DELETED
	END

	EXEC sites_summary_update @site_id

	IF ISNULL((SELECT p.ProcedureType FROM ers_sites s 
		INNER JOIN ers_procedures p ON s.ProcedureId = p.ProcedureId 
		WHERE SiteId = @site_id),0) IN (2, 7)   --Check If ERCP (2), else proceed with OGD
	BEGIN
		EXEC diagnoses_control_save @site_id, 'D64P2', @Angiodysplasia					-- 'Angiodysplasia'
		EXEC diagnoses_control_save @site_id, 'D396P2', @DuoTelangiectasia					-- 'Telangiectasia'

	END
	ELSE
	BEGIN
		EXEC diagnoses_control_save @site_id, 'D22P1', @Telangiectasia					-- 'Telangiectasia'
		EXEC diagnoses_control_save @site_id, 'D43P1', @Angioma							-- 'Angioma'
		EXEC diagnoses_control_save @site_id, 'D46P1', @StomachTelangiectasia			-- 'StomachTelangiectasia'
		EXEC diagnoses_control_save @site_id, 'D52P1', @PortalHypertensiveGastropathy	-- 'PortalHypertensiveGastropathy'
		EXEC diagnoses_control_save @site_id, 'D59P1', @TelangiectasiaAngioma			-- 'TelangiectasiaAngioma'
		EXEC diagnoses_control_save @site_id, 'D80P1', @DieulafoyLesion					-- 'Dieulafoy Lesion'
		EXEC diagnoses_control_save @site_id, 'D106P1', @DuodenumVarices
		EXEC diagnoses_control_save @site_id, 'D85P1', @WatermelonStomach				-- GAVE (Watermelon Stomach)
	END

GO

------------------------------------------------------------------------------------------------------------------------
-- TFS#	4329 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Siddik
-- TFS#	4226
-- Description of change: Trainee Endoscopist Audit update
-------------------------------------------------------------------------------------------------------------------------

EXEC dbo.DropIfExist 
    @ObjectName = 'report_TraineeEndoscopist', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[report_TraineeEndoscopist] 
	@UserID INT
AS
BEGIN
	DECLARE @FromDate as Date,
			@ToDate as Date,
			@TrustId as int,
			@HealthService as varchar(max),
			@OperatingHospitalList as varchar(100)

	Select	@FromDate = FromDate,
			@ToDate = ToDate,
			@TrustId = TrustId,
			@OperatingHospitalList=OperatingHospitalList
	FROM	ERS_ReportFilter
	where	UserID = @UserId
	
	SELECT @HealthService = CustomText FROM ERS_Custom_Text WHERE CustomTextId = 'CountryOfOriginHealthService'


		Select  p.ProcedureId 
				, pat.Forename1 as Forename
				, pat.Surname as Surname
				, pat.HospitalNumber as 'Case note number'
				, convert(varchar(14),pat.DateOfBirth,106) as DOB
				, oh.HospitalName as 'Operating hospital'
				, pt.ProcedureType as 'Procedure Type',
				p.NEDExported as 'National Data Set Exported',	--tfs 4316
				ISNULL(p.StartDateTime, p.ModifiedOn)  as 'Procedure Date & Start Time'
				,p.ENDDateTime  as 'Procedure End time'
				, Endo1.Surname + ', ' + Endo1.Forename as 'Endoscopist 1',
				 case p.endo1Role when 2 then 'trainer observed'
								  When 3 Then 'trainer assisted'
								  else ''
								  End as 'Endo1Role'
				, Endo2.Surname + ', ' + Endo2.Forename as 'Endoscopist 2',
				 case p.endo2Role when 2 then 'trainer observed'
								  When 3 Then 'trainer assisted'
								  else ''
								  End as 'Endo1Role',

			  STUFF((SELECT '<br>Submited Date :' + QUOTENAME(Logdate)  + ' Response Date :'+QUOTENAME(NEDWebserviceQueueResponseDate) +' Status '+ QUOTENAME(Status)
							FROM ERS_NEDI2FilesLog el1
							where el1.ProcedureID=p.ProcedureId
							and Status in (4,5,6)
					FOR XML PATH(''), TYPE
					).value('.', 'NVARCHAR(MAX)') 
				,1,1,'') as 'National Data Set Status'	--tfs 4316
		from ERS_Procedures p (nolock)
		join ERS_ReportConsultants rc (nolock) on p.ListConsultant = rc.ConsultantID 
		join ERS_Patients pat (nolock) on p.PatientId = pat.PatientId 
		join ERS_OperatingHospitals (nolock) oh on p.OperatingHospitalID = oh.OperatingHospitalId 
		join ERS_ProcedureTypes (nolock) pt on P.ProcedureType = pt.ProcedureTypeId 
		join ERS_Users Endo1 (nolock) on p.Endoscopist1 = Endo1.UserID
		left outer join ERS_Users Endo2 (nolock) on p.Endoscopist2 = Endo2.UserID

		where p.ProcedureCompleted = 1
			and p.IsActive = 1
			and p.CreatedOn >= @FromDate AND p.CreatedOn <= @ToDate
			and rc.UserID = @UserId
			AND P.OperatingHospitalID IN (SELECT * FROM dbo.splitString(@OperatingHospitalList,',') )--Partha , 17/05/2024 TFS1811
			and IsNull(p.DNA,0) = 0
			and  (p.Endo1Role  in (2,3) or p.Endo2Role in (2,3))
		order by p.CreatedOn 

END 

GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	4226 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Siddik
-- TFS#	4067
-- Description of change: Comorbidities - filter per procedure
-------------------------------------------------------------------------------------------------------------------------

DELETE ecp
FROM ERS_ComorbidityProcedureTypes ecp
INNER JOIN ERS_Comorbidity ec 
ON ecp.ComorbidityId = ec.UniqueId
WHERE ec.Description IN ('Enlarged Lymph Nodes', 'Interstitial Lung Disease', 'Pleural Effusion', 'Pneumonia', 'TIA');
GO

IF NOT EXISTS (SELECT 1 FROM ERS_Comorbidity WHERE Description = 'Liver Disease')
BEGIN
	INSERT INTO ERS_Comorbidity (Description, NEDTerm)
	VALUES ('Liver Disease', '');

	DECLARE @NewComorbidityId INT = SCOPE_IDENTITY();

	INSERT INTO ERS_ComorbidityProcedureTypes (ComorbidityId, ProcedureTypeId)
	VALUES 
	(@NewComorbidityId, 1),
	(@NewComorbidityId, 2),
	(@NewComorbidityId, 3),
	(@NewComorbidityId, 4),
	(@NewComorbidityId, 6),
	(@NewComorbidityId, 7),
	(@NewComorbidityId, 8),
	(@NewComorbidityId, 9);
END
GO

------------------------------------------------------------------------------------------------------------------------
-- TFS#	4067 Ended
------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rony
-- TFS#	1861
-- Description of change
-- SE V2 - Post Procedure scope section & Audit 
------------------------------------------------------------------------------------------------------------------------
 IF NOT EXISTS (
        SELECT 1
        FROM INFORMATION_SCHEMA.COLUMNS
        WHERE TABLE_NAME = 'ERS_PostOperativeComplications' AND
              COLUMN_NAME IN ('ScopeCreatedDate','ScopeDamaged', 'ScopeDiscovered','ScopeDiscoveredOther')
    )
    BEGIN
		
		ALTER TABLE ERS_PostOperativeComplications
            ADD ScopeCreatedDate datetime,
			 ScopeDamaged BIT,
             ScopeDiscovered tinyint,
			 ScopeDiscoveredOther NVARCHAR(max);
    END
GO

if not  exists(select 1 from ERS_AuditReports where AuditReportStoredProcedure='damageScopeAdded')
     insert into ERS_AuditReports values ('Damage Scope Added', 'damageScopeAdded','R')
GO
EXEC dbo.DropIfExist 
    @ObjectName = 'damageScopeAdded', 
    @ObjectTypePrefix = 'S' 
GO
CREATE PROCEDURE [dbo].[damageScopeAdded]
	@UserId int
AS
BEGIN
DECLARE @FromDate as Date,
			@ToDate as Date,
			@TrustId as int,
			@HealthService as varchar(max),
			@OperatingHospitalList as varchar(100)
	SELECT	@FromDate = FromDate,
			@ToDate = ToDate, 
			@TrustId = TrustId,
			@OperatingHospitalList=OperatingHospitalList
	FROM	ERS_ReportFilter
	WHERE	UserID = @UserId

	 SELECT
	 Convert(varchar,ModifiedOn,106) AS 'Date of procedure',	 
	 (patient.Surname + ', '+ patient.Forename1) AS 'Patient Name',
	 STUFF((SELECT DISTINCT ',' + HospitalNumber from ERS_PatientTrusts WHERE PatientId = proce.PatientId and IsMinor = 0 for xml path('')), 1, 1, '')
	  AS 'Hospital Number',
	 (u1.Surname + ', '+ u1.Forename) AS 'Consultant',
	 (u1.Surname + ', '+ u1.Forename) AS 'Endoscopist 1',
	 (u2.Surname + ', '+ u2.Forename) AS 'Endoscopist 2',
	 ISNULL(r.RoomName, 'Unknown') AS 'Room',
	 (nur1.Title + ' ' + nur1.Forename+ ' ' +nur1.Surname) AS 'Nurse 1',
	 (nur2.Title + ' ' + nur2.Forename+ ' ' +nur2.Surname) AS 'Nurse 2',
	 (nur3.Title + ' ' + nur3.Forename+ ' ' +nur3.Surname) AS 'Nurse 3',
	 procType.ProcedureType AS 'Procedure',
	  --Convert(varchar,poc.ScopeCreatedDate,106) AS 'When was the scope damaged',
	 CASE  --1861
	 WHEN poc.ScopeDiscovered = 0 THEN 'Procedure room'  
	 WHEN poc.ScopeDiscovered = 1 THEN 'Decontamination unit'
	 ELSE '' 
	 END AS 'When was the scope damaged' ,
	 poc.ScopeDiscoveredOther AS 'Comments box',
	 Convert(varchar,poc.WhenUpdated,106) AS 'Date added to procedure',	 
	 (u.Surname + ', '+ u.Forename) AS 'Recorded By',
	 poc.OtherComments AS 'Comments' 	 
	 FROM  ERS_Procedures proce 
	 JOIN ERS_ProcedureTypes  procType ON proce.ProcedureType = procType.ProcedureTypeId
	 JOIN ERS_Users u1 ON proce.Endoscopist1 = u1.UserID
	 JOIN ERS_Users u2 ON proce.Endoscopist2 = u2.UserID
	 LEFT JOIN ERS_Users nur1 ON proce.Nurse1 = nur1.UserID
	 LEFT JOIN ERS_Users nur2 ON proce.Nurse2 = nur2.UserID
	 LEFT JOIN ERS_Users nur3 ON proce.Nurse3 = nur3.UserID
	 JOIN ERS_Patients patient ON patient.PatientId = proce.PatientId
	 LEFT JOIN ERS_PostOperativeComplications poc ON poc.ProcedureId= proce.ProcedureId
	 JOIN ERS_ReportConsultants reportCon ON reportCon.ConsultantID = u1.UserID
	 LEFT JOIN ERS_Users u ON u.UserID = poc.RecordedBy
	 LEFT JOIN ERS_ImagePort imgp on imgp.ImagePortId = proce.ImagePortId
	 LEFT JOIN ERS_SCH_Rooms r on r.RoomId = imgp.RoomId
	 WHERE 
	 proce.ProcedureCompleted = 1 AND 
	 ISNULL(DNA, 0) = 0 AND 
	 proce.IsActive= 1 AND 
	 cast(proce.CreatedOn as date) BETWEEN @FromDate AND @ToDate AND 
	 proce.OperatingHospitalID IN (SELECT * FROM dbo.splitString(@OperatingHospitalList,',') ) AND 
	 reportCon.UserID = @UserId
	 ORDER BY proce.CreatedOn
END
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	1861
------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rony
-- TFS#	3587
-- Description of change
-- Oesophagitis Auditing Report (Sandwell/Birmingham City) Ticket 9609 
------------------------------------------------------------------------------------------------------------------------
if not  exists(select 1 from ERS_AuditReports where AuditReportStoredProcedure='oesophagitisAuditingReport')
     insert into ERS_AuditReports values ('Oesophagitis Auditing Report', 'oesophagitisAuditingReport','R')
GO
EXEC dbo.DropIfExist 
    @ObjectName = 'oesophagitisAuditingReport', 
    @ObjectTypePrefix = 'S' 
GO
CREATE Procedure [dbo].[oesophagitisAuditingReport]
	@UserId int
AS
BEGIN
DECLARE @FromDate as Date,
			@ToDate as Date,
			@TrustId as int,
			@HealthService as varchar(max),
			@OperatingHospitalList as varchar(100)
	SELECT	@FromDate = FromDate,
			@ToDate = ToDate, 
			@TrustId = TrustId,
			@OperatingHospitalList=OperatingHospitalList
	FROM	ERS_ReportFilter
	WHERE	UserID = @UserId

	 SELECT
	 proce.ProcedureId,
	 (patient.Surname + ', '+ patient.Forename1) AS 'Patient Name',
	 dbo.fn_FormatHealthServiceNumber(patient.NHSNo, @HealthService)  AS 'NHS Number',
	 STUFF((SELECT DISTINCT ',' + HospitalNumber from ERS_PatientTrusts WHERE PatientId = proce.PatientId and IsMinor = 0 for xml path('')), 1, 1, '') AS 'Hospital Number',
	 convert(varchar, patient.DateOfBirth, 106) AS 'DOB',
	 (CONVERT(int,CONVERT(char(8),proce.CreatedOn,112))-CONVERT(char(8),patient.DateOfBirth,112))/10000 AS 'Age at procedure',
	 oh.HospitalName AS 'Operating Hospital',
	 dbo.fnGender(patient.GenderId) AS 'Sex',
	 ListCons.Surname + ', ' + ListCons.Forename AS 'List Consultant',
	 u1.Surname + ' ' + u1.Forename AS 'Endo 1',
	 ISNULL(u2.Surname + ' ' + u2.Forename, '') AS 'Endo 2',
	 procType.ProcedureType AS 'Procedure Type',
	 CONVERT(VARCHAR(30), proce.ModifiedOn, 100) AS 'Procedure Date and Time',
	 pr.PP_Indic AS 'Indications',
	 pr.PP_Diagnoses AS 'Diagnoses',
	 LA.LAGrade AS 'LA Grade',
	 OPST.TherapSummary AS 'Therapeutic treatment received'	 	 
	 FROM  ERS_Procedures proce 
	 JOIN ERS_ProcedureTypes  procType ON proce.ProcedureType = procType.ProcedureTypeId
	 JOIN ERS_Patients patient ON patient.PatientId = proce.PatientId
	 JOIN ERS_Users u1 ON u1.UserID = proce.Endoscopist1 
	 LEFT JOIN ERS_Users u2 ON u2.UserID = proce.Endoscopist2
	 JOIN ERS_OperatingHospitals oh on proce.OperatingHospitalID = oh.OperatingHospitalId
	 JOIN ERS_ReportConsultants reportCon ON reportCon.ConsultantID = u1.UserID
	 JOIN ERS_Users ListCons ON proce.ListConsultant = ListCons.UserID
	 JOIN ERS_ProceduresReporting pr on proce.ProcedureId = pr.ProcedureId 			
	 LEFT OUTER JOIN
        (
            SELECT DISTINCT
                   UT.ProcedureId,
                   STUFF(
                   (
                       SELECT
                           ', ' + REPLACE(REPLACE(Summary, 'Stent insertion', R.Region), '<br />', ' - ')
                       FROM
                           dbo.ERS_UpperGITherapeutics UGIT 
                           INNER JOIN dbo.ERS_Sites S 
                               ON UGIT.SiteId = S.SiteId
                           INNER JOIN dbo.ERS_Regions R 
                               ON S.RegionId = R.RegionId
                       WHERE
                           1 = 1
                           AND S.ProcedureId = UT.ProcedureId
                       FOR XML PATH('')
                   ),
                   1,
                   1,
                   ''
                        ) AS TherapSummary
            FROM
                dbo.ERS_Sites UT
        ) OPST
            ON OPST.ProcedureId = proce.ProcedureId	
		LEFT OUTER JOIN(
			SELECT DISTINCT
				UT.ProcedureId,
				STUFF(
				(
					SELECT
					', ' +  CASE WHEN UGIAO.LAClassification = 1 THEN 'Grade A: Mucosal breaks confined to the mucosal fold each no longer than 5mm.' 
						WHEN UGIAO.LAClassification = 2 THEN 'Grade B: At least one mucosal break longer than 5mm confined to the mucosal fold but not continuous between two folds.'
						WHEN UGIAO.LAClassification = 3 THEN 'Grade C: Mucosal breaks that are continuous between the tops of mucosal folds but not circumferential.'
						WHEN UGIAO.LAClassification = 4 THEN 'Grade D: Extensive mucosal breaks engaging at least 75% of the oesophageal circumference.'
						ELSE '' END
					FROM
						dbo.ERS_UpperGIAbnoOesophagitis UGIAO 
						INNER JOIN dbo.ERS_Sites S 
							ON UGIAO.SiteId = S.SiteId
					WHERE
						1 = 1
						AND S.ProcedureId = UT.ProcedureId
					FOR XML PATH('')
				),
				1,
				1,
				''
					) AS LAGrade
		FROM dbo.ERS_Sites UT
		)LA ON LA.ProcedureId = proce.ProcedureId
	 
	 WHERE proce.ProcedureCompleted = 1 
	 AND ISNULL(DNA, 0) = 0 
	 AND proce.IsActive= 1 
	 AND cast(proce.CreatedOn as date) BETWEEN @FromDate AND @ToDate 
	 AND proce.OperatingHospitalID IN (SELECT * FROM dbo.splitString(@OperatingHospitalList,',') ) 
	 AND reportCon.UserID = @UserId
	 ORDER BY proce.CreatedOn
END
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	3587
------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rony
-- TFS#	4303
-- Description of change
-- Report : Main Endoscopist PEG (No Data returned)
------------------------------------------------------------------------------------------------------------------------
EXEC dbo.DropIfExist 
    @ObjectName = 'report_JAGPEGEndo1', 
    @ObjectTypePrefix = 'S' 
GO
CREATE PROCEDURE [dbo].[report_JAGPEGEndo1] 
	@UserID INT
AS
BEGIN

	SELECT DISTINCT PR.ProcedureId as ProcId, PC.ProcedureId, RC.ConsultantId ReportConsultant,eug.EndoRole, CorrectPEGPlacement
	INTO #Procedures
	FROM fw_ProceduresConsultants PC
	INNER JOIN dbo.ERS_Procedures PR ON PC.ProcedureId = 'E.' + convert(varchar(10), PR.ProcedureId)
	INNER JOIN dbo.ERS_Sites es ON PR.ProcedureId = es.ProcedureId
	INNER JOIN dbo.ERS_UpperGITherapeutics eug ON es.SiteId = eug.SiteId
	--INNER JOIN dbo.ERS_UpperGIIndications eugi ON es.ProcedureId = eugi.ProcedureId --Added by rony tfs-4303
	INNER JOIN dbo.fw_ReportConsultants RC ON PC.ConsultantId = RC.ConsultantId,
	dbo.fw_ReportFilter RF
	WHERE RF.UserId = RC.UserId 
	AND PR.CreatedOn >= RF.FromDate AND PR.CreatedOn <= RF.ToDate 
	AND PC.ConsultantTypeId IN (1)
	--AND RF.UserId = @UserID --Added by rony tfs-4303
	AND (RC.ConsultantId = 'E.' + convert(varchar(10), PR.Endoscopist1))
	
	--AND ((RC.ConsultantId = 'E.' + convert(varchar(10), PR.Endoscopist1) AND Endo1Role = 2 AND eug.EndoRole = 1) /*trainer did it alone*/
	--	OR   (eug.EndoRole IN (2,3)) /*2 = trainer observed, 3 = trainer assisted*/
	--	OR   (Endo1Role = 1 AND eug.EndoRole IN (1,4) /*2 independant endos*/))
	--AND (eug.GastrostomyInsertion = 1 AND eugi.NasoDuodenalTube = 0)  --Added by rony tfs-4303
	AND (eug.GastrostomyInsertion = 1 ) 
	AND (PR.ProcedureCompleted=1 AND PR.IsActive=1)
		--MH added on 31 Mar 2022
		and IsNull(PR.DNA,0) = 0
	AND PR.OperatingHospitalID IN (SELECT * FROM dbo.splitString(RF.OperatingHospitalList,',') )

	SELECT * 
	FROM
	(
		SELECT DISTINCT C.ConsultantName AS 'Endoscopist name'

			, (SELECT COUNT(DISTINCT ProcedureId) 
			   FROM #Procedures PR WHERE RC.ConsultantId = PR.ReportConsultant
			   ) AS [TotalPEGProcedures]

			, convert(varchar, convert(int, round(((SELECT COUNT(DISTINCT PR.ProcedureId) 
				FROM #Procedures PR 
				WHERE Pr.CorrectPEGPlacement = 1 AND RC.ConsultantId = PR.ReportConsultant
			  ) * 1.0 /NULLIF(
			  (SELECT COUNT(DISTINCT ProcedureId) FROM #Procedures WHERE RC.ConsultantId = ReportConsultant
			  ) ,0)) * 100, 0))) + '%' AS SatisfactoryPlacementOfPEGP
			
			, convert(varchar, convert(int, round(((SELECT COUNT(DISTINCT PR.ProcedureId) 
				FROM #Procedures PR 
				JOIN ERS_PostOperativeComplications POC ON PR.ProcId = POC.ProcedureId
				WHERE PR.ReportConsultant = RC.ConsultantId
				AND POC.AntibioticsForInfectionFollowingPEG = 1
				) * 1.0 / NULLIF(
				(SELECT COUNT(DISTINCT ProcedureId) 
				FROM  #Procedures WHERE ReportConsultant = RC.ConsultantId
				), 0)) * 100, 0))) + '%' AS PostProcedureInfectionRequiringAntibioticsP
			
			, convert(varchar, convert(int, round(((SELECT COUNT(DISTINCT PR.ProcedureId) 
				FROM #Procedures PR 
				JOIN ERS_PostOperativeComplications POC ON PR.ProcId = POC.ProcedureId
				WHERE PR.ReportConsultant = RC.ConsultantId
				AND POC.PeritonitisFollowingPEG = 1
				) * 1.0 / NULLIF(
				(SELECT COUNT(DISTINCT ProcedureId) 
				FROM #Procedures WHERE ReportConsultant = RC.ConsultantId
				), 0)) * 100, 0))) + '%' AS PostProcedurePeritonitisP

			, convert(varchar, convert(int, round(((SELECT COUNT(DISTINCT PR.ProcedureId) 
				FROM #Procedures PR 
				JOIN dbo.ERS_UpperGIQA eug	ON PR.ProcId = eug.ProcedureId
				WHERE PR.ReportConsultant = RC.ConsultantId
				AND eug.SignificantHaemorrhage = 1
				) * 1.0 / NULLIF(
				(SELECT COUNT(DISTINCT ProcedureId) 
				FROM #Procedures WHERE ReportConsultant = RC.ConsultantId
				), 0)) * 100, 0))) + '%' AS BleedingRequiringTransfusionP

		FROM  fw_ReportConsultants RC, fw_Consultants C, fw_ReportFilter RF, fw_ProceduresConsultants PC
		WHERE RF.UserId = RC.UserId 
			AND RF.UserId = @UserId
			AND RC.ConsultantId = PC.ConsultantId
			AND PC.ConsultantId = C.ConsultantId
			AND PC.ConsultantTypeId IN (1)
	) AS T
	WHERE TotalPEGProcedures > 0

	DROP TABLE #Procedures
END
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	4303
------------------------------------------------------------------------------------------------------------------------


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ferdowsi 7/9/2024
-- TFS#	4229
-- Description of change
-- Phrases retrived  in alphabetical order
 ------------------------------------------------------------------------------------------------------------------------
GO
EXEC dbo.DropIfExist 
    @ObjectName = 'GetFilteredPhrases', 
    @ObjectTypePrefix = 'S' 
GO
CREATE PROCEDURE [dbo].[GetFilteredPhrases]
    @OperatingHospitalId INT,
    @ProcedureTypeIds VARCHAR(MAX) = NULL,
    @PhraseCategory VARCHAR(50) = NULL,
    @PhraseText NVARCHAR(MAX) = NULL,
	@UserName NVARCHAR(MAX) = NULL
AS
BEGIN
    SET NOCOUNT ON;
	DECLARE @subQuery NVARCHAR(MAX)
    DECLARE @subQueryForGeneral NVARCHAR(MAX)
	DECLARE @subQueryForPersonal NVARCHAR(MAX)
    DECLARE @query NVARCHAR(MAX)
   IF @UserName <> ''
	BEGIN 
	   SET @subQuery = 'LEFT JOIN [ERS_Users] u ON p.UserID = u.UserID WHERE u.Username = @UserName'
	END
	ELSE
	BEGIN
	 SET @subQuery ='WHERE UserID = 0'
	 END
    
    SET @query = 'SELECT p.Phrase, p.PhraseID FROM [ERS_PhraseLibrary] p '+ @subQuery +' AND OperatingHospitalId = @OperatingHospitalId'

    IF @ProcedureTypeIds IS NOT NULL
    BEGIN
        SET @query = @query + ' AND ProcedureTypeId IN (' + @ProcedureTypeIds + ')'
    END

    IF @PhraseCategory IS NOT NULL
    BEGIN
        SET @query = @query + ' AND PhraseCategory = @PhraseCategory'
    END

    IF @PhraseText IS NOT NULL AND @PhraseText <> ''
    BEGIN
       SET @query = @query + ' AND Phrase LIKE ''%' + @PhraseText + '%'' '
    END
	SET @query = @query + ' order by p.[Phrase] ASC'
    EXEC sp_executesql @query, N'@OperatingHospitalId INT, @PhraseCategory VARCHAR(50), @PhraseText NVARCHAR(MAX),@UserName NVARCHAR(MAX)', @OperatingHospitalId, @PhraseCategory, @PhraseText, @UserName
END
 
GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS# 	4229
--  
------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rony
-- TFS#	4342
-- Description of change
-- Cyctoscpy - injection therapy
------------------------------------------------------------------------------------------------------------------------
 IF NOT EXISTS (
        SELECT 1
        FROM INFORMATION_SCHEMA.COLUMNS
        WHERE TABLE_NAME = 'ERS_CystoscopyTherapeutics' AND
              COLUMN_NAME IN ('Injection','InjectionType', 'InjectionVolume','InjectionNumber')
    )
    BEGIN
		
		ALTER TABLE ERS_CystoscopyTherapeutics
            ADD Injection BIT,
			 InjectionType INT,
             InjectionVolume INT,
			 InjectionNumber INT;
    END
GO
EXEC dbo.DropIfExist 
    @ObjectName = 'Therapeutic_cystoscopy_select', 
    @ObjectTypePrefix = 'S' 
GO
CREATE PROCEDURE [dbo].[Therapeutic_cystoscopy_select]
(
	@SiteId INT	
)
AS

SET NOCOUNT ON


SELECT 
	sp.SiteId,
	[None],
	Diathermy,
	DiathermyWatts,
	DiathermyPulses,
	DiathermySecs,
	DiathermyKJ,
	Laser,
	LaserWatts,
	LaserPulses,
	LaserSecs,
	LaserKJ,
	Injection, --Added by rony tfs-4342
	InjectionType,
	InjectionVolume,
	InjectionNumber
FROM 
	[ERS_CystoscopyTherapeutics] sp
JOIN
	ERS_Sites s ON sp.SiteId = s.SiteId
JOIN
	ERS_Procedures p ON s.ProcedureId = p.ProcedureId
WHERE 
	sp.SiteId = @SiteId
GO

EXEC dbo.DropIfExist 
    @ObjectName = 'Therapeutic_cystoscopy_save', 
    @ObjectTypePrefix = 'S' 
GO
CREATE PROCEDURE [dbo].[Therapeutic_cystoscopy_save]
(
	@SiteId INT,
	@None BIT,
	@Diathermy BIT,
	@DiathermyWatts Int,
	@DiathermyPulses Int,
	@DiathermySecs decimal,
	@DiathermyKJ Int,
	@Laser BIT,
	@LaserWatts Int,
	@LaserPulses Int,
	@LaserSecs decimal,
	@LaserKJ Int,
	@Injection BIT, --Added by rony tfs-4342
	@InjectionType Int,
	@InjectionVolume Int,
	@InjectionNumber Int,
	@LoggedInUserId INT

)
AS

SET NOCOUNT ON

DECLARE @proc_id INT
DECLARE @proc_type INT

BEGIN TRANSACTION

BEGIN TRY
	SELECT 
		@proc_id = p.ProcedureId,
		@proc_type = p.ProcedureType
	FROM 
		ERS_Sites s
	JOIN 
		ERS_Procedures p ON s.ProcedureId = p.ProcedureId
	WHERE 
		SiteId = @SiteId

	IF NOT EXISTS (SELECT 1 FROM ERS_CystoscopyTherapeutics WHERE SiteId = @SiteId)
	BEGIN
		
		INSERT INTO ERS_CystoscopyTherapeutics (
			SiteId,
			[None],
			Diathermy,
			DiathermyWatts,
			DiathermyPulses,
			DiathermySecs,
			DiathermyKJ,
			Laser,
			LaserWatts,
			LaserPulses,
			LaserSecs,
			LaserKJ,	
			WhoCreatedId,
			WhenCreated,
			Injection,--Added by rony tfs-4342
			InjectionType,
			InjectionVolume,
			InjectionNumber)
		VALUES (
			@SiteId,
			@None,
			@Diathermy,
			@DiathermyWatts,
			@DiathermyPulses,
			@DiathermySecs,
			@DiathermyKJ,
			@Laser ,
			@LaserWatts,
			@LaserPulses,
			@LaserSecs,
			@LaserKJ,
			@LoggedInUserId,
			GETDATE(),
			@Injection,--Added by rony tfs-4342
			@InjectionType,
			@InjectionVolume,
			@InjectionNumber)

		INSERT INTO ERS_RecordCount (
			[ProcedureId],
			[SiteId],
			[Identifier],
			[RecordCount]
		)
		VALUES (
			@proc_id,
			@SiteId,
			'Therapeutic procedures',
			1)
	END

	ELSE IF (@None = 0 AND @Diathermy = 0 AND @DiathermyWatts = 0 AND @DiathermyPulses = 0 AND @DiathermySecs = 0 AND @DiathermyKJ = 0 
	      AND @Laser = 0 AND @LaserWatts = 0 AND @LaserPulses = 0 AND @LaserSecs = 0 AND @LaserKJ = 0 AND @Injection = 0 AND @InjectionType = 0 AND @InjectionVolume = 0 AND @InjectionNumber = 0)--Added by rony tfs-4342
	BEGIN

		DELETE FROM ERS_CystoscopyTherapeutics
		WHERE SiteId = @SiteId

		DELETE FROM ERS_RecordCount 
		WHERE SiteId = @SiteId
		AND Identifier = 'Therapeutic Taken'
	END
	
	ELSE
	BEGIN
		
		UPDATE 
			ERS_CystoscopyTherapeutics
		SET 
			[None] = @None,
			Diathermy=@Diathermy,
			DiathermyWatts =@DiathermyWatts,
			DiathermyPulses =@DiathermyPulses,
			DiathermySecs =@DiathermySecs ,
			DiathermyKJ =@DiathermyKJ,
			Laser =@Laser,
			LaserWatts =@LaserWatts,
			LaserPulses =@LaserPulses,
			LaserSecs =@LaserSecs,
			LaserKJ =@LaserKJ,	
			WhoUpdatedId = @LoggedInUserId,
			WhenUpdated = GETDATE(),
			Injection = @Injection, --Added by rony tfs-4342
			InjectionType = @InjectionType,
			InjectionVolume = @InjectionVolume,
			InjectionNumber = @InjectionNumber
		WHERE 
			SiteId = @SiteId
	END

	--- same as bladder ... disable the trigeers and bring trigger's code here ( start ) --by mostafiz 

	EXEC Therapeutic_cystoscopy_summary_update @SiteId
	EXEC sites_summary_update @SiteId

	--- same as bladder ... disable the trigeers and trigger's their code here ( end ) 

END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;

--------------- Cystoscopy Therapeutics ------------

--------------- Cystoscopy Urethra ------------
GO
EXEC dbo.DropIfExist 
    @ObjectName = 'Therapeutic_cystoscopy_summary_update', 
    @ObjectTypePrefix = 'S' 
GO
CREATE PROCEDURE [dbo].[Therapeutic_cystoscopy_summary_update]
(
	@SiteId INT
)
AS
	SET NOCOUNT ON
	DECLARE   @msg varchar(1000)
			, @msg2 varchar(1000)
			, @Details varchar(1000)
			, @Summary varchar(4000)=''
			, @Area varchar(500)=''
			, @br VARCHAR(6) = '<br />';

	DECLARE 
		@None bit,
		@YAGLaser bit,
		@YAGLaserWatts int,
		@YAGLaserPulses int,
		@YAGLaserSecs decimal(8,2),
		@YAGLaserKJ decimal(8,2),
		@Diathermy bit,
		@DiathermyWatts int,
		@DiathermyPulses int,
		@DiathermySecs decimal(8,2),
		@DiathermyKJ decimal(8,2), 
		@Injection BIT, --Added by rony tfs-4342
		@InjectionType INT,
		@InjectionVolume INT,
		@InjectionNumber INT

		SELECT
				@None = [None],
				@YAGLaser = Laser,
				@YAGLaserWatts = LaserWatts,
				@YAGLaserPulses	= LaserPulses,
				@YAGLaserSecs = LaserSecs,
				@YAGLaserKJ	= LaserKJ,
				@Diathermy = Diathermy,
				@DiathermyWatts	= DiathermyWatts,
				@DiathermyPulses = DiathermyPulses,
				@DiathermySecs = DiathermySecs,
				@DiathermyKJ = DiathermyKJ,
				@Injection = Injection, --Added by rony tfs-4342
				@InjectionType = InjectionType,
				@InjectionVolume = InjectionVolume,
				@InjectionNumber = InjectionNumber
		FROM ERS_CystoscopyTherapeutics
		WHERE SiteId = @SiteId

IF @None = 1
		SET @summary = @summary + 'No therapeutic procedures'
	ELSE
	BEGIN
		IF @YAGLaser = 1
			BEGIN
			SET @msg =' Laser'
			SET @Details = ''
			IF @YAGLaserWatts > 0 SET @Details = @Details + ' ' + CAST(@YAGLaserWatts as varchar(50)) + 'W'
			IF @YAGLaserSecs > 0 SET @Details = @Details + ' for ' + cast(CAST(@YAGLaserSecs AS FLOAT) as varchar(50)) + CASE WHEN @YAGLaserSecs <= 1 THEN ' second' else ' seconds' END
			IF @YAGLaserPulses > 0 SET @Details = @Details + ' in ' + cast(@YAGLaserPulses as varchar(50)) + CASE WHEN @YAGLaserPulses <= 1 THEN ' pulse' else ' pulses' END
			IF @YAGLaserKJ > 0 SET @Details = @Details + ' ('+ cast(CAST(@YAGLaserKJ AS FLOAT) as varchar(50)) + 'kJ)'
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + @br
			END

		IF @Diathermy = 1
				BEGIN
					SET @msg = ' Diathermy'
					SET @Details = ''
					--Add full stop 
					SET @msg = RTrim(LTRIM(@msg))
					IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg 
				--------------  
				IF @DiathermyWatts > 0 SET @Details = @Details + ' ' + cast(@DiathermyWatts as varchar(50)) + 'W'
				IF @DiathermySecs > 0 SET @Details = @Details + ' for ' + cast(CAST(@DiathermySecs AS FLOAT) as varchar(50)) + CASE WHEN @DiathermySecs <= 1 THEN ' second' else ' seconds' END
				IF @DiathermyPulses > 0 SET @Details = @Details + ' in ' + cast(@DiathermyPulses as varchar(50)) + CASE WHEN @DiathermyPulses <= 1 THEN ' pulse' else ' pulses' END
				IF @DiathermyKJ > 0 SET @Details = @Details + ' ('+ cast(CAST(@DiathermyKJ AS FLOAT) as varchar(50)) + 'kJ)'
				IF @Details<>'' SET @msg = @msg + ': ' + @Details

				SET @summary = @summary + @msg + @br  
				END  
		IF @Injection= 1 --Added by rony tfs-4342
			BEGIN
			SET @msg =' Injection therapy'
			SET @Details = ''
			IF @InjectionVolume > 0 SET @Details = @Details + '  ' + cast(@InjectionVolume as varchar(50)) + 'ml'
			IF @InjectionVolume > 0  AND @InjectionType > 0 SET @Details = @Details + ' of'
			IF @InjectionType > 0 SET @Details = @Details + ' ' +   (SELECT [ListItemText] FROM dbo.ERS_Lists WHERE ListDescription = 'Agent Upper GI' AND [ListItemNo] = @InjectionType)
			IF @InjectionVolume> 0  AND @InjectionNumber > 0 SET @Details = @Details + ' via'
			IF @InjectionNumber >0 SET @Details = @Details + ' ' + CASE WHEN @InjectionNumber > 1 THEN cast(@InjectionNumber as varchar(50)) + ' injections' ELSE cast(@InjectionNumber as varchar(50)) + ' injection' END
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
END

-- Finally, update the summary in Therapeutics  table
	UPDATE dbo.ERS_CystoscopyTherapeutics 
	SET Summary=@summary 
	WHERE SiteId = @SiteId
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	4342
------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rony
-- TFS#	3761
-- Description of change
-- ID the Trainee / trainer on the extent section
------------------------------------------------------------------------------------------------------------------------
EXEC dbo.DropIfExist 
    @ObjectName = 'procedure_endoscopists_select', 
    @ObjectTypePrefix = 'S' 
GO
CREATE PROCEDURE [dbo].[procedure_endoscopists_select]
(
	@ProcedureId int
)
AS
BEGIN
	SELECT 
	e.EndoscopistId, ISNULL(Title + ' ', '') + ISNULL(Forename + ' ', '') + ISNULL(Surname, '') as EndoscopistName,
	CASE WHEN p.ListType IN(2,3) AND ROW_NUMBER() OVER(ORDER BY e.EndoscopistId) = 1 THEN 
	'('+(SELECT ListItemText FROM ers_lists WHERE ListDescription='Endoscopist1 Role' AND EndoscopistRole=ListItemNo) + ')'
	WHEN p.ListType IN(2,3) AND ROW_NUMBER() OVER(ORDER BY e.EndoscopistId) = 2 THEN 
	'('+(SELECT ListItemText FROM ers_lists WHERE ListDescription='Endoscopist2 Role' AND EndoscopistRole=ListItemNo) + ')'
	END AS TraineeTrainer --Added by rony tfs-3761
	FROM ERS_VW_ProceduresEndoscopists e
	INNER JOIN ERS_Users u on u.UserId = e.EndoscopistId
	INNER JOIN ERS_Procedures p on p.ProcedureId=@ProcedureId
	WHERE e.ProcedureId = @ProcedureId
END
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	3761
------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rony
-- TFS#	3759
-- Description of change
-- Complication - Pancreatitis
------------------------------------------------------------------------------------------------------------------------

DELETE FROM ERS_AdverseEventsProcedureTypes WHERE AdverseEventsId in (SELECT UniqueId FROM ERS_AdverseEvents WHERE Description ='Pancreatitis') AND ProcedureTypeId NOT IN(2,6,7)

GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	3759
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	MOSTAFIZUR RAHMAN
-- TFS#	4039
-- Description of change
-- Abnormalities not found in the Cystoscopy procedure
------------------------------------------------------------------------------------------------------------------------

GO

IF NOT EXISTS (SELECT 1 FROM ERS_AbnormalitiesMatrixCystoscopy WHERE Region = 'Urethra')
BEGIN
    Insert INTO ERS_AbnormalitiesMatrixCystoscopy (ProcedureType, Region, Bladder, Prostate, Urethra, Site, Area, WhoUpdatedId, WhoCreatedId, WhenCreated, WhenUpdated)
	                                       VALUES ((SELECT ProcedureTypeId FROM ERS_ProcedureTypes WHERE ProcedureType='Cystoscopy'), 'Urethra', 0, 0, 1, 0, 'AA', NULL, 0, GETDATE(), NULL);
END

GO


------------------------------------------------------------------------------------------------------------------------
-- TFS#	4039 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	MOSTAFIZUR RAHMAN
-- TFS#	4323
-- Description of change
-- add to adverse events for Bronch and EBUS procedure 
------------------------------------------------------------------------------------------------------------------------
Go
DECLARE @AdverseEventsType VARCHAR(50) = 'Significant desaturation,Laryngospasm,Bronchospasm';
DECLARE @ChildDesc VARCHAR(50); 
DECLARE comCursor CURSOR FOR
SELECT Item FROM fnSplitString(@AdverseEventsType, ',');

OPEN comCursor;

FETCH NEXT FROM comCursor INTO @ChildDesc;

WHILE @@FETCH_STATUS = 0
BEGIN
    IF NOT EXISTS (SELECT 1 FROM ERS_AdverseEvents WHERE Description = @ChildDesc)
    BEGIN
        INSERT INTO ERS_AdverseEvents (Description, NEDTerm, ListOrderBy, ParentId, AdditionalInfo, Suppressed, WhoCreatedId, WhenCreated, WhoUpdatedId, WhenUpdated, Complication)
        SELECT @ChildDesc, @ChildDesc, NULL, 0, 0, 0, NULL, NULL, NULL, NULL, 0;

		INSERT INTO ERS_AdverseEventsProcedureTypes (AdverseEventsId, ProcedureTypeId)
		SELECT SCOPE_IDENTITY(), ProcedureTypeId 
		FROM ERS_ProcedureTypes
		WHERE ProcedureType IN ('Bronchoscopy', 'EBUS');

    END

    FETCH NEXT FROM comCursor INTO @ChildDesc;
END

CLOSE comCursor;
DEALLOCATE comCursor;

Go

------------------------------------------------------------------------------------------------------------------------
-- TFS#	4323 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	MOSTAFIZUR RAHMAN
-- TFS#	4322 
-- Description of change
-- Adverse events - Pneumothorax add drop down
-- TFS#	4321
-- Description of change
-- Adverse event - Bleeding add drop down
------------------------------------------------------------------------------------------------------------------------

Go
DECLARE @AdverseEventsType VARCHAR(50) = 'No intervention,Drainage';
DECLARE @ParentId int = ISNULL((SELECT UniqueId from ERS_AdverseEvents where Description= 'Pneumothorax'),0);
DECLARE @ChildDesc VARCHAR(50); 
DECLARE comCursor CURSOR FOR
SELECT Item FROM fnSplitString(@AdverseEventsType, ',');

OPEN comCursor;

FETCH NEXT FROM comCursor INTO @ChildDesc;

WHILE @@FETCH_STATUS = 0
BEGIN
    IF NOT EXISTS (SELECT 1 FROM ERS_AdverseEvents WHERE Description = @ChildDesc) and @ParentId>0
    BEGIN
        INSERT INTO ERS_AdverseEvents (Description, NEDTerm, ListOrderBy, ParentId, AdditionalInfo, Suppressed, WhoCreatedId, WhenCreated, WhoUpdatedId, WhenUpdated, Complication)
        SELECT @ChildDesc, ('Pneumothorax '+LOWER(@ChildDesc)), NULL, @ParentId, 0, 0, NULL, NULL, NULL, NULL, 0;

		INSERT INTO ERS_AdverseEventsProcedureTypes (AdverseEventsId, ProcedureTypeId)
		SELECT SCOPE_IDENTITY(), ProcedureTypeId 
		FROM ERS_ProcedureTypes
		WHERE ProcedureTypeId IN (
			SELECT ProcedureTypeId 
			FROM ERS_AdverseEventsProcedureTypes 
			WHERE AdverseEventsId = @ParentId
		);


    END

    FETCH NEXT FROM comCursor INTO @ChildDesc;
END

CLOSE comCursor;
DEALLOCATE comCursor;

Go

EXEC dbo.DropIfExist 
    @ObjectName = 'ProcedureAdverseEventsSummary', 
    @ObjectTypePrefix = 'F' 
GO

CREATE FUNCTION [dbo].[ProcedureAdverseEventsSummary]
(
	@ProcedureId int
)
RETURNS varchar(max)
AS
BEGIN


DECLARE @AdverseEventsString  varchar(max), @ComplicationsString varchar(max),
		@RetVal varchar(max)

SELECT @AdverseEventsString =
    LTRIM(STUFF((
        SELECT ', ' + 
        CASE 
            WHEN i.AdditionalInfo = 0 THEN  LOWER([Description])  
            WHEN i.[Description] = 'Other Bleeding Text' THEN 'bleeding - ' + LOWER(AdditionalInformation)
            ELSE LOWER(AdditionalInformation)
        END 
        + CASE 
            WHEN ISNULL(ChildAdverseEventId, 0) > 0 THEN ' ' + 
                (SELECT 
                    CASE 
                        WHEN i2.AdditionalInfo = 1 
                            THEN 
                                CASE 
                                    WHEN i2.[Description] = 'Other Bleeding Text' THEN 'bleeding - ' + LOWER(epi.AdditionalInformation)
                                    ELSE [Description] + ': ' + epi.AdditionalInformation 
                                END
                        ELSE CASE WHEN i.NEDTerm='Bleeding' THEN  LOWER('- '+[Description]) ELSE LOWER([Description]) END 
                    END
                 FROM ERS_AdverseEvents i2 
                 WHERE UniqueId = epi.ChildAdverseEventId 
                 AND NEDTerm != 'Other bleeding')
            ELSE ''
        END AS [text()]
        FROM ERS_ProcedureAdverseEvents epi
        INNER JOIN ERS_AdverseEvents i ON i.UniqueId = epi.AdverseEventId
        WHERE ProcedureId = @ProcedureId
        ORDER BY ISNULL(i.ListOrderBy, 0)
        FOR XML PATH('')
    ), 1, 1, ''))


SELECT @AdverseEventsString = dbo.fnCapitalise(@AdverseEventsString)

IF LEN(@AdverseEventsString) > 0
BEGIN
	IF CHARINDEX(',', REVERSE(@AdverseEventsString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />','') + 'Adverse events: ' + STUFF(@AdverseEventsString, LEN(@AdverseEventsString) - CHARINDEX(' ,', REVERSE(@AdverseEventsString)), 1, ' and ') --4321
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />','') + 'Adverse events: ' + @AdverseEventsString
END
---------------------Complications


--SELECT @ComplicationsString =
--	LTRIM(STUFF((SELECT ', ' + CASE WHEN i.AdditionalInfo = 0 THEN LOWER([Description]) ELSE LOWER(AdditionalInformation) END + CASE WHEN ISNULL(ChildAdverseEventId, 0) > 0 THEN '-' + (SELECT [Description] FROM ERS_AdverseEvents WHERE UniqueId = epi.ChildAdverseEventId) ELSE '' END AS [text()] 
--	FROM ERS_ProcedureAdverseEvents epi 
--	INNER JOIN ERS_AdverseEvents i on i.UniqueId = epi.AdverseEventId
--	WHERE ISNULL(i.Complication,0) = 1 AND ProcedureId=@ProcedureId
--	ORDER BY ISNULL(i.ListOrderBy, 0)
--	FOR XML PATH('')),1,1,''))

--SELECT @ComplicationsString = dbo.fnCapitalise(@ComplicationsString) 

--IF LEN(@ComplicationsString) > 0 
--BEGIN
--	IF charindex(',', reverse(@ComplicationsString)) > 0
--		SELECT @RetVal = ISNULL(@RetVal + '<br />','') + 'Complications: ' + STUFF(@ComplicationsString, len(@ComplicationsString) - charindex(' ,', reverse(@ComplicationsString)), 2, ' and ')
--	ELSE
--		SELECT @RetVal = ISNULL(@RetVal + '<br />','') + 'Complications: ' + @ComplicationsString
--END


RETURN @RetVal
END
Go

------------------------------------------------------------------------------------------------------------------------
-- TFS#	4322 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by : Siddik
-- TFS# 3242
-- Description of change: Printed procedure's record is not found in the ERS_OCS_Process table for Cystoscopy procedure
-------------------------------------------------------------------------------------------------------------------------

UPDATE ERS_ProcedureTypes SET CanExportDocument = 1 WHERE ProcedureType = 'Cystoscopy' AND CanExportDocument <> 1
GO

------------------------------------------------------------------------------------------------------------------------
-- TFS# 3242 END
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rezaul
-- TFS#	No TFS - Item 2515
-- Description of change
-- Options from the 'Specimens taken'  not showing in the report
------------------------------------------------------------------------------------------------------------------------
GO
EXEC dbo.DropIfExist @ObjectName = 'specimens_ogd_summary_update',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[specimens_ogd_summary_update]
(
	@SiteId INT
)
/*
	Update History		:		
						:	09 Feb 2024		MH	added Biopsy sites details for Specimens taken
*/
AS
	SET NOCOUNT ON

	DECLARE 
		@summary VARCHAR (8000),
		@tempsummary VARCHAR(1000),
		@RegionId INT,
		@None BIT,
		@BrushCytology BIT,
		@Biopsy BIT,
		@BiopsiesTakenAtRandom BIT,
		@BiopsiesTakenAtSites BIT,
		@BiopsyQtyHistology INT,
		@BiopsyQtyMicrobiology INT,
		@BiopsyQtyVirology INT,
		@BiopsyDistance DECIMAL(6,2),
		@ForcepType SMALLINT,
		@ForcepSerialNo NVARCHAR(50),
		--@ForcepSerialNoDesc VARCHAR(100),
		@Urease BIT,
		@UreaseResult TINYINT,
		@Polypectomy BIT,
		@PolypectomyQty INT,
		@HotBiopsy BIT,
		@NeedleAspirate BIT,	
		@NeedleAspirateHistology BIT,
		@NeedleAspirateMicrobiology BIT, 
		@NeedleAspirateVirology BIT,
		@GastricWashing BIT,
		@Bile_PanJuice BIT,
		@Bile_PanJuiceCytology BIT,
		@Bile_PanJuiceBacteriology BIT,
		@Bile_PanJuiceAnalysis BIT,
		@EUSFNANumberOfPasses INT,
		@EUSFNANeedleGauge INT,
		@FNB BIT,
		@EUSFNBNumberOfPasses INT,
		@EUSFNBNeedleGauge INT,
		@BrushBiopsy BIT,
		@TumourMarkers BIT,
		@AmylaseLipase BIT,
		@CytologyHistology BIT,
		@FullStop VARCHAR(5) = '. ',
		@FNAAssessedAtProc BIT,
		@FNBAssessedAtProc BIT,
		@AdequateFNA BIT,
		@AdequateFNB BIt,
		@NeedleBiopsyHistology BIT,
		@NeedleBiopsyCytology BIT,	
		@NeedleBiopsyMicrobiology BIT,
		@NeedleBiopsyVirology BIT
		,@SpecimensBiopsySitesDetails varchar(max)

	SELECT 
		@summary = '',
		@RegionId = s.RegionId,
		@None=[None],
		@BrushCytology=BrushCytology,
		@Biopsy=Biopsy,
		@BiopsiesTakenAtRandom=BiopsiesTakenAtRandom,
		@BiopsiesTakenAtSites=BiopsiesTakenAtSites,
		@BiopsyQtyHistology=BiopsyQtyHistology,
		@BiopsyQtyMicrobiology=BiopsyQtyMicrobiology,
		@BiopsyQtyVirology=BiopsyQtyVirology,
		@BiopsyDistance=BiopsyDistance,
		@ForcepType = p.ForcepType,
		@ForcepSerialNo = (SELECT isnull(p.ForcepSerialNo, '') as [text()] FOR XML PATH('')),
		--@ForcepSerialNoDesc = l.[ListItemText],
		@Urease=Urease,
		@UreaseResult=UreaseResult,
		@Polypectomy=Polypectomy,
		@PolypectomyQty=PolypectomyQty,
		@HotBiopsy=HotBiopsy,
		@NeedleAspirate=NeedleAspirate,
		@NeedleAspirateHistology=NeedleAspirateHistology,
		@NeedleAspirateMicrobiology=NeedleAspirateMicrobiology,
		@NeedleAspirateVirology=NeedleAspirateVirology,
		@GastricWashing=GastricWashing,
		@Bile_PanJuice = Bile_PanJuice,
		@Bile_PanJuiceCytology = Bile_PanJuiceCytology,
		@Bile_PanJuiceBacteriology = Bile_PanJuiceBacteriology,

		@EUSFNANumberOfPasses = EUSFNANumberOfPasses,
		@EUSFNANeedleGauge = EUSFNANeedleGauge,
		@FNB = FNB,
		@EUSFNBNumberOfPasses = EUSFNBNumberOfPasses,
		@EUSFNBNeedleGauge = EUSFNBNeedleGauge,
		@BrushBiopsy = BrushBiopsy,
		@TumourMarkers = TumourMarkers,
		@AmylaseLipase = AmylaseLipase,
		@CytologyHistology = CytologyHistology,
		@FNAAssessedAtProc = FNASampleAssessedAtProcedure,
		@FNBAssessedAtProc = FNBSampleAssessedAtProcedure,
		@AdequateFNA = AdequateFNA,
		@AdequateFNB = AdequateFNB,
		--@Bile_PanJuiceCytology = Bile_PanJuiceCytology,
		--@Bile_PanJuiceBacteriology = Bile_PanJuiceBacteriology,
		--@Bile_PanJuiceAnalysis = Bile_PanJuiceAnalysis
		@NeedleBiopsyHistology = NeedleBiopsyHistology ,
		@NeedleBiopsyCytology = NeedleBiopsyCytology,	
		@NeedleBiopsyMicrobiology = NeedleBiopsyMicrobiology,
		@NeedleBiopsyVirology = NeedleBiopsyVirology
	FROM
		ERS_UpperGISpecimens sp
	JOIN
		ERS_Sites s ON sp.SiteId = s.SiteId
	JOIN
		ERS_Procedures p ON s.ProcedureId = p.ProcedureId
	--LEFT OUTER JOIN
	--	ERS_Lists l ON p.ForcepSerialNo = l.[ListItemNo] AND l.[ListDescription] = 'Forcep Serial Numbers'
	WHERE 
		sp.SiteId = @SiteId

	
		--MH added on 09 Feb 2024 - Item 57 in V10 release spreadsheet
		Set @SpecimensBiopsySitesDetails = ''
		if exists(Select * from ERS_SiteSpecimens Where SiteId = @SiteId)
		Begin
			SELECT @SpecimensBiopsySitesDetails = isnull(@SpecimensBiopsySitesDetails, '') + (SELECT STUFF((
																					SELECT ',' + BS.Description + ' at ' + cast(Distance as varchar(5)) + ' cm, ' + cast(Qty as varchar(5)) + ' Qty' 
																					from ERS_SiteSpecimens SS
																					inner join ERS_BiopsySites BS on SS.BiopsySiteId =BS.UniqueId
																					Where SiteId = @SiteId
																					FOR XML PATH('')), 1, 1, '') Code )
		End	


	IF @None = 1
		SET @summary = @summary + 'No specimens taken'
	ELSE
	BEGIN

		IF @AmylaseLipase = 1 
		BEGIN
			IF @summary <> '' SET @summary = @summary + @FullStop
			SET @summary = @summary + 'Amylase and lipase'
		END

		IF @Bile_PanJuice = 1
		BEGIN
			DECLARE @BileTxt VARCHAR(30) = 'Bile'

			IF (SELECT 1 FROM ERS_Regions WHERE RegionId = @RegionId AND 
				Region IN ('Uncinate Process', 'Head', 'Neck', 'Body', 'Tail', 'Accessory Pancreatic Duct', 'Main Pancreatic Duct') ) = 1
					SET @BileTxt = 'Pancreatic juice'
		
			IF @Bile_PanJuiceBacteriology = 1 OR @Bile_PanJuiceCytology = 1 
			BEGIN
				SET @tempsummary = ''
				IF @Bile_PanJuiceCytology = 1
					SET @tempsummary = @tempsummary + 'cytology'
				IF @Bile_PanJuiceBacteriology = 1 
						IF @tempsummary = '' SET @tempsummary = 'microbiology'
						ELSE SET @tempsummary = @tempsummary + ', microbiology'
				SET @BileTxt = 	@BileTxt + ' (' + @tempsummary + ')'
			END
			IF @summary <> '' SET @summary = @summary + @FullStop
			SET @summary = @summary + @BileTxt
		END

		IF @Biopsy = 1 
		BEGIN
			IF @summary <> '' SET @summary = @summary + @FullStop
			SET @summary = @summary + 'Biopsy'

			IF @BiopsyQtyHistology > 0 OR @BiopsyQtyMicrobiology > 0 OR @BiopsyQtyVirology > 0
			BEGIN
				SET @tempsummary = ''
				IF @BiopsiesTakenAtRandom = 1
				BEGIN
					SET @tempsummary = CONVERT(VARCHAR, ISNULL(@BiopsyQtyHistology,0) + ISNULL(@BiopsyQtyMicrobiology,0) + ISNULL(@BiopsyQtyVirology,0) )
										+ ' x random'
				END
				ELSE IF @BiopsiesTakenAtSites = 1
				BEGIN
					DECLARE @TotalProtocolSites int = (SELECT COUNT(*) FROM dbo.ERS_SiteSpecimens ess WHERE SiteId = @SiteId AND ProtocolSiteId IS NOT NULL)
					DECLARE @BXTotal int = (SELECT COUNT(Qty) FROM ERS_SiteSpecimens WHERE SiteId = @SiteId)
					SET @tempsummary = CONVERT(VARCHAR, ISNULL(@BiopsyQtyHistology,0) + ISNULL(@BiopsyQtyMicrobiology,0) + ISNULL(@BiopsyQtyVirology,0) )
										+ ' taken ' + CASE WHEN ISNULL(@TotalProtocolSites, 0) > 0 THEN 'using Sydney Protocol ' ELSE '' END + 'from multiple sites'
				END
				ELSE
				BEGIN
					IF @BiopsyQtyHistology > 0 SET @tempsummary = CONVERT(VARCHAR(10), @BiopsyQtyHistology) + ' to histology'
					IF @BiopsyQtyMicrobiology > 0
					BEGIN
						IF @tempsummary <> '' SET @tempsummary = @tempsummary + ', ' + CONVERT(VARCHAR(10), @BiopsyQtyMicrobiology) + ' to microbiology'
						ELSE SET @tempsummary = CONVERT(VARCHAR(10), @BiopsyQtyMicrobiology) + ' to microbiology'
					END
					IF @BiopsyQtyVirology > 0
					BEGIN
						IF @tempsummary <> '' SET @tempsummary = @tempsummary + ', ' + CONVERT(VARCHAR(10), @BiopsyQtyVirology) + ' to virology'
						ELSE SET @tempsummary = CONVERT(VARCHAR(10), @BiopsyQtyVirology) + ' to virology'
					END
				END
				SET @summary = @summary + ' ('
				SET @summary = @summary + @tempsummary
				SET @summary = @summary + ')'
			END
			IF @ForcepType > 0 OR ISNULL(@ForcepSerialNo,'') <> ''
			BEGIN
				IF @ForcepType = 1 
				BEGIN
					SET @summary = @summary + ' with disposable forceps'
					IF ISNULL(@ForcepSerialNo,'') <> '' SET @summary = @summary + ' (serial number: ' + @ForcepSerialNo + ')'
				END
				--ELSE IF @ForcepType = 2 
				--BEGIN
				--	SET @summary = @summary + ' (Forceps - Reusable'
				--	IF @ForcepSerialNo > 0 SET @summary = @summary + ', Serial No: ' + @ForcepSerialNoDesc
				--	SET @summary = @summary + ')'
				--END
			END

			------------------------------------------------------------------------------------------------------------------------
			-- Updated by	:	Siddikur Rahman
			-- TFS#	4041
			-- Description of change: Added biopsy distance option for clinical report
			-------------------------------------------------------------------------------------------------------------------------

			IF @BiopsyDistance > 0
			BEGIN
				SET @summary = @summary + ', Distance ' + CONVERT(VARCHAR(10), @BiopsyDistance) + ' cm'
			END

			------------------------------------------------------------------------------------------------------------------------
			-- TFS#	4041 Ended
			------------------------------------------------------------------------------------------------------------------------

		END
		
		IF @BrushCytology = 1 
		BEGIN
			IF @summary <> '' SET @summary = @summary + @FullStop
			SET @summary = @summary + 'Brush cytology'
		END

		IF @BrushBiopsy = 1 
		BEGIN
			IF @summary <> '' SET @summary = @summary + @FullStop
			SET @summary = @summary + 'Brush biopsy'
		END

		IF @CytologyHistology = 1 
		BEGIN
			IF @summary <> '' SET @summary = @summary + @FullStop
			SET @summary = @summary + 'Cytology and histology'
		END

		--FNA
		IF @NeedleAspirate = 1 
		BEGIN
			IF @summary <> '' SET @summary = @summary + @FullStop
			SET @summary = @summary + 'Fine needle aspirate'
			
			IF @NeedleAspirateHistology = 1 OR @NeedleAspirateMicrobiology = 1 OR @NeedleAspirateVirology = 1
			BEGIN
				IF @NeedleAspirateHistology = 1 OR @NeedleAspirateMicrobiology = 1 OR @NeedleAspirateVirology = 1
				BEGIN
					SET @tempsummary = ''
					IF @NeedleAspirateHistology = 1 
						SET @tempsummary = @tempsummary + 'cytology'
					IF @NeedleAspirateMicrobiology = 1 
						IF @tempsummary = '' SET @tempsummary = @tempsummary + 'microbiology'
						ELSE SET @tempsummary = @tempsummary + ', microbiology'
					IF @NeedleAspirateVirology = 1 
						IF @tempsummary = '' SET @tempsummary = @tempsummary + 'virology'
						ELSE SET @tempsummary = @tempsummary + ', virology'
					SET @summary = @summary + ' (' + @tempsummary + ')'
				END
			END

			IF @EUSFNANumberOfPasses > 0 SET @summary = @summary + ' (' + CONVERT(VARCHAR(10), @EUSFNANumberOfPasses) + CASE WHEN @EUSFNANumberOfPasses > 1 THEN ' passes' ELSE ' pass' END
			IF @EUSFNANeedleGauge > 0 
			BEGIN
				IF @EUSFNANumberOfPasses > 0 SET @summary = @summary + ' with ' ELSE SET @summary = @summary + ' (with '
				SET @summary = @summary + CONVERT(VARCHAR(10), @EUSFNANeedleGauge) + ' needle gauge)'
			END
			ELSE
				IF @EUSFNANumberOfPasses > 0 SET @summary = @summary + ')'

			IF @FNAAssessedAtProc = 1
				SET @summary = @summary + ' - assessed at procedure'

			IF @AdequateFNA = 1
				SET @Summary = @Summary + ' - adequate sample retrieved ' --2515--
		END

		--FNB
		IF @FNB = 1 
		BEGIN
			IF @summary <> '' SET @summary = @summary + @FullStop
			SET @summary = @summary + 'Fine needle biopsy'

			IF @NeedleBiopsyHistology = 1 OR @NeedleBiopsyMicrobiology = 1 OR @NeedleBiopsyVirology = 1
			BEGIN
				IF @NeedleBiopsyHistology = 1 OR @NeedleBiopsyMicrobiology = 1 OR @NeedleBiopsyVirology = 1
				BEGIN
					SET @tempsummary = ''
					IF @NeedleBiopsyHistology = 1 
						SET @tempsummary = 'histology'
					IF @NeedleBiopsyCytology = 1 														
						IF @tempsummary = '' SET @tempsummary = @tempsummary + 'cytology'
						ELSE SET @tempsummary = @tempsummary + ', cytology'
					IF @NeedleBiopsyMicrobiology = 1 
						IF @tempsummary = '' SET @tempsummary = @tempsummary + 'microbiology'
						ELSE SET @tempsummary = @tempsummary + ', microbiology'
					IF @NeedleBiopsyVirology = 1 
						IF @tempsummary = '' SET @tempsummary = @tempsummary + 'virology'
						ELSE SET @tempsummary = @tempsummary + ', virology'
					SET @summary = @summary + ' (' + @tempsummary + ')'
				END
			END

			IF @EUSFNBNumberOfPasses > 0 SET @summary = @summary + ' (' + CONVERT(VARCHAR(10), @EUSFNBNumberOfPasses) + CASE WHEN @EUSFNBNumberOfPasses > 1 THEN ' passes' ELSE ' pass' END
			IF @EUSFNBNeedleGauge > 0 
			BEGIN
				IF @EUSFNBNumberOfPasses > 0 SET @summary = @summary + ' with ' ELSE SET @summary = @summary + ' (with '
				SET @summary = @summary + CONVERT(VARCHAR(10), @EUSFNBNeedleGauge) + ' needle gauge)'
			END
			ELSE
				IF @EUSFNBNumberOfPasses > 0 SET @summary = @summary + ')'

			IF @FNBAssessedAtProc = 1
				SET @summary = @summary + ' - assessed at procedure'

			IF @AdequateFNB = 1
				SET @Summary = @Summary + ' - adequate sample retrieved ' --2515--
		END

		IF @GastricWashing = 1 
		BEGIN
			IF @summary <> '' SET @summary = @summary + @FullStop
			SET @summary = @summary + 'Gastric Washing'
		END

		IF @HotBiopsy = 1 
		BEGIN
			IF @summary <> '' SET @summary = @summary + @FullStop
			SET @summary = @summary + 'Hot biopsy'
		END
		
		IF @Polypectomy = 1 
		BEGIN
			IF @summary <> '' SET @summary = @summary + @FullStop
			SET @summary = @summary + 'Polypectomy'
			
			IF @PolypectomyQty > 0 
			BEGIN
				SET @summary = @summary + ' (' + CONVERT(VARCHAR(10), @PolypectomyQty) + CASE WHEN @PolypectomyQty > 1 THEN ' polyps' ELSE ' polyp' END

				if exists(Select 1 from ERS_UpperGITherapeutics where SiteId = @SiteId and PolypectomyRemovalType in (1,2,3,4,5,6,7))
				BEGIN
					SELECT @summary = @summary + CASE PolypectomyRemovalType 
											WHEN 1 THEN ' by partial Snare'
											WHEN 2 THEN ' by cold snare'
											WHEN 3 THEN ' by hot snare cauterisation'
											WHEN 4 THEN ' by hot biopsy'
											WHEN 5 THEN ' by cold biopsy'
											WHEN 6 THEN ' by hot snare by EMR'
											WHEN 7 THEN ' by cold snare by EMR'
										END
					FROM ERS_UpperGITherapeutics where SiteId = @SiteId
				END
				SET @summary = @summary + ')'
			END
		END
		
		IF @TumourMarkers = 1 
		BEGIN
			IF @summary <> '' SET @summary = @summary + @FullStop
			SET @summary = @summary + 'Tumour markers'
		END

		IF @Urease = 1 
		BEGIN
			IF @summary <> '' SET @summary = @summary + @FullStop

			IF @UreaseResult = 1 SET @summary = @summary + 'Positive urease test for H. pylori'
			ELSE IF @UreaseResult = 2 SET @summary = @summary + 'Urease test for H. pylori proved negative'
			ELSE  SET @summary = @summary + 'Urease test'
		END
	END

	--MH Added on 09 Feb 2024
	if(IsNull(@SpecimensBiopsySitesDetails,'') <> '')
	Begin
		Set @summary = @summary + ', - Biopsy sites: ' + @SpecimensBiopsySitesDetails
	End
	

	-- Finally, update the summary in specimens table
	UPDATE ERS_UpperGISpecimens 
	SET Summary=@summary 
	WHERE SiteId = @SiteId

GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	No TFS - Item 2515  by Rezaul
------------------------------------------------------------------------------------------------------------------------


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 05.09.24
-- TFS#	4350
-- Description of change
-- Update total list duration when slots are added/edited
------------------------------------------------------------------------------------------------------------------------
GO


ALTER PROCEDURE dbo.sch_add_list_slot
(
	@ListRulesId INT, 
	@SlotId INT, 
	@ProcedureTypeId INT, 
	@OperatingHospitalId INT, 
	@LoggedInUserId INT, 
	@SlotMinutes DECIMAL(18,2), 
	@Points DECIMAL
)
AS
BEGIN
    INSERT INTO ERS_SCH_ListSlots (ListRulesId, SlotId, ProcedureTypeId,OperatingHospitalId, WhoCreatedId, WhenCreated, SlotMinutes, Points,Locked, IsOverBookedSlot, Suppressed)
    VALUES (@ListRulesId, @SlotId, @ProcedureTypeId, @OperatingHospitalId, @LoggedInUserId, GETDATE(), @SlotMinutes, @Points, 0, 1, 0)

	UPDATE dbo.ERS_SCH_DiaryPages SET DiaryEnd = dbo.fnSCH_DiaryEnd(@ListRulesId, DiaryStart)

	--update list points and total minutes
	DECLARE @TotalMins INT, @TotalPoints DECIMAL(18,2)
	SELECT @TotalPoints = SUM(Points), @TotalMins = SUM(SlotMinutes) FROM dbo.ERS_SCH_ListSlots WHERE ListRulesId = @ListRulesId
	UPDATE dbo.ERS_SCH_ListRules SET TotalMins = @TotalMins, Points = @TotalPoints WHERE ListRulesId = @ListRulesId
END
GO


ALTER PROCEDURE [dbo].[sch_list_slot_update]
(
	@ListSlotId int,
	@SlotStatusId int,
	@ProcedureTypeId int,
	@Points decimal(18,2),
	@SlotLength int,
	@LoggedInUserId int
)
AS
BEGIN
	UPDATE ERS_SCH_ListSlots
	SET SlotId = @SlotStatusId,
		ProcedureTypeId = @ProcedureTypeId,
		Points = @Points,
		SlotMinutes = @SlotLength,
		WhenUpdated = getdate(),
		WhoUpdatedId = @LoggedInUserId
	WHERE ListSlotId = @ListSlotId

	IF @SlotLength > 0 
	BEGIN
		--update diary end
	    DECLARE @ListRulesId INT = (SELECT TOP 1 ListRulesId FROM dbo.ERS_SCH_ListSlots WHERE ListSlotId = @ListSlotId)
		DECLARE @DiaryId INT = (SELECT TOP 1 DiaryId FROM dbo.ERS_SCH_DiaryPages d WHERE d.ListRulesId = @ListRulesId)
	    UPDATE dbo.ERS_SCH_DiaryPages SET DiaryEnd = dbo.fnSCH_DiaryEnd(@ListRulesId, DiaryStart) WHERE DiaryId = @DiaryId

	END

	--update list points and total minutes
	DECLARE @TotalMins int, @TotalPoints DECIMAL(18,2)
	SELECT @TotalPoints = SUM(Points), @TotalMins = SUM(SlotMinutes) FROM dbo.ERS_SCH_ListSlots WHERE ListRulesId = @ListRulesId
	UPDATE dbo.ERS_SCH_ListRules SET TotalMins = @TotalMins, Points = @TotalPoints WHERE ListRulesId = @ListRulesId
END
GO



------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 05.09.24
-- TFS#	
-- Description of change
-- changes to fix NED errors for overall extent
------------------------------------------------------------------------------------------------------------------------
GO

ALTER FUNCTION [dbo].[fnNED_ProcedureExtent]
(
	  @ProcedureId AS INT
	, @CarriedOutRole AS INT = 0			--## 0: 'Overall Extent'; 1: TrainER; 2: TrainEE
)
RETURNS VARCHAR(50)
AS
BEGIN
	DECLARE @ProcedureType AS INT,
			@Extent AS VARCHAR(100);

	SELECT @ProcedureType= ProcedureType FROM ERS_Procedures WHERE ProcedureId=@ProcedureId;

	
	SELECT @Extent = 
	CASE WHEN @ProcedureType IN (3, 4, 9) THEN ( 
		CASE WHEN @CarriedOutRole = 0 OR @CarriedOutRole = 1 THEN --0 = furthest, 1 = Endo 1 (also furthest)
			(SELECT TOP 1 CASE WHEN pe.ExtentId IS NULL THEN CASE WHEN pe.Abandoned = 1 THEN 'Abandoned' WHEN IntubationFailed = 1 THEN 'Intubation failed' END ELSE e.NEDTerm END 
			FROM ERS_ProcedureLowerExtent pe
			JOIN ERS_Extent e ON pe.ExtentId = e.UniqueId 
			WHERE pe.ProcedureId = @ProcedureId
			ORDER BY CASE WHEN ListOrderBy = -1 THEN 9999 ELSE ListOrderBy END )
		ELSE -- Endo 2
			(SELECT CASE WHEN pe.ExtentId IS NULL THEN CASE WHEN pe.Abandoned = 1 THEN 'Abandoned' WHEN IntubationFailed = 1 THEN 'Intubation failed' END ELSE e.NEDTerm END 
			FROM ERS_ProcedureLowerExtent pe
			JOIN ERS_Procedures p ON pe.EndoscopistId = p.Endoscopist2 AND pe.ProcedureId = p.ProcedureId
			LEFT JOIN ERS_Extent e ON pe.ExtentId = e.UniqueId  
			WHERE pe.ProcedureId = @ProcedureId AND pe.EndoscopistId = p.Endoscopist2)
		END
		)
	WHEN @ProcedureType IN (1, 2, 8, 7, 6) THEN ( 
		CASE WHEN @CarriedOutRole = 0 OR @CarriedOutRole = 1 THEN --0 = furthest, 1 = Endo 1 (also furthest)
			(SELECT TOP 1 e.NEDTerm
			FROM ERS_ProcedureUpperExtent pe
			JOIN ERS_Extent e ON pe.ExtentId = e.UniqueId 
			WHERE pe.ProcedureId = @ProcedureId
			ORDER BY CASE WHEN ListOrderBy = -1 THEN 9999 ELSE ListOrderBy END DESC )
		ELSE -- Endo 2
			(SELECT TOP 1 e.NEDTerm
			FROM ERS_ProcedureUpperExtent pe
			JOIN ERS_Procedures p ON pe.EndoscopistId = p.Endoscopist2 AND pe.ProcedureId = p.ProcedureId 
			JOIN ERS_Extent e ON pe.ExtentId = e.UniqueId 
			WHERE pe.ProcedureId = @ProcedureId AND pe.EndoscopistId = p.Endoscopist2
			ORDER BY CASE WHEN ListOrderBy = -1 THEN 9999 ELSE ListOrderBy END DESC )
		END
		)
	END;

	RETURN @Extent;
END
GO



------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 05.09.24
-- TFS#	TBC
-- Description of change
-- Defined order of scheduler menu items
------------------------------------------------------------------------------------------------------------------------
GO


UPDATE dbo.ERS_MenuMap SET NodeName = 'Schedule Lists', SortOrder = 301 WHERE NodeName = 'Schedule lists...'
UPDATE dbo.ERS_MenuMap SET NodeName = 'Scheduler Reports', SortOrder = 302 WHERE NodeName = 'Scheduler reports...'
UPDATE dbo.ERS_MenuMap SET NodeName = 'Orders', SortOrder = 303 WHERE NodeName = 'Orders'
UPDATE dbo.ERS_MenuMap SET NodeName = 'Scheduler Setup', SortOrder = 304 WHERE NodeName = 'Scheduler setup'

UPDATE dbo.ERS_MenuMap SET ParentID= (SELECT MapID FROM dbo.ERS_MenuMap WHERE NodeName = 'Scheduler Setup') WHERE NodeName = 'Letters'


------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------

GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 09.09.24
-- TFS#	
-- Description of change
-- Changes for NED XML generation
------------------------------------------------------------------------------------------------------------------------
GO

ALTER FUNCTION [dbo].[tvfNED_ProcedureConsultants]
(
	@ProcedureId AS INT
	, @ProcedureType AS INT
)
-- =============================================
-- Description:	This will return the list of 'Consultants' for each Procedure- required for NED Export!
-- =============================================
RETURNS TABLE 
AS
RETURN 
(
	WITH EndoscopistSummary AS(
		select top 1 ProcedureId AS ProcedureId, ProcedureType, End1_GMCCode, Endoscopist1, Endo1Role, RoleTypeEnd1, End2_GMCCode, Endoscopist2, Endo2Role, RoleTypeEnd2, ListType from tvfEndoscopistSelectByProcedureSite(@ProcedureId,0)	
	)
	Select DISTINCT E.ProcedureId
	--, C.GMCCode AS professionalBodyCode
	--, 'UNITrainer' AS professionalBodyCode	 --## Change it for LIVE. In TEST- we need this dummy data to pass the NED Validation check!
	, LTRIM(RTRIM(E.End1_GMCCode)) AS professionalBodyCode
	, E.Endoscopist1 AS EndosId 
	, E.Endo1Role AS EndRole, E.ListType
	, E.RoleTypeEnd1 AS procedureRole
	, (Case E.Endo1Role When 1 Then 'Independent' Else 'Trainer' END) As endoscopistRole
	, 1 AS ConsultantTypeId
	,(SELECT
		CASE 
			WHEN E.ProcedureType IN (1,2,6,7,8) THEN
				CASE WHEN E.Endoscopist2 IS NULL THEN UEX.NedTerm
					 WHEN E.Endo1Role <> 1 AND NOT EXISTS (SELECT 1 FROM dbo.ERS_ProcedureUpperExtent epue WHERE epue.EndoscopistId = E.Endoscopist1 AND epue.ExtentId IS NOT NULL AND epue.ProcedureId = @ProcedureId) /*Trainee has an entry*/
										 THEN (SELECT UEX.NedTerm FROM dbo.ERS_ProcedureUpperExtent epue WHERE epue.EndoscopistId = E.Endoscopist2 AND epue.ProcedureId = @ProcedureId) /*TrainEE did it so TrainER gets it too*/
					/*WHEN Endo1Role = 1 THEN*/ ELSE (SELECT UEX.NedTerm FROM dbo.ERS_ProcedureUpperExtent epue WHERE epue.EndoscopistId = E.Endoscopist1 AND epue.ProcedureId = @ProcedureId) /*Endo is independant or TrainER did it alone */
				END
			WHEN E.ProcedureType IN (3,4,9) THEN
				CASE WHEN E.Endoscopist2 IS NULL THEN LEX.NEDTerm
					 WHEN E.Endo1Role <> 1 AND NOT EXISTS (SELECT 1 FROM dbo.ERS_ProcedureLowerExtent epue WHERE epue.EndoscopistId = E.Endoscopist1 AND epue.ExtentId IS NOT NULL AND epue.ProcedureId = @ProcedureId) 
										 THEN (SELECT LEX.NEDTerm FROM dbo.ERS_ProcedureLowerExtent epue WHERE epue.EndoscopistId = E.Endoscopist2 AND epue.ProcedureId = @ProcedureId) /*TrainEE did it so TrainER gets it too*/
					/*WHEN E.Endo1Role = 1 THEN*/ ELSE (SELECT LEX.NEDTerm FROM dbo.ERS_ProcedureLowerExtent epue WHERE epue.EndoscopistId = E.Endoscopist1 AND epue.ProcedureId = @ProcedureId) /*Endo is independant or TrainER did it alone */

				END
	 END) AS Extent
	,(SELECT
		CASE 
			WHEN E.ProcedureType IN (1,2,6,7,8) THEN
				CASE WHEN E.Endoscopist2 IS NULL THEN PUE.JManoeuvreId
					 WHEN E.Endo1Role <> 1 AND NOT EXISTS (SELECT 1 FROM dbo.ERS_ProcedureUpperExtent epue WHERE epue.EndoscopistId = E.Endoscopist1 AND epue.JManoeuvreId IS NOT NULL AND epue.ProcedureId = @ProcedureId) /*Trainee has an entry*/
										 THEN (SELECT CONVERT(BIT, epue.JManoeuvreId) FROM dbo.ERS_ProcedureUpperExtent epue WHERE epue.EndoscopistId = E.Endoscopist2 AND epue.ProcedureId = @ProcedureId) /*TrainEE did it so TrainER gets it too*/
					/*WHEN Endo1Role = 1 THEN*/ ELSE (SELECT CONVERT(BIT, epue.JManoeuvreId) FROM dbo.ERS_ProcedureUpperExtent epue WHERE epue.EndoscopistId = E.Endoscopist1 AND epue.ProcedureId = @ProcedureId) /*Endo is independant or TrainER did it alone */
				END
			WHEN E.ProcedureType IN (3,4,9) THEN
				CASE WHEN E.Endoscopist2 IS NULL THEN PLE.RetroflectionPerformed
					 WHEN E.Endo1Role <> 1 AND NOT EXISTS (SELECT 1 FROM dbo.ERS_ProcedureLowerExtent epue WHERE epue.EndoscopistId = E.Endoscopist1 AND epue.RetroflectionPerformed IS NOT NULL AND epue.ProcedureId = @ProcedureId) 
										 THEN (SELECT epue.RetroflectionPerformed FROM dbo.ERS_ProcedureLowerExtent epue WHERE epue.EndoscopistId = E.Endoscopist2 AND epue.ProcedureId = @ProcedureId) /*TrainEE did it so TrainER gets it too*/
					/*WHEN E.Endo1Role = 1 THEN*/ ELSE (SELECT epue.RetroflectionPerformed FROM dbo.ERS_ProcedureLowerExtent epue WHERE epue.EndoscopistId = E.Endoscopist1 AND epue.ProcedureId = @ProcedureId) /*Endo is independant or TrainER did it alone */

				END
		END) AS jManoeuvre
	 FROM EndoscopistSummary AS E
	 LEFT JOIN ERS_ProcedureLowerExtent				AS PLE ON PLE.ProcedureId = E.ProcedureId AND PLE.EndoscopistId = E.Endoscopist1
	 LEFT JOIN ERS_Extent							AS LEX  ON LEX.UniqueId = PLE.ExtentId
	 LEFT JOIN ERS_ProcedureUpperExtent				AS PUE ON PUE.ProcedureId = E.ProcedureId AND PUE.EndoscopistId = E.Endoscopist1
	 LEFT JOIN ERS_Extent							AS UEX  ON UEX.UniqueId = PUE.ExtentId
	 LEFT JOIN dbo.ERS_Users						AS U   ON E.Endoscopist1 = U.UserId

	UNION ALL --## Now Combine the TrainEE Record!
	
	Select DISTINCT E.ProcedureId
	--, C.GMCCode AS professionalBodyCode
	--, 'UNITrainee' AS professionalBodyCode --## Change it for LIVE. In TEST- we need this dummy data to pass the NED Validation check!
	, LTRIM(RTRIM(E.End2_GMCCode)) AS professionalBodyCode
	, E.Endoscopist2 AS EndosId, E.Endo2Role  AS EndRole, E.listType
	, E.RoleTypeEnd2 AS procedureRole
	, (Case E.Endo2Role When 1 Then 'Independent' Else 'Trainee' END) As endoscopistRole
	, 2 AS ConsultantTypeId
	, (SELECT 
		CASE 
			WHEN E.ProcedureType IN (1,2,6,7,8) THEN
				CASE WHEN E.Endo2Role = 1 THEN (SELECT UEX.NEDTerm FROM dbo.ERS_ProcedureUpperExtent epue WHERE epue.EndoscopistId = E.Endoscopist2 AND epue.ProcedureId = @ProcedureId)
					 WHEN E.Endo2Role <> 1 AND EXISTS (SELECT 1 FROM dbo.ERS_ProcedureUpperExtent epue WHERE epue.EndoscopistId = E.Endoscopist2 AND epue.ExtentId IS NOT NULL AND epue.ProcedureId = @ProcedureId) 
												THEN (SELECT UEX.NEDTerm FROM dbo.ERS_ProcedureUpperExtent epue WHERE epue.EndoscopistId = E.Endoscopist2 AND epue.ProcedureId = @ProcedureId)  /*TrainEEs outcome*/
				END
			WHEN E.ProcedureType IN (3,4,9) THEN 
				CASE WHEN E.Endo2Role = 1 THEN  (SELECT LEX.NEDTerm FROM dbo.ERS_ProcedureLowerExtent epue WHERE epue.EndoscopistId = E.Endoscopist2 AND epue.ProcedureId = @ProcedureId)
					 WHEN E.Endo2Role <> 1 AND EXISTS (SELECT 1 FROM dbo.ERS_ProcedureLowerExtent epue WHERE epue.EndoscopistId = E.Endoscopist2 AND epue.ExtentId IS NOT NULL AND epue.ProcedureId = @ProcedureId) 
											THEN (SELECT LEX.NEDTerm FROM dbo.ERS_ProcedureLowerExtent epue WHERE epue.EndoscopistId = E.Endoscopist2 AND epue.ProcedureId = @ProcedureId) /*TrainEEs outcome*/
				END
		END) AS Extent
	, (SELECT 
		CASE 
			WHEN E.ProcedureType IN (1,2,6,7,8) THEN
				CASE WHEN E.Endo2Role = 1 THEN (SELECT epue.JManoeuvreId FROM dbo.ERS_ProcedureUpperExtent epue WHERE epue.EndoscopistId = E.Endoscopist2 AND epue.ProcedureId = @ProcedureId)
					 WHEN E.Endo2Role <> 1 AND EXISTS (SELECT 1 FROM dbo.ERS_ProcedureUpperExtent epue WHERE epue.EndoscopistId = E.Endoscopist2 AND epue.JManoeuvreId IS NOT NULL AND epue.ProcedureId = @ProcedureId) 
												THEN (SELECT CONVERT(BIT, epue.JManoeuvreId) FROM dbo.ERS_ProcedureUpperExtent epue WHERE epue.EndoscopistId = E.Endoscopist2 AND epue.ProcedureId = @ProcedureId)  /*TrainEEs outcome*/
				END
			WHEN E.ProcedureType IN (3,4,9) THEN 
				CASE WHEN E.Endo2Role = 1 THEN  (SELECT epue.RetroflectionPerformed FROM dbo.ERS_ProcedureLowerExtent epue WHERE epue.EndoscopistId = E.Endoscopist2 AND epue.ProcedureId = @ProcedureId)
					 WHEN E.Endo2Role <> 1 AND EXISTS (SELECT 1 FROM dbo.ERS_ProcedureLowerExtent epue WHERE epue.EndoscopistId = E.Endoscopist2 AND epue.RetroflectionPerformed IS NOT NULL AND epue.ProcedureId = @ProcedureId) 
											THEN (SELECT epue.RetroflectionPerformed FROM dbo.ERS_ProcedureLowerExtent epue WHERE epue.EndoscopistId = E.Endoscopist2 AND epue.ProcedureId = @ProcedureId) /*TrainEEs outcome*/
				END
		END) AS jManoeuvre	
	from EndoscopistSummary AS E 
		LEFT JOIN ERS_ProcedureLowerExtent				AS PLE ON PLE.ProcedureId = E.ProcedureId AND PLE.EndoscopistId = E.Endoscopist2
		 LEFT JOIN ERS_Extent							AS LEX  ON LEX.UniqueId = PLE.ExtentId
		 LEFT JOIN ERS_ProcedureUpperExtent				AS PUE ON PUE.ProcedureId = E.ProcedureId AND PUE.EndoscopistId = E.Endoscopist2
		 LEFT JOIN ERS_Extent							AS UEX  ON UEX.UniqueId = PUE.ExtentId
		LEFT JOIN dbo.ERS_Users							AS U   ON E.Endoscopist2 = U.UserId
	Where E.Endoscopist2 IS NOT NULL
	);

GO


ALTER PROCEDURE [dbo].[usp_NED_Generate_Report]
(
		@ProcedureId AS INT
)
AS
BEGIN
	SET NOCOUNT ON;

/*
	<xs:schema xmlns="https://www.jets.nhs.uk/schema/hospital.sendbatchmessage-version2.xsd" 
	xmlns:mstns="https://www.jets.nhs.uk/schema/hospital.sendbatchmessage-version2.xsd" 
	xmlns:xs="http://www.w3.org/2001/XMLSchema" 
	targetNamespace="https://www.jets.nhs.uk/schema/hospital.sendbatchmessage-version2.xsd" 
	elementFormDefault="qualified" id="SendBatchMessageFile">		

*/
Declare @site AS VARCHAR(50);
DECLARE 
		@description	AS VARCHAR(1000),
		@uniqueid		AS VARCHAR(15),
		@previousLocalProcedureId AS VARCHAR(15),
		@PatientId		AS INT,
		@sessionType	AS VARCHAR(50),
		@operatingHospitalId AS INT,
		@ProcedureTypeId AS INT,
		@ExportFolderPath AS VARCHAR(100);	--## XML Export Folder path.. Set by Admin in the [ERS_SystemConfig] Table

DECLARE @returnXML XML;

	Set @description = 'NED List';
	SELECT @operatingHospitalId = OperatingHospitalId FROM ERS_Procedures WHERE ProcedureId = @ProcedureId;
	SELECT @site = [NED_HospitalSiteCode], @ExportFolderPath=[NED_ExportPath] FROM [dbo].[ERS_SystemConfig] WHERE OperatingHospitalId = @operatingHospitalId;

	SELECT @ProcedureTypeId = ProcedureType,
		   @uniqueid = RIGHT(('00000' + CAST(@ProcedureId AS VARCHAR(6))),6) --## Procedure Id
							+ RIGHT(('0' + CAST(ProcedureType AS VARCHAR(2))),2)  --## Procedure Type; ie: OGD=1/ERCP=2/COLON=3/FLEXI=13
								+ (CASE ProcedureType	WHEN  1 THEN 'o' 
														WHEN  2 THEN 'e'
														WHEN  4 THEN 's' 
														WHEN  3 THEN 'c'
														WHEN  6 THEN 'u'
														WHEN  7 THEN 'u'
														WHEN  8 THEN 'n'
														WHEN  9 THEN 't'
									END)	--## Procedure Letter
		 , @sessionType=Case ListType	When 1 Then 'Service List' 
										When 2 Then 'Adhoc Training List' 
											   Else 'Dedicated Training List' End 
		, @PatientId = PatientId
	From dbo.ERS_Procedures Where ProcedureId=@ProcedureId;


	--## UniqueId is generated- so UPDATE this new value now in the ERS_Procedures Table
	UPDATE dbo.ERS_Procedures
	SET [NEDProcedureId] = @uniqueid
	WHERE ProcedureId=@ProcedureId;

	--## Now get the Previous NED Unique Id- of the same Patient... We know the Patient Id already! Use it!!
	SELECT @previousLocalProcedureId = IsNull([NEDProcedureId], '') 
			 FROM dbo.ERS_Procedures 
			WHERE PatientId = @PatientId AND ProcedureId<@ProcedureId
		 ORDER BY ProcedureID DESC;

	print '@uniqueid: ' + @uniqueid;

SET @returnXML=(
SELECT 
	  @uniqueid											AS '@uniqueId'
	, @description										AS '@description'
	, REPLACE(convert(varchar, p.CreatedOn, 106), ' ', '/')	AS '@date'	--### '10 Oct 2020' ==> '10/Oct/2020'
	, P.ProcedureTime AS '@time'
	, @sessionType										AS '@type'	-- SessionTypeEnum
	, @site												AS '@site'	--## Hospital Code

	/*	##### Procedure info	*/
	, (
	Select 
		  @uniqueid										AS '@localProcedureId'
		, @previousLocalProcedureId						AS '@previousLocalProcedureId'
		, (CASE P.ProcedureType WHEN 1 THEN 'OGD' 
								WHEN 2 THEN 'ERCP' 
								WHEN 3 THEN 'COLON' 
								WHEN 4 THEN 'FLEXI' 
								WHEN 6 THEN 'EUS' 
								WHEN 7 THEN 'EUS' 
								WHEN 8 THEN 'ENT' 
								WHEN 9 THEN 'ENT' 
		   END) AS '@procedureName'
		, Dis.NEDTerm AS '@procedureDiscomfort'	
		, PPDD.NEDTerm AS '@postProcedureDiscomfort' -- **************************** TO DO *********************************
		, dbo.fnNED_ProcedureExtent(@ProcedureId, 0) AS '@extent'	--## OverAll Extent info - EE/ER- whoever has gone Furthest distance!!
		, (CASE WHEN Drug.entonox IS NULL THEN 'No' ELSE 'Yes' END) AS '@entonox'
		, CASE WHEN ISNULL((Select DrugNo from ERS_UpperGIPremedication where ProcedureId = @ProcedureID and DrugNo = -2), 0) = -2 THEN 'Yes' ELSE 'No' END AS '@generalAnaes'
		, convert(varchar, P.StartDateTime, 126) AS '@procedureStartTime'
		, convert(varchar, P.EndDateTime, 126) AS '@procedureEndTime'
		, Ins.NEDTerm AS '@insufflation' 
		, PS.NEDTerm AS '@providerSector'
		, RT.NEDTerm AS '@referrer'
		, CASE WHEN isnull(P.ReferrerTypeOther, '') = '' THEN NULL ELSE P.ReferrerTypeOther END AS '@referrerOther' -- ***************** Only if referrer is 'Other' *******************************
		, PO.NEDTerm AS '@providerOrganisation' 
		, CASE WHEN isnull(P.ProviderOther, '') = '' THEN NULL ELSE P.ProviderOther END AS '@providerOrganisationOther' -- **************** Only if providerOrganisation is 'Other' *************************
		, CASE WHEN P.ChecklistComplete = 0 THEN 'No' ELSE 'Yes' END AS '@checklist' 
		, CASE WHEN PatStat.ListItemText = 'Day patient' THEN 'Inpatient' ELSE PatStat.ListItemText END AS '@admissionType'
		, Urgency.Description AS '@urgencyType' 
		, Ext.NEDTerm AS '@plannedExtent'
		, ISNULL(AIS.NEDTerm, 'None')  AS '@artificialintelligence'
		, CASE WHEN AIS.NEDTerm = 'Other' THEN PAIS.AISoftwareOther ELSE NULL END AS '@artificialintelligenceOther' -- **************** Only if artificialintelligence is 'Other' *************************
		, CASE WHEN PAIS.AISoftwareName IS NULL OR AIS.NEDTerm = 'None' THEN NULL ELSE PAIS.AISoftwareName END AS '@nameOfAISoftware' -- **************** Only if artificialintelligence is NOT 'None' *************************
		, CASE WHEN CHARINDEX('.00',P.Points,0) > 0 THEN convert(varchar(10), convert(int, P.Points)) ELSE convert(varchar(10), P.Points) END AS '@procedurePoints'


		/*	##### Patient Info	*/		
		, (CASE dbo.fnGender(Pat.GenderId) WHEN 'Not Known' THEN 'Other' WHEN 'Not Specified' THEN 'Other' ELSE dbo.fnGender(Pat.GenderId) END)		AS 'patient/@gender'
		, (0+ FORMAT(getdate(),'yyyyMMdd') - FORMAT(Pat.DateOfBirth,'yyyyMMdd') ) /10000 AS 'patient/@age'


		/*	##### Drugs	*/
		, CASE WHEN CHARINDEX('.00',IsNull(Drug.pethidine,0),0) > 0 THEN convert(varchar(10), convert(int,IsNull(Drug.pethidine,0))) ELSE CONVERT(varchar(10),IsNull(Drug.pethidine,0)) END	As 'drugs/@pethidine'	--## Required
		, CASE WHEN CHARINDEX('.00',IsNull(Drug.midazolam,0),0) > 0 THEN convert(varchar(10), convert(int,IsNull(Drug.midazolam,0))) ELSE CONVERT(varchar(10),IsNull(Drug.midazolam,0)) END	As 'drugs/@midazolam'	--## Required
		, CASE WHEN CHARINDEX('.00',IsNull(Drug.fentanyl,0),0) > 0 THEN convert(varchar(10), convert(int,IsNull(Drug.fentanyl,0))) ELSE CONVERT(varchar(10),IsNull(Drug.fentanyl,0))	END As 'drugs/@fentanyl'	--## Required
		, CASE WHEN CHARINDEX('.00',IsNull(Drug.buscopan,0),0) > 0 THEN convert(varchar(10), convert(int,IsNull(Drug.buscopan,0))) ELSE CONVERT(varchar(10),IsNull(Drug.buscopan,0))	END As 'drugs/@buscopan'	--## Required
		, CASE WHEN CHARINDEX('.00',IsNull(Drug.remimazolam,0),0) > 0 THEN convert(varchar(10), convert(int,IsNull(Drug.remimazolam,0))) ELSE CONVERT(varchar(10),IsNull(Drug.remimazolam,0))	END As 'drugs/@remimazolam'	--## Required
		, CASE WHEN IsNull(Drug.propofol, 0) = 0 THEN 'No' ELSE	'Yes' END			As 'drugs/@propofol'	--## YesNo
		, ISNULL(Drug.noDrugsAdministered, 'Yes')	As 'drugs/@noDrugsAdministered'


		/*	##### Staff.Members: 1 Procedure to MANY staff.. So - need a SQL Subquery- to return a RecordSet		*/
		,(
			SELECT 
			  Staff.professionalBodyCode AS '@professionalBodyCode'
			, Staff.EndoscopistRole		AS '@endoscopistRole'
			, Staff.ProcedureRole		AS '@procedureRole'	-- ProcedureRoleTypeEnum
			, Staff.Extent				AS '@extent'
			, CASE WHEN @ProcedureTypeId IN (1,3,4) THEN CASE Staff.[jManoeuvre] WHEN 1 THEN 'Yes' WHEN 0 THEN 'No' ELSE NULL END END	AS '@jManoeuvre'	-- Opt -- Mandatory for OGD, Colon and Flexi procedures (Rectal retroversion)
			/*	##### Therapeutic = Sesion->Procedure-> Staff.members-> Staff-> Therapeutic; 1 [Staff] to Many [Therapeutic sessions]	*/
			, (
				Select * from (select 
					   T.NedName	AS '@type'	-- M	--## The type of therapeutic procedure.
					 , CASE WHEN rc.RegionId IS NULL THEN T.[Site] ELSE 'Anastomosis' END		AS '@site'	-- O -- BiopsyEnum  --## The location where the therapeutic procedure was performed.
					 , ISNULL(T.EndoRole, Staff.ProcedureRole) AS '@role' -- O	-- ProcedureRoleTypeEnum
					 , T.polypSize	AS '@polypSize' -- O	-- PolypSizeEnum --## The size of polyp (if found) -> is ONLY for COLON/FLEXI
					 , T.PolypSizeInt AS '@polypSizeInteger'  
					 , T.Detected AS '@observed' 
					 , T.Tattooed	AS '@tattooed'	-- O	-- TattooEnum
					 , sum(T.Performed)	AS '@performed'	-- M	-- REQUIRED; INT	-- ## Number performed
					 , sum(T.Successful)	AS '@successful' -- M	-- REQUIRED; INT -- Number of successful
					 , sum(T.Retrieved)	AS '@retrieved'	-- O	-- INT	-- ## Number of Polyp retrieved -> is ONLY for COLON/FLEXI
					 , T.comment 	AS '@comment'	-- O	--## Use this field to define what Other is when selected.
					 , T.Morphology AS '@morphology' -- **************************** TO DO *********************************

				FROM dbo.tvfNED_ProcedureTherapeutic(P.ProcedureType, @ProcedureId, Staff.ConsultantTypeId) AS T --## Which Consultant's Record in the Procedure?
					LEFT JOIN dbo.ERS_Sites ES ON es.SiteId = T.SiteId
					LEFT JOIN tvfProcedureResectedColon(@ProcedureId) RC ON RC.RegionId = ES.RegionId
				group by T.SiteId,T.NedName, 
						CASE WHEN rc.RegionId IS NULL THEN T.[Site] ELSE 'Anastomosis' END,
						T.EndoRole,
						T.polypSize,
						T.PolypSizeInt,
						T.Detected,
						T.Tattooed, 
						T.comment,
						T.Morphology) as a
				FOR XML PATH('therapeutic'), ROOT('therapeutics'), TYPE
			)/* End of: Therapeutic List- for a Staff Member		*/
			FROM dbo.tvfNED_ProcedureConsultants(@ProcedureId, P.ProcedureType) AS Staff
			WHERE Staff.EndosId > 0
			FOR XML PATH('Staff'), ROOT('staff.members'), TYPE
		)
			/*	##### Indications: -- 1 or Many	*/		
			, (
				SELECT 
					  dbo.HTMLDecode(I.NedTerm) As '@indication'
					, I.Comment AS '@comment'
					, I.elevatedCalprotectinValue AS '@elevatedCalprotectinValue' -- When indication is Elevated calprotectin then specify the value in (micrograms/gram)
					FROM dbo.tvfNED_ProcedureIndication(@ProcedureId) AS I
					FOR XML PATH('indication'), ROOT('indications'), TYPE
			)
			/*	##### subIndications: -- 0 or Many	*/	
			, (
				SELECT 
					  I.NedTerm As '@type'
					, I.Comment AS '@comment'
					FROM dbo.tvfNED_ProcedureSubIndication(@ProcedureId) AS I
					FOR XML PATH('subIndication'), ROOT('subIndications'), TYPE
			)
			
			/*	##### Limitations: */
			,(
				Select 	
					  L.Limitation As '@limitation'
					, L.Comment As '@comment'
				from [dbo].[tvfNED_ProcedureLimitation](P.ProcedureType, @ProcedureId) AS L
					FOR XML PATH('limitation'), ROOT('limitations'), TYPE
			)	

			/*	##### Biopsy: 0 or Many		*/ --## For Colon/Flexi/OGD
			, (	SELECT 
						  B.BiopsySite		AS '@biopsySite'
						, B.NumberPerformed AS '@numberPerformed'
					FROM [dbo].[tvfNED_ProcedureBiopsy](p.ProcedureType, @ProcedureId) AS B				
					 FOR XML PATH('biopsy'), ROOT('biopsies'), TYPE
			)
			/*	##### Diagnoses: 1 or Many		*/ 
			, (	SELECT 
						  D.Ned_Name	AS '@diagnosis'
						, D.tattooed	AS '@tattooed'
						, CASE WHEN RIGHT(D.Site,2) = ', '
							THEN (LEFT(D.Site, LEN(D.Site)-1))
							ELSE  D.Site END		AS '@site'
						, CASE WHEN RIGHT(D.Comment,2)=', ' 
							THEN (LEFT(D.Comment, LEN(D.Comment)-1)) 
							ELSE D.Comment END
									AS '@comment'	--## Remove the extra ',' at the end!
						,D.barrettsLengthCircumferential as '@barrettsLengthCircumferential' --Required for diagnosis of Barretts
						,D.barrettsLengthMaximum AS '@barrettsLengthMaximum'--, barrettsLengthMaximum --Required for diagnosis of Barretts
						,D.barretsInspectionTime AS '@barretsInspectionTime'--, barretsInspectionTime --Required for diagnosis of Barretts
						,D.gastricInspectiontime AS '@gastricInspectionTime'--, gastricInspectiontime --Required if diagnosis of gastric atrophy OR gastric intestinal metaplasia
						,D.oesophagitisLaClassification AS '@oesophagitisLAClassification'--, oesophagitisLaClassification --Required if diagnosis of Oesophagitis - reflux
						,D.DICAScore AS '@DICAScore'--, DICAScore --required if diagnosis of Diverticulosis
						,D.UCEIS AS '@UCEIS'--, UCEIS --If diagnosis is Ulcerative Colitis either UCEIS or Mayo scores must be provided
						,D.mayoScore AS '@mayoScore'--, mayoScore --If diagnosis is Ulcerative Colitis either UCEIS or Mayo scores must be provided
						--, site --If diagnosis is Crohns Colitis or Crohn`s- terminal ileum and [ExtentLookup]= Neo-terminal ileum
						,NULLIF(RutgeertsScore,'') AS '@rutgeertsScore' --If diagnosis is Crohns Colitis or Crohn`s- terminal ileum and [ExtentLookup]= Neo-terminal ileum
						, CDEIS AS '@CDEIS' --If diagnosis is Crohns Colitis or Crohn`s- terminal ileum
					FROM [dbo].[tvfNED_Diagnoses](p.ProcedureType, @ProcedureId) AS D
					 FOR XML PATH('diagnose'), ROOT('diagnoses'), TYPE
			)
			/*	##### Adverse events: -- 1 or Many	*/
			,(	SELECT 
					  IsNull(AD.adverseEvent,'None')	As '@adverseEvent'
					, (CASE WHEN AD.adverseEvent = 'Other' THEN AD.Comment END) 						As '@comment'
				FROM dbo.tvfNED_ProcedureAdverseEvents(@ProcedureId)		AS AD
				FOR XML PATH('adverse.event'), ROOT('adverse.events'), TYPE			
			)
			, ( Select * from (Select isnull(scog.NEDTerm, 'other') as '@manufacturerGeneration'
						, CASE WHEN scog.NEDTerm IS NULL THEN scog.Description ELSE NULL END as '@other'
				from ERS_Scopes sco
				join ERS_Procedures p on p.Instrument1 = sco.ScopeId
				join ERS_ScopeGenerations scog on sco.ScopeGenerationId = scog.UniqueId
				where p.ProcedureId = @ProcedureId
				union
				Select isnull(scog.NEDTerm, 'other') as '@manufacturerGeneration'
						, CASE WHEN LOWER(scog.NEDTerm) = 'other' THEN scog.Description ELSE NULL END as '@other'
				from ERS_Scopes sco
				join ERS_Procedures p on p.Instrument2 = sco.ScopeId
				join ERS_ScopeGenerations scog on sco.ScopeGenerationId = scog.UniqueId
				where p.ProcedureId = @ProcedureId) as a
				FOR XML PATH('scopes'), ROOT('scopes'), TYPE
			   )
			 , (
				SELECT ISNULL(C.NEDTerm, 'None') AS '@type', 
				(CASE WHEN C.NEDTerm = 'Other' THEN C.Description END) 						AS '@comment'

				 FROM ERS_Procedures p
				 LEFT JOIN ERS_ProcedureChromendosopy PC ON p.ProcedureId= PC.ProcedureId
				 LEFT JOIN ERS_Chromendoscopies C ON C.UniqueId = PC.ChromendoscopyId
				 WHERE P.ProcedureId = @ProcedureId 
				 FOR XML PATH('chromendoscopy'), ROOT('chromendoscopies'), TYPE
				)  
				 ,( 
					SELECT CASE 
						WHEN @ProcedureTypeId = 1 THEN
							(SELECT DISTINCT * FROM (SELECT 
								CASE WHEN (SELECT COUNT(*) FROM ERS_UpperGIPremedication WHERE DrugName = 'Pharyngeal Anaesthesia' AND ProcedureId = @ProcedureId) = 1 THEN 'Yes' ELSE 'No' END as '@pharyngealAnaes'
								,pe.WithdrawalMins as '@scopeWithdrawalTime'
								,ISNULL(DA.NEDTerm,'None') as '@distalAttachment'
								,CASE WHEN LOWER(DA.NEDTerm) = 'other' THEN PD.AdditionalInfo ELSE NULL END as '@distalAttachmentOther'
								,CASE WHEN p.Transnasal = 1 THEN 'Nasal' ELSE 'Oral' END as '@OGDRoute'
								,V.NEDTerm as '@OGDMucosalVisualisation'
								,CASE WHEN (SELECT COUNT(*) FROM ERS_ProcedureMucosalCleaning WHERE ProcedureId = @ProcedureId) > 1 THEN 'Other' ELSE ISNULL(C.NEDTerm, 'None') END as '@OGDMucosalCleaning'
								,CASE WHEN (SELECT COUNT(*) FROM ERS_ProcedureMucosalCleaning WHERE ProcedureId = @ProcedureId) > 1 THEN dbo.fnNED_MucosalCleaning(@ProcedureId) WHEN LOWER(C.NEDTerm) = 'other' THEN C.Description ELSE NULL END as '@OGDMucosalCleaningOther'
								,CASE WHEN P.FormerProcedureId IS NOT NULL THEN 'Yes' WHEN (SELECT COUNT(*) FROM ERS_Procedures pq WHERE pq.FormerProcedureId = p.ProcedureId) > 0 THEN 'Yes' ELSE 'No' END as '@dualProcedure'
								,CASE WHEN dbo.fnNED_GetOGDPhotoDocumentation(@ProcedureId) = 1 THEN 'Yes' ELSE 'No' END '@photoDocumentation'
								from ERS_Procedures AS P 
									LEFT JOIN ERS_ProcedureMucosalVisualisation PV ON PV.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_MucosalVisualisation V ON V.UniqueId = PV.MucosalVisualisationId
									LEFT JOIN ERS_ProcedureUpperExtent PE ON PE.ProcedureId = P.ProcedureId AND PE.WithdrawalMins IS NOT NULL /*there may be more than 1 record in the table where there's 2 endos on a procedure*/
									LEFT JOIN ERS_ProcedureDistalAttachment PD ON PD.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_DistalAttachments DA ON DA.UniqueId = PD.DistalAttachmentId
									LEFT JOIN ERS_ProcedureMucosalCleaning PC ON PC.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_MucosalCleaning C ON C.UniqueId = PC.MucosalCleaningId
								Where P.ProcedureId=@ProcedureId) ogd
							FOR XML PATH('OGD'),TYPE)
						WHEN @ProcedureTypeId = 2 THEN
							(SELECT * FROM (SELECT DISTINCT 
								CASE WHEN (SELECT COUNT(*) FROM ERS_UpperGIPremedication WHERE DrugName = 'Pharyngeal Anaesthesia' AND ProcedureId = @ProcedureId) = 1 THEN 'Yes' ELSE 'No' END as '@pharyngealAnaes'
								,CASE WHEN (SELECT COUNT(*) FROM ERS_UpperGIPremedication WHERE DrugName = 'Prophylactic Antibiotics' AND ProcedureId = @ProcedureId) = 1 THEN 'Yes' ELSE 'No' END as '@antibioticGiven'
								,NULLIF(CASE WHEN ((ev.IntendedBileDuct = 1 AND ev.MajorPapillaBile = 1) OR (ev.IntendedBileDuct_ER = 1 AND ev.MajorPapillaBile_ER = 1)) OR
												  ((ev.IntendedPancreaticDuct = 1 AND ev.MajorPapillaPancreatic = 1) OR (ev.IntendedPancreaticDuct_ER = 1 AND ev.MajorPapillaPancreatic_ER = 1)) THEN 'Yes' 
											 WHEN ((ev.IntendedBileDuct = 1 AND ev.MajorPapillaBile <> 1) OR (ev.IntendedBileDuct_ER = 1 AND ev.MajorPapillaBile_ER <> 1)) OR
												  ((ev.IntendedPancreaticDuct = 1 AND ev.MajorPapillaPancreatic <> 1) OR (ev.IntendedPancreaticDuct_ER = 1 AND ev.MajorPapillaPancreatic_ER <> 1)) THEN 'No'
											ELSE 'Not Applicable' END,'') as '@successfulCannulation'
								,ISNULL((SELECT MAX(ISNULL(convert(int, d.StonesSize),0)) FROM ERS_ERCPAbnoDuct d INNER JOIN ERS_Sites s ON S.SiteId = d.SiteId WHERE S.ProcedureId = @ProcedureId),0) AS '@sizeLargestStone'
								--,ISNULL(CASE WHEN ExtractionOutcome = 1 THEN CONVERT(varchar(max),'Yes') 
								--       WHEN ExtractionOutcome <> 0 THEN CONVERT(varchar(max),'No') END,'Not Applicable') AS '@completeStoneClearance'
								,ISNULL((SELECT TOP 1 CASE WHEN ISNULL(ExtractionOutcome,0) = 1 THEN convert(varchar(max),'Yes') 
											  WHEN StoneRemoval = 0 or ExtractionOutcome <> 1 THEN 'No' END 
								 FROM dbo.ERS_ERCPTherapeutics ET WHERE SiteId IN (SELECT SiteId FROM ERS_Sites WHERE ProcedureId = @ProcedureId)),'Not Applicable') as '@completeStoneClearance'
								,ISNULL((SELECT CASE WHEN LOWER(Region) LIKE '%hepatic%' THEN convert(varchar(max), 'Yes') ELSE convert(varchar(max), 'No') END
											FROM ERS_ERCPAbnoDuct eed 
											INNER JOIN dbo.ERS_Sites es ON eed.SiteId = es.SiteId
												INNER JOIN dbo.ERS_Regions er ON es.RegionId = er.RegionId
											WHERE es.ProcedureId = @ProcedureId AND Stricture = 1),convert(varchar(max), 'Not Applicable')) AS '@extraHepaticStricture'
								,ISNULL((SELECT CASE WHEN eed.Stricture = 1 AND eug.BrushCytology = 1 THEN convert(varchar(max),'Yes') WHEN eed.Stricture = 1 AND eug.BrushCytology = 0 THEN convert(varchar(max),'No') WHEN eed.Stricture = 0 THEN 'Not Applicable' END 
										 FROM ERS_ERCPAbnoDuct eed 
												INNER JOIN dbo.ERS_Sites es ON eed.SiteId = es.SiteId
												INNER JOIN dbo.ERS_Regions er ON es.RegionId = er.RegionId
												INNER JOIN dbo.ERS_UpperGISpecimens eug ON es.SiteId = eug.SiteId
											WHERE es.ProcedureId = @ProcedureId AND
												LOWER(Region) LIKE '%hepatic%'),convert(varchar(max),'Not Applicable')) AS '@extrahepaticStrictureCytologyHistologyTaken'
								,ISNULL((SELECT CASE WHEN eug.CorrectStentPlacement = 1 OR ert.CorrectStentPlacement = 1 THEN convert(varchar(max),'Yes') ELSE convert(varchar(max),'No') END
											FROM ERS_ERCPAbnoDuct eed 
												INNER JOIN dbo.ERS_Sites es ON eed.SiteId = es.SiteId
												INNER JOIN dbo.ERS_Regions er ON es.RegionId = er.RegionId
												LEFT JOIN dbo.ERS_UpperGITherapeutics eug ON es.SiteId = eug.SiteId
												LEFT JOIN dbo.ERS_ERCPTherapeutics ert ON es.SiteId = ert.SiteId
											WHERE es.ProcedureId = @ProcedureId AND eed.Stricture = 1 AND eug.StentInsertion = 1 AND
												LOWER(Region) LIKE '%hepatic%'),convert(varchar(max),'Not Applicable')) AS '@extrahepaticStrictureStentSuccessfullyPlaced'
								,CASE WHEN ISNULL(eea.MajorBilrothRoux,0) = 1 THEN 'Yes' ELSE 'No' END AS '@previousSurgeryBilrothRoux'
								,NULLIF(lc.NEDTerm,0) AS '@levelOfComplexity'
								,CASE WHEN (SELECT COUNT(*) FROM ERS_UpperGIPremedication WHERE DrugName = 'Prophylactic Rectal NSAIDS' AND ProcedureId = @ProcedureId) = 1 THEN 'Yes' ELSE 'No' END as '@prophylacticRectalNSAIDS'
								,CASE WHEN eea.MinorSiteLocation IN (1,2) THEN 'No' ELSE 'Yes' END AS '@nativePapilla'
								from ERS_Procedures AS P 
									LEFT JOIN (SELECT eed.AbnoDuctId, es.ProcedureId, eed.Stricture, er.Region 
												FROM ERS_ERCPAbnoDuct eed 
													INNER JOIN dbo.ERS_Sites es ON eed.SiteId = es.SiteId
													INNER JOIN dbo.ERS_Regions er ON es.RegionId = er.RegionId
											WHERE es.ProcedureId = @ProcedureId AND
												LOWER(Region) LIKE '%hepatic%')  ercs ON ercs.ProcedureId = P.ProcedureId
									LEFT JOIN (SELECT Stones, ISNULL(t.ExtractionOutcome,0) ExtractionOutcome, es.ProcedureId 
												FROM ERS_ERCPAbnoDuct a
													 INNER JOIN dbo.ERS_Sites es ON a.SiteId = es.SiteId
													 LEFT JOIN ERS_ERCPTherapeutics t ON t.siteId = a.SiteId
												 WHERE a.Stones = 1) estones ON estones.ProcedureId = P.ProcedureId
									LEFT JOIN dbo.ERS_ERCPPapillaryAnatomy eea ON P.ProcedureId = eea.ProcedureId
									LEFT JOIN dbo.ERS_Visualisation ev ON P.ProcedureId = ev.ProcedureID
									LEFT JOIN dbo.ERS_ProcedureLevelOfComplexity cl ON cl.ProcedureId = P.ProcedureId
									LEFT JOIN dbo.ERS_LevelOfComplexity lc ON lc.UniqueId = cl.ComplexityId
								Where P.ProcedureId=@ProcedureId) ercp
							FOR XML PATH('ERCP'),TYPE) 
						WHEN @ProcedureTypeId = 3 THEN
							(SELECT TOP 1 * FROM (SELECT 
								(SELECT ISNULL(SUM(Detected),0) FROM tvfNED_PolypsDetailsView(@ProcedureTypeId, @ProcedureId)) as '@polypsDetected'
								,CASE WHEN p.ScopeGuide = 1 THEN 'Yes' ELSE 'No' END AS '@magneticEndoscopeImagerUsed'
								,LE.WithdrawalMins AS '@scopeWithdrawalTime'
								,CASE WHEN LE.RectalExamPerformed = 1 THEN 'Yes' ELSE 'No' END AS '@digitalRectalExamination'
								,CONVERT(VARCHAR(19),LE.CaecumIntubationStart, 126) AS '@caecumTime'
								,ISNULL(DA.NEDTerm,'None') as '@distalAttachment'
								,NULLIF(CASE WHEN LOWER(DA.NEDTerm) = 'other' THEN PD.AdditionalInfo ELSE '' END,'') as '@distalAttachmentOther'
								,IT.NEDTerm as '@insertionTechnique'
								,PB.LeftPrepScore as '@bowelPrepLeft'
								,PB.RightPrepScore as '@bowelPrepRight'
								,PB.TransversePrepScore as '@bowelPrepTransverse'
								,PB.TotalPrepScore as '@bowelPrepTotal'
								,ISNULL(B.NEDTerm,'No preparation') as '@bowelPrep'
								,NULLIF(CASE WHEN LOWER(B.NEDTerm) = 'other' THEN B.[Description] ELSE '' END,'') as '@bowelPrepOther'
								,CASE WHEN P.FormerProcedureId IS NOT NULL THEN 'Yes' WHEN (SELECT COUNT(*) FROM ERS_Procedures pq WHERE pq.FormerProcedureId = p.ProcedureId) > 0 THEN 'Yes' ELSE 'No' END as '@dualProcedure'
								,CASE WHEN NULLIF(fit.FITValue,'') IS NOT NULL THEN fit.FITValue END AS '@fitValue'
								,CASE WHEN fit.FITNotKnownId IS NOT NULL THEN fnk.NEDTerm END AS '@fitNotKnown'
								FROM ERS_Procedures AS P 
									LEFT JOIN ERS_ProcedureLowerExtent LE ON LE.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_ProcedureDistalAttachment PD ON PD.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_DistalAttachments DA ON DA.UniqueId = PD.DistalAttachmentId
									LEFT JOIN ERS_ProcedureInsertionTechnique PIT ON PIT.ProcedureId = p.ProcedureId
									LEFT JOIN ERS_InsertionTechniques IT ON IT.UniqueId = PIT.InsertionTechniqueId
									LEFT JOIN ERS_ProcedureBowelPrep PB ON PB.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_BowelPrep B ON B.UniqueId = PB.BowelPrepId
									LEFT JOIN ERS_ProcedureFITValue fit ON fit.ProcedureId = p.ProcedureId
									LEFT JOIN ERS_FitNotKnownReasons fnk ON fnk.UniqueId = fit.FITNotKnownId
								Where P.ProcedureId=@ProcedureId) col
							FOR XML PATH('Colon'),TYPE)
						WHEN @ProcedureTypeId = 4 THEN
							(SELECT * FROM (SELECT 
								(SELECT ISNULL(SUM(Detected),0) FROM tvfNED_PolypsDetailsView(@ProcedureTypeId, @ProcedureId)) as '@polypsDetected'
								,CASE WHEN LE.RectalExamPerformed = 1 THEN 'Yes' ELSE 'No' END AS '@digitalRectalExamination'
								,CASE WHEN p.ScopeGuide = 1 THEN 'Yes' ELSE 'No' END AS '@magneticEndoscopeImagerUsed'
								,ISNULL(DA.NEDTerm,'None') as '@distalAttachment'
								,CASE WHEN LOWER(DA.NEDTerm) = 'other' THEN PD.AdditionalInfo ELSE NULL END as '@distalAttachmentOther'
								,IT.NEDTerm as '@insertionTechnique'
								,PB.LeftPrepScore as '@bowelPrepLeft'
								,PB.TransversePrepScore as '@bowelPrepTransverse'
								,PB.RightPrepScore as '@bowelPrepRight'
								,PB.TotalPrepScore as '@bowelPrepTotal'
								,ISNULL(B.NEDTerm,'No preparation') as '@bowelPrep'
								,CASE WHEN LOWER(B.NEDTerm) = 'other' THEN B.[Description] ELSE NULL END as '@bowelPrepOther'
								,CASE WHEN NULLIF(fit.FITValue,'') IS NOT NULL THEN fit.FITValue END AS '@fitValue'
								,CASE WHEN fit.FITNotKnownId IS NOT NULL THEN fnk.NEDTerm END AS '@fitNotKnown'
								FROM ERS_Procedures AS P 
									LEFT JOIN (Select ProcedureId, Max(CONVERT(int,RectalExamPerformed)) as RectalExamPerformed from ERS_ProcedureLowerExtent group by ProcedureId) LE ON LE.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_ProcedureDistalAttachment PD ON PD.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_DistalAttachments DA ON DA.UniqueId = PD.DistalAttachmentId
									LEFT JOIN ERS_ProcedureInsertionTechnique PIT ON PIT.ProcedureId = p.ProcedureId
									LEFT JOIN ERS_InsertionTechniques IT ON IT.UniqueId = PIT.InsertionTechniqueId
									LEFT JOIN ERS_ProcedureBowelPrep PB ON PB.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_BowelPrep B ON B.UniqueId = PB.BowelPrepId
									LEFT JOIN ERS_ProcedureFITValue fit ON fit.ProcedureId = p.ProcedureId
									LEFT JOIN ERS_FitNotKnownReasons fnk ON fnk.UniqueId = fit.FITNotKnownId
								Where P.ProcedureId=@ProcedureId) flexi
							FOR XML PATH('Flexi'),TYPE)  
						WHEN @ProcedureTypeId IN (6,7) THEN
							(SELECT * FROM (SELECT DISTINCT CASE WHEN pm.DrugName = '' THEN 'Yes' ELSE 'No' END AS '@prophylacticAntibioticsBeforeEUS',
												ISNULL(dbo.fnNED_FNAFNBSolidLesions(@ProcedureId, P.ProcedureType),'Not applicable') AS '@FNAorFNBSolidLesions',
												ISNULL(dbo.fnNED_FNAFNBTissueAdequacy(@ProcedureId),'Not Applicable') AS '@FNAorFNBTissueAdequacy'
											FROM ERS_UpperGIPremedication pm
												LEFT JOIN ERS_Sites s ON s.ProcedureId = pm.ProcedureId
												LEFT JOIN ERS_UpperGITherapeutics T ON S.SiteId = T.SiteId
												LEFT JOIN ERS_UpperGISpecimens AS SP  ON SP.SiteId = S.SiteId
												LEFT JOIN ERS_ERCPTherapeutics ET ON ET.SiteId = S.SiteId
											WHERE pm.ProcedureId = @ProcedureId) eushpb
								FOR XML PATH('EUS'),TYPE)  
						WHEN @ProcedureTypeId IN (8,9) THEN
							 (SELECT * FROM (SELECT DISTINCT 
								 (SELECT ISNULL(SUM(Detected),0) FROM tvfNED_PolypsTotalsView(@ProcedureId)) AS '@polypsDetected'
								 ,ISNULL(DA.NEDTerm,'None') as '@distalAttachment'
								 ,CASE WHEN LOWER(DA.NEDTerm) = 'other' THEN PDA.AdditionalInfo ELSE NULL END as '@distalAttachmentOther'
								 ,ISNULL(ET.NEDTerm,'None') as '@enteroscopyTechnique'
								 ,CASE WHEN LOWER(ET.NEDTerm) = 'other' THEN PET.AdditionalInfo ELSE NULL END as '@enteroscopyTechniqueOther'
								 ,PID.InsertionLength AS '@depthOfInsertion'
								 ,CASE PID.Tattooed WHEN 1 THEN 'Yes' WHEN 0 THEN 'No' ELSE 'Not Applicable' END AS '@tattooMaxDepthInsertion'
								 ,CASE WHEN PE.RectalExamPerformed = 1 AND ET.NEDTerm IN ('Single balloon anal','Double balloon anal') THEN 'Yes' ELSE 'No' END AS '@digitalRectalExamination'
									FROM ERS_Procedures AS P 
										LEFT JOIN ERS_ProcedureDistalAttachment PDA ON PDA.ProcedureId = P.ProcedureId
										LEFT JOIN ERS_DistalAttachments DA ON DA.UniqueId = PDA.DistalAttachmentId
										LEFT JOIN ERS_ProcedureEnteroscopyTechniques PET ON PET.ProcedureId = P.ProcedureId
										LEFT JOIN ERS_EnteroscopyTechniques ET ON ET.UniqueId = PET.TechniqueId
										LEFT JOIN ERS_ProcedureInsertionDepth PID ON PID.ProcedureId = P.ProcedureId
										LEFT JOIN ERS_ProcedureLowerExtent PE ON PE.ProcedureId = P.ProcedureId
									Where P.ProcedureId=@ProcedureId) ent
								FOR XML PATH('ENT'),TYPE)
					END
				  )
		from ERS_Procedures AS P 
		Where P.ProcedureId=@ProcedureId
		FOR XML PATH('procedure'), ROOT('procedures'), TYPE
		)	

    FROM dbo.ERS_Procedures AS P
    LEFT join dbo.ERS_ProcedureDiscomfortScore as DisNo on P.ProcedureId = DisNo.ProcedureId
    LEFT Join dbo.ERS_DiscomfortScores as Dis on DisNo.DiscomfortScoreId = Dis.UniqueId
	LEFT join dbo.ERS_PostProcedureDiscomfortScore PPD on PPD.ProcedureId = P.ProcedureId 
	LEFT join dbo.ERS_DiscomfortScores as PPDD on PPD.DiscomfortScoreId = PPDD.UniqueId
	Left join dbo.ers_lists as PatStat on PatStat.ListDescription = 'Patient Status' and PatStat.ListItemNo = P.PatientStatus 
	Left Join dbo.ERS_UrgencyTypes as Urgency on P.CategoryListId = Urgency.UniqueId
	Left join dbo.ERS_ProcedurePlannedExtent as PPE on P.ProcedureId = PPE.ProcedureId 
	Left Join dbo.ERS_Extent as Ext on PPE.ExtentId = Ext.UniqueId 
	Left join dbo.ERS_ProcedureInsufflation as PIns on P.ProcedureId = PIns.ProcedureId
	Left Join dbo.ERS_Insufflation as Ins on PIns.InsufflationId = Ins.UniqueId 
	Left Join dbo.ERS_ProviderSectors as PS on P.PatientType = PS.UniqueId 
	Left Join dbo.ERS_ReferrerTypes as RT on P.ReferrerType = RT.UniqueId 
	Left join dbo.ERS_ProviderOrganisation as PO on P.ProviderTypeId = PO.UniqueId 
	Left Join dbo.ERS_ProcedureAISoftware as PAIS on P.ProcedureId = PAIS.ProcedureId 
	Left Join dbo.ERS_AISoftware as AIS on PAIS.AISoftwareId = AIS.UniqueId 
	Left Join dbo.ERS_ProcedureChromendosopy as PCHR on PCHR.ProcedureId = p.ProcedureId


  INNER JOIN dbo.ERS_Patients			AS Pat  ON P.PatientId=Pat.[PatientId]
   LEFT JOIN dbo.tvfNED_ProcedureDrugList(@ProcedureId)	AS Drug		ON P.ProcedureId = Drug.ProcedureId	
   --LEFT JOIN dbo.ERS_UpperGIQA				AS QA   ON P.ProcedureId = QA.ProcedureId	-- Patient DIscomfort
   LEFT JOIN dbo.ERS_BowelPreparation		AS BP   ON P.ProcedureId=BP.ProcedureID	-- DIscomfort for Nurse
   LEFT JOIN dbo.ERS_ColonExtentOfIntubation   EL	ON P.ProcedureId = EL.ProcedureId
	   where P.ProcedureId= @ProcedureId
		 for XML PATH ('session'), ROOT('hospital.SendBatchMessage'), ELEMENTS
);

DECLARE   @xmlFileName AS varchar(100)
		, @ReportDate AS VARCHAR(10)
		, @ReportTime AS VARCHAR(8)
		, @xmlPreviousExportFileName AS VARCHAR(100);

SELECT    @ReportDate = CONVERT(VARCHAR(10), CreatedOn, 103)
		, @ReportTime = CONVERT(VARCHAR(8), ModifiedOn, 108) 
FROM dbo.ERS_Procedures WHERE ProcedureId=@ProcedureId;

--== Check whether Admin has added/removed the '\' at the end of the Path.. 
SET @ExportFolderPath = (CASE WHEN RIGHT(@ExportFolderPath, 1)='\' THEN @ExportFolderPath ELSE (@ExportFolderPath + '\') END);

SELECT top 1 @xmlPreviousExportFileName = xmlFileName FROM [dbo].[ERS_NedFilesLog] WHERE ProcedureId=@ProcedureId ORDER BY [LogId] desc;

--### File Path and Name example: 'NED_xml_output\74_22-09-2017_09-32-53_00831101o.xml' vs '99_19-10-2017_16-24-16_00205602e.xml'
SET @xmlFileName =    @ExportFolderPath 
					+ @site + '_' 
					+ replace(@ReportDate, '/', '-') + '_' 
					+ replace(@ReportTime, ':', '-') + '_' 
					+ @uniqueid	
					+ '.xml';					

SELECT @returnXML AS returnXML
				 , '<hospital.SendBatchMessage xmlns:xsd="http://www.w3.org/2001/XMLSchema"'
				  + 
				 ' xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"'
				  +
				 ' xmlns="https://www.jets.nhs.uk/schema/hospital.sendbatchmessage-version2.xsd"'
				  +
				 ' softwareVersion="2"' AS NS_Info		--## These extra info will be added to the Actual XML file in .NET while exporting;
				 , @xmlFileName AS xmlFileName
				 , IsNull(@xmlPreviousExportFileName, 'x') AS PreviousFileName;

END

GO


ALTER FUNCTION [dbo].[tvfNED_ProcedureIndication]
(
	@ProcedureId AS INT
)
-- =============================================
-- Description:	This will return the list of 'Indication' for each Procedure- required for NED Export!
-- =============================================
RETURNS TABLE 
AS
RETURN 
(
  Select 
		 ISNULL(NULLIF(dbo.HTMLDecode(EI.NEDTerm),''), 'Other') NEDTerm --any entry that does not have a NED term in the lookup table is to be treated as other
		, CASE WHEN EI.NEDTerm = 'Other' THEN EPI.AdditionalInformation ELSE NULL END AS Comment --where the NED term is blank, the description should be included in the other field
		, CASE WHEN EI.NEDTerm = 'FIT Positive' then CONVERT(decimal(18,2), EPI.AdditionalInformation) ELSE NULL END AS fitPositiveValue
		, CASE WHEN EI.NEDTerm = 'Elevated calprotectin' then EPI.AdditionalInformation ELSE NULL END AS elevatedCalprotectinValue
  from ERS_ProcedureIndications EPI
  join ERS_Indications EI on ISNULL(NULLIF(EPI.ChildIndicationId,0), EPI.IndicationId) = EI.UniqueId
  WHERE EPI.ProcedureId = @ProcedureId AND NEDTerm <> 'Other'
UNION ALL /*Below groups all 'Other' types into a single entry*/
 Select DISTINCT
		 'Other' NEDTerm 
		, (SELECT 
			 LTRIM(substring((SELECT ', ' + CASE WHEN EI.Description = 'Obstructed CBD/CHD' THEN 'Obstructed CBD/CHD' ELSE AdditionalInformation END
						 from ERS_ProcedureIndications EPI
						  inner join  ERS_Indications  EI on ISNULL(NULLIF(EPI.ChildIndicationId,0), EPI.IndicationId) = EI.UniqueId
						  WHERE EPI	.ProcedureId = @ProcedureId	
						  and NEDTerm = 'other' 
						 FOR XML PATH('')),2,4000))) AS Comment --where the NED term is blank, the description should be included in the other field
		, CASE WHEN EI.NEDTerm = 'FIT Positive' then CONVERT(decimal(18,2), EPI.AdditionalInformation) ELSE NULL END AS fitPositiveValue
		, CASE WHEN EI.NEDTerm = 'Elevated calprotectin' then EPI.AdditionalInformation ELSE NULL END AS elevatedCalprotectinValue
  from ERS_ProcedureIndications EPI
  join ERS_Indications EI on ISNULL(NULLIF(EPI.ChildIndicationId,0), EPI.IndicationId) = EI.UniqueId
  WHERE EPI.ProcedureId = @ProcedureId AND NEDTerm = 'Other'
UNION ALL
 SELECT 'FIT positive' NEDTerm
		, NULL AS Comment --where the NED term is blank, the description should be included in the other field
		, NULL AS fitPositiveValue
		, NULL AS elevatedCalprotectinValue
FROM dbo.ERS_ProcedureFitValue
WHERE ProcedureId = @ProcedureId AND FITValue <> '' AND ProcedureId NOT IN (SELECT procedureId 
																			FROM dbo.ERS_ProcedureIndications i 
																				INNER JOIN dbo.ERS_Indications ind ON ind.UniqueId = i.IndicationId 
																			WHERE i.ProcedureId = @ProcedureId AND ind.NEDTerm = 'FIT positive')

);
GO



------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------

---------- MH Added below function change on 10 Sep 2024 - Blackpool Site Title issue

EXEC DropIfExist 'fnGetSiteTitle', 'F';
GO

/****** Object:  UserDefinedFunction [dbo].[fnGetSiteTitle]    Script Date: 10/09/2024 10:28:05 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE FUNCTION [dbo].[fnGetSiteTitle] (@siteNo INT, @OperatingHospitalID TINYINT)
RETURNS
  VARCHAR(5)
AS
BEGIN
	DECLARE @site_no_ch VARCHAR(5)

	DECLARE @SiteIdentifier INT

	SELECT @SiteIdentifier = esc.SiteIdentification FROM dbo.ERS_SystemConfig esc WHERE OperatingHospitalID = @OperatingHospitalID

	IF @siteNo = 0
		SET @site_no_ch = ''
	ELSE
	BEGIN
		SELECT @SiteIdentifier = esc.SiteIdentification FROM dbo.ERS_SystemConfig esc WHERE OperatingHospitalID = @OperatingHospitalID

		IF @SiteIdentifier = 1
		BEGIN
			SET @site_no_ch = convert(varchar(5), @SiteNo)
		END
		ELSE
		BEGIN
			IF @siteNo <= 26
				SET @site_no_ch = CHAR(64+@siteNo)
			ELSE
			BEGIN
				DECLARE @div INT, @rem INT
				SET @div = @siteNo / 26
				SET @rem = @siteNo % 26
				IF @rem = 0 BEGIN SET @rem = 26 SET @div = @div - 1 END
				SET @site_no_ch = CHAR(64+@div) + CHAR(64+@rem)
			END
		END
	END
	RETURN @site_no_ch
END


Go

----MH Code finished.
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ahmed Shoud
-- TFS#	No TFS - Item 4166 
-- Description of change
-- Abnormalities Tree Save Function
------------------------------------------------------------------------------------------------------------------------

GO
EXEC dbo.DropIfExist @ObjectName = 'procedure_DICA_score_save',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)

GO
CREATE PROCEDURE [dbo].[procedure_DICA_score_save]
(
	@SiteId int,
	@ExtensionId int,
	@GradeId int,
	@InflammatorySignsId int,
	@ComplicationsId int,
	@LoggedInUserId int
)
AS
BEGIN
	IF NOT EXISTS (SELECT 1 FROM ERS_ProcedureDICAScores WHERE SiteId = @SiteId)
	BEGIN
		INSERT INTO ERS_ProcedureDICAScores (SiteId, ExtensionId, GradeId, InflammatorySignsId, ComplicationsId, WhoCreatedId, WhenCreated)
		VALUES (@SiteId, @ExtensionId, @GradeId, @InflammatorySignsId, @ComplicationsId, @LoggedInUserId, GETDATE())
	END
	ELSE
	BEGIN
		UPDATE ERS_ProcedureDICAScores
		SET SiteId = @SiteId,
			ExtensionId = @ExtensionId,
			GradeId = @GradeId,
			InflammatorySignsId = @InflammatorySignsId,
			ComplicationsId = @ComplicationsId,
			WhoUpdatedId = @LoggedInUserId,
			WhenUpdated = getdate()
		where SiteId = @SiteId 
	END
	EXEC abnormalities_colon_diverticulum_summary_update @SiteId
	EXEC abnormalities_mucosa_summary_update @SiteId
	EXEC sites_summary_update @SiteId
END
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	No TFS - Item 4166
------------------------------------------------------------------------------------------------------------------------




Go
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Mahfuz	On 15 Sep 2024
-- TFS#	2279
-- Description of change
-- Move PDFs out of the database into file storage (Blob Storage if Azure)
------------------------------------------------------------------------------------------------------------------------
Go

-- Creating New Table ERS_DataPurgeConfig

IF  Not EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[ERS_DocumentStorePDFRemovalLog]') AND type in (N'U'))
Begin
Print 'Creating New table ERS_DocumentStorePDFRemovalLog'
SET ANSI_NULLS ON

SET QUOTED_IDENTIFIER ON

CREATE TABLE dbo.ERS_DocumentStorePDFRemovalLog
	(
	PDFRemovalLogId int NOT NULL Identity(1,1) ,
	DocumentStoreId int NULL,
	ProcedureId int NULL,
	RemovalSuccess bit null,
	SuccessMessage varchar(200) null,
	FailureMessage varchar(2000) null,
	RemovalAttemptDateTime datetime null
	)  ON [PRIMARY]

ALTER TABLE dbo.ERS_DocumentStorePDFRemovalLog ADD CONSTRAINT
	PK_ERS_DocumentStorePDFRemovalLog PRIMARY KEY CLUSTERED 
	(
	PDFRemovalLogId
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]

End
Else
Begin
Print 'ERS_DocumentStorePDFRemovalLog table already exists'
End

Go

EXEC DropIfExist 'sp_LogPDFRemovalEvent','S';
GO
Create PROCEDURE [dbo].[sp_LogPDFRemovalEvent]
(
	@DocumentStoreId int,
	@ProcedureId int,
	@RemovalSuccess bit,
	@SuccessMessage varchar(200),
	@FailureMessage varchar(200)
)
AS
---------------------------------------------------------------------------------------
/*	Mahfuz created	On		12 Sep 2024 : TFS 2279 Move PDF out of database 		*/
/*			Updated On		 */
---------------------------------------------------------------------------------------
BEGIN

	--No need to set recovery mode simple here. This has been done inside console app in upper level

	Insert into ERS_DocumentStorePDFRemovalLog(DocumentStoreId,ProcedureId,RemovalSuccess,SuccessMessage,FailureMessage,RemovalAttemptDateTime)
	Values(@DocumentStoreId,@ProcedureId,@RemovalSuccess,@SuccessMessage,@FailureMessage,GETDATE())

	--DBCC Shrink Database will be executed after finishing the batch inside the console app in level

END
Go
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	2279 by Mahfuz
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	: Siddik
-- TFS#	3216
-- Description of change: Add Cytology to Cysto
-------------------------------------------------------------------------------------------------------------------------

EXEC dbo.DropIfExist 
    @ObjectName = 'specimens_cystoscopy_save', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[specimens_cystoscopy_save]
(
	@SiteId INT,
	@None BIT,
	@qunatity Int,
	@qunatityCytology INT,
	@forcepsDisposable BIT,
	@forcepsReusable BIT,
	@forcepsReusableSerialNumber NVARCHAR(100) ,
	@LoggedInUserId INT
)
AS

SET NOCOUNT ON

DECLARE @proc_id INT
DECLARE @proc_type INT

BEGIN TRANSACTION

BEGIN TRY
	SELECT 
		@proc_id = p.ProcedureId,
		@proc_type = p.ProcedureType
	FROM 
		ERS_Sites s
	JOIN 
		ERS_Procedures p ON s.ProcedureId = p.ProcedureId
	WHERE 
		SiteId = @SiteId

	IF (@None = 0 AND @qunatity = 0 AND @qunatityCytology = 0 AND @forcepsDisposable = 0 AND @forcepsReusable = 0 AND @forcepsReusableSerialNumber = 0)
	BEGIN

		DELETE FROM ERS_CystoscopySpecimens
		WHERE SiteId = @SiteId

		DELETE FROM ERS_RecordCount 
		WHERE SiteId = @SiteId
		AND Identifier = 'Specimens Taken'
	END

	ELSE
	BEGIN
		IF NOT EXISTS (SELECT 1 FROM ERS_CystoscopySpecimens WHERE SiteId = @SiteId)
		BEGIN
			INSERT INTO ERS_CystoscopySpecimens (
				SiteId,
				[None],
				qunatity,
				qunatityCytology,
				forcepsDisposable,
				forcepsReusable,
				forcepsReusableSerialNumber,
				WhoCreatedId,
				WhenCreated)
			VALUES (
				@SiteId,
				@None,
				@qunatity,
				@qunatityCytology,
				@forcepsDisposable,
				@forcepsReusable,
				@forcepsReusableSerialNumber,
				@LoggedInUserId,
				GETDATE())

			INSERT INTO ERS_RecordCount (
				[ProcedureId],
				[SiteId],
				[Identifier],
				[RecordCount]
			)
			VALUES (
				@proc_id,
				@SiteId,
				'Specimens Taken',
				1)
		END

		ELSE
		BEGIN
			UPDATE 
				ERS_CystoscopySpecimens
			SET 
				[None] = @None,
				qunatity = @qunatity,
				qunatityCytology = @qunatityCytology,
				forcepsDisposable = @forcepsDisposable,
				forcepsReusable = @forcepsReusable,
				forcepsReusableSerialNumber = @forcepsReusableSerialNumber,
				WhoUpdatedId = @LoggedInUserId,
				WhenUpdated = GETDATE()
			WHERE 
				SiteId = @SiteId
		END	

		EXEC specimens_cystoscopy_summary_update @SiteId
		
	END
	--edited by siddik tfs# 4183
	IF EXISTS (SELECT 1 FROM ERS_UpperGIFollowUp WHERE ProcedureId = @proc_id AND AwaitingPathologyResults = 1)
	BEGIN
		IF NOT EXISTS (SELECT 1 FROM ERS_CystoscopySpecimens sp JOIN ERS_Sites s ON sp.SiteId = s.SiteId WHERE s.ProcedureId = @proc_id AND None <> 1)
		BEGIN
			EXEC ogd_followup_save
				@ProcedureId = @proc_id,
				@AwaitingPathologyResults = 0,
				@LoggedInUserId = @LoggedInUserId;
		END
	END
	ELSE
	BEGIN
		IF EXISTS (SELECT 1 FROM ERS_CystoscopySpecimens sp JOIN ERS_Sites s ON sp.SiteId = s.SiteId WHERE s.ProcedureId = @proc_id AND None <> 1)
		BEGIN
			EXEC ogd_followup_save
				@ProcedureId = @proc_id,
				@AwaitingPathologyResults = 1,
				@LoggedInUserId = @LoggedInUserId;
		END
	END
	--tfs# 4183 end

	EXEC sites_summary_update @SiteId
END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;

GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	3216 END
-------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Siddik
-- TFS#	4207
-- Description of change: Patient Pathway Report
-------------------------------------------------------------------------------------------------------------------------

IF NOT EXISTS (SELECT 1 FROM ERS_AuditReports WHERE AuditReportDescription = 'Patient Pathway Report')
BEGIN
    INSERT INTO ERS_AuditReports (AuditReportDescription, AuditReportStoredProcedure, ReportModule)
    VALUES ('Patient Pathway Report', 'patientPathwayReport', 'R');
END
GO

EXEC dbo.DropIfExist 
    @ObjectName = 'auditPatientPathway', 
    @ObjectTypePrefix = 'S' 
GO

EXEC dbo.DropIfExist 
    @ObjectName = 'patientPathwayReport', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[patientPathwayReport]
(
    @UserId INT
)
AS
BEGIN
    DECLARE @FromDate DATE,
            @ToDate DATE,
            @TrustId INT,
            @columns NVARCHAR(MAX) = '',
            @sql NVARCHAR(MAX) = '';

    SELECT @FromDate = FromDate,
           @ToDate = ToDate,
           @TrustId = TrustId
    FROM ERS_ReportFilter
    WHERE UserID = @UserId;

	SELECT rc.ConsultantID 
	INTO #Consultants
	FROM ERS_ReportConsultants rc
	JOIN ERS_Users con on rc.ConsultantID = con.UserID 
	WHERE rc.UserID = @UserId;

	CREATE TABLE #PatientData (
		[Patient Name] NVARCHAR(255),
		[Hospital Number] NVARCHAR(50),
		[Age] INT,
		[Endoscopist 1] NVARCHAR(255),
		[Endoscopist 2] NVARCHAR(255),
		[Procedure Type] NVARCHAR(255),
		[Indications] NVARCHAR(MAX),
		[Diagnoses] NVARCHAR(MAX),
		[Specimens Taken] NVARCHAR(MAX),
		[Comments] NVARCHAR(MAX),
		[Question] NVARCHAR(255),
		[Answer] NVARCHAR(255)
	);

	SELECT procedureid, Summary 
	INTO #tbl_specimens 
	FROM ERS_Sites es 
	JOIN ERS_UpperGISpecimens up ON es.SiteId = up.SiteId;

	SELECT t1.procedureid, 
		STUFF((SELECT ', ' + t2.summary 
			   FROM #tbl_specimens t2 
			   WHERE t2.procedureid = t1.procedureid 
			   FOR XML PATH('')), 1, 1, '') AS Summaries 
	INTO #tbl_specimens_summary 
	FROM #tbl_specimens t1 
	GROUP BY t1.procedureid

	INSERT INTO #PatientData ([Patient Name], [Hospital Number], [Age], [Endoscopist 1], [Endoscopist 2], [Procedure Type], [Indications], [Diagnoses], [Specimens Taken], [Comments], [Question], [Answer])
	SELECT 
		epat.Surname + ' ' + epat.Forename1 AS [Patient Name], 
		epat.HospitalNumber AS [Hospital Number],
		DATEDIFF(YEAR, epat.DateOfBirth, GETDATE()) - IIF(GETDATE() < DATEADD(YEAR, DATEDIFF(YEAR, epat.DateOfBirth, GETDATE()), epat.DateOfBirth), 1, 0) AS [Age],
		eu.Title + ' ' + eu.Forename + ' ' + eu.Surname AS [Endoscopist 1],
		eu2.Title + ' ' + eu2.Forename + ' ' + eu2.Surname AS [Endoscopist 2],
		ept.ProcedureType AS [Procedure Type],
		STUFF((SELECT ', ' + Description FROM ERS_Indications WHERE UniqueId IN (SELECT IndicationId FROM ERS_ProcedureIndications WHERE ProcedureId = eproc.ProcedureId) FOR XML PATH(''), TYPE).value('.', 'NVARCHAR(MAX)'), 1, 2, '')  AS [Indications],
		epr.PP_Diagnoses AS [Diagnoses],
		esum.Summaries AS [Specimens Taken],
		eugif.Comments AS [Comments],
		epq.Question AS [Question],
		CASE epa.OptionAnswer WHEN 1 THEN 'Yes' WHEN 0 THEN 'No' WHEN -1 THEN 'Unknown' ELSE '' END +
		CASE WHEN ISNULL(epa.FreeTextAnswer, '') = '' OR epa.OptionAnswer IS NULL THEN '' ELSE ', ' END +
		ISNULL(epa.FreeTextAnswer, '')
		AS [Answer]

	FROM ERS_Procedures eproc
	JOIN ERS_Patients epat ON epat.PatientId = eproc.PatientId
	JOIN ERS_Users eu ON eu.UserID = eproc.Endoscopist1
	LEFT JOIN ERS_Users eu2 ON eu2.UserID = eproc.Endoscopist2
	JOIN ERS_ProcedureTypes ept ON ept.ProcedureTypeId = eproc.ProcedureType
	LEFT JOIN ERS_ProceduresReporting epr ON epr.ProcedureId = eproc.ProcedureId
	LEFT JOIN #tbl_specimens_summary esum ON esum.ProcedureId = eproc.ProcedureId
	LEFT JOIN ERS_UpperGIFollowUp eugif ON eugif.ProcedureId = eproc.ProcedureId
	LEFT JOIN ERS_ProcedurePathwayPlanAnswers epa ON epa.ProcedureId = eproc.ProcedureId 
	LEFT JOIN ERS_PathwayPlanQuestions epq ON epq.QuestionId = epa.QuestionId AND epq.Suppressed = 0
	JOIN #Consultants con ON con.ConsultantID = eproc.Endoscopist1
	WHERE eproc.CreatedOn >= @FromDate AND eproc.CreatedOn <= @ToDate
	ORDER BY eproc.CreatedOn

	SELECT @columns = STUFF((
		SELECT DISTINCT ', ' + QUOTENAME(Question)
		FROM #PatientData
		FOR XML PATH(''), TYPE
	).value('.', 'NVARCHAR(MAX)'), 1, 2, '');

	IF @columns IS NOT NULL
	BEGIN
		SET @sql = '
		SELECT [Patient Name], [Hospital Number], [Age], [Endoscopist 1], [Endoscopist 2], [Procedure Type], [Indications], [Diagnoses], [Specimens Taken], ' + @columns + ', [Comments]
		FROM (
			SELECT 
				[Patient Name], 
				[Hospital Number], 
				[Age], 
				[Endoscopist 1], 
				[Endoscopist 2], 
				[Procedure Type], 
				[Indications], 
				[Diagnoses], 
				[Specimens Taken], 
				[Question], 
				[Answer],
				[Comments] 
			FROM #PatientData
		) AS SourceTable
		PIVOT (
			MAX([Answer]) 
			FOR [Question] IN (' + @columns + ')
		) AS PivotTable;
		';

		EXEC sp_executesql @sql;
	END
	ELSE
	BEGIN
		SELECT [Patient Name], [Hospital Number], [Age], [Endoscopist 1], [Endoscopist 2], [Procedure Type], [Indications], [Diagnoses], [Specimens Taken], [Comments] 
		FROM #PatientData;
	END

	DROP TABLE #tbl_specimens;
	DROP TABLE #tbl_specimens_summary;
	DROP TABLE #PatientData;
	drop table #Consultants;
END

GO

EXEC dbo.DropIfExist 
    @ObjectName = 'pathway_plan_questions_suppress', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[pathway_plan_questions_suppress]
(
	@QuestionId int,
	@Suppress bit,
	@OperatingHospitalId INT
)
AS
SET NOCOUNT OFF;
BEGIN
	DECLARE @ProcedureType INT;
	DECLARE @Question VARCHAR(100);
	SELECT @ProcedureType = ProcedureType, @Question = Question FROM ERS_PathwayPlanQuestions WHERE QuestionId = @QuestionId;

	IF @Suppress = 1
	BEGIN
		UPDATE ERS_PathwayPlanQuestions
		SET Suppressed = 1,
		OrderById = 9999
		WHERE QuestionId = @QuestionId
		
		--reorder the questions
		DECLARE @tbl TABLE (RowId int, QuestionId int, OrderById int)

		INSERT INTO @tbl 
		SELECT ROW_NUMBER() OVER (ORDER BY OrderById), QuestionId, OrderById
		FROM ERS_PathwayPlanQuestions WHERE ProcedureType = @ProcedureType AND OperatingHospital = @OperatingHospitalId AND Suppressed = 0 ORDER BY OrderById

		UPDATE p
		SET p.OrderById = t.RowId
		FROM ERS_PathwayPlanQuestions p
		INNER JOIN @tbl t ON t.OrderById = p.OrderById
		AND p.ProcedureType = @ProcedureType AND p.OperatingHospital = @OperatingHospitalId

		--remove answers from report
		UPDATE ERS_ProceduresReporting
		SET PP_PathwayPlan = 
			STUFF(
				PP_PathwayPlan,
				CHARINDEX(@Question, PP_PathwayPlan), 
				CHARINDEX('<br />', PP_PathwayPlan, CHARINDEX(@Question, PP_PathwayPlan)) - CHARINDEX(@Question, PP_PathwayPlan) + LEN('<br />'), '')
		WHERE ProcedureId IN (SELECT ProcedureId FROM ERS_Procedures WHERE ProcedureType = @ProcedureType)
		AND PP_PathwayPlan LIKE '%' + @Question + '%';

	END
	ELSE IF @Suppress = 0
	BEGIN
		DECLARE @MaxCount Int
		SET @MaxCount = (SELECT COUNT(QuestionId) FROM ERS_PathwayPlanQuestions WHERE ProcedureType = @ProcedureType AND Suppressed = 0 AND OperatingHospital = @OperatingHospitalId)
		IF @MaxCount < 10
		BEGIN
			UPDATE ERS_PathwayPlanQuestions 
			SET Suppressed = 0, 
				OrderById = (SELECT ISNULL(MAX(OrderById), 0) + 1 FROM ERS_PathWayPlanQuestions WHERE ProcedureType = @ProcedureType AND OperatingHospital = @OperatingHospitalId AND Suppressed = 0)
			WHERE QuestionId = @QuestionId
		END
	END
END

Go

------------------------------------------------------------------------------------------------------------------------
-- TFS#	4207 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 20.9.24
-- TFS#	
-- Description of change
-- List slot id removed from cancelled appointment 
------------------------------------------------------------------------------------------------------------------------
GO



ALTER TRIGGER [dbo].[TR_Patient_Reformat_Case] ON [dbo].[ERS_Patients] FOR UPDATE, INSERT AS
SET NOCOUNT ON
DECLARE @ID int, @Deceased bit

SELECT @ID = INSERTED.PatientId, @Deceased = INSERTED.Deceased FROM INSERTED

UPDATE ERS_PATIENTS SET 
	SURNAME = dbo.fn_initcap(SURNAME),
	FORENAME1 = dbo.fn_initcap(FORENAME1),
	FORENAME2 = dbo.fn_initcap(FORENAME2),
	address1 = dbo.fn_initcap(address1),
	address2 = dbo.fn_initcap(address2),
	address3 = dbo.fn_initcap(address3),
	address4 = dbo.fn_initcap(address4)
WHERE PatientId = @ID

--Patient is deceased, cancel any future scheduled appointments
IF @Deceased = 1 
       UPDATE ERS_Appointments 
       SET AppointmentStatusId = [dbo].[fnSCHAppointmentStatusId]('C'), CancelReasonId = (SELECT CancelReasonId FROM ERS_CancelReasons WHERE Code = 'Deceased'), 
       CancelComment = 'System Generated, Patient Deceased', StaffCancelledId = 0, DateCancelled = GETDATE(), ListSlotId = NULL
       FROM ERS_Appointments APPT
       LEFT JOIN ERS_Patients P ON APPT.PatientId = P.PatientId
       LEFT JOIN ERS_AppointmentStatus APPTS ON APPT.AppointmentStatusId = APPTS.UniqueId
       WHERE P.PatientId = @ID
       AND  CONVERT(DATE,StartDateTime) >= CONVERT(DATE,P.DateOfDeath)
       AND ISNULL(APPTS.HDCKEY,'B') IN ('B','P','TCI','R') OR APPT.BookingTypeId = 1


------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO



------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ferdowsi Marufa
-- TFS#	  4390
-- Description of change
--Letters - Last Edited By is displaying
------------------------------------------------------------------------------------------------------------------------
GO
EXEC dbo.DropIfExist 
    @ObjectName = 'letSaveLetter', 
    @ObjectTypePrefix = 'S' 
GO
 
CREATE PROCEDURE [dbo].[letSaveLetter]
(
	@LetterQueueId int,
	@UserId int,
	@LetterContent varbinary(max),
	@EditLetterReasonId INT,
	@EditLetterReasonExtraInfo VARCHAR(MAX)
)
AS
BEGIN
		UPDATE ERS_LetterQueue 
		set	Edited = 1, 
			Printed = 1 , 
			PrintedDate = Getdate(),
			EditedLetterDate = Getdate(),
			EditedLetterContent = @LetterContent,
			WhoEdited = @UserId,
			WhoPrinted = @UserId,
		--If Edited after print
			EditedAfterPrint = CASE WHEN @EditLetterReasonId > 0 THEN 1 ELSE 0 END,
			EditAfterPrintReasonId = CASE WHEN @EditLetterReasonId > 0 THEN @EditLetterReasonId ELSE 0 END,
			EditAfterPrintReasonExtraInfo = ISNULL(@EditLetterReasonExtraInfo, EditAfterPrintReasonExtraInfo),
			EditedDateAfterPrint = Getdate() 
	WHERE LetterQueueId = @LetterQueueId
END



------------------------------------------------------------------------------------------------------------------------
-- END OF TFS# 4390
 
------------------------------------------------------------------------------------------------------------------------


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ferdowsi Marufa
-- TFS#	3658
-- Description of change
-- scheduling therapeutic only procedure 
------------------------------------------------------------------------------------------------------------------------
GO
UPDATE  ERS_ProcedureTypes SET SchedulerDiagnostic = 0 , SchedulerTherapeutic = 1 WHERE  ProcedureType IN ('EUS (OGD)','EUS (HPB)','EBUS')
GO
------------------------------------------------------------------------------------------------------------------------ 
-- END OF TFS# 3658
------------------------------------------------------------------------------------------------------------------------


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ferdowsi Marufa
-- TFS#	  4443
-- Description of change
-- Removed other abnormality from drop down in system settings
------------------------------------------------------------------------------------------------------------------------

GO
 UPDATE ERS_MenuMap SET Suppressed = 1 WHERE NodeName ='Other Abnormalities'
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS# 4443
 
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ferdowsi 9/25/2024
-- TFS#	3063
-- Description of change
--  appointment cancelled
--------------------------------------------------------------------------------------------------------------------------
EXEC dbo.DropIfExist 
    @ObjectName = 'sch_update_appointment_status', 
    @ObjectTypePrefix = 'S' 
GO
CREATE PROCEDURE [dbo].[sch_update_appointment_status]
(
	@AppointmentId INT,
	@HDCStatusKey VARCHAR(5),
	@LoggedInUserId int
)
AS
BEGIN
	UPDATE ERS_Appointments 
	SET AppointmentStatusId = (SELECT UniqueId FROM dbo.ERS_AppointmentStatus WHERE HDCKEY = @HDCStatusKey), 
		WhoUpdatedId = @LoggedInUserId, 
		WhenUpdated = GETDATE()
	WHERE AppointmentId = @AppointmentId
END

go

EXEC dbo.DropIfExist 
    @ObjectName = 'sch_get_day_diary', 
    @ObjectTypePrefix = 'S' 
GO
CREATE PROCEDURE [dbo].[sch_get_day_diary]
(
	@OperatingHospitalID INT,
	@DiaryDate DATETIME,
	@RoomIds VARCHAR(MAX)
)
AS

	IF OBJECT_ID ('tempdb..#tmpDiaryRooms') IS NOT NULL
		DROP TABLE #tmpDiaryRooms

	SELECT Item
	INTO #tmpDiaryRooms
	FROM dbo.fnSplitString(@RoomIds, ',')

	SELECT DISTINCT
		d.DiaryId,
		d.DiaryStart,
		CASE WHEN (SELECT MAX(DATEADD(MINUTE, CONVERT(int, ersa.AppointmentDuration), StartDateTime)) FROM ERS_Appointments ersa LEFT JOIN ERS_AppointmentStatus aps on aps.UniqueId = ersa.AppointmentStatusId WHERE ISNULL(aps.HDCKEY,'') NOT IN ('C','H','E') AND ersa.DiaryId = d.DiaryId) > d.DiaryEnd THEN (SELECT MAX(DATEADD(MINUTE, CONVERT(int, ersa.AppointmentDuration), StartDateTime)) FROM ERS_Appointments ersa  LEFT JOIN ERS_AppointmentStatus aps on aps.UniqueId = ersa.AppointmentStatusId WHERE ISNULL(aps.HDCKEY,'') NOT IN ('C','H','E') AND  ersa.DiaryId = d.DiaryId) ELSE d.DiaryEnd END AS DiaryEnd,
		d.[DiaryEnd] ActualDiaryEnd,
		d.[UserID], 
		d.[RoomID], 
		d.ListRulesId, 
		s.SlotMinutes AS [Minutes],
		CASE WHEN ept.ProcedureType IS NULL THEN ss.Description 
		ELSE 'Reserved for ' + ss.Description + ' '+ ept.ProcedureType END AS [Subject],
		ss.Description,
		ISNULL(s.ProcedureTypeID,0) AS ProcedureTypeID,
		s.ListSlotId,
		ss.ForeColor,
		ss.StatusId,
		ISNULL(s.Points, 1) AS Points,
		ISNULL(l.Endoscopist,0) AS EndoscopistId,
		(CASE WHEN  ISNULL(u.Title,'') <> '' THEN u.Title + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(u.Forename,'') <> '' THEN u.Forename + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(u.Surname,'') <> '' THEN u.Surname + ' ' ELSE '' END) as EndoscopistName,
	  (CASE WHEN  ISNULL(c.Title,'') <> '' THEN c.Title + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(c.Forename,'') <> '' THEN c.Forename + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(c.Surname,'') <> '' THEN c.Surname + ' ' ELSE '' END) as ListConsultant,
		l.ListName,
		(CASE WHEN  ISNULL(u.Title,'') <> '' THEN u.Title + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(u.Forename,'') <> '' THEN u.Forename + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(u.Surname,'') <> '' THEN u.Surname + ' ' ELSE '' END) +
	  '  [' + CONVERT(VARCHAR(5),cast(d.DiaryStart as time)) + '-' + CONVERT(VARCHAR(5),cast(d.[DiaryEnd] as time)) + ']' +
	  CASE WHEN  ISNULL(l.Points,0) <> 0 THEN '  [' + CONVERT(VARCHAR, l.Points) + ' slots]' ELSE '' END  AS ListDescription
		,d.suppressed
		,d.SuppressedFromDate
		,d.Training
		,l.GIProcedure
		,ISNULL(apt.AppointmentId, 0) AppointmentId
		,apt.StartDateTime AppointmentStart
		,ISNULL(apt.TotalPoints,0) AppointmentPoints
		,ISNULL(apt.AppointmentDuration,0) AppointmentDuration
		,DATEADD(minute, convert(int, apt.AppointmentDuration), apt.StartDateTime) AppointmentEnd
		,ISNULL(apt.StatusCode,'') AppointmentStatusCode
		,ISNULL(apt.Notes,'') AppointmentNotes
		,p.HospitalNumber + ' - ' + p.Forename1 + ' ' + p.Surname + '<br />' + apt.Description AS [AppointmentSubject]
		,STUFF(REPLACE(apt.Procs, CHAR(10), '+'), LEN(apt.procs),1,'') AS [AppointmentProcedures]
		,ISNULL(apt.GeneralInformation, '') GeneralInformation
		,CASE WHEN apt.AppointmentId IS NULL THEN s.Locked ELSE CASE WHEN ISNULL(apt.StatusCode,'') = 'BS' THEN 1 ELSE 0 END END AS Locked
		,d.OperatingHospitalId
		,ISNULL(d.RecurrenceParentID,0)RecurrenceParentID
		,ISNULL(d.locked,0) LockedDiary
		,r.RoomName
		,apt.StaffBooked,
		apt.DateBooked
	FROM ERS_SCH_DiaryPages d
		INNER JOIN #tmpDiaryRooms tr ON tr.Item = d.RoomID
		INNER JOIN dbo.ERS_SCH_Rooms r ON r.RoomId = tr.Item
		INNER JOIN ERS_SCH_ListRules l ON l.ListRulesId = d.ListRulesId
		INNER JOIN ERS_SCH_ListSlots s ON d.ListRulesId = s.ListRulesId AND s.Active = 1
		INNER JOIN dbo.ERS_SCH_SlotStatus ss ON ss.StatusId = s.SlotId
		LEFT JOIN dbo.ERS_ProcedureTypes ept ON s.ProceduretypeId = ept.ProcedureTypeId
		LEFT JOIN ERS_Users u ON u.UserID = d.UserId
		LEFT JOIN ERS_Users c ON c.UserID = d.ListConsultantId
		LEFT JOIN (SELECT ea.AppointmentId, SUM(eapt.Points) AS TotalPoints, SUM(eapt.Minutes) AS TotalMinutes, ea.ListSlotId, ea.DiaryId, 
					MAX(aps.HDCKEY) StatusCode, ass.Description, ea.PatientId, ea.GeneralInformation, ea.Notes, ea.AppointmentDuration,ea.StartDateTime,
					ISNULL(usr.Forename + ' ' + usr.Surname, '') AS StaffBooked, DateEntered as DateBooked,
						(SELECT
							AppointmentProcedures + char(10) AS [text()] 
						FROM dbo.SCH_AppointmentProcedures(ea.AppointmentId)
						WHERE AppointmentId = ea.AppointmentId
						FOR XML PATH('')) AS procs
					FROM dbo.ERS_Appointments ea
						INNER JOIN dbo.ERS_AppointmentProcedureTypes eapt ON ea.AppointmentId = eapt.AppointmentID
						INNER JOIN dbo.ERS_SCH_SlotStatus ass ON ea.SlotStatusID = ass.StatusId
						LEFT JOIN ERS_AppointmentStatus aps on aps.UniqueId = ea.AppointmentStatusId
						LEFT JOIN dbo.ERS_Users usr ON usr.UserID = ea.StaffBookedId
				--	 WHERE ISNULL(aps.HDCKEY,'') NOT IN ('C')  -- removed by Ferdowsi TFS 3063
					GROUP BY ea.AppointmentId, ea.ListSlotId, ea.DiaryId, ass.Description, ea.PatientId,ea.GeneralInformation, ea.Notes, ea.AppointmentDuration,ea.StartDateTime, usr.Forename,usr.Surname, DateEntered) AS apt 
											ON apt.DiaryId = d.DiaryId and  apt.ListSlotId = s.ListSlotId
		LEFT JOIN ERS_Patients p ON p.patientId = apt.PatientId
	WHERE d.OperatingHospitalId = @OperatingHospitalID AND convert(varchar(10), DiaryStart, 103) = convert(varchar(10), @DiaryDate, 103)
	AND d.Suppressed = 0
	ORDER BY d.DiaryId, apt.StartDateTime, s.ListSlotId

  GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS# 	 3063
--  
------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Siddik
-- TFS#	4215
-- Description of change: chagne of naming for post surgury selecting of duodemun not present
-------------------------------------------------------------------------------------------------------------------------

UPDATE ERS_DiagnosesMatrix
SET DisplayName = 'Duodenum not examined'
WHERE code = 'D108P1'
AND DisplayName <> 'Duodenum not examined'

GO
dbo.DropIfExist
    @ObjectName = 'abnormalities_postsurgery_summary_update',
    @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[abnormalities_postsurgery_summary_update]
(
	@SiteId INT
)
AS
	SET NOCOUNT ON

	DECLARE
		@summary VARCHAR(4000),
		@none BIT,
		@previousSurgery BIT,
		@surgicalProcedure SMALLINT,
		@surgicalProcedureFindings VARCHAR(1000),
		@duodenumPresent BIT,
		@jejunum BIT,
		@jejunumState TINYINT,
		@jejunumAbnormalText VARCHAR(500)

	SELECT 
		@none=[None],
		@surgicalProcedure=SurgicalProcedure,
		@surgicalProcedureFindings=(SELECT isnull(SurgicalProcedureFindings, '') as [text()] FOR XML PATH('')),
		@duodenumPresent=DuodenumPresent,
		@jejunumState=JejunumState,
		@jejunumAbnormalText=(SELECT isnull(JejunumAbnormalText, '') as [text()] FOR XML PATH(''))
	FROM
		ERS_UpperGIAbnoPostSurgery
	WHERE
		SiteId = @SiteId

	SET @Summary = ''

	IF @none = 1
		SET @summary = @summary + 'No evidence of previous surgery'
	
	ELSE 
	BEGIN
		IF @surgicalProcedure > 0
		BEGIN
			--SET @summary = @summary + 'surgical procedure - '

			SELECT @summary = @summary + [ListItemText]
			FROM ERS_Lists 
			WHERE [ListDescription] = 'Surgical procedures' 
			AND [ListItemNo] = @surgicalProcedure
		END

		IF ISNULL(@surgicalProcedureFindings, '') <> '' SET @summary = @summary + ' ' + @surgicalProcedureFindings

		IF @summary <> '' SET @summary = @summary + ', '

		IF @duodenumPresent = 1  SET @summary = @summary + 'duodenum not examined'	--TFS 4215

		IF @jejunumState > 0
		BEGIN
			IF @summary <> '' SET @summary = @summary + ', '
			ELSE SET @summary = @summary + 'jejunum '

			IF @jejunumState = 1 SET @summary = @summary + 'normal jejunum'
			ELSE IF @jejunumState = 2 
			BEGIN
				SET @summary = @summary + 'abnormal jejunum'
				IF @jejunumAbnormalText <> '' SET @summary = @summary + ' - ' + @jejunumAbnormalText
			END
			
		END
	END

	SET @Summary = LTRIM(RTRIM(@Summary))
	IF RIGHT(@Summary,1) = ',' SET @Summary = LEFT(@Summary, LEN(@Summary) - 1)
	--PRINT @summary

	-- Finally update the summary in abnormalities table
	UPDATE ERS_UpperGIAbnoPostSurgery
	SET Summary = @Summary 
	WHERE SiteId = @siteId
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS# 4215
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Siddik
-- TFS#	4237
-- Description of change: Oesophagus polyp mis spelling on diagnoses
-------------------------------------------------------------------------------------------------------------------------
GO

UPDATE ERS_DiagnosesMatrix 
SET DisplayName = 'Polyp(s)'
WHERE DisplayName IN ('Poylp', 'Polyp')

GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS# 4237
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Siddik
-- TFS#	3488
-- Description of change: Remove Day Patient 
-------------------------------------------------------------------------------------------------------------------------
GO

update ers_lists
set Suppressed = 1
where ListDescription = 'Patient Status'
and ListItemText = 'Day Patient'
and Suppressed <> 1

GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS# 3488
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Siddik
-- TFS#	3750
-- Description of change: add gastric balloon to OGD planned
-------------------------------------------------------------------------------------------------------------------------

IF NOT EXISTS (SELECT 1 FROM ERS_Indications WHERE Description = 'Balloon insertion')
BEGIN
	INSERT INTO ERS_Indications (Description, NEDTerm, IndicationSectionId)
	VALUES ('Balloon insertion', 'Balloon insertion', 5)
	
	INSERT INTO ERS_IndicationsProcedureTypes (IndicationId, ProcedureTypeId)
	VALUES (SCOPE_IDENTITY(), 1)
END

IF NOT EXISTS (SELECT 1 FROM ERS_Indications WHERE Description = 'Balloon removal')
BEGIN
	INSERT INTO ERS_Indications (Description, NEDTerm, IndicationSectionId)
	VALUES ('Balloon removal', 'Balloon removal', 5)
	
	INSERT INTO ERS_IndicationsProcedureTypes (IndicationId, ProcedureTypeId)
	VALUES (SCOPE_IDENTITY(), 1)
END

GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS# 3750
------------------------------------------------------------------------------------------------------------------------

Go
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Mahfuz	On 26 Sep 2024
-- TFS#	4446
-- Description of change
-- SE V2 Incorrect Polyp Detection Rate in GRS Colon Summary Report
------------------------------------------------------------------------------------------------------------------------
Go

EXEC DropIfExist 'report_JAGCOL','S';
GO
CREATE PROCEDURE [dbo].[report_JAGCOL] 
	@UserID INT
AS
/* Update History		
				:		08 Dec 2021			MH added filter out to elimiate Cancelled (DNA ) Procedures-
				:       17/05/2024			Partha  Filter by Hospital TFS1811
				:		07/09/2024			Ferdousi added work for TFS 4243
				:		26 Sep 2024			Mahfuz changed Polyp Detection Rate calculation - TFS 4446

*/


BEGIN
	DECLARE @ProcedureTypeId INT
	SET @ProcedureTypeId = 3

	DECLARE @FromDate as Date,
		@ToDate as Date,
		@ConsultantId as int,
			@TrustId as int,
			@OperatingHospitalList as varchar(100)



	SELECT rc.ConsultantID , con.Title + ' ' + con.Forename + ' ' + con.Surname AS Endoscopist, rc.AnonimizedID
	INTO #Consultants
	FROM ERS_ReportConsultants rc
	JOIN ERS_Users con on rc.ConsultantID = con.UserID 
	WHERE rc.UserID = @UserId

	Select	@FromDate = FromDate,
			@ToDate = ToDate,
			@TrustId = TrustId,
			@OperatingHospitalList=OperatingHospitalList
	FROM	ERS_ReportFilter
	where	UserID = @UserId

	SELECT  con.AnonimizedID AS AnonimizedID
				, con.Endoscopist as Endoscopist1
				, con.ConsultantId AS ReportID
				, con.Endoscopist AS Consultant
				, COUNT(DISTINCT p.ProcedureId) AS NumberOfProcedures
				, COUNT(DISTINCT CASE WHEN ISNULL(ple.RectalExamPerformed, 0) = 1 THEN p.ProcedureId END) * 1.0 / NULLIF(COUNT(DISTINCT P.ProcedureId), 0) AS DigiRectalExaminationP
				, COUNT(DISTINCT CASE WHEN ISNULL(ple.RetroflectionPerformed, 0) = 1 THEN p.ProcedureId END) * 1.0 / NULLIF(COUNT(DISTINCT P.ProcedureId), 0) AS RectalRetoversionRateP
				, COUNT(DISTINCT CASE WHEN eds.NEDTerm IN ('Moderate','Severe') THEN p.ProcedureId END) * 1.0 / NULLIF(COUNT(DISTINCT P.ProcedureId), 0) AS ComfortLevelModerateSevereDiscomfort
				, COUNT(DISTINCT CASE WHEN eds.NEDTerm IN ('Moderate','Severe') THEN p.ProcedureId END) * 1.0 / NULLIF(COUNT(DISTINCT P.ProcedureId), 0) AS ComfortLevelModerateSevereDiscomfortNurse
				, (SUM(DISTINCT ple.WithdrawalMins)/COUNT(DISTINCT p.ProcedureId)) AS MeanWithdrawalTime
				
				--, ISNULL(COUNT(DISTINCT CASE WHEN e.ListOrderBy <= 90 THEN s.SiteId END) * 1.0 / NULLIF(COUNT(CASE WHEN e.ListOrderBy <= 90 THEN s.SiteId END), 0),0) AS PolypDetectionRate --MH Changed as below on 26 Sep 2024
				,COUNT(Distinct Case When pds.ProcedureId IS NOT NULL then pds.ProcedureId End ) * 1.0 / COUNT(distinct p.ProcedureId) * 1.0 as PolypDetectionRate
				, COUNT(DISTINCT CASE WHEN e.ListOrderby <= 90 THEN p.ProcedureId END) * 1.0 / NULLIF(COUNT(DISTINCT P.ProcedureId), 0) AS UnadjustedCaecalIntubationRate
				, COUNT(DISTINCT CASE WHEN e.ListOrderby IN (60,70) THEN p.ProcedureId END)* 1.0 / NULLIF(COUNT(DISTINCT P.ProcedureId), 0) AS TerminalIlealIntubationRate
				
				,(SELECT COUNT(DISTINCT p.ProcedureId )  from [ERS_Procedures] p join [ERS_ProcedureIndications] pi ON pi.ProcedureId =  p.ProcedureId   -- added by Ferdowsi , TFS 4243
                 join ERS_Sites site ON p.ProcedureId = site.ProcedureId Join ERS_UpperGISpecimens s ON s.SiteId = site.SiteId  
                 JOIN ERS_Indications indi ON indi.UniqueId = pi.IndicationId WHERE( indi.Description like '%Looser or more frequent stool%') AND   s.Biopsy= 1  AND p.Endoscopist1 = con.ConsultantId ) AS DiagnosticRectalBiopsiesForUnexplainedDiarrohea -- added by Ferdowsi , TFS 4243

				, COUNT(DISTINCT CASE WHEN tl.Region NOT IN ('Rectum', 'Caecum') AND tl.TattooedId IN (2,3) THEN tl.RowId END)  * 1.0 / NULLIF(COUNT(DISTINCT tl.RowId),0) AS TattooingOfAllLesionsP
				, SUM(CASE WHEN pd.Retreived <> 0 AND pd.Successful <> 0 THEN convert(int,pd.Successful) END) * 1.0 / NULLIF(COUNT(pd.PolypDetailId),0) AS PolypRetrievalRateP
				, COUNT(CASE WHEN eds.NEDTerm IN ('Moderate','Severe') THEN '' END) * 1.0 / NULLIF(COUNT(DISTINCT P.ProcedureId), 0) AS ComfortLevelModerateSevereDiscomfort
				, COUNT(CASE WHEN eds.NEDTerm IN ('Moderate','Severe') THEN '' END) * 1.0 / NULLIF(COUNT(DISTINCT P.ProcedureId), 0) AS ComfortLevelModerateSevereDiscomfortNurse
				, dbo.CalcAnalgesiaLT70_New(con.ConsultantId, 'Midazolam', 0.5, 10.0, 1, min(@FromDate), max(@ToDate), @OperatingHospitalList) AS MedianSedationRateLT70Years_Midazolam
				, dbo.CalcAnalgesiaLT70_New(con.ConsultantId, 'Pethidine', 12.5, 200.0, 1, min(@FromDate), max(@ToDate), @OperatingHospitalList) AS MedianAnalgesiaRateLT70Years_Pethidine
				, dbo.CalcAnalgesiaLT70_New(con.ConsultantId, 'Fentanyl', 12.5, 200.0, 1, min(@FromDate), max(@ToDate), @OperatingHospitalList) AS MedianAnalgesiaRateLT70Years_Fentanyl
				, dbo.CalcAnalgesiaGT70_New(con.ConsultantId, 'Midazolam', 0.5, 10.0, 1, min(@FromDate), max(@ToDate), @OperatingHospitalList) AS MedianSedationRateGE70Years_Midazolam
				, dbo.CalcAnalgesiaGT70_New(con.ConsultantId, 'Pethidine', 12.5, 200.0, 1, min(@FromDate), max(@ToDate), @OperatingHospitalList) AS MedianAnalgesiaRateGE70Years_Pethidine
				, dbo.CalcAnalgesiaGT70_New(con.ConsultantId, 'Fentanyl', 12.5, 200.0, 1, min(@FromDate), max(@ToDate), @OperatingHospitalList) AS MedianAnalgesiaRateGE70Years_Fentanyl
				/*NO SEDATION*/
				, COUNT(distinct prof.ProcedureId) * 1.0 / NULLIF(COUNT( distinct p.procedureId), 0) as PropofolP
							, COUNT(DISTINCT CASE WHEN dru.Pethidine is null and dru.midazolam is null and dru.Fentanyl is null and dru.GeneralAnaesthetic is null THEN P.ProcedureId END) 
				* 1.0 / NULLIF(COUNT(DISTINCT CASE WHEN dru.GeneralAnaesthetic is null then P.ProcedureId END), 0) AS NoSedationP		
				--/* GTRecommededDose */
				, COUNT(DISTINCT CASE 
									WHEN (
											(P.Endoscopist1 = con.ConsultantId OR P.Endoscopist2 = con.ConsultantId) AND 
											(
												((CONVERT(int,CONVERT(char(8),GETDATE(),112))-CONVERT(char(8),pat.DateOfBirth,112))/10000 < 70 AND (
													(	(dru.Pethidine > 50) OR
														(dru.midazolam > 5) OR
														(dru.Fentanyl > 100))
													)
												) OR 
												(	
													((CONVERT(int,CONVERT(char(8),GETDATE(),112))-CONVERT(char(8),pat.DateOfBirth,112))/10000 >= 70 AND (
														(dru.Pethidine > 25) OR
														(dru.midazolam > 2.5) OR
														(dru.Fentanyl > 50))
													)	
												)
											)
										) THEN P.ProcedureId
								END) * 1.0 / NULLIF(COUNT(DISTINCT P.ProcedureId), 0) AS GTRecommededDose
	FROM #Consultants con
	JOIN ERS_Procedures p ON (con.ConsultantId = p.Endoscopist1 or (con.ConsultantId = p.Endoscopist2 and P.Endo2Role in (2, 3)))
	JOIN ERS_Patients pat on p.PatientId = pat.PatientId
	LEFT JOIN ERS_UpperGIPremedication prof on p.ProcedureId = prof.ProcedureId AND prof.DrugName = 'propofol' AND prof.Dose > 0
	LEFT JOIN ERS_UpperGIPremedication midazolam on p.ProcedureId = midazolam.ProcedureId AND midazolam.DrugName = 'midazolam'
	LEFT JOIN fw_ERS_Drugs as dru on P.ProcedureID = dru.ProcId
	LEFT JOIN ERS_ProcedureLowerExtent ple ON ple.ProcedureId = p.ProcedureId AND ple.EndoscopistId = CASE WHEN p.Endoscopist2 = con.ConsultantId AND p.Endo2Role IN (2,3) THEN con.ConsultantId ELSE ple.EndoscopistId END
	LEFT JOIN ERS_Extent e ON e.UniqueId = ple.ExtentId
	LEFT JOIN ERS_ExtentProcedureTypes ept ON ept.ExtentId = e.UniqueId AND ept.ProcedureTypeId = 3
	LEFT JOIN dbo.ERS_ProcedureDiscomfortScore epds ON p.ProcedureId = epds.ProcedureId
	LEFT JOIN dbo.ERS_DiscomfortScores eds ON epds.DiscomfortScoreId = eds.UniqueId
	LEFT JOIN ERS_ProcedureIndications pri ON pri.ProcedureId = p.ProcedureId
	LEFT JOIN ERS_Indications i ON i.UniqueId = pri.IndicationId
	LEFT JOIN ERS_Sites s ON s.ProcedureId = p.ProcedureId
	LEFT JOIN (SELECT S.ProcedureId, PolypDetailId, Retreived, Successful, Size, TattooedId, r.Region, s.SiteId
				FROM ERS_CommonAbnoPolypDetails pd 
					INNER JOIN ERS_Sites s ON pd.SiteId = s.SiteId 
					INNER JOIN ERS_PolypTypes pt ON pt.UniqueId = pd.PolypTypeId 
					INNER JOIN ERS_Regions r ON r.RegionId = s.RegionId
				WHERE LOWER(pt.[Description]) IN ('sessile','pedunculated','pseudo')) pd ON pd.ProcedureId = p.ProcedureId
	LEFT JOIN dbo.fw_TattooedLesions tl ON tl.SiteId = s.SiteId
	--MH added on 26 Sep 2024
	Left Join (select pr.ProcedureId,COUNT(pd.SiteId) as NoOfPolypSites
			From ERS_Procedures pr
			inner join ERS_Sites s on pr.ProcedureId = s.ProcedureId
			inner join ERS_CommonAbnoPolypDetails pd on s.SiteId = pd.SiteId
			Group by pr.ProcedureId) pds On p.ProcedureId = pds.ProcedureId

	WHERE p.ProcedureType = @ProcedureTypeId
		and p.ProcedureCompleted = 1
		and p.IsActive = 1
		and p.CreatedOn >= @FromDate AND p.CreatedOn <= @ToDate
		--MH added on 08 Dec 2021
		and IsNull(p.DNA,0) = 0
		AND P.OperatingHospitalID IN (SELECT * FROM dbo.splitString(@OperatingHospitalList,',') )--Partha , 17/05/2024 TFS1811
		--and pat.PatientId in (Select patientId from ERS_PatientTrusts where TrustId = @TrustId)
	GROUP BY con.Endoscopist, con.ConsultantId, con.AnonimizedID--, p.ProcedureId
	ORDER BY con.AnonimizedID 
END
Go
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	4446 by Mahfuz
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Muhammad Nasim
-- TFS#	3072
-- Description of change: Add to ERCP previous history
-------------------------------------------------------------------------------------------------------------------------
go
if not exists(select 1 from [dbo].[ERS_PreviousDiseases] where Description='Stent in place')
begin
	INSERT INTO [dbo].[ERS_PreviousDiseases]([Description],[AdditionalInfo],[Suppressed])
	VALUES('Stent in place',0,0)
	INSERT INTO [dbo].[ERS_PreviousDiseaseProcedureTypes]([PreviousDiseaseId],[ProcedureTypeId])
	VALUES(SCOPE_IDENTITY() ,2)
end
if not exists(select 1 from [dbo].[ERS_PreviousDiseases] where Description='Other')
begin
	INSERT INTO [dbo].[ERS_PreviousDiseases]([Description],[AdditionalInfo],[Suppressed])
	VALUES('Other',1,0)
	INSERT INTO [dbo].[ERS_PreviousDiseaseProcedureTypes]([PreviousDiseaseId],[ProcedureTypeId])
	VALUES(SCOPE_IDENTITY() ,2)
end
go

dbo.DropIfExist
    @ObjectName = 'patient_previous_disease_save',      -- varchar(100)
    @ObjectTypePrefix = 'S' -- varchar(5)
go
CREATE PROCEDURE [dbo].[patient_previous_disease_save]
(
	@ProcedureId int,
	@PatientId int,
	@PreviousDiseaseId int,
	@AdditionalInfo varchar(max),
	@Selected bit,
	@LoggedInUserId int
)
AS
BEGIN
	IF @Selected = 1 
	BEGIN
		IF NOT EXISTS (SELECT 1 FROM ERS_PatientPreviousDiseases WHERE PatientId = @PatientId AND PreviousDiseaseId = @PreviousDiseaseId)
		BEGIN
			INSERT INTO ERS_PatientPreviousDiseases (PatientId, PreviousDiseaseId,AdditionalInformation, ProcedureCreatedId, WhoCreatedId, WhenCreated)
			VALUES (@PatientId, @PreviousDiseaseId,@AdditionalInfo, @ProcedureId, @LoggedInUserId, getdate())
		END
		ELSE IF EXISTS (SELECT 1 FROM ERS_PatientPreviousDiseases WHERE PatientId = @PatientId AND PreviousDiseaseId = @PreviousDiseaseId AND AdditionalInformation <> @AdditionalInfo)
		BEGIN
			UPDATE ERS_PatientPreviousDiseases
			SET AdditionalInformation = @AdditionalInfo
			WHERE PatientId = @PatientId AND PreviousDiseaseId = @PreviousDiseaseId
		END
	END
	ELSE
	BEGIN
		DELETE FROM ERS_PatientPreviousDiseases WHERE PreviousDiseaseId = @PreviousDiseaseId AND PatientId = @PatientId
	END

	UPDATE ERS_ProceduresReporting
	SET PP_Indic = dbo.ProcedureIndicationsSummary(@ProcedureId)
	WHERE ProcedureId = @ProcedureId

	DECLARE @Summary VARCHAR(max) = 'Previous diseases',
			@DiseaseCount int = (SELECT count(*) FROM ERS_PatientPreviousDiseases WHERE (ProcedureCreatedId = @ProcedureId or ProcedureUpdatedId = @ProcedureId))

	EXEC UI_update_procedure_summary @ProcedureId, 'Previous diseases', @Summary, @DiseaseCount

END
go
dbo.DropIfExist
    @ObjectName = 'patient_previous_diseases_select',      -- varchar(100)
    @ObjectTypePrefix = 'S' -- varchar(5)
go
CREATE PROCEDURE [dbo].[patient_previous_diseases_select]
(
	@PatientId int
)
AS
BEGIN
	SELECT UniqueId, [Description],AdditionalInformation
	FROM ERS_PatientPreviousDiseases ppd
		INNER JOIN ERS_PreviousDiseases pd ON pd.UniqueId = ppd.PreviousDiseaseId
	WHERE PatientId = @PatientId
END
GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	3072 Ended
------------------------------------------------------------------------------------------------------------------------


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ferdowsi Marufa
-- TFS#	4235
-- Description of change
--  Moved Ulceration Miscellaneous to Oesophagitis

-- Updated by	:	Ahmed Shoud
-- TFS#	4395
-- Description of change
-- change of name on Inlet Pouch 
------------------------------------------------------------------------------------------------------------------------
GO

IF NOT EXISTS ( SELECT 1  FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ERS_UpperGIAbnoOesophagitis'  AND COLUMN_NAME = 'Ulceration')
BEGIN
      ALTER TABLE dbo.ERS_UpperGIAbnoOesophagitis ADD Ulceration bit DEFAULT 0 NOT NULL,UlcerationType bit DEFAULT 0 NOT NULL, 
	  UlcerationMultiple bit DEFAULT 0  NOT NULL, UlcerationQty smallint, UlcerationLength smallint,  UlcerationClotInBase bit DEFAULT 0  NOT NULL,
	  UlcerationReflux bit DEFAULT 0  NOT NULL, UlcerationPostSclero bit DEFAULT 0  NOT NULL, UlcerationPostBanding bit DEFAULT 0  NOT NULL;
END

GO
EXEC dbo.DropIfExist @ObjectName = 'fnRepOesoUlcer',      
                     @ObjectTypePrefix = 'F' 

GO

CREATE FUNCTION [dbo].[fnRepOesoUlcer] (@SiteId INT)
RETURNS VARCHAR(MAX)
AS
BEGIN

	DECLARE
		@summary VARCHAR(200),
		@temp VARCHAR(50),
		@None BIT,
		@Ulcer BIT,
		@Ulceration BIT,
		@UlcerationType BIT,
		@UlcerationMultiple BIT,
		@UlcerationQty SMALLINT,
		@UlcerationLength SMALLINT,
		@UlcerationClotInBase BIT,
		@UlcerationReflux BIT,
		@UlcerationPostSclero BIT,
		@UlcerationPostBanding BIT


	SELECT 
		@None				=	[None],
         @Ulcer                = Ulcer,
		@Ulceration				=	Ulceration,
		@UlcerationType			=	UlcerationType,
		@UlcerationMultiple		=	UlcerationMultiple,
		@UlcerationQty			=	UlcerationQty,
		@UlcerationLength		=	UlcerationLength,
		@UlcerationClotInBase	=	UlcerationClotInBase,
		@UlcerationReflux		=	UlcerationReflux,
		@UlcerationPostSclero	=	UlcerationPostSclero,
		@UlcerationPostBanding	=	UlcerationPostBanding
 
	FROM
		ERS_UpperGIAbnoOesophagitis
	WHERE
		SiteId = @SiteId

	SET @Summary = ''
	SET @temp = ''

	IF @None = 1
		SET @summary = '' --@summary + 'No varices'
	ELSE 
	BEGIN
		

		DECLARE @tmpUlcer TABLE(Val VARCHAR(MAX))
		DECLARE @arMisc TABLE(Val VARCHAR(MAX))
		DECLARE @XMLlist XML

		--If it hasn't already been reported
		--IF @OesoUlcer = 0
		--BEGIN 

		IF @Ulceration = 1
		BEGIN
		--What type of ulceration
		--Is ulcer of type grade 4
			IF @UlcerationReflux = 1
			BEGIN
				--but not Oesophagitis
				IF @Ulcer = 0
				BEGIN
					 INSERT INTO @tmpUlcer (Val) VALUES('reflux')
				END
			END
		

			IF @UlcerationPostSclero = 1 INSERT INTO @tmpUlcer (Val) VALUES('post sclerotherapy')
			IF @UlcerationPostBanding = 1 INSERT INTO @tmpUlcer (Val) VALUES('post banding')

			IF @UlcerationMultiple = 1
			BEGIN
				SET @Summary = 'multiple'
				SET @temp = 's'
			END
			ELSE IF @UlcerationQty > 0
			BEGIN
				IF @UlcerationQty = 1
				BEGIN
					SET @Summary = 'one'
					SET @temp = ''
				END
				ELSE
				BEGIN
					SET @Summary = CONVERT(VARCHAR, @UlcerationQty)
					SET @temp = 's'
				END
			END

			--Size
			DECLARE @length VARCHAR(30) = ''
			IF @UlcerationLength <> 0 SET @length = ' with length ' + CONVERT(VARCHAR,@UlcerationLength) + 'mm'

			IF (SELECT COUNT(Val) FROM @tmpUlcer) > 0
			BEGIN
				SET @Summary = @Summary + @length
				SET @XMLlist = (SELECT Val FROM @tmpUlcer FOR XML  RAW, ELEMENTS, TYPE)
				IF LEN(@Summary) > 0 SET @Summary = @Summary + ', '
				SET @Summary = 'ulcer' + @temp + ' (' + @Summary + dbo.fnBuildString(@XMLlist) 
			END
			ELSE
			BEGIN
				IF LEN(@Summary) > 0 SET @Summary = @Summary + ' '
				SET @Summary = @Summary + 'ulcer' + @temp + @length
			END

			

			--Clot present ?
			IF @UlcerationClotInBase = 1 SET @Summary = ISNULL(@Summary,'Ulcer') + ' with clot in base' 
			IF (SELECT COUNT(Val) FROM @tmpUlcer) > 0
			begin
				SET @Summary = @Summary + ' )'
			END
	         DELETE FROM @tmpUlcer
			IF LEN(LTRIM(RTRIM(@Summary))) > 0 
				INSERT INTO @tmpUlcer (Val) VALUES(@Summary)
			ELSE
				INSERT INTO @tmpUlcer (Val) VALUES('ulceration')


			IF (SELECT COUNT(Val) FROM @tmpUlcer) > 0
			BEGIN
				SET @XMLlist = (SELECT Val FROM @tmpUlcer FOR XML  RAW, ELEMENTS, TYPE)
				--SET @Summary = @Summary + dbo.fnBuildString(@XMLlist) + ' ulcer' + @temp
				SET @Summary = dbo.fnBuildString(@XMLlist) 
			END
		END 
	END

	RETURN @Summary
END
GO

EXEC dbo.DropIfExist 
    @ObjectName = 'abnormalities_oesophagitis_summary_update', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[abnormalities_oesophagitis_summary_update]
(
	@SiteId INT
)
AS
	SET NOCOUNT ON
	
		DECLARE
		@summary VARCHAR(8000),
		@temp VARCHAR(50),
		@None BIT,
		@MucosalAppearance TINYINT,
		@Reflux BIT,
		@ActiveBleeding BIT,
		@MSMGrade1 BIT,
		@MSMGrade2a BIT,
		@MSMGrade2b BIT,
		@MSMGrade3 BIT,
		@MSMGrade4 BIT,
		@MSMGrade5 BIT,
		@ShortOesophagus BIT,
		@Ulcer BIT,
		@Stricture BIT,
		@LAClassification TINYINT,
		@Other BIT,
		@SuspectedCandida BIT,
		@CausticIngestion BIT,
		@SuspectedHerpes BIT,
		@CorrosiveBurns BIT,
		@Eosinophilic BIT,
		@OtherTypeOther BIT,
		@OtherTypeOtherDesc VARCHAR(200),
		@SuspectedCandidaSeverity TINYINT,
		@CausticIngestionSeverity TINYINT,
		@SuspectedHerpesSeverity TINYINT,
		@CorrosiveBurnsSeverity TINYINT,
		@EosinophilicSeverity TINYINT,
		@Ulceration BIT,
		@UlcerationType BIT,
		@UlcerationMultiple BIT,
		@UlcerationQty SMALLINT,
		@UlcerationLength SMALLINT,
		@UlcerationClotInBase BIT,
		@UlcerationReflux BIT,
		@UlcerationPostSclero BIT,
		@UlcerationPostBanding BIT

		DECLARE @nonGrade5MSMText VARCHAR(200) = '',
				--@mMSM VARCHAR(50) = '',
				@sg2common VARCHAR(50) = '',
				@sg2common1 VARCHAR(50) = '',
				@Grade VARCHAR(50) = 'grade ',
				@sg1 VARCHAR(220) = '',
				@sg2 VARCHAR(220) = '',
				@sg2a VARCHAR(320) = '',
				@sg2b VARCHAR(320) = '',
				@sg3 VARCHAR(320) = '',
				@plus VARCHAR(10) = '',
				@Grade5BarrattsText VARCHAR(200) = '',
				@RefluxBleedingOnly VARCHAR(200) = ''

	SELECT 
		@None=[None],
		@MucosalAppearance = MucosalAppearance,
		@Reflux = ISNULL(Reflux,0),
		@ActiveBleeding = ISNULL(ActiveBleeding,0),
		@MSMGrade1 = ISNULL(MSMGrade1,0),
		@MSMGrade2a = ISNULL(MSMGrade2a,0),
		@MSMGrade2b = ISNULL(MSMGrade2b,0),
		@MSMGrade3 = ISNULL(MSMGrade3,0),
		@MSMGrade4 = ISNULL(MSMGrade4,0),
		@MSMGrade5 = ISNULL(MSMGrade5,0),
		@ShortOesophagus = ISNULL(ShortOesophagus,0),
		@Ulcer = ISNULL(Ulcer,0),
		@Stricture = ISNULL(Stricture,0),
		@LAClassification = LAClassification,
		@Other = Other,
		@SuspectedCandida = SuspectedCandida,
		@CausticIngestion = CausticIngestion,
		@SuspectedHerpes = SuspectedHerpes,
		@CorrosiveBurns = CorrosiveBurns,
		@Eosinophilic = Eosinophilic,
		@OtherTypeOther = OtherTypeOther,
		@Ulceration				=	Ulceration,
		@UlcerationType			=	UlcerationType,
		@UlcerationMultiple		=	UlcerationMultiple,
		@UlcerationQty			=	UlcerationQty,
		@UlcerationLength		=	UlcerationLength,
		@UlcerationClotInBase	=	UlcerationClotInBase,
		@UlcerationReflux		=	UlcerationReflux,
		@UlcerationPostSclero	=	UlcerationPostSclero,
		@UlcerationPostBanding	=	UlcerationPostBanding,
		@OtherTypeOtherDesc = (SELECT ISNULL(OtherTypeOtherDesc,'') as [text()] FOR XML PATH('')),
		@SuspectedCandidaSeverity = SuspectedCandidaSeverity,
		@CausticIngestionSeverity = CausticIngestionSeverity,
		@SuspectedHerpesSeverity = SuspectedHerpesSeverity,
		@CorrosiveBurnsSeverity = CorrosiveBurnsSeverity,
		@EosinophilicSeverity = EosinophilicSeverity
	FROM
		ERS_UpperGIAbnoOesophagitis
	WHERE
		SiteId = @SiteId

		 
	SET @Summary = ''
	SET @temp = ''
	--If 'No oesophagitis' then ...
	IF @None = 1
		SET @summary = @summary + 'No oesophagitis'
	
	ELSE IF @MucosalAppearance > 0 OR @Reflux = 1 OR @Other = 1
	BEGIN
        -- There IS Oesophagitis or Barrett's so ...
        -- nonMSMOesoText contains the non-MSM oesophagitis text
		DECLARE @tmpOeso TABLE(Val VARCHAR(MAX))

		DECLARE @tmpVal VARCHAR(500) = '',
				@LAClassText VARCHAR(300) = ''
		DECLARE @SC VARCHAR(50) = '',
				@SH VARCHAR(50) = '',
				@nonMSMOesoText VARCHAR(500) = '',
				@withText VARCHAR(20) = '',
				--@MA VARCHAR(50) = '',
				@Oeso VARCHAR(150) = '',
				@mMSM VARCHAR(150) = 'Modified Savary Miller ',
				@UlcerText VARCHAR(150) = ''
		DECLARE @XMLlist XML
				
		IF @Other = 1
		BEGIN
			-- Suspected candida
			IF @SuspectedCandida = 1
			BEGIN
				SET @SC = CASE @SuspectedCandidaSeverity
							WHEN 1 THEN 'mild '
							WHEN 2 THEN 'moderate '
							WHEN 3 THEN 'severe '
							ELSE ''
						END
				SET @SC = @SC + 'candida'
				INSERT INTO @tmpOeso (Val) VALUES(@SC)
			END
			--Suspected herpes
			IF @SuspectedHerpes = 1
			BEGIN
				SET @SH = ''
				SET @SH = CASE @SuspectedHerpesSeverity
							WHEN 1 THEN 'mild '
							WHEN 2 THEN 'moderate '
							WHEN 3 THEN 'severe '
							ELSE ''
						END
				SET @SH = @SH + 'herpes'
				INSERT INTO @tmpOeso (Val) VALUES(@SH)
			END
			-- Ulceration
			IF ISNULL(@Ulceration,0) = 1
		    BEGIN
			   IF @Ulceration = 1 SET @UlcerText = dbo.fnRepOesoUlcer(@SiteId)
			   IF @UlcerText <> '' INSERT INTO @tmpOeso (Val) VALUES (RTRIM(LTRIM(@UlcerText)))
		    END


			--'If either candida or herpes then add 'suspected'
			IF @SuspectedHerpes = 1 UPDATE @tmpOeso SET VAL = VAL + ' suspected' WHERE VAL LIKE '%herpes' --  SET @SH = @SH + ' suspected'
			ELSE IF @SuspectedCandida = 1  UPDATE @tmpOeso SET VAL = VAL + ' suspected' WHERE VAL LIKE '%candida' -- SET @SC = @SC + ' suspected'

			--IF @SuspectedHerpes = 1 INSERT INTO @tmpOeso (Val) VALUES(@SH)
			--IF @SuspectedCandida = 1 INSERT INTO @tmpOeso (Val) VALUES(@SC)

			--Caustic ingestion
			IF @CausticIngestion = 1
			BEGIN
				SET @tmpVal = ''
				SET @tmpVal = CASE @CausticIngestionSeverity
							WHEN 1 THEN 'mild '
							WHEN 2 THEN 'moderate '
							WHEN 3 THEN 'severe '
							ELSE ''
						END
				SET @tmpVal = @tmpVal + 'caustic ingestion'
				INSERT INTO @tmpOeso (Val) VALUES(@tmpVal)
			END

			--Corrosive ingestion burns
			IF @CorrosiveBurns = 1
			BEGIN
				SET @tmpVal = ''
				SET @tmpVal = CASE @CorrosiveBurnsSeverity
							WHEN 1 THEN 'mild '
							WHEN 2 THEN 'moderate '
							WHEN 3 THEN 'severe '
							ELSE ''
						END
				SET @tmpVal = @tmpVal + 'corrosive ingestion burns'
				INSERT INTO @tmpOeso (Val) VALUES(@tmpVal)
				print(11)
			END
			
			--Eosinophilic
			IF @Eosinophilic = 1
			BEGIN
				SET @tmpVal = ''
				SET @tmpVal = CASE @EosinophilicSeverity
							WHEN 1 THEN 'mild '
							WHEN 2 THEN 'moderate '
							WHEN 3 THEN 'severe '
							ELSE ''
						END
				SET @tmpVal = @tmpVal + 'eosinophilic'
				INSERT INTO @tmpOeso (Val) VALUES(@tmpVal)
			END
			
			--Other
			If @OtherTypeOther = 1 AND LTRIM(RTRIM(@OtherTypeOtherDesc)) <> ''
			BEGIN
				SET @tmpVal = ''
				SET @tmpVal = LTRIM(RTRIM(@OtherTypeOtherDesc))
				SET @tmpVal = dbo.fnFirstLetterUpper(@tmpVal)
				INSERT INTO @tmpOeso (Val) VALUES(@tmpVal)
			END
		END  --'Of Oesophagitis other

		--Mucosal appearance
		IF @MucosalAppearance > 0
		BEGIN
			SET @tmpVal = ''
			SET @tmpVal = CASE @MucosalAppearance
						WHEN 1 THEN 'normal mucosa'
						WHEN 2 THEN 'discrete erosion '
						WHEN 3 THEN 'discrete pseudomembranes '
						WHEN 4 THEN 'confluent ulceration '
						WHEN 5 THEN 'confluent pseudomembranes '
						ELSE ''
					END
			INSERT INTO @tmpOeso (Val) VALUES(@tmpVal)
			--IF @Reflux = 1 SET @temp = @temp + 'with '
		END

		SET @XMLlist = (SELECT Val FROM @tmpOeso FOR XML  RAW, ELEMENTS, TYPE)
		SET @nonMSMOesoText = dbo.fnBuildString(@XMLlist)

		--If there's only one of the above then the sentence will be concatenated with any others using the 'with' conjunction, else it will read 'together with'
		IF ISNULL((SELECT COUNT(Val) FROM @tmpOeso WHERE NOT VAL IS NULL),0) = 1
			SET @withText = ' with '
		ELSE IF ISNULL((SELECT COUNT(Val) FROM @tmpOeso WHERE NOT VAL IS NULL),0) <> 0
			SET @withText = ' together with '

		DECLARE @OesophagitisClassification BIT
		SELECT @OesophagitisClassification = ISNULL(OesophagitisClassification,0) FROM ERS_SystemConfig 
		WHERE OperatingHospitalID = 
			(SELECT OperatingHospitalID FROM ERS_Procedures WHERE ProcedureId = 
				(SELECT ProcedureId FROM ERS_Sites WHERE SiteId = @SiteId))

		--Which Oeso Classification?
		IF @LAClassification > 0 OR @OesophagitisClassification > 0
		BEGIN
			SET @tmpVal = ''
			SET @tmpVal = CASE @LAClassification
						WHEN 1 THEN 'grade A oesophagitis (mucosal breaks confined to the mucosal fold each no longer than 5mm'
						WHEN 2 THEN 'grade B oesophagitis (at least one mucosal break longer than 5mm confined to the mucosal fold but not continuous between two folds'
						WHEN 3 THEN 'grade C oesophagitis (mucosal breaks that are continuous between the tops of mucosal folds but not circumferential'
						WHEN 4 THEN 'grade D oesophagitis (extensive mucosal breaks engaging at least 75% of the oesophageal circumference'
						ELSE ''
					END
				
			IF @ActiveBleeding = 1 SET @tmpVal = @tmpVal + ' with active bleeding'
			IF @tmpVal > '' SET @tmpVal = @tmpVal + ')'

			DELETE @tmpOeso

			--If there's Short oesophagus
			IF @ShortOesophagus = 1 INSERT INTO @tmpOeso (Val) VALUES('short oesophagus')

			--If there's Ulceration
			IF @Ulcer = 1 INSERT INTO @tmpOeso (Val) VALUES('ulcer')

			IF @Stricture = 1 INSERT INTO @tmpOeso (Val) VALUES('stricture')
				
			SET @XMLlist = (SELECT Val FROM @tmpOeso FOR XML  RAW, ELEMENTS, TYPE)

			IF (SELECT COUNT(Val) FROM @tmpOeso) > 0 SET @tmpVal = @tmpVal + ' and ' + dbo.fnBuildString(@XMLlist)

			IF @tmpVal <> '' SET @LAClassText = dbo.fnFirstLetterUpper(@tmpVal)
		END
		ELSE
		BEGIN
			SET @tmpVal = ''

			DELETE FROM @tmpOeso

			If @MSMGrade5=1 SET @nonGrade5MSMText = @mMSM + 'grade 5. '

			--If the site has both reflux grade 5 and grade 4
			If @MSMGrade5=1 AND (@MSMGrade4=1 OR @MSMGrade3=1 OR @MSMGrade2b=1 OR @MSMGrade2a=1 OR @MSMGrade1=1) 
			BEGIN
				SET @nonGrade5MSMText = @nonGrade5MSMText + 'This is associated with '
				SET @mMSM = 'grade 4 '
			END

			--If the site is not 5 but is 4 or less
			If @MSMGrade5=0 AND (@MSMGrade4=1 OR @MSMGrade3=1 OR @MSMGrade2b=1 OR @MSMGrade2a=1 OR @MSMGrade1=1) 
			BEGIN
				SET @nonGrade5MSMText = @nonGrade5MSMText + @mMSM

				IF @MSMGrade4=1
				BEGIN
					SET @nonGrade5MSMText = @nonGrade5MSMText + 'grade 4 '
					SET @Grade = ''
					SET @mMSM = ''
				END
			END

			IF @MSMGrade4=1
			BEGIN
				SET @plus = ' plus '
				IF @ShortOesophagus=0 AND @Ulcer=0 AND @Stricture=0 
					SET @nonGrade5MSMText = @nonGrade5MSMText + @mMSM + 'chronic lesions'
			END

			--If there's Grade 4 Short oesophagus
			IF @ShortOesophagus=1 INSERT INTO @tmpOeso (Val) VALUES('short oesophagus')

			--If there's Grade 4 Ulceration
			IF @Ulcer=1  INSERT INTO @tmpOeso (Val) VALUES('ulcer')

			IF @Stricture=1  INSERT INTO @tmpOeso (Val) VALUES('stricture')

			IF (SELECT COUNT(Val) FROM @tmpOeso) > 0
			BEGIN
				SET @XMLlist = (SELECT Val FROM @tmpOeso FOR XML  RAW, ELEMENTS, TYPE)
				SET @nonGrade5MSMText = RTRIM(@nonGrade5MSMText) + ' ' + @mMSM + dbo.fnBuildString(@XMLlist)
			END 

			SET @sg2common = 'multiple erosions, non-circumferential, '
			SET @sg2common1 = 'affecting more than one longitudinal fold '

			IF @Grade <> ''
			BEGIN
				SET @sg1 = @Grade + '1 '
				SET @sg2 = @Grade + '2 '
				SET @sg2a = @Grade + '2a '
				SET @sg2b = @Grade + '2b '
				SET @sg3 = @Grade + '3 '
			END

			SET @sg1 = @sg1 + 'single or isolated erosion(s), oval or linear, but affecting only one longitudinal fold '
			SET @sg2 = @sg2 + @sg2common + @sg2common1
			SET @sg2a = @sg2a + @sg2common + 'without confluence, ' + @sg2common1
			SET @sg2b = @sg2b + @sg2common + 'with confluence, ' + @sg2common1
			SET @sg3 = @sg3 + 'circumferential erosion' 
				
			--If reflux grade 3, 2b, 2a or 1 then just report the grade description.
			If @MSMGrade3=1 SET @nonGrade5MSMText = @nonGrade5MSMText + @plus + @sg3
			If @MSMGrade2b=1 SET @nonGrade5MSMText = @nonGrade5MSMText + @plus + @sg2b
			If @MSMGrade2a=1 SET @nonGrade5MSMText = @nonGrade5MSMText + @plus + @sg2a
			If @MSMGrade1=1 SET @nonGrade5MSMText = @nonGrade5MSMText + @plus + @sg1

			IF LTRIM(RTRIM(@nonGrade5MSMText)) <> ''
			BEGIN
				IF @ActiveBleeding=1 SET @nonGrade5MSMText = @nonGrade5MSMText + ' and active bleeding'
			END
		END

        --'-----------------------------------------------------------------------------------------
        --' if any non Grade 5 has been reported then "active bleeding" has been already included,
        --' if any Grade 5 has been reported then now is the time to add "active bleeding",
        --' but if neither has been reported then it's just "reflux oesophagitis"
        --' (with or without active bleeding)
        --'-----------------------------------------------------------------------------------------
			
		IF LTRIM(RTRIM(@nonGrade5MSMText)) <> ''
		BEGIN
			IF LTRIM(RTRIM(@LAClassText)) = ''
			BEGIN
				IF @Reflux=1 SET @RefluxBleedingOnly = 'Reflux oesophagitis'  --'unspecified type of reflux (no MSM grade)

				IF @ActiveBleeding=1
				BEGIN
					IF @RefluxBleedingOnly <> '' SET @RefluxBleedingOnly = @RefluxBleedingOnly + ' with active bleeding'
					ELSE SET @RefluxBleedingOnly = 'Active bleeding'
				END
			END
		END

        --'If stricture has been reported check to see if scope could pass. Note stricture can
        --'only occur on MSM Grade 4 therefore text is added to nonGrade5MSMText
		--VB6 Code - StrictureReported variable will always be false


		--'complete the unspecified reflux sentence
		SET @RefluxBleedingOnly = dbo.fnAddFullStop(@RefluxBleedingOnly)
		
		IF @nonGrade5MSMText <> ''
		BEGIN
			--If there's non-MSM Oeso text to begin with then we need to combine sentences with the conjuction
			IF @nonMSMOesoText <> ''
				SET @summary = @nonMSMOesoText + @withText + @nonGrade5MSMText
			ELSE
				SET @summary = @nonGrade5MSMText

			IF  @ActiveBleeding=1 SET @Grade5BarrattsText =  ' and active bleeding'
		END
		ELSE
		BEGIN
			--'If there's LA Classification then ...
			IF @LAClassText <> '' 
			BEGIN
				SET @summary = @nonMSMOesoText + @withText + @LAClassText
				SET @LAClassText=''
			END
			ELSE
			BEGIN
				--'But if there's only Oesophagitis other
				SET @summary = @nonMSMOesoText
			END

		END
	END

	SET @Summary = LTRIM(RTRIM(@Summary))
	IF RIGHT(@Summary,1) = '.' SET @Summary = LEFT(@Summary, LEN(@Summary) - 1)
	-- Finally update the summary in abnormalities table
	UPDATE ERS_UpperGIAbnoOesophagitis
	SET Summary = @Summary 
	WHERE SiteId = @siteId

Go
EXEC dbo.DropIfExist 
@ObjectName = 'abnormalities_miscellaneous_summary_update', 
@ObjectTypePrefix = 'S' 

GO
CREATE PROCEDURE [dbo].[abnormalities_miscellaneous_summary_update]
(
	@SiteId INT
)
AS
	SET NOCOUNT ON

	DECLARE
		@Summary VARCHAR(1200),
		@temp VARCHAR(50),
		@OesoUlcer BIT,
		@None BIT,
		@Web BIT,
		@Mallory BIT,
		@SchatzkiRing BIT,
		@FoodResidue BIT,
		@Foreignbody BIT,
		@ExtrinsicCompression BIT,
		@Diverticulum BIT,
		@DivertMultiple BIT,
		@DivertQty SMALLINT,
		@Pharyngeal BIT,
		@DiffuseIntramural BIT,
		@TractionType BIT,
		@PulsionType BIT,
		@MotilityDisorder BIT,
		@ProbableAchalasia BIT,
		@ConfirmedAchalasia BIT,
		@Presbyoesophagus BIT,
		@MarkedTertiaryContractions BIT,
		@LaxLowerOesoSphincter BIT,
		@TortuousOesophagus BIT,
		@DilatedOesophagus BIT,
		@MotilityPoor BIT,
		@Stricture BIT,
		@StrictureCompression TINYINT,
		@StrictureScopeNotPass BIT,
		@StrictureSeverity TINYINT,
		@StrictureType SMALLINT,
		@StrictureProbably BIT,
		@StrictureBenignType TINYINT,
		@StrictureBeginning SMALLINT,
		@StrictureLength SMALLINT,
		@StricturePerforation TINYINT,
		@Tumour BIT,
		@TumourType TINYINT,
		@TumourProbably BIT,
		@TumourExophytic TINYINT,
		@TumourBenignType TINYINT,
		@TumourBenignTypeOther NVARCHAR(100),
		@TumourBeginning SMALLINT,
		@TumourLength SMALLINT,
		@MiscOther NVARCHAR(150),
		@IsLAClassification BIT,
		@InletPatch BIT,
		@InletPatchMultiple BIT,
		@InletPatchQty SMALLINT,
		@Fitsula BIT,
		@InletPouch BIT,		
		@InletPouchQty SMALLINT,
		@ZLine BIT,
		@ZLineSize INT,
		@Volvulus BIT,
		@AmpullaryAdenoma BIT,
		@StentOcclusion BIT,
		@StentInSitu BIT,
		@PEGInSitu BIT

	SELECT 
		@None				=	[None],
		@Web				=	Web,
		@Mallory			=	Mallory,
		@SchatzkiRing		=	SchatzkiRing,
		@FoodResidue		=	FoodResidue,
		@Foreignbody 		= 	Foreignbody,
		@ExtrinsicCompression	=	ExtrinsicCompression,
		@Diverticulum		=	Diverticulum,
		@DivertMultiple		=	DivertMultiple,
		@DivertQty			=	DivertQty,
		@Pharyngeal			=	Pharyngeal,
		@DiffuseIntramural	=	DiffuseIntramural,
		@TractionType		=	TractionType,
		@PulsionType		=	PulsionType,
		@MotilityDisorder	=	MotilityDisorder,
		@ProbableAchalasia	=	ProbableAchalasia,
		@ConfirmedAchalasia	=	ConfirmedAchalasia,
		@Presbyoesophagus	=	Presbyoesophagus,
		@MarkedTertiaryContractions	=	MarkedTertiaryContractions,
		@LaxLowerOesoSphincter		=	LaxLowerOesoSphincter,
		@TortuousOesophagus		=	TortuousOesophagus,
		@DilatedOesophagus		=	DilatedOesophagus,
		@MotilityPoor			=	MotilityPoor,
		@Stricture				=	Stricture,
		@StrictureCompression	=	StrictureCompression,
		@StrictureScopeNotPass	=	StrictureScopeNotPass,
		@StrictureSeverity		=	StrictureSeverity,
		@StrictureType			=	StrictureType,
		@StrictureProbably		=	StrictureProbably,
		@StrictureBenignType	=	StrictureBenignType,
		@StrictureBeginning		=	StrictureBeginning,
		@StrictureLength		=	StrictureLength,
		@StricturePerforation	=	StricturePerforation,
		@Tumour					=	Tumour,
		@TumourType				=	TumourType,
		@TumourProbably			=	TumourProbably,
		@TumourExophytic		=	TumourExophytic,
		@TumourBenignType		=	TumourBenignType,
		@TumourBenignTypeOther	=	(SELECT isnull(TumourBenignTypeOther, '') as [text()] FOR XML PATH('')),
		@TumourBeginning		=	TumourBeginning,
		@TumourLength			=	TumourLength,
		@MiscOther				=	MiscOther,
		@IsLAClassification		=	ISNULL(IsLAClassification,0),
		@InletPatch				=	InletPatch,
		@InletPatchMultiple		=	InletPatchMultiple,
		@InletPatchQty			=	InletPatchQty,
		@Fitsula				=	Fitsula,
		@InletPouch				=	InletPouch,		
		@InletPouchQty			=	InletPouchQty,
		@ZLine					=	ZLine,
		@ZLineSize				=	ZLineSize,
		@Volvulus				=	Volvulus,
		@AmpullaryAdenoma		=	AmpullaryAdenoma,
		@StentOcclusion			=	StentOcclusion,
		@StentInSitu			=	StentInSitu,
		@PEGInSitu				=	PEGInSitu

	FROM
		ERS_UpperGIAbnoMiscellaneous
	WHERE
		SiteId = @SiteId

	SET @Summary = ''

	IF @None = 1
		SET @Summary = '' --@Summary + 'No varices'
	ELSE 
	BEGIN

		DECLARE @tmpMisc	TABLE(Val VARCHAR(MAX))
		DECLARE @tmpMiscTAR TABLE(Val VARCHAR(MAX))
		DECLARE @UlcerText VARCHAR(500)
		DECLARE @StrictText VARCHAR(500)
		DECLARE @TumourText VARCHAR(500)
		DECLARE @a VARCHAR(500) = ''
		DECLARE @XMLlist XML
		DECLARE @br VARCHAR(7) = '<br />'
		DECLARE @indent VARCHAR(10) = '&nbsp;- ';

		--This line will be ignored in funtion dbo.fnBuildString at the end
		INSERT INTO @tmpMisc (Val) VALUES('~~NoCommas~~')

		IF ISNULL(@Tumour,0) = 1
		BEGIN
			SET @TumourText = dbo.fnRepOesoTumour(@SiteId)
			IF @TumourText <> '' INSERT INTO @tmpMisc (Val) VALUES(@indent + dbo.fnFirstLetterUpper(RTRIM(LTRIM(@TumourText))) + '.' + @br)
		END

		IF ISNULL(@Stricture,0) = 1
		BEGIN
			SET @StrictText = dbo.fnRepOesoStricture(@SiteId)
			IF @StrictText <> '' INSERT INTO @tmpMisc (Val) VALUES(@indent + dbo.fnFirstLetterUpper(RTRIM(LTRIM(@StrictText))) + '.' + @br)
		END

		--IF ISNULL(@TumourText,'') <> '' AND ISNULL(@StrictText,'') <> '' 
		--	SET @a = @TumourText + '. <br />' + @StrictText
		--ELSE
		--SET @a = RTRIM(LTRIM(ISNULL(@TumourText,'') + ISNULL(@StrictText,'')))

		--IF @a <> '' INSERT INTO @tmpMisc (Val) VALUES(@a)

		IF @Web = 1				INSERT INTO @tmpMiscTAR (Val) VALUES('web')
		IF @Mallory = 1			INSERT INTO @tmpMiscTAR (Val) VALUES('Mallory-Weiss tear')
		IF @SchatzkiRing = 1	INSERT INTO @tmpMiscTAR (Val) VALUES('Schatzki ring')
		--IF @ExtrinsicCompression = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('extrinsic compression')
		IF @FoodResidue = 1		INSERT INTO @tmpMiscTAR (Val) VALUES('food residue')
		IF @Foreignbody = 1		INSERT INTO @tmpMiscTAR (Val) VALUES('foreign body')
		IF @Fitsula = 1		INSERT INTO @tmpMiscTAR (Val) VALUES('fitsula')
		IF @AmpullaryAdenoma = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('ampullary adenoma')
		IF @StentOcclusion = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('stent occlusion')
		IF @StentInSitu = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('stent in situ')
		IF @PEGInSitu = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('PEG in situ')
		IF @InletPatch = 1 
		BEGIN
			SET @a = 'inlet patch '
			IF @InletPatchMultiple = 1
				SET @a = @a + 'multiple: '
			ELSE
				SET @a = @a + ': '
			
			IF ISNULL(@InletPatchQty,0) > 0
			BEGIN
				SET @a= @a + CONVERT(VARCHAR, @InletPatchQty) + ' mm'
			END

			INSERT INTO @tmpMiscTAR(Val) VALUES	(@a)
		END

		IF @InletPouch = 1 
		BEGIN
			SET @a = ''
			IF ISNULL(@InletPouchQty,0) > 0
			BEGIN
				IF ISNULL(@InletPouchQty,0) = 1 SET @a='pharyngeal pouch is one mm' -- TFS 4395
				ELSE SET @a='pharyngeal pouch: ' + CONVERT(VARCHAR, @InletPouchQty) + 'mm ' -- TFS 4395
			END

			INSERT INTO @tmpMiscTAR(Val) VALUES	(@a)
		END

		SET @a = ''

		IF @ZLine = 1 
		BEGIN
			SET @a = 'squamocolumnar (Z Line)'
			IF ISNULL(@ZLineSize,0) > 0
			BEGIN
				SET @a='squamocolumnar (Z Line): ' + CONVERT(VARCHAR, @ZLineSize) + 'cm '
			END

			INSERT INTO @tmpMiscTAR (Val) VALUES(@a)
		END

		SET @a = ''

		IF @Volvulus = 1	INSERT INTO @tmpMiscTAR (Val) VALUES('Volvulus')

		IF (SELECT COUNT(Val) FROM @tmpMiscTAR) > 0 
		BEGIN
			SET @XMLlist = (SELECT Val FROM @tmpMiscTAR FOR XML  RAW, ELEMENTS, TYPE)
			INSERT INTO @tmpMisc (Val) VALUES(@indent + dbo.fnFirstLetterUpper(dbo.fnBuildString(@XMLlist)) + '.' + @br)
			DELETE FROM @tmpMiscTAR
		END

		IF @MotilityDisorder = 1
		BEGIN
			IF @ProbableAchalasia = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('probable achalasia')
			IF @ConfirmedAchalasia = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('confirmed achalasia')
			IF @MarkedTertiaryContractions = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('marked tertiary contractions')
			IF @Presbyoesophagus = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('presbyoesophagus')
			IF @LaxLowerOesoSphincter = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('lax lower oesophageal sphincter')
			IF @TortuousOesophagus = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('tortuous oesophagus')
			IF @DilatedOesophagus = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('dilated oesophagus')
			IF @MotilityPoor = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('poor motility')

			IF (SELECT COUNT(Val) FROM @tmpMiscTAR) > 0 
			BEGIN
				SET @XMLlist = (SELECT Val FROM @tmpMiscTAR FOR XML  RAW, ELEMENTS, TYPE)
				INSERT INTO @tmpMisc (Val) VALUES(@indent + dbo.fnFirstLetterUpper(dbo.fnBuildString(@XMLlist)) + '.' + @br)
				DELETE FROM @tmpMiscTAR
			END
			ELSE --None selected
				INSERT INTO @tmpMisc (Val) VALUES(@indent + dbo.fnFirstLetterUpper('motility disorder') + '.' + @br)
		END


		SET @a = ''

		IF @Diverticulum = 1
		BEGIN
			IF @Pharyngeal = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('pharyngeal (Zenker''s)')
			IF @TractionType = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('traction type')
			IF @PulsionType = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('pulsion type')
			IF @DiffuseIntramural = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('diffuse intramural')

			IF @DivertMultiple = 1 
				SET @a = 'diverticula: Multiple '
			ELSE IF ISNULL(@DivertQty,0) > 0
			BEGIN
				IF ISNULL(@DivertQty,0) = 1 SET @a = 'one diverticulum'
				ELSE SET @a = 'diverticula: ' + CONVERT(VARCHAR, @DivertQty) + ' '
			END
			ELSE 
				SET @a = 'diverticulum: '
			
			IF (SELECT COUNT(Val) FROM @tmpMiscTAR) > 0
			BEGIN
				IF LEFT(@a,3) = 'one' SET @a = @a + ', '
				SET @XMLlist = (SELECT Val FROM @tmpMiscTAR FOR XML  RAW, ELEMENTS, TYPE)
				SET @a =  @a + dbo.fnBuildString(@XMLlist)
			END

			IF LEN(@a) > 0 
			BEGIN
				SET @a = RTRIM(LTRIM(@a))
				IF RIGHT(@a,1) = ':' SET @a = LEFT(@a, LEN(@a) - 1)
				INSERT INTO @tmpMisc (Val) VALUES(@indent + dbo.fnFirstLetterUpper(@a) + '.' + @br)
				DELETE FROM @tmpMiscTAR
			END
		END

		
		IF ISNULL(@MiscOther,'') <> '' 
			INSERT INTO @tmpMisc (Val) VALUES(@indent + dbo.fnFirstLetterUpper(RTRIM(@MiscOther)) + @br)

		SET @XMLlist = (SELECT Val FROM @tmpMisc FOR XML  RAW, ELEMENTS, TYPE)
		SET @Summary = dbo.fnBuildString(@XMLlist)

		IF @Summary <> '' 
		BEGIN
			SET @Summary = LTRIM(RTRIM(@Summary))
			--Remove the first indent as this will be done in SP sites_summary_update
			IF LEFT(@Summary,8) = @indent SET @Summary = RIGHT(@Summary, LEN(@Summary) - 8)
			IF RIGHT(@Summary,6) = @br SET @Summary = LEFT(@Summary, LEN(@Summary) - 6)
			IF RIGHT(@Summary,1) = '.' SET @Summary = LEFT(@Summary, LEN(@Summary) - 1)
		END
	END

	-- Finally update the summary in abnormalities table
	UPDATE ERS_UpperGIAbnoMiscellaneous
	SET Summary = @Summary 
	WHERE SiteId = @siteId

GO
EXEC dbo.DropIfExist 
@ObjectName = 'get_Ulcerdata_MiscellaneousToOesophagus', 
@ObjectTypePrefix = 'S' 

GO
CREATE PROCEDURE [dbo].[get_Ulcerdata_MiscellaneousToOesophagus]
(
	@SiteId INT	
)
AS
BEGIN
SET NOCOUNT ON

DECLARE 
    @MiscellaneousUlceration BIT = 0,
	@OesophagitisUlceration BIT= 0,
	@UlcerationType BIT,
	@UlcerationMultiple BIT,
	@UlcerationQty INT,
	@UlcerationLength INT,
	@UlcerationClotInBase BIT,
	@UlcerationReflux BIT,
	@UlcerationPostSclero BIT,
	@UlcerationPostBanding BIT   

SELECT 
    @MiscellaneousUlceration = Miscellaneous.Ulceration, 
    @OesophagitisUlceration = Oesophagitis.Ulceration
FROM 
    ERS_UpperGIAbnoMiscellaneous AS Miscellaneous
JOIN 
    ERS_UpperGIAbnoOesophagitis AS Oesophagitis
    ON Miscellaneous.SiteId = Oesophagitis.SiteId
WHERE 
    Miscellaneous.SiteId = @SiteId;
 
 IF  @MiscellaneousUlceration =1  AND @OesophagitisUlceration <> 1
 BEGIN

 -- select data from ERS_UpperGIAbnoMiscellaneous
    SELECT
	@MiscellaneousUlceration = Ulceration, @UlcerationType = UlcerationType, @UlcerationMultiple = UlcerationMultiple, @UlcerationQty = UlcerationQty,
	@UlcerationLength = UlcerationLength, @UlcerationClotInBase = UlcerationClotInBase, @UlcerationReflux = UlcerationReflux, @UlcerationPostSclero = UlcerationPostSclero,
	@UlcerationPostBanding = UlcerationPostBanding FROM ERS_UpperGIAbnoMiscellaneous  WHERE SiteId = @SiteId


 -- Update  ERS_UpperGIAbnoOesophagitis according to ERS_UpperGIAbnoMiscellaneous

      UPDATE ERS_UpperGIAbnoOesophagitis  SET Ulceration = @MiscellaneousUlceration, UlcerationType = @UlcerationType,  UlcerationMultiple = @UlcerationMultiple,
  	  UlcerationQty = @UlcerationQty, UlcerationLength = @UlcerationLength, UlcerationClotInBase = @UlcerationClotInBase, UlcerationReflux = @UlcerationReflux,
	  UlcerationPostSclero = @UlcerationPostSclero, UlcerationPostBanding = @UlcerationPostBanding  WHERE  SiteId = @SiteId 
	 
  -- Update  ERS_UpperGIAbnoMiscellaneous set null
	  UPDATE ERS_UpperGIAbnoMiscellaneous  SET Ulceration =0, UlcerationType = 0, UlcerationMultiple = 0, UlcerationQty = 0, UlcerationLength = 0,
	 UlcerationClotInBase = 0, UlcerationReflux = 0, UlcerationPostSclero = 0, UlcerationPostBanding = 0  WHERE  SiteId = @SiteId

	 -- updating the summary
	 EXEC abnormalities_oesophagitis_summary_update @SiteId
	 EXEC abnormalities_miscellaneous_summary_update @SiteId
	 EXEC sites_summary_update @SiteId
 END
 END

GO
EXEC dbo.DropIfExist 
@ObjectName = 'abnormalities_oesophagitis_select', 
@ObjectTypePrefix = 'S' 

GO
CREATE PROCEDURE [dbo].[abnormalities_oesophagitis_select]
(
	@SiteId INT	
)
AS
BEGIN
SET NOCOUNT ON

 EXEC get_Ulcerdata_MiscellaneousToOesophagus @SiteId -- added by Ferdowsi, TFS 4253

SELECT
	[SiteId],
	[None],
	[MucosalAppearance],
	[Reflux],
	[ActiveBleeding],
	[MSMGrade1],
	[MSMGrade2a],
	[MSMGrade2b],
	[MSMGrade3],
	[MSMGrade4],
	[MSMGrade5],
	[ShortOesophagus],
	[Ulcer],
	[Stricture],
	[LAClassification],
	[Other],
	[SuspectedCandida],
	[CausticIngestion],
	[SuspectedHerpes],
	[OtherTypeOther],
	[OtherTypeOtherDesc],
	[SuspectedCandidaSeverity],
	[CausticIngestionSeverity],
	[SuspectedHerpesSeverity],
	[CorrosiveBurns],
	[CorrosiveBurnsSeverity],
	[Eosinophilic],
	[EosinophilicSeverity],
	Ulceration,
	UlcerationType,
	UlcerationMultiple,
	UlcerationQty,
	UlcerationLength,
	UlcerationClotInBase,
	UlcerationReflux,
	UlcerationPostSclero,
	UlcerationPostBanding
FROM
	ERS_UpperGIAbnoOesophagitis
WHERE 
	SiteId = @SiteId

 
END

GO
EXEC dbo.DropIfExist 
    @ObjectName = 'abnormalities_oesophagitis_save', 
    @ObjectTypePrefix = 'S' 

GO
CREATE PROCEDURE [dbo].[abnormalities_oesophagitis_save]
(
	@SiteId INT,
	@None BIT,
	@MucosalAppearance	TINYINT,
	@Reflux				bit,
	@ActiveBleeding		bit,
	@MSMGrade1			bit,
	@MSMGrade2a			bit,
	@MSMGrade2b			bit,
	@MSMGrade3			bit,
	@MSMGrade4			bit,
	@MSMGrade5			bit,
	@ShortOesophagus	bit,
	@LAClassification	tinyint,
	@Other				bit,
	@SuspectedCandida	bit,
	@CausticIngestion	bit,
	@SuspectedHerpes	bit,
	@CorrosiveBurns		bit,
	@OtherTypeOther		bit,
	@Eosinophilic		bit,
	@OtherTypeOtherDesc	nvarchar(200) ,
	@SuspectedCandidaSeverity	tinyint,
	@CausticIngestionSeverity	tinyint,
	@SuspectedHerpesSeverity	tinyint,
	@CorrosiveBurnsSeverity		tinyint,
	@EosinophilicSeverity		tinyint,
	@Ulceration BIT,
	@UlcerationMultiple BIT,
	@UlcerationQty SMALLINT,
	@UlcerationLength SMALLINT,
	@UlcerationClotInBase BIT,
	@UlcerationReflux BIT,
	@UlcerationPostSclero BIT,
	@UlcerationPostBanding BIT,
	@LoggedInUserId INT

)
AS

SET NOCOUNT ON

DECLARE @proc_id INT
DECLARE @proc_type INT

BEGIN TRANSACTION

BEGIN TRY
	SELECT 
		@proc_id = p.ProcedureId,
		@proc_type = p.ProcedureType
	FROM 
		ERS_Sites s
	JOIN 
		ERS_Procedures p ON s.ProcedureId = p.ProcedureId
	WHERE 
		SiteId = @SiteId
			
	IF NOT EXISTS (SELECT 1 FROM ERS_UpperGIAbnoOesophagitis WHERE SiteId = @SiteId)
	BEGIN
		INSERT INTO ERS_UpperGIAbnoOesophagitis (
			SiteId,
			[None],
			MucosalAppearance,
			Reflux,
			ActiveBleeding,
			MSMGrade1,
			MSMGrade2a,
			MSMGrade2b,
			MSMGrade3,
			MSMGrade4,
			MSMGrade5,
			ShortOesophagus,
			--Ulcer,
			--Stricture,
			LAClassification,
			Other,
			SuspectedCandida,
			CausticIngestion,
			SuspectedHerpes,
			CorrosiveBurns,
			Eosinophilic,
			OtherTypeOther,
			OtherTypeOtherDesc,
			SuspectedCandidaSeverity,
			CausticIngestionSeverity,
			SuspectedHerpesSeverity,
			CorrosiveBurnsSeverity,
			EosinophilicSeverity,
			Ulceration,
			UlcerationType,
			UlcerationMultiple,
			UlcerationQty,
			UlcerationLength,
			UlcerationClotInBase,
			UlcerationReflux,
			UlcerationPostSclero,
			UlcerationPostBanding,
			WhoCreatedId,
			WhenCreated) 
		VALUES (
			@SiteId,
			@None,
			@MucosalAppearance,
			@Reflux,
			@ActiveBleeding,
			@MSMGrade1,
			@MSMGrade2a,
			@MSMGrade2b,
			@MSMGrade3,
			@MSMGrade4,
			@MSMGrade5,
			@ShortOesophagus,
			--@Ulcer,
			--@Stricture,
			@LAClassification,
			@Other,
			@SuspectedCandida,
			@CausticIngestion,
			@SuspectedHerpes,
			@CorrosiveBurns,
			@Eosinophilic,
			@OtherTypeOther	,
			@OtherTypeOtherDesc,
			@SuspectedCandidaSeverity,
			@CausticIngestionSeverity,
			@SuspectedHerpesSeverity,
			@CorrosiveBurnsSeverity,
			@EosinophilicSeverity,
			@Ulceration,
		    0,
			@UlcerationMultiple,
			@UlcerationQty,
			@UlcerationLength,
			@UlcerationClotInBase,
			@UlcerationReflux,
			@UlcerationPostSclero,
			@UlcerationPostBanding,
			@LoggedInUserId,
			GETDATE())

		INSERT INTO ERS_RecordCount (
			[ProcedureId],
			[SiteId],
			[Identifier],
			[RecordCount]
		)
		VALUES (
			@proc_id,
			@SiteId,
			'Oesophagitis',
			1)
	END
	
	ELSE IF (@None=0 AND @MucosalAppearance=0 AND @Reflux=0 AND @Other=0 AND @CausticIngestion = 0 AND @SuspectedCandida = 0 AND @SuspectedHerpes = 0 AND @CorrosiveBurns = 0 AND @Eosinophilic = 0 AND @Ulceration = 0)
	BEGIN
		DELETE FROM ERS_UpperGIAbnoOesophagitis 
		WHERE SiteId = @SiteId

		DELETE FROM ERS_RecordCount 
		WHERE SiteId = @SiteId
		AND Identifier = 'Oesophagitis'
	END

	ELSE
	BEGIN
		UPDATE 
			ERS_UpperGIAbnoOesophagitis
		SET 
			[None] = @None,
			MucosalAppearance = @MucosalAppearance,
			Reflux = @Reflux,
			ActiveBleeding = @ActiveBleeding,
			MSMGrade1 = @MSMGrade1,
			MSMGrade2a = @MSMGrade2a,
			MSMGrade2b = @MSMGrade2b,
			MSMGrade3 = @MSMGrade3,
			MSMGrade4 = @MSMGrade4,
			MSMGrade5 = @MSMGrade5,
			ShortOesophagus = @ShortOesophagus,
			--Ulcer = @Ulcer,
			--Stricture = @Stricture,
			LAClassification = @LAClassification,
			Other = @Other,
			SuspectedCandida = @SuspectedCandida,
			CausticIngestion = @CausticIngestion,
			SuspectedHerpes = @SuspectedHerpes,
			CorrosiveBurns = @CorrosiveBurns,
			Eosinophilic = @Eosinophilic,
			OtherTypeOther = @OtherTypeOther,
			OtherTypeOtherDesc = @OtherTypeOtherDesc,
			SuspectedCandidaSeverity = @SuspectedCandidaSeverity,
			CausticIngestionSeverity = @CausticIngestionSeverity,
			SuspectedHerpesSeverity = @SuspectedHerpesSeverity,
			CorrosiveBurnsSeverity = @CorrosiveBurnsSeverity,
			EosinophilicSeverity = @EosinophilicSeverity,
			Ulceration = @Ulceration,
			UlcerationType = 0,
			UlcerationMultiple = @UlcerationMultiple,
			UlcerationQty = @UlcerationQty,
			UlcerationLength = @UlcerationLength,
			UlcerationClotInBase = @UlcerationClotInBase,
			UlcerationReflux = @UlcerationReflux,
			UlcerationPostSclero = @UlcerationPostSclero,
			UlcerationPostBanding = @UlcerationPostBanding,
			WhoUpdatedId = @LoggedInUserId,
			WhenUpdated = GETDATE()
		WHERE 
			SiteId = @SiteId
	END
END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;

GO 
EXEC dbo.DropIfExist 
    @ObjectName = 'abnormalities_miscellaneous_save', 
    @ObjectTypePrefix = 'S' 

GO
CREATE PROCEDURE [dbo].[abnormalities_miscellaneous_save]
(
	@SiteId INT,
	@None BIT,
	@Web BIT,
	@Mallory BIT,
	@SchatzkiRing BIT,
	@FoodResidue BIT,
	@Foreignbody BIT,
	@ExtrinsicCompression BIT,
	@Diverticulum BIT,
	@DivertMultiple BIT,
	@DivertQty SMALLINT,
	@Pharyngeal BIT,
	@DiffuseIntramural BIT,
	@TractionType BIT,
	@PulsionType BIT,
	@MotilityDisorder BIT,
	@ProbableAchalasia BIT,
	@ConfirmedAchalasia BIT,
	@Presbyoesophagus BIT,
	@MarkedTertiaryContractions BIT,
	@LaxLowerOesoSphincter BIT,
	@TortuousOesophagus BIT,
	@DilatedOesophagus BIT,
	@MotilityPoor BIT,
	@Stricture BIT,
	@StrictureCompression TINYINT,
	@StrictureScopeNotPass BIT,
	@StrictureSeverity TINYINT,
	@StrictureType SMALLINT,
	@StrictureProbably BIT,
	@StrictureBenignType TINYINT,
	@StrictureBeginning SMALLINT,
	@StrictureLength SMALLINT,
	@StricturePerforation TINYINT,
	@Tumour BIT,
	@TumourType TINYINT,
	@TumourProbably BIT,
	@TumourExophytic TINYINT,
	@TumourBenignType TINYINT,
	@TumourBenignTypeOther NVARCHAR(100),
	@TumourBeginning SMALLINT,
	@TumourLength SMALLINT,
	@TumourScopeCouldNotPass BIT,
	@MiscOther NVARCHAR(150),
	@InletPatch BIT,
	@InletPatchMultiple BIT,
	@InletPatchQty SMALLINT,
	@Fitsula BIT,
	@LoggedInUserId INT,
	@InletPouch BIT,	
	@InletPouchQty SMALLINT,
	@ZLine BIT,
	@ZLineSize INT,
	@Volvulus BIT,
	@AmpullaryAdenoma BIT,
	@StentOcclusion BIT,
	@StentInSitu BIT,
	@PEGInSitu BIT

)
AS

SET NOCOUNT ON

DECLARE @proc_id INT
DECLARE @proc_type INT

BEGIN TRANSACTION

BEGIN TRY
	SELECT 
		@proc_id = p.ProcedureId,
		@proc_type = p.ProcedureType
	FROM 
		ERS_Sites s
	JOIN 
		ERS_Procedures p ON s.ProcedureId = p.ProcedureId
	WHERE 
		SiteId = @SiteId
			
	IF NOT EXISTS (SELECT 1 FROM ERS_UpperGIAbnoMiscellaneous WHERE SiteId = @SiteId)
	BEGIN
		INSERT INTO ERS_UpperGIAbnoMiscellaneous (
			SiteId,
			[None],
			Web,
			Mallory,
			SchatzkiRing,
			FoodResidue,
			Foreignbody,
			ExtrinsicCompression,
			Diverticulum,
			DivertMultiple,
			DivertQty,
			Pharyngeal,
			DiffuseIntramural,
			TractionType,
			PulsionType,
			MotilityDisorder,
			ProbableAchalasia,
			ConfirmedAchalasia,
			Presbyoesophagus,
			MarkedTertiaryContractions,
			LaxLowerOesoSphincter,
			TortuousOesophagus,
			DilatedOesophagus,
			MotilityPoor,
			Stricture,
			StrictureCompression,
			StrictureScopeNotPass,
			StrictureSeverity,
			StrictureType,
			StrictureProbably,
			StrictureBenignType,
			StrictureBeginning,
			StrictureLength,
			StricturePerforation,
			Tumour,
			TumourType,
			TumourProbably,
			TumourExophytic,
			TumourBenignType,
			TumourBenignTypeOther,
			TumourBeginning,
			TumourLength,
			TumourScopeNotPass,
			MiscOther,
			InletPatch,
			InletPatchMultiple,
			InletPatchQty,
			Fitsula,
			WhoCreatedId,
			WhenCreated,
			InletPouch,			
			InletPouchQty,
			ZLine,
			ZLineSize,
			Volvulus,
			AmpullaryAdenoma,
			StentOcclusion,
			StentInSitu,
			PEGInSitu) 
		VALUES (@SiteId,
				@None,
				@Web,
				@Mallory,
				@SchatzkiRing,
				@FoodResidue,
				@Foreignbody,
				@ExtrinsicCompression,
				@Diverticulum,
				@DivertMultiple,
				@DivertQty,
				@Pharyngeal,
				@DiffuseIntramural,
				@TractionType,
				@PulsionType,
				@MotilityDisorder,
				@ProbableAchalasia,
				@ConfirmedAchalasia,
				@Presbyoesophagus,
				@MarkedTertiaryContractions,
				@LaxLowerOesoSphincter,
				@TortuousOesophagus,
				@DilatedOesophagus,
				@MotilityPoor,
				@Stricture,
				@StrictureCompression,
				@StrictureScopeNotPass,
				@StrictureSeverity,
				@StrictureType,
				@StrictureProbably,
				@StrictureBenignType,
				@StrictureBeginning,
				@StrictureLength,
				@StricturePerforation,
				@Tumour,
				@TumourType,
				@TumourProbably,
				@TumourExophytic,
				@TumourBenignType,
				@TumourBenignTypeOther,
				@TumourBeginning,
				@TumourLength,
				@TumourScopeCouldNotPass,
				@MiscOther,
				@InletPatch,
				@InletPatchMultiple,
				@InletPatchQty,
				@Fitsula,
				@LoggedInUserId,
				GETDATE(),
				@InletPouch,			
				@InletPouchQty,
				@ZLine,
				@ZlineSize,
				@Volvulus,
				@AmpullaryAdenoma,
				@StentOcclusion,
				@StentInSitu,
				@PEGInSitu)

		INSERT INTO ERS_RecordCount (
			[ProcedureId],
			[SiteId],
			[Identifier],
			[RecordCount]
		)
		VALUES (
			@proc_id,
			@SiteId,
			'Miscellaneous',
			1)
	END

	ELSE IF (@None = 0 AND @Web = 0 AND @Mallory = 0 AND @SchatzkiRing = 0 AND @FoodResidue = 0 
			AND @Diverticulum = 0 AND @MotilityDisorder = 0  AND @Stricture = 0 AND @Tumour = 0 
			AND @Foreignbody = 0 AND @InletPatch = 0 AND @Fitsula = 0 AND @InletPatch = 0 AND @InletPouch = 0 AND @ZLine = 0 AND @Volvulus = 0 AND @AmpullaryAdenoma = 0 AND @StentOcclusion = 0
			AND @StentInSitu = 0 AND @PEGInSitu = 1 AND RTRIM(LTRIM(@MiscOther)) = '')
	BEGIN
		DELETE FROM ERS_UpperGIAbnoMiscellaneous 
		WHERE SiteId = @SiteId

		DELETE FROM ERS_RecordCount 
		WHERE SiteId = @SiteId
		AND Identifier = 'Miscellaneous'
	END
	
	ELSE
	BEGIN
		UPDATE 
			ERS_UpperGIAbnoMiscellaneous
		SET 
			[None]				=	@None,
			Web					=	@Web,
			Mallory				=	@Mallory,
			SchatzkiRing		=	@SchatzkiRing,
			FoodResidue			=	@FoodResidue,
			Foreignbody = @Foreignbody,
			ExtrinsicCompression	=	@ExtrinsicCompression,
			Diverticulum		=	@Diverticulum,
			DivertMultiple		=	@DivertMultiple,
			DivertQty			=	@DivertQty,
			Pharyngeal			=	@Pharyngeal,
			DiffuseIntramural	=	@DiffuseIntramural,
			TractionType		=	@TractionType,
			PulsionType			=	@PulsionType,
			MotilityDisorder	=	@MotilityDisorder,
			ProbableAchalasia	=	@ProbableAchalasia,
			ConfirmedAchalasia	=	@ConfirmedAchalasia,
			Presbyoesophagus	=	@Presbyoesophagus,
			MarkedTertiaryContractions	=	@MarkedTertiaryContractions,
			LaxLowerOesoSphincter		=	@LaxLowerOesoSphincter,
			TortuousOesophagus		=	@TortuousOesophagus,
			DilatedOesophagus		=	@DilatedOesophagus,
			MotilityPoor			=	@MotilityPoor,

			Stricture				=	@Stricture,
			StrictureCompression	=	@StrictureCompression,
			StrictureScopeNotPass	=	@StrictureScopeNotPass,
			StrictureSeverity		=	@StrictureSeverity,
			StrictureType			=	@StrictureType,
			StrictureProbably		=	@StrictureProbably,
			StrictureBenignType		=	@StrictureBenignType,
			StrictureBeginning		=	@StrictureBeginning,
			StrictureLength			=	@StrictureLength,
			StricturePerforation	=	@StricturePerforation,
			Tumour					=	@Tumour,
			TumourType				=	@TumourType,
			TumourProbably			=	@TumourProbably,
			TumourExophytic			=	@TumourExophytic,
			TumourBenignType		=	@TumourBenignType,
			TumourBenignTypeOther	=	@TumourBenignTypeOther,
			TumourBeginning			=	@TumourBeginning,
			TumourLength			=	@TumourLength,
			TumourScopeNotPass		=	@TumourScopeCouldNotPass,
			MiscOther				=	@MiscOther,
			InletPatch				=	@InletPatch,
			InletPatchMultiple		=	@InletPatchMultiple,
			InletPatchQty			=	@InletPatchQty,
			Fitsula					=	@Fitsula,
			WhoUpdatedId			=	@LoggedInUserId,
			WhenUpdated				=	GETDATE(),
			InletPouch				=	@InletPouch,			
			InletPouchQty			=	@InletPouchQty,
			ZLine					=	@ZLine,
			ZLineSize				=	@ZLineSize,
			Volvulus				=	@Volvulus,
			AmpullaryAdenoma		=	@AmpullaryAdenoma,
			StentOcclusion			=	@StentOcclusion,
			StentInSitu				=	@StentInSitu,
			PEGInSitu				=	@PEGInSitu
		WHERE 
			SiteId = @SiteId
	END
END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;

GO
EXEC dbo.DropIfExist 
    @ObjectName = 'abnormalities_miscellaneous_select', 
    @ObjectTypePrefix = 'S' 

GO
CREATE PROCEDURE [dbo].[abnormalities_miscellaneous_select]
(
	@SiteId INT	
)
AS

SET NOCOUNT ON

SELECT
	SiteId,						
	[None],							
	[Web],							
	[Mallory],				
	[SchatzkiRing],					
	[FoodResidue],					
	[Foreignbody],					
	[ExtrinsicCompression],			
	[Diverticulum],					
	[DivertMultiple],				
	[DivertQty],						
	[Pharyngeal],					
	[DiffuseIntramural],				
	[TractionType],					
	[PulsionType],					
	[MotilityDisorder],				
	[ProbableAchalasia],				
	[ConfirmedAchalasia],			
	[Presbyoesophagus],				
	[MarkedTertiaryContractions],	
	[LaxLowerOesoSphincter],			
	[TortuousOesophagus],			
	[DilatedOesophagus],				
	[MotilityPoor],								
	[Stricture],						
	[StrictureCompression],			
	[StrictureScopeNotPass],			
	[StrictureSeverity],			
	[StrictureType],					
	[StrictureProbably],				
	[StrictureBenignType],			
	[StrictureBeginning],			
	[StrictureLength],	
	[StricturePerforation],			
	[Tumour],						
	[TumourType],					
	[TumourProbably],				
	[TumourExophytic],				
	[TumourBenignType],				
	[TumourBenignTypeOther],			
	[TumourBeginning],				
	[TumourLength],					
	[TumourScopeNotPass],			
	[MiscOther],						
	[EUSproctype],
	[InletPatch],
	[InletPatchMultiple],
	[InletPatchQty],
	[Fitsula],
	[Summary],
	[InletPouch],	
	[InletPouchQty],
	[ZLine],
	[ZLineSize],
	[Volvulus],
	[AmpullaryAdenoma],
	[StentOcclusion],
	[StentInSitu],
	[PEGInSitu]
FROM
	[ERS_UpperGIAbnoMiscellaneous]
WHERE 
	SiteId = @SiteId

GO

------------------------------------------------------------------------------------------------------------------------
-- TFS#	4235, 4395 Ended
------------------------------------------------------------------------------------------------------------------------


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 03.10.24
-- TFS#	4458
-- Description of change
-- Excludes deleted diaries from availability check
------------------------------------------------------------------------------------------------------------------------
GO

SET QUOTED_IDENTIFIER ON
SET ANSI_NULLS ON
GO
ALTER PROCEDURE [dbo].[sch_get_room_diaries]
(
	@RoomId int,
	@StartDate datetime = null,
	@EndDate datetime = null
)
AS
BEGIN
	SELECT * FROM ERS_SCH_DiaryPages WHERE RoomId = @RoomId and Suppressed = 0 and SuppressedBy is null and CancelReasonId is null
END
GO



------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rezaul Karim 
-- TFS#	4330
-- Description of change
-- Nurse Module Feature
------------------------------------------------------------------------------------------------------------------------

IF NOT EXISTS(SELECT 1 FROM ERS_Pages WHERE PageName = 'Admin Utilities -> NurseSettings' )
	BEGIN
	declare @groupId int, @pageId int, @parentId int
	select @pageId  = (SELECT TOP 1 PageId FROM ERS_Pages ORDER BY PageId DESC)+1

	select @groupId = GroupId from ERS_PageGroups where GroupName = 'Admin Utilities'
	 INSERT INTO ERS_Pages ( PageId,PageName,PageAlias,AppPageName,GroupId ,PageURL,WhoUpdatedId,WhoCreatedId ,WhenCreated ,WhenUpdated) VALUES
	 (@pageId,'Admin Utilities -> NurseSettings', 'Nurse Settings','products_options_nursesettings_aspx',@groupId,'~/Products/Options/NurseSettings.aspx',NULL,0,GETDATE(),NULL);


	INSERT INTO [dbo].[ERS_PagesByRole]([RoleId] ,[PageId],[AccessLevel],[WhoUpdatedId],[WhoCreatedId],[WhenCreated],[WhenUpdated])
     VALUES(1,@pageId,9,null ,1, GETDATE(), null)

	select @parentId = mapid FROM ERS_MenuMap WHERE NodeName = 'Admin Utilities'

	INSERT INTO [dbo].[ERS_MenuMap]([ParentID],[NodeName] ,[MenuCategory],[MenuUrl],[isViewer] ,[isDemoVersion] ,[PageID],[MenuIcon] ,[MenuTooltip],[Suppressed] ,[WhoUpdatedId] ,[WhoCreatedId],[WhenCreated]
           ,[WhenUpdated]
           ,[SortOrder])
     VALUES(@parentId, 'Nurse Settings', 'Configure', '~/Products/Options/NurseSettings.aspx', 1, 0 ,@pageId, null,null,0,null, 1, GETDATE(), null, 0 )
end    
GO

IF NOT EXISTS (SELECT 1 from sys.objects WHERE object_id = OBJECT_ID('ERS_NurseModuleSection'))
BEGIN
CREATE TABLE [dbo].[ERS_NurseModuleSection](
	[SectionId] [int] IDENTITY(1,1) NOT NULL,
	[SectionName] [varchar](100) NOT NULL,
	[ProcedureType] [int] NOT NULL,
	[Suppressed] [bit] NULL,
	[SortOrder] [int] NULL,
	[WhoUpdatedId] [int] NULL,
	[WhenUpdated] [datetime] NULL
PRIMARY KEY CLUSTERED 
(
	[SectionId] ASC
))ON [PRIMARY]
ALTER TABLE [dbo].[ERS_NurseModuleSection]  WITH CHECK ADD FOREIGN KEY([WhoUpdatedId])
REFERENCES [dbo].[ERS_Users] ([UserID])
END
GO

IF NOT EXISTS (SELECT 1 from sys.objects WHERE object_id = OBJECT_ID('ERS_NurseModuleQuestion'))
BEGIN
CREATE TABLE [dbo].[ERS_NurseModuleQuestion](
	[QuestionId] [int] IDENTITY(1,1) NOT NULL,
	[SectionId] [int] NOT NULL,
	[Question] [varchar](250) NOT NULL,
	[Mandatory] [bit] NOT NULL,
	[FreeText] [bit] NOT NULL,
	[YesNo] [bit] NOT NULL,
	[Suppressed] [bit] NOT NULL,
	[TrustId] [int] NOT NULL,
	[WhoCreated] [int] NOT NULL,
	[WhenCreated] [datetime] NOT NULL,
	[WhoUpdated] [int] NULL,
	[WhenUpdated] [datetime] NULL,
	[DropdownOption] [bit] NULL,
	[DropdownOptionText] [varchar](500) NULL,
	[SortOrder] [int] NULL
PRIMARY KEY CLUSTERED 
(
	[QuestionId] ASC
)) 

ALTER TABLE [dbo].[ERS_NurseModuleQuestion]  WITH CHECK ADD FOREIGN KEY([SectionId])
REFERENCES [dbo].[ERS_NurseModuleSection] ([SectionId])

ALTER TABLE [dbo].[ERS_NurseModuleQuestion]  WITH CHECK ADD FOREIGN KEY([TrustId])
REFERENCES [dbo].[ERS_Trusts] ([TrustID])

ALTER TABLE [dbo].[ERS_NurseModuleQuestion]  WITH CHECK ADD FOREIGN KEY([WhoCreated])
REFERENCES [dbo].[ERS_Users] ([UserID])

ALTER TABLE [dbo].[ERS_NurseModuleQuestion]  WITH CHECK ADD FOREIGN KEY([WhoUpdated])
REFERENCES [dbo].[ERS_Users] ([UserID])
END
GO

IF NOT EXISTS (SELECT 1 from sys.objects WHERE object_id = OBJECT_ID('ERS_NurseModuleProcedure'))
BEGIN
CREATE TABLE [dbo].[ERS_NurseModuleProcedure](
	[NurseModuleId] [int] IDENTITY(1,1) NOT NULL,
	[NurseModuleDate] [datetime] NULL,
	[ProcedureType] [varchar](100) NULL,
	[WhoCreated] [int] NOT NULL,
	[WhoUpdated] [int] NULL,
	[WhenUpdated] [datetime] NULL,
	[PatientId] [int] NOT NULL,
	[IsComplete] [bit] NULL
PRIMARY KEY CLUSTERED 
(
	[NurseModuleId] ASC
)) 

ALTER TABLE [dbo].[ERS_NurseModuleProcedure]  WITH CHECK ADD FOREIGN KEY([PatientId])
REFERENCES [dbo].[ERS_Patients] ([PatientId])

ALTER TABLE [dbo].[ERS_NurseModuleProcedure]  WITH CHECK ADD FOREIGN KEY([WhoCreated])
REFERENCES [dbo].[ERS_Users] ([UserID])

ALTER TABLE [dbo].[ERS_NurseModuleProcedure]  WITH CHECK ADD FOREIGN KEY([WhoUpdated])
REFERENCES [dbo].[ERS_Users] ([UserID])
END
GO
IF NOT EXISTS (SELECT 1 from sys.objects WHERE object_id = OBJECT_ID('ERS_NurseModuleAnswers'))
BEGIN
CREATE TABLE [dbo].[ERS_NurseModuleAnswers](
	[AnswerId] [int] IDENTITY(1,1) NOT NULL,
	[NurseModuleId] [int] NOT NULL,
	[QuestionId] [int] NOT NULL,
	[FreeTextAnswer] [varchar](max) NULL,
	[OptionAnswer] [int] NULL,
	[DropdownAnswer] [varchar](100) NULL,
	[WhoCreated] [int] NOT NULL,
	[WhenCreated] [datetime] NOT NULL,
	[WhoUpdated] [int] NULL,
	[WhenUpdated] [datetime] NULL,
PRIMARY KEY CLUSTERED 
(
	[AnswerId] ASC
))

ALTER TABLE [dbo].[ERS_NurseModuleAnswers] ADD  DEFAULT (getdate()) FOR [WhenCreated]

ALTER TABLE [dbo].[ERS_NurseModuleAnswers]  WITH CHECK ADD FOREIGN KEY([NurseModuleId])
REFERENCES [dbo].[ERS_NurseModuleProcedure] ([NurseModuleId])

ALTER TABLE [dbo].[ERS_NurseModuleAnswers]  WITH CHECK ADD FOREIGN KEY([WhoCreated])
REFERENCES [dbo].[ERS_Users] ([UserID])

ALTER TABLE [dbo].[ERS_NurseModuleAnswers]  WITH CHECK ADD FOREIGN KEY([WhoUpdated])
REFERENCES [dbo].[ERS_Users] ([UserID])
END
GO

EXEC dbo.DropIfExist @ObjectName = 'Add_Or_Update_Nurse_Question_Item',  
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO
CREATE PROCEDURE [dbo].[Add_Or_Update_Nurse_Question_Item]
(
	 @SectionId		AS INT
	,@QuestionId		AS INT
	,@Question		AS VARCHAR(500) = NULL
	,@Mandatory		AS BIT = NULL
	,@FreeText		AS BIT = NULL
	,@YesNo			AS BIT = NULL
	,@DropdownOption	AS BIT = NULL
	,@DropdownOptionText	AS VARCHAR(500) = ''
	,@TrustId		AS INT
	,@IsSuppressed		AS BIT = NULL
	,@LoggedInUserId	AS INT
	,@SortOrder AS INT NULL = null
)
AS
BEGIN

		IF NOT EXISTS (SELECT 1 FROM ERS_NurseModuleQuestion WHERE QuestionId = @QuestionId )
		BEGIN
			INSERT INTO dbo.ERS_NurseModuleQuestion
			(
				Question,
				SectionId,
				Mandatory,
				[FreeText],
				YesNo,
				DropdownOption,
				DropdownOptionText,
				Suppressed,
				TrustId,
				WhoCreated,
				WhenCreated,
				SortOrder
			)
			values(@Question,@SectionId,@Mandatory,@FreeText,@YesNo,@DropdownOption,@DropdownOptionText,0,@TrustId,@LoggedInUserId,GETDATE(),@SortOrder)
		END
		else
		BEGIN
			DECLARE @PrevSuppressed bit
			select @PrevSuppressed = Suppressed from ERS_NurseModuleQuestion where QuestionId = @QuestionId

			If @IsSuppressed is not null and @IsSuppressed <> @PrevSuppressed
				BEGIN
					UPDATE ERS_NurseModuleQuestion SET Suppressed = @IsSuppressed WHERE @QuestionId = QuestionId
				END
			ELSE
				BEGIN
					UPDATE [dbo].[ERS_NurseModuleQuestion]
					   SET [Question]=  @Question 
						 , [SectionId]	=  @SectionId 
						 , [Mandatory]		=  @Mandatory 
						 , [FreeText]		= @FreeText 
						 , [YesNo]		= @YesNo 
						 , [DropdownOption]		=  @DropdownOption 
						 , [DropdownOptionText]		=  @DropdownOptionText
						 , [WhoUpdated] = @LoggedInUserId
						 , [WhenUpdated] = GETDATE()
						 ,[SortOrder] =  @SortOrder 
					 WHERE [dbo].[ERS_NurseModuleQuestion].QuestionId = @QuestionId;
				END
		END
 IF @@ROWCOUNT > 0 
		RETURN 1;
	ELSE 
		RETURN 0;
END
GO

EXEC dbo.DropIfExist @ObjectName = 'Add_Or_Update_Nurse_Section_Item',  
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO
CREATE PROCEDURE [dbo].[Add_Or_Update_Nurse_Section_Item]
(
	@SectionId int ,
	@sectionName varchar(50),
	@order int null,
	@procedureType int null,
	@IsSuppressed BIT = NULL,
	@loggedInUserId int
)
AS

	BEGIN
		IF NOT EXISTS (SELECT 1 FROM ERS_NurseModuleSection WHERE SectionId = @SectionId)
		BEGIN
			INSERT INTO dbo.ERS_NurseModuleSection
			(
				SectionName,
				SortOrder,
				Suppressed,
				ProcedureType,
				WhenUpdated,
				WhoUpdatedId
			)
			values(@sectionName,@order,0,@procedureType,GETDATE(),@LoggedInUserId)
		END
		ELSE
		BEGIN
			
			DECLARE @prevSuppressed bit
			select @prevSuppressed = Suppressed from ERS_NurseModuleSection where SectionId = @SectionId

			If @IsSuppressed is not null  and @prevSuppressed <> @IsSuppressed
			BEGIN
				UPDATE ERS_NurseModuleSection SET Suppressed = @IsSuppressed WHERE SectionId = @SectionId
			END	
			ELSE
			Begin
				UPDATE [dbo].[ERS_NurseModuleSection]
				   SET [SectionName]= @SectionName
					 , [SortOrder]	= @Order
					 , [WhoUpdatedId] = @LoggedInUserId
					 ,ProcedureType = @procedureType
					 , [WhenUpdated] = GETDATE()
				 WHERE [dbo].[ERS_NurseModuleSection].SectionId = @SectionId;
				END
			END
	IF @@ROWCOUNT > 0 
		RETURN 1;
	ELSE 
		RETURN 0;
	END
	GO

EXEC dbo.DropIfExist @ObjectName = 'ERS_NurseModuleProcedure_Save',  
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[ERS_NurseModuleProcedure_Save]
(
	@ProcedureType varchar(100) = '', 
	@LoggedInUserId int,
	@PatientId int,
	@NurseModuleId int = 0,
	@ProcedureDate dateTime,
	@IsComplete bit = 0
)
AS
BEGIN
		declare @ModuleId int = 0
		IF NOT EXISTS (SELECT 1 FROM ERS_NurseModuleProcedure WHERE NurseModuleId= @NurseModuleId)
		BEGIN
			INSERT INTO [dbo].ERS_NurseModuleProcedure (NurseModuleDate, ProcedureType, WhoCreated, PatientId, IsComplete)
			VALUES (getdate(),@ProcedureType, @LoggedInUserId, @PatientId,0)
			SET @ModuleId = SCOPE_IDENTITY();
		END
		ELSE
		BEGIN
			UPDATE 
				ERS_NurseModuleProcedure 
			SET 
				
				ProcedureType = @ProcedureType,
				WhenUpdated = GETDATE(),
				NurseModuleDate = @ProcedureDate,
				WhoUpdated = @LoggedInUserId,
				IsComplete =  case when IsComplete = 1 then 1 else  @IsComplete end
			WHERE 
				NurseModuleId = @NurseModuleId
				SET @ModuleId = @NurseModuleId;
		END
		SELECT @MOduleId AS NurseModuleId;
END
GO

EXEC dbo.DropIfExist @ObjectName = 'get_nurse_module_question_list',  
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO
CREATE PROCEDURE [dbo].[get_nurse_module_question_list]
AS
BEGIN
select e.SectionName, p.SectionId,p.QuestionId,p.Suppressed, p.Question,p.SortOrder, p.Mandatory, p.[FreeText], p.YesNo,p.DropdownOption,p.DropdownOptionText from dbo.ERS_NurseModuleQuestion p
left join ERS_NurseModuleSection e on p.SectionId = e.SectionId
where e.Suppressed = 0
ORDER BY 
        CASE 
            WHEN p.SortOrder IS NULL THEN 1
            ELSE 0 
        END, 
        p.SortOrder ASC;
END
GO

EXEC dbo.DropIfExist @ObjectName = 'get_nurse_module_section_list',  
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO
CREATE PROCEDURE [dbo].[get_nurse_module_section_list]
AS
BEGIN
SELECT s.sectionid,s.sectionname,s.suppressed,s.sortorder,e.ProcedureType as ProcedureTypeName,s.ProcedureType
FROM dbo.ERS_NurseModuleSection s
left join ERS_ProcedureTypes e on e.ProcedureTypeId = s.proceduretype
ORDER BY SortOrder ASC
END
GO

EXEC dbo.DropIfExist @ObjectName = 'Nurse_Module_Answers_Save',  
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO
CREATE PROCEDURE [dbo].[Nurse_Module_Answers_Save]
(
	@NurseModuleId int,
	@QuestionId	int,
	@AnswerId int NULL,
	@OptionAnswer int = null,
	@FreeTextAnswer varchar(max) = NULL,
	@DropdownAnswer varchar(100) = '',
	@LoggedInUserId int
)
AS
BEGIN

	IF NOT EXISTS (SELECT 1 FROM ERS_NurseModuleAnswers WHERE QuestionId = @QuestionId AND NurseModuleId = @NurseModuleId)
	BEGIN
		INSERT INTO ERS_NurseModuleAnswers(NurseModuleId, QuestionId, OptionAnswer, FreeTextAnswer,DropdownAnswer , WhoCreated, WhenCreated)
		VALUES (@NurseModuleId, @QuestionId,  @OptionAnswer , @FreeTextAnswer,@DropdownAnswer, @LoggedInUserId, getdate())
	END
	ELSE
	BEGIN
		UPDATE ERS_NurseModuleAnswers
		SET OptionAnswer= @OptionAnswer, FreeTextAnswer = @FreeTextAnswer,DropdownAnswer = @DropdownAnswer, WhoUpdated = @LoggedInUserId, WhenUpdated = getdate()
		WHERE NurseModuleId = @NurseModuleId AND QuestionId = @QuestionId	
	END

END
GO

EXEC dbo.DropIfExist @ObjectName = 'ValidateNurseModuleMandatoryQuestions',  
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO
CREATE PROCEDURE [dbo].[ValidateNurseModuleMandatoryQuestions]
    @NurseModuleId INT
AS
BEGIN
    DECLARE    @IncompleteSections NVARCHAR(MAX) ,
   @QuestionName NVARCHAR(MAX),
   @ProcTypes varchar(100) = '1'


    SET @IncompleteSections = ''

	select @ProcTypes =  proceduretype from ERS_NurseModuleProcedure where NurseModuleId = @NurseModuleId
    
		DECLARE unansweredCursor CURSOR FOR
		SELECT eppq.Question
		FROM dbo.ERS_NurseModuleQuestion eppq
		LEFT JOIN ERS_NurseModuleAnswers pa 
			ON pa.QuestionId = eppq.QuestionId 
			AND pa.NurseModuleId = @NurseModuleId
		INNER JOIN dbo.ERS_NurseModuleSection epns
			ON epns.SectionId = eppq.SectionId
		WHERE eppq.Mandatory = 1 
		AND eppq.Suppressed = 0
		   AND epns.ProcedureType IN (
        SELECT CAST(item AS INT) 
        FROM fnSplitString(@ProcTypes, ',')) 
		AND (
			(eppq.YesNo = 1 AND pa.OptionAnswer IS NULL) OR
			(eppq.[FreeText] = 1 AND pa.FreeTextAnswer IS NULL) OR
			(eppq.DropdownOption = 1 AND (pa.DropdownAnswer IS NULL OR pa.DropdownAnswer = ''))
		);

    OPEN unansweredCursor

    FETCH NEXT FROM unansweredCursor INTO @QuestionName

    WHILE @@FETCH_STATUS = 0
    BEGIN
        SET @IncompleteSections = @IncompleteSections  + @QuestionName + ' is required.' +  '<br />'
        FETCH NEXT FROM unansweredCursor INTO @QuestionName
    END

    CLOSE unansweredCursor
    DEALLOCATE unansweredCursor
	select @IncompleteSections
END
GO

EXEC dbo.DropIfExist @ObjectName = 'GetNurseModuleQuestionAndAnswerList',  
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO
CREATE PROCEDURE [dbo].[GetNurseModuleQuestionAndAnswerList]
    @NurseModuleId INT,
    @procedureType VARCHAR(MAX),
	@trustId as int = 0
AS
BEGIN
    SELECT s.SectionName, 
           q.QuestionId, 
           q.Question, 
           q.Mandatory, 
           q.[FreeText], 
           q.YesNo, 
           q.DropdownOption, 
           q.DropdownOptionText, 
           q.Suppressed, 
           q.TrustId, 
           a.FreeTextAnswer, 
           a.OptionAnswer, 
           a.AnswerId, 
           a.DropdownAnswer
    FROM ERS_NurseModuleSection s
    INNER JOIN ERS_NurseModuleQuestion q 
        ON s.SectionId = q.SectionId
        AND s.ProcedureType IN (SELECT CAST(item AS INT) FROM fnSplitString(@procedureType, ','))
    LEFT JOIN ERS_NurseModuleAnswers a 
        ON q.QuestionId = a.QuestionId 
        AND a.NurseModuleId = @NurseModuleId
    WHERE (q.Suppressed = 0 OR (q.Suppressed = 1 AND a.QuestionId > 0))
      AND (s.Suppressed = 0 OR (s.Suppressed = 1 AND a.QuestionId > 0))
    ORDER BY 
        CASE WHEN s.SortOrder IS NULL THEN 1 ELSE 0 END, 
        s.SortOrder ASC, 
        CASE WHEN q.SortOrder IS NULL THEN 1 ELSE 0 END, 
        q.SortOrder ASC;
END;
GO

EXEC dbo.DropIfExist @ObjectName = 'GetNurseModuleList',  
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO
CREATE PROCEDURE [dbo].[GetNurseModuleList]
    @patientId INT
AS
BEGIN
SELECT top 5 s.NurseModuleId, s.NurseModuleDate, s.ProcedureType,s.PatientId 
                      FROM ERS_NurseModuleProcedure s 
                      WHERE (s.PatientId = @patientId) order by s.nursemoduledate desc
END
GO

EXEC dbo.DropIfExist @ObjectName = 'GetPreAssessmentQuestionList',  
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO
CREATE PROCEDURE [dbo].[GetPreAssessmentQuestionList]
    @PreAssessmentId INT,
	@TrustId as int = 0
AS
BEGIN
	SELECT s.SectionName, q.QuestionId, q.Question, q.Optional, q.[FreeText], q.YesNo, q.DropdownOption, q.DropdownOptionText, 
		q.Suppressed, q.TrustId, 
		a.FreeTextAnswer, a.OptionAnswer, a.AnswerId, a.DropdownAnswer  
		FROM ERS_PreAssessmentSections s 
		INNER JOIN ERS_PreAssessmentQuestions q ON s.SectionId = q.SectionId  
		LEFT JOIN ERS_PreAssessmentAnswers a ON q.QuestionId = a.QuestionId  
		AND a.PreAssessmentId = @PreAssessmentId 
		WHERE (q.Suppressed = 0 OR (q.Suppressed = 1 AND a.QuestionId > 0))  
		AND (s.Suppressed = 0 OR (s.Suppressed = 1 AND a.QuestionId > 0))  
				ORDER BY  
			CASE WHEN s.SortOrder IS NULL THEN 1 ELSE 0 END,  
			s.SortOrder ASC,  
			CASE WHEN q.SortOrder IS NULL THEN 1 ELSE 0 END,  
			q.SortOrder ASC
END
GO

EXEC dbo.DropIfExist @ObjectName = 'Delete_Nurse_Module',
@ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[Delete_Nurse_Module]
	@nurseModuleId int
AS

BEGIN
	IF EXISTS (SELECT 1 FROM ERS_NurseModuleProcedure WHERE NurseModuleId = @nurseModuleId)
	BEGIN
		Delete from ERS_NurseModuleAnswers where NurseModuleId = @nurseModuleId
		Delete from ERS_NurseModuleProcedure where NurseModuleId = @nurseModuleId
	END

	IF @@ROWCOUNT > 0
	RETURN 1;
	ELSE
	RETURN 0;
END
GO

CREATE TABLE #temp (
    Section VARCHAR(MAX),
    Question VARCHAR(MAX)
);
INSERT INTO #temp
VALUES 
    ('Patient Information', 'Patient confirmed identity/ID band applied(b).Referral letter(b).why is the referral letter not available?(t).Patient notes available(b).why are the patient notes not available?(t).'),
    ('Sedation Type', 'Is the Patient having Sedation?(b).Is the patient having Entonox?(b).Is the Patient having throat spray?(b).Is the Patient having a General Aesthetic(b).'),
    ('Next of Kin / Emergency Contact', 'Name(t).Contact Number(t).Relationship to patient(t).'),
    ('Previous History', 'Has there been a change to medical/surgical history including GP/OPD/ED/hospital admissions or change in medication since date of Pre-assessment?(b).Free text box for further details(t).'),
    ('Pre Procedure Checks', 'Fasting for recommended period(b).Bowel preparation completed as prescribed(b).Problems identified(t).Does patient require phosphate enema(b)'),
    ('Signature', 'Nurse name(Nurse1,Nurse2,nurse3).Signature(t).Date & Time(t)'),
    ('Vital signs pre procedure', 'Resp.SP02%(Scale1,Scale2).Air or Oxygen?(Air,Oxyzen).BP(t).Level of Consciousness(Alert,Confusion,Voice,Pain,Unresponsive).'),
    ('phosphate enema', 'What type of enema was used?(enamea bowel,enamea bowel2).Name of staff member(Nurse1,Nurse2,Nurse3).');


DECLARE Cur_1 CURSOR FOR 
SELECT Section, Question FROM #temp;

OPEN Cur_1;

DECLARE @Section VARCHAR(200),
        @Question VARCHAR(MAX),
        @SectionId INT,
        @order INT = 1,
        @QuestionDetail VARCHAR(500),
        @YesNo INT,
        @FreeText INT,
        @DropdownOptions VARCHAR(MAX),
        @DropdownOptionText VARCHAR(MAX);

FETCH NEXT FROM Cur_1 INTO @Section, @Question;

WHILE (@@FETCH_STATUS = 0)
BEGIN

    SET @SectionId = ISNULL((SELECT SectionId FROM ERS_NurseModuleSection WHERE SectionName = @Section), 0);
    

    IF @SectionId = 0
    BEGIN
        INSERT INTO [dbo].ERS_NurseModuleSection ([SectionName], [ProcedureType], [Suppressed], [SortOrder], [WhoUpdatedId], [WhenUpdated]) 
        VALUES (@Section, 1, 0, @order, 1, GETDATE());
        SELECT @SectionId = SCOPE_IDENTITY();
    END

    SET @Question = REPLACE(@Question, CHAR(13) + CHAR(10), '');


    DECLARE comCursor CURSOR FOR 
    SELECT Item FROM fnSplitString(@Question, '.');

    OPEN comCursor;
    FETCH NEXT FROM comCursor INTO @QuestionDetail;

    WHILE @@FETCH_STATUS = 0
    BEGIN
        SET @YesNo = 0;
        SET @FreeText = 0;
        SET @DropdownOptions = NULL;
        SET @DropdownOptionText = NULL;

 
        DECLARE @ParenthesisContent VARCHAR(MAX);
        DECLARE @HasOptions INT;

        IF CHARINDEX('(', @QuestionDetail) > 0
        BEGIN
            SET @ParenthesisContent = SUBSTRING(@QuestionDetail, CHARINDEX('(', @QuestionDetail) + 1, CHARINDEX(')', @QuestionDetail) - CHARINDEX('(', @QuestionDetail) - 1);
            SET @QuestionDetail = REPLACE(@QuestionDetail, '(' + @ParenthesisContent + ')', ''); 


            SET @YesNo = CASE WHEN @ParenthesisContent = 'b' THEN 1 ELSE 0 END;
            SET @FreeText = CASE WHEN @ParenthesisContent = 't' THEN 1 ELSE 0 END;


            IF CHARINDEX(',', @ParenthesisContent) > 0
            BEGIN
                SET @HasOptions = 1;
                SET @DropdownOptions = 1;
                SET @DropdownOptionText = REPLACE(@ParenthesisContent, '', ''); 
            END
            ELSE
            BEGIN
                SET @DropdownOptions = 0;
            END
        END


        SET @QuestionDetail = LTRIM(RTRIM(@QuestionDetail));


        IF NOT EXISTS (SELECT 1 FROM ERS_NurseModuleQuestion WHERE Question = @QuestionDetail AND SectionId = @SectionId)
        BEGIN
            INSERT INTO [dbo].ERS_NurseModuleQuestion ( 
                [SectionId], 
                [Question], 
                [Mandatory], 
                [FreeText], 
                [YesNo], 
                [Suppressed], 
                [TrustId], 
                [WhoCreated], 
                [WhenCreated], 
                [WhoUpdated], 
                [WhenUpdated], 
                [DropdownOption], 
                [DropdownOptionText], 
                [SortOrder]
            )
            VALUES (
                @SectionId, 
                @QuestionDetail, 
                @YesNo, 
                @FreeText, 
                @YesNo, 
                0, 
                3, 
                1, 
                GETDATE(), 
                NULL, 
                NULL, 
                @DropdownOptions, 
                @DropdownOptionText, 
                @order
            );
        END

        FETCH NEXT FROM comCursor INTO @QuestionDetail;
    END

 
    CLOSE comCursor;
    DEALLOCATE comCursor;

    FETCH NEXT FROM Cur_1 INTO @Section, @Question;
    SET @order = @order + 1;
END

CLOSE Cur_1;
DEALLOCATE Cur_1;

DROP TABLE #temp;
GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#4330	
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Muhammad Nasim
-- TFS#	2362
-- Description of change: SEv2 EBUS updates
-------------------------------------------------------------------------------------------------------------------------
if not exists(select 1 from [dbo].[ERS_Indications] where [Description]='Lung cancer staging')
begin
	INSERT INTO [dbo].[ERS_Indications]([Description],[NEDTerm],[Suppressed],[AdditionalInfo],[SubIndicationParent],[PlannedProcedure],[IndicationSectionId],[JAGAuditable])
	VALUES('Lung cancer staging','Lung cancer staging',0,0,0,0,1,0)
	INSERT INTO [dbo].[ERS_IndicationsProcedureTypes]([IndicationId],[ProcedureTypeId])
	VALUES(SCOPE_IDENTITY() ,11)
end
if not exists(select 1 from [dbo].[ERS_Indications] where [Description]='Mediastinal lymphadenopathy')
begin
	INSERT INTO [dbo].[ERS_Indications]([Description],[NEDTerm],[Suppressed],[AdditionalInfo],[SubIndicationParent],[PlannedProcedure],[IndicationSectionId],[JAGAuditable])
	VALUES('Mediastinal lymphadenopathy','Mediastinal lymphadenopathy',0,0,0,0,1,0)
	INSERT INTO [dbo].[ERS_IndicationsProcedureTypes]([IndicationId],[ProcedureTypeId])
	VALUES(SCOPE_IDENTITY() ,11)
end
if not exists(select 1 from [dbo].[ERS_Indications] where [Description]='Other cancer')
begin
	INSERT INTO [dbo].[ERS_Indications]([Description],[NEDTerm],[Suppressed],[AdditionalInfo],[SubIndicationParent],[PlannedProcedure],[IndicationSectionId],[JAGAuditable])
	VALUES('Other cancer','Other cancer',0,1,0,0,1,0)
	INSERT INTO [dbo].[ERS_IndicationsProcedureTypes]([IndicationId],[ProcedureTypeId])
	VALUES(SCOPE_IDENTITY() ,11)
end
if not exists(select 1 from ERS_EBUSLymphNodes where EBUSLymphNodeId in (11,12,13,14,15,16))
begin
	insert into ERS_EBUSLymphNodes ([EBUSLymphNodeId],[Name],[XCoordinate],[YCoordinate],[RegionId],[ActualRegionName])
	values (11,'Lymph node station (11L-14L)',395,310,11019,'Left upper lobe bronchus'),
		   (12,'Lymph node station (11R-14R))',170,308,11010,'Anterior segment right upper lobe'),
		   (13,'Lymph node station 8L',320,348,11032,'Superior segment right lower lobe'),
		   (14,'Lymph node station 8R',254,358,11032,'Superior segment right lower lobe'),
		   (15,'Lymph node station 9L',343,416,11034,'Superior segment left lower lobe'),
		   (16,'Lymph node station 9R',203,415,11016,'Medial basal segment right lower lobe')
end

Go
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#2362 	(SEv2 EBUS updates)
------------------------------------------------------------------------------------------------------------------------
Go
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Muhammad Nasim
-- TFS#	2132
-- Description of change: SE V2 add Alcohol Status
-------------------------------------------------------------------------------------------------------------------------
GO
IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE object_id = OBJECT_ID('[dbo].[ERS_AlcoholingType]'))
BEGIN
CREATE TABLE [dbo].[ERS_AlcoholingType](
	[AlcoholingTypeId] [int] IDENTITY(1,1) NOT NULL PRIMARY KEY,
	[AlcoholingTypeName] [varchar](250) NULL,
	[Suppressed] [bit] NULL Default 0,
	[AlcoholingTypeAverageDescription] [varchar](250) NULL,
	[WhoUpdatedId] [int] NULL,
	[WhoCreatedId] [int] NULL,
	[WhenCreated] [datetime] NULL,
	[WhenUpdated] [datetime] NULL
)
END
GO

DECLARE @AlcoholType VARCHAR(50) = 'Beer,Wine,Spirits,Liquors';
DECLARE @ChildDesc VARCHAR(50); 
DECLARE comCursor CURSOR FOR
SELECT Item FROM fnSplitString(@AlcoholType, ',');

OPEN comCursor;

FETCH NEXT FROM comCursor INTO @ChildDesc;

WHILE @@FETCH_STATUS = 0
BEGIN
    IF NOT EXISTS (SELECT 1 FROM ERS_AlcoholingType WHERE AlcoholingTypeName = @ChildDesc)
    BEGIN
		INSERT INTO [dbo].[ERS_AlcoholingType] ([AlcoholingTypeName],[AlcoholingTypeAverageDescription])
		VALUES ( @ChildDesc,'Unit(s) per day for')
    END

    FETCH NEXT FROM comCursor INTO @ChildDesc;
END

CLOSE comCursor;
DEALLOCATE comCursor;
Go

dbo.DropIfExist
    @ObjectName = 'AlcoholingType_select',      -- varchar(100)
    @ObjectTypePrefix = 'S' -- varchar(5)
GO
Create  Procedure [dbo].[AlcoholingType_select]
As
Begin
select * from ERS_AlcoholingType
End
go
IF NOT EXISTS (SELECT 1 FROM sys.objects WHERE object_id = OBJECT_ID('[dbo].[ERS_ProcedureAlcoholing]'))
begin
CREATE TABLE [dbo].[ERS_ProcedureAlcoholing](
	[ProcedureAlcoholingId] [int] IDENTITY(1,1) NOT NULL PRIMARY KEY,
	[ProcedureId] [int] NOT NULL,
	[PatientId] [int] NOT NULL,
	[AlcoholingTypeId] [int] NOT NULL,
	[AlcoholingStatus] [varchar](50) NOT NULL,
	[AverageAlcoholing] [int] NULL,
	[AlcoholingNoYear] [int] NULL,
	[AlcoholedQuitYears] [int] NULL,
	[AlcoholedPerday] [int] NULL,
	[AlcoholedNoYear] [int] NULL,
	[AlcoholingDescription] [varchar](500) NULL,
	[WhoCreatedId] [int] NULL,
	[WhenCreated] [datetime] NOT NULL,
	[WhoUpdatedId] [int] NULL,
	[WhenUpdated] [datetime] NULL
)
end
go
dbo.DropIfExist
    @ObjectName = 'AlcoholingDetail_select',      -- varchar(100)
    @ObjectTypePrefix = 'S' -- varchar(5)
go
CREATE PROCEDURE [dbo].[AlcoholingDetail_select]
(
	@ProcedureId int
)
AS
BEGIN
	SELECT[ProcedureAlcoholingId] ,[AlcoholingTypeId] ,[AlcoholingStatus],[AlcoholingDescription]
	from ERS_ProcedureAlcoholing
	WHERE [ProcedureId] = @ProcedureId
	order by [ProcedureAlcoholingId]
END
go
dbo.DropIfExist
    @ObjectName = 'procedure_Alocoholing_save',      -- varchar(100)
    @ObjectTypePrefix = 'S' -- varchar(5)
go
CREATE PROCEDURE [dbo].[procedure_Alocoholing_save]
(
	
	@ProcedureId int, 
	@PatientId int,
	@AlcoholingTypeId int,
	@AlcoholingStatus varchar(50),
	@AverageAlcoholing int,
	@AlcoholingNoYear int,
	@AlcoholedQuitYears int,
	@AlcoholedPerday int,
	@AlcoholedNoYear int,
	@LoggedInUserId int
)
AS
BEGIN

declare @alcoholingText  varchar(400)
declare @sPerdayText varchar(100)=' '
declare @AlcoholingTypeName varchar(50)
select @sPerdayText=AlcoholingTypeAverageDescription,@AlcoholingTypeName=AlcoholingTypeName from ERS_AlcoholingType where AlcoholingTypeId=@AlcoholingTypeId
if @AlcoholingStatus='Yes'
 set @alcoholingText = @AlcoholingTypeName + ' an average of ' + cast(@AverageAlcoholing as varchar(10))+ ' ' + @sPerdayText + ' '+ cast(@AlcoholingNoYear as varchar(10)) + ' yrs.'

if @AlcoholingStatus='Stopped' 
    set @alcoholingText = 'Stopped ' + @AlcoholingTypeName +' ' + cast(@AlcoholedQuitYears as varchar(10)) + ' years ago, however alcoholed  ' + cast(@AlcoholedPerday as varchar(10)) + ' ' + @sPerdayText + ' ' + cast(@AlcoholedNoYear as varchar(10))+ ' yrs.'


		IF NOT EXISTS (SELECT 1 FROM ERS_ProcedureAlcoholing WHERE PatientId = @PatientId AND ProcedureId = @ProcedureId and AlcoholingTypeId=@AlcoholingTypeId)
		BEGIN
			INSERT INTO [dbo].[ERS_ProcedureAlcoholing] (ProcedureId, PatientId,AlcoholingTypeId,AlcoholingStatus,AverageAlcoholing,AlcoholingNoYear, AlcoholedQuitYears,AlcoholedPerday,AlcoholedNoYear,AlcoholingDescription,WhoCreatedId, WhenCreated)
			VALUES (@ProcedureId, @PatientId,@AlcoholingTypeId,@AlcoholingStatus, @AverageAlcoholing,@AlcoholingNoYear,@AlcoholedQuitYears,@AlcoholedPerday,@AlcoholedNoYear,@alcoholingText,@LoggedInUserId, getdate())
		END
		ELSE
		BEGIN
			UPDATE 
				ERS_ProcedureAlcoholing
			SET 
				AlcoholingTypeId = @AlcoholingTypeId,
				AlcoholingStatus = @AlcoholingStatus,
				AverageAlcoholing = @AverageAlcoholing,
				AlcoholingNoYear = @AlcoholingNoYear,
				AlcoholedQuitYears = @AlcoholedQuitYears,
				AlcoholedPerday = @AlcoholedPerday,
				AlcoholedNoYear = @AlcoholedNoYear,
				AlcoholingDescription=@alcoholingText,
				WhoUpdatedId=@LoggedInUserId,
				WhenUpdated=GETDATE()
			WHERE 
				PatientId = @PatientId AND ProcedureId = @ProcedureId and AlcoholingTypeId=@AlcoholingTypeId
		END

	--	DECLARE @Summary VARCHAR(max) = 'Alcoholing: ',
	--		@AlcoholingCount int = (SELECT count(*) FROM ERS_ProcedureIndications WHERE ProcedureId = @ProcedureId)

	--EXEC UI_update_procedure_summary @ProcedureId, 'Alcoholing', @Summary, @AlcoholingCount

	UPDATE ERS_ProceduresReporting
	SET PP_Indic = dbo.ProcedureIndicationsSummary(@ProcedureId)
	WHERE ProcedureId = @ProcedureId
	
	
END
go
dbo.DropIfExist
    @ObjectName = 'procedure_alcoholing_delete',      -- varchar(100)
    @ObjectTypePrefix = 'S' -- varchar(5)
go
CREATE PROCEDURE [dbo].[procedure_alcoholing_delete]
(
	@ProcedureAlcoholingId as int
)
as 
begin
declare @ProcedureId int
	Select @ProcedureId=ProcedureId
	from ERS_ProcedureAlcoholing
	WHERE ProcedureAlcoholingId = @ProcedureAlcoholingId
delete from ERS_ProcedureAlcoholing
	WHERE ProcedureAlcoholingId = @ProcedureAlcoholingId

		UPDATE ERS_ProceduresReporting
	SET PP_Indic = dbo.ProcedureIndicationsSummary(@ProcedureId)
	WHERE ProcedureId = @ProcedureId
end

Go
if not exists (select 1 from ERS_FamilyDiseaseHistory where Description in ('Family history of Barrett''s Oesophagus','Oesophageal cancer'))--1,6,8,9
begin
	insert into ERS_FamilyDiseaseHistory([Description],[AdditionalInfo],[Suppressed])
	values ('Family history of Barrett''s Oesophagus',0,0),('Oesophageal cancer',0,0)
end
declare @UniqueId int, @ProcedureTypeId int, @Description varchar(500)
declare ProcedureTypeCursor cursor for 
Select ProcedureTypeId From ERS_ProcedureTypes where ProcedureType in 
('Gastroscopy', 'ERCP', 'Colonoscopy', 'Sigmoidoscopy', 'Proctoscopy', 'EUS (OGD)', 'EUS (HPB)', 
'Ent - Antegrade', 'Ent - Retrograde', 'Bronchoscopy', 'EBUS', 'Cystoscopy')
open ProcedureTypeCursor
fetch next from ProcedureTypeCursor into @ProcedureTypeId
while @@FETCH_STATUS=0
begin
	declare UpdateFamilyCursor cursor for select UniqueId from ERS_FamilyDiseaseHistory
	open UpdateFamilyCursor fetch next from UpdateFamilyCursor into @UniqueId
	while @@FETCH_STATUS=0
	begin
		if not exists(select 1 from ERS_FamilyDiseaseHistoryProcedureTypes where FamilyDiseaseHistoryId=@UniqueId and ProcedureTypeId=@ProcedureTypeId)
		begin
			set @Description=(select [Description] from ERS_FamilyDiseaseHistory where UniqueId=@UniqueId)
			if (@Description in ('Family history of Barrett''s Oesophagus','Oesophageal cancer'))
			begin
				if (@ProcedureTypeId in (1,6,8,9))
				begin
					insert into ERS_FamilyDiseaseHistoryProcedureTypes ([FamilyDiseaseHistoryId],[ProcedureTypeId]) values(@UniqueId,@ProcedureTypeId)
				end
			end
			else
			begin
				insert into ERS_FamilyDiseaseHistoryProcedureTypes ([FamilyDiseaseHistoryId],[ProcedureTypeId]) values(@UniqueId,@ProcedureTypeId)
			end			
		end
		fetch next from UpdateFamilyCursor into @UniqueId
	end
	close UpdateFamilyCursor
	deallocate UpdateFamilyCursor
	fetch next from ProcedureTypeCursor into @ProcedureTypeId
end
CLOSE ProcedureTypeCursor
DEALLOCATE ProcedureTypeCursor
GO
	dbo.DropIfExist
    @ObjectName = 'family_disease_history_select',      -- varchar(100)
    @ObjectTypePrefix = 'S' -- varchar(5)
GO
CREATE PROCEDURE [dbo].[family_disease_history_select]
(
	@ProcedureTypeId int
)
AS
BEGIN
	SELECT a.UniqueId, a.[Description], a.AdditionalInfo
	FROM ERS_FamilyDiseaseHistory a inner join ERS_FamilyDiseaseHistoryProcedureTypes b
	on a.UniqueId=b.FamilyDiseaseHistoryId
	WHERE a.Suppressed = 0 and b.ProcedureTypeId=@ProcedureTypeId
	ORDER BY ISNULL(ListOrderBy,999), Description
END
GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	2132 Ended
------------------------------------------------------------------------------------------------------------------------


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Siddik
-- TFS#	4444
-- Description of change: FOB Indication
-------------------------------------------------------------------------------------------------------------------------

DELETE eip from ERS_IndicationsProcedureTypes eip
JOIN ERS_Indications ei ON eip.IndicationId = ei.UniqueId
WHERE ei.Description = 'FOB positive'
AND eip.ProcedureTypeId IN (3, 4)

GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	4444 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Siddik
-- TFS#	2604
-- Description of change: SEv2 bowel prep alphabetical order
-- Updated by	:	MOSTAFIZUR RAHMAN
-- TFS#	4158
-- Description of change
-- Bowel prep in clinical reproting 
-------------------------------------------------------------------------------------------------------------------------

EXEC dbo.DropIfExist 
    @ObjectName = 'bowel_prep_select', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[bowel_prep_select]
AS
BEGIN
	SELECT UniqueId, Description
	FROM ERS_BowelPrep
	WHERE Suppressed = 0
	ORDER BY ISNULL(ListOrderBy, 999), Description
END

GO

UPDATE ERS_BowelPrep
SET ListOrderBy = NULL
WHERE Description NOT IN ('No preparation', 'Other')
AND ListOrderBy IS NOT NULL
GO

EXEC dbo.DropIfExist 
    @ObjectName = 'procedure_bowel_prep_save', 
    @ObjectTypePrefix = 'S' 
GO

CREATE procedure [dbo].[procedure_bowel_prep_save]
(
	@ProcedureId int,
	@BowelPrepId int,
	@LeftScore int,
	@RightScore int,
	@TransverseScore int,
	@TotalScore int,
	@Quantity decimal(18,2),
	@EnemaId int,
	@EnemaOther varchar(200),
	@AdditionalInfo varchar(max),
	@LoggedInUserId int
)
AS
BEGIN
	IF @BowelPrepId >0 
	BEGIN
	    /*Check if new values been */
	    	IF ISNULL(@AdditionalInfo,'') <> ''
	    	BEGIN
				--edited by siddik --tfs 2604
	    		IF NOT EXISTS (SELECT 1 FROM ERS_BowelPrep WHERE Description = @AdditionalInfo)
	    		BEGIN
	    			INSERT INTO ERS_BowelPrep (Description, NEDTerm) VALUES (@AdditionalInfo, 'Other')	    			
	    		END
				--tfs 2604 end

	    		SELECT @BowelPrepId = UniqueId FROM ERS_BowelPrep WHERE Description = @AdditionalInfo
	    	END
	    
	    	/*Check if new values been */
	    	IF ISNULL(@EnemaOther,'') <> ''
	    	BEGIN
	    		IF NOT EXISTS (SELECT 1 FROM ERS_BowelPrepEnemas WHERE Description = @EnemaOther)
	    		BEGIN
	    			/*get and set the new items order id so it appears 1 above 'other' we always want other to be last*/
	    
	    			DECLARE @EOtherListOrderBy int = (SELECT ListOrderBy FROM ERS_BowelPrepEnemas WHERE Description = 'Other')
	    			INSERT INTO ERS_BowelPrepEnemas (Description, NEDTerm, ListOrderBy) VALUES (@EnemaOther, 'Other', @EOtherListOrderBy)
	    			
	    			UPDATE dbo.ERS_BowelPrepEnemas SET ListOrderBy = @EOtherListOrderBy + 1 WHERE Description = 'Other'
	    		END
	    
	    		SELECT @EnemaId = UniqueId FROM ERS_BowelPrepEnemas WHERE Description = @EnemaOther
	    	END
	    
	    	IF NOT EXISTS (SELECT 1 FROM ERS_ProcedureBowelPrep WHERE ProcedureId = @ProcedureId)
	    	BEGIN
	    		INSERT INTO ERS_ProcedureBowelPrep (ProcedureId, BowelPrepId, Quantity, LeftPrepScore, RightPrepScore, TransversePrepScore, TotalPrepScore, AdditionalInfo, EnemaId, WhoCreatedId, WhenCreated)
	    		VALUES (@ProcedureId, @BowelPrepId, @Quantity, NULLIF(@LeftScore, -1), NULLIF(@RightScore, -1), NULLIF(@TransverseScore,-1), NULLIF(@TotalScore, -1), '', @EnemaId, @LoggedInUserId, getdate())
	    	END
	    	ELSE
	    	BEGIN
	    		UPDATE ERS_ProcedureBowelPrep
	    		SET BowelPrepId = NULLIF(@BowelPrepId,0),
	    			Quantity = @Quantity,
	    			LeftPrepScore = NULLIF(@LeftScore, -1),
	    			RightPrepScore = NULLIF(@RightScore, -1),
	    			TransversePrepScore = NULLIF(@TransverseScore, -1),
	    			TotalPrepScore = NULLIF(@TotalScore, -1),
	    			AdditionalInfo = @AdditionalInfo,
	    			EnemaId = @EnemaId,
	    			WhoUpdatedId = @LoggedInUserId,
	    			WhenUpdated = getdate()
	    		WHERE ProcedureId = @ProcedureId
	    	END
	END
	ELSE
	BEGIN
	    DELETE FROM dbo.ERS_ProcedureBowelPrep WHERE ProcedureId =@ProcedureId
	END
	

	DECLARE @Summary VARCHAR(max), 
			@BowelPrepFormula varchar(max) = (SELECT [Description] FROM ERS_BowelPrep WHERE UniqueId = @BowelPrepId) + 
				CASE WHEN ISNULL(@EnemaId,0) > 0 THEN ' + ' + (SELECT [Description] FROM dbo.ERS_BowelPrepEnemas WHERE UniqueId = @EnemaId) ELSE '' END +
				CASE WHEN ISNULL(@Quantity,0) > 0 THEN ' (Volume ' + CONVERT(varchar(10), convert(int, @Quantity))  + ')' ELSE '' END

	
	SET @Summary = @BowelPrepFormula + '. '
	
	IF NULLIF(@TotalScore, -1) IS NOT NULL 
	BEGIN
		SET @Summary = @Summary + ' Boston Bowel Prep Total Score ' +  cast( @TotalScore as varchar(10))
		--'issue 4158
	SET @Summary = @Summary + CASE 
    WHEN ISNULL((SELECT ResectedColonNo FROM ers_procedures WHERE ProcedureId = @ProcedureId), '') NOT IN ('0', '')-- tfs 4158

        THEN CASE 
            WHEN @TotalScore <= 3 THEN ' (Look- Modified BBP)' 
            WHEN @TotalScore BETWEEN 4 AND 6 THEN ' (Good- Modified BBP)' 
            WHEN @TotalScore BETWEEN 7 AND 9 THEN ' (Excellent- Modified BBP)'
        END
    ELSE CASE 
            WHEN @TotalScore <= 3 THEN ' (Look)'
            WHEN @TotalScore BETWEEN 4 AND 6 THEN ' (Good)' 
            WHEN @TotalScore BETWEEN 7 AND 9 THEN ' (Excellent)'         
        END
	END
	 --'issue 4158
	END 

	--UPDATE  [ERS_BowelPreparation] SET Summary = @Summary WHERE ProcedureID=@ProcedureId
	UPDATE [ERS_ProceduresReporting] SET [PP_Bowel_Prep] = @Summary WHERE ProcedureID=@ProcedureId
	EXEC procedure_summary_update @ProcedureId

	DECLARE @SectionId int = (SELECT UISectionId FROM UI_Sections WHERE SectionName = 'Bowel Prep')

	DELETE FROM ERS_ProcedureSummary WHERE ProcedureId = @ProcedureId AND SectionId = @SectionId
	
	--validate completion
	EXEC procedure_bowel_prep_completion_check @ProcedureId	
END

GO

------------------------------------------------------------------------------------------------------------------------
-- TFS#	2604, 4158 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rezaul Karim
-- TFS#	3316
-- Description of change
-- Join procedure data integration 
------------------------------------------------------------------------------------------------------------------------
EXEC dbo.DropIfExist @ObjectName = 'usp_Procedure_Replicate',  
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO
CREATE PROCEDURE [dbo].[usp_Procedure_Replicate]
(
	@ProcedureID		INT,
	@ProcedureType		INT,
	@returnProcedureId INT OUTPUT
)
AS

SET NOCOUNT ON

DECLARE @newProcId INT, @AntiCoag BIT, @PotentialSignificantDrugs BIT, @isAllergyPresent BIT,@anticogOtherText VARCHAR(255)
BEGIN TRANSACTION

BEGIN TRY	

	IF EXISTS (Select 1 from ERS_Procedures where FormerProcedureId = @ProcedureID and IsActive = 1 and ProcedureType = @ProcedureType)  
		Select top 1 ProcedureId from ERS_Procedures where FormerProcedureId = @ProcedureID and IsActive = 1 and ProcedureType = @ProcedureType order by ProcedureId desc
	else
	BEGIN
		INSERT INTO [dbo].[ERS_Procedures]
			   ([ProcedureType]							,[CreatedBy]					,[CreatedOn]					,[ModifiedOn]
				,[PatientId]					        ,[OperatingHospitalID]	        ,[DiagramNumber]				,[ListConsultant]
				,[Endoscopist1]						,[Endoscopist2]					,[Assistant]					,[Nurse1]
				,[Nurse2]								,[Nurse3]						--,[Instrument1]					,[Instrument2]
				,[ReferralHospitalNo]					,[ReferralConsultantNo]			,[GPReferralFlag]				,[PatientStatus]
				,[Ward]									,[PatientType]					,[ReferralConsultantSpeciality]	
				,[PatientConsent]						,[GPCode]						,[CategoryListId]				,[EmergencyProcType]				
				,[GPPracticeCode]						,[ListType]						,[Endo1Role]					,[Endo2Role]					
				,[FormerProcedureId]					,[ImagePortId]					,[WhoCreatedId]					,[Points]
				,[ChecklistComplete]					,[ReferrerType]					,[ReferrertypeOther]			,[ProcedureTime] 
				,[ProviderTypeId]						,[ProviderOther]				,[PatientNotes]					,[PatientReferralLetter]
				,[AntiCoagDrugs])
			SELECT 
				@ProcedureType							,p.[CreatedBy]					,p.[CreatedOn]					,GETDATE()
				,p.[PatientId]					        ,p.[OperatingHospitalID]	    ,p.[DiagramNumber]				,p.[ListConsultant]
				,p.[Endoscopist1]						,p.[Endoscopist2]				,p.[Assistant]					,p.[Nurse1]
				,p.[Nurse2]								,p.[Nurse3]						--,p.[Instrument1]				,p.[Instrument2]
				,p.[ReferralHospitalNo]					,p.[ReferralConsultantNo]		,p.[GPReferralFlag]				,p.[PatientStatus]
				,p.[Ward]								,p.[PatientType]				,p.[ReferralConsultantSpeciality]	
				,p.[PatientConsent]						,p.[GPCode]						,p.[CategoryListId]				,p.[EmergencyProcType]
				,p.[GPPracticeCode]						,p.[ListType]					,p.[Endo1Role]					,p.[Endo2Role]					
				,@ProcedureID							,p.[ImagePortId]				,p.[WhoCreatedId]				,p.[Points]
				,p.[ChecklistComplete]					,p.[ReferrerType]				,p.[ReferrertypeOther]			,p.[ProcedureTime] 
				,p.[ProviderTypeId]						,p.[ProviderOther]				,p.[PatientNotes]				,p.[PatientReferralLetter]
				,p.[AntiCoagDrugs]
			FROM ERS_Procedures p 
			WHERE p.ProcedureId = @ProcedureID

		SET @newProcId = SCOPE_IDENTITY()

		--Copy ProceduresReporting (PP fields)
		INSERT INTO [dbo].[ERS_ProceduresReporting]
			   ( [PP_PatAddress]						,[PP_RefHosp]					,[PP_CNN]						,[PP_RepDateAndTime]
				,[PP_RepType]							,[PP_GP]						,[PP_PatStatus]					,[PP_Ward]
				,[PP_RefCons]							,[PP_Endos]						,[PP_Premed]
				--,[PP_Indic]								,[PP_MainReportBody]			,[PP_Diagnoses]				,[PP_Instrument]	
				,[PP_Endo1]						
				,[PP_CCRefCons]							,[PP_CCOther]					,[PP_CCPatient]					,[PP_RepHead]					
				,[PP_RepSubHead]						,[PP_OpHosp]					,[PP_Room_ID]					,[PP_Priority]					
				,[PP_GPName]							,[PP_GPAddress]					,[PP_Endo2]
				,ProcedureId							,[PP_PathwayPlan])
			SElECT 	
				 pr.[PP_PatAddress]						,pr.[PP_RefHosp]				,pr.[PP_CNN]					,pr.[PP_RepDateAndTime]
				,pr.[PP_RepType]						,pr.[PP_GP]						,pr.[PP_PatStatus]				,pr.[PP_Ward]
				,pr.[PP_RefCons]						,pr.[PP_Endos]					,pr.[PP_Premed]
				--,pr.[PP_Indic]							,pr.[PP_MainReportBody]			,pr.[PP_Diagnoses]			,pr.[PP_Instrument]	
				,pr.[PP_Endo1]						
				,pr.[PP_CCRefCons]						,pr.[PP_CCOther]				,pr.[PP_CCPatient]				,pr.[PP_RepHead]					
				,pr.[PP_RepSubHead]						,pr.[PP_OpHosp]					,pr.[PP_Room_ID]				,pr.[PP_Priority]					
				,pr.[PP_GPName]							,pr.[PP_GPAddress]				,pr.[PP_Endo2]					
				,@newProcId								,pr.PP_Bowel_Prep
			FROM ERS_ProceduresReporting pr 
			WHERE pr.ProcedureId = @ProcedureID

			select top 1 @AntiCoag = AntiCoagDrugs,@PotentialSignificantDrugs = PotentialSignificantDrugs from ERS_Procedures where ProcedureId = @ProcedureID
			select top 1 @anticogOtherText = AdditionalInfo from ERS_ProcedureDamagingDrugs where ProcedureId = @ProcedureID and (AdditionalInfo is not null and AdditionalInfo <> '')


		--Copy Premedication

		DECLARE @PreMedFieldName VARCHAR(50),
				@sqlString varchar(500)

		Select @PreMedFieldName = CASE @ProcedureType
									WHEN 1 THEN 'UsedInUpperGI' --Gasrto
									WHEN 2 THEN 'UsedInERCP' --ERCP
									WHEN 3 THEN 'UsedInColonSig' --Colon
									WHEN 4 THEN 'UsedInColonSig' --Sig
									WHEN 5 THEN 'UsedInColonSig' -- proct
									WHEN 6 THEN 'UsedInEUS_OGD' --EUS OGD
									WHEN 7 THEN 'UsedInEUS_HPB' --EUS HPB
									WHEN 8 THEN 'UsedInAntigrade' --ENT Anti
									WHEN 9 THEN 'UsedInRetrograde' --ENT Retro
									WHEN 10 THEN 'UsedInBroncho' --Bronchs
									WHEN 11 THEN 'UsedInEBUS' --EBUS
									WHEN 13 THEN 'UsedInFlexiCystoscopy' --Cysto
									ELSE 'UsedInUpperGI' -- Unknown procedure type. Use Gastro.
								  END		
		SET @sqlString = 'INSERT INTO ERS_UpperGIPremedication (ProcedureId, DrugNo, DrugName, Dose, Units, DeliveryMethod) '
		SET @sqlString = @sqlString + 'SELECT ' + CONVERT(VARCHAR, @newProcId) 
		SET @sqlString = @sqlString + ', pre.DrugNo, pre.DrugName, pre.Dose, pre.Units, pre.DeliveryMethod '
		SET @sqlString = @sqlString + ' FROM ERS_UpperGIPremedication pre '
		SET @sqlString = @sqlString + ' JOIN  ERS_DrugList dl on pre.DrugNo = dl.DrugNo WHERE ProcedureId = ' 
		SET @sqlString = @sqlString + CONVERT(VARCHAR, @ProcedureID) + ' AND ' + @PreMedFieldName + ' = 1'

		exec (@sqlString)

		IF @@ROWCOUNT > 0
		BEGIN
			DECLARE @Summary VARCHAR(max) = 'Procedure drugs:', 
					@DrugCount bit = (SELECT count(*) FROM ERS_UpperGIPremedication WHERE ProcedureId = @newProcId)

			EXEC UI_update_procedure_summary @newProcId, 'Procedure drugs', @Summary, @DrugCount	

			EXEC ogd_premedication_summary_update @newProcId
		END 


		--Copy Co-Morbidity
		INSERT INTO ERS_ProcedureComorbidity (ProcedureId, ComorbidityId, ChildComorbidityId, AdditionalInformation, WhoCreatedId, WhenCreated, WhoUpdatedId, WhenUpdated)
		SELECT @newProcId, ComorbidityId, ChildComorbidityId, AdditionalInformation, WhoCreatedId, GETDATE(), WhoUpdatedId, GETDATE() FROM ERS_ProcedureComorbidity WHERE ProcedureId = @ProcedureId
	
	
		IF @@ROWCOUNT > 0
		BEGIN
			DECLARE @Summary_c VARCHAR(max) = 'Comorbidity: ',
				@ComorbidityCount int = (SELECT count(*) FROM ERS_ProcedureComorbidity WHERE ProcedureId = @newProcId)

			EXEC UI_update_procedure_summary @newProcId, 'Comorbidity', @Summary_c, @ComorbidityCount

			UPDATE ERS_ProceduresReporting
			SET PP_Indic = dbo.ProcedureIndicationsSummary(@newProcId)
			WHERE ProcedureId = @newProcId
		END 

		--Copy ASAStatus
		INSERT INTO ERS_PatientASAStatus (PatientId, ProcedureCreatedId, ASAStatusId, WhoCreatedId, WhenCreated, WhoUpdatedId, WhenUpdated)
		SELECT PatientId, @newProcId, ASAStatusId, WhoCreatedId, GETDATE(), WhoUpdatedId, GETDATE() FROM ERS_PatientASAStatus WHERE ISNULL(ProcedureUpdatedId, ProcedureCreatedId) = @ProcedureId
	
	
		IF @@ROWCOUNT > 0
		BEGIN
			DECLARE @Summary_a VARCHAR(max) = 'ASA Status: ',
				@ASAStatusCount int = (SELECT count(*) FROM ERS_PatientASAStatus WHERE ISNULL(ProcedureUpdatedId, ProcedureCreatedId) = @newProcId)

			EXEC UI_update_procedure_summary @newProcId, 'ASA Status', @Summary_a, @ASAStatusCount

			UPDATE ERS_ProceduresReporting
			SET PP_Indic = dbo.ProcedureIndicationsSummary(@newProcId)
			WHERE ProcedureId = @newProcId
		END 
		if @AntiCoag = 1
			BEGIN
				DECLARE @drugIds varchar(255), @whoCreatedId int
				SELECT @AntiCoag AS TEST
				SELECT @drugIds = STUFF((SELECT ',' + CAST(DamagingDrugId AS VARCHAR(10))
								 FROM ERS_ProcedureDamagingDrugs
								 WHERE ProcedureId = @ProcedureID
								FOR XML PATH('')), 1, 1, '')
				exec procedure_damaging_drugs_save @newProcId, @drugIds,1,1,'Anti-coag drugs','',@PotentialSignificantDrugs,@anticogOtherText
			END
			--allergies--copy
			IF EXISTS(SELECT  1 from ERS_PatientAllergies WHERE ISNULL(ProcedureUpdatedId, ProcedureCreatedId) = @ProcedureId)
		    Begin
				INSERT INTO ERS_PatientAllergies (PatientId, ProcedureCreatedId, AllergyResult, AllergyDescription, WhoCreatedId, WhenCreated)
				select PatientId, @newProcId, AllergyResult, AllergyDescription, WhoCreatedId, GETDATE() from ERS_PatientAllergies where ISNULL(ProcedureUpdatedId, ProcedureCreatedId) = @ProcedureId
				
				If @@ROWCOUNT > 0
				BEGIN
					UPDATE ERS_ProceduresReporting
					SET PP_Indic = dbo.ProcedureIndicationsSummary(@newProcId)
					WHERE ProcedureId = @ProcedureId
	
					DECLARE @allergySummary VARCHAR(max) = 'Allergies',
							@AllergyCount int = (SELECT 1 FROM ERS_PatientAllergies WHERE (ProcedureCreatedId = @ProcedureId or ProcedureUpdatedId = @ProcedureId))

					EXEC UI_update_procedure_summary @ProcedureId, 'Allergies', @allergySummary, @AllergyCount
				END
			End

		SET @returnProcedureId = @newProcId
	END
END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH

IF @@TRANCOUNT > 0 COMMIT TRANSACTION;
GO
-----------------------------------------------------------------------------------------------------------------
---- 3316 END------
-----------------------------------------------------------------------------------------------------------------

-------------------------------------------------------------------------------------------------------------------------
--TFS# 3147-------------
-------------------------------------------------------------------------------------------------------------------------
EXEC dbo.DropIfExist @ObjectName = 'spGetScopeListByOperatingHospitalandTrust',  
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO
CREATE PROCEDURE [dbo].[spGetScopeListByOperatingHospitalandTrust]    
(
	@ProcedureTypeId int,
	@TrustId int,
	@OperatingHospitalId int,
	@ProcedureId int
)    
AS   
-- =============================================
-- Author:		Mahfuz
-- Create date: 31 Aug 2022 - copied from SE1
-- Get the List of Scopes for two combo box in Create Procedure/Edit Procedure screen
-- =============================================

BEGIN 
	declare @UsedScope1 as int
	declare @UsedScope2 as int

	declare @ScopesTableVar as Table
	(
		ScopeId int,
		ScopeName varchar(200),
		ScopeGenerationId int null
	)

	if IsNull(@OperatingHospitalId,0) > 0
	Begin
		Insert into @ScopesTableVar
		 SELECT
			DISTINCT s.ScopeId, s.ScopeName,s.ScopeGenerationId
				FROM [ERS_Scopes] s 
				INNER JOIN ERS_ScopeProcedures p On p.ScopeId = s.ScopeId And p.ProcedureTypeId = @ProcedureTypeId		
				Inner Join ERS_ScopeOperatingHospitals SOH on SOH.ScopeId = s.ScopeId
				INNER JOIN ERS_OperatingHospitals h On SOH.OperatingHospitalId = h.OperatingHospitalId
				WHERE h.TrustId = @TrustId AND s.Suppressed = 0
				and SOH.OperatingHospitalId = @OperatingHospitalId
				ORDER BY ScopeName
	End
	Else
	Begin
		Insert into @ScopesTableVar
		 SELECT
			DISTINCT s.ScopeId, s.ScopeName, s.ScopeGenerationId
				FROM [ERS_Scopes] s 
				INNER JOIN ERS_ScopeProcedures p On p.ScopeId = s.ScopeId And p.ProcedureTypeId = @ProcedureTypeId		
				Inner Join ERS_ScopeOperatingHospitals SOH on SOH.ScopeId = s.ScopeId
				INNER JOIN ERS_OperatingHospitals h On SOH.OperatingHospitalId = h.OperatingHospitalId
				WHERE h.TrustId = @TrustId AND s.Suppressed = 0
				ORDER BY ScopeName
	End

	if IsNull(@OperatingHospitalId,0) > 0
	Begin
		Select @UsedScope1 = Instrument1, @UsedScope2 = Instrument2 from ERS_Procedures Where ProcedureId = @ProcedureId

		If not exists(Select * from @ScopesTableVar Where ScopeId = @UsedScope1)
		Begin
			Insert into @ScopesTableVar(ScopeId,ScopeName,ScopeGenerationId)
			Select ScopeId,ScopeName,ScopeGenerationId from ERS_Scopes Where ScopeId = @UsedScope1
		End

		If not exists(Select * from @ScopesTableVar Where ScopeId = @UsedScope2)
		Begin
			Insert into @ScopesTableVar(ScopeId,ScopeName,ScopeGenerationId)
			Select ScopeId,ScopeName,ScopeGenerationId from ERS_Scopes Where ScopeId = @UsedScope2
		End
	End

	Select * from @ScopesTableVar Order by ScopeName
END
GO
-------------------------------------------------------------------------------------------------------------------------
--END-------------
-------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rony
-- TFS#	3059
-- Description of change
-- deleting a report from - add comments box
------------------------------------------------------------------------------------------------------------------------

EXEC dbo.DropIfExist 
    @ObjectName = 'usp_Procedures_Delete', 
    @ObjectTypePrefix = 'S' 
GO
CREATE PROCEDURE [dbo].[usp_Procedures_Delete]
(
	@ProcedureId INT,
	@DeleteText NVARCHAR(MAX), --Added by rony tfs-3059
	@UserId INT
)
AS

--## We should not delete any record from the Transactional Database.. Only Flag it as Inactive..
	UPDATE ERS_Procedures 
	   SET	IsActive = 0,
			WhoUpdatedId = @UserId,
			WhenUpdated = GETDATE(),
			DeletedDate = GETDATE(), --Added by rony tfs-3059
			DeleteText = @DeleteText
	 WHERE ProcedureId  = @ProcedureId;

	 --Insert into OCS Process table to mark as deleted
	 INSERT INTO ERS_OCS_Process (Process, ProcedureId, TrustId, isDeletion)
	 SELECT 'ORU|' + CONVERT(VARCHAR, p.PatientId) + '||' + CONVERT(VARCHAR, p.ProcedureId) + '||PDF|0', p.ProcedureId, op.TrustId, 1
	 FROM ERS_Procedures p
	 JOIN ERS_OperatingHospitals op ON p.OperatingHospitalID = op.OperatingHospitalId 
	 WHERE ProcedureId = @ProcedureId

GO 

if not  exists(select 1 from ERS_AuditReports where AuditReportStoredProcedure='procedureDeletedReport')
     insert into ERS_AuditReports values ('Procedure Deleted Report', 'procedureDeletedReport','R')
GO

EXEC dbo.DropIfExist 
    @ObjectName = 'procedureDeletedReport', 
    @ObjectTypePrefix = 'S' 
GO
CREATE PROCEDURE [dbo].[procedureDeletedReport]
	@UserId int
AS
BEGIN
DECLARE @FromDate as Date,
			@ToDate as Date,
			@TrustId as int,
			@HealthService as varchar(max),
			@OperatingHospitalList as varchar(100)
	SELECT	@FromDate = FromDate,
			@ToDate = ToDate, 
			@TrustId = TrustId,
			@OperatingHospitalList=OperatingHospitalList
	FROM	ERS_ReportFilter
	WHERE	UserID = @UserId

	 SELECT	 	 
	 (patient.Surname + ', '+ patient.Forename1) AS 'Name',
	 convert(varchar, patient.DateOfBirth, 106) AS 'DOB',
	 STUFF((SELECT DISTINCT ',' + HospitalNumber from ERS_PatientTrusts WHERE PatientId = proce.PatientId and IsMinor = 0 for xml path('')), 1, 1, '')AS 'Hospital Number',
	 dbo.fn_FormatHealthServiceNumber(patient.NHSNo, @HealthService)  AS 'NHS Number',
	 oh.HospitalName AS 'Operating Hospital',
	 '' AS 'Procedure report cancelled',
	 Convert(varchar,ModifiedOn,106) AS 'Date of procedure',
	 Convert(varchar,proce.DeletedDate,106) AS 'Date deleted & time',
	 proce.DeleteText AS 'Comments on why deleted'
	 FROM  ERS_Procedures proce 
	 JOIN ERS_Users u1 ON proce.Endoscopist1 = u1.UserID
	 JOIN ERS_Patients patient ON patient.PatientId = proce.PatientId
	 JOIN ERS_ReportConsultants reportCon ON reportCon.ConsultantID = u1.UserID
	 JOIN ERS_OperatingHospitals oh on proce.OperatingHospitalID = oh.OperatingHospitalId
	 WHERE 
	 cast(proce.DeletedDate as date) BETWEEN @FromDate AND @ToDate AND proce.DeleteText IS NOT NULL
	 AND proce.OperatingHospitalID IN (SELECT * FROM dbo.splitString(@OperatingHospitalList,',') ) 
	 AND reportCon.UserID = @UserId
	 ORDER BY proce.DeletedDate
END
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	3059
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	: Raihanul	
-- TFS#	4375
-- Description of change: Suspected with cancer data report 
------------------------------------------------------------------------------------------------------------------------

IF NOT EXISTS(SELECT 1 FROM ERS_AuditReports WHERE AuditReportDescription ='Suspected With Cancer')
BEGIN
	INSERT INTO ERS_AuditReports(AuditReportDescription, AuditReportStoredProcedure, ReportModule)
		VALUES('Suspected With Cancer', 'audit_SuspectedWithCancer', 'R')
END
GO

EXEC dbo.DropIfExist 
    @ObjectName = 'audit_SuspectedWithCancer', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE audit_SuspectedWithCancer 
	@UserId int
AS
BEGIN
	DECLARE @FromDate as Date,
			@ToDate as Date,
			@TrustId as int,
			@HealthService as varchar(max),
			@OperatingHospitalList as varchar(100)

	Select	@FromDate = FromDate,
			@ToDate = ToDate,
			@TrustId = TrustId,
			@OperatingHospitalList=OperatingHospitalList
	FROM	ERS_ReportFilter
	where	UserID = @UserId
	
	SELECT @HealthService = CustomText FROM ERS_Custom_Text WHERE CustomTextId = 'CountryOfOriginHealthService'

Declare @tableVarTherapeutics Table(
ProcedureId Int Not null,
TherapeuticProcedures varchar(4000) null
)
Insert into @tableVarTherapeutics(ProcedureId,TherapeuticProcedures)
select S.ProcedureId,
TherapeuticProcedures = R.Region + ':' + Case When TP.[None] = '1' then 'None'
Else
	Case when Len(Ltrim(Rtrim(Case when TP.YAGLaser = '1' then 'YAG Laser, ' else '' end
	+
	Case When TP.ArgonBeamDiathermy = '1' then 'Argon beam diathermy, ' else '' end
	+
	Case When TP.BalloonDilation = '1' then 'Balloon dilation, ' else '' end
	+ 
	Case When TP.BotoxInjection = '1' then 'Botox injection, ' else '' end
	+
	Case When TP.EndoloopPlacement = '1' then 'Endoloop placement, ' else '' end
	+
	Case when TP.HeatProbe = '1' then 'Heater probe coagulation, ' else '' end
	+
	Case when TP.BicapElectro = '1' then 'Bicap electrocautery, ' else '' end
	+
	Case when TP.Diathermy = '1' then 'Diathermy, ' else '' end
	+
	Case when TP.HotBiopsy = '1' then 'Hot biopsy, ' else '' end
	+
	Case when TP.ForeignBody = '1' then 'Foreign body removal, ' else '' end
	+
	Case when TP.Injection = '1' then 'Injection therapy, ' else '' end
	+
	Case when TP.Polypectomy = '1' then 'Polypectomy, ' else '' end
	+
	Case when TP.GastrostomyInsertion = '1' then 'Gastrostomy insertion (PEG), ' else '' end
	+
	Case when TP.GastrostomyRemoval = '1' then 'Gastrostomy removal (PEG), ' else '' end
	+
	Case when TP.NGNJTubeInsertion = '1' then 'NG/NJ tube insertion, ' else '' end
	+
	Case when TP.VaricealSclerotherapy = '1' then 'Variceal sclerotherapy, ' else '' end
	+
	Case when TP.VaricealBanding = '1' then 'Variceal banding, ' else '' end
	+
	Case when TP.StentInsertion = '1' then 'Stent insertion, ' else '' end
	+
	Case when TP.StentRemoval = '1' then 'Stent removal, ' else '' end
	+
	Case when TP.Marking = '1' then 'Marking, ' else '' end
	+
	Case when TP.Clip = '1' then 'Clip, ' else '' end
	+
	Case when TP.EndoClot = '1' then 'Endo clot, ' else '' end
	))) > 1 then
	Left(Ltrim(Rtrim(Case when TP.YAGLaser = '1' then 'YAG Laser, ' else '' end
	+
	Case When TP.ArgonBeamDiathermy = '1' then 'Argon beam diathermy, ' else '' end
	+
	Case When TP.BalloonDilation = '1' then 'Balloon dilation, ' else '' end
	+ 
	Case When TP.BotoxInjection = '1' then 'Botox injection, ' else '' end
	+
	Case When TP.EndoloopPlacement = '1' then 'Endoloop placement, ' else '' end
	+
	Case when TP.HeatProbe = '1' then 'Heater probe coagulation, ' else '' end
	+
	Case when TP.BicapElectro = '1' then 'Bicap electrocautery, ' else '' end
	+
	Case when TP.Diathermy = '1' then 'Diathermy, ' else '' end
	+
	Case when TP.HotBiopsy = '1' then 'Hot biopsy, ' else '' end
	+
	Case when TP.ForeignBody = '1' then 'Foreign body removal, ' else '' end
	+
	Case when TP.Injection = '1' then 'Injection therapy, ' else '' end
	+
	Case when TP.Polypectomy = '1' then 'Polypectomy, ' else '' end
	+
	Case when TP.GastrostomyInsertion = '1' then 'Gastrostomy insertion (PEG), ' else '' end
	+
	Case when TP.GastrostomyRemoval = '1' then 'Gastrostomy removal (PEG), ' else '' end
	+
	Case when TP.NGNJTubeInsertion = '1' then 'NG/NJ tube insertion, ' else '' end
	+
	Case when TP.VaricealSclerotherapy = '1' then 'Variceal sclerotherapy, ' else '' end
	+
	Case when TP.VaricealBanding = '1' then 'Variceal banding, ' else '' end
	+
	Case when TP.StentInsertion = '1' then 'Stent insertion, ' else '' end
	+
	Case when TP.StentRemoval = '1' then 'Stent removal, ' else '' end
	+
	Case when TP.Marking = '1' then 'Marking, ' else '' end
	+
	Case when TP.Clip = '1' then 'Clip, ' else '' end
	+
	Case when TP.EndoClot = '1' then 'Endo clot, ' else '' end
	)),Len(Ltrim(Rtrim(Case when TP.YAGLaser = '1' then 'YAG Laser, ' else '' end
	+
	Case When TP.ArgonBeamDiathermy = '1' then 'Argon beam diathermy, ' else '' end
	+
	Case When TP.BalloonDilation = '1' then 'Balloon dilation, ' else '' end
	+ 
	Case When TP.BotoxInjection = '1' then 'Botox injection, ' else '' end
	+
	Case When TP.EndoloopPlacement = '1' then 'Endoloop placement, ' else '' end
	+
	Case when TP.HeatProbe = '1' then 'Heater probe coagulation, ' else '' end
	+
	Case when TP.BicapElectro = '1' then 'Bicap electrocautery, ' else '' end
	+
	Case when TP.Diathermy = '1' then 'Diathermy, ' else '' end
	+
	Case when TP.HotBiopsy = '1' then 'Hot biopsy, ' else '' end
	+
	Case when TP.ForeignBody = '1' then 'Foreign body removal, ' else '' end
	+
	Case when TP.Injection = '1' then 'Injection therapy, ' else '' end
	+
	Case when TP.Polypectomy = '1' then 'Polypectomy, ' else '' end
	+
	Case when TP.GastrostomyInsertion = '1' then 'Gastrostomy insertion (PEG), ' else '' end
	+
	Case when TP.GastrostomyRemoval = '1' then 'Gastrostomy removal (PEG), ' else '' end
	+
	Case when TP.NGNJTubeInsertion = '1' then 'NG/NJ tube insertion, ' else '' end
	+
	Case when TP.VaricealSclerotherapy = '1' then 'Variceal sclerotherapy, ' else '' end
	+
	Case when TP.VaricealBanding = '1' then 'Variceal banding, ' else '' end
	+
	Case when TP.StentInsertion = '1' then 'Stent insertion, ' else '' end
	+
	Case when TP.StentRemoval = '1' then 'Stent removal, ' else '' end
	+
	Case when TP.Marking = '1' then 'Marking, ' else '' end
	+
	Case when TP.Clip = '1' then 'Clip, ' else '' end
	+
	Case when TP.EndoClot = '1' then 'Endo clot, ' else '' end
	)))-1)
	else '' end
end
from
	ERS_UpperGITherapeutics TP
	inner join ERS_Sites S on TP.SiteId = S.SiteId
	Inner Join ERS_Regions R on S.RegionId = R.RegionId

Select 
		p.ProcedureId 
		, pat.Forename1 as Forename
		, pat.Surname as Surname
		, dbo.fn_FormatHealthServiceNumber(pat.NHSNo, @HealthService) as 'NHS number'
		, pat.HospitalNumber as 'Case note number'
		, convert(varchar(14),pat.DateOfBirth,106) as DOB
		, oh.HospitalName as 'Operating hospital'
		, gt.Title as Sex
		, pat.Postcode as 'Patients postcode'
		, pt.ProcedureType as 'Procedure name'
		,case when p.providerTypeId =1 then dbo.fnGetProviderName(p.providerTypeId) else p.ProviderOther end as 'Provider'
		, dbo.fnGetRefferNameName(p.ReferrerType) AS 'Referrer'	--edited by siddik --TFS 4375
		,dbo.fnGetCategoryName(p.CategoryListId ) as 'Category'
		,ISNULL(p.StartDateTime, p.ModifiedOn)  as 'Procedure start time'
		,p.ENDDateTime  as 'Procedure End time'
		, case when thera.procedureId is null then 'Diagnostic' else 'Therapeutic' end as 'Therapeutic or diagnostic'
		, dbo.fnGetAgeAtDate(pat.DateOfBirth, p.CreatedOn) as 'Age at procedure'
		, case p.PatientStatus when 1 then 'Inpatient' when 2 then 'Outpatient' else 'Day Patient' end as 'Patient Status'	--edited by siddik --TFS 4375
		, case when p.PatientType = 1 then 'NHS' else 'Private' end as 'Patient Type'	--edited by siddik --TFS 4375
		, ListCons.Surname + ', ' + ListCons.Forename as 'List consultant'
		, Endo1.Surname + ', ' + Endo1.Forename as 'Endoscopist 1'
		, Endo2.Surname + ', ' + Endo2.Forename as 'Endoscopist 2'
		, pr.PP_Indic as Indications
		, (select Description from ERS_ASAStatus where UniqueId = pas.ASAStatusId) as 'ASA status'	--edited by siddik --TFS 4375
		, ISNULL(CASE epfuqa.OptionAnswer WHEN 1 THEN 'Yes' WHEN 0 THEN 'No' WHEN -1 THEN 'Unknown' END, '') + 
			ISNULL(( ' (' + (SELECT ListItemText FROM ers_lists WHERE ListId = epfuqa.EvidenceOfCancer) + ')'), '') AS 'Evidence of cancer'	--edited by siddik --TFS 4375
		, DrugList as Drugs
		, d.SessileExcised as 'Sessile ployps excised'
		, d.SessileToLabs as 'Sessile ployps sent to lab'
		, d.PedunculatedExcised as 'Pedunculated ployps excised'
		, d.PedunculatedToLabs as 'Pedunculated ployps sent to lab'
		, d.SubmucosalExcised as 'Submucosal ployps excised'
		, d.SubmucosalToLabs as 'Submucosal ployps sent to lab'
		, d.PseudopolypsExcised as 'Pseudo ployps excised'
		, d.PseudopolypsToLabs as 'Pseudo ployps sent to lab'
		, d.BiopsyQtyHistology as 'Bx to histology'
		, CASE WHEN ISNULL(CEOI.NED_TimeToCaecumMin, 0) = 0 
			THEN CASE WHEN ISNULL(CEOI.TimeToCaecumMin, 0) = 0 
				THEN CASE WHEN ISNULL(CEOI.TimeToCaecumMin_Photo, 0) = 0 
					THEN 0
					ELSE CEOI.TimeToCaecumMin_Photo + CASE WHEN ISNULL(CEOI.TimeToCaecumSec_Photo, 0) >= 30 THEN 1 ELSE 0 END
					END
				ELSE 	CEOI.TimeToCaecumMin + CASE WHEN ISNULL(CEOI.TimeToCaecumSec, 0) >= 30 THEN 1 ELSE 0 END
				END
			ELSE	CEOI.NED_TimeToCaecumMin + CASE WHEN ISNULL(CEOI.NED_TimeToCaecumSec, 0) >= 30 THEN 1 ELSE 0 END
		   END as 'Time to caecum (lower only)'		
		 , CASE WHEN ISNULL(CEOI.NED_TimeForWithdrawalMin, 0) = 0 
			THEN CASE WHEN ISNULL(CEOI.TimeForWithdrawalMin, 0) = 0 
				THEN CASE WHEN ISNULL(CEOI.TimeForWithdrawalMin_Photo, 0) = 0 
					THEN 0
					ELSE CEOI.TimeForWithdrawalMin_Photo + CASE WHEN ISNULL(CEOI.TimeForWithdrawalSec_Photo, 0) >= 30 THEN 1 ELSE 0 END
					END
				ELSE 	CEOI.TimeForWithdrawalMin + CASE WHEN ISNULL(CEOI.TimeForWithdrawalSec, 0) >= 30 THEN 1 ELSE 0 END
				END
			ELSE	CEOI.NED_TimeForWithdrawalMin + CASE WHEN ISNULL(CEOI.NED_TimeForWithdrawalSec, 0) >= 30 THEN 1 ELSE 0 END
		  END as 'Time for withdrawal (lower only)'
	    , qa.PatDiscomfortEndo as 'Endoscopists patient comfort score'
	    , qa.PatDiscomfortNurse as 'Nurse patient comfort score'
	    , qa.PatDiscomfortPatient as 'patients own comfort score'
		, case qa.PatSedation	when 0 then 'Not completed' 
								when 1 then 'Not recorded' 
								when 2 then 'Awake' 
								when 3 then 'Drowsy' 
								when 4 then 'Asleep but responding to name' 
								when 5 then 'Asleep but responding to touch' 
								when 6 then 'Asleep but unresponsive' 
								else 'Unknown' end as 'Patient sedation'
		, '"'+pr.pp_AdviceAndComments+'"'  as 'Advice and comments'
		, pr.PP_Followup as 'Follow up'
		, pr.PP_Diagnoses as Diagnoses
		,UPQA.AdverseEvents
		,UPQA.Complications
		,Therap.TherapeuticProcedures
from ERS_Procedures p (nolock)
join ERS_ReportConsultants rc (nolock) on p.Endoscopist1 = rc.ConsultantID 
join ERS_Patients pat (nolock) on p.PatientId = pat.PatientId 
join ERS_OperatingHospitals (nolock) oh on p.OperatingHospitalID = oh.OperatingHospitalId 
left outer join ERS_GenderTypes (nolock) gt on pat.GenderId = gt.GenderId 
join ERS_ProcedureTypes (nolock) pt on P.ProcedureType = pt.ProcedureTypeId 
left outer join (Select distinct s.ProcedureId 
			from ERS_Sites (nolock) s  
			left join ERS_UpperGITherapeutics (nolock) t on s.siteId = t.SiteId
			left join ERS_ERCPTherapeutics (nolock) ercpt on s.siteId = ercpt.SiteId
			where t.siteid is not null or ercpt.siteid is not null) thera on p.ProcedureId = thera.ProcedureId
join ERS_Users ListCons (nolock) on p.ListConsultant = ListCons.UserID
join ERS_Users Endo1 (nolock) on p.Endoscopist1 = Endo1.UserID
left outer join ERS_Users Endo2 (nolock) on p.Endoscopist2 = Endo2.UserID
join ERS_ProceduresReporting pr (nolock) on p.ProcedureId = pr.ProcedureId 
left outer join ERS_UpperGIIndications ind (nolock) on p.ProcedureId = ind.ProcedureId 
left outer join ERS_UpperGIFollowUp fu (nolock) on p.ProcedureId = fu.ProcedureId 
LEFT JOIN ERS_ProcedurePathwayPlanAnswers epfuqa (nolock) ON p.ProcedureId = epfuqa.ProcedureId										--edited by siddik --TFS 4375
JOIN ERS_PathwayPlanQuestions efuq (nolock) ON epfuqa.QuestionId = efuq.QuestionId AND efuq.Question LIKE '%Evidence of cancer%'	--edited by siddik --TFS 4375
LEFT JOIN ERS_PatientASAStatus pas (nolock) ON p.ProcedureId = pas.ProcedureCreatedId												--edited by siddik --TFS 4375
left outer join 
(
Select distinct d.ProcedureId, STUFF(( Select ', ' + drugconcat.DrugName + ' - ' + convert(varchar, drugconcat.Dose) + drugconcat.Units
                FROM ERS_UpperGIPremedication drugconcat
				where drugconcat.ProcedureId = d.ProcedureId
              FOR
                XML PATH('')
              ), 1, 1, '') AS DrugList
from ERS_UpperGIPremedication d) Drugs on Drugs.ProcedureId = p.ProcedureId
Left outer join (Select s.ProcedureId 
					, isnull(sum(l.SessileExcised), 0) + isnull(SUM(ap.SessileNumExcised), 0) as SessileExcised
					, isnull(sum(l.SessileToLabs), 0) + isnull(SUM(ap.SessileNumToLabs), 0) as SessileToLabs
					, isnull(sum(l.PedunculatedExcised), 0) + isnull(SUM(ap.PedunculatedNumExcised), 0) as PedunculatedExcised
					, isnull(sum(l.PedunculatedToLabs), 0) + isnull(SUM(ap.PedunculatedNumToLabs), 0) as PedunculatedToLabs
					, isnull(SUM(ap.SubmucosalNumExcised), 0) as SubmucosalExcised
					, isnull(SUM(ap.SubmucosalNumToLabs), 0) as SubmucosalToLabs
					, isnull(SUM(l.PseudopolypsExcised), 0) as PseudopolypsExcised
					, isnull(SUM(l.PseudopolypsToLabs), 0) as PseudopolypsToLabs
					, ISNULL(max(convert(int, sp.BrushCytology)), 0) as BrushCytology
					, ISNULL(sum(sp.BiopsyQtyHistology), 0) as BiopsyQtyHistology
					, ISNULL(sum(sp.BiopsyQtyMicrobiology), 0) as BiopsyQtyMicrobiology
					, ISNULL(sum(sp.BiopsyQtyVirology), 0) as BiopsyQtyVirology
					, ISNULL(max(convert(int, sp.HotBiopsy)), 0) as HotBiopsy
				from ERS_Sites s  (nolock)
				left outer join ERS_ColonAbnoLesions l (nolock) on s.SiteId = l.SiteId 
				left outer join ERS_UpperGIAbnoPolyps ap (nolock) on s.SiteId = ap.SiteId 
				left outer join ERS_UpperGISpecimens sp (nolock) on s.SiteId = sp.SiteId 
				Group by s.ProcedureId ) d on p.ProcedureId = d.ProcedureId 
left outer join ERS_ColonExtentOfIntubation CEOI (nolock) on p.ProcedureId = CEOI.ProcedureId 
left outer join ERS_UpperGIQA (nolock) qa on p.ProcedureId = qa.ProcedureId 
Left outer Join (select 
ProcedureId, AdverseEvents = Case When AdverseEventsNone = '1' then 'None'
Else
	Case when Len(Ltrim(Rtrim(Case when ConsentSignedInRoom = '1' then 'Consent signed in room, ' else '' end
	+
	Case When UnplannedAdmission = '1' then 'Unplanned Admisison, ' else '' end
	+
	Case When O2Desaturation = '1' then 'O2 Desaturation, ' else '' end
	+ 
	Case When WithdrawalOfConsent = '1' then 'Withdrawal of consent, ' else '' end
	+
	Case When UnsupervisedTrainee = '1' then 'Unsupervised Trainee, ' else '' end
	+
	Case when Ventilation = '1' then 'Ventilation, ' else '' end
	))) > 1 then
	Left(Ltrim(Rtrim(Case when ConsentSignedInRoom = '1' then 'Consent signed in room, ' else '' end
	+
	Case When UnplannedAdmission = '1' then 'Unplanned Admisison, ' else '' end
	+
	Case When O2Desaturation = '1' then 'O2 Desaturation, ' else '' end
	+ 
	Case When WithdrawalOfConsent = '1' then 'Withdrawal of consent, ' else '' end
	+
	Case When UnsupervisedTrainee = '1' then 'Unsupervised Trainee, ' else '' end
	+
	Case when Ventilation = '1' then 'Ventilation, ' else '' end
	)),Len(Ltrim(Rtrim(Case when ConsentSignedInRoom = '1' then 'Consent signed in room, ' else '' end
	+
	Case When UnplannedAdmission = '1' then 'Unplanned Admisison, ' else '' end
	+
	Case When O2Desaturation = '1' then 'O2 Desaturation, ' else '' end
	+ 
	Case When WithdrawalOfConsent = '1' then 'Withdrawal of consent, ' else '' end
	+
	Case When UnsupervisedTrainee = '1' then 'Unsupervised Trainee, ' else '' end
	+
	Case when Ventilation = '1' then 'Ventilation, ' else '' end
	)))-1)
	else '' end
end
,
Complications = Case When ComplicationsNone = '1' then 'None'
Else
	Case when Len(Ltrim(Rtrim(Case when PoorlyTolerated = '1' then 'Poorly tolerated, ' else '' end
	+
	Case When PatientDiscomfort = '1' then 'Patient discomfort, ' else '' end
	+
	Case When PatientDistress = '1' then 'Patient distress, ' else '' end
	+ 
	Case When InjuryToMouth = '1' then 'Injury to mouth/teeth, ' else '' end
	+
	Case When DifficultIntubation = '1' then 'Difficult intubation, ' else '' end
	+
	Case when Death = '1' then 'Death, ' else '' end
	+
	Case when Perforation = '1' then 'Perforation : '+ IsNull(PerforationText,'') + ', ' else '' end
	+
	Case when DamageToScope = '1' then 'Damaged to scope, ' else '' end
	+
	Case when GastricContentsAspiration = '1' then 'Gastric contents aspiration, ' else '' end
	+
	Case when ShockHypotension = '1' then 'Shock/hypotension, ' else '' end
	+
	Case when Haemorrhage = '1' then 'Haemorrhage, ' else '' end
	+
	Case when SignificantHaemorrhage = '1' then 'Significant Haemorrhage, ' else '' end
	+
	Case when Hypoxia = '1' then 'Hypoxia, ' else '' end
	+
	Case when RespiratoryDepression = '1' then 'Respiratory depression, ' else '' end
	+
	Case when RespiratoryArrest = '1' then 'Respiratory arrest requiring immediate action, ' else '' end
	+
	Case when CardiacArrest = '1' then 'Cardiac arrest, ' else '' end
	+
	Case when CardiacArrythmia = '1' then 'Cardiac arrhythmia, ' else '' end
	+
	Case when Len(IsNull(ComplicationsOtherText,'')) > 1 then 'Other complications:' + ComplicationsOtherText else '' end
	+
	Case when Len(IsNull(TechnicalFailure,'')) > 1 then 'Technical failure:' + TechnicalFailure else '' end
	))) > 1 then
	Left(Ltrim(Rtrim(Case when PoorlyTolerated = '1' then 'Poorly tolerated, ' else '' end
	+
	Case When PatientDiscomfort = '1' then 'Patient discomfort, ' else '' end
	+
	Case When PatientDistress = '1' then 'Patient distress, ' else '' end
	+ 
	Case When InjuryToMouth = '1' then 'Injury to mouth/teeth, ' else '' end
	+
	Case When DifficultIntubation = '1' then 'Difficult intubation, ' else '' end
	+
	Case when Death = '1' then 'Death, ' else '' end
	+
	Case when Perforation = '1' then 'Perforation : '+ IsNull(PerforationText,'') + ', ' else '' end
	+
	Case when DamageToScope = '1' then 'Damaged to scope, ' else '' end
	+
	Case when GastricContentsAspiration = '1' then 'Gastric contents aspiration, ' else '' end
	+
	Case when ShockHypotension = '1' then 'Shock/hypotension, ' else '' end
	+
	Case when Haemorrhage = '1' then 'Haemorrhage, ' else '' end
	+
	Case when SignificantHaemorrhage = '1' then 'Significant Haemorrhage, ' else '' end
	+
	Case when Hypoxia = '1' then 'Hypoxia, ' else '' end
	+
	Case when RespiratoryDepression = '1' then 'Respiratory depression, ' else '' end
	+
	Case when RespiratoryArrest = '1' then 'Respiratory arrest requiring immediate action, ' else '' end
	+
	Case when CardiacArrest = '1' then 'Cardiac arrest, ' else '' end
	+
	Case when CardiacArrythmia = '1' then 'Cardiac arrhythmia, ' else '' end
	+
	Case when Len(IsNull(ComplicationsOtherText,'')) > 1 then 'Other complications:' + ComplicationsOtherText else '' end
	+
	Case when Len(IsNull(TechnicalFailure,'')) > 1 then 'Technical failure:' + TechnicalFailure else '' end
	)),Len(Ltrim(Rtrim(Case when PoorlyTolerated = '1' then 'Poorly tolerated, ' else '' end
	+
	Case When PatientDiscomfort = '1' then 'Patient discomfort, ' else '' end
	+
	Case When PatientDistress = '1' then 'Patient distress, ' else '' end
	+ 
	Case When InjuryToMouth = '1' then 'Injury to mouth/teeth, ' else '' end
	+
	Case When DifficultIntubation = '1' then 'Difficult intubation, ' else '' end
	+
	Case when Death = '1' then 'Death, ' else '' end
	+
	Case when Perforation = '1' then 'Perforation : '+ IsNull(PerforationText,'') + ', ' else '' end
	+
	Case when DamageToScope = '1' then 'Damaged to scope, ' else '' end
	+
	Case when GastricContentsAspiration = '1' then 'Gastric contents aspiration, ' else '' end
	+
	Case when ShockHypotension = '1' then 'Shock/hypotension, ' else '' end
	+
	Case when Haemorrhage = '1' then 'Haemorrhage, ' else '' end
	+
	Case when SignificantHaemorrhage = '1' then 'Significant Haemorrhage, ' else '' end
	+
	Case when Hypoxia = '1' then 'Hypoxia, ' else '' end
	+
	Case when RespiratoryDepression = '1' then 'Respiratory depression, ' else '' end
	+
	Case when RespiratoryArrest = '1' then 'Respiratory arrest requiring immediate action, ' else '' end
	+
	Case when CardiacArrest = '1' then 'Cardiac arrest, ' else '' end
	+
	Case when CardiacArrythmia = '1' then 'Cardiac arrhythmia, ' else '' end
	+
	Case when Len(IsNull(ComplicationsOtherText,'')) > 1 then 'Other complications:' + ComplicationsOtherText else '' end
	+
	Case when Len(IsNull(TechnicalFailure,'')) > 1 then 'Technical failure:' + TechnicalFailure else '' end
	)))-1)
	else '' end
end
from ERS_UpperGIQA) UPQA on UPQA.ProcedureId = P.ProcedureId
left outer join 
(
Select distinct d.ProcedureId, STUFF(( Select '; ' + therapconcat.TherapeuticProcedures
                FROM @tableVarTherapeutics therapconcat
				where therapconcat.ProcedureId = d.ProcedureId
              FOR
                XML PATH('')
              ), 1, 1, '') AS TherapeuticProcedures
from @tableVarTherapeutics d) Therap on Therap.ProcedureId = p.ProcedureId

where p.ProcedureCompleted = 1
	and p.IsActive = 1
	and p.CreatedOn >= @FromDate AND p.CreatedOn <= @ToDate
	and rc.UserID = @UserId
	AND P.OperatingHospitalID IN (SELECT * FROM dbo.splitString(@OperatingHospitalList,',') )
	--and pat.PatientId in (Select patientId from ERS_PatientTrusts where TrustId = @TrustId)
	and IsNull(p.DNA,0) = 0
	and p.CategoryListId = (SELECT UniqueId
		FROM ERS_UrgencyTypes where Description = 'Urgent (suspected cancer pathway)')
order by pt.ProcedureType, p.CreatedOn 

end

GO

EXEC dbo.DropIfExist 
    @ObjectName = 'patient_asa_status_save', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[patient_asa_status_save]
(
	@PatientId int,
	@ASAStatusId int,
	@ProcedureId int,
	@LoggedInUserId int
)
AS
BEGIN
	IF NOT EXISTS (SELECT 1 FROM ERS_PatientASAStatus WHERE PatientId = @PatientID AND ProcedureCreatedId = @ProcedureId)
	BEGIN
		INSERT INTO ERS_PatientASAStatus (PatientId, ASAStatusId, ProcedureCreatedId, WhoCreatedId, WhenCreated)
		VALUES (@PatientId, @ASAStatusId, @ProcedureId, @LoggedInUserId, GETDATE())
	END
	ELSE
	BEGIN
		UPDATE ERS_PatientASAStatus
		SET ASAStatusId = @ASAStatusId,
			ProcedureCreatedId = @ProcedureId,
			WhoUpdatedId = @LoggedInUserId,
			WhenUpdated = GETDATE()
		WHERE ProcedureCreatedId = @ProcedureId	--edited by siddik --TFS 4375
	END

	UPDATE ERS_ProceduresReporting
	SET PP_Indic = dbo.ProcedureIndicationsSummary(@ProcedureId)
	WHERE ProcedureId = @ProcedureId

	DECLARE @Summary VARCHAR(max) = 'ASA Status'
	EXEC UI_update_procedure_summary @ProcedureId, 'ASA Status', @Summary, @ASAStatusId
END

GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	4375
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	: Duncan	
-- TFS#	4375
-- Description of change: Only get/save pathway plan questions from the procedures operaqting hospital
------------------------------------------------------------------------------------------------------------------------
GO
EXEC dbo.DropIfExist 
    @ObjectName = 'procedure_pathway_plan_answers_save', 
    @ObjectTypePrefix = 'S' 
GO
Create PROCEDURE [dbo].[procedure_pathway_plan_answers_save]
(
	@ProcedureId int,
	@QuestionId	int,
	@OptionAnswer int = null,
	@FreeTextAnswer varchar(max) = NULL,
	@ComboBoxItemId INT,
	@LoggedInUserId int
)
AS
BEGIN
	DECLARE @Optional BIT = (SELECT eppq.Optional FROM dbo.ERS_PathwayPlanQuestions eppq WHERE eppq.QuestionId=@QuestionId)
	DECLARE @OperatingHospitalId INT = (Select OperatingHospitalId from ERS_Procedures where ProcedureId = @ProcedureId)

	IF NOT EXISTS (SELECT 1 FROM ERS_ProcedurePathwayPlanAnswers WHERE QuestionId = @QuestionId AND ProcedureId = @ProcedureId)
	BEGIN
		INSERT INTO ERS_ProcedurePathwayPlanAnswers (ProcedureId, QuestionId, OptionAnswer, FreeTextAnswer, EvidenceOfCancer, WhoCreatedId, WhenCreated)
		VALUES (@ProcedureId, @QuestionId, CASE WHEN @Optional = 1 THEN @OptionAnswer ELSE NULL END, @FreeTextAnswer, @ComboBoxItemId, @LoggedInUserId, getdate())
	END
	ELSE
	BEGIN
		UPDATE ERS_ProcedurePathwayPlanAnswers
		SET OptionAnswer= CASE WHEN @Optional = 1 THEN @OptionAnswer ELSE NULL END, FreeTextAnswer = @FreeTextAnswer, EvidenceOfCancer = @ComboBoxItemId, WhoUpdatedId = @LoggedInUserId	, WhenUpdated = getdate()
		WHERE ProcedureId = @ProcedureId AND QuestionId = @QuestionId	
	END

	DECLARE @ComboBoxItemText VARCHAR(200) = ''
	DECLARE @EvidenceOfCancer INT = (SELECT EvidenceOfCancer FROM ERS_ProcedurePathwayPlanAnswers WHERE EvidenceOfCancer > 0 AND ProcedureId = @ProcedureId)
	IF @EvidenceOfCancer > 0
	BEGIN
		SET @ComboBoxItemText = (SELECT ListItemText FROM ers_lists WHERE ListId = @EvidenceOfCancer)
	END
	
	DECLARE @PathwayPlan varchar(max) = 
	(SELECT efuq.Question + ' ' + ISNULL(CASE OptionAnswer WHEN 1 THEN 'Yes' WHEN 0 THEN 'No' WHEN -1 THEN 'Unknown' END, '') + 
			CASE WHEN OptionAnswer IS NOT NULL AND NULLIF(FreeTextAnswer,'') IS NOT NULL THEN ', ' ELSE '' END 
	+ ISNULL(FreeTextAnswer, '') + ' ' + CASE WHEN efuq.Question IN ('Evidence of cancer?') AND @ComboBoxItemText <> ''
	THEN '(' + @ComboBoxItemText + ')' ELSE '' END + ' ** ' AS [text()]
	FROM dbo.ERS_PathwayPlanQuestions efuq
	INNER JOIN ERS_ProcedurePathwayPlanAnswers epfuqa ON efuq.QuestionId = epfuqa.QuestionId
	WHERE ProcedureId = @ProcedureId
	AND efuq.OperatingHospital = @OperatingHospitalId
	ORDER BY efuq.OrderById
	FOR XML PATH (''))

	UPDATE ERS_ProceduresReporting SET PP_PathwayPlan = REPLACE(@PathwayPlan, '**', '<br />') WHERE ProcedureId = @ProcedureId

END
GO
EXEC dbo.DropIfExist 
    @ObjectName = 'procedure_pathway_plan_answers_select', 
    @ObjectTypePrefix = 'S' 
GO
Create PROCEDURE [dbo].[procedure_pathway_plan_answers_select]
(
	@ProcedureId int
)
AS
BEGIN
	SELECT efuq.QuestionId, efuq.Question, OptionAnswer, FreeTextAnswer, Mandatory, EvidenceOfCancer
	FROM dbo.ERS_PathwayPlanQuestions efuq
		INNER JOIN ERS_ProcedurePathwayPlanAnswers epfuqa ON efuq.QuestionId = epfuqa.QuestionId
		INNER JOIN ERS_Procedures p on p.ProcedureId = epfuqa.ProcedureId and p.OperatingHospitalID = efuq.OperatingHospital
	WHERE epfuqa.ProcedureId = @ProcedureId
END
GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	XXXX
------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Muhammad Nasim
-- TFS#	****
-- Description of change: PhraseLibrary duplicate data insert
-------------------------------------------------------------------------------------------------------------------------
GO

EXEC dbo.DropIfExist @ObjectName = 'add_new_operating_hospital',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)

GO
CREATE PROCEDURE [dbo].[add_new_operating_hospital]
(
    @ExistingHospitalID int,
	@InternalHospitalID VARCHAR(150), 
	@NHSHospitalID VARCHAR(150), 
	@TrustId int,
	@HospitalName VARCHAR(150), 
	@ContactNumber VARCHAR(150), 
	@ReportExportPath VARCHAR(500),
	@ReportHeading VARCHAR(200), 
    @ReportTrustType VARCHAR(200),
    @ReportSubHeading VARCHAR(200),
	@ReportFooter VARCHAR(500),
    @DepartmentName VARCHAR(200),
	@NEDExportPath VARCHAR(200),
	@NEDODSCode VARCHAR(50),
	@LoggedInUserId INT,
	@CopyPrintSettings BIT,
	@CopyPhraseLibrary BIT,
	@ImportPatientByWebservice int,
	@AddExportFileForMirth bit,
	@ExportDocumentFilePrefix varchar(30),
	@SuppressMainReportPDF bit = 0,
	@TrustName varchar(200) = NULL
	
)
AS

/**************************************************************************
 Author:		?
 Create date:	?
 Description:	Create a new operating hospital. Inserts into 
				OperatingHospital, System_Config and the print settings
*****************************************************************************************
*****                        Change History											*****
*****************************************************************************************
** Rev	Date			Author		Description 
** --	-----------		---------	-------------------------------------------------------------------
** 1	25 Jul 2019		Duncan		Added report footer to System Config
** 
** 2    21 Jan 2021     Duncan      Added TrustId
**
** 3	08 Mar 2021		Mahfuz		Added ImportPatientByWebservice
** 4	19 Mar 2021		Mahfuz		updated ImportPatientByWebservice column as Int
** 5	25 May 2021		Andrea		Added new trust entry option and General room and Image port now added when creating a new OH
** 6	06 Aug 2021		Adrian		Fixed bug that when the print settings are duplicated, they miss out the defaultphotosize
** 7	05 Oct 2021		Duncan		Fixed DefaultPhotoSize in print settings so that Null is not inserted (defaults to 2)
** 8	17 Nov 2021		Mahfuz		added new parameter AddExportFileForMirth, TFS #1779
** 9	05 Jan 2022		Mahfuz		added new parameter ExportDocumentFilePrefix TFS # 1832
** 10	29 Mar 2022		Mahfuz		added new parameter SuppressMainReportPDF TFS # 1985 - Suppress PDF (Main report) from the Exported document if no required
*******************************************************************************************************/
SET NOCOUNT ON

BEGIN TRANSACTION
	BEGIN TRY
		DECLARE @NewOHID INT, @OperatingHospitalId INT, @NewRoomId INT
		--IF @TrustName IS NOT NULL
		--BEGIN
		--	INSERT INTO ERS_Trusts (TrustName) VALUES (@TrustName)

		--	SET @TrustId = SCOPE_IDENTITY()
		--END

		SELECT TOP 1 @OperatingHospitalId = OperatingHospitalId FROM ERS_OperatingHospitals ORDER BY OperatingHospitalId

		INSERT INTO ERS_OperatingHospitals (InternalHospitalID, NHSHospitalID, HospitalName, ContactNumber, ReportExportPath, TrustId,ImportPatientByWebservice,AddExportFileForMirth,SuppressMainReportPDF,ExportDocumentFilePrefix)
	    VALUES (@InternalHospitalID, @NHSHospitalID, @HospitalName, @ContactNumber, @ReportExportPath, @TrustId, @ImportPatientByWebservice,@AddExportFileForMirth,@SuppressMainReportPDF,@ExportDocumentFilePrefix); 
		 SET @NewOHID = SCOPE_IDENTITY()
		--Assign Admin and logged in user (if not admin) to new hospital
		DECLARE @AdminUserId int = (SELECT UserId FROM ERS_Users WHERE UserName = 'Admin')
		INSERT INTO ERS_UserOperatingHospitals (UserId, OperatingHospitalId) VALUES (@AdminUserId, @NewOHID)
		
		IF @AdminUserId <> @LoggedInUserId
		BEGIN
			INSERT INTO ERS_UserOperatingHospitals (UserId, OperatingHospitalId) VALUES (@LoggedInUserID, @NewOHID)
		END

		--New (general) room entry
		INSERT INTO ERS_SCH_Rooms (RoomName, AllProcedureTypes, HospitalId, OtherInvestigations, Suppressed, WhoCreatedId, WhenCreated)
		VALUES ('General', 1, @NewOHID, 0, 0, @LoggedInUserId, getdate())

		SET @NewRoomId = SCOPE_IDENTITY()

		--New (none) image port entry
		INSERT INTO ERS_ImagePort (OperatingHospitalId, PortName, MacAddress, [Static], PCName, IsActive, WhoCreatedId, WhenCreated, RoomId, FriendlyName, [Default])
		VALUES (@NewOHID, 'None', NULL, 1, '', 1, @LoggedInUserId, getdate(), @NewRoomId, 'None',1)
		
	   -- Added a default CAll in times by Ferdowsi
	   INSERT INTO  ERS_SCH_ProcedureCallInTimes
           ([ProcedureTypeId]
           ,[CallInMinutes]
           ,[OperatingHospitalId]
           ,[WhoCreatedId]
           ,[WhenCreated])    
       SELECT DISTINCT 
            [ProcedureTypeId]
           ,[CallInMinutes]
           ,@NewOHID
           ,@LoggedInUserId
           ,GETDATE() 
       FROM ERS_SCH_ProcedureCallInTimes
       WHERE [OperatingHospitalId] = @ExistingHospitalID;
	   -- End
	   -- Added a default points by Ferdowsi
       INSERT INTO ERS_SCH_PointMappings (Minutes,OperatingHospitalId,ProceduretypeId,Points,WhoUpdatedId,WhoCreatedId,
       WhenCreated,WhenUpdated,Training,NonGI,TherapeuticMinutes,TherapeuticPoints) 
       SELECT Minutes,@NewOHID,ProceduretypeId,Points,NULL,@LoggedInUserId,GETDATE(),NULL,
       Training,NonGI,TherapeuticMinutes,TherapeuticPoints  from ERS_SCH_PointMappings where OperatingHospitalId = @ExistingHospitalID;
	   --END

		INSERT INTO dbo.ERS_SystemConfig
		(
			HospitalID,
			OperatingHospitalID,
			ApplicationTimeOut,
			SystemDisabled,
			ScheduledShutdown,
			PwdRuleMinLength,
			PwdRuleNoOfSpecialChars,
			PwdRuleNoSpaces,
			PwdRuleCantBeUserId,
			PwdRuleDaysToExpiration,
			PwdRuleNoOfPastPwdsToAvoid,
			SiteIdentification,
			SiteRadius,
			OGDDiagnosis,
			UreaseTestsIncludeTickBoxes,
			OesophagitisClassification,
			BostonBowelPrepScale,
			ReportHeading,
			ReportTrustType,
			ReportSubHeading,
			DepartmentName,
			PatientConsent,
			SortReferringConsultantBy,
			CompleteWHOSurgicalSafetyCheckList,
			ReportLocking,
			LockingTime,
			LockingDays,
			CountryLabel,
			NED_HospitalSiteCode,
			NED_OrganisationCode,
			NED_APIKey,
			NED_BatchId,
			NED_ExportPath,
			NEDEnabled,
			AuditLogEnabled,
			ErrorLogEnabled,
			ImGrabEnabled,
			IncludeUGI,
			DefaultPatientStatus,
			DefaultPatientType,
			DefaultWard,
			BRTPulmonaryPhysiology,
			PhotosURL,
			PhotosUNC,
			MaxWorklistDays,
			WhoCreatedId,
			WhenCreated,
			ReportFooter
		)
		SELECT 
			HospitalID,
			@NewOHID,
			ApplicationTimeOut,
			SystemDisabled,
			ScheduledShutdown,
			PwdRuleMinLength,
			PwdRuleNoOfSpecialChars,
			PwdRuleNoSpaces,
			PwdRuleCantBeUserId,
			PwdRuleDaysToExpiration,
			PwdRuleNoOfPastPwdsToAvoid,
			SiteIdentification,
			SiteRadius,
			OGDDiagnosis,
			UreaseTestsIncludeTickBoxes,
			OesophagitisClassification,
			BostonBowelPrepScale,
			@ReportHeading,
			@ReportTrustType,
			@ReportSubHeading,
			@DepartmentName,
			PatientConsent,
			SortReferringConsultantBy,
			CompleteWHOSurgicalSafetyCheckList,
			ReportLocking,
			LockingTime,
			LockingDays,
			CountryLabel,
			@NEDODSCode,
			NED_OrganisationCode,
			NED_APIKey,
			NED_BatchId,
			(SELECT TOP 1 NED_ExportPath FROM ERS_SystemConfig),
			NEDEnabled,
			AuditLogEnabled,
			ErrorLogEnabled,
			ImGrabEnabled,
			IncludeUGI,
			DefaultPatientStatus,
			DefaultPatientType,
			DefaultWard,
			BRTPulmonaryPhysiology,
			PhotosURL,
			PhotosUNC,
			MaxWorklistDays,
			@LoggedInUserId,
			GETDATE(),
			@ReportFooter
		FROM ERS_SystemConfig
		WHERE ERS_SystemConfig.OperatingHospitalID= @OperatingHospitalId

		IF @CopyPrintSettings = 1 
		BEGIN
			INSERT INTO dbo.ERS_PrintOptionsGPReport
			(
				IncludeDiagram,
				IncludeDiagramOnlyIfSitesExist,
				IncludeListConsultant,
				IncludeNurses,
				IncludeInstrument,
				IncludeMissingCaseNote,
				IncludeIndications,
				IncludeCoMorbidities,
				IncludePlannedProcedures,
				IncludePremedication,
				IncludeProcedureNotes,
				IncludeSiteNotes,
				IncludeBowelPreparation,
				IncludeExtentOfIntubation,
				IncludePreviousGastricUlcer,
				IncludeExtentAndLimitingFactors,
				IncludeCannulation,
				IncludeExtentOfVisualisation,
				IncludeContrastMediaUsed,
				IncludePapillaryAnatomy,
				IncludeDiagnoses,
				IncludeFollowUp,
				IncludeTherapeuticProcedures,
				IncludeSpecimensTaken,
				IncludePeriOperativeComplications,
				DefaultNumberOfCopies,
				DefaultNumberOfPhotos,
				DefaultPhotoSize,
				OperatingHospitalId,
				WhoCreatedId,
				WhenCreated
			)
			SELECT 
				epog.IncludeDiagram, 
				epog.IncludeDiagramOnlyIfSitesExist, 
				epog.IncludeListConsultant, 
				epog.IncludeNurses, 
				epog.IncludeInstrument, 
				epog.IncludeMissingCaseNote, 
				epog.IncludeIndications, 
				epog.IncludeCoMorbidities, 
				epog.IncludePlannedProcedures, 
				epog.IncludePremedication, 
				epog.IncludeProcedureNotes, 
				epog.IncludeSiteNotes, 
				epog.IncludeBowelPreparation, 
				epog.IncludeExtentOfIntubation, 
				epog.IncludePreviousGastricUlcer, 
				epog.IncludeExtentAndLimitingFactors, 
				epog.IncludeCannulation, 
				epog.IncludeExtentOfVisualisation, 
				epog.IncludeContrastMediaUsed, 
				epog.IncludePapillaryAnatomy, 
				epog.IncludeDiagnoses, 
				epog.IncludeFollowUp, 
				epog.IncludeTherapeuticProcedures, 
				epog.IncludeSpecimensTaken, 
				epog.IncludePeriOperativeComplications, 
				epog.DefaultNumberOfCopies, 
				epog.DefaultNumberOfPhotos, 
				 2,
				@NewOHID, 
				@LoggedInUserId, 
				GETDATE()
			FROM dbo.ERS_PrintOptionsGPReport epog
			WHERE epog.OperatingHospitalId =@OperatingHospitalId


			INSERT INTO dbo.ERS_PrintOptionsLabRequestReport
			(
				--RequestReportID - this column value is auto-generated
				OneRequestForEverySpecimen,
				GroupSpecimensByDestination,
				RequestsPerA4Page,
				IncludeDiagram,
				IncludeTimeSpecimenCollected,
				IncludeHeading,
				Heading,
				IncludeIndications,
				IncludeProcedureNotes,
				IncludeAbnormalities,
				IncludeSiteNotes,
				IncludeDiagnoses,
				DefaultNumberOfCopies,
				OperatingHospitalId,
				WhoCreatedId,
				WhenCreated
			)
			SELECT
				OneRequestForEverySpecimen,
				GroupSpecimensByDestination,
				RequestsPerA4Page,
				IncludeDiagram,
				IncludeTimeSpecimenCollected,
				IncludeHeading,
				Heading,
				IncludeIndications,
				IncludeProcedureNotes,
				IncludeAbnormalities,
				IncludeSiteNotes,
				IncludeDiagnoses,
				DefaultNumberOfCopies,
				@NewOHID,
				@LoggedInUserId,
				GETDATE()
			FROM ERS_PrintOptionsLabRequestReport
			WHERE OperatingHospitalId = @OperatingHospitalId


			INSERT INTO dbo.ERS_PrintOptionsPatientFriendlyReport
			(
				IncludeNoFollowup,
				IncludeUreaseText,
				UreaseText,
				IncludePolypectomyText,
				PolypectomyText,
				IncludeOtherBiopsyText,
				OtherBiopsyText,
				IncludeAnyOtherBiopsyText,
				AnyOtherBiopsyText,
				IncludeAdviceComments,
				IncludePreceedAdviceComments,
				PreceedAdviceComments,
				IncludeFinalText,
				FinalText,
				DefaultNumberOfCopies,
				OperatingHospitalId,
				WhoCreatedId,
				WhenCreated
			)
			SELECT
				IncludeNoFollowup,
				IncludeUreaseText,
				UreaseText,
				IncludePolypectomyText,
				PolypectomyText,
				IncludeOtherBiopsyText,
				OtherBiopsyText,
				IncludeAnyOtherBiopsyText,
				AnyOtherBiopsyText,
				IncludeAdviceComments,
				IncludePreceedAdviceComments,
				PreceedAdviceComments,
				IncludeFinalText,
				FinalText,
				DefaultNumberOfCopies,
				@NewOHID,
				@LoggedInUserId,
				GETDATE()
			FROM ERS_PrintOptionsPatientFriendlyReport
			WHERE OperatingHospitalId = @OperatingHospitalId


			INSERT INTO dbo.ERS_PrintOptionsPatientFriendlyReportAdditional
			(
				--Id - this column value is auto-generated
				IncludeAdditionalText,
				AdditionalText,
				OperatingHospitalId,
				WhoCreatedId,
				WhenCreated
			)
			SELECT
				IncludeAdditionalText,
				AdditionalText,
				@NewOHID,
				@LoggedInUserId,
				GETDATE()
			FROM ERS_PrintOptionsPatientFriendlyReportAdditional
			WHERE OperatingHospitalId = @OperatingHospitalId
		END

		IF @CopyPhraseLibrary = 1
		BEGIN
			INSERT INTO dbo.ERS_PhraseLibrary
			(
				--PhraseID - this column value is auto-generated
				UserID,
				PhraseCategory,
				Phrase,
				UsageCount,
				OperatingHospitalId,
				WhoCreatedId,
				WhenCreated
			)
			SELECT
				UserID,
				PhraseCategory,
				Phrase,
				UsageCount,
				@NewOHID,
				WhoCreatedId,
				WhenCreated
			FROM ERS_PhraseLibrary
			WHERE OperatingHospitalId = @OperatingHospitalId
		END

		SELECT CASE WHEN @TrustName IS NULL THEN @NewOHID ELSE @TrustId END
	END TRY

	BEGIN CATCH
		DECLARE @ErrorMessage NVARCHAR(4000);
		DECLARE @ErrorSeverity INT;
		DECLARE @ErrorState INT;

		SELECT @ErrorMessage = ERROR_MESSAGE(),
			  @ErrorSeverity = ERROR_SEVERITY(),
			   @ErrorState = ERROR_STATE();
    
		RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

		IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
	END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;

GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	**** Ended
------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rony
-- TFS#	4331
-- Description of change
-- GP Code Report
------------------------------------------------------------------------------------------------------------------------

if not  exists(select 1 from ERS_AuditReports where AuditReportStoredProcedure='gpCodeReport')
     insert into ERS_AuditReports values ('GP Code Report', 'gpCodeReport','R')
GO
EXEC dbo.DropIfExist 
    @ObjectName = 'gpCodeReport', 
    @ObjectTypePrefix = 'S' 
GO
CREATE PROCEDURE [dbo].[gpCodeReport]
	@UserId int
AS
BEGIN
DECLARE @FromDate as Date,
			@ToDate as Date,
			@TrustId as int,
			@HealthService as varchar(max),
			@OperatingHospitalList as varchar(100)
	SELECT	@FromDate = FromDate,
			@ToDate = ToDate, 
			@TrustId = TrustId,
			@OperatingHospitalList=OperatingHospitalList
	FROM	ERS_ReportFilter
	WHERE	UserID = @UserId

	 SELECT DISTINCT
	 patient.PatientId,
	 (patient.Surname + ', '+ patient.Forename1) AS 'Patient Name',
	 dbo.fn_FormatHealthServiceNumber(patient.NHSNo, @HealthService) AS 'NHS', 
	 STUFF((SELECT DISTINCT ',' + HospitalNumber from ERS_PatientTrusts WHERE PatientId = patient.PatientId and IsMinor = 0 for xml path('')), 1, 1, '') AS 'Hospital Number',
	 Convert(varchar(14),patient.DateofBirth,106) AS 'DOB',
	 gps.Code AS 'GPCode(GMC)',
	 gps.Name AS 'GP Name',
	 prac.Name AS 'GP Surgery',
	 COUNT(ProcedureId) AS 'Number of procedures'
	 FROM  ERS_Procedures proce 
	 INNER JOIN ERS_Patients patient ON patient.PatientId = proce.PatientId
	 INNER JOIN ERS_GPS gps ON gps.GPId = patient.RegGpId
	 INNER JOIN ERS_Practices prac ON prac.PracticeID = patient.RegGpPracticeId
	 WHERE 
	 ISNULL(DNA, 0) = 0 AND 
	 proce.IsActive= 1 AND 
	 cast(proce.CreatedOn as date) BETWEEN @FromDate AND @ToDate AND 
	 proce.OperatingHospitalID IN (SELECT * FROM dbo.splitString(@OperatingHospitalList,',') ) 
	 GROUP BY patient.PatientId,patient.Surname,patient.Forename1,patient.NHSNo,patient.DateofBirth,gps.Code,gps.Name,prac.Name
END
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	4331
------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rony
-- TFS#	4326
-- Description of change
-- Bronch Vocal Cord add other
------------------------------------------------------------------------------------------------------------------------

IF NOT EXISTS (SELECT 1 FROM ERS_VocalCordParalysis WHERE Description ='Other')
 BEGIN
   INSERT INTO ERS_VocalCordParalysis (Description,AdditionalInfo,Suppressed)
 VALUES ('Other',0,0)
END
GO
EXEC dbo.DropIfExist 
    @ObjectName = 'procedure_vocal_cord_paralysis_save', 
    @ObjectTypePrefix = 'S' 
GO
CREATE PROCEDURE [dbo].[procedure_vocal_cord_paralysis_save]
(
	@ProcedureId int, 
	@VocalCordParalysisId int, 
	@AdditionalInformation VARCHAR(MAX), --Added by rony tfs-4326
	@LoggedInUserId int
)
AS
BEGIN
		IF NOT EXISTS (SELECT 1 FROM ERS_ProcedureVocalCordParalysis WHERE ProcedureId = @ProcedureId)
		BEGIN
			INSERT INTO [dbo].[ERS_ProcedureVocalCordParalysis] (ProcedureId, VocalCordParalysisId, AdditionalInformation,WhoCreatedId, WhenCreated)--Added by rony tfs-4326
			VALUES (@ProcedureId, @VocalCordParalysisId, @AdditionalInformation,@LoggedInUserId, getdate())--Added by rony tfs-4326
		END
		ELSE
		BEGIN
			UPDATE 
				ERS_ProcedureVocalCordParalysis 
			SET 
				VocalCordParalysisId = @VocalCordParalysisId,
				AdditionalInformation = @AdditionalInformation,--Added by rony tfs-4326
				WhenUpdated = getdate(),
				WhoUpdatedId = @LoggedInUserId
			WHERE 
				ProcedureId = @ProcedureId 
		END
END
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	4326
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Siddik
-- TFS#	4318
-- Description of change: Family History data pull through 
------------------------------------------------------------------------------------------------------------------------

EXEC dbo.DropIfExist 
    @ObjectName = 'patient_family_disease_history_select', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[patient_family_disease_history_select]
(
	@PatientId int,
	@ProcedureId int,
	@IsProcedureCreation bit = 0
)
AS
BEGIN
	DECLARE @PreviousProcedureId INT, @ProcedureTypeId INT;
	SELECT @PreviousProcedureId = MAX(ProcedureCreatedId) FROM ERS_PatientFamilyDiseaseHistory WHERE PatientId = @PatientId;
	SELECT @ProcedureTypeId = ProcedureType FROM dbo.ERS_Procedures WHERE ProcedureId = @ProcedureId;

	IF @IsProcedureCreation = 1 AND NOT EXISTS (SELECT 1 FROM ERS_PatientFamilyDiseaseHistory pfh JOIN ERS_FamilyDiseaseHistory fh ON fh.UniqueId = pfh.FamilyDiseaseHistoryId 
		WHERE pfh.PatientId = @PatientId AND pfh.ProcedureCreatedId = @PreviousProcedureId AND fh.Description IN ('No risk', 'Risk unknown'))
	BEGIN							
		INSERT INTO ERS_PatientFamilyDiseaseHistory (PatientId, FamilyDiseaseHistoryId, AdditionalInformation, ProcedureCreatedId, WhenCreated)
		SELECT @PatientId, p.FamilyDiseaseHistoryId, p.AdditionalInformation, @ProcedureId, GETDATE()
		FROM ERS_PatientFamilyDiseaseHistory p
		INNER JOIN ERS_FamilyDiseaseHistoryProcedureTypes t ON p.FamilyDiseaseHistoryId = t.FamilyDiseaseHistoryId
		WHERE p.PatientId = @PatientId
		AND p.ProcedureCreatedId = @PreviousProcedureId
		AND t.ProcedureTypeId = @ProcedureTypeId;

		UPDATE ERS_ProceduresReporting
		SET PP_Indic = dbo.ProcedureIndicationsSummary(@ProcedureId)
		WHERE ProcedureId = @ProcedureId;
	END
	ELSE
	BEGIN
		SELECT FamilyDiseaseHistoryId, AdditionalInformation
		FROM ERS_PatientFamilyDiseaseHistory
		WHERE PatientId = @PatientId
		AND ProcedureCreatedId = @ProcedureId;
	END
END

GO

EXEC dbo.DropIfExist 
    @ObjectName = 'patient_family_disease_history_save', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[patient_family_disease_history_save]
(
	@PatientId int,
	@ProcedureId int,
	@FamilyDiseaseHistoryId int,
	@AdditionalInfo varchar(max),
	@Selected bit,
	@LoggedInUserId int
)
AS
BEGIN
	IF @Selected = 1
	BEGIN
		IF NOT EXISTS (SELECT 1 FROM ERS_PatientFamilyDiseaseHistory WHERE PatientId = @PatientId 
			AND ProcedureCreatedId = @ProcedureId AND FamilyDiseaseHistoryId = @FamilyDiseaseHistoryId)
		BEGIN
			INSERT INTO ERS_PatientFamilyDiseaseHistory (PatientId, FamilyDiseaseHistoryId, AdditionalInformation, ProcedureCreatedId, WhoCreatedId, WhenCreated)
			VALUES (@PatientId, @FamilyDiseaseHistoryId, @AdditionalInfo, @ProcedureId, @LoggedInUserId, getdate())
		END
		ELSE 
		BEGIN
			UPDATE ERS_PatientFamilyDiseaseHistory
			SET AdditionalInformation = @AdditionalInfo
			WHERE PatientId = @PatientId AND FamilyDiseaseHistoryId = @FamilyDiseaseHistoryId AND AdditionalInformation <> @AdditionalInfo AND ProcedureCreatedId = @ProcedureId 
		END
	END
	ELSE
	BEGIN
		DELETE FROM ERS_PatientFamilyDiseaseHistory WHERE PatientId = @PatientId AND FamilyDiseaseHistoryId = @FamilyDiseaseHistoryId AND ProcedureCreatedId = @ProcedureId
	END

	UPDATE ERS_ProceduresReporting
	SET PP_Indic = dbo.ProcedureIndicationsSummary(@ProcedureId)
	WHERE ProcedureId = @ProcedureId
END

GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	4318
------------------------------------------------------------------------------------------------------------------------


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Siddik
-- TFS#	3546
-- Description of change: Planned Procedures for ERCP
-------------------------------------------------------------------------------------------------------------------------

DECLARE @ErcpId INT = (SELECT ProcedureTypeId FROM ERS_ProcedureTypes WHERE ProcedureType = 'ERCP');
DECLARE @SectionId INT = (SELECT IndicationSectionId FROM ERS_IndicationSections WHERE SectionName = 'Planned procedures');
DECLARE @Description VARCHAR(100);

DECLARE cur CURSOR FOR
    SELECT item
    FROM (VALUES 
        ('Stent Removal'), 
        ('Stent change'), 
        ('Stent insertion')
    ) AS Descriptions(item)

OPEN cur
FETCH NEXT FROM cur INTO @Description

WHILE @@FETCH_STATUS = 0
BEGIN
	DECLARE @IndicationId INT;
	SELECT @IndicationId = UniqueId FROM ERS_Indications WHERE Description = @Description;

    IF NOT EXISTS (SELECT 1 FROM ERS_Indications WHERE Description = @Description)
	BEGIN
		INSERT INTO ERS_Indications (Description, NEDTerm, IndicationSectionId)
		VALUES (@Description, @Description, @SectionId)

		INSERT INTO ERS_IndicationsProcedureTypes (IndicationId, ProcedureTypeId)
		VALUES (SCOPE_IDENTITY(), @ErcpId)
	END
	ELSE IF EXISTS (SELECT 1 FROM ERS_Indications WHERE Description = @Description AND IndicationSectionId <> @SectionId)
	BEGIN
		UPDATE ERS_Indications
		SET IndicationSectionId = @SectionId 
		WHERE Description = @Description

		IF NOT EXISTS (SELECT 1 FROM ERS_IndicationsProcedureTypes WHERE IndicationId = @IndicationId AND ProcedureTypeId = @ErcpId)
		BEGIN
			INSERT INTO ERS_IndicationsProcedureTypes (IndicationId, ProcedureTypeId)
			VALUES (@IndicationId, @ErcpId)
		END
	END
	ELSE IF EXISTS (SELECT 1 FROM ERS_Indications WHERE Description = @Description AND IndicationSectionId = @SectionId)
		AND NOT EXISTS (SELECT 1 FROM ERS_IndicationsProcedureTypes WHERE IndicationId = @IndicationId AND ProcedureTypeId = @ErcpId)
	BEGIN
		INSERT INTO ERS_IndicationsProcedureTypes (IndicationId, ProcedureTypeId)
		VALUES (@IndicationId, @ErcpId)
	END

    FETCH NEXT FROM cur INTO @Description
END

CLOSE cur
DEALLOCATE cur

GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	3546 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Siddik
-- TFS#	3559
-- Description of change: Lynch syndrome indicaiton - lower procedures 
-------------------------------------------------------------------------------------------------------------------------

IF NOT EXISTS (SELECT 1 FROM ERS_Indications WHERE Description = 'Lynch syndrome')
BEGIN
	INSERT INTO ERS_Indications (Description, NEDTerm, IndicationSectionId)
	VALUES ('Lynch syndrome', 'Other', 1)
END

DECLARE @IndicationId INT;
SELECT @IndicationId = UniqueId FROM ERS_Indications WHERE Description = 'Lynch syndrome';

DECLARE @TypeId INT;
DECLARE cur CURSOR FOR
	SELECT ProcedureTypeId FROM ERS_ProcedureTypes 
	WHERE ProcedureType IN ('Colonoscopy', 'Sigmoidoscopy', 'Ent - Retrograde');

OPEN cur
FETCH NEXT FROM cur INTO @TypeId

WHILE @@FETCH_STATUS = 0
BEGIN
	IF NOT EXISTS (SELECT 1 FROM ERS_IndicationsProcedureTypes WHERE IndicationId = @IndicationId AND ProcedureTypeId = @TypeId)
	BEGIN
		INSERT INTO ERS_IndicationsProcedureTypes (IndicationId, ProcedureTypeId)
		VALUES (@IndicationId, @TypeId)
	END

	FETCH NEXT FROM cur INTO @TypeId
END

CLOSE cur
DEALLOCATE cur

GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS# 3559
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Siddik
-- TFS#	4317
-- Description of change: extent of intubation
-------------------------------------------------------------------------------------------------------------------------

EXEC dbo.DropIfExist 
    @ObjectName = 'lower_extent_confirmed_by_select', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[lower_extent_confirmed_by_select]
(
	@LimitationReason bit
)
AS
BEGIN
	SELECT UniqueId, Description, ISNULL(ParentId,0) As ParentId, Suppressed
	FROM [ERS_ExtentConfirmedByList]
	WHERE LimitationReason = @LimitationReason
	ORDER BY ISNULL(ListOrderBy, 999)
END
GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	4317 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Siddik
-- TFS#	4384
-- Description of change: Allergies not changing or pulling inot reprot
-------------------------------------------------------------------------------------------------------------------------

EXEC dbo.DropIfExist 
    @ObjectName = 'patient_allergy_select', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[patient_allergy_select]
(
	@PatientId int,
	@ProcedureId int,
	@IsProcedureCreation bit = 0
)
AS
BEGIN
	IF @IsProcedureCreation = 1
	BEGIN
		SELECT TOP 1 AllergyResult, AllergyDescription 
		FROM ERS_PatientAllergies 
		WHERE PatientId = @PatientId 
		ORDER BY ProcedureCreatedId DESC
	END
	ELSE
	BEGIN
		SELECT TOP 1 AllergyResult, AllergyDescription 
		FROM ERS_PatientAllergies 
		WHERE PatientId = @PatientId AND ProcedureCreatedId = @ProcedureId
	END
END

GO

------------------------------------------------------------------------------------------------------------------------
-- TFS#	4384 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Siddik
-- TFS#	4337
-- Description of change: Sorting Bug 

-- Updated by	:	Ahmed Shoud
-- TFS#	4062
-- All items are showing up double in Cystoscopy procedure
-------------------------------------------------------------------------------------------------------------------------

EXEC dbo.DropIfExist 
    @ObjectName = 'indications_select', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[indications_select]
(
	@ProcedureTypeId int
)
AS
BEGIN
	-- TFS 4062 Start
	SELECT SectionName, MIN(i.IndicationSectionId) as SectionId, MIN(i.UniqueId) as UniqueId, Description, NEDTerm, Suppressed, SubIndicationParent, ISNULL(ParentId, 0) AS ParentId, AdditionalInfo, i.ListOrderBy, JAGAuditable
	FROM ERS_Indications i
		INNER JOIN ERS_IndicationSections s on i.IndicationSectionId = s.IndicationSectionId
		INNER JOIN ERS_IndicationsProcedureTypes ip on i.UniqueId = ip.IndicationId
	WHERE ProcedureTypeId = @ProcedureTypeId AND PlannedProcedure = 0 AND i.Suppressed = 0
	GROUP BY SectionName, Description, NEDTerm, Suppressed, SubIndicationParent, ISNULL(ParentId, 0), AdditionalInfo, i.ListOrderBy, JAGAuditable
	ORDER BY ISNULL(i.ListOrderBy, 0), Description
	-- TFS 4062 End
END

GO

EXEC dbo.DropIfExist 
    @ObjectName = 'subindications_select', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[subindications_select]
(
	@ProcedureTypeId int
)
AS
BEGIN
	SELECT DISTINCT i.UniqueId, Description, NEDTerm, Suppressed, ISNULL(ListOrderBy,0), AdditionalInfo, IndicationId
	FROM ERS_SubIndications i
		INNER JOIN ERS_SubIndicationsProcedureTypes ip on i.UniqueId = ip.SubIndicationId
	WHERE ProcedureTypeId = @ProcedureTypeId
	ORDER BY ISNULL(ListOrderBy, 0), Description
END

GO

------------------------------------------------------------------------------------------------------------------------
-- TFS#	4337, 4062 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	MOSTAFIZUR RAHMAN
-- TFS#	4426
-- Description of change
-- Version numbers in the application
------------------------------------------------------------------------------------------------------------------------

EXEC dbo.DropIfExist 
    @ObjectName = 'fnGetDBInfo', 
    @ObjectTypePrefix = 'F' 
GO

CREATE FUNCTION dbo.fnGetDBInfo()
RETURNS @DBInfo TABLE (
    VersionNum VARCHAR(50),
    InstallDate DATETIME
)
AS
BEGIN
    DECLARE @VersionNum VARCHAR(50)
    DECLARE @InstallDate DATETIME

    SELECT TOP 1 
        @VersionNum = VersionNum, 
        @InstallDate = InstallDate 
    FROM DBVersion 
    ORDER BY InstallDate DESC

    INSERT INTO @DBInfo (VersionNum, InstallDate)
    VALUES (@VersionNum, @InstallDate)

    RETURN
END;
GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	4426 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Duncan
------------------------------------------------------------------------------------------------------------------------

IF Not EXISTS(SELECT * FROM sys.columns WHERE Name = N'IsPrinted' AND Object_ID = Object_ID(N'ERS_Procedures'))
Begin
Print 'Adding Column IsPrinted to ERS_Procedures table'
ALTER TABLE dbo.ERS_Procedures
   ADD IsPrinted BIT NULL


End
GO
UPDATE ERS_Procedures set IsPrinted = 1 WHERE ProcedureCompleted = 1
GO

EXEC dbo.DropIfExist @ObjectName = 'usp_IsProcedurePrinted',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE dbo.usp_IsProcedurePrinted
(
	@ProcedureId int
)
AS
	SELECT ISNULL(IsPrinted, 0) 
	FROM ERS_Procedures
	WHERE ProcedureId = @ProcedureId
GO

EXEC dbo.DropIfExist @ObjectName = 'usp_SetProcedurePrinted',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE dbo.usp_SetProcedurePrinted
(
	@ProcedureId int
)
AS
	UPDATE ERS_Procedures
	SET IsPrinted = 1
	WHERE ProcedureId = @ProcedureId
GO

------------------------------------------------------------------------------------------------------------------------
-- Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ahmed Shoud
-- TFS#	3016
-- Description of change
-- Data not saving onto report/procedure in Ileum/Jejunum - Ent Antegrade 
------------------------------------------------------------------------------------------------------------------------
Go

EXEC DropIfExist 'abnormalities_vascular_lesions_summary_update','S';
GO
CREATE PROCEDURE [dbo].[abnormalities_vascular_lesions_summary_update]
(
	@SiteId INT
)
AS
	SET NOCOUNT ON

	DECLARE
		@summary VARCHAR(200),
		@temp VARCHAR(120),
		@None BIT,
		@Type TINYINT,
		@Multiple BIT,
		@Quantity INT,
		@Bleeding TINYINT,
		@Area  VARCHAR(50)

	SELECT 
		@None=[None],
		@Type=[Type],
		@Multiple=Multiple,
		@Quantity=Quantity,
		@Bleeding=Bleeding,
		@Area=Area
	FROM
		ERS_CommonAbnoVascularLesions
	WHERE
		SiteId = @SiteId

	SET @Summary = ''

	IF @None = 1
		SET @summary = @summary + 'No vascular lesions'
	
	ELSE IF @Type > 0
	BEGIN
		IF @Multiple > 0 SET @summary = @summary + 'multiple'
		ELSE IF @Quantity > 1 SET @summary = @summary + CONVERT(VARCHAR(20), @Quantity)

		IF RIGHT(LOWER(@Area),5) = ' part' SET @Area = 'Duodenum' --For ERCP, the variable @Area has region name instead of Area and all the region in duodenum ends with ' part', so use this to generate @Summary text

		IF @Area = 'Oesophagus'
		BEGIN
			SET @temp = CASE @Type
						WHEN 1 THEN 'Telangiectasia'
						WHEN 2 THEN 'Angiodysplasia (<5mm)'
						WHEN 3 THEN 'Angiodysplasia (>5mm)'
						WHEN 4 THEN 'Angiodysplasia (large and small lesions)'
						WHEN 5 THEN 'Portal hypertensive gastropathy'
						WHEN 6 THEN 'Watermelon stomach'
					END
		END
		ELSE IF @Area = 'Stomach'
		BEGIN
			SET @temp = CASE @Type
						WHEN 1 THEN 'Telangiectasia'
						WHEN 2 THEN 'Angiodysplasia (<5mm)'
						WHEN 3 THEN 'Angiodysplasia (>5mm)'
						WHEN 4 THEN 'Angiodysplasia (large and small lesions)'
						WHEN 5 THEN 'Portal hypertensive gastropathy'
						WHEN 6 THEN 'Watermelon stomach'
						WHEN 7 THEN 'Dieulafoy lesion'
					END
		END
		ELSE IF @Area = 'Duodenum'
		BEGIN
			SET @temp = CASE @Type
						WHEN 1 THEN 'Telangiectasia'
						WHEN 2 THEN 'Angiodysplasia (<5mm)'
						WHEN 3 THEN 'Angiodysplasia (>5mm)'
						WHEN 4 THEN 'Angiodysplasia (large and small lesions)'
						WHEN 5 THEN 'Varices'
					END
		END
		ELSE IF @Area = 'colon' -- TFS 3016 Start
		BEGIN
			SET @temp = CASE @Type
						WHEN 1 THEN 'Telangiectasia'
						WHEN 2 THEN 'Angiodysplasia (<5mm)'
						WHEN 3 THEN 'Angiodysplasia (>5mm)'
						WHEN 4 THEN 'Angiodysplasia (large and small lesions)'
					END
		END  
		-- TFS 3016 End

		IF @summary <> '' SET @summary = @summary + ' ' + LOWER(@temp)
		ELSE SET @summary = @temp

		IF @Bleeding > 0 
		BEGIN
			SET @summary = @summary + ' with '


			IF @Area = 'Stomach'
			BEGIN
				SET @summary =  @summary + 
					CASE @Bleeding
						WHEN 1 THEN 'no bleeding'
						WHEN 2 THEN 'fresh clot'
						WHEN 3 THEN 'altered blood'
						WHEN 4 THEN 'active bleeding'
					END
			END
			ELSE IF @Area = 'Duodenum'
			BEGIN
				SET @summary =  @summary + 
					CASE @Bleeding
						WHEN 1 THEN 'no bleeding'
						WHEN 2 THEN 'fibrin plug'
						WHEN 3 THEN 'fresh clot'
						WHEN 4 THEN 'red sign'
						WHEN 5 THEN 'active bleeding'
					END
			END
			ELSE IF @Area = 'Oesophagus'
			BEGIN
				SET @summary =  @summary + 
					CASE @Bleeding
						WHEN 1 THEN 'no bleeding'
						WHEN 2 THEN 'fibrin plug'
						WHEN 3 THEN 'fresh clot'
						WHEN 4 THEN 'red sign'
						WHEN 5 THEN 'active bleeding'
					END
			END
			ELSE IF @Area = 'colon' -- TFS 3016 Start
			BEGIN
				SET @summary =  @summary + 
					CASE @Bleeding
						WHEN 1 THEN 'no bleeding'
						WHEN 2 THEN 'fibrin plug'
						WHEN 3 THEN 'fresh clot'
						WHEN 4 THEN 'red sign'
						WHEN 5 THEN 'active bleeding'
					END
			END -- TFS 3016 End


		END
	END
	--PRINT @summary

	-- Finally update the summary in abnormalities table
	UPDATE ERS_CommonAbnoVascularLesions
	SET Summary = (SELECT isnull(@summary, '') as [text()] FOR XML PATH(''))  
	WHERE SiteId = @siteId

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	3016
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ahmed Shoud
-- TFS#	4438
-- Description of change
-- NED Validation - ERCP Level of complexity should be conditionally mandatory
------------------------------------------------------------------------------------------------------------------------
GO
IF NOT EXISTS(SELECT 1 FROM UI_sections WHERE SectionName = 'Level of Complexity' AND SectionControl = 'UpperExtent.ascx' AND ReferenceTableName = 'ERS_LevelOfComplexity' AND DataTableName = 'ERS_ProcedureLevelOfComplexity')
BEGIN
	INSERT INTO UI_sections (SectionName, SectionControl, ItemOrder, ReferenceTableName, DataTableName, DisplayOnReport, NEDRequired, DNAExempt, PageId)
			      VALUES('Level of Complexity', 'UpperExtent.ascx', 0, 'ERS_LevelOfComplexity', 'ERS_ProcedureLevelOfComplexity', 0, 1, 1, 2)
	INSERT INTO UI_SectionProcedureTypes (UISectionId, ProcedureTypeId) VALUES (SCOPE_IDENTITY(), 2)
END
GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	4438 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ahmed Shoud
-- TFS#	4438
-- Description of change
-- NED Validation - ERCP Level of complexity should be conditionally mandatory
------------------------------------------------------------------------------------------------------------------------
Go

EXEC DropIfExist 'procedure_level_of_complexity_save','S';
GO
CREATE PROCEDURE [dbo].[procedure_level_of_complexity_save]
(
	@ComplexityId int,
	@ProcedureId int,
	@LoggedInUserId int
)
AS
BEGIN
	-- TFS 4438 Start
	IF @ComplexityId = 0
	BEGIN
		DELETE FROM ERS_ProcedureLevelOfComplexity WHERE ProcedureId = @ProcedureId

		EXEC UI_update_procedure_summary @ProcedureId, 'Level of Complexity', 'Level of Complexity:', 0
	END -- TFS 4438 End
	ELSE
	BEGIN
		IF NOT EXISTS (SELECT 1 FROM ERS_ProcedureLevelOfComplexity WHERE ProcedureId = @ProcedureId)
		BEGIN
			INSERT INTO ERS_ProcedureLevelOfComplexity (ComplexityId, ProcedureId, WhoCreatedId, WhenCreated)
			VALUES (@ComplexityId, @ProcedureId, @LoggedInUserId, getdate())
		END
		ELSE
		BEGIN
			UPDATE ERS_ProcedureLevelOfComplexity 
			SET ComplexityId = @ComplexityId,
				WhoUpdatedId = @LoggedInUserId,
				WhenUpdated = getdate()
			WHERE ProcedureId = @ProcedureId
			
		END
		EXEC UI_update_procedure_summary @ProcedureId, 'Level of Complexity', 'Level of Complexity:', 1
	END
END
Go
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	4438
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ahmed Shoud
-- TFS#	2426
-- Description of change
-- SEv2 Bronch / EBUS technique used
-- Updated by	:	Rony
-- TFS#	3513
-- Description of change: V2 Transnasal to be Procedure Title  
------------------------------------------------------------------------------------------------------------------------
Go

EXEC DropIfExist 'procedure_instruments_select','S';
GO
CREATE PROCEDURE [dbo].[procedure_instruments_select]
(
	@ProcedureId int
)
AS
BEGIN
	SELECT 
		ISNULL(Instrument1, 0) AS Instrument1, 
		ISNULL(Instrument2, 0) AS Instrument2, 
		ISNULL(ScopeGuide,0) AS ScopeGuide,
		ISNULL(TechniqueUsed,0) AS TechniqueUsed -- TFS 2426
	FROM ERS_Procedures
	WHERE ProcedureId = @ProcedureId
END
Go

Go

EXEC DropIfExist 'procedure_instruments_save','S';
GO
CREATE PROCEDURE [dbo].[procedure_instruments_save]
(
	@ProcedureId int,
	@Instrument1Id int,
	@Instrument2Id int,
	@ScopeGuideUsed bit,
	@TecniqueUsed varchar(max), -- TFS 2426
	@TecniqueUsedIdx varchar(50) -- TFS 2426
)
AS
BEGIN
	UPDATE ERS_Procedures 
	SET 
		Instrument1 = NULLIF(@Instrument1Id,0), 
		Instrument2 = NULLIF(@Instrument2Id, 0), 
		ScopeGuide = @ScopeGuideUsed,
		TechniqueUsed = @TecniqueUsedIdx -- TFS 2426
	WHERE ProcedureId = @ProcedureId

	DECLARE @SectionId int, @Summary varchar(max)

	
	/*Scope*/
	SET @Summary = 'Scopes:'
	IF @Instrument1Id > 0 
	BEGIN
		EXEC UI_update_procedure_summary @ProcedureId, 'Scopes', @Summary, @Instrument1Id
	END
	--ELSE IF @Instrument2Id > 0 
	--	EXEC UI_update_procedure_summary @ProcedureId, 'Scopes', @Summary, @Instrument2Id
	ELSE
		EXEC UI_update_procedure_summary @ProcedureId, 'Scopes', @Summary, 0

	--update reporting field for summary report
	DECLARE @InstrumentTxt varchar(max) = '', @Instru1Text varchar(200) = '', @Instru2Text varchar(200) = '', @Instru3Text varchar(max) = '' -- TFS 2426

	IF ISNULL(@Instrument1Id,0) > 0
		SELECT @Instru1Text = '1st Scope : ' + ScopeName FROM ERS_Scopes WHERE ScopeId = @Instrument1Id
	
	IF ISNULL(@Instrument2Id,0) > 0
		SELECT @Instru2Text = ScopeName FROM ERS_Scopes WHERE ScopeId = @Instrument2Id 
	
	IF @TecniqueUsed <> ''  -- TFS 2426
		SELECT @Instru3Text = 'Technique Used: ' + @TecniqueUsed -- TFS 2426

	--accessVia Part

	IF @ProcedureId IN (SELECT ProcedureId  FROM ERS_Procedures WHERE ProcedureType IN (select ProcedureTypeId from ERS_ProcedureTypes where ProcedureType In ('Bronchoscopy', 'EBUS'))) -- edited by MOSTAFIZ 10 oct/24
	BEGIN
		Select @Instru2Text = 'Access Via: ' + ListItemText
	FROM ers_lists WHERE ListItemNo=@Instrument2Id And ListDescription='AccessMethod Thoracic'
	END

	--accessVia Part
	
	If @Instru1Text <> '' 
		SET @InstrumentTxt = @Instru1Text

	
	If @Instru2Text <> '' 
		SET @InstrumentTxt = @InstrumentTxt + '<br /> ' + @Instru2Text

	IF @Instru3Text <> '' -- TFS 2426
		SET @InstrumentTxt = @InstrumentTxt + '<br /> ' + @Instru3Text -- TFS 2426

	IF @Instru1Text <> '' OR @Instru2Text <> '' OR @Instru3Text <> '' -- TFS 2426
	BEGIN
		--transnasal check
		IF EXISTS (SELECT 1 FROM dbo.ERS_Procedures WHERE ProcedureId = @ProcedureId AND Transnasal = 1)
		BEGIN	
			SET @InstrumentTxt = @InstrumentTxt + ' (transnasal) '
		END

		UPDATE ERS_ProceduresReporting SET PP_Instrument = @InstrumentTxt WHERE ProcedureId = @ProcedureId
	END
END
Go
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	2426
------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	MOSTAFIZUR RAHMAN
-- TFS#	4166
-- Description of change
-- Abnormalities Tree Save Function
------------------------------------------------------------------------------------------------------------------------

EXEC dbo.DropIfExist 
    @ObjectName = 'abnormalities_barrett_summary_update', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[abnormalities_barrett_summary_update]
(
       @SiteId INT
)
AS
       SET NOCOUNT ON

       DECLARE
              @summary VARCHAR(300),
              @None BIT,
              @BarrettIslands BIT,
              @Proximal INT,
              @Distal INT,
              @DistanceC1 INT,
              @DistanceC2 INT,
              @DistanceC3 INT,
              @DistanceM1 INT,
              @DistanceM2 INT,
			  @FocalLesions BIT,
			  @FocalLesionQty INT,
			  @FocalLesionLargest INT,
			  @FocalLesionTumourTypeId INT,
			  @FocalLesionProbably BIT,
			  @FocalLesionParisClassificationId INT,
			  @FocalLesionPitPatternId INT,
			  @InspectionTimeMins INT, -- 4166 by mostafiz
			  @SmokerRadioButtonListId INT--add by mostafiz 2360



       SELECT 
              @None=[None],
              @BarrettIslands = BarrettIslands,
              @Proximal = Proximal,
              @Distal = Distal,
              @DistanceC1 = DistanceC1,
              @DistanceC2 = DistanceC2,
              @DistanceC3 = DistanceC3,
              @DistanceM1 = DistanceM1,
              @DistanceM2 = DistanceM2,
			  @FocalLesions = FocalLesions,
			  @FocalLesionQty = FocalLesionQty,
			  @FocalLesionLargest = FocalLesionLargest,
			  @FocalLesionTumourTypeId = FocalLesionTumourTypeId,
			  @FocalLesionProbably = FocalLesionProbably,
			  @FocalLesionParisClassificationId = FocalLesionParisClassificationId,
			  @FocalLesionPitPatternId = FocalLesionPitPatternId,
			  @InspectionTimeMins= InspectionTimeMins, -- 4166 by mostafiz
			  @SmokerRadioButtonListId =SmokerRadioButtonListId --add by mostafiz 2360
       FROM
              ERS_UpperGIAbnoBarrett
       WHERE
              SiteId = @SiteId

       SET @Summary = ''
	DECLARE @BarrattsText varchar(500) ='', @Start varchar(500) ='', @End varchar(500)=''

       IF @None = 1 SET @summary = @summary + 'No Barrett''s epithelium'
       ELSE 
        BEGIN
		
			IF (ISNULL(@InspectionTimeMins,0)<>0) SET @summary=@summary+ 'Inspection Time: '+cast(ISNULL(@InspectionTimeMins,0) as varchar(50)) + ' mins. ' --add by mostafiz 4166
			
		--add by mostafiz 2360
					
			IF (@SmokerRadioButtonListId =1 ) SET @summary=@summary+ ' Patient is smoker. '
			ELSE IF (@SmokerRadioButtonListId =2 ) SET @summary=@summary+ 'Patient is non-smoker. '
			
		--add by mostafiz 2360
			

			--FOCAL LESIONS
			IF @FocalLesions = 1 
			BEGIN
				--saves calling the table multiple times :)
				DECLARE @TumourTypes TABLE (TypeId int, [Description] varchar(100))
				INSERT INTO @TumourTypes
				SELECT UniqueId, [Description] 
				FROM ERS_TumourTypes 
				WHERE Suppressed = 0


				IF @FocalLesionQty > 1 SET @summary = @summary + CONVERT(VARCHAR(20), @FocalLesionQty) + ' '
				ELSE SET @summary = @summary + 'A '
		
				IF @FocalLesionProbably = 1 SET @summary = @summary + 'probably '

				SELECT @summary = @summary + LOWER([Description]) + ' ' FROM @TumourTypes WHERE TypeId = @FocalLesionTumourTypeId

				IF @FocalLesionQty > 1 SET @summary = @summary + 'focal lesions ' ELSE SET @summary = @summary + 'focal lesion ' 

				IF (@FocalLesionQty > 0 AND @FocalLesionLargest > 0) 
				BEGIN
					IF @FocalLesionQty > 1
						SET @summary = @summary + '(largest ' + CONVERT(VARCHAR(20), @FocalLesionLargest) + 'mm)'
					ELSE
						SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @FocalLesionLargest) + 'mm)'
				END

				SET @summary = @summary + '. '
			END

			IF @BarrettIslands=1 SET @Start='Islands of '
			IF (ISNULL(@Distal,0) <> 0) OR (ISNULL(@Proximal,0) <>0)
					BEGIN
					SET @End= ' from ' + cast(ISNULL(@Proximal,0) as varchar(50)) + 'cm'
					SET @End= @End + ' to ' + cast(ISNULL(@Distal,0) as varchar(50)) + 'cm'
					END
			IF ISNULL(@DistanceM1,0)<>0 OR ISNULL(@DistanceM2,0)<>0
					BEGIN
					SET @BarrattsText= ', Prague C'+cast(ISNULL(@DistanceM2,0) as varchar(50))
					SET @BarrattsText= @BarrattsText + 'M' +cast(ISNULL(@DistanceM1,0) as varchar(50))
					END
			ELSE
					BEGIN
					IF @DistanceC1>0 AND @DistanceC2>0 AND @DistanceC3>0
					BEGIN
					SET @BarrattsText = ', Prague C' +cast(ISNULL(@DistanceC3-@DistanceC1,0) as varchar(50))
					SET @BarrattsText= @BarrattsText + 'M' +cast(ISNULL(@DistanceC3 - @DistanceC2,0) as varchar(50))
					END
					END
			IF @BarrattsText ='' BEGIN IF @Start <> '' OR @End <> '' SET @summary = @Start + 'Barrett''s epithelium'+ @End END
			ELSE SET @summary = @summary + @Start + 'Barrett''s epithelium distance (ab oral)'+ @End+@BarrattsText --TFS--4079

        END
       -- Finally update the summary in abnormalities table
       UPDATE ERS_UpperGIAbnoBarrett
       SET Summary = @Summary 
       WHERE SiteId = @siteId
GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	4166 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ahmed Shoud
-- TFS#	1881
-- Description of change
-- SE V2 create procedure change to Endoscopist  
------------------------------------------------------------------------------------------------------------------------
 IF NOT EXISTS (
        SELECT 1
        FROM INFORMATION_SCHEMA.COLUMNS
        WHERE TABLE_NAME = 'ERS_Users' AND
              COLUMN_NAME IN ('IsTrainee')
    )
    BEGIN
		
		ALTER TABLE ERS_Users
            ADD IsTrainee Bit DEFAULT 0;
    END
GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	1881
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ahmed Shoud
-- TFS#	1881
-- Description of change
-- SE V2 create procedure change to Endoscopist 
-------------------------------------------------------------------------------------------------------------------------

EXEC dbo.DropIfExist 
    @ObjectName = 'get_user', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[get_user]
(
	@UserId INT,
	@TrustId INT
)
AS

BEGIN

	--Gather users Roles for user and current trust into temporary table
	DECLARE @RoleId VARCHAR(MAX)
	SELECT @RoleID = RoleID FROM ERS_Users WHERE UserID = @UserId
	SELECT [item] AS RoleId, r.RoleName INTO #tmpRoles FROM dbo.fnSplitString(@RoleId,','), ERS_Roles r WHERE [item] = r.RoleId  AND (r.TrustId = @TrustId OR r.TrustId IS NULL)

	--Get User and Comma seperated list of role names
	SELECT [UserID]
      ,[ExpiresOn]
      ,[Username]
      ,[Title]
      ,[Forename]
      ,[Surname]
      ,[Initials]
      ,[Qualifications]
      ,u.[JobTitleID]
      ,[RoleID]
      ,CanRunAK
      ,[IsListConsultant]
      ,[IsEndoscopist1]
      ,[IsEndoscopist2]
      ,[IsAssistantOrTrainee]
      ,[IsNurse1]
      ,[IsNurse2]
      ,[ResetPassword]
      ,u.[Suppressed] 
      ,[ShowTooltips]     
      ,[GMCCode]
      ,[CanEditDropdowns]
      ,[CanViewAllUserAudits]
      ,ISNULL([GeneralLibrary],0) AS GeneralLibrary,
	  jt.Description AS JobTitle,
	(SELECT SUBSTRING((SELECT ',' + CONVERT(VARCHAR(12),RoleName)
				  FROM #tmpRoles
				  ORDER BY CAST(RoleId AS NUMERIC(4,0)) ASC
				  for xml path('')),2,70)) AS Permissions
	  ,CanOverBookLists
	  ,ISNULL(CanOverrideSchedule,0) CanOverrideSchedule
	  ,ISNULL(IsTrainee,0) IsTrainee
	FROM ERS_Users u
	LEFT JOIN ERS_JobTitles jt ON u.JobTitleID = jt.JobTitleID
	WHERE UserId = @UserId
END
GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	1881 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ahmed Shoud
-- TFS#	1881
-- Description of change
-- SE V2 create procedure change to Endoscopist 
-------------------------------------------------------------------------------------------------------------------------

EXEC dbo.DropIfExist 
    @ObjectName = 'insert_user', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[insert_user]
(
	@Username VARCHAR(100),
	@Title VARCHAR(10),
	@Forename VARCHAR(100),
	@Surname VARCHAR(100),
	@Qualifications VARCHAR(30),
	@IsGI BIT,
	@JobTitleId INT,
	@RoleID VARCHAR(70),
	@CanRunAK BIT,
	@CanViewAllUserAudits BIT,
	@IsListConsultant BIT,
	@IsEndoscopist1 BIT,
	@IsEndoscopist2 BIT,
	@IsAssistantOrTrainee BIT,
	@IsNurse1 BIT,
	@IsNurse2 BIT,
	@Suppressed BIT,
	@ExpiresOn DATETIME,
	@ShowTooltips BIT,
	@GMCCode VARCHAR(50),
	@CanEditDropdowns BIT,
	@CanOverbookLists BIT,
	@Password VARCHAR(200),
	@Initials VARCHAR(10),
	@GeneralLibrary BIT,
	@CanOverrideSchedule BIT,
	@LoggedInUserId int,
	@IsTrainee BIT
)
AS
BEGIN
	INSERT INTO ERS_Users (RecordCreated, LastUpdated, ExpiresOn, Username, [Password], PasswordExpiresOn, Title, Forename, Surname, Initials, Qualifications, IsGIConsultant, JobTitleId, RoleID, CanRunAK, IsListConsultant, IsEndoscopist1, IsEndoscopist2, IsAssistantOrTrainee, IsNurse1, IsNurse2, ResetPassword, Suppressed, ShowTooltips, GMCCode, CanEditDropdowns, CanViewAllUserAudits, WhoCreatedId, WhenCreated, CanOverbookLists,GeneralLibrary, CanOverrideSchedule, IsTrainee)
	VALUES (GETDATE(), GETDATE(), @ExpiresOn, @Username, @Password, GETDATE(), @Title, @Forename, @Surname, @Initials, @Qualifications, @IsGI, @JobTitleId, @RoleID, @CanRunAK, @IsListConsultant, @IsEndoscopist1, @IsEndoscopist2, @IsAssistantOrTrainee, @IsNurse1, @IsNurse2, 1, @Suppressed, @ShowTooltips, @GMCCode, @CanEditDropdowns, @CanViewAllUserAudits, @LoggedInUserId, GETDATE(), @CanOverbookLists, @GeneralLibrary, @CanOverrideSchedule, @IsTrainee)
	SELECT SCOPE_IDENTITY()
END
GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	1881 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ahmed Shoud
-- TFS#	1881
-- Description of change
-- SE V2 create procedure change to Endoscopist 
-------------------------------------------------------------------------------------------------------------------------

EXEC dbo.DropIfExist 
    @ObjectName = 'update_user', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[update_user]
(
	@TrustId INT,
	@UserId INT,
	@Username VARCHAR(100),
	@Title VARCHAR(10),
	@Forename VARCHAR(100),
	@Surname VARCHAR(100),
	@Qualifications VARCHAR(30),
	@IsGI BIT,
	@JobTitleId INT,
	@RoleID VARCHAR(70),
	@CanRunAK BIT,
	@CanViewAllUserAudits BIT,
	@IsListConsultant BIT,
	@IsEndoscopist1 BIT,
	@IsEndoscopist2 BIT,
	@IsAssistantOrTrainee BIT,
	@IsNurse1 BIT,
	@IsNurse2 BIT,
	@Suppressed BIT,
	@ExpiresOn DATETIME,
	@ShowTooltips BIT,
	@GMCCode VARCHAR(50),
	@CanEditDropdowns BIT,
	@UpdateUserId INT,
	@CanOverbookLists BIT,
	@GeneralLibrary BIT,
	@CanOverrideSchedule BIT,
	@IsTrainee BIT
)
AS

SET NOCOUNT ON

BEGIN TRANSACTION

BEGIN TRY
	UPDATE ERS_Users 
        SET Username=@Username, 
            LastUpdated=getdate(), 
            Title=@Title, 
			Forename=@Forename, 
			Surname=@Surname, 
            Qualifications = @Qualifications, 
            IsGIConsultant = @IsGI, 
            JobTitleID = @JobTitleId, 
            CanRunAK=@CanRunAK,
            CanViewAllUserAudits=@CanViewAllUserAudits,
            IsListConsultant=@IsListConsultant, 
			IsEndoscopist1=@IsEndoscopist1, 
			IsEndoscopist2=@IsEndoscopist2, 
            IsAssistantOrTrainee=@IsAssistantOrTrainee, 
			IsNurse1=@IsNurse1, 
			IsNurse2=@IsNurse2, 
            Suppressed=@Suppressed, 
			ExpiresOn=@ExpiresOn, 
			ShowTooltips=@ShowTooltips, 
			GMCCode=@GMCCode, 
			CanEditDropdowns = @CanEditDropdowns, 
		    GeneralLibrary = @GeneralLibrary, 
			CanOverbookLists = @CanOverbookLists,
			CanOverrideSchedule = @CanOverrideSchedule,
			IsTrainee = @IsTrainee,
			WhoUpdatedId = ISNULL(@UpdateUserId, WhoUpdatedId), 
			WhenUpdated = GETDATE() 
        WHERE UserId=@UserId

		EXEC update_user_roles @UserId=@UserId, @TrustId=@TrustId,@TrustRolesToAdd=@RoleId

END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
	DECLARE @ErrorSeverity INT;
	DECLARE @ErrorState INT;

	SELECT	@ErrorMessage = ERROR_MESSAGE(),
			@ErrorSeverity = ERROR_SEVERITY(),
			@ErrorState = ERROR_STATE();
    
	RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;
GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	1881 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rezaul Karim
-- TFS#	4302
-- Description of change
-- Bowel Prep audits
------------------------------------------------------------------------------------------------------------------------

EXEC dbo.DropIfExist @ObjectName = 'auditBowelPrepSummary',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE Procedure [dbo].[auditBowelPrepSummary]
	@UserId int
AS

/*****************************************************************************************************************
Update History:
	01		:		21 May 2024		Mostafiz TFS1811: Filter by Operating Hospital 
******************************************************************************************************************/

BEGIN
	DECLARE @FromDate as Date,
			@ToDate as Date,
			@TrustId as int,
			@OperatingHospitalList as varchar(100)  --added by mostafiz 5/21/24 Filter by Hospital TFS1811

	Select	@FromDate = FromDate,
			@ToDate = ToDate,
			@TrustId = TrustId,
			@OperatingHospitalList=OperatingHospitalList  --added by mostafiz 5/21/24 Filter by Hospital TFS1811
	FROM	ERS_ReportFilter
	where	UserID = @UserId

Select u.Surname + ', '+ u.Forename as 'Endoscopist',
	case p.ProcedureType when 3 then 'Colonoscopy'
						 when 4 then 'Sigmoidoscopy'
						 else 'unknown' end as 'Procedure Type',
	sum(bpq.Inadequate)  as 'Poor prep',
	sum(bpq.Fair) as Fair,
	sum(bpq.Good) as Good,
	sum(bpq.Excellent) as Excellent
	FROM ERS_Procedures p
	join ERS_Users u on u.UserID = p.Endoscopist1
	join ERS_Patients pat on pat.PatientId = p.PatientId
	join ERS_ReportConsultants rc on u.UserID = rc.ConsultantID 
	join 	(Select ProcedureID, 
				case when isnull(TotalPrepScore, 0) = 0 then 1 else 0  end as Inadequate  ,
				case when isnull(TotalPrepScore, 0) > 0 and isnull(TotalPrepScore, 0) <=3 then 1 else 0  end as Fair  ,
				case when isnull(TotalPrepScore, 0) > 3 and isnull(TotalPrepScore, 0) <=6 then 1 else 0  end as Good  ,
				case when isnull(TotalPrepScore, 0) > 6 and isnull(TotalPrepScore, 0) <=9 then 1 else 0  end as Excellent  
			from ERS_ProcedureBowelPrep) bpq on p.ProcedureId = bpq.ProcedureID 
	where p.ProcedureCompleted = 1
	and p.IsActive = 1
	and p.CreatedOn >= @FromDate AND p.CreatedOn <= @ToDate
	and rc.UserID = @UserId
	and p.ProcedureType in (3, 4) -- Just want colon and sig reports
	--and pat.PatientId in (Select patientId from ERS_PatientTrusts where TrustId = @TrustId)  --omited by mostafiz 5/21/24 Filter by Hospital TFS1811
	AND p.OperatingHospitalID IN (SELECT * FROM dbo.splitString(@OperatingHospitalList,',') )  --added by mostafiz 5/21/24 Filter by Hospital TFS1811
	group by u.Surname + ', '+ u.Forename, p.ProcedureType
	order by u.Surname + ', '+ u.Forename, p.ProcedureType
END
GO

------------------------------------------------------------------------------------------------------------------------
-- TFS#	4302 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Siddik
-- TFS#	4066
-- Description of change: Planned Procedures - filtering per procedure 
-------------------------------------------------------------------------------------------------------------------------

DECLARE @SectionId INT = (SELECT IndicationSectionId FROM ERS_IndicationSections WHERE SectionName = 'Planned procedures');

MERGE INTO ERS_Indications AS Target
USING (
    VALUES
    ('Bariatric Pre-Assessment'),
    ('Post Bariatric Surgery Assessment'),
    ('Insertion of pH probe'),
    ('Balloon Insertion'),
    ('Balloon Removal'),
    ('Scouting Procedure'),
    ('Foreign Body'),
    ('TEMS Assessment'),
    ('TEMS Follow up'),
    ('Polyp Surveillance'),
    ('Singe baloon enteroscopy'),
    ('Double balloon enteroscopy (push-pull enteroscopy)'),
    ('Stent Change'),
    ('Stent Placement'),
    ('Stent Removal'),
    ('Stone Removal'),
    ('Papillotomy/Sphincterotomy'),
    ('Naso-Pancreatic/Biliary Drains'),
    ('Manometry'),
    ('Endoscopic Cyst puncture'),
    ('Combined Procedure (Rendezvous)'),
    ('Cannulate and opacify the biliary tree'),
    ('Planned Ampullectomy'),
    ('EUS guided FNA/Biopsy'),
    ('EUS Guided Cystgastrostomy'),
    ('EUS guided coeliac plexus block /neurolysis'),
    ('Hemeroide Banding'),
    ('Agron Plasma Coagulation'),
    ('Assessment of Celiac Disease'),
    ('Tumour Staging')
) AS Source (Description)
ON Target.Description = Source.Description

WHEN MATCHED AND Target.IndicationSectionId <> @SectionId THEN 
    UPDATE SET IndicationSectionId = @SectionId

WHEN NOT MATCHED THEN 
    INSERT (Description, NEDTerm, IndicationSectionId)
    VALUES (Source.Description, Source.Description, @SectionId);

GO

--gastroscopy (1)
UPDATE ERS_Indications
SET Description = REPLACE(Description, 'PEG', 'PEG/PEJ')
WHERE Description IN ('PEG change', 'PEG placement', 'PEG removal');
GO

DELETE eip 
FROM ERS_IndicationsProcedureTypes eip
INNER JOIN ERS_Indications ei ON eip.IndicationId = ei.UniqueId
WHERE ei.Description IN ('PEJ placement', 'Polyp Assessment', 'Stricture dilatation')
AND eip.ProcedureTypeId = 1
GO

INSERT INTO ERS_IndicationsProcedureTypes (IndicationId, ProcedureTypeId)
SELECT IndicationId, ProcedureTypeId FROM (SELECT UniqueId, 1 FROM ERS_Indications WHERE Description IN('Bariatic Pre-Assessment', 'Post Bariatic Surgery Assessment', 'Insertion of pH probe', 'Balloon Insertion', 'Balloon Removal', 'Scouting Procedure'))
AS NewData (IndicationId, ProcedureTypeId)
WHERE NOT EXISTS (SELECT 1 FROM ERS_IndicationsProcedureTypes WHERE ERS_IndicationsProcedureTypes.IndicationId = NewData.IndicationId AND ERS_IndicationsProcedureTypes.ProcedureTypeId = 1);
GO

-- Colon (3) and Sigmoid (4)
DELETE eip 
FROM ERS_IndicationsProcedureTypes eip
INNER JOIN ERS_Indications ei ON eip.IndicationId = ei.UniqueId
WHERE ei.Description IN ('Capsule placement', 'Injection of botulinum toxin', 'Polyp Assessment', 'Stent change', 'Stricture dilatation')
AND eip.ProcedureTypeId IN (3, 4)
GO

INSERT INTO ERS_IndicationsProcedureTypes (IndicationId, ProcedureTypeId)
SELECT IndicationId, ProcedureTypeId FROM (SELECT UniqueId, 3 FROM ERS_Indications WHERE Description IN('Scouting Procedure', 'Polyp Surveillance', 'Hemeroide Banding'))
AS NewData (IndicationId, ProcedureTypeId)
WHERE NOT EXISTS (SELECT 1 FROM ERS_IndicationsProcedureTypes WHERE ERS_IndicationsProcedureTypes.IndicationId = NewData.IndicationId AND ERS_IndicationsProcedureTypes.ProcedureTypeId = 3);
GO

INSERT INTO ERS_IndicationsProcedureTypes (IndicationId, ProcedureTypeId)
SELECT IndicationId, ProcedureTypeId FROM (SELECT UniqueId, 4 FROM ERS_Indications WHERE Description IN('Scouting Procedure', 'Forgeign Body', 'TEMS Assessment', 'TEMS Follow up'))
AS NewData (IndicationId, ProcedureTypeId)
WHERE NOT EXISTS (SELECT 1 FROM ERS_IndicationsProcedureTypes WHERE ERS_IndicationsProcedureTypes.IndicationId = NewData.IndicationId AND ERS_IndicationsProcedureTypes.ProcedureTypeId = 4);
GO

--ENT Antegrade (8)
DELETE eip 
FROM ERS_IndicationsProcedureTypes eip
INNER JOIN ERS_Indications ei ON eip.IndicationId = ei.UniqueId
WHERE ei.Description IN ('Injection of botulinum toxin', 'Nasojejenal tube insertion', 'PEG/PEJ change', 'PEG/PEJ placement', 'PEG/PEJ removal', 'Polyp Assessment', 'Stent change', 'Stricture dilatation')
AND eip.ProcedureTypeId = 8
GO

INSERT INTO ERS_IndicationsProcedureTypes (IndicationId, ProcedureTypeId)
SELECT IndicationId, ProcedureTypeId FROM (SELECT UniqueId, 8 FROM ERS_Indications WHERE Description IN('Singe baloon enteroscopy', 'Double balloon enteroscopy (push-pull enteroscopy)', 'Scouting Procedure', 'Agron Plasma Coagulation', 'Assessment of Celiac Disease'))
AS NewData (IndicationId, ProcedureTypeId)
WHERE NOT EXISTS (SELECT 1 FROM ERS_IndicationsProcedureTypes WHERE ERS_IndicationsProcedureTypes.IndicationId = NewData.IndicationId AND ERS_IndicationsProcedureTypes.ProcedureTypeId = 8);
GO

--ENT Retrograde (9)
DELETE eip 
FROM ERS_IndicationsProcedureTypes eip
INNER JOIN ERS_Indications ei ON eip.IndicationId = ei.UniqueId
WHERE ei.Description IN ('Capsule placement', 'Injection of botulinum toxin', 'Polyp Assessment', 'Stricture dilatation')
AND eip.ProcedureTypeId = 9
GO

INSERT INTO ERS_IndicationsProcedureTypes (IndicationId, ProcedureTypeId)
SELECT IndicationId, ProcedureTypeId FROM (SELECT UniqueId, 9 FROM ERS_Indications WHERE Description IN('Singe baloon enteroscopy', 'Double balloon enteroscopy (push-pull enteroscopy)', 'Scouting Procedure'))
AS NewData (IndicationId, ProcedureTypeId)
WHERE NOT EXISTS (SELECT 1 FROM ERS_IndicationsProcedureTypes WHERE ERS_IndicationsProcedureTypes.IndicationId = NewData.IndicationId AND ERS_IndicationsProcedureTypes.ProcedureTypeId = 9);
GO

--ERCP (2)
DELETE eip 
FROM ERS_IndicationsProcedureTypes eip
INNER JOIN ERS_Indications ei ON eip.IndicationId = ei.UniqueId
WHERE ei.Description IN ('Capsule placement', 'Injection of botulinum toxin', 'Planned Dilatation', 'Polyp Assessment')
AND eip.ProcedureTypeId = 2
GO

INSERT INTO ERS_IndicationsProcedureTypes (IndicationId, ProcedureTypeId)
SELECT IndicationId, ProcedureTypeId FROM (SELECT UniqueId, 2 FROM ERS_Indications WHERE Description IN('Stent Change', 'Stent Placement', 'Stent Removal', 
'Stone Removal', 'Papillotomy/Sphincterotomy', 'Naso-Pancreatic/Biliary Drains', 'Manometry', 'Endoscopic Cyst puncture', 'Combined Procedure (Rendezvous)', 'Cannulate and opacify the biliary tree', 'Planned Ampullectomy'
))
AS NewData (IndicationId, ProcedureTypeId)
WHERE NOT EXISTS (SELECT 1 FROM ERS_IndicationsProcedureTypes WHERE ERS_IndicationsProcedureTypes.IndicationId = NewData.IndicationId AND ERS_IndicationsProcedureTypes.ProcedureTypeId = 2);
GO

--EUS-OGD (6) and EUS-HPB (7)
DELETE eip 
FROM ERS_IndicationsProcedureTypes eip
INNER JOIN ERS_Indications ei ON eip.IndicationId = ei.UniqueId
WHERE ei.Description IN ('Capsule placement', 'Injection of botulinum toxin', 'Planned dilatation', 'Planned polypectomy', 'Polyp Assessment', 'Stricture dilatation')
AND eip.ProcedureTypeId IN (6, 7)
GO

INSERT INTO ERS_IndicationsProcedureTypes (IndicationId, ProcedureTypeId)
SELECT IndicationId, ProcedureTypeId FROM (SELECT UniqueId, 6 FROM ERS_Indications WHERE Description IN('EUS guided FNA/Biopsy', 'Tumour Staging', 'EUS Guided Cystgastrostomy'))
AS NewData (IndicationId, ProcedureTypeId)
WHERE NOT EXISTS (SELECT 1 FROM ERS_IndicationsProcedureTypes WHERE ERS_IndicationsProcedureTypes.IndicationId = NewData.IndicationId AND ERS_IndicationsProcedureTypes.ProcedureTypeId = 6);
GO

INSERT INTO ERS_IndicationsProcedureTypes (IndicationId, ProcedureTypeId)
SELECT IndicationId, ProcedureTypeId FROM (SELECT UniqueId, 7 FROM ERS_Indications WHERE Description IN('EUS guided FNA/Biopsy', 'EUS guided cystogastrostomy', 'EUS guided coeliac plexus block /neurolysis'))
AS NewData (IndicationId, ProcedureTypeId)
WHERE NOT EXISTS (SELECT 1 FROM ERS_IndicationsProcedureTypes WHERE ERS_IndicationsProcedureTypes.IndicationId = NewData.IndicationId AND ERS_IndicationsProcedureTypes.ProcedureTypeId = 7);
GO

DECLARE @ParentId INT = (SELECT UniqueId FROM ERS_Indications WHERE Description = 'Tumour Staging')
DECLARE @SectionId INT = (SELECT IndicationSectionId FROM ERS_IndicationSections WHERE SectionName = 'Planned procedures');

INSERT INTO ERS_Indications (Description, NEDTerm, IndicationSectionId, ParentId)
OUTPUT inserted.UniqueId, 6 INTO ERS_IndicationsProcedureTypes (IndicationId, ProcedureTypeId)
SELECT Description, NEDTerm, IndicationSectionId, ParentId
FROM (
    VALUES
    ('Oesophageal', 'Oesophageal', @SectionId, @ParentId),
    ('Gastric', 'Gastric', @SectionId, @ParentId),
	('Duodenal', 'Duodenal', @SectionId, @ParentId)
) AS NewData (Description, NEDTerm, IndicationSectionId, ParentId)
WHERE NOT EXISTS (
    SELECT 1
    FROM ERS_Indications
    WHERE ERS_Indications.Description = NewData.Description
);

GO

------------------------------------------------------------------------------------------------------------------------
-- TFS#	4066 ended
------------------------------------------------------------------------------------------------------------------------


------------------------------------------------------------------------------------------------------------------------
-- Updated by	: Raihanul	
-- TFS#	3669
-- Description of change
-- Ommited top 1's to show all the diagnosis of selected sites
------------------------------------------------------------------------------------------------------------------------
EXEC dbo.DropIfExist @ObjectName = 'tvfNED_Diagnoses',      -- varchar(100)
                     @ObjectTypePrefix = 'F' -- varchar(5)
GO
CREATE FUNCTION [dbo].[tvfNED_Diagnoses]
(	
	 @ProcedureType AS INT
	,@ProcedureId AS INT
)
RETURNS @Diagnoses TABLE (
	Ned_Name VARCHAR(200),
	Tattooed VARCHAR(3),
	[site] VARCHAR(100),
	Comment  VARCHAR(1000),
	barrettsLengthCircumferential INT,
	barrettsLengthMaximum INT,
	barretsInspectionTime INT,
	gastricInspectiontime INT,
	oesophagitisLaClassification VARCHAR(2),
	DICAScore INT,
	UCEIS INT,
	mayoScore INT,
	rutgeertsScore VARCHAR(2),
	CDEIS INT
)
AS
BEGIN
	IF NOT EXISTS (SELECT 1 FROM ERS_Diagnoses WHERE ProcedureId = @ProcedureId AND MatrixCode NOT IN ('Summary','D138P2','D33P2', 'D51P2','D67P2'))
	BEGIN
		INSERT INTO @Diagnoses
		--## There are few Exception 'Diagnoses' Code.. Which doesn't exist int he DiagnosesMatrix.Code field. So- read them separately
			SELECT TOP 1 --## 'Top 1' Because- it can be like: "'OverallNormal', 'DuodenumNormal', 'OesophagusNormal', 'StomachNormal'"- and we need only once to show 'Normal!'
				  'Normal' AS Ned_Name
				, NULL	AS Tattooed
				, 'None' AS site		
				, NULL	AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL AS oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
	END
	ELSE IF EXISTS (SELECT 1 FROM ERS_Diagnoses WHERE ProcedureId = @ProcedureId AND MatrixCode = 'OverallNormal')
	BEGIN
		INSERT INTO @Diagnoses
		--## There are few Exception 'Diagnoses' Code.. Which doesn't exist int he DiagnosesMatrix.Code field. So- read them separately
			SELECT TOP 1 --## 'Top 1' Because- it can be like: "'OverallNormal', 'DuodenumNormal', 'OesophagusNormal', 'StomachNormal'"- and we need only once to show 'Normal!'
				  'Normal' AS Ned_Name
				, NULL	AS Tattooed
				, 'None' AS site		
				, NULL	AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL AS oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
	END
	ELSE IF EXISTS (SELECT 1 FROM ERS_Diagnoses WHERE ProcedureId = @ProcedureId AND MatrixCode = 'ColonNormal')
	BEGIN
		INSERT INTO @Diagnoses
		--## There are few Exception 'Diagnoses' Code.. Which doesn't exist int he DiagnosesMatrix.Code field. So- read them separately
			SELECT TOP 1 --## 'Top 1' Because- it can be like: "'OverallNormal', 'DuodenumNormal', 'OesophagusNormal', 'StomachNormal'"- and we need only once to show 'Normal!'
				  'Normal' AS Ned_Name
				, NULL	AS Tattooed
				, 'None' AS site		
				, NULL	AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL AS oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
	END
	ELSE
	BEGIN
		INSERT INTO @Diagnoses
		   SELECT 'Colorectal cancer' AS Ned_Name
				, CASE WHEN ISNULL(T.TattooedId, 0) = 1 THEN 'No' WHEN ISNULL(T.TattooedId, 0) = 2 THEN 'Yes' END AS tattooed	--## 'Colonic polyps or Rectal polyps' => Colon/FLexi ONLY! 
				, dbo.fnNED_GetBiopsySiteName(P.ProcedureId, R.Region) AS Site		--## Location of tattoo. BiopsyEnum (Page 42, in Business Spec.doc v.1.15): The Biopsy field is procedure specific. See the BiopsyEnum table for further information.
				, NULL AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL AS oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
			 FROM [dbo].[ERS_Diagnoses] D
		--LEFT JOIN [dbo].[ERS_DiagnosesMatrix]	AS M ON D.MatrixCode = M.Code
		LEFT JOIN [dbo].[ERS_Procedures]		AS P ON D.ProcedureID = P.ProcedureId
		LEFT JOIN dbo.ERS_Sites		AS S ON D.SiteId = S.SiteId
		LEFT JOIN dbo.ERS_Regions	AS R ON S.RegionId = R.RegionId
		LEFT JOIN dbo.ERS_ColonAbnoTumour T ON T.SiteId = S.SiteID
			WHERE D.ProcedureId= @ProcedureId
			  AND P.ProcedureType IN(3,4,9)	--## Only for OGD/Colon/FLEXI! NOT for ERCP! - NO, Colon and Flexi only. How can you get colon cancer in an OGD procedure? - Don't forget ENT procedures, but really, we don't need this line as it should be taken care of by the matrix code on the next line
			  AND D.MatrixCode IN ('S69P3', 'D69P3')  --## 'Colorectal cancer'

		UNION ALL
		SELECT 'Barrett''s oesophagus' AS Ned_Name
				, NULL AS tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END AS [Site]
				, NULL AS Comment
				, B.DistanceM2 AS barrettsLengthCircumferential
				, B.DistanceM1 AS barrettsLengthMaximum
				, B.InspectionTimeMins AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
			 FROM [dbo].[ERS_Diagnoses] D
		LEFT JOIN [dbo].[ERS_Procedures]		AS P ON D.ProcedureID = P.ProcedureId
		LEFT JOIN dbo.ERS_Sites		AS S ON D.SiteId = S.SiteId
		LEFT JOIN ERS_Regions		AS R ON R.RegionId = S.RegionId
		left join dbo.ERS_UpperGIAbnoBarrett AS B on B.SiteId = S.SiteId 
			WHERE D.ProcedureId= @ProcedureId 
			  AND P.ProcedureType IN(1, 2, 6, 8)	--## Only for upper procedures
			  AND D.MatrixCode IN ('D23P1')  --## Barrett's oesophagus

		UNION ALL
		SELECT 'Gastric atrophy' AS Ned_Name
				, NULL AS tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END As [Site]	
				, NULL AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, datediff(minute, G.GastricInspectionStartDateTime, G.GastricInspectionEndDateTime) AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
			 FROM [dbo].[ERS_Diagnoses] D
		--LEFT JOIN [dbo].[ERS_DiagnosesMatrix]	AS M ON D.MatrixCode = M.Code
		LEFT JOIN [dbo].[ERS_Procedures]		AS P ON D.ProcedureID = P.ProcedureId
		LEFT JOIN dbo.ERS_Sites		AS S ON D.SiteId = S.SiteId
		LEFT JOIN ERS_Regions		AS R ON R.RegionId = S.RegionId
		left join dbo.ERS_UpperGIAbnoGastritis AS G on G.SiteId = S.SiteId 
			WHERE D.ProcedureId= @ProcedureId
			  AND P.ProcedureType IN(1, 2, 6, 8)	--## Only for upper procedures
			  AND D.MatrixCode IN ('N2006')

		UNION ALL
		SELECT top 1 M.NED_Name
				, NULL AS tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END As [Site]
				, NULL AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, CASE O.LAClassification 
					WHEN 1 THEN 'A'
					WHEN 2 THEN 'B'
					WHEN 3 THEN 'C'
					WHEN 4 THEN 'D'
				  END as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
			 FROM [dbo].[ERS_Diagnoses] D
		LEFT JOIN [dbo].[ERS_DiagnosesMatrix]	AS M ON D.MatrixCode = M.Code
		LEFT JOIN [dbo].[ERS_Procedures]		AS P ON D.ProcedureID = P.ProcedureId
		LEFT JOIN dbo.ERS_Sites		AS S ON D.SiteId = S.SiteId
		LEFT JOIN ERS_Regions		AS R ON R.RegionId = S.RegionId
		left join dbo.ERS_UpperGIAbnoOesophagitis AS O on O.SiteId = S.SiteId 
			WHERE D.ProcedureId= @ProcedureId
			  AND P.ProcedureType IN(1, 2, 6, 8)	--## Only for upper procedures
			  AND D.MatrixCode IN ('D36P1') --Oesophagitis - reflux

		UNION ALL	
		select DISTINCT --## DISTINCT REQUIRED- When in Stomach- 3 sites - all has Polyps and Gastric- then they will repeat.
				  'Other'
				, NULL	AS Tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END As [Site]		
				, eugm.MiscOther AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
		FROM ERS_diagnoses AS D
		INNER JOIN [dbo].[ERS_DiagnosesMatrix] AS M ON D.MatrixCode = M.Code
		INNER JOIN ERS_Sites S ON D.SiteId = S.SiteId
			INNER JOIN ERS_Regions R ON s.RegionId = R.RegionId
			INNER JOIN dbo.ERS_UpperGIAbnoMiscellaneous eugm ON S.SiteId = eugm.SiteId
		where D.ProcedureId= @ProcedureId 
			AND M.NED_Include = 1
			AND M.ProcedureTypeID = @ProcedureType
			AND M.DisplayName = 'Other'
		
		UNION ALL	-- dbo.fnNED_GetBiopsySiteName(P.ProcedureId, R.Region)
		select DISTINCT --## DISTINCT REQUIRED- When in Stomach- 3 sites - all has Polyps and Gastric- then they will repeat.
				  'Other'
				, NULL	AS Tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END As [Site]		
				, eugm.OtherDesc AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
		FROM ERS_diagnoses AS D
		INNER JOIN [dbo].[ERS_DiagnosesMatrix] AS M ON D.MatrixCode = M.Code
		INNER JOIN ERS_Sites S ON D.SiteId = S.SiteId
			INNER JOIN ERS_Regions R ON s.RegionId = R.RegionId
			INNER JOIN dbo.ERS_CommonAbnoDiverticulum eugm ON S.SiteId = eugm.SiteId
		where D.ProcedureId= @ProcedureId 
			AND M.NED_Include = 1
			AND M.ProcedureTypeID = @ProcedureType
			AND M.DisplayName = 'Other'
		UNION ALL
		select DISTINCT --## DISTINCT REQUIRED- When in Stomach- 3 sites - all has Polyps and Gastric- then they will repeat.
				  'Other'
				, NULL	AS Tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END As [Site]		
				, eugm.Other AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
		FROM ERS_diagnoses AS D
		INNER JOIN [dbo].[ERS_DiagnosesMatrix] AS M ON D.MatrixCode = M.Code
		INNER JOIN ERS_Sites S ON D.SiteId = S.SiteId
			INNER JOIN ERS_Regions R ON s.RegionId = R.RegionId
			INNER JOIN dbo.ERS_ERCPAbnoDiverticulum eugm ON S.SiteId = eugm.SiteId
		where D.ProcedureId= @ProcedureId 
			AND M.NED_Include = 1
			AND M.ProcedureTypeID = @ProcedureType
			AND M.DisplayName = 'Other'
		UNION ALL
		select DISTINCT --## DISTINCT REQUIRED- When in Stomach- 3 sites - all has Polyps and Gastric- then they will repeat.
				  'Other'
				, NULL	AS Tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE dbo.fnNED_GetBiopsySiteName(S.ProcedureId, R.Region) END As [Site]		
				, eugm.Other AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
		FROM ERS_diagnoses AS D
		INNER JOIN [dbo].[ERS_DiagnosesMatrix] AS M ON D.MatrixCode = M.Code
		INNER JOIN ERS_Sites S ON D.SiteId = S.SiteId
			INNER JOIN ERS_Regions R ON s.RegionId = R.RegionId
			INNER JOIN dbo.ERS_ColonAbnoMiscellaneous eugm ON S.SiteId = eugm.SiteId
		where D.ProcedureId= @ProcedureId 
			AND M.NED_Include = 1
			AND M.ProcedureTypeID = @ProcedureType
			AND M.DisplayName = 'Other'
		UNION ALL				
		select DISTINCT --## DISTINCT REQUIRED- When in Stomach- 3 sites - all has Polyps and Gastric- then they will repeat.
				  M.Ned_Name
				, NULL	AS Tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END As [Site]		
				, NULL	AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
		FROM ERS_diagnoses AS D
		INNER JOIN [dbo].[ERS_DiagnosesMatrix] AS M ON D.MatrixCode = M.Code
		INNER JOIN ERS_Sites S ON D.SiteId = S.SiteId
			INNER JOIN ERS_Regions R ON s.RegionId = R.RegionId
		where D.ProcedureId= @ProcedureId 
			AND M.Ned_Name IS NOT NULL --## I mean select the 'NED Mapped' fields ONLY!
			AND M.NED_Include = 1
			AND M.ProcedureTypeID = @ProcedureType
			AND D.MatrixCode NOT IN ('D70P3', 'S69P3', 'D69P3', 'D23P1', 'N2006', 'D36P1', 'D86P3', 'D96P3', 'S96P3', 'D1P3', 'N2015','S1P3','D1P3','P1P3','D1P9') -- don't include Colorectal cancer, barretts, Gastric atrophy, Oesophagitis, Diverticulosis - reflux or proctitus, they are already done 
			AND M.DisplayName <> 'Other'

		UNION ALL
			--## Combine 'OTHER' type of Diagnoses! Which Doesn't have a NED Name mapping!
			--start #3669 Raihan
			select 
			  'Other' AS DisplayName
			, NULL	AS Tattooed
			, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END As [Site]				
		
			, 
			(select 
				  (/*Section + ' ' +*/ M.DisplayName) + ', ' 
			FROM ERS_diagnoses AS D 
			LEFT JOIN [dbo].[ERS_DiagnosesMatrix] AS M ON D.MatrixCode = M.Code
			where D.ProcedureId= @ProcedureId
				AND M.Ned_Name IS NULL --## 'NED Mapped' is Missing
				--AND D.MatrixCode NOT IN ('D198P2', 'D265P2', 'D32P2', 'D33P2', 'D51P2', 'D67P2','D138P2') --## Diagnoses thinks these Exceptions belongs to others.. Because these are not Mapped to NED seperately
				AND D.MatrixCode not in ('N257P1', 'D70P3', 'D21P3', 'S21P3', 'D100P1','N2016', 'SN2016', 'N100P2') -- Could be NED field for Chrones, need to work that out, see next select
				AND M.NED_Include = 1
				AND D.SiteId = S.SiteId
				AND M.ProcedureTypeID = @ProcedureType
				FOR XML PATH('')
			) AS Comment		--## All the fields which are not in the 'NED Restricted Lookup' list!
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
		FROM ERS_diagnoses AS D
		INNER JOIN [dbo].[ERS_DiagnosesMatrix] AS M ON D.MatrixCode = M.Code --## InnerJoin- to avoid keeping anything which Codes (Summary, OverallNormal) don't exist in the Matrix Table.. WIll exclude them...
		INNER JOIN ERS_Sites S ON D.SiteId = S.SiteId
			INNER JOIN ERS_Regions R ON s.RegionId = R.RegionId
			where D.ProcedureId= @ProcedureId
			AND M.Ned_Name IS NULL --## Means when 'NED Mapped' is Missing- those belong to 'Other' type 
			AND D.MatrixCode not in ('N257P1', 'D21P3', 'S21P3', 'D100P1','N2016', 'SN2016', 'N100P2')
			AND M.NED_Include = 1
			AND M.ProcedureTypeID = @ProcedureType
		UNION ALL
			Select  'Crohn''s - terminal ileum'
				, NULL	AS Tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE dbo.fnNED_GetBiopsySiteName(S.ProcedureId, R.Region) END As [Site]		
				, NULL	AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, CASE WHEN dbo.fnNED_ProcedureExtent(@ProcedureId, 0) = 'Neo-terminal ileum' THEN rs.NEDTerm ELSE NULL END AS rutgeertsScore
				, CDEISScore AS CDEIS
			FROM ERS_ColonAbnoMucosa C
			join ERS_Sites S on S.SiteId = C.SiteId
			INNER JOIN ERS_Regions R ON S.RegionId = R.RegionId
			LEFT JOIN ERS_RutgeertsScores rs ON rs.UniqueId = C.RutgeertsScore
			where C.InflammatoryIleitis	 = 1 AND c.InflammatoryDisorder = 2
			AND S.ProcedureId = @ProcedureId 
		UNION ALL
			Select  'Crohn''s colitis'
				, NULL	AS Tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE dbo.fnNED_GetBiopsySiteName(S.ProcedureId, R.Region) END As [Site]		
				, NULL	AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, CASE WHEN dbo.fnNED_ProcedureExtent(@ProcedureId, 0) = 'Neo-terminal ileum' THEN rs.NEDTerm ELSE NULL END AS rutgeertsScore
				, CDEISScore AS CDEIS
			FROM ERS_ColonAbnoMucosa C
			join ERS_Sites S on S.SiteId = C.SiteId
			INNER JOIN ERS_Regions R ON S.RegionId = R.RegionId
			LEFT JOIN ERS_RutgeertsScores rs ON rs.UniqueId = C.RutgeertsScore
			where C.InflammatoryColitis = 1 AND c.InflammatoryDisorder = 2
			AND S.ProcedureId = @ProcedureId 

		UNION ALL
			Select  'Proctitis'
				, NULL	AS Tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END As [Site]		
				, NULL	AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
			FROM ERS_ColonAbnoMucosa C
			join ERS_Sites S on S.SiteId = C.SiteId
			INNER JOIN ERS_Regions R ON S.RegionId = R.RegionId
			where C.InflammatoryProctitis = 1
			AND S.ProcedureId = @ProcedureId 
	
	
		UNION ALL
			Select  'Colitis - unspecified'
				, NULL	AS Tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END As [Site]		
				, NULL	AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
			FROM ERS_ColonAbnoMucosa C
			join ERS_Sites S on S.SiteId = C.SiteId
			INNER JOIN ERS_Regions R ON S.RegionId = R.RegionId
			where C.InflammatoryDisorder = 1
			AND S.ProcedureId = @ProcedureId 

		UNION ALL
			Select 'Colitis - pseudomembranous'
				, NULL	AS Tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END As [Site]		
				, NULL	AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
			FROM ERS_ColonAbnoMucosa C
			join ERS_Sites S on S.SiteId = C.SiteId
			INNER JOIN ERS_Regions R ON S.RegionId = R.RegionId
			where C.InflammatoryDisorder = 10
			AND S.ProcedureId = @ProcedureId 

		UNION ALL
			Select  'Colitis - ischemic'
				, NULL	AS Tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END As [Site]		
				, NULL	AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
			FROM ERS_ColonAbnoMucosa C
			join ERS_Sites S on S.SiteId = C.SiteId
			INNER JOIN ERS_Regions R ON S.RegionId = R.RegionId
			where C.InflammatoryDisorder = 8
			AND S.ProcedureId = @ProcedureId 

		UNION ALL
			Select  'Diverticulosis'
				, NULL	AS Tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END As [Site]		
				, NULL	AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, isnull(ePoints.Points, 0) + isnull(GPoints.Points, 0) + isnull(IPoints.points, 0) + isnull(CPoints.Points, 0) AS DICAScore -- THIS IS NEEDED HERE
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
			FROM ERS_ColonAbnoMucosa C
			join ERS_Sites S on S.SiteId = C.SiteId
			INNER JOIN ERS_Regions R ON S.RegionId = R.RegionId
			JOIN ERS_ProcedureDICAScores D on S.SiteId = D.SiteId 
			INNER join ERS_DICAScores ePoints on D.ExtensionId = ePoints.UniqueId
			INNER join ERS_DICAScores GPoints on D.GradeId = gPoints.UniqueId
			left join ERS_DICAScores iPoints on D.InflammatorySignsId = iPoints.UniqueId
			left join ERS_DICAScores CPoints on D.ComplicationsId = cPoints.UniqueId
			where C.InflammatoryDisorder = 4
			AND S.ProcedureId = @ProcedureId 
		
		UNION ALL
			Select 'Diverticulosis'
				, NULL	AS Tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END As [Site]		
				, NULL	AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, isnull(ePoints.Points, 0) + isnull(GPoints.Points, 0) + isnull(IPoints.points, 0) + isnull(CPoints.Points, 0) AS DICAScore -- THIS IS NEEDED HERE
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
			FROM ERS_ColonAbnoDiverticulum C
			INNER join ERS_Sites S on S.SiteId = C.SiteId
			INNER JOIN ERS_Regions R ON S.RegionId = R.RegionId
			INNER JOIN ERS_ProcedureDICAScores D on S.SiteId = D.SiteId 
			INNER join ERS_DICAScores ePoints on D.ExtensionId = ePoints.UniqueId
			INNER join ERS_DICAScores GPoints on D.GradeId = gPoints.UniqueId
			LEFT join ERS_DICAScores iPoints on D.InflammatorySignsId = iPoints.UniqueId
			LEFT join ERS_DICAScores CPoints on D.ComplicationsId = cPoints.UniqueId
			WHERE S.ProcedureId = @ProcedureId 
		UNION ALL
			Select 'Ulcerative colitis'
				, NULL	AS Tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE isnull(R.NED_Term, 'Colon') END As [Site]		
				, NULL	AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, (Select sum(points) from ERS_UCEISScores where UniqueId in (VascularPatternUCEISScore, BleedingUCEISScore, ErosionsUCEISScore)) AS UCEIS
				, InflammatoryMayoScore AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
			FROM ERS_ColonAbnoMucosa C
			join ERS_Sites S on S.SiteId = C.SiteId
			Left JOIN ERS_Regions R ON s.RegionId = R.RegionId
			where C.InflammatoryDisorder = 12
			AND S.ProcedureId = @ProcedureId 
			--end #3669 Raihan
		

		UNION ALL--## Handles colotis diagnosis as the diagnoses matrix table is joined on ERS_Diagnoses 'value' column rather than the 'code' column
			SELECT 
			  ISNULL(NED_Name,'Colitis - unspecified') AS NED_Name
			, NULL	AS Tattooed
			, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END As [Site]		
			, NULL	AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
			FROM ERS_Diagnoses d
				INNER JOIN dbo.ERS_DiagnosesMatrix edm	ON code=value
			INNER JOIN ERS_Sites S ON S.SiteId = d.SiteId
			INNER JOIN ERS_Regions R ON S.RegionId = R.RegionId
			WHERE d.MatrixCode='ColitisType'  AND d.procedureid=@ProcedureId	
			AND edm.ProcedureTypeID = @ProcedureType

		UNION ALL
		SELECT DISTINCT --## DISTINCT REQUIRED- When in Stomach- 3 sites - all has Polyps and Gastric- then they will repeat.
					  M.Ned_Name
					, NULL AS tattooed	--## 'Colonic polyps or Rectal polyps' => Colon/FLexi ONLY! 
					, 'Colon' As [Site]		
					, NULL	AS Comment
					, NULL AS barrettsLengthCircumferential
					, NULL AS barrettsLengthMaximum
					, NULL AS barretsInspectionTime
					, NULL AS gastricInspectiontime
					, NULL as oesophagitisLaClassification
					, NULL AS DICAScore
					, NULL AS UCEIS
					, NULL AS mayoScore
					, NULL AS rutgeertsScore
					, NULL AS CDEIS
			FROM ERS_diagnoses AS D
			INNER JOIN [dbo].[ERS_DiagnosesMatrix] AS M ON D.MatrixCode = M.Code
			INNER JOIN ERS_Sites S ON D.SiteId = S.SiteId
			where D.ProcedureId= @ProcedureId 
				AND M.Ned_Name IS NOT NULL --## I mean select the 'NED Mapped' fields ONLY!
				AND M.NED_Include = 1
				AND M.ProcedureTypeID = @ProcedureType
				AND SiteNo = -77 --site by distance diagnoses
				and M.Ned_Name <> 'Ulcerative Colitis'
	
	END
	If (Select 1 from @Diagnoses where Ned_Name = 'Gastric atrophy') > 0
		Delete from @Diagnoses where Ned_Name = 'Gastritis - non-erosive'

	RETURN ;
END

/* columns returned
   ----------------
    Ned_Name
    Tattooed
    Comment
	barrettsLengthCircumferential	--Required for diagnosis of Barretts
	barrettsLengthMaximum			--Required for diagnosis of Barretts
	barretsInspectionTime			--Required for diagnosis of Barretts
	gastricInspectiontime			--Required if diagnosis of gastric atrophy OR gastric intestinal metaplasia
	oesophagitisLaClassification	--Required if diagnosis of Oesophagitis - reflux
	DICAScore						--required if diagnosis of Diverticulosis
	UCEIS							--If diagnosis is Ulcerative Colitis both UCEIS and Mayo scores must be provided
	mayoScore						--If diagnosis is Ulcerative Colitis both UCEIS and Mayo scores must be provided
	site							--If diagnosis is Crohns Colitis or Crohn`s- terminal ileum and [ExtentLookup]= Neo-terminal ileum
	rutgeertsScore					--If diagnosis is Crohns Colitis or Crohn`s- terminal ileum and [ExtentLookup]= Neo-terminal ileum
	CDEIS							--If diagnosis is Crohns Colitis or Crohn`s- terminal ileum
*/
Go
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	3669
------------------------------------------------------------------------------------------------------------------------


------------------------------------------------------------------------------------------------------------------------
-- Updated by	: Raihanul	
-- TFS#	3815
-- Description of change
-- Fetching data from [ERS_CommonAbnoPolypDetails] to show polyp info
------------------------------------------------------------------------------------------------------------------------
EXEC dbo.DropIfExist 
    @ObjectName = 'AuditProcedureDetails', 
    @ObjectTypePrefix = 'S' 
GO
CREATE Procedure [dbo].[AuditProcedureDetails] 
	@UserId int
AS
/*
--	Update History		:		10 Mar 2022 MH added filter to eliminate Cancelled/DNA procedures
						:		11 May 2022 SG added Health Service Number formatting
						:		16 Jun 2022 MH removed inner join with ERS_UpperGIIndications, used left outer instead TFS 2173
						:		29 Jun 2022	MH added additional Therapeutic carried out, Complications, Adverse Events columns
						:		01 MAY 2024 Add Refferer/Service Provider/Category TFS item 3981/4080
						:		01 MAY 2024 Add Procedure Satrt time and DOB in dd/mm/yyyy format  TFS item 3981/4082
						:       17/05/2024 Partha  Filter by Hospital TFS1811
						:       30/05/2024 Partha Add Procedure End Time TFS 3470/TFS 4042
						:		17/10/2024 Raihan #3815
*/
BEGIN
	DECLARE @FromDate as Date,
			@ToDate as Date,
			@TrustId as int,
			@HealthService as varchar(max),
			@OperatingHospitalList as varchar(100)

	Select	@FromDate = FromDate,
			@ToDate = ToDate,
			@TrustId = TrustId,
			@OperatingHospitalList=OperatingHospitalList
	FROM	ERS_ReportFilter
	where	UserID = @UserId
	
	SELECT @HealthService = CustomText FROM ERS_Custom_Text WHERE CustomTextId = 'CountryOfOriginHealthService'

Declare @tableVarTherapeutics Table(
ProcedureId Int Not null,
TherapeuticProcedures varchar(4000) null
)
Insert into @tableVarTherapeutics(ProcedureId,TherapeuticProcedures)
select S.ProcedureId,
TherapeuticProcedures = R.Region + ':' + Case When TP.[None] = '1' then 'None'
Else
	Case when Len(Ltrim(Rtrim(Case when TP.YAGLaser = '1' then 'YAG Laser, ' else '' end
	+
	Case When TP.ArgonBeamDiathermy = '1' then 'Argon beam diathermy, ' else '' end
	+
	Case When TP.BalloonDilation = '1' then 'Balloon dilation, ' else '' end
	+ 
	Case When TP.BotoxInjection = '1' then 'Botox injection, ' else '' end
	+
	Case When TP.EndoloopPlacement = '1' then 'Endoloop placement, ' else '' end
	+
	Case when TP.HeatProbe = '1' then 'Heater probe coagulation, ' else '' end
	+
	Case when TP.BicapElectro = '1' then 'Bicap electrocautery, ' else '' end
	+
	Case when TP.Diathermy = '1' then 'Diathermy, ' else '' end
	+
	Case when TP.HotBiopsy = '1' then 'Hot biopsy, ' else '' end
	+
	Case when TP.ForeignBody = '1' then 'Foreign body removal, ' else '' end
	+
	Case when TP.Injection = '1' then 'Injection therapy, ' else '' end
	+
	Case when TP.Polypectomy = '1' then 'Polypectomy, ' else '' end
	+
	Case when TP.GastrostomyInsertion = '1' then 'Gastrostomy insertion (PEG), ' else '' end
	+
	Case when TP.GastrostomyRemoval = '1' then 'Gastrostomy removal (PEG), ' else '' end
	+
	Case when TP.NGNJTubeInsertion = '1' then 'NG/NJ tube insertion, ' else '' end
	+
	Case when TP.VaricealSclerotherapy = '1' then 'Variceal sclerotherapy, ' else '' end
	+
	Case when TP.VaricealBanding = '1' then 'Variceal banding, ' else '' end
	+
	Case when TP.StentInsertion = '1' then 'Stent insertion, ' else '' end
	+
	Case when TP.StentRemoval = '1' then 'Stent removal, ' else '' end
	+
	Case when TP.Marking = '1' then 'Marking, ' else '' end
	+
	Case when TP.Clip = '1' then 'Clip, ' else '' end
	+
	Case when TP.EndoClot = '1' then 'Endo clot, ' else '' end
	))) > 1 then
	Left(Ltrim(Rtrim(Case when TP.YAGLaser = '1' then 'YAG Laser, ' else '' end
	+
	Case When TP.ArgonBeamDiathermy = '1' then 'Argon beam diathermy, ' else '' end
	+
	Case When TP.BalloonDilation = '1' then 'Balloon dilation, ' else '' end
	+ 
	Case When TP.BotoxInjection = '1' then 'Botox injection, ' else '' end
	+
	Case When TP.EndoloopPlacement = '1' then 'Endoloop placement, ' else '' end
	+
	Case when TP.HeatProbe = '1' then 'Heater probe coagulation, ' else '' end
	+
	Case when TP.BicapElectro = '1' then 'Bicap electrocautery, ' else '' end
	+
	Case when TP.Diathermy = '1' then 'Diathermy, ' else '' end
	+
	Case when TP.HotBiopsy = '1' then 'Hot biopsy, ' else '' end
	+
	Case when TP.ForeignBody = '1' then 'Foreign body removal, ' else '' end
	+
	Case when TP.Injection = '1' then 'Injection therapy, ' else '' end
	+
	Case when TP.Polypectomy = '1' then 'Polypectomy, ' else '' end
	+
	Case when TP.GastrostomyInsertion = '1' then 'Gastrostomy insertion (PEG), ' else '' end
	+
	Case when TP.GastrostomyRemoval = '1' then 'Gastrostomy removal (PEG), ' else '' end
	+
	Case when TP.NGNJTubeInsertion = '1' then 'NG/NJ tube insertion, ' else '' end
	+
	Case when TP.VaricealSclerotherapy = '1' then 'Variceal sclerotherapy, ' else '' end
	+
	Case when TP.VaricealBanding = '1' then 'Variceal banding, ' else '' end
	+
	Case when TP.StentInsertion = '1' then 'Stent insertion, ' else '' end
	+
	Case when TP.StentRemoval = '1' then 'Stent removal, ' else '' end
	+
	Case when TP.Marking = '1' then 'Marking, ' else '' end
	+
	Case when TP.Clip = '1' then 'Clip, ' else '' end
	+
	Case when TP.EndoClot = '1' then 'Endo clot, ' else '' end
	)),Len(Ltrim(Rtrim(Case when TP.YAGLaser = '1' then 'YAG Laser, ' else '' end
	+
	Case When TP.ArgonBeamDiathermy = '1' then 'Argon beam diathermy, ' else '' end
	+
	Case When TP.BalloonDilation = '1' then 'Balloon dilation, ' else '' end
	+ 
	Case When TP.BotoxInjection = '1' then 'Botox injection, ' else '' end
	+
	Case When TP.EndoloopPlacement = '1' then 'Endoloop placement, ' else '' end
	+
	Case when TP.HeatProbe = '1' then 'Heater probe coagulation, ' else '' end
	+
	Case when TP.BicapElectro = '1' then 'Bicap electrocautery, ' else '' end
	+
	Case when TP.Diathermy = '1' then 'Diathermy, ' else '' end
	+
	Case when TP.HotBiopsy = '1' then 'Hot biopsy, ' else '' end
	+
	Case when TP.ForeignBody = '1' then 'Foreign body removal, ' else '' end
	+
	Case when TP.Injection = '1' then 'Injection therapy, ' else '' end
	+
	Case when TP.Polypectomy = '1' then 'Polypectomy, ' else '' end
	+
	Case when TP.GastrostomyInsertion = '1' then 'Gastrostomy insertion (PEG), ' else '' end
	+
	Case when TP.GastrostomyRemoval = '1' then 'Gastrostomy removal (PEG), ' else '' end
	+
	Case when TP.NGNJTubeInsertion = '1' then 'NG/NJ tube insertion, ' else '' end
	+
	Case when TP.VaricealSclerotherapy = '1' then 'Variceal sclerotherapy, ' else '' end
	+
	Case when TP.VaricealBanding = '1' then 'Variceal banding, ' else '' end
	+
	Case when TP.StentInsertion = '1' then 'Stent insertion, ' else '' end
	+
	Case when TP.StentRemoval = '1' then 'Stent removal, ' else '' end
	+
	Case when TP.Marking = '1' then 'Marking, ' else '' end
	+
	Case when TP.Clip = '1' then 'Clip, ' else '' end
	+
	Case when TP.EndoClot = '1' then 'Endo clot, ' else '' end
	)))-1)
	else '' end
end
from
	ERS_UpperGITherapeutics TP
	inner join ERS_Sites S on TP.SiteId = S.SiteId
	Inner Join ERS_Regions R on S.RegionId = R.RegionId

Select p.ProcedureId 
		, pat.Forename1 as Forename
		, pat.Surname as Surname
		, dbo.fn_FormatHealthServiceNumber(pat.NHSNo, @HealthService) as 'NHS number'
		, pat.HospitalNumber as 'Case note number'
		, convert(varchar(14),pat.DateOfBirth,106) as DOB
		, oh.HospitalName as 'Operating hospital'
		, gt.Title as Sex
		, pat.Postcode as 'Patients postcode'
		, pt.ProcedureType as 'Procedure name'
		,case when p.providerTypeId =1 then dbo.fnGetProviderName(p.providerTypeId) else p.ProviderOther end as 'Provider'
		,case when p.ReferrerType =1 then dbo.fnGetRefferNameName(p.ReferrerType) else p.ReferrerTypeOther end as 'Referrer'
		,dbo.fnGetCategoryName(p.CategoryListId ) as 'Category'
		,ISNULL(p.StartDateTime, p.ModifiedOn)  as 'Procedure start time'
		,p.ENDDateTime  as 'Procedure End time'
		, case when thera.procedureId is null then 'Diagnostic' else 'Therapeutic' end as 'Therapeutic or diagnostic'
		, dbo.fnGetAgeAtDate(pat.DateOfBirth, p.CreatedOn) as 'Age at procedure'
		, case when p.PatientStatus = (Select ListItemNo from ERS_Lists where ListDescription = 'Patient Status' and ListItemText = 'Inpatient') then 1 else null end as 'In patient'
		, case when p.PatientStatus = (Select ListItemNo from ERS_Lists where ListDescription = 'Patient Status' and ListItemText = 'Outpatient') then 1 else null end as 'Out patient'
		, case when p.PatientStatus = (Select ListItemNo from ERS_Lists where ListDescription = 'Patient Status' and ListItemText = 'Day Patient') then 1 else null end as 'Day patient'
		, case when p.PatientType = (Select ListItemNo from ERS_Lists where ListDescription = 'Patient Type' and ListItemText = 'NHS') then 1 else null end as 'NHS'
		, case when p.PatientType = (Select ListItemNo from ERS_Lists where ListDescription = 'Patient Type' and ListItemText = 'Private') then 1 else null end as 'Private'
		, ListCons.Surname + ', ' + ListCons.Forename as 'List consultant'
		, Endo1.Surname + ', ' + Endo1.Forename as 'Endoscopist 1'
		, Endo2.Surname + ', ' + Endo2.Forename as 'Endoscopist 2'
		, pr.PP_Indic as Indications
		, ind.ASAStatus as 'ASA status'
		, case fu.EvidenceOfCancerIdentified when 1 then 'Yes' 
											 When 2 then 'No'
											 When 3 then 'Unknown'
											 else '' end as 'Evidence of cancer'
		, DrugList as Drugs
		, d.SessileExcised as 'Sessile ployps excised'
		, d.SessileToLabs as 'Sessile ployps sent to lab'
		, d.PedunculatedExcised as 'Pedunculated ployps excised'
		, d.PedunculatedToLabs as 'Pedunculated ployps sent to lab'
		, d.SubmucosalExcised as 'Submucosal ployps excised'
		, d.SubmucosalToLabs as 'Submucosal ployps sent to lab'
		, d.PseudopolypsExcised as 'Pseudo ployps excised'
		, d.PseudopolypsToLabs as 'Pseudo ployps sent to lab'
		, d.BiopsyQtyHistology as 'Bx to histology'
		, CASE WHEN ISNULL(CEOI.NED_TimeToCaecumMin, 0) = 0 
			THEN CASE WHEN ISNULL(CEOI.TimeToCaecumMin, 0) = 0 
				THEN CASE WHEN ISNULL(CEOI.TimeToCaecumMin_Photo, 0) = 0 
					THEN 0
					ELSE CEOI.TimeToCaecumMin_Photo + CASE WHEN ISNULL(CEOI.TimeToCaecumSec_Photo, 0) >= 30 THEN 1 ELSE 0 END
					END
				ELSE 	CEOI.TimeToCaecumMin + CASE WHEN ISNULL(CEOI.TimeToCaecumSec, 0) >= 30 THEN 1 ELSE 0 END
				END
			ELSE	CEOI.NED_TimeToCaecumMin + CASE WHEN ISNULL(CEOI.NED_TimeToCaecumSec, 0) >= 30 THEN 1 ELSE 0 END
		   END as 'Time to caecum (lower only)'		
		 , CASE WHEN ISNULL(CEOI.NED_TimeForWithdrawalMin, 0) = 0 
			THEN CASE WHEN ISNULL(CEOI.TimeForWithdrawalMin, 0) = 0 
				THEN CASE WHEN ISNULL(CEOI.TimeForWithdrawalMin_Photo, 0) = 0 
					THEN 0
					ELSE CEOI.TimeForWithdrawalMin_Photo + CASE WHEN ISNULL(CEOI.TimeForWithdrawalSec_Photo, 0) >= 30 THEN 1 ELSE 0 END
					END
				ELSE 	CEOI.TimeForWithdrawalMin + CASE WHEN ISNULL(CEOI.TimeForWithdrawalSec, 0) >= 30 THEN 1 ELSE 0 END
				END
			ELSE	CEOI.NED_TimeForWithdrawalMin + CASE WHEN ISNULL(CEOI.NED_TimeForWithdrawalSec, 0) >= 30 THEN 1 ELSE 0 END
		  END as 'Time for withdrawal (lower only)'
	    , qa.PatDiscomfortEndo as 'Endoscopists patient comfort score'
	    , qa.PatDiscomfortNurse as 'Nurse patient comfort score'
	    , qa.PatDiscomfortPatient as 'patients own comfort score'
		, case qa.PatSedation	when 0 then 'Not completed' 
								when 1 then 'Not recorded' 
								when 2 then 'Awake' 
								when 3 then 'Drowsy' 
								when 4 then 'Asleep but responding to name' 
								when 5 then 'Asleep but responding to touch' 
								when 6 then 'Asleep but unresponsive' 
								else 'Unknown' end as 'Patient sedation'
		, '"'+pr.pp_AdviceAndComments+'"'  as 'Advice and comments'
		, pr.PP_Followup as 'Follow up'
		, pr.PP_Diagnoses as Diagnoses
		,UPQA.AdverseEvents
		,UPQA.Complications
		,Therap.TherapeuticProcedures
from ERS_Procedures p (nolock)
join ERS_ReportConsultants rc (nolock) on p.Endoscopist1 = rc.ConsultantID 
join ERS_Patients pat (nolock) on p.PatientId = pat.PatientId 
join ERS_OperatingHospitals (nolock) oh on p.OperatingHospitalID = oh.OperatingHospitalId 
left outer join ERS_GenderTypes (nolock) gt on pat.GenderId = gt.GenderId 
join ERS_ProcedureTypes (nolock) pt on P.ProcedureType = pt.ProcedureTypeId 
left outer join (Select distinct s.ProcedureId 
			from ERS_Sites (nolock) s  
			left join ERS_UpperGITherapeutics (nolock) t on s.siteId = t.SiteId
			left join ERS_ERCPTherapeutics (nolock) ercpt on s.siteId = ercpt.SiteId
			where t.siteid is not null or ercpt.siteid is not null) thera on p.ProcedureId = thera.ProcedureId
join ERS_Users ListCons (nolock) on p.ListConsultant = ListCons.UserID
join ERS_Users Endo1 (nolock) on p.Endoscopist1 = Endo1.UserID
left outer join ERS_Users Endo2 (nolock) on p.Endoscopist2 = Endo2.UserID
join ERS_ProceduresReporting pr (nolock) on p.ProcedureId = pr.ProcedureId 
left outer join ERS_UpperGIIndications ind (nolock) on p.ProcedureId = ind.ProcedureId 
left outer join ERS_UpperGIFollowUp fu (nolock) on p.ProcedureId = fu.ProcedureId 
left outer join 
(
Select distinct d.ProcedureId, STUFF(( Select ', ' + drugconcat.DrugName + ' - ' + convert(varchar, drugconcat.Dose) + drugconcat.Units
                FROM ERS_UpperGIPremedication drugconcat
				where drugconcat.ProcedureId = d.ProcedureId
              FOR
                XML PATH('')
              ), 1, 1, '') AS DrugList
from ERS_UpperGIPremedication d) Drugs on Drugs.ProcedureId = p.ProcedureId
Left outer join (
-----TFS 3815 Start
			Select s.ProcedureId
					, SUM(CASE WHEN l.PolypTypeId = 1 THEN l.Excised ELSE 0 END) AS SessileExcised
					, SUM(CASE WHEN l.PolypTypeId = 1 THEN l.Successful ELSE 0 END) AS SessileToLabs
					, SUM(CASE WHEN l.PolypTypeId = 2 THEN l.Excised ELSE 0 END) AS PedunculatedExcised
					, SUM(CASE WHEN l.PolypTypeId = 2 THEN l.Successful ELSE 0 END) AS PedunculatedToLabs
					, SUM(CASE WHEN l.PolypTypeId = 4 THEN l.Excised ELSE 0 END) AS SubmucosalExcised
					, SUM(CASE WHEN l.PolypTypeId = 4 THEN l.Successful ELSE 0 END) AS SubmucosalToLabs
					, SUM(CASE WHEN l.PolypTypeId = 3 THEN l.Excised ELSE 0 END) AS PseudopolypsExcised
					, SUM(CASE WHEN l.PolypTypeId = 3 THEN l.Successful ELSE 0 END) AS PseudopolypsToLabs
					, ISNULL(max(convert(int, sp.BrushCytology)), 0) as BrushCytology
					, ISNULL(sum(sp.BiopsyQtyHistology), 0) as BiopsyQtyHistology
					, ISNULL(sum(sp.BiopsyQtyMicrobiology), 0) as BiopsyQtyMicrobiology
					, ISNULL(sum(sp.BiopsyQtyVirology), 0) as BiopsyQtyVirology
					, ISNULL(max(convert(int, sp.HotBiopsy)), 0) as HotBiopsy
				from ERS_Sites s  (nolock)
				left outer join [dbo].[ERS_CommonAbnoPolypDetails] l (nolock) on s.SiteId = l.SiteId 
				left outer join ERS_UpperGIAbnoPolyps ap (nolock) on s.SiteId = ap.SiteId
				left outer join ERS_UpperGISpecimens sp (nolock) on s.SiteId = sp.SiteId 
-----TFS 3815 End
				Group by s.ProcedureId	
				) d on p.ProcedureId = d.ProcedureId 
left outer join ERS_ColonExtentOfIntubation CEOI (nolock) on p.ProcedureId = CEOI.ProcedureId 
left outer join ERS_UpperGIQA (nolock) qa on p.ProcedureId = qa.ProcedureId 
Left outer Join (select 
ProcedureId, AdverseEvents = Case When AdverseEventsNone = '1' then 'None'
Else
	Case when Len(Ltrim(Rtrim(Case when ConsentSignedInRoom = '1' then 'Consent signed in room, ' else '' end
	+
	Case When UnplannedAdmission = '1' then 'Unplanned Admisison, ' else '' end
	+
	Case When O2Desaturation = '1' then 'O2 Desaturation, ' else '' end
	+ 
	Case When WithdrawalOfConsent = '1' then 'Withdrawal of consent, ' else '' end
	+
	Case When UnsupervisedTrainee = '1' then 'Unsupervised Trainee, ' else '' end
	+
	Case when Ventilation = '1' then 'Ventilation, ' else '' end
	))) > 1 then
	Left(Ltrim(Rtrim(Case when ConsentSignedInRoom = '1' then 'Consent signed in room, ' else '' end
	+
	Case When UnplannedAdmission = '1' then 'Unplanned Admisison, ' else '' end
	+
	Case When O2Desaturation = '1' then 'O2 Desaturation, ' else '' end
	+ 
	Case When WithdrawalOfConsent = '1' then 'Withdrawal of consent, ' else '' end
	+
	Case When UnsupervisedTrainee = '1' then 'Unsupervised Trainee, ' else '' end
	+
	Case when Ventilation = '1' then 'Ventilation, ' else '' end
	)),Len(Ltrim(Rtrim(Case when ConsentSignedInRoom = '1' then 'Consent signed in room, ' else '' end
	+
	Case When UnplannedAdmission = '1' then 'Unplanned Admisison, ' else '' end
	+
	Case When O2Desaturation = '1' then 'O2 Desaturation, ' else '' end
	+ 
	Case When WithdrawalOfConsent = '1' then 'Withdrawal of consent, ' else '' end
	+
	Case When UnsupervisedTrainee = '1' then 'Unsupervised Trainee, ' else '' end
	+
	Case when Ventilation = '1' then 'Ventilation, ' else '' end
	)))-1)
	else '' end
end
,
Complications = Case When ComplicationsNone = '1' then 'None'
Else
	Case when Len(Ltrim(Rtrim(Case when PoorlyTolerated = '1' then 'Poorly tolerated, ' else '' end
	+
	Case When PatientDiscomfort = '1' then 'Patient discomfort, ' else '' end
	+
	Case When PatientDistress = '1' then 'Patient distress, ' else '' end
	+ 
	Case When InjuryToMouth = '1' then 'Injury to mouth/teeth, ' else '' end
	+
	Case When DifficultIntubation = '1' then 'Difficult intubation, ' else '' end
	+
	Case when Death = '1' then 'Death, ' else '' end
	+
	Case when Perforation = '1' then 'Perforation : '+ IsNull(PerforationText,'') + ', ' else '' end
	+
	Case when DamageToScope = '1' then 'Damaged to scope, ' else '' end
	+
	Case when GastricContentsAspiration = '1' then 'Gastric contents aspiration, ' else '' end
	+
	Case when ShockHypotension = '1' then 'Shock/hypotension, ' else '' end
	+
	Case when Haemorrhage = '1' then 'Haemorrhage, ' else '' end
	+
	Case when SignificantHaemorrhage = '1' then 'Significant Haemorrhage, ' else '' end
	+
	Case when Hypoxia = '1' then 'Hypoxia, ' else '' end
	+
	Case when RespiratoryDepression = '1' then 'Respiratory depression, ' else '' end
	+
	Case when RespiratoryArrest = '1' then 'Respiratory arrest requiring immediate action, ' else '' end
	+
	Case when CardiacArrest = '1' then 'Cardiac arrest, ' else '' end
	+
	Case when CardiacArrythmia = '1' then 'Cardiac arrhythmia, ' else '' end
	+
	Case when Len(IsNull(ComplicationsOtherText,'')) > 1 then 'Other complications:' + ComplicationsOtherText else '' end
	+
	Case when Len(IsNull(TechnicalFailure,'')) > 1 then 'Technical failure:' + TechnicalFailure else '' end
	))) > 1 then
	Left(Ltrim(Rtrim(Case when PoorlyTolerated = '1' then 'Poorly tolerated, ' else '' end
	+
	Case When PatientDiscomfort = '1' then 'Patient discomfort, ' else '' end
	+
	Case When PatientDistress = '1' then 'Patient distress, ' else '' end
	+ 
	Case When InjuryToMouth = '1' then 'Injury to mouth/teeth, ' else '' end
	+
	Case When DifficultIntubation = '1' then 'Difficult intubation, ' else '' end
	+
	Case when Death = '1' then 'Death, ' else '' end
	+
	Case when Perforation = '1' then 'Perforation : '+ IsNull(PerforationText,'') + ', ' else '' end
	+
	Case when DamageToScope = '1' then 'Damaged to scope, ' else '' end
	+
	Case when GastricContentsAspiration = '1' then 'Gastric contents aspiration, ' else '' end
	+
	Case when ShockHypotension = '1' then 'Shock/hypotension, ' else '' end
	+
	Case when Haemorrhage = '1' then 'Haemorrhage, ' else '' end
	+
	Case when SignificantHaemorrhage = '1' then 'Significant Haemorrhage, ' else '' end
	+
	Case when Hypoxia = '1' then 'Hypoxia, ' else '' end
	+
	Case when RespiratoryDepression = '1' then 'Respiratory depression, ' else '' end
	+
	Case when RespiratoryArrest = '1' then 'Respiratory arrest requiring immediate action, ' else '' end
	+
	Case when CardiacArrest = '1' then 'Cardiac arrest, ' else '' end
	+
	Case when CardiacArrythmia = '1' then 'Cardiac arrhythmia, ' else '' end
	+
	Case when Len(IsNull(ComplicationsOtherText,'')) > 1 then 'Other complications:' + ComplicationsOtherText else '' end
	+
	Case when Len(IsNull(TechnicalFailure,'')) > 1 then 'Technical failure:' + TechnicalFailure else '' end
	)),Len(Ltrim(Rtrim(Case when PoorlyTolerated = '1' then 'Poorly tolerated, ' else '' end
	+
	Case When PatientDiscomfort = '1' then 'Patient discomfort, ' else '' end
	+
	Case When PatientDistress = '1' then 'Patient distress, ' else '' end
	+ 
	Case When InjuryToMouth = '1' then 'Injury to mouth/teeth, ' else '' end
	+
	Case When DifficultIntubation = '1' then 'Difficult intubation, ' else '' end
	+
	Case when Death = '1' then 'Death, ' else '' end
	+
	Case when Perforation = '1' then 'Perforation : '+ IsNull(PerforationText,'') + ', ' else '' end
	+
	Case when DamageToScope = '1' then 'Damaged to scope, ' else '' end
	+
	Case when GastricContentsAspiration = '1' then 'Gastric contents aspiration, ' else '' end
	+
	Case when ShockHypotension = '1' then 'Shock/hypotension, ' else '' end
	+
	Case when Haemorrhage = '1' then 'Haemorrhage, ' else '' end
	+
	Case when SignificantHaemorrhage = '1' then 'Significant Haemorrhage, ' else '' end
	+
	Case when Hypoxia = '1' then 'Hypoxia, ' else '' end
	+
	Case when RespiratoryDepression = '1' then 'Respiratory depression, ' else '' end
	+
	Case when RespiratoryArrest = '1' then 'Respiratory arrest requiring immediate action, ' else '' end
	+
	Case when CardiacArrest = '1' then 'Cardiac arrest, ' else '' end
	+
	Case when CardiacArrythmia = '1' then 'Cardiac arrhythmia, ' else '' end
	+
	Case when Len(IsNull(ComplicationsOtherText,'')) > 1 then 'Other complications:' + ComplicationsOtherText else '' end
	+
	Case when Len(IsNull(TechnicalFailure,'')) > 1 then 'Technical failure:' + TechnicalFailure else '' end
	)))-1)
	else '' end
end
from ERS_UpperGIQA) UPQA on UPQA.ProcedureId = P.ProcedureId
left outer join 
(
Select distinct d.ProcedureId, STUFF(( Select '; ' + therapconcat.TherapeuticProcedures
                FROM @tableVarTherapeutics therapconcat
				where therapconcat.ProcedureId = d.ProcedureId
              FOR
                XML PATH('')
              ), 1, 1, '') AS TherapeuticProcedures
from @tableVarTherapeutics d) Therap on Therap.ProcedureId = p.ProcedureId

where p.ProcedureCompleted = 1
	and p.IsActive = 1
	and p.CreatedOn >= @FromDate AND p.CreatedOn <= @ToDate
	and rc.UserID = @UserId
	AND P.OperatingHospitalID IN (SELECT * FROM dbo.splitString(@OperatingHospitalList,',') )--Partha , 17/05/2024 TFS1811
	--and pat.PatientId in (Select patientId from ERS_PatientTrusts where TrustId = @TrustId)
	--MH added on 10 Mar 2022
	and IsNull(p.DNA,0) = 0
order by pt.ProcedureType, p.CreatedOn 

end
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	3815
------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ahmed
-- TFS#	4311
-- Description of change
-- Procedure drugs section in system setting - add make does box 
------------------------------------------------------------------------------------------------------------------------
 IF NOT EXISTS (
        SELECT 1
        FROM INFORMATION_SCHEMA.COLUMNS
        WHERE TABLE_NAME = 'ERS_DrugList' AND
              COLUMN_NAME IN ('MaximumDose')
    )
    BEGIN
		
		ALTER TABLE ERS_DrugList
            ADD MaximumDose Real
    END
GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	4311
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ahmed Shoud
-- TFS#	4311
-- Description of change
-- Procedure drugs section in system setting - add make does box
------------------------------------------------------------------------------------------------------------------------
Go

EXEC DropIfExist 'get_drug','S';
GO
CREATE PROCEDURE [dbo].[get_drug]
(
	@DrugNo int
)
AS
BEGIN
	SELECT [DrugNo] as DrugNo,[DrugName] as DrugName,[DrugType],[IsReversingAgent] as Isreversingagent,[Units] as Units, [DefaultDose] as Defaultdose,[DoseIncrement] as Doseincrement,[DeliveryMethod] as Deliverymethod ,[UsedinColonSig] as UsedinColonSig, [UsedinERCP] as UsedinERCP ,[UsedinUpperGI] as UsedinUpperGI,[UsedinEUS_OGD] as UsedinEUSOGD,[UsedinEUS_HPB] as UsedinEUSHPB,  ISNULL(DoseNotApplicable,0) as DoseNotApplicable, ISNULL([UsedInBroncho], 0) as UsedInBroncho,  ISNULL([UsedInAntegrade], 0) as UsedInAntegrade,  ISNULL([UsedInRetrograde], 0) as UsedInRetrograde,  ISNULL([UsedInEBUS], 0) as UsedInEBUS,  ISNULL([UsedInFlexiCystoscopy], 0) as UsedInFlexiCystoscopy, [MaximumDose] as MaximumDose
	FROM   [ERS_DrugList] 
	WHERE [DrugNo] = @DrugNo
END

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	4311
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea
-- TFS#	3839
-- Description of change
-- NED Bowel prep score checks based on extent
------------------------------------------------------------------------------------------------------------------------
GO


SET QUOTED_IDENTIFIER ON
SET ANSI_NULLS ON
GO


ALTER PROCEDURE dbo.procedure_bowel_prep_completion_check
(
	@ProcedureId INT,
	@BowelPrepId INT = NULL,
	@LeftScore INT = NULL,
	@RightScore INT = NULL,
	@TransverseScore INT = NULL
)
AS	
BEGIN
	IF @BowelPrepId IS NULL 
	BEGIN
	    SELECT @LeftScore = LeftPrepScore, @RightScore = RightPrepScore, @TransverseScore = TransversePrepScore, @BowelPrepId = BowelPrepId FROM dbo.ERS_ProcedureBowelPrep WHERE ProcedureId = @ProcedureId
	END

	DECLARE @Summary VARCHAR(200) = 'Bowel prep'
    DECLARE @ProcedureTypeId INT = (SELECT ProcedureType FROM dbo.ERS_Procedures WHERE ProcedureId = @ProcedureId)
	DECLARE @ExtentId INT = (SELECT MAX(pe.ExtentId) FROM dbo.ERS_ProcedureLowerExtent pe WHERE pe.ProcedureId = @ProcedureId)
	DECLARE @FurthestExtent VARCHAR(200) = dbo.fnNED_ProcedureExtent(@ProcedureId,0)
	DECLARE @SplenicFlexureId INT
	DECLARE @HepaticFlexureId INT
	DECLARE @CaecumId INT
	DECLARE @TIleumId INT

	SELECT 
		@SplenicFlexureId = MAX(CASE WHEN NEDTerm = 'Splenic flexure' THEN UniqueId END),
		@HepaticFlexureId = MAX(CASE WHEN NEDTerm = 'Hepatic flexure' THEN UniqueId END), 
		@HepaticFlexureId = MAX(CASE WHEN NEDTerm = 'Transverse' THEN UniqueId END), 
		@CaecumId = MAX(CASE WHEN NEDTerm = 'Caecum' THEN UniqueId END), 
		@TIleumId = MAX(CASE WHEN NEDTerm = 'Terminal ileum' THEN UniqueId END) 
	FROM 
		dbo.ERS_Extent
	WHERE 
		NEDTerm IN ('Splenic flexure', 'Hepatic flexure', 'Caecum', 'Terminal ileum', 'Transverse');


	/*For colonoscopy and flexi sig, where the extent is anastamosis, ileo-colon anastamosis or neo-terminal ileum, segmental BBPS scores 
	or a total BBPS score is no longer mandated.*/
	IF EXISTS (SELECT 1 FROM dbo.ERS_ProcedureLowerExtent pe WHERE pe.ProcedureId = @ProcedureId AND (ISNULL(pe.LimitationId,0) > 0 or (pe.IntubationFailed =1 OR pe.Abandoned = 1) OR pe.ExtentId IN (
		SELECT e.UniqueId FROM dbo.ERS_Extent e WHERE e.NEDTerm IN ('Ileo-colon anastomosis','Neo-terminal ileum','Terminal ileum','Anastomosis'))))
			BEGIN
				EXEC UI_update_procedure_summary   @ProcedureId, 'Bowel Prep', @Summary, 1	
			END
	ELSE
	BEGIN
		IF (@BowelPrepId = (SELECT bp.UniqueId FROM dbo.ERS_BowelPrep bp WHERE bp.NEDTerm = 'No preparation'))
			EXEC UI_update_procedure_summary   @ProcedureId, 'Bowel Prep', @Summary, 1	
		ELSE IF @ProcedureTypeId = 3 AND @LeftScore > -1
			BEGIN
				IF @RightScore > -1 AND @TransverseScore > -1 --if all scores are presant
					BEGIN
						EXEC UI_update_procedure_summary   @ProcedureId, 'Bowel Prep', @Summary, 1	
					END
				ELSE IF  (@RightScore = -1 OR @TransverseScore = -1) AND @ExtentId NOT IN (@CaecumId,@TIleumId) --if right or transverse arent provided and extent is not Caecum or Terminal ileum
				BEGIN
					EXEC UI_update_procedure_summary   @ProcedureId, 'Bowel Prep', @Summary, 1	
				END
				ELSE --might already be a completed value in there so remove it
				BEGIN
					EXEC UI_update_procedure_summary   @ProcedureId, 'Bowel Prep', @Summary, 0	
				END
			END
		ELSE IF @ProcedureTypeId = 4 AND @LeftScore > -1 
		BEGIN
			/*Left is required*/
			IF(@FurthestExtent IN ('stoma','pouch', 'anus', 'rectum', 'sigmoid', 'descending', 'splenic flexure') AND @LeftScore IS NOT NULL)
			BEGIN
				EXEC UI_update_procedure_summary   @ProcedureId, 'Bowel Prep', @Summary, 1		    
			END
			ELSE
            BEGIN
                EXEC UI_update_procedure_summary   @ProcedureId, 'Bowel Prep', @Summary, 0	
            END

			/*Left and transverse is required*/
			IF(@FurthestExtent IN ('transverse', 'hepatic flexure') AND (@LeftScore IS NOT NULL AND @TransverseScore IS NOT NULL))
			BEGIN
				EXEC UI_update_procedure_summary   @ProcedureId, 'Bowel Prep', @Summary, 1		    
			END
			ELSE IF(@FurthestExtent IN ('transverse', 'hepatic flexure') AND (@LeftScore IS NULL OR @TransverseScore IS NULL))
            BEGIN
                EXEC UI_update_procedure_summary   @ProcedureId, 'Bowel Prep', @Summary, 0	
            END


			/*Left, transverse and right is required*/
			IF(@FurthestExtent IN ('ascending', 'caecum') AND (@LeftScore IS NOT NULL AND @TransverseScore IS NOT NULL AND @RightScore IS NOT NULL))
			BEGIN
				EXEC UI_update_procedure_summary   @ProcedureId, 'Bowel Prep', @Summary, 1		    
			END
			ELSE IF(@FurthestExtent IN ('ascending', 'caecum') AND (@LeftScore IS NULL OR @TransverseScore IS NULL OR @RightScore IS NULL))
            BEGIN
                EXEC UI_update_procedure_summary   @ProcedureId, 'Bowel Prep', @Summary, 0	
            END
		END
		ELSE
			EXEC UI_update_procedure_summary   @ProcedureId, 'Bowel Prep', @Summary, 0	
	END
END
GO


------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ahmed Shoud
-- TFS#	4440
-- Description of change
-- Anti-Coag Free Text Box
------------------------------------------------------------------------------------------------------------------------
GO

EXEC DropIfExist 'GetUserByUserName','S';

GO
CREATE PROCEDURE [dbo].[GetUserByUserName]
(
	@UserName VARCHAR(255),
	@OperatingHospitalId INT
)
AS
BEGIN
	DECLARE @RoleID VARCHAR(70)
	SELECT @RoleID=RoleId FROM ERS_Users eu 
	LEFT JOIN dbo.ERS_UserOperatingHospitals euoh ON eu.UserID = euoh.UserId AND euoh.OperatingHospitalId = @OperatingHospitalId
	WHERE eu.UserName = @UserName
	DECLARE @GlobalAdmin BIT = 0
	Select [item] INTO #tmpRole FROM dbo.fnSplitString(@RoleID,',') 
	Select @GlobalAdmin=ISNULL((select 1 from ers_roles r where r.RoleId in (SELECT [item] FROM #tmpRole) and r.RoleName = 'GlobalAdmin'), 0)
	DECLARE @isAdmin BIT = 0
	IF EXISTS (select 1 from ers_roles r where r.RoleId in (SELECT [item] FROM #tmpRole) and LOWER(r.RoleName) LIKE '%admin%') SET @isAdmin = 1
	Select TOP 1 *, @isAdmin AS IsAdmin FROM ERS_Users eu
	Left JOIN dbo.ERS_UserOperatingHospitals euoh ON eu.UserID = euoh.UserId WHERE eu.UserName = @UserName AND (euoh.OperatingHospitalId = @OperatingHospitalId OR @GlobalAdmin = 1)
END
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	4440
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Siddik
-- TFS#	4316
-- Description of change: Where NED term is used 
-------------------------------------------------------------------------------------------------------------------------

UPDATE ERS_AuditReports 
SET AuditReportDescription = 'National Data Set Export validation Failed Report'
WHERE AuditReportDescription = 'NED Export validation Failed Report'

GO

EXEC dbo.DropIfExist 
    @ObjectName = 'auditNEDFailedProcedures', 
    @ObjectTypePrefix = 'S' 
GO

CREATE Procedure [dbo].[auditNEDFailedProcedures]
	@UserId int
AS
/****** 24 Dec 2021		:		Mahfuz created for NED Validation JAG Audit report ******/
/****** 03 May 2024		:		Partha Kundu , Do not show  Error from ERS_errorlog TFS 2313 ******/
/****	17/05/2024      :        Partha  Filter by Hospital TFS1811 */
/*		Update History	:		*/
BEGIN


	DECLARE @FromDate as Date,
			@ToDate as Date,
			@TrustId as int,
			@HealthService as varchar(max),
			@OperatingHospitalList as varchar(100)

	Select	@FromDate = FromDate,
			@ToDate = ToDate,
			@TrustId = TrustId,
			@OperatingHospitalList=OperatingHospitalList
	FROM	ERS_ReportFilter
	where	UserID = @UserId
	
	SELECT @HealthService = CustomText FROM ERS_Custom_Text WHERE CustomTextId = 'CountryOfOriginHealthService'
	
	Declare @NedFailedProcedures Table 
	(
		AutoRowId int identity(1,1) not null,
		ProcedureID int not null,
		ApplicationError varchar(max) Null,
		[National Data Set Error] varchar(max) null
	);

	Select nl.ProcedureId,nl.ErrorDescription into #tempTableNEDError 
	from ERS_NEDI2FilesLog nl
		INNER JOIN ERS_NEDI2Status en ON nl.[Status] = en.id
		inner join ERS_Procedures p on nl.ProcedureID = p.ProcedureId
		inner join (
				Select ProcedureId,Max(LogID) as MaxLogID 
				from ERS_NEDI2FilesLog 
				Group by ProcedureID) mxl on nl.ProcedureID = mxl.ProcedureID and nl.LogId = mxl.MaxLogID
		Where en.IsError = 1
		--MH added on 10 Mar 2022
		and IsNull(p.DNA,0) = 0
		and p.ModifiedOn between @FromDate and @ToDate
		--17/05/2024     Partha  Filter by Hospital TFS1811
		AND p.OperatingHospitalID IN (SELECT * FROM dbo.splitString(@OperatingHospitalList,',') ) 
		
	--Select el.ProcedureId,el.ErrorMessage + '. ' + el.ErrorDescription as AppErrorMessage into #tempTableAppError from ERS_ErrorLog el
	--	inner join ERS_Procedures p on el.ProcedureID = p.ProcedureId
	--		inner join (
	--			Select ProcedureId,Max(ErrorLogId) as MaxLogID from ERS_ErrorLog Group by ProcedureID) mxl on el.ProcedureID = mxl.ProcedureID and el.ErrorLogId = mxl.MaxLogID
				
	--			Where p.ModifiedOn between  @FromDate and @ToDate
	--			--MH added on 10 Mar 2022
	--			and IsNull(p.DNA,0) = 0


	-- 1 : Currently NED failed and not sorted or exported
	Insert into @NedFailedProcedures(ProcedureID,ApplicationError, [National Data Set Error])
	Select p.ProcedureId
	    --,aep.AppErrorMessage
		,Null
		, nem.ErrorDescription
		from ers_procedures p
		inner join ers_procedureTypes pt on p.ProcedureType = pt.ProcedureTypeId
		left join #tempTableNEDError nem on p.ProcedureId = nem.ProcedureID
		--left join #tempTableAppError aep on p.ProcedureId = aep.ProcedureId
	Where pt.NedExportRequired = 1 
		and p.ProcedureCompleted = 1 
		and p.NEDEnabled = 1
		and IsNull(p.DNA,0) not in (1,2,3)
		and p.NEDExported <> 1
		--MH added on 10 Mar 2022
		and IsNull(p.DNA,0) = 0
		--17/05/2024     Partha  Filter by Hospital TFS1811
		AND p.OperatingHospitalID IN (SELECT * FROM dbo.splitString(@OperatingHospitalList,',') ) 


		-- 2 : Current NEDexported Successfully but once had NED error (had record in ERS_NEDI2FilesLog
	Insert into @NedFailedProcedures(ProcedureID, [National Data Set Error])
	Select p.ProcedureId, nem.ErrorDescription
		from ers_procedures p
		inner join ers_procedureTypes pt on p.ProcedureType = pt.ProcedureTypeId
		left join #tempTableNEDError nem on p.ProcedureId = nem.ProcedureID
	Where pt.NedExportRequired = 1 
		and p.ProcedureCompleted = 1 
		--and p.NEDEnabled = 1
		and IsNull(p.DNA,0) not in (1,2,3)
		and p.NEDExported = 1
		and (IsNull(nem.ErrorDescription,'') <> '')
		--MH added on 10 Mar 2022
		and IsNull(p.DNA,0) = 0
		--17/05/2024     Partha  Filter by Hospital TFS1811
		AND p.OperatingHospitalID IN (SELECT * FROM dbo.splitString(@OperatingHospitalList,',') )



	Select distinct
		oh.HospitalName, 
		pat.Surname + ', '+ pat.Forename1 as Patient, 
		pat.HospitalNumber as 'Case No.',
		dbo.fn_FormatHealthServiceNumber(pat.NHSNo, @HealthService) as 'NHS number',
		convert(varchar, p.ModifiedOn, 106) as ProcedureDate,
		format(p.ModifiedOn,'hh:mm tt') as ProcedureTime,
		pt.ProcedureType as 'Procedure',
		ltrim(rtrim(lc.Forename + ' ' + lc.Surname)) as ListConsultant,
		e1.Surname + ', '+ e1.Forename as 'Endoscopist 1',
		e2.Surname + ', '+ e2.Forename as 'Endoscopist 2',
		case when p.Endo2Role = 1 or p.Endoscopist2 is null then 'Independent' else '' END as Independant,
		NedFailReport.[National Data Set Error]
	from ers_procedures p
	inner join @NedFailedProcedures NedFailReport on p.ProcedureId = NedFailReport.ProcedureID
	join (select ListItemNo as PatientStatusId, ListItemText as PatientStatus from ERS_Lists where ListDescription = 'Patient Status') ps on p.PatientStatus = ps.PatientStatusId
	join ERS_Patients pat on p.PatientId = pat.PatientId
	join ERS_OperatingHospitals oh on p.OperatingHospitalID = oh.OperatingHospitalId
	join ERS_ProcedureTypes pt on p.ProcedureType = pt.ProcedureTypeId
	join ERS_Users e1 on p.Endoscopist1 = e1.UserID
	left join ERS_Users e2 on p.Endoscopist2 = e2.UserID
	left join ERS_Users lc on p.ListConsultant = lc.UserID
	join ERS_ReportConsultants rc on rc.ConsultantID = e1.UserID or rc.ConsultantID = e2.UserID
	where p.IsActive = 1 
		and p.ProcedureCompleted = 1
		and p.CreatedOn >= @FromDate AND p.CreatedOn <= @ToDate
		and rc.UserID = CASE WHEN @UserId = 1 THEN rc.UserId ELSE @UserId END
		--17/05/2024     Partha  Filter by Hospital TFS1811
		AND p.OperatingHospitalID IN (SELECT * FROM dbo.splitString(@OperatingHospitalList,',') )
		--and pat.PatientId in (Select patientId from ERS_PatientTrusts where TrustId = @TrustId)
		--MH added on 10 Mar 2022
		and IsNull(p.DNA,0) = 0
	--order by p.CreatedOn, pt.ProcedureType, e1.Surname
END

GO

------------------------------------------------------------------------------------------------------------------------
-- TFS#	4316 END
-------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ahmed Shoud
-- TFS#	4166
-- Description of change
-- Abnormalities Tree Save Function
------------------------------------------------------------------------------------------------------------------------

EXEC dbo.DropIfExist 
    @ObjectName = 'abnormalities_barrett_save', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[abnormalities_barrett_save]
(
       @SiteId INT,
       @None BIT,
       @BarrettIslands BIT,
       @Proximal INT,
       @Distal INT,
       @DistanceC1 INT,
       @DistanceC2 INT,
       @DistanceC3 INT,
       @DistanceM1 INT,
       @DistanceM2 INT,
	   @FocalLesion BIT,
	   @FocalLesionQty INT,
	   @FocalLesionLargest INT,
	   @FocalLesionTumourTypeId INT,
	   @FocalLesionProbably BIT,
	   @FocalLesionParisClassificationId INT,
	   @FocalLesionPitPatternId INT,
	   @InspectionTimeMins INT,
	   @SmokerRadioButtonListId INT, --add by mostafiz 2360
	   @LoggedInUserId INT
)
AS

SET NOCOUNT ON

DECLARE @proc_id INT
DECLARE @proc_type INT

BEGIN TRANSACTION

BEGIN TRY
       SELECT 
              @proc_id = p.ProcedureId,
              @proc_type = p.ProcedureType
       FROM 
              ERS_Sites s
       JOIN 
              ERS_Procedures p ON s.ProcedureId = p.ProcedureId
       WHERE 
              SiteId = @SiteId
                     
       
       IF (@None=0 AND @BarrettIslands=0  AND @Proximal =0 AND @Distal =0 AND @DistanceC1 ='' AND @DistanceC2  =''AND @DistanceC3  ='' AND @DistanceM1  IS NULL  AND @DistanceM2  IS NULL AND @FocalLesion IS NULL AND @InspectionTimeMins  IS NULL) -- 4166
       BEGIN
              DELETE FROM ERS_UpperGIAbnoBarrett 
              WHERE SiteId = @SiteId
			  
			  DELETE FROM ERS_RecordCount 
              WHERE SiteId = @SiteId
              AND Identifier = 'Barretts'
       END
	   
       ELSE
		   BEGIN		   
				IF NOT EXISTS (SELECT 1 FROM ERS_UpperGIAbnoBarrett WHERE SiteId = @SiteId)
			   BEGIN
					  INSERT INTO ERS_UpperGIAbnoBarrett
									 ([SiteId]
									,[None]
									,[BarrettIslands]
									,[Proximal]
									,[Distal]
									,[DistanceC1]
									,[DistanceC2]
									,[DistanceC3]
									,[DistanceM1]
									,[DistanceM2]
									,[FocalLesions]
									,[FocalLesionQty]
									,[FocalLesionLargest]
									,[FocalLesionTumourTypeId]
									,[FocalLesionProbably]
									,[FocalLesionParisClassificationId]
									,[FocalLesionPitPatternId]
									,[InspectionTimeMins]
									,[WhoCreatedId]
									,[WhenCreated]
									,[SmokerRadioButtonListId]								
									)
							VALUES (@SiteId ,
									@None ,
									@BarrettIslands ,
									@Proximal ,
									@Distal ,
									NULLIF(@DistanceC1,0) ,
									NULLIF(@DistanceC2,0) ,
									NULLIF(@DistanceC3,0) ,
									NULLIF(@DistanceM1,0) ,
									@DistanceM2 ,
									@FocalLesion ,
									NULLIF(@FocalLesionQty,0) ,
									NULLIF(@FocalLesionLargest,0) ,
									NULLIF(@FocalLesionTumourTypeId,0) ,
									@FocalLesionProbably ,
									@FocalLesionParisClassificationId ,
									@FocalLesionPitPatternId ,
									@InspectionTimeMins ,
									@LoggedInUserId ,
									GETDATE(),
									NULLIF(@SmokerRadioButtonListId,0)) --add by mostafiz 2360	
																
					  INSERT INTO ERS_RecordCount (
							 [ProcedureId],
							 [SiteId],
							 [Identifier],
							 [RecordCount]
					  )
					  VALUES (
							 @proc_id,
							 @SiteId,
							 'Barretts',
							 1)
			   END
		   Else
			   BEGIN
				  UPDATE 
						 ERS_UpperGIAbnoBarrett
				  SET 
						[None]=@None  ,
						[BarrettIslands]=@BarrettIslands ,
						[Proximal]=@Proximal ,
						[Distal]=@Distal ,
						[DistanceC1]=NULLIF(@DistanceC1,0),
						[DistanceC2]=NULLIF(@DistanceC2,0) ,
						[DistanceC3]=NULLIF(@DistanceC3,0) ,
						[DistanceM1]= NULLIF(@DistanceM1,0),
						[DistanceM2]=@DistanceM2 ,
						[FocalLesions] =@FocalLesion,
						[FocalLesionQty] = NULLIF(@FocalLesionQty,0),
						[FocalLesionLargest] = NULLIF(@FocalLesionLargest,0),
						[FocalLesionTumourTypeId] =NULLIF(@FocalLesionTumourTypeId,0),
						[FocalLesionProbably] =@FocalLesionProbably,
						[FocalLesionParisClassificationId] =@FocalLesionParisClassificationId,
						[FocalLesionPitPatternId] = @FocalLesionPitPatternId,
						[InspectionTimeMins] =@InspectionTimeMins,
						[WhoUpdatedId] = @LoggedInUserId,
						[WhenUpdated] = GETDATE(),
						[SmokerRadioButtonListId]=@SmokerRadioButtonListId --add by mostafiz 2360						
				  WHERE 
						 SiteId = @SiteId 
			   END
		  EXEC abnormalities_Barrett_summary_update @SiteId
		  EXEC diagnoses_control_save @SiteId, 'N2003', @FocalLesion  --Focal Lesions

       END

	    --ADDED BY MOSTAFIZ 2360
	  EXEC sites_summary_update @SiteId
	  declare @TF varchar(10)
	  Select @TF = CASE WHEN @None = 0 THEN 'True' ELSE 'False' END
	  EXEC diagnoses_control_save @SiteId, 'D23P1', @TF  --Barretts

	    --ADDED BY MOSTAFIZ 2360
END TRY

BEGIN CATCH
       DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

       IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;

GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	4166 Ended
------------------------------------------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rony
-- TFS#	4328
-- Description of change
-- cumulative dose for LIDOCAINE section in Bronch / EBUS
------------------------------------------------------------------------------------------------------------------------
 IF NOT EXISTS (
        SELECT 1
        FROM INFORMATION_SCHEMA.COLUMNS
        WHERE TABLE_NAME = 'ERS_BRT_BronchoDrugs' AND
              COLUMN_NAME IN ('LignocaineSprayPercentage')
    )
    BEGIN
		
		ALTER TABLE ERS_BRT_BronchoDrugs
            ADD 
             LignocaineSprayPercentage tinyint;
    END
GO
EXEC dbo.DropIfExist 
    @ObjectName = 'broncho_drugs_select', 
    @ObjectTypePrefix = 'S' 
GO
CREATE PROCEDURE [dbo].[broncho_drugs_select](
	@ProcedureId INT
)
AS

SET NOCOUNT ON

SELECT
	EffectOfSedation,
	LignocaineSpray,
	LignocaineSprayTotal,
	LignocaineGel,
	LignocaineViaScope1pc,
	LignocaineViaScope2pc,
	LignocaineViaScope4pc,
	LignocaineNebuliser2pc,
	LignocaineNebuliser4pc,
	LignocaineTranscricoid2pc,
	LignocaineTranscricoid4pc,
	LignocaineBronchial1pc,
	LignocaineBronchial2pc,
	SupplyOxygen,
	SupplyOxygenPercentage,
	Nasal,
	SpO2Base,
	SpO2Min,
	SUM(ISNULL(LignocaineViaScope1pc,0) + ISNULL(LignocaineViaScope2pc,0) + ISNULL(LignocaineViaScope4pc,0) + ISNULL(LignocaineNebuliser2pc,0) + ISNULL(LignocaineNebuliser4pc,0) + ISNULL(LignocaineTranscricoid2pc,0) + ISNULL(LignocaineTranscricoid4pc,0) + ISNULL(LignocaineBronchial1pc,0) + ISNULL(LignocaineBronchial2pc,0)) AS TotalLignocaine, --Added by rony tfs-4328
	LignocaineSprayPercentage
FROM
	ERS_BRT_BronchoDrugs
WHERE 
	ProcedureId = @ProcedureId
--Added by rony tfs-4328
GROUP BY EffectOfSedation,LignocaineSpray,LignocaineSprayTotal,LignocaineGel,LignocaineViaScope1pc,LignocaineViaScope2pc,LignocaineViaScope4pc,LignocaineNebuliser2pc,LignocaineNebuliser4pc,
LignocaineTranscricoid2pc,LignocaineTranscricoid4pc,LignocaineBronchial1pc,LignocaineBronchial2pc,SupplyOxygen,SupplyOxygenPercentage,Nasal,SpO2Base,SpO2Min,LignocaineSprayPercentage

GO
EXEC dbo.DropIfExist 
    @ObjectName = 'broncho_drugs_save', 
    @ObjectTypePrefix = 'S' 
GO
CREATE PROCEDURE [dbo].[broncho_drugs_save]
(
	@ProcedureId INT,
	@EffectOfSedation INT = NULL,
	@LignocaineSpray BIT,
	@LignocaineSprayTotal DECIMAL(8,2),
	@LignocaineGel BIT,
	@LignocaineViaScope1pc DECIMAL(8,2),
	@LignocaineViaScope2pc DECIMAL(8,2),
	@LignocaineViaScope4pc DECIMAL(8,2),
	@LignocaineNebuliser2pc DECIMAL(8,2),
	@LignocaineNebuliser4pc DECIMAL(8,2),
	@LignocaineTranscricoid2pc DECIMAL(8,2),
	@LignocaineTranscricoid4pc DECIMAL(8,2),
	@LignocaineBronchial1pc DECIMAL(8,2),
	@LignocaineBronchial2pc DECIMAL(8,2),
	@SupplyOxygen BIT,
	@SupplyOxygenPercentage DECIMAL(8,2),
	@Nasal DECIMAL(8,2),
	@SpO2Base DECIMAL(8,2),
	@SpO2Min DECIMAL(8,2),
	@LoggedInUserId INT,
	@LignocaineSprayPercentage INT = NULL --Added by rony tfs-4328

)
AS

SET NOCOUNT ON

BEGIN TRANSACTION

BEGIN TRY
			
	IF NOT EXISTS (SELECT 1 FROM ERS_BRT_BronchoDrugs WHERE ProcedureId = @ProcedureId)
	BEGIN
		INSERT INTO ERS_BRT_BronchoDrugs (
			ProcedureId,
			EffectOfSedation,
			LignocaineSpray,
			LignocaineSprayTotal,
			LignocaineGel,
			LignocaineViaScope1pc,
			LignocaineViaScope2pc,
			LignocaineViaScope4pc,
			LignocaineNebuliser2pc,
			LignocaineNebuliser4pc,
			LignocaineTranscricoid2pc,
			LignocaineTranscricoid4pc,
			LignocaineBronchial1pc,
			LignocaineBronchial2pc,
			SupplyOxygen,
			SupplyOxygenPercentage,
			Nasal,
			SpO2Base,
			SpO2Min,
			WhoCreatedId,
			WhenCreated,
			LignocaineSprayPercentage) 
		VALUES (
			@ProcedureId,
			@EffectOfSedation,
			@LignocaineSpray,
			@LignocaineSprayTotal,
			@LignocaineGel,
			@LignocaineViaScope1pc,
			@LignocaineViaScope2pc,
			@LignocaineViaScope4pc,
			@LignocaineNebuliser2pc,
			@LignocaineNebuliser4pc,
			@LignocaineTranscricoid2pc,
			@LignocaineTranscricoid4pc,
			@LignocaineBronchial1pc,
			@LignocaineBronchial2pc,
			@SupplyOxygen,
			@SupplyOxygenPercentage,
			@Nasal,
			@SpO2Base,
			@SpO2Min,
			@LoggedInUserId,
			GETDATE(),
			@LignocaineSprayPercentage)

		INSERT INTO ERS_RecordCount (
			[ProcedureId],
			[SiteId],
			[Identifier],
			[RecordCount]
		)
		VALUES (
			@ProcedureId,
			NULL,
			'Drugs',
			1)
	END
	
	ELSE
	BEGIN
		UPDATE 
			ERS_BRT_BronchoDrugs
		SET 
			EffectOfSedation = @EffectOfSedation,
			LignocaineSpray = @LignocaineSpray,
			LignocaineSprayTotal = @LignocaineSprayTotal,
			LignocaineGel = @LignocaineGel,
			LignocaineViaScope1pc = @LignocaineViaScope1pc,
			LignocaineViaScope2pc = @LignocaineViaScope2pc,
			LignocaineViaScope4pc = @LignocaineViaScope4pc,
			LignocaineNebuliser2pc = @LignocaineNebuliser2pc,
			LignocaineNebuliser4pc = @LignocaineNebuliser4pc,
			LignocaineTranscricoid2pc = @LignocaineTranscricoid2pc,
			LignocaineTranscricoid4pc = @LignocaineTranscricoid4pc,
			LignocaineBronchial1pc = @LignocaineBronchial1pc,
			LignocaineBronchial2pc = @LignocaineBronchial2pc,
			SupplyOxygen = @SupplyOxygen,
			SupplyOxygenPercentage = @SupplyOxygenPercentage,
			Nasal = @Nasal,
			SpO2Base = @SpO2Base,
			SpO2Min = @SpO2Min,
			WhoUpdatedId = @LoggedInUserId,
			WhenUpdated = GETDATE(),
			LignocaineSprayPercentage = @LignocaineSprayPercentage
		WHERE 
			ProcedureId = @ProcedureId
	END
END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;

GO
EXEC dbo.DropIfExist 
    @ObjectName = 'broncho_drugs_summary_update', 
    @ObjectTypePrefix = 'S' 
GO
CREATE PROCEDURE [dbo].[broncho_drugs_summary_update]
(
	@ProcedureId INT
)
AS
	SET NOCOUNT ON

	--FLOAT removes trailing zeroes
	DECLARE
		@summary VARCHAR(4000),
		@EffectOfSedation INT,
		@LignocaineSpray BIT,
		@LignocaineGel BIT,
		@LignocaineSprayTotal Float,
		@LignocaineViaScope1pc FLOAT,
		@LignocaineViaScope2pc FLOAT,
		@LignocaineViaScope4pc FLOAT,
		@LignocaineNebuliser2pc FLOAT,
		@LignocaineNebuliser4pc FLOAT,
		@LignocaineTranscricoid2pc FLOAT,
		@LignocaineTranscricoid4pc FLOAT,
		@LignocaineBronchial1pc FLOAT,
		@LignocaineBronchial2pc FLOAT,
		@SupplyOxygen BIT,
		@SupplyOxygenPercentage FLOAT,
		@Nasal FLOAT,
		@SpO2Base FLOAT,
		@SpO2Min FLOAT,
		@TotalLignocaine FLOAT, --Added by rony tfs-4328
		@LignocaineSprayPercentage TINYINT

	DECLARE @tempsummary VARCHAR(1320) = ''
	DECLARE @summaryitems TABLE (summary VARCHAR (300))
	declare @newsummary VARCHAR(1320) = ''
	SET @Summary  =  ''
	SET @tempsummary = ''

	SELECT
		@EffectOfSedation = EffectOfSedation,
		@LignocaineSpray = LignocaineSpray,
		@LignocaineGel = LignocaineGel,
		@LignocaineSprayTotal = LignocaineSprayTotal,
		@LignocaineViaScope1pc = LignocaineViaScope1pc,
		@LignocaineViaScope2pc = LignocaineViaScope2pc,
		@LignocaineViaScope4pc = LignocaineViaScope4pc,
		@LignocaineNebuliser2pc = LignocaineNebuliser2pc,
		@LignocaineNebuliser4pc = LignocaineNebuliser4pc,
		@LignocaineTranscricoid2pc = LignocaineTranscricoid2pc,
		@LignocaineTranscricoid4pc = LignocaineTranscricoid4pc,
		@LignocaineBronchial1pc = LignocaineBronchial1pc,
		@LignocaineBronchial2pc = LignocaineBronchial2pc,
		@SupplyOxygen = SupplyOxygen,
		@SupplyOxygenPercentage = SupplyOxygenPercentage,
		@Nasal = Nasal,
		@SpO2Base = SpO2Base,
		@SpO2Min = SpO2Min,
		@TotalLignocaine = SUM(ISNULL(LignocaineViaScope1pc,0) + ISNULL(LignocaineViaScope2pc,0) + ISNULL(LignocaineViaScope4pc,0) + ISNULL(LignocaineNebuliser2pc,0) + ISNULL(LignocaineNebuliser4pc,0) + ISNULL(LignocaineTranscricoid2pc,0) + ISNULL(LignocaineTranscricoid4pc,0) + ISNULL(LignocaineBronchial1pc,0) + ISNULL(LignocaineBronchial2pc,0)),
		@LignocaineSprayPercentage = LignocaineSprayPercentage
		
	FROM 
		ERS_BRT_BronchoDrugs
	WHERE
		ProcedureId = @ProcedureId
	--Added by rony tfs-4328
	GROUP BY EffectOfSedation,LignocaineSpray,LignocaineSprayTotal,LignocaineGel,LignocaineViaScope1pc,LignocaineViaScope2pc,LignocaineViaScope4pc,LignocaineNebuliser2pc,LignocaineNebuliser4pc,
    LignocaineTranscricoid2pc,LignocaineTranscricoid4pc,LignocaineBronchial1pc,LignocaineBronchial2pc,SupplyOxygen,SupplyOxygenPercentage,Nasal,SpO2Base,SpO2Min,LignocaineSprayPercentage

	IF @LignocaineSpray = 1 
		INSERT INTO @summaryitems 
		--VALUES ('Lido\Lignocaine ' + CONVERT(VARCHAR, isnull(@LignocaineSprayTotal,0)) + case when @LignocaineSprayTotal > 1 then ' spray(s) was used ' else ' spray was used' end) --TFS # 3210
		VALUES ('Lido\Lignocaine ' + CONVERT(VARCHAR, isnull(@LignocaineSprayTotal,0)) + ' Sprays was used ' +  CONVERT(VARCHAR, isnull(@LignocaineSprayPercentage,0)) + CASE WHEN @LignocaineSprayPercentage > 0 then '%' else '' end) --Added by rony tfs-4328

	IF @LignocaineGel = 1
		INSERT INTO @summaryitems 
		VALUES ('Lido\Lignocaine gel was used')

	IF @LignocaineNebuliser2pc > 0
	BEGIN
		INSERT INTO @summaryitems 
		VALUES ('Lido\Lignocaine 2% by nebuliser ' + CONVERT(VARCHAR, @LignocaineNebuliser2pc) + ' mls')
	END

	IF @LignocaineNebuliser4pc > 0
	BEGIN
		INSERT INTO @summaryitems 
		VALUES ('Lido\Lignocaine 4% by nebuliser ' + CONVERT(VARCHAR, @LignocaineNebuliser4pc) + ' mls')
	END

	IF @LignocaineViaScope1pc > 0
	BEGIN
		INSERT INTO @summaryitems 
		VALUES ('Lido\Lignocaine 1% to larynx via scope ' + CONVERT(VARCHAR, @LignocaineViaScope1pc) + ' mls')
	END

	IF @LignocaineViaScope2pc > 0
	BEGIN
		INSERT INTO @summaryitems 
		VALUES ('Lido\Lignocaine 2% to larynx via scope ' + CONVERT(VARCHAR, @LignocaineViaScope2pc) + ' mls')
	END

	IF @LignocaineViaScope4pc > 0
	BEGIN
		INSERT INTO @summaryitems 
		VALUES ('Lido\Lignocaine 4% to larynx via scope ' + CONVERT(VARCHAR, @LignocaineViaScope4pc) + ' mls')
	END

	IF @LignocaineTranscricoid2pc > 0
	BEGIN
		INSERT INTO @summaryitems 
		VALUES ('Lido\Lignocaine 2% given transcricoid ' + CONVERT(VARCHAR, @LignocaineTranscricoid2pc) + ' mls')
	END

	IF @LignocaineTranscricoid4pc > 0
	BEGIN
		INSERT INTO @summaryitems 
		VALUES ('Lido\Lignocaine 4% given transcricoid ' + CONVERT(VARCHAR, @LignocaineTranscricoid4pc) + ' mls')
	END

	IF @LignocaineBronchial1pc > 0
	BEGIN
		INSERT INTO @summaryitems 
		VALUES ('Lido\Lignocaine 1% to bronchial tree ' + CONVERT(VARCHAR, @LignocaineBronchial1pc) + ' mls')
	END

	IF @LignocaineBronchial2pc > 0
	BEGIN
		INSERT INTO @summaryitems 
		VALUES ('Lido\Lignocaine 2% to bronchial tree ' + CONVERT(VARCHAR, @LignocaineBronchial2pc) + ' mls')
	END
	--Added by rony tfs-4328
	IF @TotalLignocaine > 0
	BEGIN
	INSERT INTO @summaryitems 
		VALUES ('Lido\Lignocaine Total ' + CONVERT(VARCHAR, @TotalLignocaine) + ' mls')
	END

		--TFS-4100--START
	IF EXISTS (SELECT 1 FROM @summaryitems)
	BEGIN
			set @newsummary = 'Local anaesthesia - Lidocaine / Lignocaine'
			SELECT @newsummary = @newsummary + '<br />' + summary
			FROM @summaryitems;
			DELETE FROM @summaryitems;
	END
		--TFS-4100--END

	IF @SupplyOxygen = 1
	BEGIN
		IF @SupplyOxygenPercentage > 0
		INSERT INTO @summaryitems 
		VALUES ('Supply oxygen mask ' + CONVERT(VARCHAR, @SupplyOxygenPercentage) + '%')
	END

	IF @Nasal > 0
	BEGIN
		INSERT INTO @summaryitems 
		VALUES ('Nasal cannulae ' + CONVERT(VARCHAR, @Nasal) + ' L min-1')
	END

	IF @SpO2Base > 0
	BEGIN
		INSERT INTO @summaryitems 
		VALUES ('Saturation (SPO2) Pre-procedure baseline ' + CONVERT(VARCHAR, @SpO2Base) + ' %')
	END

	IF @SpO2Min > 0
	BEGIN
		INSERT INTO @summaryitems 
		VALUES ('Saturation (SPO2) Minimum during procedure ' + CONVERT(VARCHAR, @SpO2Min) + ' %')
	END

		--TFS-4100--START
	IF EXISTS (SELECT 1 FROM @summaryitems)
	BEGIN
			set @tempsummary = 'Oxygen'
			SELECT @tempsummary = @tempsummary + '<br />' + summary
			FROM @summaryitems
			DELETE FROM @summaryitems;
	END
		--TFS-4100--END

	UPDATE ERS_BRT_BronchoDrugs
	SET Summary = @newsummary + '<br />' + @tempsummary
	WHERE ProcedureId = @ProcedureId
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	4328
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	MOSTAFIZUR RAHMAN
-- TFS#	4421
-- Description of change
-- Two types of Polyps not showing their diameter length in the report
------------------------------------------------------------------------------------------------------------------------
GO
EXEC dbo.DropIfExist 
    @ObjectName = 'common_polpydetails_summary', 
    @ObjectTypePrefix = 'F' 
GO

CREATE FUNCTION [dbo].[common_polpydetails_summary]
(
	@SiteId int,
	@PolypDetailId int = NULL
)
RETURNS VARCHAR(max)
AS
BEGIN
	DECLARE 
	@PolypType varchar(100),
	@TumourType varchar(100),
	@PolypCondition varchar(100), 
	@Tattooed varchar(100),
	@TattooMarkingType varchar(100),
	--@PolypDetailId int,
	@Quantity int,
	@summary varchar(max) = '',
	@Probably bit,
	@TumourTypeId int,
	@Size int,
	@ParisClass int,
	@PitPattern int,
	@Excised int,
	@Retrieved int,
	@ToLabs int,
	@Removal int,
	@RemovalType varchar(10) = '',
	@RemovalMethod int,
	@RemovalBy varchar(500) = '',
	@Inflam bit,
	@PostInflam bit,
	@TattooedId int,
	@TattooMarkingTypeId int,
	@Count int,
	@Submucosal BIT,
	@SubmucosalQuantity INT,
	@SubmucosalLargest INT,
	@SubmucosalProbably BIT,
	@SubmucosalTypeId TINYINT,
	@Focal BIT,
	@FocalQuantity INT,
	@FocalLargest INT,
	@FocalProbably BIT,
	@FocalTypeId TINYINT,
	@FundicGlandPolyp BIT,
	@FundicGlandPolypQuantity INT,
	@FundicGlandPolypLargest Numeric(18,2)
	
	--saves calling the table multiple times :)
	DECLARE @TumourTypes TABLE (TypeId int, [Description] varchar(100))
	INSERT INTO @TumourTypes
	SELECT UniqueId, [Description] 
	FROM ERS_TumourTypes 
	WHERE Suppressed = 0

	SELECT 
	@Submucosal =iif(b.description='Submucosal',1,0),
	@SubmucosalTypeId = a.type,
	@SubmucosalLargest = a.SubmucosalLargest,
	@SubmucosalProbably = a.Probably,
	@SubmucosalQuantity = a.SubmucosalQuantity,
	@Focal = iif(b.description='Focal lesions',1,0),
	@FocalTypeId = a.type,
	@FocalLargest = a.FocalLargest,
	@FocalProbably = a.Probably,
	@FocalQuantity = a.FocalQuantity,
	@FundicGlandPolyp = iif(b.description='Fundic Gland Polyp',1,0),
	@FundicGlandPolypQuantity = FundicGlandPolypQuantity,
	@FundicGlandPolypLargest = FundicGlandPolypLargest
FROM
	ERS_CommonAbnoPolypDetails a left join ERS_PolypTypes b on a.PolypTypeId=b.uniqueid
WHERE
	SiteId = @SiteId and PolypDetailId = ISNULL(@PolypDetailId, PolypDetailId)


	SELECT @Quantity = count(*)
	FROM ERS_CommonAbnoPolypDetails WHERE SiteId = @SiteId AND PolypDetailId = ISNULL(@PolypDetailId, PolypDetailId)

	SELECT @PolypType = LOWER([Description])
	FROM ERS_PolypTypes pt
		INNER JOIN ERS_CommonAbnoPolypDetails l ON pt.UniqueId = l.PolypTypeId
	WHERE SiteId = @SiteId


	DECLARE cur CURSOR FOR
	SELECT ecapd.PolypDetailId, ecapd.Size, ecapd.Excised, ecapd.Retreived, ecapd.Successful, ecapd.Removal, ecapd.RemovalMethod, ecapd.Probably, ecapd.Type, ecapd.ParisClass, ecapd.PitPattern, 
		ecapd.Infammatory, ecapd.PostInflammatory, ecapd.TattooedId, ecapd.TattooedMarkingTypeId
	FROM dbo.ERS_CommonAbnoPolypDetails ecapd
	WHERE SiteId = @SiteId AND PolypDetailId = ISNULL(@PolypDetailId, PolypDetailId)

	SET @summary = CASE WHEN @PolypDetailId IS NULL THEN CONVERT(VARCHAR(10), @Quantity) + ' ' + @PolypType + CASE WHEN @Quantity = 1 THEN ' polyp' ELSE ' polyps' END ELSE '' END



	------------------------------------------------------------------------------------------
	-------	SUBMUCOSAL LESION -------
	------------------------------------------------------------------------------------------
	IF @Submucosal > 0
	BEGIN
		IF @summary <> '' SET @summary = @summary + '##'

		IF @SubmucosalQuantity > 1 SET @summary = @summary + CONVERT(VARCHAR(20), @SubmucosalQuantity) + ' '
		ELSE SET @summary = @summary + 'A '
		
		IF @SubmucosalProbably = 1 SET @summary = @summary + 'probably '

		SELECT @summary = @summary + LOWER([Description]) + ' ' FROM @TumourTypes WHERE TypeId = @SubmucosalTypeId

		IF @SubmucosalQuantity > 1 SET @summary = @summary + 'submucosal lesions ' ELSE SET @summary = @summary + 'submucosal lesion ' 

		IF (@SubmucosalQuantity > 0 AND @SubmucosalLargest > 0) 
		BEGIN
			IF @SubmucosalQuantity > 1
				SET @summary = @summary + '(largest ' + CONVERT(VARCHAR(20), @SubmucosalLargest) + 'mm) '
			ELSE
				SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @SubmucosalLargest) + 'mm) '
		END
	END

	------------------------------------------------------------------------------------------
	-------	FOCAL LESIONS -------
	------------------------------------------------------------------------------------------
	IF @Focal > 0
	BEGIN
		IF @summary <> '' SET @summary = @summary + '##'

		IF @FocalQuantity > 1 SET @summary = @summary + CONVERT(VARCHAR(20), @FocalQuantity) + ' '
		ELSE SET @summary = @summary + 'A '
		
		IF @FocalProbably = 1 SET @summary = @summary + 'probably '

		SELECT @summary = @summary + LOWER([Description]) + ' ' FROM @TumourTypes WHERE TypeId = @FocalTypeId

		IF @FocalQuantity > 1 SET @summary = @summary + 'focal lesions ' ELSE SET @summary = @summary + 'focal lesion ' 

		IF (@FocalQuantity > 0 AND @FocalLargest > 0) 
		BEGIN
			IF @FocalQuantity > 1
				SET @summary = @summary + '(largest ' + CONVERT(VARCHAR(20), @FocalLargest) + 'mm) '
			ELSE
				SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @FocalLargest) + 'mm) '
		END		
	END
	-------------------------------------------------------------------------------------------
	-------	Fundic Gland Polyp -------
	------------------------------------------------------------------------------------------
	IF @FundicGlandPolyp > 0
	BEGIN
		IF @summary <> '' SET @summary = @summary + '##'

		IF @FundicGlandPolypQuantity > 1 SET @summary = @summary + CONVERT(VARCHAR(20), @FundicGlandPolypQuantity) + ' '
		ELSE SET @summary = @summary + 'A '
		
		IF @FundicGlandPolypQuantity > 1 SET @summary = @summary + 'Fundic Gland Polyp found ' ELSE SET @summary = @summary + 'Fundic Gland Polyp found ' --TFS-2958---

		IF (@FundicGlandPolypQuantity > 0 AND @FundicGlandPolypLargest > 0) 
		BEGIN
			IF @FundicGlandPolypQuantity > 1
				SET @summary = @summary + '(largest ' + CONVERT(VARCHAR(20), @FundicGlandPolypLargest) + ' mm) '
			ELSE
				SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @FundicGlandPolypLargest) + ' mm) '
		END		
	END


	SET @Count = 1
	--loop through records
	OPEN cur
	FETCH NEXT FROM cur INTO @PolypDetailId, @Size, @Excised, @Retrieved, @ToLabs, @Removal, @RemovalMethod, @Probably, @TumourTypeId, @ParisClass, @PitPattern, @Inflam, @PostInflam, @TattooedId, @TattooMarkingTypeId

	WHILE @@FETCH_STATUS = 0 
	BEGIN
		SET  @Tattooed = NULL
		SET @TumourType = ''
		SET @TattooMarkingType = NULL

		--build up summary report
		SELECT @TumourType = LOWER(ISNULL([Description],''))
		FROM ERS_TumourTypes
		WHERE UniqueId = @TumourTypeId

		SELECT @Tattooed = LOWER([Description])
		FROM ERS_TattooOptions
		WHERE UniqueId = @TattooedId

		SELECT @TattooMarkingType = LOWER(ISNULL([Description],''))
		FROM ERS_MarkingTypes
		WHERE UniqueId = @TattooMarkingTypeId

		SELECT @PolypCondition = (
			SELECT STUFF((SELECT ', ' + LOWER(ISNULL([SummaryTerm],''))as [text()] 
		    FROM ERS_CommonAbnoPolypConditions cc
				INNER JOIN ERS_PolypConditions pd on cc.PolypConditionId = pd.UniqueId
			WHERE PolypDetailId = @PolypDetailId AND [Description] <> 'Hyperplastic'
			ORDER BY ISNULL(ListOrderBy,9999)
		    FOR XML PATH('')),1,1,''))
		
		SELECT @RemovalType = LOWER([Description])
		FROM ERS_PolypRemovalMethods
		WHERE UniqueId = @Removal

		SELECT @RemovalBy = Description
		FROM ERS_PolypRemovalTypes
		WHERE UniqueId = @RemovalMethod

		SELECT @PolypCondition = dbo.fnStringToSentance(@PolypCondition)

		DECLARE @IsHyperplastic BIT = (SELECT 1 FROM ERS_CommonAbnoPolypConditions cc
				INNER JOIN ERS_PolypConditions pd on cc.PolypConditionId = pd.UniqueId
			WHERE PolypDetailId = @PolypDetailId AND [Description] = 'Hyperplastic')

		IF @Quantity > 1 SET @summary = @summary + '<br/>Polyp ' + convert(varchar(10), @Count) + '- '
		IF ISNULL(@PolypCondition,'') <> '' OR ISNULL(@IsHyperPlastic,0) = 1
		BEGIN
		 SET @summary = @summary + CASE WHEN ISNULL(@IsHyperPlastic,0) = 1 THEN 'Hyperplastic ' ELSE '' END +  CASE WHEN ISNULL(@PolypCondition,'') <> '' THEN 'with' + @PolypCondition ELSE '' END + ': ' --ELSE SET @summary = @summary + '<br/>'
		END

		IF @PolypType = 'sessile'
			BEGIN
				IF @Probably = 1 SET @summary = @summary + 'probably '

				SET @summary = @summary + ' ' + @TumourType + ' '

				IF (@Quantity > 0 AND @Size > 0) 
				BEGIN
					SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @Size) + 'mm) '
				END
			END

			------------------------------------------------------------------------------------------
			-------	PEDUNCULATED -------
			------------------------------------------------------------------------------------------
			ELSE IF @PolypType = 'pedunculated'
			BEGIN
				--IF @Quantity > 0 SET @summary = @summary + CONVERT(VARCHAR(20), @Quantity) + ' '
		
				IF @Probably = 1 SET @summary = @summary + 'probably '

				IF @TumourTypeId = 1 SET @summary = @summary + 'benign '
				ELSE IF @TumourTypeId = 2 SET @summary = @summary + 'malignant '

				IF @ParisClass = 2 
					SET @summary = @summary + 'sub pedunculated ' 
				--ELSE
				--	SET @summary = @summary + 'polyp ' 

				IF (@Quantity > 0 AND @Size > 0) 
				BEGIN
					SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @Size) + 'mm) '
				END
			END

			------------------------------------------------------------------------------------------
			-------	PSEUDOPOLYPS -------
			------------------------------------------------------------------------------------------
			ELSE IF @PolypType = 'pseudo'
			BEGIN
				--IF @Quantity > 0 SET @summary = @summary + CONVERT(VARCHAR(20), @Quantity) + ' '

				IF @Inflam = 1 AND @PostInflam = 0 SET @summary = @summary + 'inflammatory '
				ELSE IF @Inflam = 0 AND @PostInflam = 1 SET @summary = @summary + 'post-inflammatory '
				ELSE IF @Inflam = 1 AND @PostInflam = 1 SET @summary = @summary + 'inflammatory and post-inflammatory '
		
				--SET @summary = @summary + 'pseudopolyp ' 

				IF (@Quantity > 0 AND @Size > 0) 
				BEGIN
					SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @Size) + 'mm) '
				END
			END
			------------------------------------------------------------------------------------------
			-------	SUBMUCOSAL -------
			------------------------------------------------------------------------------------------
			ELSE IF @PolypType = 'submucosal'
			BEGIN
				IF (@Quantity > 0 AND @Size > 0) 
				BEGIN
					SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @Size) + 'mm) '
				END


				-- Set the last occurence of $$ to "and"
				IF CHARINDEX('$$', @summary) > 0 SET @summary = STUFF(@summary, len(@summary) - charindex('$$', reverse(@summary)), 3, ' and')
				-- Replace all other occurences of $$ with commas
				SET @summary = REPLACE(@summary, '$$', ',')
			END

			------------------------------------------------------------------------------------------ tfs 4421
			-------	FOCAL LESIONS -------
			------------------------------------------------------------------------------------------
			ELSE IF @PolypType = 'focal lesions'
			BEGIN				
				IF (@Quantity > 0 AND @Size > 0) 
				BEGIN
					SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @Size) + 'mm) '
				END


				-- Set the last occurence of $$ to "and"
				IF CHARINDEX('$$', @summary) > 0 SET @summary = STUFF(@summary, len(@summary) - charindex('$$', reverse(@summary)), 3, ' and')
				-- Replace all other occurences of $$ with commas
				SET @summary = REPLACE(@summary, '$$', ',')
			END

			------------------------------------------------------------------------------------------ tfs 4421
			-------	Fundic Gland Polyp -------
			------------------------------------------------------------------------------------------
			ELSE IF @PolypType = 'fundic gland polyp'
			BEGIN				
				IF (@Quantity > 0 AND @Size > 0) 
				BEGIN
					SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @Size) + 'mm) '
				END


				-- Set the last occurence of $$ to "and"
				IF CHARINDEX('$$', @summary) > 0 SET @summary = STUFF(@summary, len(@summary) - charindex('$$', reverse(@summary)), 3, ' and')
				-- Replace all other occurences of $$ with commas
				SET @summary = REPLACE(@summary, '$$', ',')
			END

			IF ISNULL(@Tattooed,'no') <> 'no'
			BEGIN
				SET @summary = @summary + '. Polyp ' + CASE WHEN @Tattooed = 'yes' THEN 'tattooed' ELSE ISNULL(@Tattooed, 'previously tattooed') END + CASE WHEN ISNULL(@TattooMarkingType,'') <> '' THEN ' using ' + @TattooMarkingType ELSE '' END
			END

			IF @ParisClass > 0 OR @PitPattern > 0
				BEGIN
					SET @summary = @summary + '('

					IF @ParisClass > 0 
					SET @summary = @summary +
							 CASE @ParisClass
								   WHEN  1 THEN 'Paris Is'
								   WHEN  2 THEN 'Paris IIa'
								   WHEN  3 THEN 'Paris IIa + IIc'
								   WHEN  4 THEN 'Paris IIb'
								   WHEN  5 THEN 'Paris IIc'
								   WHEN  6 THEN 'Paris IIc + IIa'
								   WHEN  7 THEN 'Paris Ip'
								   WHEN  8 THEN 'Paris Isp'
								   WHEN  10 THEN 'Paris LST-G'
								   WHEN  11 THEN 'Paris LST-NG'
								   WHEN  12 THEN 'Paris LST-D'
								   WHEN  13 THEN 'Paris LST-M'
								   ELSE ''
					END

					IF @PitPattern > 0 
					BEGIN
						IF @ParisClass > 0 SET @summary = @summary + ', '
				
						SET @summary = @summary +
								   CASE @PitPattern
										  WHEN  1 THEN 'pit type I'
										  WHEN  2 THEN 'pit type II'
										  WHEN  3 THEN 'pit type IIIs'
										  WHEN  4 THEN 'pit type IIIL'
										  WHEN  5 THEN 'pit type IV'
										  WHEN  6 THEN 'pit type V'
							ELSE ''
						END
					END

					SET @summary = @summary + ')'
				END

				IF @Excised = 1 
				BEGIN
					SET @summary = @summary + '$$ '
					SET @summary = @summary + 'excised '

					IF @Removal > 0 OR @RemovalMethod > 0
					BEGIN
						SET @summary = @summary + '(removed '
				
						IF @Removal > 0 SET @summary = @summary + @RemovalBy + ' '
						IF @RemovalMethod > 0 SET @summary = @summary + @RemovalType
						
						SET @summary = @summary + ')'
					END
				END

				IF @Retrieved = 1 
				BEGIN
					SET @summary = @summary + '$$ '
					SET @summary = @summary + 'retrieved '
				END

				IF @ToLabs = 1  
				BEGIN
					SET @summary = @summary + '$$ '
					SET @summary = @summary + 'sent to labs '
				END

				-- Set the last occurence of $$ to "and"
				IF CHARINDEX('$$', @summary) > 0 SET @summary = STUFF(@summary, len(@summary) - charindex('$$', reverse(@summary)), 3, ' and ')
				-- Replace all other occurences of $$ with commas
				SET @summary = REPLACE(@summary, '$$', ',')

		SET @Count = @Count + 1
		FETCH NEXT FROM cur INTO @PolypDetailId, @Size, @Excised, @Retrieved, @ToLabs, @Removal, @RemovalMethod, @Probably, @TumourTypeId, @ParisClass, @PitPattern, @Inflam, @PostInflam, @TattooedId, @TattooMarkingTypeId

	END

	CLOSE cur
	DEALLOCATE cur

	RETURN @summary + '##'
END

GO

------------------------------------------------------------------------------------------------------------------------
-- TFS#	4421 Ended
------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rony
-- TFS#	3513
-- Description of change
-- V2 Transnasal to be Procedure Title  
------------------------------------------------------------------------------------------------------------------------
update ERS_ProcedureTypes set ProductTypeId=1,ReportHeader='TRANSNASAL ENDOSCOPY REPORT' where ProcedureType = 'Transnasal'

INSERT INTO ERS_Regions (ProcedureType,DiagramId,Region,Path,is3D,[Order],Direction,NED_Term)
SELECT (SELECT ProcedureTypeId FROM ERS_ProcedureTypes where ProcedureType = 'Transnasal'),DiagramId,Region,Path,is3D,[Order],Direction,NED_Term FROM(
SELECT r.DiagramId,r.Region,r.Path,r.is3D,r.[Order],r.Direction,r.NED_Term FROM ERS_Regions r 
WHERE r.ProcedureType=1 
)re        
WHERE (SELECT ProcedureTypeId FROM ERS_ProcedureTypes where ProcedureType = 'Transnasal') NOT IN (SELECT ProcedureType FROM ERS_Regions WHERE ProcedureType = (SELECT ProcedureTypeId FROM ERS_ProcedureTypes where ProcedureType = 'Transnasal'))

INSERT INTO ERS_ExtentProcedureTypes (ExtentId,ProcedureTypeId)
SELECT ExtentId,(SELECT ProcedureTypeId FROM ERS_ProcedureTypes where ProcedureType = 'Transnasal') FROM(
SELECT ExtentId FROM ERS_ExtentProcedureTypes WHERE ProcedureTypeId=1
)ept
WHERE ept.ExtentId NOT IN(SELECT ExtentId FROM ERS_ExtentProcedureTypes WHERE ProcedureTypeId=(SELECT ProcedureTypeId FROM ERS_ProcedureTypes where ProcedureType = 'Transnasal'))

INSERT INTO ERS_IndicationsProcedureTypes (IndicationId,ProcedureTypeId)
SELECT IndicationId,(SELECT ProcedureTypeId FROM ERS_ProcedureTypes where ProcedureType = 'Transnasal') FROM(
SELECT IndicationId FROM ERS_IndicationsProcedureTypes WHERE ProcedureTypeId=1
)ip
WHERE ip.IndicationId NOT IN(SELECT IndicationId FROM ERS_IndicationsProcedureTypes WHERE ProcedureTypeId=(SELECT ProcedureTypeId FROM ERS_ProcedureTypes where ProcedureType = 'Transnasal'))

INSERT INTO ERS_PreviousDiseaseProcedureTypes (PreviousDiseaseId,ProcedureTypeId)
SELECT PreviousDiseaseId,(SELECT ProcedureTypeId FROM ERS_ProcedureTypes where ProcedureType = 'Transnasal') FROM(
SELECT PreviousDiseaseId FROM ERS_PreviousDiseaseProcedureTypes WHERE ProcedureTypeId=1
)pdp
WHERE pdp.PreviousDiseaseId NOT IN(SELECT PreviousDiseaseId FROM ERS_PreviousDiseaseProcedureTypes WHERE ProcedureTypeId=(SELECT ProcedureTypeId FROM ERS_ProcedureTypes where ProcedureType = 'Transnasal'))

INSERT INTO ERS_AdverseEventsProcedureTypes (AdverseEventsId,ProcedureTypeId)
SELECT AdverseEventsId,(SELECT ProcedureTypeId FROM ERS_ProcedureTypes where ProcedureType = 'Transnasal') FROM(
SELECT AdverseEventsId FROM ERS_AdverseEventsProcedureTypes WHERE ProcedureTypeId=1
)aept
WHERE aept.AdverseEventsId NOT IN(SELECT AdverseEventsId FROM ERS_AdverseEventsProcedureTypes WHERE ProcedureTypeId=(SELECT ProcedureTypeId FROM ERS_ProcedureTypes where ProcedureType = 'Transnasal'))

INSERT INTO ERS_LimitationProcedureTypes (LimitationId,ProcedureTypeId)
SELECT LimitationId,(SELECT ProcedureTypeId FROM ERS_ProcedureTypes WHERE ProcedureType = 'Transnasal') FROM(
SELECT LimitationId FROM ERS_LimitationProcedureTypes WHERE ProcedureTypeId=1
)lpt
WHERE lpt.LimitationId NOT IN(SELECT LimitationId FROM ERS_LimitationProcedureTypes WHERE ProcedureTypeId=(SELECT ProcedureTypeId FROM ERS_ProcedureTypes where ProcedureType = 'Transnasal'))

INSERT INTO ERS_AbnormalitiesMatrixUpperGI([ProcedureType],[Region],[Gastritis],[Gastric Ulcer],[Lumen],[Malignancy],[Post Surgery],[Deformity],[Polyps],[Varices],[Hiatus Hernia],[Achalasia],[Oesophagitis],[Barretts]
,[Miscellaneous],[Diverticulum/Other],[Tumour],[Duodenitis],[Pyloric Ulcer],[Duodenal Ulcer],[Scarring/Stenosis],[Vascular Lesions],[Atrophic Duodenum],[Mediastinal]
,[Area],[Lesions])
SELECT (SELECT ProcedureTypeId FROM ERS_ProcedureTypes where ProcedureType = 'Transnasal'),* FROM(
SELECT [Region],[Gastritis],[Gastric Ulcer],[Lumen],[Malignancy],[Post Surgery],[Deformity],[Polyps],[Varices],[Hiatus Hernia],[Achalasia],[Oesophagitis],[Barretts]
,[Miscellaneous],[Diverticulum/Other],[Tumour],[Duodenitis],[Pyloric Ulcer],[Duodenal Ulcer],[Scarring/Stenosis],[Vascular Lesions],[Atrophic Duodenum],[Mediastinal]
,[Area],[Lesions] FROM ERS_AbnormalitiesMatrixUpperGI WHERE ProcedureType=1
)ab
WHERE (SELECT ProcedureTypeId FROM ERS_ProcedureTypes where ProcedureType = 'Transnasal') NOT IN(SELECT ProcedureType FROM ERS_AbnormalitiesMatrixUpperGI WHERE ProcedureType = (SELECT ProcedureTypeId FROM ERS_ProcedureTypes where ProcedureType = 'Transnasal'))

INSERT INTO ERS_SiteDetailsMenuUrls(ProcedureType,[Menu],[NavigateUrl])
SELECT (SELECT ProcedureTypeId FROM ERS_ProcedureTypes where ProcedureType = 'Transnasal'),* FROM(
SELECT [Menu],[NavigateUrl] FROM ERS_SiteDetailsMenuUrls WHERE ProcedureType=1
) sd
WHERE (SELECT ProcedureTypeId FROM ERS_ProcedureTypes where ProcedureType = 'Transnasal') NOT IN(SELECT ProcedureType FROM ERS_SiteDetailsMenuUrls WHERE ProcedureType = (SELECT ProcedureTypeId FROM ERS_ProcedureTypes where ProcedureType = 'Transnasal'))

INSERT INTO ERS_DiagnosesMatrix(ProcedureTypeID,[DisplayName],[NED_Name],[EndoCode],[Section],[OrderByNumber],[Code],[NED_Include])
SELECT (SELECT ProcedureTypeId FROM ERS_ProcedureTypes where ProcedureType = 'Transnasal'),* FROM(
select [DisplayName],[NED_Name],[EndoCode],[Section],[OrderByNumber],[Code],[NED_Include] from ERS_DiagnosesMatrix where ProcedureTypeID=1
)dm
WHERE (SELECT ProcedureTypeId FROM ERS_ProcedureTypes where ProcedureType = 'Transnasal') NOT IN(SELECT ProcedureTypeID FROM ERS_DiagnosesMatrix WHERE ProcedureTypeID = (SELECT ProcedureTypeId FROM ERS_ProcedureTypes where ProcedureType = 'Transnasal'))

INSERT INTO ERS_FamilyDiseaseHistoryProcedureTypes (FamilyDiseaseHistoryId,ProcedureTypeId)
SELECT FamilyDiseaseHistoryId,(SELECT ProcedureTypeId FROM ERS_ProcedureTypes where ProcedureType = 'Transnasal') FROM(
SELECT FamilyDiseaseHistoryId FROM ERS_FamilyDiseaseHistoryProcedureTypes WHERE ProcedureTypeId=1
)fdhpt
WHERE fdhpt.FamilyDiseaseHistoryId NOT IN(SELECT FamilyDiseaseHistoryId FROM ERS_FamilyDiseaseHistoryProcedureTypes WHERE ProcedureTypeId=(SELECT ProcedureTypeId FROM ERS_ProcedureTypes where ProcedureType = 'Transnasal'))

GO
EXEC dbo.DropIfExist 
    @ObjectName = 'get_Transnasal_AccessMethodThoracic_List', 
    @ObjectTypePrefix = 'S' 
GO
CREATE PROCEDURE [dbo].[get_Transnasal_AccessMethodThoracic_List]
    @ListDescription VARCHAR(200),
    @LoggedInUserId INT,
    @OrderByDesc BIT
AS
BEGIN
	SELECT lm.*, l.*, 
		CASE WHEN u.caneditdropdowns = 1 THEN lm.allowaddnewitem ELSE 0 END AS allowaddnewitemusersetting 
	FROM ers_lists l 
	LEFT JOIN ers_listsmain lm ON l.listdescription = lm.listdescription 
	CROSS JOIN ers_users u 
	WHERE lm.listdescription IN (@listDescription) AND l.ListItemText IN('left nostril','right nostril','mouth')
		AND ISNULL(l.suppressed, 0) = 0 
		AND u.userid = @LoggedInUserId 
	ORDER BY 
		CASE WHEN ISNULL(@OrderByDesc, 0) = 0 THEN l.listitemno END ASC, 
		CASE WHEN ISNULL(@OrderByDesc, 0) = 1 THEN l.listitemtext END ASC
END
GO
EXEC dbo.DropIfExist 
    @ObjectName = 'site_details_menu_select', 
    @ObjectTypePrefix = 'S' 
GO
CREATE PROCEDURE [dbo].[site_details_menu_select]
(
	@SiteId INT	
)
AS

SET NOCOUNT ON

DECLARE	@ProcedureType INT
DECLARE @Region VARCHAR (500)
DECLARE	@Area VARCHAR (50)
DECLARE	@ProcedureId INT

declare  @Menus TABLE (
	[SiteId] INT,
	[ProcedureType] INT,
	[Region] VARCHAR(500),	
	[ParentMenu] VARCHAR (500),
	[Menu] VARCHAR (500),
	[NavigateUrl] VARCHAR (4000),
	[SortOrder] TINYINT
)

DECLARE @SiteNo INT = NULL, @IsLymphNode BIT = 0

SELECT @SiteNo = SiteNo FROM ERS_Sites WHERE SiteId = @SiteId

IF @SiteId = -1 
BEGIN
	SET @ProcedureType = 11
	SET @IsLymphNode = 1
	SET @Region = 'EBUS'
END
ELSE IF @SiteNo = 0
	SET @SiteId = dbo.fnGetPrimeSiteId(@SiteId)
ELSE IF @SiteNo = -77   --'SiteNo is set to -77 for sites By Distance (Col & Sig only)
	SELECT @ProcedureType = 3, @Region = 'Anus'
ELSE
	SELECT @ProcedureType = p.ProcedureType, @Region = r.Region, @ProcedureId = p.ProcedureId, @IsLymphNode = s.IsLymphNode 
	FROM ERS_Sites s
	JOIN ERS_Procedures p ON s.ProcedureId = p.ProcedureId
	JOIN ERS_Regions r ON s.RegionId = r.RegionId
	WHERE SiteId = @SiteId

IF @ProcedureType IN (1,6,(SELECT ProcedureTypeId FROM ERS_ProcedureTypes where ProcedureType = 'Transnasal')) --Gastroscopy / EUS(OGD) / Transnasal TFS-3513
BEGIN

	SELECT TOP 1 @Area = [Area] 
	FROM ERS_AbnormalitiesMatrixUpperGI
	WHERE [ProcedureType] = @ProcedureType 
	AND [Region] = @Region

	INSERT INTO @Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu])
	SELECT 
		@SiteId,
		[ProcedureType], 
		[Region], 
		'Abnormalities' AS [ParentMenu], 
		[Menu]
	FROM 
	(
		SELECT * 
		FROM [ERS_AbnormalitiesMatrixUpperGI] 
		WHERE [ProcedureType] = @ProcedureType 
		AND [Region] = @Region
	) a
	UNPIVOT
	(
		[Display] 
		FOR [Menu] IN ([Gastritis], [Gastric Ulcer], [Lumen], [Malignancy], [Post Surgery], 
						[Deformity], [Polyps], [Varices], [Hiatus Hernia], [Achalasia], 
						[Oesophagitis], [Barretts], [Miscellaneous], [Diverticulum/Other], [Tumour], 
						[Duodenitis], [Pyloric Ulcer], [Duodenal Ulcer], [Scarring/Stenosis], [Vascular Lesions],
						[Atrophic Duodenum], [Mediastinal], [Lesions])
	) b
	WHERE [Display] = 1

	INSERT INTO @Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu], [NavigateUrl], [SortOrder])
	SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Gastro/TherapeuticProcedures/OGDTherapeuticProcedures.aspx', 1
	--SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Gastro/Abnormalities/OGD/Lumen.aspx'
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Gastro/Specimens/OGDSpecimensTaken.aspx', 2
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Media', '', '~/Products/Common/AttachedMedia.aspx', 3
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Additional notes', '', '~/Products/Gastro/Notes/Notes.aspx', 4
	--SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Gastro/Abnormalities/OGD/Lumen.aspx'
END

ELSE IF @ProcedureType IN (2,7) --ERCP / EUS(HPB)
BEGIN

	SELECT TOP 1 @Area = [Area] 
	FROM ERS_AbnormalitiesMatrixERCP
	WHERE [ProcedureType] = @ProcedureType 
	AND [Region] = @Region

	INSERT INTO @Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu])
	SELECT 
		@SiteId,
		[ProcedureType], 
		[Region], 
		'Abnormalities' AS [ParentMenu], 
		[Menu]
	FROM 
	(
		SELECT * 
		FROM [ERS_AbnormalitiesMatrixERCP] 
		WHERE [ProcedureType] = @ProcedureType 
		AND [Region] = @Region
	) a
	UNPIVOT
	(
		[Display] 
		FOR [Menu] IN ([Gall Bladder], [Duct], [Parenchyma], [Appearance], [Diverticulum], [Tumour], [Diverticulum/Other], 
						[TumourCommon],[Duodenitis],[Duodenal Ulcer],[Scarring/Stenosis],[Vascular Lesions],[Atrophic Duodenum],[Intrahepatic],[Site],[Miscellaneous], [Varices], [Lesions])
	) b
	WHERE [Display] = 1

	INSERT INTO @Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu], [NavigateUrl], [SortOrder])
	--SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Gastro/TherapeuticProcedures/ERCPTherapeuticProcedures.aspx'
	--SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Gastro/Abnormalities/OGD/Lumen.aspx'
	SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Gastro/TherapeuticProcedures/ERCPTherapeuticProcedures.aspx', 1
	UNION ALL
	--SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Gastro/Specimens/ERCPSpecimensTaken.aspx'
	--SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Gastro/Abnormalities/OGD/Lumen.aspx'
	SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Gastro/Specimens/OGDSpecimensTaken.aspx', 2
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Media', '', '~/Products/Common/AttachedMedia.aspx', 3
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Additional notes', '', '~/Products/Gastro/Notes/Notes.aspx', 4
	
END

ELSE IF @ProcedureType IN (3,4,5) --Colonoscopy / Proctoscopy / Sigmoidoscopy
BEGIN
	INSERT INTO @Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu])
	SELECT 
		@SiteId,
		[ProcedureType], 
		[Region], 
		'Abnormalities' AS [ParentMenu], 
		[Menu]
	FROM 
	(
		SELECT * 
		FROM [ERS_AbnormalitiesMatrixColon] 
		WHERE [ProcedureType] = @ProcedureType 
		AND [Region] = @Region
	) a
	UNPIVOT
	(
		[Display] 
		FOR [Menu] IN ([Calibre],[Mucosa], [Diverticulum], [Lesions], [Vascularity], [Haemorrhage], [Miscellaneous], [Perianal Lesions],[Tumour], [Varices])
	) b
	WHERE [Display] = 1

	INSERT INTO @Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu], [NavigateUrl], [SortOrder])
	--SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Gastro/TherapeuticProcedures/ColonTherapeuticProcedures.aspx'
	--SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Gastro/Abnormalities/OGD/Lumen.aspx'
	SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Gastro/TherapeuticProcedures/OGDTherapeuticProcedures.aspx', 1
	UNION ALL
	--SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Gastro/Specimens/ColonSpecimensTaken.aspx'
	--SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Gastro/Abnormalities/OGD/Lumen.aspx'
	SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Gastro/Specimens/OGDSpecimensTaken.aspx', 2
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Media', '', '~/Products/Common/AttachedMedia.aspx', 3
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Additional notes', '', '~/Products/Gastro/Notes/Notes.aspx', 4
END

ELSE IF @ProcedureType IN (8) --Antegrade
BEGIN
	SELECT TOP 1 @Area = [Area] 
	FROM [ERS_AbnormalitiesMatrixAntegrade]
	WHERE [ProcedureType] = @ProcedureType 
	AND [Region] = @Region

	INSERT INTO @Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu])
	SELECT 
		@SiteId,
		[ProcedureType], 
		[Region], 
		'Abnormalities' AS [ParentMenu], 
		CASE WHEN region = 'Jejunum' AND [Menu] = 'Diverticulum/Other' THEN 'Diverticulum' /*WHEN region= 'Ileum' AND [Menu] = 'Miscellaneous/Other' THEN 'Miscellaneous'*/ ELSE [Menu] END AS Menu
	FROM 
	(
		SELECT * 
		FROM [ERS_AbnormalitiesMatrixAntegrade] 
		WHERE [ProcedureType] = @ProcedureType 
		AND [Region] = @Region
	) a
	UNPIVOT
	(
		[Display] 
		FOR [Menu] IN ([Gastritis], [Gastric Ulcer], [Lumen], [Malignancy], [Post Surgery], 
						[Deformity], [Varices], [Hiatus Hernia], [Achalasia], 
						[Oesophagitis], [Barretts], [Miscellaneous], [Diverticulum/Other], [Tumour], 
						[Duodenitis], [Pyloric Ulcer], [Duodenal Ulcer], 
						[Lesions],[Jejunitis],[Jejunal Ulcer],[Ileitis],[Ileal Ulcer],
						[Scarring/Stenosis], [Vascular Lesions],
						[Atrophic Duodenum], [Miscellaneous/Other])
	) b
	WHERE [Display] = 1

	INSERT INTO @Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu], [NavigateUrl], [SortOrder])
	SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Gastro/TherapeuticProcedures/OGDTherapeuticProcedures.aspx', 1
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Gastro/Specimens/OGDSpecimensTaken.aspx', 2
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Media', '', '~/Products/Common/AttachedMedia.aspx', 3
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Additional notes', '', '~/Products/Gastro/Notes/Notes.aspx', 4
END

ELSE IF @ProcedureType IN (9) --Retrograde
BEGIN
	INSERT INTO @Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu])
	SELECT 
		@SiteId,
		[ProcedureType], 
		[Region], 
		'Abnormalities' AS [ParentMenu], 
		[Menu]
	FROM 
	(
		SELECT * 
		FROM [ERS_AbnormalitiesMatrixRetrograde] 
		WHERE [ProcedureType] = @ProcedureType 
		AND [Region] = @Region
	) a
	UNPIVOT
	(
		[Display] 
		FOR [Menu] IN ([Calibre], [Mucosa], [Diverticulum], [Lesions], [Vascularity], [Haemorrhage], [Miscellaneous], [Perianal Lesions], [Tumour], 
		[Jejunitis], [Jejunal Ulcer], [Scarring/Stenosis], [Ileitis], [Ileal Ulcer], [Varices])
	) b
	WHERE [Display] = 1

	INSERT INTO @Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu], [NavigateUrl], [SortOrder])
	--SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Gastro/TherapeuticProcedures/ColonTherapeuticProcedures.aspx'
	--SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Gastro/Abnormalities/OGD/Lumen.aspx'
	SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Gastro/TherapeuticProcedures/OGDTherapeuticProcedures.aspx', 1
	UNION ALL
	--SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Gastro/Specimens/ColonSpecimensTaken.aspx'
	--SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Gastro/Abnormalities/OGD/Lumen.aspx'
	SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Gastro/Specimens/OGDSpecimensTaken.aspx', 2
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Media', '', '~/Products/Common/AttachedMedia.aspx', 3
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Additional notes', '', '~/Products/Gastro/Notes/Notes.aspx', 4
END

ELSE IF @ProcedureType IN (10,11) and @IsLymphNode = 0 -- Bronchoscopy / EBUS
BEGIN
	INSERT INTO @Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu])
	SELECT 
		@SiteId,
		[ProcedureType], 
		[Region], 
		'Abnormalities' AS [ParentMenu], 
		[Menu]
	FROM 
	(
		SELECT * 
		FROM [ERS_AbnormalitiesMatrixBRT] 
		WHERE [ProcedureType] = @ProcedureType 
		--AND [Region] = @Region      -- Abnormality is the same for all BRT regions 
	) a
	UNPIVOT
	(
		[Display] 
		FOR [Menu] IN ([Carinal Abnormality], [Vocal Cord Paralysis], [Compression], [Stenosis], [Obstruction], [Mucosal], [Mucosal Irregularity], [Excessive secretions], [Bleeding])
	) b
	WHERE [Display] = 1

	INSERT INTO @Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu], [NavigateUrl], [SortOrder])
	SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Gastro/TherapeuticProcedures/OGDTherapeuticProcedures.aspx', 1
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Broncho/Specimens/BronchoSpecimens.aspx', 2
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Media', '', '~/Products/Common/AttachedMedia.aspx', 3
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Additional notes', '', '~/Products/Gastro/Notes/Notes.aspx', 4
END

ELSE IF @ProcedureType = 11 and @IsLymphNode = 1 --  EBUS
BEGIN
	INSERT INTO @Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu])
	SELECT 
		@SiteId,
		[ProcedureType], 
		[Region], 
		'Abnormalities' AS [ParentMenu], 
		[Menu]
	FROM 
	(
		SELECT * 
		FROM [ERS_AbnormalitiesMatrixBRT] 
		WHERE [ProcedureType] = @ProcedureType 
		--AND [Region] = @Region      -- Abnormality is the same for all BRT regions 
	) a
	UNPIVOT
	(
		[Display] 
		FOR [Menu] IN ([EBUS Abnormality descriptions])
	) b
	WHERE [Display] = 1

	INSERT INTO @Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu], [NavigateUrl], [SortOrder])
	SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Gastro/TherapeuticProcedures/OGDTherapeuticProcedures.aspx', 1
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Broncho/Specimens/BronchoSpecimens.aspx', 2
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Media', '', '~/Products/Common/AttachedMedia.aspx' , 3
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Additional notes', '', '~/Products/Gastro/Notes/Notes.aspx', 4
END
ELSE IF @ProcedureType IN (13) -- Cystoscopy
BEGIN
	INSERT INTO @Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu])
	SELECT 
		@SiteId,
		[ProcedureType], 
		[Region], 
		'Abnormalities' AS [ParentMenu], 
		[Menu]
	FROM 
	(
		SELECT * 
		FROM [ERS_AbnormalitiesMatrixCystoscopy] 
		WHERE [ProcedureType] = @ProcedureType 
		AND [Region] = @Region      
	) a
	UNPIVOT
	(
		[Display] 
		FOR [Menu] IN ([Bladder],[Prostate],[Urethra])
	) b
	WHERE [Display] = 1

	INSERT INTO @Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu], [NavigateUrl], [SortOrder])
	SELECT @SiteId, @ProcedureType, @Region, 'Therapeutic Procedures', '', '~/Products/Cystoscopy/TherapeuticProcedures/CystoscopyTherapeuticProcedures.aspx', 1
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Specimens Taken', '', '~/Products/Cystoscopy/Specimens/CystoscopySpecimens.aspx', 2
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Media', '', '~/Products/Common/AttachedMedia.aspx', 3
	UNION ALL
	SELECT @SiteId, @ProcedureType, @Region, 'Additional notes', '', '~/Products/Gastro/Notes/Notes.aspx', 3
END

UPDATE a
SET NavigateUrl = b.NavigateUrl
FROM @Menus a
LEFT JOIN ERS_SiteDetailsMenuUrls b ON a.Menu = b.Menu
WHERE b.ProcedureType = @ProcedureType

UPDATE @Menus SET Menu = 'Tumour' WHERE Menu = 'TumourCommon'

-- Check if there are Other Abnormalities in this region, if there are, display Other in the Abnormalities tab
IF EXISTS (SELECT 1 FROM sys.objects WHERE object_id = object_id('ERS_OtherAbnormalitiesRegions'))
begin
If exists(Select 1 from ERS_OtherAbnormalitiesRegions oar join ERS_Sites s on s.RegionId = oar.RegionId join ERS_OtherAbnormalities OA on oar.OtherId = OA.OtherId where OA.Active = 1 and s.SiteId = @SiteId)
BEGIN
	INSERT INTO @Menus ([SiteId], [ProcedureType], [Region], [ParentMenu], [Menu], [NavigateUrl])
	SELECT 
		@SiteId,
		@ProcedureType, 
		r.Region, 
		'Abnormalities' AS [ParentMenu], 
		'Other' as [Menu],
		'~/Products/Gastro/Abnormalities/Common/Other.aspx' as NavigateUrl
	FROM ERS_Sites s
	join ERS_Regions r on s.RegionId = r.regionId
	where s.SiteId = @SiteId 
END
end
SELECT 
	m.ProcedureType,
	m.Region,
	m.ParentMenu, 
	m.Menu,
	m.NavigateUrl, 
	CASE WHEN r.RecordCountId IS NULL THEN 0 ELSE 1 END AS RecordExists,
	ISNULL(@Area,ISNULL(@Region,'')) AS Area
FROM 
	@Menus m
LEFT OUTER JOIN
	ERS_RecordCount r ON 
		(m.SiteId = r.SiteId OR
			(@ProcedureType IN (2,7) AND r.ProcedureId = @ProcedureId AND r.Identifier = 'Diagnoses')) --These conditions for Diagnoses only (for the whole procedure unlike the other items which are per site)
		AND (m.Menu = r.Identifier OR m.ParentMenu = r.Identifier)
				--OR LEFT(m.Menu,12) = 'Diverticulum') -- embolden 'Diverticulum/Other' when its attributes have been set.
ORDER BY m.SortOrder, m.Menu

--DROP TABLE #Menus
GO
EXEC dbo.DropIfExist 
    @ObjectName = 'usp_get_site_region_details', 
    @ObjectTypePrefix = 'S' 
GO
CREATE PROCEDURE [dbo].[usp_get_site_region_details]
(
	@SiteId int,
	@ProcedureTypeId int
)
AS
BEGIN
	IF @ProcedureTypeId IN (1,6,(SELECT ProcedureTypeId FROM ERS_ProcedureTypes where ProcedureType = 'Transnasal')) --tfs-3513
		SELECT DISTINCT area, a.Region
		FROM ERS_AbnormalitiesMatrixUpperGI a
			INNER JOIN ERS_Regions r ON a.Region = r.Region
			INNER JOIN ERS_Sites s ON s.RegionId = r.RegionId
		WHERE SiteId = @SiteId
	ELSE IF @ProcedureTypeId IN (2,7)
		SELECT DISTINCT area, a.Region
		FROM ERS_AbnormalitiesMatrixERCP a
			INNER JOIN ERS_Regions r ON a.Region = r.Region
			INNER JOIN ERS_Sites s ON s.RegionId = r.RegionId
		WHERE SiteId = @SiteId
	ELSE IF @ProcedureTypeId = 8
		SELECT DISTINCT area, a.Region
		FROM ERS_AbnormalitiesMatrixAntegrade a
			INNER JOIN ERS_Regions r ON a.Region = r.Region
			INNER JOIN ERS_Sites s ON s.RegionId = r.RegionId
		WHERE SiteId = @SiteId 
	ELSE IF @ProcedureTypeId IN (3,4,9)
		SELECT DISTINCT 'Colon' AS area, a.Region
		FROM ERS_AbnormalitiesMatrixColon a
			INNER JOIN ERS_Regions r ON a.Region = r.Region
			INNER JOIN ERS_Sites s ON s.RegionId = r.RegionId
		WHERE SiteId = @SiteId
END
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	3513
------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rony
-- TFS#	4358
-- Description of change
-- proctoscopy procedure
------------------------------------------------------------------------------------------------------------------------

update ERS_ProcedureTypes set Suppressed=0 where ProcedureType = 'Proctoscopy'

 --update to same as sig / colon
INSERT INTO ERS_ComorbidityProcedureTypes (ComorbidityId,ProcedureTypeId)
SELECT ComorbidityId,(SELECT ProcedureTypeId FROM ERS_ProcedureTypes where ProcedureType = 'Proctoscopy') FROM(
SELECT ComorbidityId FROM ERS_ComorbidityProcedureTypes WHERE ProcedureTypeId=3
)ept
WHERE ept.ComorbidityId NOT IN(SELECT ComorbidityId FROM ERS_ComorbidityProcedureTypes WHERE ProcedureTypeId=(SELECT ProcedureTypeId FROM ERS_ProcedureTypes where ProcedureType = 'Proctoscopy'))

--update Referral Symptoms
INSERT INTO ERS_IndicationsProcedureTypes (IndicationId,ProcedureTypeId)
SELECT IndicationId,(SELECT ProcedureTypeId FROM ERS_ProcedureTypes where ProcedureType = 'Proctoscopy') FROM(
SELECT IndicationId FROM ERS_IndicationsProcedureTypes WHERE ProcedureTypeId=3
)ept
WHERE ept.IndicationId NOT IN(SELECT IndicationId FROM ERS_IndicationsProcedureTypes WHERE ProcedureTypeId=(SELECT ProcedureTypeId FROM ERS_ProcedureTypes where ProcedureType = 'Proctoscopy'))

GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	4358
------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Muhammad Nasim
-- TFS#	4299
-- Description of change: Patient friendly report - no further update - auto
-------------------------------------------------------------------------------------------------------------------------
dbo.DropIfExist
    @ObjectName = 'Get_PatientReport_Info',      -- varchar(100)
    @ObjectTypePrefix = 'S' -- varchar(5)
Go
CREATE PROCEDURE [dbo].[Get_PatientReport_Info]
	@ProcedureId int,
	@OperatingHospitalId int
AS
BEGIN
	Declare @PP_PFRFollowUp nvarchar(max),@LimitationId int,@ProcedureUpperExtent int,@ProcedureLowerExtent bit,@ProcedureTypeID int,@NEDEnabled int,@procedureComplete nvarchar(100)
	Declare @Results as Table(includeText nvarchar(200) ,includes bit,result nvarchar(max))

	select @ProcedureUpperExtent=ExtentId from ERS_ProcedureUpperExtent where ProcedureId=@ProcedureId and ExtentId=(select UniqueId from ERS_Extent where Description='Abandoned')
	select @ProcedureLowerExtent=isnull(Abandoned,0) from ERS_ProcedureLowerExtent where ProcedureId=@ProcedureId	
	select @LimitationId=LimitationId from ERS_ProcedureUpperExtent where ProcedureId=@ProcedureId

	select @ProcedureTypeID= ProcedureType,@NEDEnabled=ISNULL(NEDEnabled,1) from ers_procedures where ProcedureId=@ProcedureId
	if @NEDEnabled<>1 or (@ProcedureTypeID in (3,4,5,9) and @ProcedureLowerExtent=1) or (@ProcedureTypeID in (1,6,7,8,2) and @ProcedureUpperExtent is not null)
	begin
		set @procedureComplete='No'
	end
	else if @LimitationId is not null
	begin
		set @procedureComplete='Yes (limited)'
	end
	else
	begin
		set @procedureComplete='Yes'
	end

	select Biopsy,Urease,Polypectomy into #tmpPatientReport from ERS_UpperGISpecimens where SiteId in (SELECT SiteId FROM ERS_Sites where ProcedureId=@ProcedureId)
	select @PP_PFRFollowUp=ISNULL(LTRIM(RTRIM(PP_PFRFollowUp)), '') from ERS_UpperGIFollowUp where procedureid=@ProcedureId

	insert into @Results(includeText,includes,result)
	select 'Urease',IncludeUreaseText,'<strong>&#8226;</strong>&nbsp;&nbsp;'+UreaseText from ERS_PrintOptionsPatientFriendlyReport where OperatingHospitalId=1 and (select Urease from #tmpPatientReport)=1 union all
	select 'Polypectomy',IncludePolypectomyText,'<strong>&#8226;</strong>&nbsp;&nbsp;'+PolypectomyText from ERS_PrintOptionsPatientFriendlyReport where OperatingHospitalId=1 and (select Polypectomy from #tmpPatientReport)=1 union all
	select 'OtherBiopsy',IncludeOtherBiopsyText,'<strong>&#8226;</strong>&nbsp;&nbsp;'+OtherBiopsyText from ERS_PrintOptionsPatientFriendlyReport where OperatingHospitalId=1 and (select Biopsy from #tmpPatientReport)=1 union all
	select 'IncludeAnyOtherBiopsyText',IncludeOtherBiopsyText,'<strong>&#8226;</strong>&nbsp;&nbsp;'+AnyOtherBiopsyText from ERS_PrintOptionsPatientFriendlyReport where OperatingHospitalId=1 and (select Biopsy from #tmpPatientReport)=1 union all
	select 'PreceedAdviceComments',IncludePreceedAdviceComments,'<strong>&#8226;</strong>&nbsp;&nbsp;'+PreceedAdviceComments+' '+@PP_PFRFollowUp from ERS_PrintOptionsPatientFriendlyReport where OperatingHospitalId=1 and @PP_PFRFollowUp<>''


	select procedureComplete=@procedureComplete,ProcedureType=isnull(b.ProcedureType,''),ProcedureTypeId=b.ProcedureTypeId,MedicationText=ISNULL( c.Summary,''),
	NoFurtherTestsRequired=isnull(d.NoFurtherTestsRequired,0),d.AwaitingPathologyResults,NoFurtherFollowUp=isnull(d.NoFurtherFollowUp,0),
	ListItemText=(SELECT isnull(ListItemText,'') FROM ERS_Lists WHERE ListDescription = 'Return or referred to' AND ListItemNo=d.ReturnTo),
	ReviewText=isnull(d.ReviewText,''),d.Summary
	from ERS_Procedures a left join ERS_ProcedureTypes b on a.ProcedureType=b.ProcedureTypeId
	left join ERS_UpperGIRx c on a.ProcedureId=c.ProcedureId
	left join ERS_UpperGIFollowUp d on a.ProcedureId=d.ProcedureId
	where a.ProcedureId=@ProcedureId

	select result from @Results where includes=1
	return
END
Go
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#4299 	(Patient friendly report - no further update - auto)
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	MOSTAFIZUR RAHMAN
-- TFS#	3828
-- Description of change
-- post-surgical anatomy Diagnoses
------------------------------------------------------------------------------------------------------------------------

GO 
EXEC dbo.DropIfExist 
    @ObjectName = 'usp_PrintReport', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[usp_PrintReport]
(
	@ProcedureId INT,
	@Group VARCHAR(10),
	@EpisodeNo INT = 0,
    @PatientComboId VARCHAR(30) = NULL,
    @ProcedureType INT,
    @ColonType INT
)
AS
/*
	16 Feb 2024			:		MH added Diagnoses Colon normal if no Diagnoses provided
*/
SET NOCOUNT ON

	CREATE TABLE #Summary_Main (NodeName VARCHAR(200), NodeSummary NVARCHAR(MAX) ,[Group] VARCHAR(10))

	INSERT INTO #Summary_Main
	EXEC usp_PrintReport_Select @ProcedureId, @Group, @EpisodeNo, @PatientComboId, @ProcedureType, @ColonType
	
	--FOR EUS-HPB
	IF @Group = 'LS' AND @EpisodeNo > 0 AND @ProcedureType = 7 -- ONLY for EUS-HPB (ERCP Report should include OGD, upper tract findings)
	BEGIN
		CREATE TABLE #Summary_UpperTract (NodeName VARCHAR(200), NodeSummary NVARCHAR(MAX) ,[Group] VARCHAR(10))

		INSERT INTO #Summary_UpperTract
		EXEC usp_PrintReport_Select @ProcedureId, @Group, @EpisodeNo, @PatientComboId, 1, @ColonType

		IF (SELECT COUNT(*) FROM #Summary_UpperTract WHERE LTRIM(RTRIM(NodeSummary)) <> '') > 0
		BEGIN
			INSERT INTO #Summary_Main
			SELECT '', '<br /><u style="color:#bf4040;font-weight:bold;">Within the limitations of a side-viewing scope the following upper tract findings were observed.</u>', @Group
			UNION ALL
			SELECT * FROM #Summary_UpperTract
		END
		DROP TABLE #Summary_UpperTract
	END

	declare @ProcedureTypeId int
	Declare @ProcedureTypeName varchar(100)
	declare @dna SMALLINT --edited by mostafiz 3830

	Select @ProcedureTypeId = PR.ProcedureType, @ProcedureTypeName = PT.ProcedureType,@dna=PR.DNA --edited by mostafiz 3830
		from ERS_Procedures PR
		inner join ERS_ProcedureTypes PT on PR.ProcedureType = PT.ProcedureTypeId
		Where ProcedureId = @ProcedureId
	 --below line [and (@dna = 0 OR @dna IS NULL)] edited by mostafiz 3830 but the comment was previously written
	 -- TFS 3774 @ProcedureTypeId IN (3, 13)
	IF @Group = 'LS' and @ProcedureTypeId IN (3, 13) and (@dna = 0 OR @dna IS NULL) --Can be used for any other Procedure types as well
		
		declare @DiagnosesNormalText as varchar(50) = @ProcedureTypeName + ' normal'
		IF ISNULL((SELECT ResectedColonNo FROM ers_procedures WHERE ProcedureId = @ProcedureId), '') NOT IN ('0', '')-- tfs 3828
			BEGIN
				SET @DiagnosesNormalText = '(post-surgical anatomy) - ' + @DiagnosesNormalText;
			END;
		Begin
			If not exists(Select * from #Summary_Main Where NodeName = 'Diagnoses')
		Begin
			Insert into #Summary_Main(NodeName,NodeSummary,[Group]) Values('Diagnoses',@DiagnosesNormalText,'LS')
		End
		Else if Exists(Select * from #Summary_Main Where NodeName = 'Diagnoses' and IsNull(NodeSummary,'') = '')
		Begin
			Update #Summary_Main Set NodeSummary = @DiagnosesNormalText
			Where NodeName = 'Diagnoses' and IsNull(NodeSummary,'') = ''
		End

	End

	 --  Color updating part 

	SELECT 
    NodeName,
	-- Highlight the word "Positive" if its immediate next word is "Urease" and if '- Specimens taken:' is found
    NodeSummary = 
        CASE 
            WHEN CHARINDEX('Specimens taken', NodeSummary) > 0 AND
                 CHARINDEX('Positive', NodeSummary) > 0 AND
                 CHARINDEX('Urease', SUBSTRING(NodeSummary, CHARINDEX('Positive', NodeSummary) + LEN('Positive') + 1, LEN(NodeSummary))) > 0
            THEN
                REPLACE(NodeSummary, 'Positive', '<span style="color: red;">Positive</span>')
            ELSE
                NodeSummary
        END,
		[Group]
	FROM 
		#Summary_Main 
	WHERE 
		NodeSummary IS NOT NULL;

	 -- Color updating part 

	DROP TABLE #Summary_Main

GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	3828 Ended
------------------------------------------------------------------------------------------------------------------------




------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ferdowsi Marufa
-- TFS#	  4310
-- Description of change
--   Peg Replacement added in the theraputices 
------------------------------------------------------------------------------------------------------------------------

GO

 
 IF NOT EXISTS( SELECT 1 FROM ERS_TherapeuticTypes  where Description = 'Peg Replacement')
 BEGIN
  INSERT INTO ERS_TherapeuticTypes ( [Description],[NedName],[OGD],[ERCP],[Colon] ,[Flexi],[SchedulerTherapeutic],[WhoUpdatedId],[WhoCreatedId],[WhenCreated],[WhenUpdated] ,[Proct] ,
  [EUS] ,[EUS_HPB],[Antegrade] ,[RecordId],[NEDRequired],[Retrograde],[Bronchs],[Cysto],[Bronch_Rigid],[Bronch_Flexi]) Values 
  ('Peg Replacement','Peg Replacement',1,0,0 ,0,1,NULL,0,GETDATE(),NULL ,1 ,1 ,0,0 ,NULL,1,1,0,0,0,0)
 END
 


GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS# 4310
 
------------------------------------------------------------------------------------------------------------------------


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ferdowsi Marufa
-- TFS#	  4408
-- Description of change
--   Food Bolus added in the theraputices 
------------------------------------------------------------------------------------------------------------------------

GO

 IF NOT EXISTS( SELECT 1 FROM ERS_TherapeuticTypes  where Description = 'Food Bolus')
 BEGIN
  INSERT INTO ERS_TherapeuticTypes ( [Description],[NedName],[OGD],[ERCP],[Colon] ,[Flexi],[SchedulerTherapeutic],[WhoUpdatedId],[WhoCreatedId],[WhenCreated],[WhenUpdated] ,[Proct] ,
  [EUS] ,[EUS_HPB],[Antegrade] ,[RecordId],[NEDRequired],[Retrograde],[Bronchs],[Cysto],[Bronch_Rigid],[Bronch_Flexi]) Values 
   ('Food Bolus','Food Bolus',1,1,0 ,0,1,NULL,0,GETDATE(),NULL ,1 ,1 ,1,1 ,NULL,1,1,0,0,0,0)
 END
 
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS# 4408
 
------------------------------------------------------------------------------------------------------------------------


