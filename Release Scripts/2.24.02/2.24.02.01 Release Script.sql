------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	
-- TFS#	
-- Description of change
-- 
------------------------------------------------------------------------------------------------------------------------
GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO

---------------------------------------------------------
-- Update script for release 2.24.02.xx
---------------------------------------------------------
DECLARE @Version AS VARCHAR(40) = '2.24.02.xx'

IF NOT EXISTS(SELECT * FROM DBversion WHERE VersionNum = @Version)
	BEGIN 
		-- First time the script has been run
		INSERT INTO DBVersion VALUES (@Version, GETDATE())
	END 
ELSE
	BEGIN 
		-- script run more than once
		DECLARE @DBVersionCount as INT 

		SELECT @DBVersionCount = COUNT(*) 
		FROM DBVersion WHERE VersionNum = @Version

		INSERT INTO DBVersion VALUES (@Version + ' (' + CONVERT(VARCHAR, @DBVersionCount) + ')', GETDATE())
	END 
GO
---------------------------------------------------------
GO 
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 07.03.24
-- TFS#	3821
-- Description of change
-- NED export procedure to exclude DNA procedures
------------------------------------------------------------------------------------------------------------------------
GO


ALTER PROCEDURE [dbo].[usp_NEDI2_Get_Unsent_Procedures]
AS
BEGIN
	select 
		prc.ProcedureId, 
		prc.operatingHospitalId, 
		ISNULL((SELECT TOP 1 ISNULL(ServiceId,'') FROM dbo.ERS_NedI2FilesLog enil WHERE enil.ProcedureID = prc.ProcedureId AND [Status] = 5),'') AS ServiceId, 
		createdon
	From dbo.ERS_Procedures prc 
		INNER JOIN ERS_ProcedureTypes pt ON pt.ProcedureTypeId = prc.ProcedureType, ERS_SystemConfig cnfg 
	where ( ProcedureCompleted = 1 
			and IsActive = 1 
			AND prc.DNA IS NULL 
			and cnfg.NEDEnabled = 1 
			and prc.operatingHospitalId = cnfg.operatingHospitalId 
			AND pt.NedExportRequired = 1 
			AND ISNULL(prc.NEDExported,0) = 0) 
		and CreatedOn >= (select min(InstallDate) from DBVersion where VersionNum like '2%')
END
GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO

GO 
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 07.03.24
-- TFS#	3822
-- Description of change
-- DICA scores non mandaotry scores excluded
------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 18.07.24
-- TFS#	
-- Description of change
-- Join changed to a WHERE clause
------------------------------------------------------------------------------------------------------------------------
GO


ALTER FUNCTION [dbo].[tvfNED_Diagnoses]
(	
	 @ProcedureType AS INT
	,@ProcedureId AS INT
)
RETURNS @Diagnoses TABLE (
	Ned_Name VARCHAR(200),
	Tattooed VARCHAR(3),
	[site] VARCHAR(100),
	Comment  VARCHAR(1000),
	barrettsLengthCircumferential INT,
	barrettsLengthMaximum INT,
	barretsInspectionTime INT,
	gastricInspectiontime INT,
	oesophagitisLaClassification VARCHAR(2),
	DICAScore INT,
	UCEIS INT,
	mayoScore INT,
	rutgeertsScore VARCHAR(2),
	CDEIS INT
)
AS
BEGIN
	IF NOT EXISTS (SELECT 1 FROM ERS_Diagnoses WHERE ProcedureId = @ProcedureId AND MatrixCode NOT IN ('Summary','D138P2','D33P2', 'D51P2','D67P2'))
	BEGIN
		INSERT INTO @Diagnoses
		--## There are few Exception 'Diagnoses' Code.. Which doesn't exist int he DiagnosesMatrix.Code field. So- read them separately
			SELECT TOP 1 --## 'Top 1' Because- it can be like: "'OverallNormal', 'DuodenumNormal', 'OesophagusNormal', 'StomachNormal'"- and we need only once to show 'Normal!'
				  'Normal' AS Ned_Name
				, NULL	AS Tattooed
				, 'None' AS site		
				, NULL	AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL AS oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
	END
	ELSE IF EXISTS (SELECT 1 FROM ERS_Diagnoses WHERE ProcedureId = @ProcedureId AND MatrixCode = 'OverallNormal')
	BEGIN
		INSERT INTO @Diagnoses
		--## There are few Exception 'Diagnoses' Code.. Which doesn't exist int he DiagnosesMatrix.Code field. So- read them separately
			SELECT TOP 1 --## 'Top 1' Because- it can be like: "'OverallNormal', 'DuodenumNormal', 'OesophagusNormal', 'StomachNormal'"- and we need only once to show 'Normal!'
				  'Normal' AS Ned_Name
				, NULL	AS Tattooed
				, 'None' AS site		
				, NULL	AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL AS oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
	END
	ELSE IF EXISTS (SELECT 1 FROM ERS_Diagnoses WHERE ProcedureId = @ProcedureId AND MatrixCode = 'ColonNormal')
	BEGIN
		INSERT INTO @Diagnoses
		--## There are few Exception 'Diagnoses' Code.. Which doesn't exist int he DiagnosesMatrix.Code field. So- read them separately
			SELECT TOP 1 --## 'Top 1' Because- it can be like: "'OverallNormal', 'DuodenumNormal', 'OesophagusNormal', 'StomachNormal'"- and we need only once to show 'Normal!'
				  'Normal' AS Ned_Name
				, NULL	AS Tattooed
				, 'None' AS site		
				, NULL	AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL AS oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
	END
	ELSE
	BEGIN
		INSERT INTO @Diagnoses
		   SELECT 'Colorectal cancer' AS Ned_Name
				, CASE WHEN ISNULL(T.TattooedId, 0) = 1 THEN 'No' WHEN ISNULL(T.TattooedId, 0) = 2 THEN 'Yes' END AS tattooed	--## 'Colonic polyps or Rectal polyps' => Colon/FLexi ONLY! 
				, dbo.fnNED_GetBiopsySiteName(P.ProcedureId, R.Region) AS Site		--## Location of tattoo. BiopsyEnum (Page 42, in Business Spec.doc v.1.15): The Biopsy field is procedure specific. See the BiopsyEnum table for further information.
				, NULL AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL AS oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
			 FROM [dbo].[ERS_Diagnoses] D
		--LEFT JOIN [dbo].[ERS_DiagnosesMatrix]	AS M ON D.MatrixCode = M.Code
		LEFT JOIN [dbo].[ERS_Procedures]		AS P ON D.ProcedureID = P.ProcedureId
		LEFT JOIN dbo.ERS_Sites		AS S ON D.SiteId = S.SiteId
		LEFT JOIN dbo.ERS_Regions	AS R ON S.RegionId = R.RegionId
		LEFT JOIN dbo.ERS_ColonAbnoTumour T ON T.SiteId = S.SiteID
			WHERE D.ProcedureId= @ProcedureId
			  AND P.ProcedureType IN(3,4,9)	--## Only for OGD/Colon/FLEXI! NOT for ERCP! - NO, Colon and Flexi only. How can you get colon cancer in an OGD procedure? - Don't forget ENT procedures, but really, we don't need this line as it should be taken care of by the matrix code on the next line
			  AND D.MatrixCode IN ('S69P3', 'D69P3')  --## 'Colorectal cancer'

		UNION ALL
		SELECT 'Barrett''s oesophagus' AS Ned_Name
				, NULL AS tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END AS [Site]
				, NULL AS Comment
				, B.DistanceM2 AS barrettsLengthCircumferential
				, B.DistanceM1 AS barrettsLengthMaximum
				, B.InspectionTimeMins AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
			 FROM [dbo].[ERS_Diagnoses] D
		LEFT JOIN [dbo].[ERS_Procedures]		AS P ON D.ProcedureID = P.ProcedureId
		LEFT JOIN dbo.ERS_Sites		AS S ON D.SiteId = S.SiteId
		LEFT JOIN ERS_Regions		AS R ON R.RegionId = S.RegionId
		left join dbo.ERS_UpperGIAbnoBarrett AS B on B.SiteId = S.SiteId 
			WHERE D.ProcedureId= @ProcedureId 
			  AND P.ProcedureType IN(1, 2, 6, 8)	--## Only for upper procedures
			  AND D.MatrixCode IN ('D23P1')  --## Barrett's oesophagus

		UNION ALL
		SELECT 'Gastric atrophy' AS Ned_Name
				, NULL AS tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END As [Site]	
				, NULL AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, datediff(minute, G.GastricInspectionStartDateTime, G.GastricInspectionEndDateTime) AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
			 FROM [dbo].[ERS_Diagnoses] D
		--LEFT JOIN [dbo].[ERS_DiagnosesMatrix]	AS M ON D.MatrixCode = M.Code
		LEFT JOIN [dbo].[ERS_Procedures]		AS P ON D.ProcedureID = P.ProcedureId
		LEFT JOIN dbo.ERS_Sites		AS S ON D.SiteId = S.SiteId
		LEFT JOIN ERS_Regions		AS R ON R.RegionId = S.RegionId
		left join dbo.ERS_UpperGIAbnoGastritis AS G on G.SiteId = S.SiteId 
			WHERE D.ProcedureId= @ProcedureId
			  AND P.ProcedureType IN(1, 2, 6, 8)	--## Only for upper procedures
			  AND D.MatrixCode IN ('N2006')

		UNION ALL
		SELECT top 1 M.NED_Name
				, NULL AS tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END As [Site]
				, NULL AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, CASE O.LAClassification 
					WHEN 1 THEN 'A'
					WHEN 2 THEN 'B'
					WHEN 3 THEN 'C'
					WHEN 4 THEN 'D'
				  END as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
			 FROM [dbo].[ERS_Diagnoses] D
		LEFT JOIN [dbo].[ERS_DiagnosesMatrix]	AS M ON D.MatrixCode = M.Code
		LEFT JOIN [dbo].[ERS_Procedures]		AS P ON D.ProcedureID = P.ProcedureId
		LEFT JOIN dbo.ERS_Sites		AS S ON D.SiteId = S.SiteId
		LEFT JOIN ERS_Regions		AS R ON R.RegionId = S.RegionId
		left join dbo.ERS_UpperGIAbnoOesophagitis AS O on O.SiteId = S.SiteId 
			WHERE D.ProcedureId= @ProcedureId
			  AND P.ProcedureType IN(1, 2, 6, 8)	--## Only for upper procedures
			  AND D.MatrixCode IN ('D36P1') --Oesophagitis - reflux

		UNION ALL	
		select DISTINCT --## DISTINCT REQUIRED- When in Stomach- 3 sites - all has Polyps and Gastric- then they will repeat.
				  'Other'
				, NULL	AS Tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END As [Site]		
				, eugm.MiscOther AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
		FROM ERS_diagnoses AS D
		INNER JOIN [dbo].[ERS_DiagnosesMatrix] AS M ON D.MatrixCode = M.Code
		INNER JOIN ERS_Sites S ON D.SiteId = S.SiteId
			INNER JOIN ERS_Regions R ON s.RegionId = R.RegionId
			INNER JOIN dbo.ERS_UpperGIAbnoMiscellaneous eugm ON S.SiteId = eugm.SiteId
		where D.ProcedureId= @ProcedureId 
			AND M.NED_Include = 1
			AND M.ProcedureTypeID = @ProcedureType
			AND M.DisplayName = 'Other'
		
		UNION ALL	-- dbo.fnNED_GetBiopsySiteName(P.ProcedureId, R.Region)
		select DISTINCT --## DISTINCT REQUIRED- When in Stomach- 3 sites - all has Polyps and Gastric- then they will repeat.
				  'Other'
				, NULL	AS Tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END As [Site]		
				, eugm.OtherDesc AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
		FROM ERS_diagnoses AS D
		INNER JOIN [dbo].[ERS_DiagnosesMatrix] AS M ON D.MatrixCode = M.Code
		INNER JOIN ERS_Sites S ON D.SiteId = S.SiteId
			INNER JOIN ERS_Regions R ON s.RegionId = R.RegionId
			INNER JOIN dbo.ERS_CommonAbnoDiverticulum eugm ON S.SiteId = eugm.SiteId
		where D.ProcedureId= @ProcedureId 
			AND M.NED_Include = 1
			AND M.ProcedureTypeID = @ProcedureType
			AND M.DisplayName = 'Other'
		UNION ALL
		select DISTINCT --## DISTINCT REQUIRED- When in Stomach- 3 sites - all has Polyps and Gastric- then they will repeat.
				  'Other'
				, NULL	AS Tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END As [Site]		
				, eugm.Other AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
		FROM ERS_diagnoses AS D
		INNER JOIN [dbo].[ERS_DiagnosesMatrix] AS M ON D.MatrixCode = M.Code
		INNER JOIN ERS_Sites S ON D.SiteId = S.SiteId
			INNER JOIN ERS_Regions R ON s.RegionId = R.RegionId
			INNER JOIN dbo.ERS_ERCPAbnoDiverticulum eugm ON S.SiteId = eugm.SiteId
		where D.ProcedureId= @ProcedureId 
			AND M.NED_Include = 1
			AND M.ProcedureTypeID = @ProcedureType
			AND M.DisplayName = 'Other'
		UNION ALL
		select DISTINCT --## DISTINCT REQUIRED- When in Stomach- 3 sites - all has Polyps and Gastric- then they will repeat.
				  'Other'
				, NULL	AS Tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE dbo.fnNED_GetBiopsySiteName(S.ProcedureId, R.Region) END As [Site]		
				, eugm.Other AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
		FROM ERS_diagnoses AS D
		INNER JOIN [dbo].[ERS_DiagnosesMatrix] AS M ON D.MatrixCode = M.Code
		INNER JOIN ERS_Sites S ON D.SiteId = S.SiteId
			INNER JOIN ERS_Regions R ON s.RegionId = R.RegionId
			INNER JOIN dbo.ERS_ColonAbnoMiscellaneous eugm ON S.SiteId = eugm.SiteId
		where D.ProcedureId= @ProcedureId 
			AND M.NED_Include = 1
			AND M.ProcedureTypeID = @ProcedureType
			AND M.DisplayName = 'Other'
		UNION ALL				
		select DISTINCT --## DISTINCT REQUIRED- When in Stomach- 3 sites - all has Polyps and Gastric- then they will repeat.
				  M.Ned_Name
				, NULL	AS Tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END As [Site]		
				, NULL	AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
		FROM ERS_diagnoses AS D
		INNER JOIN [dbo].[ERS_DiagnosesMatrix] AS M ON D.MatrixCode = M.Code
		INNER JOIN ERS_Sites S ON D.SiteId = S.SiteId
			INNER JOIN ERS_Regions R ON s.RegionId = R.RegionId
		where D.ProcedureId= @ProcedureId 
			AND M.Ned_Name IS NOT NULL --## I mean select the 'NED Mapped' fields ONLY!
			AND M.NED_Include = 1
			AND M.ProcedureTypeID = @ProcedureType
			AND D.MatrixCode NOT IN ('D70P3', 'S69P3', 'D69P3', 'D23P1', 'N2006', 'D36P1', 'D86P3', 'D96P3', 'S96P3', 'D1P3', 'N2015','S1P3','D1P3','P1P3','D1P9') -- don't include Colorectal cancer, barretts, Gastric atrophy, Oesophagitis, Diverticulosis - reflux or proctitus, they are already done 
			AND M.DisplayName <> 'Other'

		UNION ALL					--## Combine 'OTHER' type of Diagnoses! Which Doesn't have a NED Name mapping!
			select top 1
			  'Other' AS DisplayName
			, NULL	AS Tattooed
			, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END As [Site]				
		
			, 
			(select 
				  (/*Section + ' ' +*/ M.DisplayName) + ', ' 
			FROM ERS_diagnoses AS D 
			LEFT JOIN [dbo].[ERS_DiagnosesMatrix] AS M ON D.MatrixCode = M.Code
			where D.ProcedureId= @ProcedureId
				AND M.Ned_Name IS NULL --## 'NED Mapped' is Missing
				--AND D.MatrixCode NOT IN ('D198P2', 'D265P2', 'D32P2', 'D33P2', 'D51P2', 'D67P2','D138P2') --## Diagnoses thinks these Exceptions belongs to others.. Because these are not Mapped to NED seperately
				AND D.MatrixCode not in ('N257P1', 'D70P3', 'D21P3', 'S21P3', 'D100P1','N2016', 'SN2016', 'N100P2') -- Could be NED field for Chrones, need to work that out, see next select
				AND M.NED_Include = 1
				AND D.SiteId = S.SiteId
				AND M.ProcedureTypeID = @ProcedureType
				FOR XML PATH('')
			) AS Comment		--## All the fields which are not in the 'NED Restricted Lookup' list!
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
		FROM ERS_diagnoses AS D
		INNER JOIN [dbo].[ERS_DiagnosesMatrix] AS M ON D.MatrixCode = M.Code --## InnerJoin- to avoid keeping anything which Codes (Summary, OverallNormal) don't exist in the Matrix Table.. WIll exclude them...
		INNER JOIN ERS_Sites S ON D.SiteId = S.SiteId
			INNER JOIN ERS_Regions R ON s.RegionId = R.RegionId
			where D.ProcedureId= @ProcedureId
			AND M.Ned_Name IS NULL --## Means when 'NED Mapped' is Missing- those belong to 'Other' type 
			AND D.MatrixCode not in ('N257P1', 'D21P3', 'S21P3', 'D100P1','N2016', 'SN2016', 'N100P2')
			AND M.NED_Include = 1
			AND M.ProcedureTypeID = @ProcedureType
		UNION ALL
			Select top 1 'Crohn''s - terminal ileum'
				, NULL	AS Tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE dbo.fnNED_GetBiopsySiteName(S.ProcedureId, R.Region) END As [Site]		
				, NULL	AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, CASE WHEN dbo.fnNED_ProcedureExtent(@ProcedureId, 0) = 'Neo-terminal ileum' THEN rs.NEDTerm ELSE NULL END AS rutgeertsScore
				, CDEISScore AS CDEIS
			FROM ERS_ColonAbnoMucosa C
			join ERS_Sites S on S.SiteId = C.SiteId
			INNER JOIN ERS_Regions R ON S.RegionId = R.RegionId
			LEFT JOIN ERS_RutgeertsScores rs ON rs.UniqueId = C.RutgeertsScore
			where C.InflammatoryIleitis	 = 1 AND c.InflammatoryDisorder = 2
			AND S.ProcedureId = @ProcedureId 
		UNION ALL
			Select top 1 'Crohn''s colitis'
				, NULL	AS Tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE dbo.fnNED_GetBiopsySiteName(S.ProcedureId, R.Region) END As [Site]		
				, NULL	AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, CASE WHEN dbo.fnNED_ProcedureExtent(@ProcedureId, 0) = 'Neo-terminal ileum' THEN rs.NEDTerm ELSE NULL END AS rutgeertsScore
				, CDEISScore AS CDEIS
			FROM ERS_ColonAbnoMucosa C
			join ERS_Sites S on S.SiteId = C.SiteId
			INNER JOIN ERS_Regions R ON S.RegionId = R.RegionId
			LEFT JOIN ERS_RutgeertsScores rs ON rs.UniqueId = C.RutgeertsScore
			where C.InflammatoryColitis = 1 AND c.InflammatoryDisorder = 2
			AND S.ProcedureId = @ProcedureId 

		UNION ALL
			Select top 1 'Proctitis'
				, NULL	AS Tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END As [Site]		
				, NULL	AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
			FROM ERS_ColonAbnoMucosa C
			join ERS_Sites S on S.SiteId = C.SiteId
			INNER JOIN ERS_Regions R ON S.RegionId = R.RegionId
			where C.InflammatoryProctitis = 1
			AND S.ProcedureId = @ProcedureId 
	
	
		UNION ALL
			Select top 1 'Colitis - unspecified'
				, NULL	AS Tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END As [Site]		
				, NULL	AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
			FROM ERS_ColonAbnoMucosa C
			join ERS_Sites S on S.SiteId = C.SiteId
			INNER JOIN ERS_Regions R ON S.RegionId = R.RegionId
			where C.InflammatoryDisorder = 1
			AND S.ProcedureId = @ProcedureId 

		UNION ALL
			Select top 1 'Colitis - pseudomembranous'
				, NULL	AS Tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END As [Site]		
				, NULL	AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
			FROM ERS_ColonAbnoMucosa C
			join ERS_Sites S on S.SiteId = C.SiteId
			INNER JOIN ERS_Regions R ON S.RegionId = R.RegionId
			where C.InflammatoryDisorder = 10
			AND S.ProcedureId = @ProcedureId 

		UNION ALL
			Select top 1 'Colitis - ischemic'
				, NULL	AS Tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END As [Site]		
				, NULL	AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
			FROM ERS_ColonAbnoMucosa C
			join ERS_Sites S on S.SiteId = C.SiteId
			INNER JOIN ERS_Regions R ON S.RegionId = R.RegionId
			where C.InflammatoryDisorder = 8
			AND S.ProcedureId = @ProcedureId 

		UNION ALL
			Select top 1 'Diverticulosis'
				, NULL	AS Tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END As [Site]		
				, NULL	AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, isnull(ePoints.Points, 0) + isnull(GPoints.Points, 0) + isnull(IPoints.points, 0) + isnull(CPoints.Points, 0) AS DICAScore -- THIS IS NEEDED HERE
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
			FROM ERS_ColonAbnoMucosa C
			join ERS_Sites S on S.SiteId = C.SiteId
			INNER JOIN ERS_Regions R ON S.RegionId = R.RegionId
			JOIN ERS_ProcedureDICAScores D on S.SiteId = D.SiteId 
			INNER join ERS_DICAScores ePoints on D.ExtensionId = ePoints.UniqueId
			INNER join ERS_DICAScores GPoints on D.GradeId = gPoints.UniqueId
			left join ERS_DICAScores iPoints on D.InflammatorySignsId = iPoints.UniqueId
			left join ERS_DICAScores CPoints on D.ComplicationsId = cPoints.UniqueId
			where C.InflammatoryDisorder = 4
			AND S.ProcedureId = @ProcedureId 
		
		UNION ALL
			Select top 1 'Diverticulosis'
				, NULL	AS Tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END As [Site]		
				, NULL	AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, isnull(ePoints.Points, 0) + isnull(GPoints.Points, 0) + isnull(IPoints.points, 0) + isnull(CPoints.Points, 0) AS DICAScore -- THIS IS NEEDED HERE
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
			FROM ERS_ColonAbnoDiverticulum C
			INNER join ERS_Sites S on S.SiteId = C.SiteId
			INNER JOIN ERS_Regions R ON S.RegionId = R.RegionId
			INNER JOIN ERS_ProcedureDICAScores D on S.SiteId = D.SiteId 
			INNER join ERS_DICAScores ePoints on D.ExtensionId = ePoints.UniqueId
			INNER join ERS_DICAScores GPoints on D.GradeId = gPoints.UniqueId
			LEFT join ERS_DICAScores iPoints on D.InflammatorySignsId = iPoints.UniqueId
			LEFT join ERS_DICAScores CPoints on D.ComplicationsId = cPoints.UniqueId
			WHERE S.ProcedureId = @ProcedureId 
		UNION ALL
			Select top 1 'Ulcerative colitis'
				, NULL	AS Tattooed
				, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE isnull(R.NED_Term, 'Colon') END As [Site]		
				, NULL	AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, (Select sum(points) from ERS_UCEISScores where UniqueId in (VascularPatternUCEISScore, BleedingUCEISScore, ErosionsUCEISScore)) AS UCEIS
				, InflammatoryMayoScore AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
			FROM ERS_ColonAbnoMucosa C
			join ERS_Sites S on S.SiteId = C.SiteId
			Left JOIN ERS_Regions R ON s.RegionId = R.RegionId
			where C.InflammatoryDisorder = 12
			AND S.ProcedureId = @ProcedureId 

		

		UNION ALL--## Handles colotis diagnosis as the diagnoses matrix table is joined on ERS_Diagnoses 'value' column rather than the 'code' column
			SELECT 
			  ISNULL(NED_Name,'Colitis - unspecified') AS NED_Name
			, NULL	AS Tattooed
			, CASE WHEN EXISTS (SELECT 1 FROM ERS_Sites WHERE ProcedureId = s.ProcedureId AND AreaNo > 0) THEN dbo.fnNED_GetMarkedArea(S.ProcedureId, s.SiteId) ELSE R.NED_Term END As [Site]		
			, NULL	AS Comment
				, NULL AS barrettsLengthCircumferential
				, NULL AS barrettsLengthMaximum
				, NULL AS barretsInspectionTime
				, NULL AS gastricInspectiontime
				, NULL as oesophagitisLaClassification
				, NULL AS DICAScore
				, NULL AS UCEIS
				, NULL AS mayoScore
				, NULL AS rutgeertsScore
				, NULL AS CDEIS
			FROM ERS_Diagnoses d
				INNER JOIN dbo.ERS_DiagnosesMatrix edm	ON code=value
			INNER JOIN ERS_Sites S ON S.SiteId = d.SiteId
			INNER JOIN ERS_Regions R ON S.RegionId = R.RegionId
			WHERE d.MatrixCode='ColitisType'  AND d.procedureid=@ProcedureId	
			AND edm.ProcedureTypeID = @ProcedureType

		UNION ALL
		SELECT DISTINCT --## DISTINCT REQUIRED- When in Stomach- 3 sites - all has Polyps and Gastric- then they will repeat.
					  M.Ned_Name
					, NULL AS tattooed	--## 'Colonic polyps or Rectal polyps' => Colon/FLexi ONLY! 
					, 'Colon' As [Site]		
					, NULL	AS Comment
					, NULL AS barrettsLengthCircumferential
					, NULL AS barrettsLengthMaximum
					, NULL AS barretsInspectionTime
					, NULL AS gastricInspectiontime
					, NULL as oesophagitisLaClassification
					, NULL AS DICAScore
					, NULL AS UCEIS
					, NULL AS mayoScore
					, NULL AS rutgeertsScore
					, NULL AS CDEIS
			FROM ERS_diagnoses AS D
			INNER JOIN [dbo].[ERS_DiagnosesMatrix] AS M ON D.MatrixCode = M.Code
			INNER JOIN ERS_Sites S ON D.SiteId = S.SiteId
			where D.ProcedureId= @ProcedureId 
				AND M.Ned_Name IS NOT NULL --## I mean select the 'NED Mapped' fields ONLY!
				AND M.NED_Include = 1
				AND M.ProcedureTypeID = @ProcedureType
				AND SiteNo = -77 --site by distance diagnoses
				and M.Ned_Name <> 'Ulcerative Colitis'
	
	END
	If (Select 1 from @Diagnoses where Ned_Name = 'Gastric atrophy') > 0
		Delete from @Diagnoses where Ned_Name = 'Gastritis - non-erosive'

	RETURN ;
END

/* columns returned
   ----------------
    Ned_Name
    Tattooed
    Comment
	barrettsLengthCircumferential	--Required for diagnosis of Barretts
	barrettsLengthMaximum			--Required for diagnosis of Barretts
	barretsInspectionTime			--Required for diagnosis of Barretts
	gastricInspectiontime			--Required if diagnosis of gastric atrophy OR gastric intestinal metaplasia
	oesophagitisLaClassification	--Required if diagnosis of Oesophagitis - reflux
	DICAScore						--required if diagnosis of Diverticulosis
	UCEIS							--If diagnosis is ‘Ulcerative Colitis’ both UCEIS and Mayo scores must be provided
	mayoScore						--If diagnosis is ‘Ulcerative Colitis’ both UCEIS and Mayo scores must be provided
	site							--If diagnosis is ‘Crohns Colitis’ or ‘Crohn`s- terminal ileum’ and [ExtentLookup]= ‘Neo-terminal ileum’
	rutgeertsScore					--If diagnosis is ‘Crohns Colitis’ or ‘Crohn`s- terminal ileum’ and [ExtentLookup]= ‘Neo-terminal ileum’
	CDEIS							--If diagnosis is ‘Crohns Colitis’ or ‘Crohn`s- terminal ileum’
*/
GO



GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 07.03.24
-- TFS#	3823
-- Description of change
-- NED Definition change
------------------------------------------------------------------------------------------------------------------------
GO

IF EXISTS (SELECT 1 FROM dbo.ERS_DiagnosesMatrix WHERE NED_Name = 'Gallbladder stone(s)')
BEGIN
    UPDATE dbo.ERS_DiagnosesMatrix SET NED_Name = 'Gallbladder stones' WHERE NED_Name = 'Gallbladder stone(s)'
END
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Duncan 
-- TFS#	XXXX
-- Description of change
-- Delete procedures not recording user name of the person who deleted.
------------------------------------------------------------------------------------------------------------------------
GO
ALTER PROCEDURE [dbo].[usp_Procedures_Delete]
(
	@ProcedureId INT,
	@UserId INT
)
AS

--## We should not delete any record from the Transactional Database.. Only Flag it as Inactive..
	UPDATE ERS_Procedures 
	   SET	IsActive = 0,
			WhoUpdatedId = @UserId,
			WhenUpdated = GETDATE()
	 WHERE ProcedureId  = @ProcedureId;

	 --Insert into OCS Process table to mark as deleted
	 INSERT INTO ERS_OCS_Process (Process, ProcedureId, TrustId, isDeletion)
	 SELECT 'ORU|' + CONVERT(VARCHAR, p.PatientId) + '||' + CONVERT(VARCHAR, p.ProcedureId) + '||PDF|0', p.ProcedureId, op.TrustId, 1
	 FROM ERS_Procedures p
	 JOIN ERS_OperatingHospitals op ON p.OperatingHospitalID = op.OperatingHospitalId 
	 WHERE ProcedureId = @ProcedureId

GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 12.02.24
-- TFS#	3861
-- Description of change
-- List points converted to decimal to handle half points
------------------------------------------------------------------------------------------------------------------------
Go
Exec DropIfExist 'trg_ERS_Procedures_Update','TR'
Go

CREATE TRIGGER [dbo].[trg_ERS_Procedures_Update] ON [dbo].[ERS_Procedures] 
AFTER UPDATE
AS 
--26 Feb 2024		:		MH allowing changing PatientId but logging in
SET NOCOUNT ON; 

IF UPDATE([PatientId])
BEGIN
   --;THROW 51000, 'Update the Patient ID is forbidden', 1;  
   --Rollback transaction
   Declare @ProductVersion varchar(50), @ErrorMessage varchar(200), @ErrorReference varchar(50)
   Declare @UserId Int,@ProcedureId Int,@PatientId Int, @OldPatientId int, @OperatingHospitalId int
   Select @UserId = IsNull(WhoCreatedId,1),@ProcedureId = ProcedureId,@PatientId = PatientId,@OperatingHospitalId=OperatingHospitalID from inserted
   Select @OldPatientId = PatientId from deleted
   
   If @UserId is null Set @UserId = 1
   If @OperatingHospitalId is null 
   Begin
	Select top 1 @OperatingHospitalId = OperatingHospitalId from ERS_OperatingHospitals
   End
	Set @ErrorMessage = 'Old PatientId : ' + Convert(varchar(20),@OldPatientId) + ', New PatientId : ' + Convert(varchar(20),@PatientId)
	Set @ErrorReference = 'PATCHANGE_' + CONVERT(VARCHAR(30), getdate(), 112) + REPLACE(CONVERT(VARCHAR(30), getdate(), 108), ':', '')
			Select top 1 @ProductVersion = VersionNum from DBVersion Order by InstallDate desc			
			
			Insert into ERS_ErrorLog(ErrorReference,ErrorTimestamp,ErrorNo,ErrorMessage,ErrorDescription,ProductId,ProductVersion,UserId,ProcedureId,PatientId,HospitalId,OperatingHospitalId)
			Values(@ErrorReference,GETDATE(),Convert(varchar(30), @ProcedureId), 'PatientId is being changed.', @ErrorMessage,1, @ProductVersion, @UserId,@ProcedureId,@PatientId,@OperatingHospitalId,@OperatingHospitalId)

END

INSERT INTO [ERSAudit].[ERS_Procedures_Audit] (ProcedureId, tbl.[ProcedureType], tbl.[CreatedBy], tbl.[CreatedOn], tbl.[ModifiedOn], tbl.[PatientId], tbl.[PatientType], tbl.[PatientStatus], tbl.[Ward], tbl.[CategoryListId], tbl.[OnWaitingList], tbl.[OpenAccessProc], tbl.[EmergencyProcType], tbl.[OperatingHospitalID], tbl.[ReferralHospitalNo], tbl.[ReferralConsultantNo], tbl.[GPReferralFlag], tbl.[DiagramNumber], tbl.[ListType], tbl.[ListConsultant], tbl.[ConsultantPresent], tbl.[Endoscopist1], tbl.[Endo1Role], tbl.[Endoscopist2], tbl.[Endo2Role], tbl.[Assistant], tbl.[Nurse1], tbl.[Nurse2], tbl.[Nurse3], tbl.[Instrument1], tbl.[Instrument2], tbl.[ResectedColonNo], tbl.[IncludeProcNotes], tbl.[ProcedureNotes], tbl.[Video], tbl.[VideoNotes], tbl.[GPReportText], tbl.[TextEdited], tbl.[DiagramIncluded], tbl.[EndoscribeComments], tbl.[EndoscribePremedication], tbl.[MucosalJunctionAt], tbl.[NewCardia], tbl.[AbnoText], tbl.[PancreasDivisum], tbl.[BiliaryManometry], tbl.[PancreaticManometry], tbl.[FirstERCP], tbl.[ExportedToEPR], tbl.[ForcepType], tbl.[ForcepSerialNo], tbl.[AccountNo], tbl.[DNA], tbl.[DNACombined], tbl.[DNACreatedViaRC], tbl.[ExportFileName], tbl.[ExportProducedOn], tbl.[ReferralConsultantSpeciality], tbl.[PatientConsent], tbl.[SurgicalSafetyCheckListCompleted], tbl.[GPCode], tbl.[GPPracticeCode], tbl.[NEDEnabled], tbl.[NEDExported], tbl.[NEDProcedureId], tbl.[ScopeGuide], tbl.[FormerProcedureId], tbl.[ProcedureCompleted], tbl.[IsDirty], tbl.[IsActive], tbl.[BreathTestResult], tbl.[ImagePortId], tbl.[Transnasal], tbl.[ReportUpdated],  LastActionId, ActionDateTime, ActionUserId)
SELECT tbl.ProcedureId , tbl.[ProcedureType], tbl.[CreatedBy], tbl.[CreatedOn], tbl.[ModifiedOn], tbl.[PatientId], tbl.[PatientType], tbl.[PatientStatus], tbl.[Ward], tbl.[CategoryListId], tbl.[OnWaitingList], tbl.[OpenAccessProc], tbl.[EmergencyProcType], tbl.[OperatingHospitalID], tbl.[ReferralHospitalNo], tbl.[ReferralConsultantNo], tbl.[GPReferralFlag], tbl.[DiagramNumber], tbl.[ListType], tbl.[ListConsultant], tbl.[ConsultantPresent], tbl.[Endoscopist1], tbl.[Endo1Role], tbl.[Endoscopist2], tbl.[Endo2Role], tbl.[Assistant], tbl.[Nurse1], tbl.[Nurse2], tbl.[Nurse3], tbl.[Instrument1], tbl.[Instrument2], tbl.[ResectedColonNo], tbl.[IncludeProcNotes], tbl.[ProcedureNotes], tbl.[Video], tbl.[VideoNotes], tbl.[GPReportText], tbl.[TextEdited], tbl.[DiagramIncluded], tbl.[EndoscribeComments], tbl.[EndoscribePremedication], tbl.[MucosalJunctionAt], tbl.[NewCardia], tbl.[AbnoText], tbl.[PancreasDivisum], tbl.[BiliaryManometry], tbl.[PancreaticManometry], tbl.[FirstERCP], tbl.[ExportedToEPR], tbl.[ForcepType], tbl.[ForcepSerialNo], tbl.[AccountNo], tbl.[DNA], tbl.[DNACombined], tbl.[DNACreatedViaRC], tbl.[ExportFileName], tbl.[ExportProducedOn], tbl.[ReferralConsultantSpeciality], tbl.[PatientConsent], tbl.[SurgicalSafetyCheckListCompleted], tbl.[GPCode], tbl.[GPPracticeCode], tbl.[NEDEnabled], tbl.[NEDExported], tbl.[NEDProcedureId], tbl.[ScopeGuide], tbl.[FormerProcedureId], tbl.[ProcedureCompleted], tbl.[IsDirty], tbl.[IsActive], tbl.[BreathTestResult], tbl.[ImagePortId], tbl.[Transnasal], tbl.[ReportUpdated],  2, GETDATE(), i.WhoUpdatedId
FROM deleted tbl INNER JOIN inserted i ON tbl.ProcedureId = i.ProcedureId

------------------------------------------------------------------------------------------------------------------------
-- END OF ALTER TRIGGER 
------------------------------------------------------------------------------------------------------------------------
Go

Go
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Mahfuz	On 20 Mar 2024
-- TFS#	3901
-- Description of change
-- Patient Search with Date of birth where DOB has also hour time values
------------------------------------------------------------------------------------------------------------------------
Go

EXEC DropIfExist 'startup_select','S';
GO
CREATE PROCEDURE [dbo].[startup_select] (
	@SearchString1 VARCHAR(500)			--CaseNoteNo
	,@SearchString2 VARCHAR(500)		--NHSNo
	,@SearchString3 VARCHAR(500)		--Surname
	,@SearchString4 VARCHAR(500)		--Forename
	,@SearchString5 VARCHAR(500)		--DOB
	,@SearchString6 VARCHAR(500)		--Address
	,@SearchString7 VARCHAR(500)		--Postcode
	,@searchGender Varchar(500)			--Gender
	,@SearchTab INT = 0					
	,@Condition VARCHAR(50) = ''		
	,@SearchType VARCHAR(50)
	,@ExcludeDeceased BIT = 0			--ExcludeDeadOption
	,@UserId INT						--UserId
	,@UserName NVARCHAR(500)			--UserName
	,@TrustId int )
AS
/*	Update History		:		07 Sept 2022 MH copied from SE1 - treat single quote in name, fix duplicate NHSNo (Isminor) etc 
						:		18 Nov 2022 MH implemented Soundex (pronounced like) search on Patient Surname and Forename TFS 2446
						:		06 Jun 2023 MH added search with Gender - Parameter value will be M, F, U or T or NULL/ ''
						:		20 Mar 2024 MH fixed date of birth search issue TFS 3901
*/
DECLARE @Statement NVARCHAR(max)
DECLARE @Statement2 NVARCHAR(max)
DECLARE @SearchCriteria INT
	,@SearchCriteriaOption INT
	,@SearchCriteriaOptionPatientCount INT
	,@SearchCriteriaOptionDate DATETIME
	,@SearchCriteriaOptionMonths INT
	,@ExcludeDeadOption BIT
	,@ExcludeUGI BIT
	,@AllProcedures BIT
	,@Gastroscopy BIT
	,@ERCP BIT
	,@Colonoscopy BIT
	,@Proctoscopy BIT
	,@OutstandingCLO BIT
	,@OrderListOptions INT


--MH replaces single ' with '' in Surname and Forename variables.
Set @SearchString3 = Replace(@SearchString3,'''','''''')
Set @SearchString4 = Replace(@SearchString4,'''','''''')

IF EXISTS (SELECT 1 FROM ERS_StartupSettings WHERE ISNULL(UserId,0) = @UserId)
	SELECT TOP (1) @SearchCriteria = [SearchCriteria]
		,@SearchCriteriaOption = [SearchCriteriaOption]
		,@SearchCriteriaOptionPatientCount = [SearchCriteriaOptionPatientCount]
		,@SearchCriteriaOptionDate = [SearchCriteriaOptionDate]
		,@SearchCriteriaOptionMonths = [SearchCriteriaOptionMonths]
		,@ExcludeDeadOption = [ExcludeDeadOption]
		,@ExcludeUGI = [ExcludeUGI]
		,@AllProcedures = [AllProcedures]
		,@Gastroscopy = [Gastroscopy]
		,@ERCP = [ERCP]
		,@Colonoscopy = [Colonoscopy]
		,@Proctoscopy = [Proctoscopy]
		,@OutstandingCLO = [OutstandingCLO]
		,@OrderListOptions = [OrderListOptions]
	FROM [ERS_StartupSettings]
	WHERE UserID = @UserId
ELSE
	SELECT TOP (1) @SearchCriteria = [SearchCriteria]
	,@SearchCriteriaOption = [SearchCriteriaOption]
	,@SearchCriteriaOptionPatientCount = [SearchCriteriaOptionPatientCount]
	,@SearchCriteriaOptionDate = [SearchCriteriaOptionDate]
	,@SearchCriteriaOptionMonths = [SearchCriteriaOptionMonths]
	,@ExcludeDeadOption = [ExcludeDeadOption]
	,@ExcludeUGI = [ExcludeUGI]
	,@AllProcedures = [AllProcedures]
	,@Gastroscopy = [Gastroscopy]
	,@ERCP = [ERCP]
	,@Colonoscopy = [Colonoscopy]
	,@Proctoscopy = [Proctoscopy]
	,@OutstandingCLO = [OutstandingCLO]
	,@OrderListOptions = [OrderListOptions]
	FROM [ERS_StartupSettings]

DECLARE @SQLString VARCHAR(max)
	,@SelectStr VARCHAR(max)
	,@FromStr VARCHAR(500)
	,@FromStr2 VARCHAR(500)
	,@WhereStr VARCHAR(1000)
	,@WhereStr2 VARCHAR(1000)
	,@OrderStr VARCHAR(1000)

SET @SelectStr = 'SELECT DISTINCT	p.PatientId, 
									p.Forename1 + '' '' + p.Surname AS PatientName, 
									dbo.fnFullAddress(p.Address1, p.Address2, p.Address3, p.Address4, '''') as Address, 
									p.DateOfBirth AS DOB, 
									UPPER(SUBSTRING(dbo.fnGender(p.GenderId),1,1)) as Gender, 
									dbo.fnEthnicity(p.EthnicId) as Ethnicity, 
									CASE WHEN EXISTS (select TOP 1 HospitalNumber from ERS_PatientTrusts where PatientId = p.PatientId and IsMinor = 0) 
									 THEN STUFF((SELECT DISTINCT '',''+HospitalNumber from ERS_PatientTrusts where PatientId = p.PatientId and IsMinor = 0 for xml path('''')), 1, 1, '''')
									 ELSE STUFF((SELECT DISTINCT '',''+HospitalNumber from ERS_PatientTrusts where PatientId = p.PatientId and IsMinor = 1 for xml path('''')), 1, 1, '''')
								    END AS CaseNoteNo, 
									p.NHSNo, 
									p.DateAdded AS CreatedOn, 
									ISNULL(Deceased,0) AS Deceased,
									--ROW_NUMBER() OVER (ORDER BY p.PatientId) AS PatientRowId,
									p.PatientId AS PatientId, 
									NULL AS UGIPatientId,
									NULL AS ComboId,
									1 AS ERSPatient, 
									p.Title AS Title, 
									p.Forename1 AS Forename1, 
									p.Surname AS Surname, 
									dbo.fnGender(p.GenderId) AS Gender, 
									p.Forename1 + '' '' + p.Surname AS PatientName, 
									dbo.fnFullAddress(p.Address1, p.Address2, p.Address3, p.Address4, '''') AS Address, 
									p.PostCode,
									p.Telephone,
									p.DateOfBirth AS DateOfBirth, 
									CASE WHEN EXISTS (select TOP 1 HospitalNumber from ERS_PatientTrusts where PatientId = p.PatientId and IsMinor = 0) 
									 THEN STUFF((SELECT DISTINCT '',''+HospitalNumber from ERS_PatientTrusts where PatientId = p.PatientId and IsMinor = 0 for xml path('''')), 1, 1, '''')
									 ELSE STUFF((SELECT DISTINCT '',''+HospitalNumber from ERS_PatientTrusts where PatientId = p.PatientId and IsMinor = 1 for xml path('''')), 1, 1, '''')
								    END AS HospitalNumber,
									p.NHSNo AS NHSNo, 
									p.DateAdded AS DateAdded,
									p.DateUpdated AS DateUpdated,
									p.EthnicId AS EthnicId,
									p.DateOfDeath AS DateOfDeath,
									ISNULL(p.Deceased,0)  AS Deceased,
									p.CreateUpdateMethod'
SET @FromStr = ' FROM ERS_Patients p (nolock) inner join  ERS_PatientTrusts pt on  p.PatientId = pt.PatientId Left join ERS_GenderTypes gt on p.GenderId = gt.GenderId'
SET @FromStr2 = ' FROM ERS_Patients p (nolock) JOIN ERS_MergeJournal mj on p.PatientId = mj.MasterPatientId  Left join ERS_GenderTypes gt on p.GenderId = gt.GenderId'
SET @WhereStr = ''
SET @WhereStr2 = ''
SET @OrderStr = ' ORDER BY p.DateAdded DESC, p.PatientId  DESC'

IF @SearchCriteria = 1 OR @SearchTab IN (1, 2) --(@SearchCriteria=2 AND @SearchTab <> 0)
BEGIN
print 'searchtab = ' + convert(varchar, @SearchTab)
	IF @SearchTab = 1
	BEGIN
		IF @searchString1 IS NOT NULL AND @searchString1 <> ''
		BEGIN
			SET @WhereStr = (
					SELECT CASE @Condition
							WHEN 'ALL'
								THEN ' WHERE pt.HospitalNumber = ISNULL(''' + @SearchString1 + ''','''') OR NHSNo = ISNULL(''' + @SearchString1 + ''','''') OR Surname LIKE ''%'' + ISNULL(''' + @SearchString1 + ''','''') + ''%'' OR Forename1 LIKE ''%'' + ISNULL(''' + @SearchString1 + ''','''') + ''%'' '
							WHEN 'Case note no.'
								THEN ' WHERE pt.HospitalNumber LIKE ''%'' + ISNULL(''' + @SearchString1 + ''','''') + ''%'' '
							WHEN 'NHS No'
								THEN ' WHERE REPLACE(NHSNo, '' '','''') LIKE ''%'' + ISNULL(''' + REPLACE(@SearchString1,' ', '') + ''','''') + ''%'' '
							WHEN 'Surname'
								THEN ' WHERE Surname LIKE ''%'' + ISNULL(''' + @SearchString1 + ''','''') + ''%'' '
							WHEN 'Forenames'
								THEN ' WHERE Forename1 LIKE ''%'' + ISNULL(''' + @SearchString1 + ''','''') + ''%'' '
							END
					)
			SET @WhereStr2 = (
					SELECT CASE @Condition
							WHEN 'ALL'
								THEN ' WHERE mj.SlaveExt LIKE ''%'' + ISNULL(''' + @SearchString1 + ''','''') + ''%'' OR NHSNo = ISNULL(''' + @SearchString1 + ''','''') OR Surname LIKE ''%'' + ISNULL(''' + @SearchString1 + ''','''') + ''%'' OR Forename1 LIKE ''%'' + ISNULL(''' + @SearchString1 + ''','''') + ''%'' '
							WHEN 'Case note no.'
								THEN ' WHERE mj.SlaveExt LIKE ''%'' + ISNULL(''' + @SearchString1 + ''','''') + ''%'' '
							WHEN 'NHS No'
								THEN ' WHERE REPLACE(NHSNo, '' '','''') = ISNULL(''' + REPLACE(@SearchString1,' ', '') + ''','''') '
							WHEN 'Surname'
								THEN ' WHERE Surname LIKE ''%'' + ISNULL(''' + @SearchString1 + ''','''') + ''%'' '
							WHEN 'Forenames'
								THEN ' WHERE Forename1 LIKE ''%'' + ISNULL(''' + @SearchString1 + ''','''') + ''%'' '
							END
					)
			
		END
	END
	ELSE
	BEGIN
		IF @SearchString1 IS NOT NULL AND @SearchString1 <> ''
		BEGIN
			SET @WhereStr = @WhereStr + (
					SELECT CASE @WhereStr
							WHEN ''	THEN ' WHERE ' ELSE @Condition END
					) + ' pt.HospitalNumber = ISNULL(''' + @SearchString1 + ''','''') '
			SET @WhereStr2 = @WhereStr2 + (
					SELECT CASE @WhereStr2
							WHEN ''	THEN ' WHERE ' ELSE @Condition END
					) + ' mj.SlaveExt LIKE ''%'' + ISNULL(''' + @SearchString1 + ''','''') + ''%'' '
			print @WhereStr2
		END

		IF @SearchString2 IS NOT NULL AND @SearchString2 <> ''
		BEGIN
			SET @WhereStr = @WhereStr + (
					SELECT CASE @WhereStr
							WHEN ''	THEN ' WHERE ' ELSE @Condition END
					) + ' REPLACE(NHSNo,'' '', '''') = ISNULL(''' + REPLACE(@SearchString2, ' ', '') + ''','''') '
		END

		IF @SearchString3 IS NOT NULL AND @SearchString3 <> ''
		BEGIN
			SET @WhereStr = @WhereStr + (
					SELECT CASE @WhereStr
							WHEN ''	THEN ' WHERE ' ELSE @Condition END
					) + ' ((Surname LIKE ''%'' + ISNULL(''' + @SearchString3 + ''','''') + ''%'') Or Soundex(Surname) = Soundex(''' + @SearchString3 + '%'')) '
		END

		IF @SearchString4 IS NOT NULL AND @SearchString4 <> ''
		BEGIN
			SET @WhereStr = @WhereStr + (
					SELECT CASE @WhereStr
							WHEN ''	THEN ' WHERE ' ELSE @Condition END
					) + ' ((Forename1 LIKE ''%'' + ISNULL(''' + @SearchString4 + ''','''') + ''%'') Or Soundex(Forename1) = Soundex(''' + @SearchString4 + '%'')) '
		END

		IF @SearchString5 IS NOT NULL AND @SearchString5 <> ''
		BEGIN
			SET @WhereStr = @WhereStr + (
					SELECT CASE @WhereStr
							WHEN ''	THEN ' WHERE ' ELSE @Condition END
					) + ' Convert(Date,DateOfBirth) = '''' + ISNULL(''' + @SearchString5 + ''','''') + '''' '
		END

		IF @SearchString6 IS NOT NULL AND @SearchString6 <> ''
		BEGIN
			SET @WhereStr = @WhereStr + (
					SELECT CASE @WhereStr
							WHEN ''	THEN ' WHERE ' ELSE @Condition END
					) + ' LTRIM(RTRIM(Address)) LIKE ''%'' + ISNULL(''' + LTRIM(RTRIM(@SearchString6)) + ''','''') + ''%'' '
		END

		IF @SearchString7 IS NOT NULL AND @SearchString7 <> ''
		BEGIN
			SET @WhereStr = @WhereStr + (
					SELECT CASE @WhereStr
							WHEN ''	THEN ' WHERE ' ELSE @Condition	END
					) + ' REPLACE(Postcode, '' '', '''') LIKE ''%'' + ISNULL(''' + REPLACE(@SearchString7, ' ', '') + ''','''') + ''%'' '
		END

		IF @searchGender IS NOT NULL AND @searchGender <> ''
		BEGIN
			if @searchGender = 'N'
			begin
				SET @WhereStr = @WhereStr + (
					SELECT CASE @WhereStr
							WHEN ''	THEN ' WHERE ' ELSE @Condition	END
					) + ' (REPLACE(gt.Code, '' '', '''') = ISNULL(''' + REPLACE(@searchGender, ' ', '') + ''','''') Or gt.Code Is Null)'
			end
			else
			begin
				SET @WhereStr = @WhereStr + (
					SELECT CASE @WhereStr
							WHEN ''	THEN ' WHERE ' ELSE @Condition	END
					) + ' REPLACE(gt.Code, '' '', '''') = ISNULL(''' + REPLACE(@searchGender, ' ', '') + ''','''') '
			end

			
		END

	END
	--Added For Trust Requirement
	SET @WhereStr = @WhereStr + ' AND pt.TrustId= ' + cast(@TrustId as varchar)
	
	IF @ExcludeDeceased = 1
		BEGIN
			IF @WhereStr <> ''
				SET @WhereStr = @WhereStr + ' AND ISNULL([Deceased],0) = 0'
			ELSE
				SET @WhereStr = 'WHERE ISNULL([Deceased],0) = 0'
		END

	--SET @SelectStr = @SelectStr + @FromStr
END
ELSE IF @SearchCriteria = 2
BEGIN
	--IF @AllProcedures = 1
	--BEGIN
		--IF @SearchCriteriaOption =1 SET @SelectStr = 'SELECT DISTINCT p.[Patient No] AS PatientId, p.Forename + '' '' + p.Surname AS PatientName, p.[Case note no] AS CaseNoteNo, p.[NHS No] AS NHSNo, p.[Record created] AS CreatedOn,p.[Surname] ,p.[Case note no] ,p.[Product ID] ,p.[Location ID] ,p.[Patient No] ,  p.[Has Images] ,p.[Just downloaded] ,p.[Forename] ,p.[Record created] ,p.[Combo ID] ,p.[NHS No] ,p.[Date of death]  FROM Patient p'
		IF @SearchCriteriaOption = 2 AND @SearchCriteriaOptionPatientCount > 0
			SET @SelectStr = 'SELECT TOP(' + CAST(@SearchCriteriaOptionPatientCount AS VARCHAR(50)) + ')  p.PatientId, p.Forename1 + '' '' + p.Surname AS PatientName, p.Address1 as Address, p.DateOfBirth AS DOB, UPPER(SUBSTRING(p.Gender,1,1)) as Gender, dbo.fnEthnicity(p.EthnicId) as Ethnicity, p.HospitalNumber AS CaseNoteNo, p.NHSNo, p.DateAdded AS CreatedOn, ISNULL(Deceased,0) AS Deceased (**) '
		ELSE IF @SearchCriteriaOption = 3 AND @SearchCriteriaOptionDate IS NOT NULL
			SET @WhereStr = 'WHERE DateAdded >= ''' + cast(@SearchCriteriaOptionDate AS VARCHAR(50)) + ''' '
		ELSE IF @SearchCriteriaOption = 4 AND @SearchCriteriaOptionMonths > 0
			SET @WhereStr = 'WHERE DateAdded >= DATEADD(MM,-' + CAST(@SearchCriteriaOptionMonths AS VARCHAR(50)) + ', GETDATE())'

		IF @ExcludeDeceased = 1
		BEGIN
			IF @WhereStr <> ''
				SET @WhereStr = @WhereStr + ' AND ISNULL([Deceased],0) = 0'
			ELSE
				SET @WhereStr = 'WHERE ISNULL([Deceased],0) = 0'
		END

		--SET @SelectStr = @SelectStr + @FromStr

END

IF @OrderListOptions = 2
	SET @OrderStr = ' ORDER BY [Surname], p.PatientId  DESC'

SET @Statement = @SelectStr + @FromStr + @WhereStr + @OrderStr
SET @Statement2 = @SelectStr + @FromStr + @WhereStr + ' union ' + @SelectStr + @FromStr2 + @WhereStr2 + @OrderStr

SET @Statement = (
					SELECT CASE @SearchType
							WHEN 'EQUALTO'
								THEN REPLACE(REPLACE(REPLACE(@Statement,'LIKE','='),'''%'' +',''),'+ ''%''','')
							WHEN 'STARTSWITH'
								THEN REPLACE(@Statement,'''%'' +','')
							WHEN 'ENDSWITH'
								THEN REPLACE(@Statement,'+ ''%''','')
							WHEN 'CONTAINS'
								THEN @Statement	
							END
					)
SET @Statement2 = (
					SELECT CASE @SearchType
							WHEN 'EQUALTO'
								THEN REPLACE(REPLACE(REPLACE(@Statement2,'LIKE','='),'''%'' +',''),'+ ''%''','')
							WHEN 'STARTSWITH'
								THEN REPLACE(@Statement2,'''%'' +','')
							WHEN 'ENDSWITH'
								THEN REPLACE(@Statement2,'+ ''%''','')
							WHEN 'CONTAINS'
								THEN @Statement2	
							END
					)

print @Statement

print @Statement2
IF ISNULL(@SearchString1, '') = ''
BEGIN
	EXEC sp_executesql @Statement
END
else
BEGIN
	EXEC sp_executesql @Statement2
END


DECLARE
	@sqlStringAudit NVARCHAR(MAX) = 'Searched: '

BEGIN

	IF @Condition <> '' 
	BEGIN
		SET @sqlStringAudit = @sqlStringAudit + 'Search Condition: ' + ISNULL(@Condition, '') + '. '
	END

	IF @SearchString1 <> '' 
	BEGIN
		SET @sqlStringAudit = @sqlStringAudit + 'Case Note No: ' + ISNULL(@SearchString1, '') + '. '
	END
	
	IF ISNULL(@SearchString2, '') <> ''
	BEGIN
		SET @sqlStringAudit = @sqlStringAudit + 'NHS No: ' + ISNULL(@SearchString2, '') + '. '
	END	

	IF ISNULL(@SearchString3, '') <> ''
	BEGIN
		SET @sqlStringAudit = @sqlStringAudit + 'Surname: ' + ISNULL(@SearchString3, '') + '. '
	END

	IF ISNULL(@SearchString4, '') <> ''
	BEGIN
		SET @sqlStringAudit = @sqlStringAudit + 'Forename: ' + ISNULL(@SearchString4, '') + '. '
	END

	IF ISNULL(@SearchString5, '') <> ''
	BEGIN	
		SET @sqlStringAudit = @sqlStringAudit + 'Date of Birth: ' + ISNULL(@SearchString5, '') + '. '
	END

	IF ISNULL(@SearchString6, '') <> ''
	BEGIN
		SET @sqlStringAudit = @sqlStringAudit + 'Address: ' + ISNULL(@SearchString6, '') + '. '
	END

	IF ISNULL(@SearchString7, '') <> ''
	BEGIN
		SET @sqlStringAudit = @sqlStringAudit + 'Postcode: ' + ISNULL(@SearchString7, '') + '. '
	END

	IF ISNULL(@searchGender, '') <> ''
	BEGIN
		SET @sqlStringAudit = @sqlStringAudit + 'Gender: ' + ISNULL(@searchGender, '') + '. '
	END

	IF @ExcludeDeceased = 1
	BEGIN
		SET @sqlStringAudit = @sqlStringAudit + 'Exclude Deceased: True. '
	END
	ELSE
	BEGIN
		SET @sqlStringAudit = @sqlStringAudit + 'Exclude Deceased: False. '
	END

	BEGIN
	INSERT INTO ERS_UserActivityAudit
	(
		[UserID],
		[UserName],
		[Action],
		[ActionDetails],
		[PatientId],	
		[When]	
	)
	VALUES
	(
		@UserId,
		UPPER(@UserName),
		'SEARCH',
		@sqlStringAudit,
		NULL,
		GETDATE()
	)
	END
END
Go
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	3901 by Mahfuz
------------------------------------------------------------------------------------------------------------------------
Go

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea
-- TFS#	
-- Description of change
-- View to retrieve lists and their appointments
------------------------------------------------------------------------------------------------------------------------
GO

EXEC dbo.DropIfExist @ObjectName = 'ERS_VW_List_Appointments',      -- varchar(100)
                     @ObjectTypePrefix = 'V' -- varchar(5)
GO

CREATE VIEW dbo.ERS_VW_List_Appointments
AS

select a.AppointmentId, a.StartDateTime, a.AppointmentDuration, a.ListSlotId, d.Subject, r.RoomName, r.RoomId, r.HospitalId, 
	   d.DiaryStart, d.DiaryEnd, d.ListRulesId, p.HospitalNumber, a.EndoscopistId, d.ListConsultantId
from dbo.ERS_Appointments a 
	inner join dbo.ERS_SCH_DiaryPages d on a.DiaryId = d.DiaryId
	inner join dbo.ERS_SCH_Rooms r on r.RoomId = d.roomid
	inner join dbo.ERS_Patients p on p.PatientId = a.PatientId

GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea
-- TFS#	3935
-- Description of change
-- Removed the updating of the slot minutes
------------------------------------------------------------------------------------------------------------------------
GO

ALTER PROCEDURE [dbo].[sch_list_slot_update]
(
	@ListSlotId int,
	@SlotStatusId int,
	@ProcedureTypeId int,
	@Points decimal(18,2),
	@SlotLength int,
	@LoggedInUserId int
)
AS
BEGIN
	UPDATE ERS_SCH_ListSlots
	SET SlotId = @SlotStatusId,
		ProcedureTypeId = @ProcedureTypeId,
		Points = @Points,
		WhenUpdated = getdate(),
		WhoUpdatedId = @LoggedInUserId
	WHERE ListSlotId = @ListSlotId
END
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	3935
------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Duncan
-- TFS#	XXXX
-- Description of change
-- Previous procedure images erroring as no region was being added to the #Photos table
------------------------------------------------------------------------------------------------------------------------
GO
EXEC dbo.DropIfExist 
    @ObjectName = 'printreport_photos_select', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[printreport_photos_select]
(
	@OperatingHospitalID SMALLINT,
	@ProcedureId INT,
	@EpisodeNo INT = 0,
	@PatientComboId VARCHAR(30) = NULL,
    @ProcedureType TINYINT,
    @ColonType INT = -1
)
AS

SET NOCOUNT ON
--Dependency : sites_select

create table #Photos (RowId INT, PhotoUrl VARCHAR(max), PhotoTitle VARCHAR(MAX), SortedSiteNo INT, Region VARCHAR(max))


	INSERT INTO #Photos
	SELECT 
		ROW_NUMBER() OVER (ORDER BY a.siteid asc,a.DateTimeStamp desc) AS RowId,--tfs#3749 changed
		convert(varchar(max), REPLACE(PhotoName, '.mp4', '.bmp')) AS PhotoUrl, 
		ISNULL(b.SiteDescription, 'No site associated - ' + CAST(a.photoId AS VARCHAR) + ' (Attached to the report)') + 
		CASE 
		WHEN a.PhotoName LIKE '%.mp4' 
		THEN '  (Video)' 
		ELSE '' 
		END AS PhotoTitle ,
		0 AS SortedSiteNo,
		b.Region As Region  --ADDING REGION HERE FOR MEDIA 
		
		
		

	FROM [ERS_Photos] a 
	LEFT JOIN 
		(SELECT s.SiteId, 
			'Site ' + CONVERT(VARCHAR(200), dbo.fnGetSiteTitle(SiteNo, @OperatingHospitalID	)) + ' - '+ cast(p.photoId as varchar) +
			' (' + 
			CASE AntPos WHEN 1 THEN 'Anterior' WHEN 2 THEN 'Posterior' WHEN 3 THEN '' END + 
			' ' + r.Region + 
			')' AS SiteDescription ,
			r.Region --ADDING REGION HERE FOR MEDIA 
		FROM ERS_Sites s 
		JOIN ERS_Regions r ON s.RegionId = r.RegionId 
		JOIN ERS_Photos p ON s.SiteId = p.SiteId
		WHERE s.ProcedureId = @ProcedureId) b ON a.SiteId=b.SiteId 
	WHERE ProcedureId = @ProcedureId

	if @ProcedureId >= 6000000
	begin
		INSERT INTO #Photos
		Select ROW_NUMBER() OVER (ORDER BY previmg.ImageId) as RowId,
				'data:image/jpeg;base64,' + PhotoUrl,
				ImageName,
				0,
				ImageLocation 
		FROM ERS_PreviousImages previmg
		cross apply (select ImageBinary as '*' for xml path('')) T (PhotoUrl)
		WHERE PreviousProcedureID =  @ProcedureId
	end

SELECT *
FROM #Photos
WHERE RowID >= CASE 
		WHEN @EpisodeNo > 0	-- UGI
			THEN 1  
		ELSE 0				-- ERS
		END
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea
-- TFS#	
-- Description of change
-- Default contraint missing from NCA Salford. Adding incase its missing anywhere else
------------------------------------------------------------------------------------------------------------------------
GO
IF  (SELECT ISNULL(OBJECT_DEFINITION(default_object_id), '') AS definition
	FROM   sys.columns
	WHERE  name      ='AdditionalInfo'
	AND    object_id = object_id('dbo.ERS_Limitations ')) = '' 
BEGIN
    ALTER TABLE dbo.ERS_Limitations 
    ADD CONSTRAINT [DF_ERS_Limitations_AdditionalInfo] DEFAULT 0 FOR AdditionalInfo;
END
GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
Go

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Muhammad Nasim
-- TFS#	3817
-- Description of change: Cardia should be the small region and GOJ the large
-------------------------------------------------------------------------------------------------------------------------
update ERS_Regions set Region='GOJ' where [Path] = 'M 200, 244,  253, 229,  261, 238,  270, 242,  230, 280,  213, 266 z'
update ERS_Regions set Region='Cardia' where [Path] = 'M 230, 280,  270, 242,  279, 245,  238, 284 z'
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#3817 	(Cardia should be the small region and GOJ the large)
------------------------------------------------------------------------------------------------------------------------
GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Muhammad Nasim
-- TFS#	4054
-- Description of change: when moving to 'procedure' page the sigmoid colectomy should auto apply to the anatomical image on the left and its not
-------------------------------------------------------------------------------------------------------------------------
GO
dbo.DropIfExist
    @ObjectName = 'patient_previous_surgery_save',      -- varchar(100)
    @ObjectTypePrefix = 'S' -- varchar(5)
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[patient_previous_surgery_save]
(
	@PreviousSurgeryId varchar(255),	
	@PreviousSurgeryPeriod int,
	@ProcedureId int,
	@PatientId int,
	@LoggedInUserId int
)
AS
BEGIN
	DELETE FROM ERS_PatientPreviousSurgery WHERE PatientId = @PatientId
	DECLARE @SelectedID int,@resectionId int;
	DECLARE db_cursor CURSOR FOR  
	SELECT item  FROM fnSplitString( @PreviousSurgeryId, ',')
	update ERS_Procedures set ResectedColonNo=null WHERE ProcedureID = @ProcedureId
	OPEN db_cursor   
	FETCH NEXT FROM db_cursor INTO @SelectedID 
	WHILE @@FETCH_STATUS = 0   
	BEGIN
		INSERT INTO ERS_PatientPreviousSurgery (PatientId, PreviousSurgeryId, PreviousSurgeryPeriod, ProcedureCreatedId, WhoCreatedId, WhenCreated)
		VALUES (@PatientId, @SelectedID, @PreviousSurgeryPeriod, @ProcedureId, @LoggedInUserId, getdate())

		DECLARE @ProcedureTypeId INT
		SELECT @ProcedureTypeId = ProcedureType FROM ERS_Procedures WHERE ProcedureId = @ProcedureId

		--check if previous surgery id exists in the procedure types link table, if not, add for this procedure type
		IF NOT EXISTS (SELECT 1 FROM ERS_PreviousSurgeryProcedureTypes WHERE PreviousSurgeryId = @SelectedID AND ProcedureTypeId = @ProcedureTypeId)
		BEGIN
			INSERT INTO ERS_PreviousSurgeryProcedureTypes (PreviousSurgeryId, ProcedureTypeId) VALUES (@SelectedID, @ProcedureTypeId)
		END
		set @resectionId=(select resectionId from ERS_PreviousSurgery where UniqueId=@SelectedID)
		if @resectionId is not null
		begin
			update ERS_Procedures set ResectedColonNo=@resectionId
			WHERE ProcedureID = @ProcedureId
		end
		--DECLARE @ResectionId INT
		--SELECT @ResectionId = ResectionId FROM ERS_PreviousSurgery WHERE UniqueId = @PreviousSurgeryId
		--IF @ResectionId IS NOT NULL
		--BEGIN
		--	UPDATE ERS_Procedures
		--	SET ResectedColonNo = @ResectionId
		--	WHERE ProcedureId = @ProcedureId
		--END

		FETCH NEXT FROM db_cursor INTO @SelectedID   
	END   

	CLOSE db_cursor   
	DEALLOCATE db_cursor

	UPDATE ERS_ProceduresReporting
	SET PP_Indic = dbo.ProcedureIndicationsSummary(@ProcedureId)
	WHERE ProcedureId = @ProcedureId

	DECLARE @Summary VARCHAR(max) = 'Previous surgery',
			@SurgeryCount int = (SELECT count(*) FROM ERS_PatientPreviousSurgery WHERE (ProcedureCreatedId = @ProcedureId or ProcedureUpdatedId = @ProcedureId))

	EXEC UI_update_procedure_summary @ProcedureId, 'Previous surgery', @Summary, @SurgeryCount

END
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#4054 	(when moving to 'procedure' page the sigmoid colectomy should auto apply to the anatomical image on the left and its not)
------------------------------------------------------------------------------------------------------------------------
GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	MOSTAFIZUR RAHMAN
-- TFS#	3729
-- Description of change
-- Fixed Dashboard year change bug
------------------------------------------------------------------------------------------------------------------------
GO
EXEC dbo.DropIfExist 
    @ObjectName = 'chart_get_procedure_years', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[chart_get_procedure_years]

AS
	SET NOCOUNT ON

	IF (
			EXISTS (
				SELECT 1
				FROM INFORMATION_SCHEMA.TABLES
				WHERE TABLE_SCHEMA = 'dbo'
					AND TABLE_NAME = 'Colon Procedure'
				)
			)
	BEGIN
		SELECT year([Procedure date]) AS ProcedureYear
		FROM [Colon Procedure]
		WHERE year([Procedure date]) IS NOT NULL
		GROUP BY year([Procedure date])
	
		UNION
	
		SELECT year([Procedure date]) AS ProcedureYear
		FROM [Upper GI Procedure]
		WHERE year([Procedure date]) IS NOT NULL
		GROUP BY year([Procedure date])
	
		UNION
	
		SELECT year([Procedure date]) AS ProcedureYear
		FROM [ERCP Procedure]
		WHERE year([Procedure date]) IS NOT NULL
		GROUP BY year([Procedure date])
	
		UNION
	
		SELECT year([Procedure date]) AS ProcedureYear
		FROM [EUS procedure]
		WHERE year([Procedure date]) IS NOT NULL
		GROUP BY year([Procedure date])

		IF @@ROWCOUNT = 0 SELECT 0 AS ProcedureYear
	END
	ELSE
		--SELECT 0 AS ProcedureYear
		-- added by mostafiz 3729
    SELECT YEAR(CreatedOn) AS ProcedureYear
    FROM ERS_Procedures
    WHERE IsNull(DNA, 0) = 0
        AND ProcedureCompleted = 1
        AND YEAR(CreatedOn) IS NOT NULL
        AND CreatedOn > DATEADD(year, -10, GETDATE())
        AND IsActive = 1
    GROUP BY YEAR(CreatedOn)


	  -- added by mostafiz 3729
	  GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	3729 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	MOSTAFIZUR RAHMAN
-- TFS#	3487
-- Description of change
-- Fixed TNM Staging for GI EUS procedure 
------------------------------------------------------------------------------------------------------------------------


 IF NOT EXISTS (
        SELECT 1
        FROM INFORMATION_SCHEMA.COLUMNS
        WHERE TABLE_NAME = 'ERS_CommonAbnoTumour' AND
              COLUMN_NAME IN ('TumourLocation', 'StageT', 'StageN', 'StageM')
    )
    BEGIN
		
		ALTER TABLE ERS_CommonAbnoTumour
            ADD TumourLocation VARCHAR(50),
             StageT VARCHAR(20),
             StageN VARCHAR(20),
             StageM VARCHAR(20);
    END

GO
EXEC dbo.DropIfExist 
    @ObjectName = 'abnormalities_ogd_tumour_save', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[abnormalities_ogd_tumour_save]
(
	@SiteId INT,
	@None BIT,
	@Type TINYINT,
	--@Primary BIT,
	--@ExternalInvasion BIT,	
	@Tumour BIT,		
	@TumourProbably BIT,
	@TumourExophytic TINYINT,
	@TumourBenignType TINYINT,
	@TumourBenignTypeOther NVARCHAR(150),
	@TumourBeginning SMALLINT,
	@TumourLength SMALLINT,
	@TumourLocation VARCHAR(50), -- edited by mostafiz 3487
	@StageT VARCHAR(20),
	@StageN VARCHAR(20),
	@StageM VARCHAR(20),
	--@TumourOther NVARCHAR(150),
	@IsLAClassification BIT,
	@TumourScopeNotPass BIT,
	@LoggedInUserId INT,
	@TumourComplexDetails BIT = 1
)
AS

SET NOCOUNT ON

DECLARE @proc_id INT
DECLARE @proc_type INT

BEGIN TRANSACTION

BEGIN TRY
	SELECT 
		@proc_id = p.ProcedureId,
		@proc_type = p.ProcedureType
	FROM 
		ERS_Sites s
	JOIN 
		ERS_Procedures p ON s.ProcedureId = p.ProcedureId
	WHERE 
		SiteId = @SiteId
			
	IF NOT EXISTS (SELECT 1 FROM ERS_CommonAbnoTumour WHERE SiteId = @SiteId)
	BEGIN
		INSERT INTO ERS_CommonAbnoTumour (
			SiteId,
			[None],
			[Type],
			--[Primary],
			--ExternalInvasion,
			WhoCreatedId,
			WhenCreated,
			Tumour,		
			TumourProbably,
			TumourExophytic,
			TumourBenignType,
			TumourBenignTypeOther,
			TumourBeginning,
			TumourLength,
			TumourLocation, -- edited by mostafiz 3487
			StageT,
			StageN,
			StageM,
			--TumourOther,
			IsLAClassification,
			TumourScopeNotPass,
			TumourComplexDetails)
		VALUES (
			@SiteId,
			@None,
			@Type,
			--@Primary,
			--@ExternalInvasion,
			@LoggedInUserId,
			GETDATE(),
			@Tumour,		
			@TumourProbably,
			@TumourExophytic,
			@TumourBenignType,
			@TumourBenignTypeOther,
			@TumourBeginning,
			@TumourLength,
			@TumourLocation ,-- edited by mostafiz 3487
			@StageT,
			@StageN,
			@StageM,
			--@TumourOther,
			@IsLAClassification,
			@TumourScopeNotPass,
			@TumourComplexDetails
			) 

		INSERT INTO ERS_RecordCount (
			[ProcedureId],
			[SiteId],
			[Identifier],
			[RecordCount]
		)
		VALUES (
			@proc_id,
			@SiteId,
			'Tumour',
			1)
	END

	ELSE IF (@None = 0 AND @Type = 0 AND @Tumour = 0)
	BEGIN
		DELETE FROM ERS_CommonAbnoTumour 
		WHERE SiteId = @SiteId

		DELETE FROM ERS_RecordCount 
		WHERE SiteId = @SiteId
		AND Identifier = 'Tumour'
	END
	
	ELSE
	BEGIN
		UPDATE 
			ERS_CommonAbnoTumour
		SET 
			[None] = @None,
			[Type] = @Type,
			--[Primary] = @Primary,
			--ExternalInvasion = @ExternalInvasion,
			WhoUpdatedId = @LoggedInUserId,
			WhenUpdated = GETDATE(),
			Tumour = @Tumour,		
			TumourProbably = @TumourProbably,
			TumourExophytic = @TumourExophytic,
			TumourBenignType = @TumourBenignType,
			TumourBenignTypeOther = @TumourBenignTypeOther,
			TumourBeginning = @TumourBeginning,
			TumourLength = @TumourLength,
			TumourLocation=@TumourLocation, -- edited by mostafiz 3487
			StageT=@StageT,
			StageN=@StageN,
			StageM=@StageM,
			--TumourOther = @TumourOther,
			IsLAClassification = @IsLAClassification,
			TumourScopeNotPass = @TumourScopeNotPass
		WHERE 
			SiteId = @SiteId
	END
END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;
  
GO
EXEC dbo.DropIfExist 
    @ObjectName = 'abnormalities_tumour_summary_update', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[abnormalities_tumour_summary_update]
(
	@SiteId INT
)
AS
	SET NOCOUNT ON
	
	DECLARE
		@summary VARCHAR(max) = '', -- edited by mostafiz 3487
		@temp VARCHAR(50) = '',
		@None BIT = 0,
		@Type TINYINT = 0,
		@Primary BIT = 0,
		@ExternalInvasion BIT = 0,
		@Tumour BIT = 0,
		@TumourProbably BIT = 0,
		@TumourExophytic TINYINT = 0,
		@TumourBenignType TINYINT = 0,
		@TumourBenignTypeOther NVARCHAR(100) = '',
		@TumourBeginning SMALLINT = 0,
		@TumourLength SMALLINT = 0,
		@TumourLocation VARCHAR(50), -- edited by mostafiz 3487
		@StageT VARCHAR(20),
		@StageN VARCHAR(20),
		@StageM VARCHAR(20),
		@TumourScopeNotPass BIT = 0,
		@TumourComplexDetails BIT = 0

DECLARE @tmpDiv TABLE(Val VARCHAR(MAX))
		DECLARE @XMLlist XML
		DECLARE @a VARCHAR(200) = 'Tumour: '
		DECLARE @b VARCHAR(200) = ''
		DECLARE @c VARCHAR(200) = ''
		DECLARE @TumourText VARCHAR(MAX) -- edited by mostafiz 3487

	SELECT 
		@None					=	[None],
		@Type					=	[Type],
		@Primary				=	[Primary],
		@ExternalInvasion		=	ExternalInvasion,
		@Tumour					=	Tumour,
		@TumourProbably			=	TumourProbably,
		@TumourExophytic		=	TumourExophytic,
		@TumourBenignType		=	TumourBenignType,
		@TumourBenignTypeOther	=	(SELECT ISNULL(TumourBenignTypeOther, '') as [text()] FOR XML PATH('')),
		@TumourBeginning		=	TumourBeginning,
		@TumourLength			=	TumourLength,
		@TumourLocation			=	TumourLocation, -- edited by mostafiz 3487
		@StageT					=	StageT,
		@StageN					=	StageN,		
		@StageM					=   StageM,
		@TumourScopeNotPass		=	TumourScopeNotPass,
		@TumourComplexDetails	=	TumourComplexDetails
	FROM
		ERS_CommonAbnoTumour
	WHERE
		SiteId = @SiteId

	SET @summary = ''
	SET @temp = ''

	--IF ISNULL(@Tumour,0) = 1
	--BEGIN
	--	SET @TumourText = dbo.fnRptOesophagusTumour(@SiteId)
	--	IF @TumourText <> '' INSERT INTO @tmpMisc (Val) VALUES(@indent + dbo.fnFirstLetterUpper(RTRIM(LTRIM(@TumourText))) + '.' + @br)
	--END
	--ELSE
	--SELECT 64 AS [Line Number], @Tumour AS [Tumour], @Type AS [Tumour Type], @TumourComplexDetails AS [Tumour Complex Details]
	IF @None = 1
		SET @summary = @summary + 'No tumour'	
	ELSE IF @Tumour = 1 AND @Type = 0 AND @None = 0
		SET @summary = @summary + dbo.fnRptOesophagusTumour(@SiteId) -- TFS 3487
	ELSE IF @Tumour = 1 AND @Type > 0	
	BEGIN	
		--DECLARE @tmpDiv TABLE(Val VARCHAR(MAX))
		--DECLARE @XMLlist XML
		--DECLARE @a VARCHAR(200) = 'Tumour: '
		--DECLARE @b VARCHAR(200) = ''
		--DECLARE @c VARCHAR(200) = ''
		--DECLARE @TumourText VARCHAR(500)
		
		IF @TumourComplexDetails = 0
		BEGIN		
			IF @Type = 1
			BEGIN
				SET @a = ''
				SET @b = ' Benign polyp'
			END
			ELSE IF @Type = 2
			BEGIN
				SET @b = ' lymphoma'
			END
			ELSE IF @Type = 3
			BEGIN		
				SET @b = ' carcinoma'
				SET @c = ' probable'
			END
			ELSE IF @Type = 4
			BEGIN
				SET @b = ' carcinoma'
				SET @c = ' confirmed'
			END
			ELSE SET @a = ''
			
			IF @ExternalInvasion = 1 SET @a = @a + ' external invasion of'

			IF @Primary = 1 SET @a = @a + ' primary'

			IF @b <> '' SET @a = @a + @c + @b

			IF @a <> '' SET @summary = @a 

			--SET @TumourText = @summary 
		END
		ELSE
		BEGIN
			--SET @TumourText = dbo.fnRptOesophagusTumour(@SiteId)		
			SET @summary = dbo.fnRptOesophagusTumour(@SiteId)
		END

		--IF @TumourText <> '' --INSERT INTO @tmpMisc (Val) VALUES(@indent + dbo.fnFirstLetterUpper(RTRIM(LTRIM(@TumourText))) + '.' + @br)
		--SET @summary = @summary + @TumourText

	END
	ELSE IF @Tumour = 0 AND @Type > 0	
	BEGIN	
	--SELECT 123 AS [Line Number], @Tumour AS [Tumour], @Type AS [Tumour Type], @TumourComplexDetails AS [Tumour Complex Details]
		IF @TumourComplexDetails = 0
		BEGIN		
			IF @Type = 1
			BEGIN
				SET @a = ''
				SET @b = ' Benign polyp'
			END
			ELSE IF @Type = 2
			BEGIN
				SET @b = ' lymphoma'
			END
			ELSE IF @Type = 3
			BEGIN		
				SET @b = ' carcinoma'
				SET @c = ' probable'
				--SELECT @b, @c
			END
			ELSE IF @Type = 4
			BEGIN
				SET @b = ' carcinoma'
				SET @c = ' confirmed'
			END
			ELSE SET @a = ''
			--SELECT @ExternalInvasion AS [ExternalInvasion]
			IF @ExternalInvasion = 1 SET @a = @a + ' external invasion of'
			--SELECT @a AS [@a]
			IF @Primary = 1 SET @a = @a + ' primary'

			IF @b <> '' SET @a = @a + @c + @b

			IF @a <> '' SET @summary = @a 

			--SET @TumourText = @summary 
		END
	END
	ELSE IF @Tumour = 0 AND @Type = 0
		SET @summary = ''

	-- Finally update the summary in abnormalities table
	UPDATE dbo.ERS_CommonAbnoTumour
	SET Summary = @summary 
	WHERE SiteId = @siteId
GO

EXEC dbo.DropIfExist @ObjectName = 'fnRptOesophagusTumour',      
                     @ObjectTypePrefix = 'F' 
GO
CREATE FUNCTION [dbo].[fnRptOesophagusTumour] (@SiteId INT)
RETURNS VARCHAR(MAX)
AS
BEGIN

	DECLARE		
		@None BIT,
		@Tumour BIT,
		@TumourType TINYINT,
		@TumourProbably BIT,
		@TumourExophytic TINYINT,
		@TumourBenignType TINYINT,
		@TumourBenignTypeOther NVARCHAR(100),
		@TumourBeginning SMALLINT,
		@TumourLength SMALLINT,
		@TumourLocation VARCHAR(50),-- edited by mostafiz 3487
		@StageT VARCHAR(20),
		@StageN VARCHAR(20),
		@StageM VARCHAR(20),
		@TumourScopeNotPass BIT,
		@IsLAClassification BIT

	SELECT 
		@None					=	[None],
		@TumourType				=	[Type],
		@Tumour					=	Tumour,		
		@TumourProbably			=	TumourProbably,
		@TumourExophytic		=	TumourExophytic,
		@TumourBenignType		=	TumourBenignType,
		@TumourBenignTypeOther	=	TumourBenignTypeOther,
		@TumourBeginning		=	TumourBeginning,
		@TumourLength			=	TumourLength,
		@TumourLocation			=	TumourLocation, -- edited by mostafiz 3487
		@StageT					=	StageT,
		@StageN					=	StageN,		
		@StageM					=   StageM,
		@TumourScopeNotPass		=	TumourScopeNotPass,
		@IsLAClassification		=	ISNULL(IsLAClassification,0)
	FROM
		dbo.ERS_CommonAbnoTumour
	WHERE
		SiteId = @SiteId


	DECLARE @TumourText VARCHAR(max) = '' -- edited by mostafiz 3487
	DECLARE @Prob VARCHAR(100) = ''

	IF ISNULL(@Tumour,0) = 0 RETURN ''

	SET @TumourText = CASE @TumourExophytic
							WHEN 1 THEN 'indeterminate'
							WHEN 2 THEN 'submucosal'
							WHEN 3 THEN 'exophytic'
							ELSE ''
						END

	SET @TumourText = @TumourText + ' tumour'

	IF @TumourProbably = 1 SET @Prob = 'probably '

	IF @TumourType = 1
	BEGIN
		SET @TumourText = CASE @TumourBenignType
							WHEN 1 THEN @TumourText + ', ' + @Prob +  'benign (type uncertain)'
							WHEN 2 THEN @TumourText + ', ' + @Prob +  'leiomyoma'
							WHEN 3 THEN @TumourText + ', ' + @Prob +  'lipoma'
							WHEN 4 THEN @TumourText + ', ' + @Prob +  'granular cell tumour'
							WHEN 5 THEN 
								(CASE WHEN @TumourBenignTypeOther <> '' THEN @TumourText + ', ' + @Prob +  'benign (' + @TumourBenignTypeOther + ') ' ELSE '' END)
							ELSE @TumourText + ', ' + @Prob +  'benign'
						END
	END
	ELSE IF @TumourType = 2
	BEGIN
		SET @TumourText = CASE @TumourBenignType
							WHEN 1 THEN @TumourText + ', ' + @Prob +  'malignant (cell type uncertain)'
							WHEN 2 THEN @TumourText + ', ' + @Prob +  'squamous carcinoma'
							WHEN 3 THEN @TumourText + ', ' + @Prob +  'adenocarcinoma'
							WHEN 4 THEN 
								CASE WHEN @TumourBenignTypeOther <> '' THEN @TumourText + ', ' + @Prob +  'malignant (' + @TumourBenignTypeOther + ') ' ELSE '' END
							ELSE @TumourText + ', ' + @Prob +  'malignant'
						END
	END

		--Only report the beginning and/or length of the tumour if it is different from the stricture beginning and/or length.
	IF ISNULL(@TumourBeginning,0) <> 0
	BEGIN
		--IF ISNULL(@StrictureBeginning,0) <> ISNULL(@TumourBeginning,0)
				SET @TumourText = @TumourText + ' beginning ' + CONVERT(VARCHAR,@TumourBeginning) + 'cm from incisors'
	END	

	IF ISNULL(@TumourLength,0) <> 0
	BEGIN
		--IF ISNULL(@StrictureLength,0) <> ISNULL(@TumourLength,0)
				SET @TumourText = @TumourText + ' length ' + CONVERT(VARCHAR,@TumourLength) + 'cm'
	END	

	-- edited by mostafiz 3487

	IF @TumourLocation IS NOT NULL AND @TumourLocation <> ''
	BEGIN
		SET @TumourText = @TumourText + '. Location of primary tumour: ' + @TumourLocation
	END

	
	IF @StageT IS NOT NULL AND @StageT <> ''
	BEGIN
		SET @TumourText = @TumourText + ', Stage: T- ' + @StageT
	END

	
	IF @StageN IS NOT NULL AND @StageN <> ''
	BEGIN
		SET @TumourText = @TumourText + ', N- ' + @StageN
	END

	
	IF @StageM IS NOT NULL AND @StageM <> ''
	BEGIN
		SET @TumourText = @TumourText + ', M- ' + @StageM
	END
	-- edited by mostafiz 3487

	IF @TumourScopeNotPass = 1 SET @TumourText = @TumourText + ', scope unable to pass'

	RETURN @TumourText
END

GO

EXEC dbo.DropIfExist 
    @ObjectName = 'abnormalities_ogd_tumour_select', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[abnormalities_ogd_tumour_select]
(
	@SiteId INT	
)
AS

SET NOCOUNT ON

	SELECT	[SiteId],
			[None],
			[Type],
			[Primary],
			ExternalInvasion,
			WhoCreatedId,
			WhenCreated,
			Tumour,		
			TumourProbably,
			TumourExophytic,
			TumourBenignType,
			TumourBenignTypeOther,
			TumourBeginning,
			TumourLength,
			TumourLocation,
			StageT,
			StageN,
			StageM,
			TumourOther,
			IsLAClassification,
			TumourScopeNotPass
	FROM 
		[dbo].[ERS_CommonAbnoTumour]
	WHERE 
		SiteId = @SiteId


GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	3487 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	MOSTAFIZUR RAHMAN
-- TFS#	3926
-- Description of change
-- Fixed Problems while saving polyps data in Ent-Retrograde procedures
------------------------------------------------------------------------------------------------------------------------

Go
EXEC DropIfExist 'TR_CommonAbnoLesions', 'TR';
Go


CREATE TRIGGER [dbo].[TR_CommonAbnoLesions]
	ON [dbo].[ERS_CommonAbnoLesions]
	AFTER INSERT, UPDATE, DELETE
	AS 
		DECLARE @site_id INT, @Polyp VARCHAR(10) = 'False', 
							  @BenignTumour VARCHAR(10) = 'False', 
							  @MalignantTumour VARCHAR(10) = 'False', 
							  @SubmucosalTumour VARCHAR(10) = 'False', 
							  @FocalLesions VARCHAR(10) = 'False',
							  @SubmucoaslLesion VARCHAR(10) = 'False',
							  @FundicGlandPolyp VARCHAR(10) = 'False',
							  @PreviousESDScar VARCHAR(10) = 'False',
				@PolypTypeId INT, @Region VARCHAR(20), @ProcedureTypeId INT, @MatrixCode VARCHAR(50)
	
		IF EXISTS(SELECT * FROM INSERTED)


		BEGIN
		
			SELECT @site_id=SiteId,
					@Polyp = (CASE WHEN (ISNULL(Polyp,0) = 1) THEN 'True' ELSE 'False' END),
					@FocalLesions = (CASE WHEN (ISNULL(Focal,0) = 1) THEN 'True' ELSE 'False' END),
					@SubmucoaslLesion = (CASE WHEN (ISNULL(Submucosal,0) = 1) THEN 'True' ELSE 'False' END),
					@FundicGlandPolyp = (CASE WHEN (ISNULL(FundicGlandPolyp,0) = 1) THEN 'True' ELSE 'False' END),
					@PolypTypeId = PolypTypeId,
					@PreviousESDScar = (CASE WHEN (ISNULL(PreviousESDScar,0) = 1) THEN 'True' ELSE 'False' END)
				
			FROM INSERTED

			SELECT TOP 1 @ProcedureTypeId =  p.ProcedureType FROM ERS_Sites s INNER JOIN ERS_Procedures p ON p.ProcedureId = s.ProcedureId WHERE s.SiteId = @site_id
			--check if polyps = 1
			IF @Polyp = 'True' 
			BEGIN
				--check for polyp type
				DECLARE @PolypType VARCHAR(200) = (SELECT Description FROM ERS_PolypTypes WHERE UniqueId = @PolypTypeId)

				IF LOWER(@PolypType) = 'sessile'
				BEGIN
					--sessile polyps to produce a gastric tumour outcome depending on the tumour type
					IF EXISTS (SELECT 1 FROM ERS_CommonAbnoPolypDetails WHERE SiteId = @site_id AND Type = (SELECT UniqueId FROM ERS_TumourTypes WHERE Description = 'benign'))
						SET @BenignTumour = 'True'
					ELSE 
						SET @BenignTumour = 'False'

					IF EXISTS (SELECT 1 FROM ERS_CommonAbnoPolypDetails WHERE SiteId = @site_id AND Type = (SELECT UniqueId FROM ERS_TumourTypes WHERE Description = 'malignant'))
						SET @MalignantTumour = 'True'
					ELSE
						SET @MalignantTumour = 'False'
				END
			
				IF LOWER(@PolypType) = 'submucosal'  AND LOWER(@Region) = 'stomach'
					SET @SubmucoaslLesion = 'True'
				ELSE
					SET @SubmucoaslLesion = 'False'

			END
		
			IF @ProcedureTypeId IN (1,6,8)
			BEGIN
				SELECT @Region = dbo.fnSiteRegion(@site_id)

				IF LOWER(@Region) = 'stomach'
				BEGIN
					--SELECT @Polyp = CASE WHEN @FundicGlandPolyp = 'False' AND @BenignTumour = 'False' AND @MalignantTumour = 'False' AND @SubmucosalTumour = 'False' THEN 'True' ELSE 'False' END
					SET @MatrixCode = 'D40P1'
				END
				ELSE IF LOWER(@Region) = 'oesophagus'
					SET @MatrixCode = 'N2013'
				ELSE IF LOWER(@Region) = 'duodenum'
					SET @MatrixCode = 'D58P1'
				ELSE IF LOWER(@Region) = 'colon'
					SET @MatrixCode = 'D58P1'
				
			END
			ELSE IF @ProcedureTypeId IN (3,4,9)
			BEGIN
				SELECT @Region = dbo.fnSiteRegion(@site_id)
				PRINT @Region
				IF @Polyp = 'True' AND @Region IN ('Rectum', 'Anal Margin')
					SET @MatrixCode = 'D4P3'

				IF @Polyp = 'True' AND (@Region NOT IN ('Rectum', 'Anal Margin', 'Terminal Ileum') OR @Region IS NULL) --EDITED BY MOSTAFIZ 3926 
					SET @MatrixCode = 'D12P3'

				IF @Polyp = 'True' AND @Region IN ('Terminal Ileum', 'Neo-Terminal Ileum')
					SET @MatrixCode = 'DIPOLYPP3'

				
			END

		END
		ELSE
		BEGIN
			SELECT @site_id=SiteId FROM DELETED
		END

		EXEC abnormalities_common_lesions_summary_update @site_id

		IF @site_id IS NOT NULL AND @ProcedureTypeId IN (1,3,4,6,8,9,2,7)
		BEGIN
			EXEC sites_summary_update @site_id

			
			EXEC diagnoses_control_save @site_id, @MatrixCode, @Polyp		
			
			--EXEC diagnoses_control_save @site_id, 'D86P1', @BenignTumour	
			--EXEC diagnoses_control_save @site_id, 'D87P1', @MalignantTumour	
			EXEC diagnoses_control_save @site_id, 'N2001', @FocalLesions
			EXEC diagnoses_control_save @site_id, 'D88P1', @SubmucosalTumour
			EXEC diagnoses_control_save @site_id, 'N2002', @SubmucoaslLesion
			EXEC diagnoses_control_save @site_id, 'N2019', @FundicGlandPolyp

			IF @ProcedureTypeId IN (1,6,8)
			BEGIN
			    EXEC diagnoses_control_save @site_id, 'DSESDSCARP1', @PreviousESDScar		
			END
			ELSE IF @ProcedureTypeId IN (2,7)
			BEGIN
				EXEC diagnoses_control_save @site_id, 'DDESDSCARP2', @PreviousESDScar
			END
			ELSE IF @ProcedureTypeId IN (3,9)
			BEGIN
				EXEC diagnoses_control_save @site_id, 'DESDSCARP3', @PreviousESDScar
			END
			ELSE IF @ProcedureTypeId = 4
			BEGIN
				EXEC diagnoses_control_save @site_id, 'SESDSCARP3', @PreviousESDScar
			END
		END



GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	3926 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ferdowsi On 29 April 2024
-- TFS#	No TFS - Item 3829
-- Description of change
-- Changed summary eosinophila to eosinophilic , Changed report eosinophila to eosinophilic
------------------------------------------------------------------------------------------------------------------------
GO
EXEC dbo.DropIfExist @ObjectName = 'abnormalities_oesophagitis_summary_update',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[abnormalities_oesophagitis_summary_update]
(
	@SiteId INT
)
AS
	SET NOCOUNT ON
	
		DECLARE
		@summary VARCHAR(8000),
		@temp VARCHAR(50),
		@None BIT,
		@MucosalAppearance TINYINT,
		@Reflux BIT,
		@ActiveBleeding BIT,
		@MSMGrade1 BIT,
		@MSMGrade2a BIT,
		@MSMGrade2b BIT,
		@MSMGrade3 BIT,
		@MSMGrade4 BIT,
		@MSMGrade5 BIT,
		@ShortOesophagus BIT,
		@Ulcer BIT,
		@Stricture BIT,
		@LAClassification TINYINT,
		@Other BIT,
		@SuspectedCandida BIT,
		@CausticIngestion BIT,
		@SuspectedHerpes BIT,
		@CorrosiveBurns BIT,
		@Eosinophilic BIT,
		@OtherTypeOther BIT,
		@OtherTypeOtherDesc VARCHAR(200),
		@SuspectedCandidaSeverity TINYINT,
		@CausticIngestionSeverity TINYINT,
		@SuspectedHerpesSeverity TINYINT,
		@CorrosiveBurnsSeverity TINYINT,
		@EosinophilicSeverity TINYINT

		DECLARE @nonGrade5MSMText VARCHAR(200) = '',
				--@mMSM VARCHAR(50) = '',
				@sg2common VARCHAR(50) = '',
				@sg2common1 VARCHAR(50) = '',
				@Grade VARCHAR(50) = 'grade ',
				@sg1 VARCHAR(220) = '',
				@sg2 VARCHAR(220) = '',
				@sg2a VARCHAR(320) = '',
				@sg2b VARCHAR(320) = '',
				@sg3 VARCHAR(320) = '',
				@plus VARCHAR(10) = '',
				@Grade5BarrattsText VARCHAR(200) = '',
				@RefluxBleedingOnly VARCHAR(200) = ''

	SELECT 
		@None=[None],
		@MucosalAppearance = MucosalAppearance,
		@Reflux = ISNULL(Reflux,0),
		@ActiveBleeding = ISNULL(ActiveBleeding,0),
		@MSMGrade1 = ISNULL(MSMGrade1,0),
		@MSMGrade2a = ISNULL(MSMGrade2a,0),
		@MSMGrade2b = ISNULL(MSMGrade2b,0),
		@MSMGrade3 = ISNULL(MSMGrade3,0),
		@MSMGrade4 = ISNULL(MSMGrade4,0),
		@MSMGrade5 = ISNULL(MSMGrade5,0),
		@ShortOesophagus = ISNULL(ShortOesophagus,0),
		@Ulcer = ISNULL(Ulcer,0),
		@Stricture = ISNULL(Stricture,0),
		@LAClassification = LAClassification,
		@Other = Other,
		@SuspectedCandida = SuspectedCandida,
		@CausticIngestion = CausticIngestion,
		@SuspectedHerpes = SuspectedHerpes,
		@CorrosiveBurns = CorrosiveBurns,
		@Eosinophilic = Eosinophilic,
		@OtherTypeOther = OtherTypeOther,
		@OtherTypeOtherDesc = (SELECT ISNULL(OtherTypeOtherDesc,'') as [text()] FOR XML PATH('')),
		@SuspectedCandidaSeverity = SuspectedCandidaSeverity,
		@CausticIngestionSeverity = CausticIngestionSeverity,
		@SuspectedHerpesSeverity = SuspectedHerpesSeverity,
		@CorrosiveBurnsSeverity = CorrosiveBurnsSeverity,
		@EosinophilicSeverity = EosinophilicSeverity
	FROM
		ERS_UpperGIAbnoOesophagitis
	WHERE
		SiteId = @SiteId

		 
	SET @Summary = ''
	SET @temp = ''
	--If 'No oesophagitis' then ...
	IF @None = 1
		SET @summary = @summary + 'No oesophagitis'
	
	ELSE IF @MucosalAppearance > 0 OR @Reflux = 1 OR @Other = 1
	BEGIN
        -- There IS Oesophagitis or Barrett's so ...
        -- nonMSMOesoText contains the non-MSM oesophagitis text
		DECLARE @tmpOeso TABLE(Val VARCHAR(MAX))

		DECLARE @tmpVal VARCHAR(500) = '',
				@LAClassText VARCHAR(300) = ''
		DECLARE @SC VARCHAR(50) = '',
				@SH VARCHAR(50) = '',
				@nonMSMOesoText VARCHAR(500) = '',
				@withText VARCHAR(20) = '',
				--@MA VARCHAR(50) = '',
				@Oeso VARCHAR(150) = '',
				@mMSM VARCHAR(150) = 'Modified Savary Miller '
		DECLARE @XMLlist XML
				
		IF @Other = 1
		BEGIN
			-- Suspected candida
			IF @SuspectedCandida = 1
			BEGIN
				SET @SC = CASE @SuspectedCandidaSeverity
							WHEN 1 THEN 'mild '
							WHEN 2 THEN 'moderate '
							WHEN 3 THEN 'severe '
							ELSE ''
						END
				SET @SC = @SC + 'candida'
				INSERT INTO @tmpOeso (Val) VALUES(@SC)
			END
			--Suspected herpes
			IF @SuspectedHerpes = 1
			BEGIN
				SET @SH = ''
				SET @SH = CASE @SuspectedHerpesSeverity
							WHEN 1 THEN 'mild '
							WHEN 2 THEN 'moderate '
							WHEN 3 THEN 'severe '
							ELSE ''
						END
				SET @SH = @SH + 'herpes'
				INSERT INTO @tmpOeso (Val) VALUES(@SH)
			END

			--'If either candida or herpes then add 'suspected'
			IF @SuspectedHerpes = 1 UPDATE @tmpOeso SET VAL = VAL + ' suspected' WHERE VAL LIKE '%herpes' --  SET @SH = @SH + ' suspected'
			ELSE IF @SuspectedCandida = 1  UPDATE @tmpOeso SET VAL = VAL + ' suspected' WHERE VAL LIKE '%candida' -- SET @SC = @SC + ' suspected'

			--IF @SuspectedHerpes = 1 INSERT INTO @tmpOeso (Val) VALUES(@SH)
			--IF @SuspectedCandida = 1 INSERT INTO @tmpOeso (Val) VALUES(@SC)

			--Caustic ingestion
			IF @CausticIngestion = 1
			BEGIN
				SET @tmpVal = ''
				SET @tmpVal = CASE @CausticIngestionSeverity
							WHEN 1 THEN 'mild '
							WHEN 2 THEN 'moderate '
							WHEN 3 THEN 'severe '
							ELSE ''
						END
				SET @tmpVal = @tmpVal + 'caustic ingestion'
				INSERT INTO @tmpOeso (Val) VALUES(@tmpVal)
			END

			--Corrosive ingestion burns
			IF @CorrosiveBurns = 1
			BEGIN
				SET @tmpVal = ''
				SET @tmpVal = CASE @CorrosiveBurnsSeverity
							WHEN 1 THEN 'mild '
							WHEN 2 THEN 'moderate '
							WHEN 3 THEN 'severe '
							ELSE ''
						END
				SET @tmpVal = @tmpVal + 'corrosive ingestion burns'
				INSERT INTO @tmpOeso (Val) VALUES(@tmpVal)
				print(11)
			END
			
			--Eosinophilic
			IF @Eosinophilic = 1
			BEGIN
				SET @tmpVal = ''
				SET @tmpVal = CASE @EosinophilicSeverity
							WHEN 1 THEN 'mild '
							WHEN 2 THEN 'moderate '
							WHEN 3 THEN 'severe '
							ELSE ''
						END
				SET @tmpVal = @tmpVal + 'eosinophilic'
				INSERT INTO @tmpOeso (Val) VALUES(@tmpVal)
			END
			
			--Other
			If @OtherTypeOther = 1 AND LTRIM(RTRIM(@OtherTypeOtherDesc)) <> ''
			BEGIN
				SET @tmpVal = ''
				SET @tmpVal = LTRIM(RTRIM(@OtherTypeOtherDesc))
				SET @tmpVal = dbo.fnFirstLetterUpper(@tmpVal)
				INSERT INTO @tmpOeso (Val) VALUES(@tmpVal)
			END
		END  --'Of Oesophagitis other

		--Mucosal appearance
		IF @MucosalAppearance > 0
		BEGIN
			SET @tmpVal = ''
			SET @tmpVal = CASE @MucosalAppearance
						WHEN 1 THEN 'normal mucosa'
						WHEN 2 THEN 'discrete erosion '
						WHEN 3 THEN 'discrete pseudomembranes '
						WHEN 4 THEN 'confluent ulceration '
						WHEN 5 THEN 'confluent pseudomembranes '
						ELSE ''
					END
			INSERT INTO @tmpOeso (Val) VALUES(@tmpVal)
			--IF @Reflux = 1 SET @temp = @temp + 'with '
		END

		SET @XMLlist = (SELECT Val FROM @tmpOeso FOR XML  RAW, ELEMENTS, TYPE)
		SET @nonMSMOesoText = dbo.fnBuildString(@XMLlist)

		--If there's only one of the above then the sentence will be concatenated with any others using the 'with' conjunction, else it will read 'together with'
		IF ISNULL((SELECT COUNT(Val) FROM @tmpOeso WHERE NOT VAL IS NULL),0) = 1
			SET @withText = ' with '
		ELSE IF ISNULL((SELECT COUNT(Val) FROM @tmpOeso WHERE NOT VAL IS NULL),0) <> 0
			SET @withText = ' together with '

		DECLARE @OesophagitisClassification BIT
		SELECT @OesophagitisClassification = ISNULL(OesophagitisClassification,0) FROM ERS_SystemConfig 
		WHERE OperatingHospitalID = 
			(SELECT OperatingHospitalID FROM ERS_Procedures WHERE ProcedureId = 
				(SELECT ProcedureId FROM ERS_Sites WHERE SiteId = @SiteId))

		--Which Oeso Classification?
		IF @LAClassification > 0 OR @OesophagitisClassification > 0
		BEGIN
			SET @tmpVal = ''
			SET @tmpVal = CASE @LAClassification
						WHEN 1 THEN 'grade A oesophagitis (mucosal breaks confined to the mucosal fold each no longer than 5mm'
						WHEN 2 THEN 'grade B oesophagitis (at least one mucosal break longer than 5mm confined to the mucosal fold but not continuous between two folds'
						WHEN 3 THEN 'grade C oesophagitis (mucosal breaks that are continuous between the tops of mucosal folds but not circumferential'
						WHEN 4 THEN 'grade D oesophagitis (extensive mucosal breaks engaging at least 75% of the oesophageal circumference'
						ELSE ''
					END
				
			IF @ActiveBleeding = 1 SET @tmpVal = @tmpVal + ' with active bleeding'
			IF @tmpVal > '' SET @tmpVal = @tmpVal + ')'

			DELETE @tmpOeso

			--If there's Short oesophagus
			IF @ShortOesophagus = 1 INSERT INTO @tmpOeso (Val) VALUES('short oesophagus')

			--If there's Ulceration
			IF @Ulcer = 1 INSERT INTO @tmpOeso (Val) VALUES('ulcer')

			IF @Stricture = 1 INSERT INTO @tmpOeso (Val) VALUES('stricture')
				
			SET @XMLlist = (SELECT Val FROM @tmpOeso FOR XML  RAW, ELEMENTS, TYPE)

			IF (SELECT COUNT(Val) FROM @tmpOeso) > 0 SET @tmpVal = @tmpVal + ' and ' + dbo.fnBuildString(@XMLlist)

			IF @tmpVal <> '' SET @LAClassText = dbo.fnFirstLetterUpper(@tmpVal)
		END
		ELSE
		BEGIN
			SET @tmpVal = ''

			DELETE FROM @tmpOeso

			If @MSMGrade5=1 SET @nonGrade5MSMText = @mMSM + 'grade 5. '

			--If the site has both reflux grade 5 and grade 4
			If @MSMGrade5=1 AND (@MSMGrade4=1 OR @MSMGrade3=1 OR @MSMGrade2b=1 OR @MSMGrade2a=1 OR @MSMGrade1=1) 
			BEGIN
				SET @nonGrade5MSMText = @nonGrade5MSMText + 'This is associated with '
				SET @mMSM = 'grade 4 '
			END

			--If the site is not 5 but is 4 or less
			If @MSMGrade5=0 AND (@MSMGrade4=1 OR @MSMGrade3=1 OR @MSMGrade2b=1 OR @MSMGrade2a=1 OR @MSMGrade1=1) 
			BEGIN
				SET @nonGrade5MSMText = @nonGrade5MSMText + @mMSM

				IF @MSMGrade4=1
				BEGIN
					SET @nonGrade5MSMText = @nonGrade5MSMText + 'grade 4 '
					SET @Grade = ''
					SET @mMSM = ''
				END
			END

			IF @MSMGrade4=1
			BEGIN
				SET @plus = ' plus '
				IF @ShortOesophagus=0 AND @Ulcer=0 AND @Stricture=0 
					SET @nonGrade5MSMText = @nonGrade5MSMText + @mMSM + 'chronic lesions'
			END

			--If there's Grade 4 Short oesophagus
			IF @ShortOesophagus=1 INSERT INTO @tmpOeso (Val) VALUES('short oesophagus')

			--If there's Grade 4 Ulceration
			IF @Ulcer=1  INSERT INTO @tmpOeso (Val) VALUES('ulcer')

			IF @Stricture=1  INSERT INTO @tmpOeso (Val) VALUES('stricture')

			IF (SELECT COUNT(Val) FROM @tmpOeso) > 0
			BEGIN
				SET @XMLlist = (SELECT Val FROM @tmpOeso FOR XML  RAW, ELEMENTS, TYPE)
				SET @nonGrade5MSMText = RTRIM(@nonGrade5MSMText) + ' ' + @mMSM + dbo.fnBuildString(@XMLlist)
			END 

			SET @sg2common = 'multiple erosions, non-circumferential, '
			SET @sg2common1 = 'affecting more than one longitudinal fold '

			IF @Grade <> ''
			BEGIN
				SET @sg1 = @Grade + '1 '
				SET @sg2 = @Grade + '2 '
				SET @sg2a = @Grade + '2a '
				SET @sg2b = @Grade + '2b '
				SET @sg3 = @Grade + '3 '
			END

			SET @sg1 = @sg1 + 'single or isolated erosion(s), oval or linear, but affecting only one longitudinal fold '
			SET @sg2 = @sg2 + @sg2common + @sg2common1
			SET @sg2a = @sg2a + @sg2common + 'without confluence, ' + @sg2common1
			SET @sg2b = @sg2b + @sg2common + 'with confluence, ' + @sg2common1
			SET @sg3 = @sg3 + 'circumferential erosion' 
				
			--If reflux grade 3, 2b, 2a or 1 then just report the grade description.
			If @MSMGrade3=1 SET @nonGrade5MSMText = @nonGrade5MSMText + @plus + @sg3
			If @MSMGrade2b=1 SET @nonGrade5MSMText = @nonGrade5MSMText + @plus + @sg2b
			If @MSMGrade2a=1 SET @nonGrade5MSMText = @nonGrade5MSMText + @plus + @sg2a
			If @MSMGrade1=1 SET @nonGrade5MSMText = @nonGrade5MSMText + @plus + @sg1

			IF LTRIM(RTRIM(@nonGrade5MSMText)) <> ''
			BEGIN
				IF @ActiveBleeding=1 SET @nonGrade5MSMText = @nonGrade5MSMText + ' and active bleeding'
			END
		END

        --'-----------------------------------------------------------------------------------------
        --' if any non Grade 5 has been reported then "active bleeding" has been already included,
        --' if any Grade 5 has been reported then now is the time to add "active bleeding",
        --' but if neither has been reported then it's just "reflux oesophagitis"
        --' (with or without active bleeding)
        --'-----------------------------------------------------------------------------------------
			
		IF LTRIM(RTRIM(@nonGrade5MSMText)) <> ''
		BEGIN
			IF LTRIM(RTRIM(@LAClassText)) = ''
			BEGIN
				IF @Reflux=1 SET @RefluxBleedingOnly = 'Reflux oesophagitis'  --'unspecified type of reflux (no MSM grade)

				IF @ActiveBleeding=1
				BEGIN
					IF @RefluxBleedingOnly <> '' SET @RefluxBleedingOnly = @RefluxBleedingOnly + ' with active bleeding'
					ELSE SET @RefluxBleedingOnly = 'Active bleeding'
				END
			END
		END

        --'If stricture has been reported check to see if scope could pass. Note stricture can
        --'only occur on MSM Grade 4 therefore text is added to nonGrade5MSMText
		--VB6 Code - StrictureReported variable will always be false


		--'complete the unspecified reflux sentence
		SET @RefluxBleedingOnly = dbo.fnAddFullStop(@RefluxBleedingOnly)
		
		IF @nonGrade5MSMText <> ''
		BEGIN
			--If there's non-MSM Oeso text to begin with then we need to combine sentences with the conjuction
			IF @nonMSMOesoText <> ''
				SET @summary = @nonMSMOesoText + @withText + @nonGrade5MSMText
			ELSE
				SET @summary = @nonGrade5MSMText

			IF  @ActiveBleeding=1 SET @Grade5BarrattsText =  ' and active bleeding'
		END
		ELSE
		BEGIN
			--'If there's LA Classification then ...
			IF @LAClassText <> '' 
			BEGIN
				SET @summary = @nonMSMOesoText + @withText + @LAClassText
				SET @LAClassText=''
			END
			ELSE
			BEGIN
				--'But if there's only Oesophagitis other
				SET @summary = @nonMSMOesoText
			END

		END
	END

	SET @Summary = LTRIM(RTRIM(@Summary))
	IF RIGHT(@Summary,1) = '.' SET @Summary = LEFT(@Summary, LEN(@Summary) - 1)
	-- Finally update the summary in abnormalities table
	UPDATE ERS_UpperGIAbnoOesophagitis
	SET Summary = @Summary 
	WHERE SiteId = @siteId

Go

EXEC dbo.DropIfExist @ObjectName = 'TR_UpperGIAbnoOesophagitis',      -- varchar(100)
                     @ObjectTypePrefix = 'TR' -- varchar(5)
GO

CREATE TRIGGER [dbo].[TR_UpperGIAbnoOesophagitis]
ON [dbo].[ERS_UpperGIAbnoOesophagitis]
AFTER INSERT, UPDATE, DELETE 
AS 
	DECLARE @site_id INT, 
			@Action CHAR(1) = 'I', 
			@SuspectedCandida VARCHAR(10) = 'False', 
			@OesophagitisOther VARCHAR(10) = 'False', 
			@OesophagitisReflux VARCHAR(10) = 'False', 
			@NormalMuscosa VARCHAR(10) = 'False',
			@CorrosiveBurns VARCHAR(10) = 'False',
			@Eosinophilic VARCHAR(10) = 'False'

	IF EXISTS(SELECT * FROM DELETED) SET @Action = CASE WHEN EXISTS(SELECT * FROM INSERTED) THEN 'U' ELSE 'D' END

	IF @Action IN ('I', 'U') 
	BEGIN
		SELECT @site_id=SiteId, 
				@SuspectedCandida	= (CASE WHEN SuspectedCandida = 1 THEN 'True' ELSE 'False' END),
				@NormalMuscosa	= (CASE WHEN (MucosalAppearance = 1) THEN 'True' ELSE 'False' END),
				@OesophagitisOther = (CASE WHEN (OtherTypeOther = 1) THEN 'True' ELSE 'False' END),
				@OesophagitisReflux	= (CASE WHEN (Reflux = 1) THEN 'True' ELSE 'False' END),
				@CorrosiveBurns	= (CASE WHEN (CorrosiveBurns = 1) THEN 'True' ELSE 'False' END),
				@Eosinophilic = (CASE WHEN (Eosinophilic = 1) THEN 'True' ELSE 'False' END)
		FROM INSERTED

		EXEC abnormalities_oesophagitis_summary_update @site_id
	END
	-- DELETED
	IF @Action = 'D'
	BEGIN
		SELECT @site_id=SiteId FROM DELETED
	END

	EXEC diagnoses_control_save @site_id , 'D27P1', @SuspectedCandida		-- 'Candida'
	EXEC diagnoses_control_save @site_id , 'D33P1', @OesophagitisOther		-- 'OesophagitisOther'
	EXEC diagnoses_control_save @site_id , 'D36P1', @OesophagitisReflux		-- 'OesophagitisReflux'
	EXEC diagnoses_control_save @site_id , 'D107P1', @NormalMuscosa		-- 'Normal Muscosa'
	EXEC diagnoses_control_save @site_id , 'N2005', @CorrosiveBurns		-- 'Normal Muscosa'
	EXEC diagnoses_control_save @site_id , 'D65P1', @Eosinophilic		-- 'Eosinophilic'
	EXEC sites_summary_update @site_id

GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	No TFS - Item 3829  by Ferdowsi
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ferdowsi On 29 April 2024
-- TFS#	No TFS - Item 2923
-- Description of change
-- Added Polyp text in the summary
------------------------------------------------------------------------------------------------------------------------
GO
EXEC dbo.DropIfExist @ObjectName = 'specimens_ogd_summary_update',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[specimens_ogd_summary_update]
(
	@SiteId INT
)
/*
	Update History		:		
						:	09 Feb 2024		MH	added Biopsy sites details for Specimens taken
*/
AS
	SET NOCOUNT ON

	DECLARE 
		@summary VARCHAR (8000),
		@tempsummary VARCHAR(1000),
		@RegionId INT,
		@None BIT,
		@BrushCytology BIT,
		@Biopsy BIT,
		@BiopsiesTakenAtRandom BIT,
		@BiopsiesTakenAtSites BIT,
		@BiopsyQtyHistology INT,
		@BiopsyQtyMicrobiology INT,
		@BiopsyQtyVirology INT,
		@BiopsyDistance DECIMAL(6,2),
		@ForcepType SMALLINT,
		@ForcepSerialNo NVARCHAR(50),
		--@ForcepSerialNoDesc VARCHAR(100),
		@Urease BIT,
		@UreaseResult TINYINT,
		@Polypectomy BIT,
		@PolypectomyQty INT,
		@HotBiopsy BIT,
		@NeedleAspirate BIT,	
		@NeedleAspirateHistology BIT,
		@NeedleAspirateMicrobiology BIT, 
		@NeedleAspirateVirology BIT,
		@GastricWashing BIT,
		@Bile_PanJuice BIT,
		@Bile_PanJuiceCytology BIT,
		@Bile_PanJuiceBacteriology BIT,
		@Bile_PanJuiceAnalysis BIT,
		@EUSFNANumberOfPasses INT,
		@EUSFNANeedleGauge INT,
		@FNB BIT,
		@EUSFNBNumberOfPasses INT,
		@EUSFNBNeedleGauge INT,
		@BrushBiopsy BIT,
		@TumourMarkers BIT,
		@AmylaseLipase BIT,
		@CytologyHistology BIT,
		@FullStop VARCHAR(5) = '. ',
		@FNAAssessedAtProc BIT,
		@FNBAssessedAtProc BIT,
		@AdequateFNA BIT,
		@AdequateFNB BIt,
		@NeedleBiopsyHistology BIT,
		@NeedleBiopsyCytology BIT,	
		@NeedleBiopsyMicrobiology BIT,
		@NeedleBiopsyVirology BIT
		,@SpecimensBiopsySitesDetails varchar(max)

	SELECT 
		@summary = '',
		@RegionId = s.RegionId,
		@None=[None],
		@BrushCytology=BrushCytology,
		@Biopsy=Biopsy,
		@BiopsiesTakenAtRandom=BiopsiesTakenAtRandom,
		@BiopsiesTakenAtSites=BiopsiesTakenAtSites,
		@BiopsyQtyHistology=BiopsyQtyHistology,
		@BiopsyQtyMicrobiology=BiopsyQtyMicrobiology,
		@BiopsyQtyVirology=BiopsyQtyVirology,
		@BiopsyDistance=BiopsyDistance,
		@ForcepType = p.ForcepType,
		@ForcepSerialNo = (SELECT isnull(p.ForcepSerialNo, '') as [text()] FOR XML PATH('')),
		--@ForcepSerialNoDesc = l.[ListItemText],
		@Urease=Urease,
		@UreaseResult=UreaseResult,
		@Polypectomy=Polypectomy,
		@PolypectomyQty=PolypectomyQty,
		@HotBiopsy=HotBiopsy,
		@NeedleAspirate=NeedleAspirate,
		@NeedleAspirateHistology=NeedleAspirateHistology,
		@NeedleAspirateMicrobiology=NeedleAspirateMicrobiology,
		@NeedleAspirateVirology=NeedleAspirateVirology,
		@GastricWashing=GastricWashing,
		@Bile_PanJuice = Bile_PanJuice,
		@Bile_PanJuiceCytology = Bile_PanJuiceCytology,
		@Bile_PanJuiceBacteriology = Bile_PanJuiceBacteriology,

		@EUSFNANumberOfPasses = EUSFNANumberOfPasses,
		@EUSFNANeedleGauge = EUSFNANeedleGauge,
		@FNB = FNB,
		@EUSFNBNumberOfPasses = EUSFNBNumberOfPasses,
		@EUSFNBNeedleGauge = EUSFNBNeedleGauge,
		@BrushBiopsy = BrushBiopsy,
		@TumourMarkers = TumourMarkers,
		@AmylaseLipase = AmylaseLipase,
		@CytologyHistology = CytologyHistology,
		@FNAAssessedAtProc = FNASampleAssessedAtProcedure,
		@FNBAssessedAtProc = FNBSampleAssessedAtProcedure,
		@AdequateFNA = AdequateFNA,
		@AdequateFNB = AdequateFNB,
		--@Bile_PanJuiceCytology = Bile_PanJuiceCytology,
		--@Bile_PanJuiceBacteriology = Bile_PanJuiceBacteriology,
		--@Bile_PanJuiceAnalysis = Bile_PanJuiceAnalysis
		@NeedleBiopsyHistology = NeedleBiopsyHistology ,
		@NeedleBiopsyCytology = NeedleBiopsyCytology,	
		@NeedleBiopsyMicrobiology = NeedleBiopsyMicrobiology,
		@NeedleBiopsyVirology = NeedleBiopsyVirology
	FROM
		ERS_UpperGISpecimens sp
	JOIN
		ERS_Sites s ON sp.SiteId = s.SiteId
	JOIN
		ERS_Procedures p ON s.ProcedureId = p.ProcedureId
	--LEFT OUTER JOIN
	--	ERS_Lists l ON p.ForcepSerialNo = l.[ListItemNo] AND l.[ListDescription] = 'Forcep Serial Numbers'
	WHERE 
		sp.SiteId = @SiteId

	
		--MH added on 09 Feb 2024 - Item 57 in V10 release spreadsheet
		Set @SpecimensBiopsySitesDetails = ''
		if exists(Select * from ERS_SiteSpecimens Where SiteId = @SiteId)
		Begin
			SELECT @SpecimensBiopsySitesDetails = isnull(@SpecimensBiopsySitesDetails, '') + (SELECT STUFF((
																					SELECT ',' + BS.Description + ' at ' + cast(Distance as varchar(5)) + ' cm, ' + cast(Qty as varchar(5)) + ' Qty' 
																					from ERS_SiteSpecimens SS
																					inner join ERS_BiopsySites BS on SS.BiopsySiteId =BS.UniqueId
																					Where SiteId = @SiteId
																					FOR XML PATH('')), 1, 1, '') Code )
		End	


	IF @None = 1
		SET @summary = @summary + 'No specimens taken'
	ELSE
	BEGIN

		IF @AmylaseLipase = 1 
		BEGIN
			IF @summary <> '' SET @summary = @summary + @FullStop
			SET @summary = @summary + 'Amylase and lipase'
		END

		IF @Bile_PanJuice = 1
		BEGIN
			DECLARE @BileTxt VARCHAR(30) = 'Bile'

			IF (SELECT 1 FROM ERS_Regions WHERE RegionId = @RegionId AND 
				Region IN ('Uncinate Process', 'Head', 'Neck', 'Body', 'Tail', 'Accessory Pancreatic Duct', 'Main Pancreatic Duct') ) = 1
					SET @BileTxt = 'Pancreatic juice'
		
			IF @Bile_PanJuiceBacteriology = 1 OR @Bile_PanJuiceCytology = 1 
			BEGIN
				SET @tempsummary = ''
				IF @Bile_PanJuiceCytology = 1
					SET @tempsummary = @tempsummary + 'cytology'
				IF @Bile_PanJuiceBacteriology = 1 
						IF @tempsummary = '' SET @tempsummary = 'microbiology'
						ELSE SET @tempsummary = @tempsummary + ', microbiology'
				SET @BileTxt = 	@BileTxt + ' (' + @tempsummary + ')'
			END
			IF @summary <> '' SET @summary = @summary + @FullStop
			SET @summary = @summary + @BileTxt
		END

		IF @Biopsy = 1 
		BEGIN
			IF @summary <> '' SET @summary = @summary + @FullStop
			SET @summary = @summary + 'Biopsy'

			IF @BiopsyQtyHistology > 0 OR @BiopsyQtyMicrobiology > 0 OR @BiopsyQtyVirology > 0
			BEGIN
				SET @tempsummary = ''
				IF @BiopsiesTakenAtRandom = 1
				BEGIN
					SET @tempsummary = CONVERT(VARCHAR, ISNULL(@BiopsyQtyHistology,0) + ISNULL(@BiopsyQtyMicrobiology,0) + ISNULL(@BiopsyQtyVirology,0) )
										+ ' x random'
				END
				ELSE IF @BiopsiesTakenAtSites = 1
				BEGIN
					DECLARE @TotalProtocolSites int = (SELECT COUNT(*) FROM dbo.ERS_SiteSpecimens ess WHERE SiteId = @SiteId AND ProtocolSiteId IS NOT NULL)
					DECLARE @BXTotal int = (SELECT COUNT(Qty) FROM ERS_SiteSpecimens WHERE SiteId = @SiteId)
					SET @tempsummary = CONVERT(VARCHAR, ISNULL(@BiopsyQtyHistology,0) + ISNULL(@BiopsyQtyMicrobiology,0) + ISNULL(@BiopsyQtyVirology,0) )
										+ ' taken ' + CASE WHEN ISNULL(@TotalProtocolSites, 0) > 0 THEN 'using Sydney Protocol ' ELSE '' END + 'from multiple sites'
				END
				ELSE
				BEGIN
					IF @BiopsyQtyHistology > 0 SET @tempsummary = CONVERT(VARCHAR(10), @BiopsyQtyHistology) + ' to histology'
					IF @BiopsyQtyMicrobiology > 0
					BEGIN
						IF @tempsummary <> '' SET @tempsummary = @tempsummary + ', ' + CONVERT(VARCHAR(10), @BiopsyQtyMicrobiology) + ' to microbiology'
						ELSE SET @tempsummary = CONVERT(VARCHAR(10), @BiopsyQtyMicrobiology) + ' to microbiology'
					END
					IF @BiopsyQtyVirology > 0
					BEGIN
						IF @tempsummary <> '' SET @tempsummary = @tempsummary + ', ' + CONVERT(VARCHAR(10), @BiopsyQtyVirology) + ' to virology'
						ELSE SET @tempsummary = CONVERT(VARCHAR(10), @BiopsyQtyVirology) + ' to virology'
					END
				END
				SET @summary = @summary + ' ('
				SET @summary = @summary + @tempsummary
				SET @summary = @summary + ')'
			END
			IF @ForcepType > 0 OR ISNULL(@ForcepSerialNo,'') <> ''
			BEGIN
				IF @ForcepType = 1 
				BEGIN
					SET @summary = @summary + ' with disposable forceps'
					IF ISNULL(@ForcepSerialNo,'') <> '' SET @summary = @summary + ' (serial number: ' + @ForcepSerialNo + ')'
				END
				--ELSE IF @ForcepType = 2 
				--BEGIN
				--	SET @summary = @summary + ' (Forceps - Reusable'
				--	IF @ForcepSerialNo > 0 SET @summary = @summary + ', Serial No: ' + @ForcepSerialNoDesc
				--	SET @summary = @summary + ')'
				--END
			END

			------------------------------------------------------------------------------------------------------------------------
			-- Updated by	:	Siddikur Rahman
			-- TFS#	4041
			-- Description of change: Added biopsy distance option for clinical report
			-------------------------------------------------------------------------------------------------------------------------

			IF @BiopsyDistance > 0
			BEGIN
				SET @summary = @summary + ', Distance ' + CONVERT(VARCHAR(10), @BiopsyDistance) + ' cm'
			END

			------------------------------------------------------------------------------------------------------------------------
			-- TFS#	4041 Ended
			------------------------------------------------------------------------------------------------------------------------

		END
		
		IF @BrushCytology = 1 
		BEGIN
			IF @summary <> '' SET @summary = @summary + @FullStop
			SET @summary = @summary + 'Brush cytology'
		END

		IF @BrushBiopsy = 1 
		BEGIN
			IF @summary <> '' SET @summary = @summary + @FullStop
			SET @summary = @summary + 'Brush biopsy'
		END

		IF @CytologyHistology = 1 
		BEGIN
			IF @summary <> '' SET @summary = @summary + @FullStop
			SET @summary = @summary + 'Cytology and histology'
		END

		--FNA
		IF @NeedleAspirate = 1 
		BEGIN
			IF @summary <> '' SET @summary = @summary + @FullStop
			SET @summary = @summary + 'Fine needle aspirate'
			
			IF @NeedleAspirateHistology = 1 OR @NeedleAspirateMicrobiology = 1 OR @NeedleAspirateVirology = 1
			BEGIN
				IF @NeedleAspirateHistology = 1 OR @NeedleAspirateMicrobiology = 1 OR @NeedleAspirateVirology = 1
				BEGIN
					SET @tempsummary = ''
					IF @NeedleAspirateHistology = 1 
						SET @tempsummary = @tempsummary + 'cytology'
					IF @NeedleAspirateMicrobiology = 1 
						IF @tempsummary = '' SET @tempsummary = @tempsummary + 'microbiology'
						ELSE SET @tempsummary = @tempsummary + ', microbiology'
					IF @NeedleAspirateVirology = 1 
						IF @tempsummary = '' SET @tempsummary = @tempsummary + 'virology'
						ELSE SET @tempsummary = @tempsummary + ', virology'
					SET @summary = @summary + ' (' + @tempsummary + ')'
				END
			END

			IF @EUSFNANumberOfPasses > 0 SET @summary = @summary + ' (' + CONVERT(VARCHAR(10), @EUSFNANumberOfPasses) + CASE WHEN @EUSFNANumberOfPasses > 1 THEN ' passes' ELSE ' pass' END
			IF @EUSFNANeedleGauge > 0 
			BEGIN
				IF @EUSFNANumberOfPasses > 0 SET @summary = @summary + ' with ' ELSE SET @summary = @summary + ' (with '
				SET @summary = @summary + CONVERT(VARCHAR(10), @EUSFNANeedleGauge) + ' needle gauge)'
			END
			ELSE
				IF @EUSFNANumberOfPasses > 0 SET @summary = @summary + ')'

			IF @FNAAssessedAtProc = 1
				SET @summary = @summary + ' - assessed at procedure'

			IF @AdequateFNA = 1
				SET @Summary = @Summary + ' - adeqate sample retreived '
		END

		--FNB
		IF @FNB = 1 
		BEGIN
			IF @summary <> '' SET @summary = @summary + @FullStop
			SET @summary = @summary + 'Fine needle biopsy'

			IF @NeedleBiopsyHistology = 1 OR @NeedleBiopsyMicrobiology = 1 OR @NeedleBiopsyVirology = 1
			BEGIN
				IF @NeedleBiopsyHistology = 1 OR @NeedleBiopsyMicrobiology = 1 OR @NeedleBiopsyVirology = 1
				BEGIN
					SET @tempsummary = ''
					IF @NeedleBiopsyHistology = 1 
						SET @tempsummary = 'histology'
					IF @NeedleBiopsyCytology = 1 														
						IF @tempsummary = '' SET @tempsummary = @tempsummary + 'cytology'
						ELSE SET @tempsummary = @tempsummary + ', cytology'
					IF @NeedleBiopsyMicrobiology = 1 
						IF @tempsummary = '' SET @tempsummary = @tempsummary + 'microbiology'
						ELSE SET @tempsummary = @tempsummary + ', microbiology'
					IF @NeedleBiopsyVirology = 1 
						IF @tempsummary = '' SET @tempsummary = @tempsummary + 'virology'
						ELSE SET @tempsummary = @tempsummary + ', virology'
					SET @summary = @summary + ' (' + @tempsummary + ')'
				END
			END

			IF @EUSFNBNumberOfPasses > 0 SET @summary = @summary + ' (' + CONVERT(VARCHAR(10), @EUSFNBNumberOfPasses) + CASE WHEN @EUSFNBNumberOfPasses > 1 THEN ' passes' ELSE ' pass' END
			IF @EUSFNBNeedleGauge > 0 
			BEGIN
				IF @EUSFNBNumberOfPasses > 0 SET @summary = @summary + ' with ' ELSE SET @summary = @summary + ' (with '
				SET @summary = @summary + CONVERT(VARCHAR(10), @EUSFNBNeedleGauge) + ' needle gauge)'
			END
			ELSE
				IF @EUSFNBNumberOfPasses > 0 SET @summary = @summary + ')'

			IF @FNBAssessedAtProc = 1
				SET @summary = @summary + ' - assessed at procedure'

			IF @AdequateFNB = 1
				SET @Summary = @Summary + ' - adeqate sample retreived '
		END

		IF @GastricWashing = 1 
		BEGIN
			IF @summary <> '' SET @summary = @summary + @FullStop
			SET @summary = @summary + 'Gastric Washing'
		END

		IF @HotBiopsy = 1 
		BEGIN
			IF @summary <> '' SET @summary = @summary + @FullStop
			SET @summary = @summary + 'Hot biopsy'
		END
		
		IF @Polypectomy = 1 
		BEGIN
			IF @summary <> '' SET @summary = @summary + @FullStop
			SET @summary = @summary + 'Polypectomy'
			
			IF @PolypectomyQty > 0 
			BEGIN
				SET @summary = @summary + ' (' + CONVERT(VARCHAR(10), @PolypectomyQty) + CASE WHEN @PolypectomyQty > 1 THEN ' polyps' ELSE ' polyp' END

				if exists(Select 1 from ERS_UpperGITherapeutics where SiteId = @SiteId and PolypectomyRemovalType in (1,2,3,4,5,6,7))
				BEGIN
					SELECT @summary = @summary + CASE PolypectomyRemovalType 
											WHEN 1 THEN ' by partial Snare'
											WHEN 2 THEN ' by cold snare'
											WHEN 3 THEN ' by hot snare cauterisation'
											WHEN 4 THEN ' by hot biopsy'
											WHEN 5 THEN ' by cold biopsy'
											WHEN 6 THEN ' by hot snare by EMR'
											WHEN 7 THEN ' by cold snare by EMR'
										END
					FROM ERS_UpperGITherapeutics where SiteId = @SiteId
				END
				SET @summary = @summary + ')'
			END
		END
		
		IF @TumourMarkers = 1 
		BEGIN
			IF @summary <> '' SET @summary = @summary + @FullStop
			SET @summary = @summary + 'Tumour markers'
		END

		IF @Urease = 1 
		BEGIN
			IF @summary <> '' SET @summary = @summary + @FullStop

			IF @UreaseResult = 1 SET @summary = @summary + 'Positive urease test for H. pylori'
			ELSE IF @UreaseResult = 2 SET @summary = @summary + 'Urease test for H. pylori proved negative'
			ELSE  SET @summary = @summary + 'Urease test'
		END
	END

	--MH Added on 09 Feb 2024
	if(IsNull(@SpecimensBiopsySitesDetails,'') <> '')
	Begin
		Set @summary = @summary + ', - Biopsy sites: ' + @SpecimensBiopsySitesDetails
	End
	

	-- Finally, update the summary in specimens table
	UPDATE ERS_UpperGISpecimens 
	SET Summary=@summary 
	WHERE SiteId = @SiteId

GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	No TFS - Item 2923  by Ferdowsi
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Siddikur Rahman
-- TFS#	3771
-- Description of change: Fixed issue with pre populating allergies
-------------------------------------------------------------------------------------------------------------------------

EXEC dbo.DropIfExist 
    @ObjectName = 'patient_allergy_select', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[patient_allergy_select]
(
	@PatientId int,
	@ProcedureId int
)
AS
BEGIN
	SELECT TOP 1 AllergyResult, AllergyDescription 
	FROM ERS_PatientAllergies 
	WHERE PatientId = @PatientId
	ORDER BY ProcedureCreatedId DESC
END

GO

------------------------------------------------------------------------------------------------------------------------
-- TFS#	3771 Ended
------------------------------------------------------------------------------------------------------------------------


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Siddikur Rahman
-- TFS#	3856
-- Description of change: Added hot snare by EMR on report
-- Updated by	:	Rony
-- TFS#	2970
-- Description of change: tattoo on tomour
-------------------------------------------------------------------------------------------------------------------------

GO
 IF NOT EXISTS (
        SELECT 1
        FROM INFORMATION_SCHEMA.COLUMNS
        WHERE TABLE_NAME = 'ERS_CommonAbnoPolypDetails' AND
              COLUMN_NAME IN ('TattooLocationDistal', 'TattooLocationProximal')
    )
    BEGIN
		
		ALTER TABLE dbo.ERS_CommonAbnoPolypDetails
            ADD TattooLocationDistal bit,
             TattooLocationProximal bit;
    END
GO

EXEC dbo.DropIfExist 
    @ObjectName = 'common_polpydetails_summary', 
    @ObjectTypePrefix = 'F'
GO

CREATE FUNCTION [dbo].[common_polpydetails_summary]
(
	@SiteId int,
	@PolypDetailId int = NULL
)
RETURNS VARCHAR(max)
AS
BEGIN
	DECLARE 
	@PolypType varchar(100),
	@TumourType varchar(100),
	@PolypCondition varchar(100), 
	@Tattooed varchar(100),
	@TattooMarkingType varchar(100),
	--@PolypDetailId int,
	@Quantity int,
	@summary varchar(max) = '',
	@Probably bit,
	@TumourTypeId int,
	@Size int,
	@ParisClass int,
	@PitPattern int,
	@Excised int,
	@Retrieved int,
	@ToLabs int,
	@Removal int,
	@RemovalType varchar(10) = '',
	@RemovalMethod int,
	@RemovalBy varchar(500) = '',
	@Inflam bit,
	@PostInflam bit,
	@TattooedId int,
	@TattooMarkingTypeId int,
	@Count int,
	--Added by rony tfs-2970 start
	@TattooLocationDistal BIT,
	@TattooLocationProximal BIT

	SELECT @Quantity = count(*)
	FROM ERS_CommonAbnoPolypDetails WHERE SiteId = @SiteId AND PolypDetailId = ISNULL(@PolypDetailId, PolypDetailId)

	SELECT @PolypType = LOWER([Description])
	FROM ERS_PolypTypes pt
		INNER JOIN ERS_CommonAbnoPolypDetails l ON pt.UniqueId = l.PolypTypeId
	WHERE SiteId = @SiteId


	DECLARE cur CURSOR FOR
	--Added by rony tfs-2970
	SELECT ecapd.PolypDetailId, ecapd.Size, ecapd.Excised, ecapd.Retreived, ecapd.Successful, ecapd.Removal, ecapd.RemovalMethod, ecapd.Probably, ecapd.Type, ecapd.ParisClass, ecapd.PitPattern, 
		ecapd.Infammatory, ecapd.PostInflammatory, ecapd.TattooedId, ecapd.TattooedMarkingTypeId,ecapd.TattooLocationDistal,ecapd.TattooLocationProximal
	FROM dbo.ERS_CommonAbnoPolypDetails ecapd
	WHERE SiteId = @SiteId AND PolypDetailId = ISNULL(@PolypDetailId, PolypDetailId)

	SET @summary = CASE WHEN @PolypDetailId IS NULL THEN CONVERT(VARCHAR(10), @Quantity) + ' ' + @PolypType + CASE WHEN @Quantity = 1 THEN ' polyp' ELSE ' polyps' END ELSE '' END
	SET @Count = 1
	--loop through records
	OPEN cur
	--Added by rony tfs-2970
	FETCH NEXT FROM cur INTO @PolypDetailId, @Size, @Excised, @Retrieved, @ToLabs, @Removal, @RemovalMethod, @Probably, @TumourTypeId, @ParisClass, @PitPattern, @Inflam, @PostInflam, @TattooedId, @TattooMarkingTypeId,@TattooLocationDistal,@TattooLocationProximal

	WHILE @@FETCH_STATUS = 0 
	BEGIN
		SET  @Tattooed = NULL
		SET @TumourType = ''
		SET @TattooMarkingType = NULL

		--build up summary report
		SELECT @TumourType = LOWER(ISNULL([Description],''))
		FROM ERS_TumourTypes
		WHERE UniqueId = @TumourTypeId

		SELECT @Tattooed = LOWER([Description])
		FROM ERS_TattooOptions
		WHERE UniqueId = @TattooedId

		SELECT @TattooMarkingType = LOWER(ISNULL([Description],''))
		FROM ERS_MarkingTypes
		WHERE UniqueId = @TattooMarkingTypeId

		SELECT @PolypCondition = (
			SELECT STUFF((SELECT ', ' + LOWER(ISNULL([SummaryTerm],''))as [text()] 
		    FROM ERS_CommonAbnoPolypConditions cc
				INNER JOIN ERS_PolypConditions pd on cc.PolypConditionId = pd.UniqueId
			WHERE PolypDetailId = @PolypDetailId AND [Description] <> 'Hyperplastic'
			ORDER BY ISNULL(ListOrderBy,9999)
		    FOR XML PATH('')),1,1,''))
		
		SELECT @RemovalType = LOWER([Description])
		FROM ERS_PolypRemovalMethods
		WHERE UniqueId = @Removal

		SELECT @RemovalBy = Description
		FROM ERS_PolypRemovalTypes
		WHERE UniqueId = @RemovalMethod

		SELECT @PolypCondition = dbo.fnStringToSentance(@PolypCondition)

		DECLARE @IsHyperplastic BIT = (SELECT 1 FROM ERS_CommonAbnoPolypConditions cc
				INNER JOIN ERS_PolypConditions pd on cc.PolypConditionId = pd.UniqueId
			WHERE PolypDetailId = @PolypDetailId AND [Description] = 'Hyperplastic')

		IF @Quantity > 1 SET @summary = @summary + '<br/>Polyp ' + convert(varchar(10), @Count) + '- '
		IF ISNULL(@PolypCondition,'') <> '' OR ISNULL(@IsHyperPlastic,0) = 1
		BEGIN
		 SET @summary = @summary + CASE WHEN ISNULL(@IsHyperPlastic,0) = 1 THEN 'Hyperplastic ' ELSE '' END +  CASE WHEN ISNULL(@PolypCondition,'') <> '' THEN 'with' + @PolypCondition ELSE '' END + ': ' --ELSE SET @summary = @summary + '<br/>'
		END

		IF @PolypType = 'sessile'
			BEGIN
				IF @Probably = 1 SET @summary = @summary + 'probably '

				SET @summary = @summary + ' ' + @TumourType + ' '

				IF (@Quantity > 0 AND @Size > 0) 
				BEGIN
					SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @Size) + 'mm) '
				END

				IF @ParisClass > 0 OR @PitPattern > 0
				BEGIN
					SET @summary = @summary + '('

					IF @ParisClass > 0 
					SET @summary = @summary +
							 CASE @ParisClass
								   WHEN  1 THEN 'Paris Is'
								   WHEN  2 THEN 'Paris IIa'
								   WHEN  3 THEN 'Paris IIa + IIc'
								   WHEN  4 THEN 'Paris IIb'
								   WHEN  5 THEN 'Paris IIc'
								   WHEN  6 THEN 'Paris IIc + IIa'
								   WHEN  7 THEN 'Paris Ip'
								   WHEN  8 THEN 'Paris Isp'
								   WHEN  10 THEN 'Paris LST-G'
								   WHEN  11 THEN 'Paris LST-NG'
								   WHEN  12 THEN 'Paris LST-D'
								   WHEN  13 THEN 'Paris LST-M'
								   ELSE ''
					END

					IF @PitPattern > 0 
					BEGIN
						IF @ParisClass > 0 SET @summary = @summary + ', '
				
						SET @summary = @summary +
								   CASE @PitPattern
										  WHEN  1 THEN 'pit type I'
										  WHEN 2 THEN 'pit type II'
										  WHEN  3 THEN 'pit type IIIs'
										  WHEN  4 THEN 'pit type IIIL'
										  WHEN  5 THEN 'pit type IV'
										  WHEN  6 THEN 'pit type V'
							ELSE ''
						END
					END

					SET @summary = @summary + ')'
				END

				IF @Excised = 1 
				BEGIN
					SET @summary = @summary + '$$ '
					SET @summary = @summary + 'excised '

					IF @Removal > 0 OR @RemovalMethod > 0
					BEGIN
						SET @summary = @summary + '(removed '
				
						IF @Removal > 0 SET @summary = @summary + @RemovalBy + ' '
						IF @RemovalMethod > 0 SET @summary = @summary + @RemovalType
						
						SET @summary = @summary + ')'
					END
				END

				IF @Retrieved = 1 
				BEGIN
					SET @summary = @summary + '$$ '
					SET @summary = @summary + 'retrieved '
				END

				IF @ToLabs = 1  
				BEGIN
					SET @summary = @summary + '$$ '
					SET @summary = @summary + 'sent to labs '
				END
						

				-- Set the last occurence of $$ to "and"
				IF CHARINDEX('$$', @summary) > 0 SET @summary = STUFF(@summary, len(@summary) - charindex('$$', reverse(@summary)), 3, ' and ')
				-- Replace all other occurences of $$ with commas
				SET @summary = REPLACE(@summary, '$$', ',')
			END

			------------------------------------------------------------------------------------------
			-------	PEDUNCULATED -------
			------------------------------------------------------------------------------------------
			ELSE IF @PolypType = 'pedunculated'
			BEGIN
				--IF @Quantity > 0 SET @summary = @summary + CONVERT(VARCHAR(20), @Quantity) + ' '
		
				IF @Probably = 1 SET @summary = @summary + 'probably '

				IF @TumourTypeId = 1 SET @summary = @summary + 'benign '
				ELSE IF @TumourTypeId = 2 SET @summary = @summary + 'malignant '

				IF @ParisClass = 2 
					SET @summary = @summary + 'sub pedunculated ' 
				--ELSE
				--	SET @summary = @summary + 'polyp ' 

				IF (@Quantity > 0 AND @Size > 0) 
				BEGIN
					SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @Size) + 'mm) '
				END

				IF @ParisClass > 0 OR @PitPattern > 0
				BEGIN
					SET @summary = @summary + '('

					IF @ParisClass > 0 
					SET @summary = @summary +
					CASE 
						 WHEN  @ParisClass = 7 THEN 'Paris IP'
						 WHEN  @ParisClass = 8 THEN 'Paris Isp'
						ELSE ''
					END

					IF @PitPattern > 0 
					BEGIN
						IF @ParisClass > 0 SET @summary = @summary + ', '
				
						SET @summary = @summary +
						CASE 
							WHEN @PitPattern = 1 THEN 'pit type I'
							WHEN @PitPattern = 2 THEN 'pit type II'
							WHEN @PitPattern = 3 THEN 'pit type IIIs'
							WHEN @PitPattern = 4 THEN 'pit type IIIL'
							WHEN @PitPattern = 5 THEN 'pit type IV'
							WHEN @PitPattern = 6 THEN 'pit type V'
							ELSE ''
						END
					END

					SET @summary = @summary + ')'
				END

				IF @Excised =1
				BEGIN
					SET @summary = @summary + '$$ '
					SET @summary = @summary + ' excised '

					IF @Removal > 0 OR @RemovalMethod > 0
					BEGIN
						SET @summary = @summary + '(removed '
				
						IF @Removal > 0 SET @summary = @summary + @RemovalBy + ' '
						IF @RemovalMethod = 1 SET @summary = @summary + @RemovalType
				
						SET @summary = @summary + ')'
					END
				END

				IF @Retrieved =1 
				BEGIN
					SET @summary = @summary + '$$ '
					SET @summary = @summary + 'retrieved '
				END

				IF @ToLabs =1 
				BEGIN
					SET @summary = @summary + '$$ '
					SET @summary = @summary + 'sent to labs '
				END

				SET @summary = @summary + ')'
				-- Set the last occurence of $$ to "and"
				IF CHARINDEX('$$', @summary) > 0 SET @summary = STUFF(@summary, len(@summary) - charindex('$$', reverse(@summary)), 3, ' and ')
				-- Replace all other occurences of $$ with commas
				SET @summary = REPLACE(@summary, '$$', ',')
			END

			------------------------------------------------------------------------------------------
			-------	PSEUDOPOLYPS -------
			------------------------------------------------------------------------------------------
			ELSE IF @PolypType = 'pseudo'
			BEGIN
				--IF @Quantity > 0 SET @summary = @summary + CONVERT(VARCHAR(20), @Quantity) + ' '

				IF @Inflam = 1 AND @PostInflam = 0 SET @summary = @summary + 'inflammatory '
				ELSE IF @Inflam = 0 AND @PostInflam = 1 SET @summary = @summary + 'post-inflammatory '
				ELSE IF @Inflam = 1 AND @PostInflam = 1 SET @summary = @summary + 'inflammatory and post-inflammatory '
		
				--SET @summary = @summary + 'pseudopolyp ' 

				IF (@Quantity > 0 AND @Size > 0) 
				BEGIN
					SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @Size) + 'mm) '
				END

				IF @ParisClass > 0 OR @PitPattern > 0
				BEGIN
					SET @summary = @summary + '('

					IF @ParisClass > 0 
					SET @summary = @summary +
					 CASE @ParisClass
						WHEN  1 THEN 'Paris Is'
						WHEN  2 THEN 'Paris IIa'
						WHEN  3 THEN 'Paris IIa + IIc'
						WHEN  4 THEN 'Paris IIb'
						WHEN  5 THEN 'Paris IIc'
						WHEN  6 THEN 'Paris IIc + IIa'
						WHEN  7 THEN 'Paris Ip'
						WHEN  8 THEN 'Paris Isp'
						WHEN  10 THEN 'Paris LST-G'
						WHEN  11 THEN 'Paris LST-NG'
						WHEN  12 THEN 'Paris LST-D'
						WHEN  13 THEN 'Paris LST-M'
						ELSE ''
					END

					IF @PitPattern > 0 
					BEGIN
						IF @ParisClass > 0 SET @summary = @summary + ', '
				
						SET @summary = @summary +
						CASE 
							WHEN @PitPattern = 1 THEN 'pit type I'
							WHEN @PitPattern = 2 THEN 'pit type II'
							WHEN @PitPattern = 3 THEN 'pit type IIIs'
							WHEN @PitPattern = 4 THEN 'pit type IIIL'
							WHEN @PitPattern = 5 THEN 'pit type IV'
							WHEN @PitPattern = 6 THEN 'pit type V'
							ELSE ''
						END
					END

					SET @summary = @summary + ')'
				END

				IF @Excised =1 
				BEGIN
					SET @summary = @summary + '$$ '
					SET @summary = @summary + 'excised '

					IF @Removal > 0 OR @RemovalMethod > 0
					BEGIN
						SET @summary = @summary + '(removed '
				
						IF @Removal > 0 SET @summary = @summary + @RemovalBy + ' '
						IF @RemovalMethod = 1 SET @summary = @summary + @RemovalType

						
					END
				END

				IF @Retrieved =1 
				BEGIN
					SET @summary = @summary + '$$ '
					SET @summary = @summary + 'retrieved '
				END

				IF @ToLabs =1 
				BEGIN
					SET @summary = @summary + '$$ '
					SET @summary = @summary + 'sent to labs '
				END

				SET @summary = @summary + ')'

				-- Set the last occurence of $$ to "and"
				IF CHARINDEX('$$', @summary) > 0 SET @summary = STUFF(@summary, len(@summary) - charindex('$$', reverse(@summary)), 3, ' and ')
				-- Replace all other occurences of $$ with commas
				SET @summary = REPLACE(@summary, '$$', ',')
			END
			------------------------------------------------------------------------------------------
			-------	SUBMUCOSAL -------
			------------------------------------------------------------------------------------------
			ELSE IF @PolypType = 'submucosal'
			BEGIN
				IF (@Quantity > 0 AND @Size > 0) 
				BEGIN
					SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @Size) + 'mm) '
				END


				-- Set the last occurence of $$ to "and"
				IF CHARINDEX('$$', @summary) > 0 SET @summary = STUFF(@summary, len(@summary) - charindex('$$', reverse(@summary)), 3, ' and')
				-- Replace all other occurences of $$ with commas
				SET @summary = REPLACE(@summary, '$$', ',')
			END
			--Added by rony tfs-2970 start
			BEGIN
			Declare @TattoLocationMessage varchar(50)
			Declare @TattoMessage varchar(100)
			declare @MaxId int, @MinId int, @loopCounter int

			Set @TattoLocationMessage = ''
			Set @TattoMessage = ''
			If @TattooLocationDistal > 0 
			Begin
				Set @TattoLocationMessage = 'Distal'
			End

			If @TattooLocationProximal > 0 
			Begin
				if @TattoLocationMessage = ''			
					begin
						Set @TattoLocationMessage = 'Proximal'
					end
				else
					begin
						Set @TattoLocationMessage = @TattoLocationMessage + ',Proximal'
					end		
			End

			Select @MinId = Min(id),@MaxId=Max(id) from fnSplitString(@TattoLocationMessage,',') 
			Set @loopCounter = @MinId
			While @loopCounter < (@MaxId+1)
			begin
				if @loopCounter = 1
				begin
					Set @TattoMessage = (Select Item from fnSplitString(@TattoLocationMessage,',') Where Id = @loopCounter)
				end
				else
				begin
					if @loopCounter <> @MaxId 
					begin
						Set @TattoMessage = @TattoMessage + ', ' + (Select Item from fnSplitString(@TattoLocationMessage,',') Where Id = @loopCounter)
					end
					else
					begin
						Set @TattoMessage = @TattoMessage + ' and ' + (Select Item from fnSplitString(@TattoLocationMessage,',') Where Id = @loopCounter)
					end
				end
				set @loopCounter = @loopCounter + 1
			END
			END
			-- End
			IF ISNULL(@Tattooed,'no') <> 'no'
			BEGIN
			--Added by rony tfs-2970
				SET @summary = @summary + '. Polyp ' + CASE WHEN @Tattooed = 'yes' THEN 'tattooed' ELSE ISNULL(@Tattooed, 'previously tattooed') END + ' ' + ISNULL(@TattoMessage, '') + ' ' + CASE WHEN ISNULL(@TattooMarkingType,'') <> '' THEN ' using ' + @TattooMarkingType ELSE '' END
			END
		SET @Count = @Count + 1
		--Added by rony tfs-2970
		FETCH NEXT FROM cur INTO @PolypDetailId, @Size, @Excised, @Retrieved, @ToLabs, @Removal, @RemovalMethod, @Probably, @TumourTypeId, @ParisClass, @PitPattern, @Inflam, @PostInflam, @TattooedId, @TattooMarkingTypeId,@TattooLocationDistal,@TattooLocationProximal

	END

	CLOSE cur
	DEALLOCATE cur

	RETURN @summary + '##'
END

GO

------------------------------------------------------------------------------------------------------------------------
-- TFS#	3856 Ended
------------------------------------------------------------------------------------------------------------------------


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Siddikur Rahman
-- TFS#	3779
-- Description of change: Added drop down to appear when pacemaker is selected
-------------------------------------------------------------------------------------------------------------------------

DECLARE @ParentId INT;
DECLARE @ChildDesc VARCHAR(10);

SELECT @ParentId = UniqueId FROM ERS_Comorbidity WHERE Description = 'Pacemaker'

IF @ParentId IS NOT NULL
BEGIN
	DECLARE @PacemakerChild VARCHAR(50)
	SET @PacemakerChild = 'CRT-D,CRT-P,ICD,PM'
	DECLARE comCursor CURSOR FOR
		SELECT Item FROM fnSplitString(@PacemakerChild, ',')

	OPEN comCursor

	FETCH NEXT FROM comCursor INTO @ChildDesc

	WHILE @@FETCH_STATUS = 0

	BEGIN
		IF NOT EXISTS (SELECT 1 FROM ERS_Comorbidity WHERE Description = @ChildDesc AND ParentId = @ParentId)
		BEGIN
			INSERT INTO ERS_Comorbidity (Description, NEDTerm, ParentId, AdditionalInfo, Suppressed)
			SELECT @ChildDesc, '', @ParentId, 0, 0;

			INSERT INTO ERS_ComorbidityProcedureTypes (ComorbidityId, ProcedureTypeId)
			SELECT ComorbidityId, ProcedureTypeId FROM 
			(VALUES (SCOPE_IDENTITY())) AS Target(ComorbidityId) 
			CROSS APPLY (
			SELECT ProcedureTypeId 
			FROM ERS_ComorbidityProcedureTypes
			WHERE ComorbidityId = @ParentId
			)AS Source;
		END

		FETCH NEXT FROM comCursor INTO @ChildDesc
	END

	CLOSE comCursor
	DEALLOCATE comCursor
END

GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	3779 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Siddikur Rahman
-- TFS#	4047
-- Description of change: Fixed tree not showing correct location with resection in place
-- Updated by	:	Ahmed Shoud
-- TFS#	4046
-- Description of change: Mark Area, not saying correct location on Tree
-------------------------------------------------------------------------------------------------------------------------

GO
INSERT INTO ERS_ResectedColonRegions (ResectedColonID, RegionId)
SELECT rc.ResectedColonID, STUFF(r.RegionId, 1, 1, '4') as RegionId
FROM ERS_Regions r
LEFT JOIN ERS_ResectedColonRegions rc ON r.RegionId = rc.RegionId
WHERE r.ProcedureType = 3
AND NOT EXISTS (
    SELECT 1 
    FROM ERS_ResectedColonRegions existing
    WHERE existing.ResectedColonID = rc.ResectedColonID
    AND existing.RegionId = STUFF(r.RegionId, 1, 1, '4')
)
ORDER BY RegionId;

GO
dbo.DropIfExist
    @ObjectName = 'fnSetAreaDescriptionForGetSitesBYProcedure',      -- varchar(100)
    @ObjectTypePrefix = 'F' -- varchar(5)

GO
CREATE FUNCTION [dbo].[fnSetAreaDescriptionForGetSitesBYProcedure] (@ProcedureId INT, @AreaNo INT, @ResectedColonId INT) 
RETURNS
  VARCHAR(MAX)
AS
BEGIN
	DECLARE @MinRegionID INT, @MaxRegionID INT, @StartRegionId INT, @SiteDesc VARCHAR(MAX)=''
	DECLARE @tmpSites TABLE (SiteId INT, SiteNo INT, RegionId INT, Region VARCHAR(500), IsAnastamosis BIT)

	--Insert site records in temp table
	INSERT INTO @tmpSites
	SELECT MIN(s.SiteId) AS SiteId, s.SiteNo, s.RegionId, 
			CASE 
				WHEN ISNULL(@ResectedColonId,0) > 0  AND
				EXISTS (SELECT 1 FROM ERS_Regions r 
							JOIN ERS_ResectedColonRegions rcr ON r.RegionId = rcr.RegionId
							WHERE r.RegionId = s.RegionId
							AND rcr.ResectedColonId = @ResectedColonId) THEN 'anastomosis'
				ELSE MIN((r.Region))
				END AS Region, 0
	FROM ERS_Sites s 
	INNER JOIN ERS_Regions r ON s.RegionId = r.RegionId AND s.ProcedureId = @ProcedureId AND s.AreaNo = @AreaNo
	GROUP BY s.RegionId, s.SiteNo, s.RegionId
	ORDER BY SiteId

	--Get start site of the area
	SELECT TOP 1 @StartRegionId = RegionId FROM @tmpSites WHERE SiteNo > 0

	--Get minimum & maximum region id of the area to set as the 2 extremity
	SELECT @MinRegionID = MIN(RegionID), @MaxRegionID = MAX(RegionID) FROM @tmpSites 
	
	--Delete the rest, not to include in the description of the area
	DELETE FROM @tmpSites WHERE RegionID NOT IN (@MinRegionID, @MaxRegionID) AND SiteNo = 0
	DELETE FROM @tmpSites WHERE RegionID = @StartRegionId AND SiteNo = 0
	DELETE FROM @tmpSites WHERE Region = (SELECT TOP 1 Region FROM @tmpSites WHERE RegionID = @StartRegionId) AND SiteNo = 0 

	DECLARE @RowCnt INT = (SELECT COUNT(SiteId) FROM @tmpSites)

	IF @RowCnt = 1
		SELECT TOP 1 @SiteDesc = Region FROM @tmpSites ORDER BY SiteId
	ELSE IF @RowCnt = 2
	BEGIN
		SET @SiteDesc = (SELECT TOP 1 Region FROM @tmpSites WHERE SiteNo > 0) 
							+ ' to <br/>the ' + (SELECT TOP 1 Region FROM @tmpSites WHERE SiteNo = 0)
	END
	ELSE IF @RowCnt > 2 -- more than 2 rows (max 3 rows)
	BEGIN
		SET @SiteDesc = (SELECT TOP 1 Region FROM @tmpSites WHERE RegionId = @StartRegionId) 
	END

	RETURN @SiteDesc

END


GO

EXEC dbo.DropIfExist 
    @ObjectName = 'Get_Sites_By_Procedure', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[Get_Sites_By_Procedure]
(
	@ProcedureId as int
)
AS

BEGIN

Select s.Siteid, s.SiteNo, s.AreaNo, s.RegionId , 
	CASE WHEN s.SiteNo = -77 THEN convert(varchar(10), s.XCoordinate) + ' to '
	+ convert(varchar(10), s.YCoordinate) + ' cm' ELSE
	CASE WHEN rcr.ResectedColonID IS NOT NULL THEN 'Anastomosis'
	WHEN ISNULL(s.EBUSLymphNodeSiteId,0) = 0
	THEN 
	-- TFS 4046 Start

		CASE
			WHEN s.AreaNo > 0 THEN dbo.fnSetAreaDescriptionForGetSitesBYProcedure(@ProcedureId, s.AreaNo, rcr.ResectedColonID)
			ELSE r.Region 
		END 
	-- TFS 4046 End
	ELSE ln.Name END END as Region,
	ISNULL(dbo.fnGetSiteTitle(s.SiteNo, p.OperatingHospitalID),'') as SiteName
	FROM ERS_Procedures p
	join ERS_Sites s on p.ProcedureId = s.ProcedureId 
	join ERS_Regions r on s.RegionId = r.RegionId and r.ProcedureType = p.ProcedureType 
	left JOIN ERS_ResectedColonRegions rcr ON r.RegionId = rcr.RegionId AND rcr.ResectedColonId = p.ResectedColonNo
	left join ERS_EBUSLymphNodes ln on ln.EBUSLymphNodeId = s.EBUSLymphNodeSiteId
	where (s.SiteNo > 0 or s.SiteNo = -77) and p.ProcedureId = @ProcedureId AND ISNULL(s.IsProtocol,0) = 0
	UNION ALL
	Select s.Siteid, s.SiteNo, s.AreaNo,s.RegionId, convert(varchar(10), XCoordinate) + ' to '
	+ convert(varchar(10), YCoordinate) + ' cm' as Region , ISNULL(dbo.fnGetSiteTitle(s.SiteNo, p.OperatingHospitalID),'') as SiteName
	FROM ERS_Procedures p
	join ERS_Sites s on p.ProcedureId = s.ProcedureId 
	where s.SiteNo = -77 and p.ProcedureId = @ProcedureId AND ISNULL(s.IsProtocol,0) = 0;

END

Go
--TFS 4046 Start
GO
dbo.DropIfExist
    @ObjectName = 'Get_Sites_With_Description',      -- varchar(100)
    @ObjectTypePrefix = 'S' -- varchar(5)

GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[Get_Sites_With_Description]
(
	@ProcedureId as int
)
AS

BEGIN

	SELECT SiteId, 'Site ' + dbo.fnGetSiteTitle(SiteNo, pr.OperatingHospitalID) + ' (' + 
			CASE AntPos 
				WHEN 1 THEN 'Anterior' 
				WHEN 2 THEN 'Posterior' WHEN 3 
				THEN '' END +
			CASE 
				WHEN s.AreaNo > 0 THEN REPLACE(dbo.fnSetAreaDescriptionForGetSitesBYProcedure(@ProcedureId, s.AreaNo, 0), '<br/>', '') 
			ELSE r.Region END +
			 ')' AS SiteDescription 
	FROM ERS_Sites s 
	JOIN ERS_Regions r ON s.RegionId = r.RegionId 
	Left Join ERS_Procedures pr on s.ProcedureID = pr.ProcedureID 
	WHERE pr.ProcedureId = @ProcedureId 
	AND s.SiteNo <> 0 
	ORDER BY s.SiteNo 
END
GO
--TFS 4046 End
------------------------------------------------------------------------------------------------------------------------
-- TFS#	4047 Ended
------------------------------------------------------------------------------------------------------------------------


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Muhammad Nasim
-- TFS#	1355
-- Description of change: select multiple procedure suggest changing them to tick boxes, room drop down
-- TFS#	3842
-- Description of change: From the worklist view the Therapeutic needs to show next to the procedure type 
-- TFS#	3776
-- Description of change: remove additional fullstop in Bronch abnormalities

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ferdowsi	On 10 june 2024
-- TFS#	No TFS - Item 4123
-- Description of change
--Letters : Printing (No Row at position 0)
------------------------------------------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------

IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ERS_Users' AND COLUMN_NAME = 'CanOverrideSchedule')
BEGIN
    ALTER TABLE [dbo].[ERS_Users]
    ADD CanOverrideSchedule BIT DEFAULT 0;
END
GO
update ERS_Users set CanOverrideSchedule = 0 where CanOverrideSchedule is null
GO

EXEC dbo.DropIfExist @ObjectName = 'trg_Appointments_LetterQueue_UPDATE',      -- varchar(100)
                     @ObjectTypePrefix = 'TR' -- varchar(5)
GO

EXEC dbo.DropIfExist @ObjectName = 'insert_data_LetterQueue',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[insert_data_LetterQueue]
(
	@AppointmentId int
)
AS
BEGIN

	 declare @changedRecord int

	 	  select @changedRecord =count(1)
		  from [ERS_Appointments] appt, [ERS_LetterQueue] lq
		  where appt.AppointmentId=@appointmentid
		  and appt.AppointmentId=lq.AppointmentId
		  and lq.[Printed]=0
		  and lq.AppointmentStatusId in (15,16)
		  and DATEDIFF(SECOND,lq.whencreated,getdate())<900

		  if (@changedRecord = 0)
			begin 
					delete lq
				from [dbo].[ERS_LetterQueue] lq
				where lq.[Printed]=0 AND  lq.AppointmentId= @AppointmentId

	      INSERT INTO [dbo].[ERS_LetterQueue]
				 (AppointmentId
				, AppointmentStatusId
				,[PatientId]
				,[ProcedureId]
				,OperationalHospitalId
				,[WhenCreated] ) 
				SELECT
					appoint.AppointmentId,
				    isnull(appoint.AppointmentStatusId,1),
				    appoint.PatientId,
				     1,
				    appoint.OperationalHospitaId
				    , GETDATE()
				FROM  ERS_Appointments appoint join ERS_AppointmentStatus appts on isnull(appoint.AppointmentStatusId,1)=appts.UniqueId
				where appts.RequiredLetter=1 AND appoint.AppointmentId = @AppointmentId
			END		
				 
END
GO

-------------------------------------------------------------------------------------------------------------------------
-- END TFS#	No TFS - Item 4123
-------------------------------------------------------------------------------------------------------------------------
dbo.DropIfExist
    @ObjectName = 'add_to_worklist',      -- varchar(100)
    @ObjectTypePrefix = 'S' -- varchar(5)
GO

/****** Object:  StoredProcedure [dbo].[add_to_worklist]    Script Date: 10/03/2024 12:25:01 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE PROCEDURE [dbo].[add_to_worklist](
	@PatientId INT,
	@Endoscopist INT,
	@StartDateTime DATETIME,
	@ProcedureTypeId nvarchar(max),
	@OperatingHospitalId INT,
	@TimeOfDay VARCHAR(10),
	@LoggedInUserId INT,
	@RoomID INT
)
AS
BEGIN
BEGIN TRANSACTION
BEGIN TRY
    SELECT AppointmentId into #tblERS_Appointments FROM dbo.ERS_Appointments WHERE PatientId = @PatientId AND OperationalHospitaId = @OperatingHospitalId AND AppointmentStatusId = 1 AND BookingTypeId = 1
	delete from dbo.ERS_AppointmentProcedureTypes where AppointmentID in (SELECT AppointmentId from #tblERS_Appointments)
	delete from dbo.ERS_LetterQueue where PatientId = @PatientId and AppointmentID in (SELECT AppointmentId from #tblERS_Appointments)
	delete from ERS_Appointments  where AppointmentID in (SELECT AppointmentId from #tblERS_Appointments)
		
	DECLARE @AppointmentId INT, @ProcedurePoints DECIMAL(18,2), @ProcedureMinutes INT, @ProcedureTypeIds int
	
	DECLARE worklistCursor CURSOR
	FOR
	SELECT item FROM fnSplitString( @ProcedureTypeId, ',')
	OPEN worklistCursor
	FETCH NEXT FROM worklistCursor
	    INTO @ProcedureTypeIds
	 
	WHILE @@FETCH_STATUS = 0
	BEGIN
		SELECT @ProcedureMinutes = Minutes, @ProcedurePoints = Points FROM dbo.ERS_SCH_PointMappings WHERE ProceduretypeId = @ProcedureTypeIds AND Training=0 AND NonGI = 0 AND OperatingHospitalId = @OperatingHospitalId
		INSERT INTO ERS_Appointments
			(
				PatientId,
				EndoscopistId,
				StartDateTime,
				OperationalHospitaId,
				AppointmentStatusId,
				BookingTypeId, 
				TimeOfDay,
				WhoCreatedId,
				WhenCreated,
				RoomId
			)
			VALUES
			(
				@PatientId,
				@Endoscopist,
				@StartDateTime,
				@OperatingHospitalId,
				1, /*designated enum to specify a worklist booking*/
				1,
				@TimeOfDay,
				@LoggedInUserId,
				GETDATE(),
				@RoomID
			)
	
			IF ISNULL(@ProcedureTypeIds,0) > 0 
			BEGIN
				SELECT @AppointmentId = SCOPE_IDENTITY()
	
				INSERT INTO dbo.ERS_AppointmentProcedureTypes
				(
					AppointmentID,
					ProcedureTypeID,
					IsTherapeutic,
					Points,
					Minutes,
					WhoCreatedId,
					WhenCreated
				)
				VALUES
				(
					@AppointmentId,
					@ProcedureTypeIds,
					0,
					@ProcedurePoints,
					@ProcedureMinutes,
					@LoggedInUserId,
					GETDATE()
				)
			END
		
	    --SELECT @AppointmentId

	    FETCH NEXT FROM worklistCursor
	    INTO @ProcedureTypeIds
	END
	 
	CLOSE worklistCursor
	DEALLOCATE worklistCursor


	drop table #tblERS_Appointments

	END TRY

	BEGIN CATCH
		DECLARE @ErrorMessage NVARCHAR(4000);
		DECLARE @ErrorSeverity INT;
		DECLARE @ErrorState INT;

		SELECT @ErrorMessage = ERROR_MESSAGE(),
			   @ErrorSeverity = ERROR_SEVERITY(),
			   @ErrorState = ERROR_STATE();
    
		RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

		IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
	END CATCH


	IF @@TRANCOUNT > 0 COMMIT TRANSACTION;
END
GO
-------------------------------------------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------
dbo.DropIfExist
    @ObjectName = 'get_worklist_patient',      -- varchar(100)
    @ObjectTypePrefix = 'S' -- varchar(5)
GO
-------------------------------------------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------
/****** Object:  StoredProcedure [dbo].[get_worklist_patient]    Script Date: 10/03/2024 12:25:02 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[get_worklist_patient]
(
	@AppointmentId INT = NULL,
	@PatientId INT = NULL,
	@OperatingHospitalId INT = NULL
)
AS
SET NOCOUNT ON

BEGIN TRANSACTION

BEGIN TRY

SELECT 
	ea.AppointmentId AS UniqueId, 
	ep.Surname, 
	ep.Forename1 as Forename, 
	convert(char(10),ep.DateOfBirth,103) AS DateOfBirth, 
	isnull(ep.Title,'') as Title, 
	UPPER(SUBSTRING(dbo.fnGender(ep.GenderId),1,1)) AS Gender,
	STUFF((SELECT DISTINCT ', '+ HospitalNumber from ERS_PatientTrusts where PatientId = ep.PatientId for xml path('')), 1, 2, '') AS HospitalNumber,
	dbo.fnFullAddress(ep.Address1, ep.Address2, ep.Address3, ep.Address4, '') AS Address,
	isnull(ep.Postcode,'') as Postcode,
	ea.StartDateTime as [Date], 
	ept.ProcedureType AS ProcedureType,
	isnull(eapt.ProcedureTypeID,0) AS ProcedureTypeId,
	ep.PatientId,
	isnull(r.RoomName,rw.RoomName) as RoomName, 
	isnull(r.RoomId,rw.RoomId) as RoomId,
	ea.StartDateTime,
	ea.TimeOfDay,
	ea.EndoscopistId,
	ISNULL(eapt.Points, 1) Points,
	ISNULL(eapt.Minutes, 15) Minutes
	FROM  ERS_Appointments ea  
		LEFT JOIN dbo.ERS_Patients ep  ON ea.PatientId = ep.PatientId
		LEFT JOIN ERS_AppointmentProcedureTypes eapt ON EA.AppointmentId = eapt.AppointmentID
		LEFT JOIN dbo.ERS_ProcedureTypes ept ON eapt.ProcedureTypeID = ept.ProcedureTypeId
		LEFT JOIN dbo.ERS_Users eu ON eu.UserID = ea.EndoscopistId
		LEFT JOIN ERS_SCH_DiaryPages dp on ea.DiaryId = dp.DiaryId
		LEFT JOIN ERS_SCH_Rooms r (nolock) on dp.RoomId = r.RoomId
		LEFT JOIN ERS_SCH_Rooms rw (nolock) on ea.RoomId = rw.RoomId
	WHERE ISNULL(@AppointmentId, ea.AppointmentId) = ea.AppointmentId 
		AND ISNULL(@PatientId, ea.PatientId) = ea.PatientId
		AND ISNULL(@OperatingHospitalId, ea.OperationalHospitaId) = ISNULL(dp.OperatingHospitalId, ea.OperationalHospitaId)

END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH

IF @@TRANCOUNT > 0 COMMIT TRANSACTION;

------------------------------------------------------------------------------------------------------------------------
-- Updated by				:	Adrian Schaal 
-- Updated on				:	25th June, 2024
-- TFS#						:	4148
-- Description of change	:	Multitrust worklist view should only display one hospital
-- SP						:	get_worklist_patients
------------------------------------------------------------------------------------------------------------------------
GO
-------------------------------------------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------
GO

dbo.DropIfExist
    @ObjectName = 'get_worklist_patients',      -- varchar(100)
    @ObjectTypePrefix = 'S' -- varchar(5)

GO
-------------------------------------------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------
CREATE PROCEDURE  [dbo].[get_worklist_patients]
(
	@OperatingHospitalId INT,
	@StartDate DATETIME = NULL,
	@EndDate DATETIME = NULL,
	@EndoscopistId INT = NULL
)
AS
BEGIN
	IF @StartDate IS NULL
	BEGIN
		SET @StartDate = convert(date, convert(varchar(10), GETDATE(), 102))
	END
	IF @EndDate IS NOT NULL
	BEGIN
		SELECT @EndDate = convert(date, convert(varchar(10), DATEADD(Day, 1, @EndDate), 102))
	END

	SELECT DISTINCT
		ea.AppointmentId AS UniqueId, 
		ea.BookingTypeId AS BookingTypeId,
		ep.Surname, 
		ep.Forename1 as Forename, 
		convert(char(10),ep.DateOfBirth,103) AS DOB, 
		isnull(ep.Title,'') as Title,
		UPPER(SUBSTRING(dbo.fnGender(ep.GenderId),1,1)) AS Gender,
		STUFF((SELECT DISTINCT ', '+ HospitalNumber from ERS_PatientTrusts where PatientId = ep.PatientId for xml path('')), 1, 2, '') AS HospitalNumber,
		ep.NHSNo,
		dbo.fnFullAddress(ep.Address1, ep.Address2, ep.Address3, ep.Address4, '') AS Address,
		isnull(ep.Postcode,'') as Postcode, 
		convert(char(10),ea.StartDateTime,103) as [Date], 
		isnull(eapt.ProcedureTypeID,0) AS ProcedureTypeId,
		ept.ProcedureType,
		isnull((select stuff((SELECT DISTINCT ', ' + ett.Description AS [text()]
						FROM dbo.ERS_AppointmentTherapeutics eat
							INNER JOIN dbo.ERS_TherapeuticTypes ett ON eat.TherapeuticTypeID = ett.Id
						where AppointmentId=ea.AppointmentId and eat.AppointmentProcedureId=eapt.AppointmentProcedureTypeID
						FOR XML PATH('')),1,1,'')),'') AS [AppointmentSubject],--Description of change: From the worklist view the Therapeutic needs to show next to the procedure type 
		ep.PatientId,
		1 AS ERSPatient,
		--ISNULL(dp.OperatingHospitalId, ea.OperationalHospitaId) as HospitalId,
		@OperatingHospitalId as HospitalId,
		ea.StartDateTime,
		ea.TimeOfDay,
		CASE WHEN [as].HDCKEY IS NULL THEN 'Booked'
			 WHEN [as].HDCKEY = 'P' THEN 'Booked'
		ELSE [as].[Description]
		END as AppointmentStatus,
		[as].HDCKEY as AppointmentStatusHDCKEY,
		isnull(r.RoomName,rw.RoomName) as RoomName, 
		isnull(r.RoomId,rw.RoomId) as RoomId,--Description of change: select multiple procedure suggest changing them to tick boxes, room drop down
		ea.Notes as Alerts,
		ea.GeneralInformation as Notes,
		CASE WHEN ISNULL(ea.DiaryId, 0) = 0 THEN ea.EndoscopistId ELSE dp.UserID END EndoscopistId,
		eu.Title + ' ' + eu.Forename + ' ' + eu.Surname AS Endoscopist,
		CASE ISNULL(ea.TimeOfDay,'') WHEN '' THEN 0 WHEN 'AM' THEN 1 WHEN 'PM' THEN 2 WHEN 'Evening' THEN 3 END AS iTOD,
		CONVERT(varchar(5), ea.StartDateTime, 108) AS AppointmentTime,
		ISNULL(pip.ProcedureCompleted,0) AS ProcedureCompleted,
		CASE WHEN pj.PatientAdmissionTime IS NULL THEN 0 ELSE 1 END PatientArrived,
		CONVERT(varchar(5), pj.PatientAdmissionTime, 108) as ArrivedTime,
		CONVERT(varchar(5), pj.ProcedureStartTime, 108) as InProgressTime,
		CONVERT(varchar(5), pj.ProcedureEndTime, 108) as RecoveryTime,
		CONVERT(varchar(5), pj.PatientDischargeTime, 108) as DischargeTime,
		CONVERT(varchar(5), ea.DueArrivalTime, 108) as CallInTime,
		ss.Description AS Category
	FROM  ERS_Appointments ea  
		LEFT JOIN dbo.ERS_Patients ep (nolock) ON ea.PatientId = ep.PatientId
		LEFT JOIN ERS_AppointmentStatus [as] (nolock) ON EA.AppointmentStatusId = [as].UniqueId 
		LEFT JOIN ERS_AppointmentProcedureTypes eapt (nolock) ON EA.AppointmentId = eapt.AppointmentID
		LEFT JOIN dbo.ERS_ProcedureTypes ept (nolock) ON eapt.ProcedureTypeID = ept.ProcedureTypeId
		LEFT JOIN ERS_SCH_DiaryPages dp (nolock) on ea.DiaryId = dp.DiaryId
		LEFT JOIN dbo.ERS_Users eu (nolock) ON eu.UserID = CASE WHEN ISNULL(ea.DiaryId,0) = 0 THEN ea.EndoscopistId ELSE dp.UserId END 
		LEFT JOIN ERS_SCH_Rooms r (nolock) on dp.RoomId = r.RoomId
		LEFT JOIN ERS_SCH_Rooms rw (nolock) on ea.RoomId = rw.RoomId
		LEFT JOIN (SELECT ep.ProcedureId, ep.ProcedureType, ep.ProcedureCompleted, ep.PatientId, ep.CreatedOn
						FROM dbo.ERS_Procedures ep (nolock)
					WHERE ep.IsActive= 1 
						AND ISNULL(ep.ProcedureCompleted,0) = 0 
						AND ep.OperatingHospitalID = @OperatingHospitalId
				  ) pip ON ea.PatientId = pip.PatientId AND ISNULL(eapt.ProcedureTypeId, pip.ProcedureType) = pip.ProcedureType
		LEFT JOIN ERS_PatientJourney pj (nolock) on pj.PatientId = ep.PatientId AND pj.AppointmentId = ea.AppointmentId
		LEFT JOIN ERS_SCH_SlotStatus ss (nolock) on ss.StatusId = ea.SlotStatusID
	WHERE ea.BookingTypeId IN (1, 2) /*1 = worklist, 2 = scheduler appointment*/
		AND ea.StartDateTime >= @StartDate 
		AND (@EndDate IS NULL OR ea.StartDateTime < @EndDate)
		AND (ea.IsDeleted IS NULL OR ea.IsDeleted = 0) and ( ea.AppointmentStatusId is null or [as].Description != 'Cancelled') --TFS--3463
		AND (@EndoscopistId IS NULL OR CASE WHEN ISNULL(ea.DiaryId,0) = 0 THEN ea.EndoscopistId ELSE dp.UserId END = @EndoscopistId)
		AND ea.OperationalHospitaId = @OperatingHospitalId
	order by ea.StartDateTime  
END

GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#1355 	(multiple procedure suggest changing them to tick boxes)
-- END OF TFS#3842  (From the worklist view the Therapeutic needs to show next to the procedure type)
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ferdowsi On 6 March 2024
-- TFS#	No TFS - Item 2758  
-- Description of change
-- Alter Mucosa with Mucosa & Colitides
------------------------------------------------------------------------------------------------------------------------
GO

EXEC dbo.DropIfExist @ObjectName = 'sites_summary_update',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[sites_summary_update]
(
	@SiteId INT,
	@RefreshReport BIT = 1
)
AS
/*
-- Update History:
-- 10 Nov 2023		MH		replaced table reference ERS_ColonAbnoLesions with ERS_CommonAbnoLesions	TFS #3556
-- 15 Nov 2023		MH/Andrea		after finding the sp could updated from older version - the script has been taken from release 2_23_05_03 and then added some required refreshsummary works done by Steve, Polyp details are fixed here for Colon,Gastro etc
--							
*/
SET NOCOUNT ON

DECLARE @TrustId int
SELECT @TrustId = oh.TrustId
FROM ERS_Procedures p
JOIN ERS_Sites s ON s.ProcedureId = p.ProcedureId AND s.SiteId = @SiteId
JOIN ERS_OperatingHospitals oh ON oh.OperatingHospitalId = p.OperatingHospitalID

DECLARE @ReportSummaryRefresh int
SELECT @ReportSummaryRefresh = CAST([dbo].[fn_ShouldRefreshSummary](@TrustId) AS INT)

IF (@ReportSummaryRefresh + CAST(@RefreshReport AS INT) > 0)
BEGIN
	DECLARE @summaryAbnormalities VARCHAR(MAX)
			,@summarySpecimens VARCHAR(MAX)
			,@summaryTherapeutics VARCHAR(MAX)
			,@summaryWhole VARCHAR(MAX)
			,@summaryAbnormalitiesWithHyperLinks VARCHAR(MAX)
			,@summarySpecimensWithHyperLinks VARCHAR(MAX)
			,@summaryTherapeuticsWithHyperLinks VARCHAR(MAX)
			,@procType INT
			,@procId INT
			,@none TINYINT
			,@region VARCHAR(500)
			,@htmlAnchorCode VARCHAR(500)
			,@siteIdStr VARCHAR(15)
			,@indent VARCHAR(15) 
			,@br VARCHAR(10)
			,@opDiv VARCHAR(150)
			,@clDiv VARCHAR(50)
			,@opBold VARCHAR(5)
			,@clBold VARCHAR(5)
			,@fullStop VARCHAR(1)
			,@colon VARCHAR(2)
			,@fldNone VARCHAR(20)
			,@emptyStr VARCHAR(1)
			,@abnoTheraPresent BIT = 0
			,@tmpSummaryAbno VARCHAR(MAX)
			,@tmpSummaryAbnoLinks VARCHAR(MAX)
			,@SiteNo INT
			,@regionID INT
			,@AreaNo INT
			,@AbnormalProcedure BIT = 0


	BEGIN TRANSACTION

	BEGIN TRY

		SET	@summaryAbnormalities = ''
		SET	@summarySpecimens = ''
		SET	@summaryTherapeutics = ''
		SET	@summaryAbnormalitiesWithHyperLinks = ''
		SET	@summarySpecimensWithHyperLinks = ''
		SET	@summaryTherapeuticsWithHyperLinks = ''
		SET @siteIdStr = CONVERT(VARCHAR(10),@SiteId)
		SET @AbnormalProcedure = 0

		DECLARE @IsLymphNode VARCHAR(10) = 'False'

		SELECT @procId = p.ProcedureId,@procType = p.ProcedureType, @regionID = s.RegionId, @SiteNo = s.SiteNo, @AreaNo = ISNULL(AreaNo,0),
				@region = CASE WHEN s.SiteNo = -77 THEN						--SiteNo is set to -77 for sites By Distance (Col & Sig only)
							CONVERT(VARCHAR,XCoordinate) +  
								CASE WHEN YCoordinate IS NULL OR YCoordinate=0 THEN ' cm' 
								ELSE (' to ' + CONVERT(VARCHAR,YCoordinate) + ' cm' ) 
								END
						ELSE (SELECT r.Region FROM ERS_Regions r WHERE r.RegionId = s.RegionId)
						END
				,@IsLymphNode = CASE WHEN s.IsLymphNode = 1 THEN 'True' ELSE 'False' END
		FROM ERS_Sites s
		JOIN ERS_Procedures p ON s.ProcedureId = p.ProcedureId
		--JOIN ERS_Regions r ON s.RegionId = r.RegionId
		WHERE SiteId = @SiteId
		--SELECT @region = Region FROM ERS_Regions WHERE RegionId = @regionID

		SET @htmlAnchorCode = '<a href="#" class="sitesummary" onclick="OpenSiteDetails(''''' + @region + ''''',' + @siteIdStr + ',''''{0}'''',''''' + CONVERT(VARCHAR,@AreaNo) + ''''');">{1}</a>'
		--{0} is the name of the menu and {1} is the summary text

	
		DECLARE @SQLString NVARCHAR(MAX), @QryString NVARCHAR(MAX), @AbnoCheck BIT
		DECLARE @ProcedureType INT, @TableName VARCHAR(50), @AbnoNodeName VARCHAR(50), @Identifier VARCHAR(50)

		CREATE TABLE #QueryDetails (ProcType INT, TableName VARCHAR(50), AbnoNodeName VARCHAR(50), Identifier VARCHAR(50));

		--Notes to appear on the report just after the Site X heading, before the abnormalities.
		INSERT INTO #QueryDetails SELECT @procType,	'ERS_Sites',		'',		'Additional notes'
		IF @procType IN (1,6) --Gastroscopy / EUS(OGD)
		BEGIN
			INSERT INTO #QueryDetails VALUES 
			(@procType,	'ERS_CommonAbnoAtrophic',			'Atrophic duodenum','Atrophic Duodenum')
			,(@procType,	'ERS_UpperGIAbnoAchalasia',		'Achalasia',		'Achalasia')
			,(@procType,	'ERS_UpperGIAbnoBarrett',		'',					'Barretts Epithelium')
			,(@procType,	'ERS_UpperGIAbnoDeformity',		'Deformity',		'Deformity')
			,(@procType,	'ERS_CommonAbnoDiverticulum',	'Diverticulum',		'Diverticulum/Other')
			,(@procType,	'ERS_CommonAbnoDuodenalUlcer',	'',					CASE WHEN @region = 'Jejunum' THEN 'Jejunal Ulcer' WHEN @region = 'Ileum' THEN 'Ileal Ulcer' ELSE 'Duodenal Ulcer' END)
			,(@procType,	'ERS_CommonAbnoDuodenitis',		'',					CASE WHEN @region = 'Jejunum' THEN 'Jejunitis' WHEN @region = 'Ileum' THEN 'Ileitis' ELSE 'Duodenitis' END)
			,(@procType,	'ERS_UpperGIAbnoGastricUlcer',	'Gastric ulcer',	'Gastric Ulcer')
			,(@procType,	'ERS_UpperGIAbnoGastritis',		'Gastritis',		'Gastritis')
			,(@procType,	'ERS_UpperGIAbnoHiatusHernia',	'Hiatus hernia',	'Hiatus Hernia')
			,(@procType,	'ERS_UpperGIAbnoLumen',			'Lumen',			'Lumen')
			,(@procType,	'ERS_UpperGIAbnoMalignancy',	'Malignancy',		'Malignancy')
			,(@procType,	'ERS_UpperGIAbnoMiscellaneous',	'',					'Miscellaneous')
			,(@procType,	'ERS_UpperGIAbnoOesophagitis',	'Oesophagitis',		'Oesophagitis')
			,(@procType,	'ERS_CommonAbnoLesions',		'Lesions',			'Lesions')
			,(@procType,	'ERS_UpperGIAbnoPostSurgery',	'Post surgery',		'Post Surgery')
			,(@procType,	'ERS_CommonAbnoScaring',		'',					'Scarring/Stenosis')
			,(@procType,	'ERS_CommonAbnoTumour',			'',					'Tumour')
			,(@procType,	'ERS_UpperGIAbnoVarices',		CASE WHEN (Select isnull(Quantity, 0) from ERS_UpperGIAbnoVarices where SiteId = @SiteId) = 1 then 'Varix' ELSE 'Varices' END ,			'Varices')
			,(@procType,	'ERS_CommonAbnoVascularLesions','Vascular lesions',	'Vascular Lesions')
			,(@procType,	'ERS_EUSAbnoMediastinal',		'Mediastinal',		'Mediastinal')
			,(@procType,	'ERS_UpperGITherapeutics',		'Therapeutic procedure(s)',	'Therapeutic Procedures')
			,(@procType,	'ERS_UpperGISpecimens',			'Specimens taken',	'Specimens Taken')
		END
		ELSE IF @procType IN (2,7) --ERCP / / EUS(HPB)
		BEGIN
			INSERT INTO #QueryDetails VALUES 
			(@procType,		'ERS_ERCPAbnoAppearance',		'Appearance',		'Appearance')
			,(@procType,	'ERS_CommonAbnoAtrophic',		'Atrophic duodenum','Atrophic Duodenum')
			,(@procType,	'ERS_CommonAbnoDiverticulum',	'Diverticulum',		'Diverticulum/Other')
			,(@procType,	'ERS_ERCPAbnoDiverticulum',		'Diverticulum',		CASE WHEN @region IN ('Major Papilla', 'Minor Papilla') THEN 'Diverticulum' ELSE 'Diverticulum/Other' END)
			,(@procType,	'ERS_ERCPAbnoDuct',				'Duct',				CASE WHEN @region = 'Gall Bladder' THEN 'Gall Bladder' ELSE 'Duct' END)
			,(@procType,	'ERS_CommonAbnoDuodenalUlcer',	'',					CASE WHEN @region = 'Jejunum' THEN 'Jejunal Ulcer' WHEN @region = 'Ileum' THEN 'Ileal Ulcer' ELSE 'Duodenal Ulcer' END)
			,(@procType,	'ERS_CommonAbnoDuodenitis',		'',					CASE WHEN @region = 'Jejunum' THEN 'Jejunitis' WHEN @region = 'Ileum' THEN 'Ileitis' ELSE 'Duodenitis' END)
			,(@procType,	'ERS_ERCPAbnoParenchyma',		'Parenchyma',		'Parenchyma')
			,(@procType,	'ERS_CommonAbnoScaring',		'',					'Scarring/Stenosis')
			,(@procType,	'ERS_UpperGIAbnoMiscellaneous',	'',					'Miscellaneous')
			,(@procType,	'ERS_CommonAbnoTumour',			'',					'Tumour')
			,(@procType,	'ERS_ERCPAbnoTumour',			'Tumour',			'Tumour')
			,(@procType,	'ERS_ERCPAbnoIntrahepatic',		'Intrahepatic',		'Intrahepatic')
			,(@procType,	'ERS_CommonAbnoVascularLesions','Vascular lesions',	'Vascular Lesions')
			,(@procType,	'ERS_EUSAbnoMediastinal',		'Mediastinal',		'Mediastinal')
			,(@procType,	'ERS_CommonAbnoLesions',		'Lesions',			'Lesions')
			,(@procType,	'ERS_UpperGIAbnoVarices',		CASE WHEN (Select isnull(Quantity, 0) from ERS_UpperGIAbnoVarices where SiteId = @SiteId) = 1 then 'Varix' ELSE 'Varices' END ,			'Varices')
			,(@procType,	'ERS_ERCPTherapeutics',			'Therapeutic procedure(s)',	'Therapeutic Procedures')
			,(@procType,	'ERS_UpperGISpecimens',			'Specimens taken',	'Specimens Taken')
		END
		ELSE IF @procType IN (3,4,5) --Colon/Sigmo/Procto
		BEGIN
			INSERT INTO #QueryDetails VALUES
			(@procType,		'ERS_ColonAbnoCalibre',			'Calibre',			'Calibre')
			,(@procType,	'ERS_ColonAbnoDiverticulum',	'Diverticulum',		'Diverticulum')
			,(@procType,	'ERS_ColonAbnoHaemorrhage',		'Haemorrhage',		'Haemorrhage')
			,(@procType,	'ERS_CommonAbnoLesions',			'Lesions',			'Lesions')
			,(@procType,	'ERS_ColonAbnoTumour',			'Tumour',			'Tumour')
			,(@procType,	'ERS_ColonAbnoMiscellaneous',	'',					'Miscellaneous')
			,(@procType,	'ERS_ColonAbnoMucosa',			'Mucosa & Colitides',			'Mucosa')
			,(@procType,	'ERS_ColonAbnoperianallesions',	'Perianal lesions',	'Perianal Lesions')
			,(@procType,	'ERS_ColonAbnoVascularity',		'Vascularity',		'Vascularity')
			,(@procType,	'ERS_UpperGIAbnoVarices',		CASE WHEN (Select isnull(Quantity, 0) from ERS_UpperGIAbnoVarices where SiteId = @SiteId) = 1 then 'Varix' ELSE 'Varices' END ,			'Varices')
			,(@procType,	'ERS_UpperGITherapeutics',		'Therapeutic procedure(s)',	'Therapeutic Procedures')
			,(@procType,	'ERS_UpperGISpecimens',			'Specimens taken',	'Specimens Taken')
		END
		ELSE IF @procType IN (8) --Antegrade
		BEGIN
			INSERT INTO #QueryDetails VALUES 
			(@procType,		'ERS_UpperGIAbnoAchalasia',		'Achalasia',		'Achalasia')
			,(@procType,	'ERS_UpperGIAbnoBarrett',		'',					'Barretts Epithelium')
			,(@procType,	'ERS_UpperGIAbnoDeformity',		'Deformity',		'Deformity')
			,(@procType,	'ERS_CommonAbnoAtrophic',		'Atrophic duodenum','Atrophic Duodenum')
			,(@procType,	'ERS_CommonAbnoDiverticulum',	'Diverticulum',		'Diverticulum/Other')
			,(@procType,	'ERS_ColonAbnoDiverticulum',	'Diverticulum',		'Diverticulum')
			,(@procType,	'ERS_CommonAbnoDuodenalUlcer',	'',					CASE WHEN @region = 'Jejunum' THEN 'Jejunal Ulcer' WHEN @region = 'Ileum' THEN 'Ileal Ulcer' ELSE 'Duodenal Ulcer' END)
			,(@procType,	'ERS_CommonAbnoDuodenitis',		'',					CASE WHEN @region = 'Jejunum' THEN 'Jejunitis' WHEN @region = 'Ileum' THEN 'Ileitis' ELSE 'Duodenitis' END)
			,(@procType,	'ERS_ColonAbnoLesions',			'Lesions',			'Lesions')
			,(@procType,	'ERS_CommonAbnoScaring',		'',					'Scarring/Stenosis')
			,(@procType,	'ERS_CommonAbnoTumour',			'',					'Tumour')
			,(@procType,	'ERS_CommonAbnoVascularLesions','Vascular lesions',	'Vascular Lesions')
			,(@procType,	'ERS_UpperGIAbnoGastricUlcer',	'Gastric ulcer',	'Gastric Ulcer')
			,(@procType,	'ERS_UpperGIAbnoGastritis',		'Gastritis',		'Gastritis')
			,(@procType,	'ERS_UpperGIAbnoHiatusHernia',	'Hiatus hernia',	'Hiatus Hernia')
			,(@procType,	'ERS_UpperGIAbnoLumen',			'Lumen',			'Lumen')
			,(@procType,	'ERS_UpperGIAbnoMalignancy',	'Malignancy',		'Malignancy')
			,(@procType,	'ERS_UpperGIAbnoMiscellaneous',	'',					'Miscellaneous')
			,(@procType,	'ERS_UpperGIAbnoOesophagitis',	'Oesophagitis',		'Oesophagitis')
			,(@procType,	'ERS_UpperGIAbnoPostSurgery',	'Post surgery',		'Post Surgery')
			,(@procType,	'ERS_CommonAbnoLesions',		'Lesions',			'Lesions')
			,(@procType,	'ERS_UpperGIAbnoVarices',		CASE WHEN (Select isnull(Quantity, 0) from ERS_UpperGIAbnoVarices where SiteId = @SiteId) = 1 then 'Varix' ELSE 'Varices' END ,			'Varices')
			,(@procType,	'ERS_UpperGITherapeutics',		'Therapeutic procedure(s)',	'Therapeutic Procedures')
			,(@procType,	'ERS_UpperGISpecimens',			'Specimens taken',	'Specimens Taken')
		END
		ELSE IF @procType IN (9) --Retrograde
		BEGIN
			INSERT INTO #QueryDetails VALUES
			(@procType,		'ERS_ColonAbnoCalibre',			'Calibre',			'Calibre')
			,(@procType,	'ERS_ColonAbnoDiverticulum',	'Diverticulum',		'Diverticulum')
			,(@procType,	'ERS_ColonAbnoHaemorrhage',		'Haemorrhage',		'Haemorrhage')
			,(@procType,	'ERS_CommonAbnoLesions',			'Lesions',			'Lesions')
			,(@procType,	'ERS_ColonAbnoTumour',			'Tumour',			'Tumour')
			,(@procType,	'ERS_ColonAbnoMiscellaneous',	'',					'Miscellaneous')
			,(@procType,	'ERS_ColonAbnoMucosa',			'Mucosa & Colitides',			'Mucosa')
			,(@procType,	'ERS_ColonAbnoperianallesions',	'Perianal lesions',	'Perianal Lesions')
			,(@procType,	'ERS_ColonAbnoVascularity',		'Vascularity',		'Vascularity')
			,(@procType,	'ERS_CommonAbnoDuodenalUlcer',	'',					CASE WHEN @region = 'Jejunum' THEN 'Jejunal Ulcer' WHEN @region = 'Ileum' THEN 'Ileal Ulcer' ELSE 'Duodenal Ulcer' END)
			,(@procType,	'ERS_CommonAbnoDuodenitis',		'',					CASE WHEN @region = 'Jejunum' THEN 'Jejunitis' WHEN @region = 'Ileum' THEN 'Ileitis' ELSE 'Duodenitis' END)
			,(@procType,	'ERS_CommonAbnoScaring',		'',					'Scarring/Stenosis')
			,(@procType,	'ERS_UpperGIAbnoVarices',		CASE WHEN (Select isnull(Quantity, 0) from ERS_UpperGIAbnoVarices where SiteId = @SiteId) = 1 then 'Varix' ELSE 'Varices' END ,			'Varices')
			,(@procType,	'ERS_UpperGITherapeutics',			'Therapeutic procedure(s)',	'Therapeutic Procedures')
			,(@procType,	'ERS_UpperGISpecimens',			'Specimens taken',	'Specimens Taken')
		END
		ELSE IF @procType IN (13) --Cystoscopy
		BEGIN
			INSERT INTO #QueryDetails VALUES
			(@procType,		'ERS_CystoscopyAbnoBladder',	'Bladder',			'Bladder')
			,(@procType,	'ERS_CystoscopyAbnoProstate',	'Prostate',		    'Prostate')
			,(@procType,	'ERS_CystoscopyAbnoUrethra',	'Urethra',		    'Urethra')
			,(@procType,	'ERS_CystoscopyTherapeutics',	'Therapeutic procedure(s)',	'Therapeutic Procedures')
			,(@procType,	'ERS_CystoscopySpecimens',		'Specimens taken',	'Specimens Taken')
		END
		ELSE IF @procType IN (10,12) --Bronchoscopy, Thoracoscopy
		BEGIN
			INSERT INTO #QueryDetails
			VALUES (
				@procType
				,'ERS_BRTSpecimens'
				,'Specimens taken'
				,'Specimens Taken'
				),
				(
				@procType
				,'ERS_UpperGITherapeutics'
				,'Therapeutic procedure(s)'
				,'Therapeutic Procedures'
				),
				(
				@procType
				,'ERS_BRTAbnoDescriptions'
				,'<strong>Abnormalities</strong>'			
				,''
				)

		END	
		ELSE IF @procType IN (
				11
				) --EBUS			
				BEGIN
					INSERT INTO #QueryDetails
					VALUES (
						@procType
						,'ERS_BRTSpecimens'
						,'Specimens taken'
						,'Specimens Taken'
						),
						(
						@procType
						,'ERS_UpperGITherapeutics'
						,'Therapeutic procedure(s)'
						,'Therapeutic Procedures'
						)
			
					IF @IsLymphNode = 'True'
					BEGIN
						INSERT INTO #QueryDetails
						VALUES 
							(
							@procType
							,'ERS_EBUSAbnoDescriptions'
							,'<strong>Abnormalities</strong>'
							,'EBUS Abnormality Descriptions'
							)
					END
					ELSE
					BEGIN
						INSERT INTO #QueryDetails
						VALUES 
							(
							@procType
							,'ERS_BRTAbnoDescriptions'
							,'<strong>Abnormalities</strong>'
							,''
							)
					END
				END


		DECLARE qry_cursor CURSOR FOR 
		SELECT ProcType, TableName, AbnoNodeName, Identifier FROM #QueryDetails

		OPEN qry_cursor 
		FETCH NEXT FROM qry_cursor INTO @ProcType, @TableName, @AbnoNodeName, @Identifier

		WHILE @@FETCH_STATUS = 0
		BEGIN
			SET @summaryWhole = ''
			SET @none = NULL
			SET @opDiv = '''<table><tr><td style="padding-left:25px;padding-right:50px; font-size:12px;"><span>'' + ' 
			SET @clDiv = ' + ''</span></td></tr></table>'''
			SET @indent = '  - ';		SET @br = '<br />'
			SET @opBold = '<b>';			SET @clBold = '</b>'
			SET @fullStop = '.';			SET @colon = ': '
			SET @fldNone = 'None';			SET @emptyStr = ''
		
			IF @TableName = 'ERS_UpperGIAbnoLumen' SET @fldNone = 'NoBlood'
			ELSE IF @TableName = 'ERS_ERCPAbnoIntrahepatic' SET @fldNone = 'NormalIntraheptic'
			ELSE IF @TableName IN ('ERS_ERCPAbnoDuct', 'ERS_ERCPAbnoParenchyma', 'ERS_ERCPAbnoAppearance', 'ERS_ERCPAbnoDiverticulum','ERS_CystoscopyAbnoBladder','ERS_CystoscopyAbnoProstate','ERS_CystoscopyAbnoUrethra','ERS_EBUSAbnoDescriptions') SET @fldNone = 'Normal'
			ELSE SET @fldNone = 'None'
			--Get Summary from respective table
			IF @TableName = 'ERS_Sites'
				BEGIN
					SET @SQLString = 'SELECT @summaryWhole = AdditionalNotes FROM ' + @TableName + '  
								WHERE SiteId =  ' + CONVERT(VARCHAR,@SiteId) + ' AND ISNULL(AdditionalNotes,'''') <> '''' '
					SET @fullStop = @emptyStr
				END
			ELSE
				BEGIN
					SET @SQLString = 'SELECT @summaryWhole = Summary, @none = [' + @fldNone + '] FROM ' + @TableName + '  
								WHERE SiteId =  ' + CONVERT(VARCHAR,@SiteId) + ' AND ISNULL(Summary,'''') <> '''' '
				END
			EXECUTE sp_executesql @SQLString, N'@summaryWhole VARCHAR(MAX) OUTPUT, @none TINYINT OUTPUT', @summaryWhole OUTPUT, @none OUTPUT

			IF @Identifier = 'Therapeutic Procedures' 
			BEGIN
				IF ISNULL(@none,0) = 0 AND LEN(@summaryWhole) > 0
				BEGIN
					SET @fullStop = @emptyStr
					SET @abnoTheraPresent = 1
			END
			ELSE 
			BEGIN
					SET @opDiv = @emptyStr;		SET @clDiv = @emptyStr
					SET @opBold = @emptyStr;	SET @clBold = @emptyStr
			END
			END
			ELSE 
			BEGIN
				IF @Identifier = 'Specimens Taken' 
				BEGIN
					--IF therapeutics present, remove line before specimens
					IF @abnoTheraPresent = 1 SET @br = @emptyStr
				END
				ELSE 
				BEGIN
					SET @opBold = @emptyStr;	SET @clBold = @emptyStr
				END
				SET @opDiv = @emptyStr ;		SET @clDiv = @emptyStr
			END

			IF ISNULL(@summaryWhole,'') <> ''
			BEGIN
				SET @summaryWhole = REPLACE(@summaryWhole,'''','''''')

				--If None is clicked, prefix not required (e.g "Oesophagitis : No Oesophagitis." should be "No Oesophagitis.")
				--Prefix (@AbnoNodeName) is required for Lumen even if None (Blood free) is selected
				IF (ISNULL(@none,0) = 1 OR @AbnoNodeName = '') AND @TableName <> 'ERS_UpperGIAbnoLumen'
				BEGIN	
					SET @AbnoNodeName = '';		SET @colon = ''
				END
				ELSE
				BEGIN
					SET @colon = ': '
				END
		
				SET @tmpSummaryAbno = ' CASE WHEN ''' + @summaryWhole + ''' IN ('''', ''' + @AbnoNodeName + ''') THEN ''' +  @indent + @AbnoNodeName + '' + @fullStop + '''' +
										' ELSE  ''' + @indent + @opBold + @AbnoNodeName + @clBold + @colon + ''' + ' + @opDiv + '''' + @summaryWhole + @fullStop + '''' + @clDiv +
									' END'

				--TFS#	3776
				SET @tmpSummaryAbnoLinks = 'CASE WHEN ''' + @summaryWhole + ''' IN ('''', ''' + @AbnoNodeName + ''') THEN ''' +  @indent + @AbnoNodeName + ''' + REPLACE(REPLACE(''' + @htmlAnchorCode + ''',''{0}'',''' + @Identifier + '''),''{1}'',''' + @AbnoNodeName + ''') + ''' + @fullStop + '''' +
											' ELSE  ''' +  @indent + @opBold + @AbnoNodeName + @clBold + @colon + ''' + REPLACE(REPLACE(''' + @htmlAnchorCode + ''',''{0}'',''' + @Identifier + '''),''{1}'',' +  @opDiv + '''' + @summaryWhole  + '''' +	 @clDiv +')  ' +
										' END'
				--TFS#	3776

			SET @SQLString = 'SELECT ' +
								CASE WHEN @Identifier = 'Specimens Taken'			THEN '@summarySpecimens = @summarySpecimens '
									 WHEN @Identifier = 'Therapeutic Procedures'	THEN '@summaryTherapeutics = @summaryTherapeutics '
									 ELSE '@summaryAbnormalities = @summaryAbnormalities ' END +
											' + ''' + @br  + ''' + '  + @tmpSummaryAbno + ', ' +

								CASE WHEN @Identifier = 'Specimens Taken'			THEN '@summarySpecimensWithHyperLinks = @summarySpecimensWithHyperLinks '
									 WHEN @Identifier = 'Therapeutic Procedures'	THEN '@summaryTherapeuticsWithHyperLinks = @summaryTherapeuticsWithHyperLinks '
									 ELSE '@summaryAbnormalitiesWithHyperLinks = @summaryAbnormalitiesWithHyperLinks ' END +
												' + ''' + @br  + ''' + '  + @tmpSummaryAbnoLinks 						
			--Perform abno check to determine normal procedure
			IF @none = 0  and @TableName <> 'ERS_UpperGISpecimens' AND @AbnormalProcedure <> 1  SET @AbnormalProcedure = 1

			IF @Identifier = 'Specimens Taken'
				EXECUTE sp_executesql @SQLString, N'@summarySpecimens VARCHAR(MAX) OUTPUT,@summarySpecimensWithHyperLinks VARCHAR(MAX) OUTPUT', 
							@summarySpecimens = @summarySpecimens OUTPUT, @summarySpecimensWithHyperLinks=@summarySpecimensWithHyperLinks OUTPUT
			ELSE IF @Identifier = 'Therapeutic Procedures'
				EXECUTE sp_executesql @SQLString, N'@summaryTherapeutics VARCHAR(MAX) OUTPUT,@summaryTherapeuticsWithHyperLinks VARCHAR(MAX) OUTPUT', 
							@summaryTherapeutics = @summaryTherapeutics OUTPUT, @summaryTherapeuticsWithHyperLinks=@summaryTherapeuticsWithHyperLinks OUTPUT
			ELSE
				EXECUTE sp_executesql @SQLString, N'@summaryAbnormalities VARCHAR(MAX) OUTPUT,@summaryAbnormalitiesWithHyperLinks VARCHAR(MAX) OUTPUT', 
							@summaryAbnormalities = @summaryAbnormalities OUTPUT, @summaryAbnormalitiesWithHyperLinks=@summaryAbnormalitiesWithHyperLinks OUTPUT
			END

			FETCH NEXT FROM qry_cursor INTO @ProcType, @TableName, @AbnoNodeName, @Identifier
		END

		CLOSE qry_cursor
		DEALLOCATE qry_cursor

		DROP TABLE #QueryDetails

		if exists(select 1 from ERS_CommonAbnoOther where SiteId = @SiteId)
		BEGIN
			SELECT @summaryAbnormalities = isnull(@summaryAbnormalities, '') + (SELECT STUFF((
																					SELECT ', ' + OA.Summary 
																					FROM ERS_OtherAbnormalities OA
																					JOIN ERS_CommonAbnoOther CAO ON OA.OtherId = CAO.OtherId
																					WHERE CAO.SiteId = @SiteId
																					FOR XML PATH('')), 1, 1, '') Code ),
				 @summaryAbnormalitiesWithHyperLinks = isnull(@summaryAbnormalitiesWithHyperLinks, '') + '<table><tr><td style="padding-right:50px;">- Other:' +
				 REPLACE(REPLACE(REPLACE(@htmlAnchorCode,'''{0}''','Other'),'{1}',
																					(SELECT STUFF((
																					SELECT ', ' + OA.Summary 
																					FROM ERS_OtherAbnormalities OA
																					JOIN ERS_CommonAbnoOther CAO ON OA.OtherId = CAO.OtherId
																					WHERE CAO.SiteId = @SiteId
																					FOR XML PATH('')), 1, 1, '') Code )), '''''', '''')
														+ '</td></tr></table>'
		END
		-- Update the current site's summary
		UPDATE ERS_Sites 
		SET	
			SiteSummary = @summaryAbnormalities,
			SiteSummarySpecimens = @summarySpecimens,
			SiteSummaryTherapeutics = @summaryTherapeutics,
			SiteSummaryWithLinks = @summaryAbnormalitiesWithHyperLinks,
			SiteSummarySpecimensWithLinks = @summarySpecimensWithHyperLinks,
			SiteSummaryTherapeuticsWithLinks = @summaryTherapeuticsWithHyperLinks,
			HasAbnormalities = @AbnormalProcedure
		WHERE 
			SiteId = @siteId

		-- Update the summary of the procedure (all the sites)
		EXEC procedure_summary_update @procId

	END TRY

	BEGIN CATCH
		DECLARE @ErrorMessage NVARCHAR(4000);
		DECLARE @ErrorSeverity INT;
		DECLARE @ErrorState INT;

		SELECT @ErrorMessage = ERROR_MESSAGE(),
			   @ErrorSeverity = ERROR_SEVERITY(),
			   @ErrorState = ERROR_STATE();
    
		RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

		IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
	END CATCH


	IF @@TRANCOUNT > 0 COMMIT TRANSACTION;
END
Go
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	No TFS - Item 2758 by Ferdowsi
------------------------------------------------------------------------------------------------------------------------


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ferdowsi	On 6 March 2024
-- TFS#	No TFS - Item 1590  
-- Description of change
-- Set Default value 2 as DefaultPhotoSize

-- TFS#	No TFS - Item 2420 
-- Description of change
-- For New Operating Hospital, set up a Scheduler tables
------------------------------------------------------------------------------------------------------------------------

GO
EXEC dbo.DropIfExist @ObjectName = 'add_new_operating_hospital',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[add_new_operating_hospital]
(
    @ExistingHospitalID int,
	@InternalHospitalID VARCHAR(150), 
	@NHSHospitalID VARCHAR(150), 
	@TrustId int,
	@HospitalName VARCHAR(150), 
	@ContactNumber VARCHAR(150), 
	@ReportExportPath VARCHAR(500),
	@ReportHeading VARCHAR(200), 
    @ReportTrustType VARCHAR(200),
    @ReportSubHeading VARCHAR(200),
	@ReportFooter VARCHAR(500),
    @DepartmentName VARCHAR(200),
	@NEDExportPath VARCHAR(200),
	@NEDODSCode VARCHAR(50),
	@LoggedInUserId INT,
	@CopyPrintSettings BIT,
	@CopyPhraseLibrary BIT,
	@ImportPatientByWebservice int,
	@AddExportFileForMirth bit,
	@ExportDocumentFilePrefix varchar(30),
	@SuppressMainReportPDF bit = 0,
	@TrustName varchar(200) = NULL
	
)
AS

/**************************************************************************
 Author:		?
 Create date:	?
 Description:	Create a new operating hospital. Inserts into 
				OperatingHospital, System_Config and the print settings
*****************************************************************************************
*****                        Change History											*****
*****************************************************************************************
** Rev	Date			Author		Description 
** --	-----------		---------	-------------------------------------------------------------------
** 1	25 Jul 2019		Duncan		Added report footer to System Config
** 
** 2    21 Jan 2021     Duncan      Added TrustId
**
** 3	08 Mar 2021		Mahfuz		Added ImportPatientByWebservice
** 4	19 Mar 2021		Mahfuz		updated ImportPatientByWebservice column as Int
** 5	25 May 2021		Andrea		Added new trust entry option and General room and Image port now added when creating a new OH
** 6	06 Aug 2021		Adrian		Fixed bug that when the print settings are duplicated, they miss out the defaultphotosize
** 7	05 Oct 2021		Duncan		Fixed DefaultPhotoSize in print settings so that Null is not inserted (defaults to 2)
** 8	17 Nov 2021		Mahfuz		added new parameter AddExportFileForMirth, TFS #1779
** 9	05 Jan 2022		Mahfuz		added new parameter ExportDocumentFilePrefix TFS # 1832
** 10	29 Mar 2022		Mahfuz		added new parameter SuppressMainReportPDF TFS # 1985 - Suppress PDF (Main report) from the Exported document if no required
*******************************************************************************************************/
SET NOCOUNT ON

BEGIN TRANSACTION
	BEGIN TRY
		DECLARE @NewOHID INT, @OperatingHospitalId INT, @NewRoomId INT
		--IF @TrustName IS NOT NULL
		--BEGIN
		--	INSERT INTO ERS_Trusts (TrustName) VALUES (@TrustName)

		--	SET @TrustId = SCOPE_IDENTITY()
		--END

		SELECT TOP 1 @OperatingHospitalId = OperatingHospitalId FROM ERS_OperatingHospitals ORDER BY OperatingHospitalId

		INSERT INTO ERS_OperatingHospitals (InternalHospitalID, NHSHospitalID, HospitalName, ContactNumber, ReportExportPath, TrustId,ImportPatientByWebservice,AddExportFileForMirth,SuppressMainReportPDF,ExportDocumentFilePrefix)
	    VALUES (@InternalHospitalID, @NHSHospitalID, @HospitalName, @ContactNumber, @ReportExportPath, @TrustId, @ImportPatientByWebservice,@AddExportFileForMirth,@SuppressMainReportPDF,@ExportDocumentFilePrefix); 
		 SET @NewOHID = SCOPE_IDENTITY()
		--Assign Admin and logged in user (if not admin) to new hospital
		DECLARE @AdminUserId int = (SELECT UserId FROM ERS_Users WHERE UserName = 'Admin')
		INSERT INTO ERS_UserOperatingHospitals (UserId, OperatingHospitalId) VALUES (@AdminUserId, @NewOHID)
		
		IF @AdminUserId <> @LoggedInUserId
		BEGIN
			INSERT INTO ERS_UserOperatingHospitals (UserId, OperatingHospitalId) VALUES (@LoggedInUserID, @NewOHID)
		END

		--New (general) room entry
		INSERT INTO ERS_SCH_Rooms (RoomName, AllProcedureTypes, HospitalId, OtherInvestigations, Suppressed, WhoCreatedId, WhenCreated)
		VALUES ('General', 1, @NewOHID, 0, 0, @LoggedInUserId, getdate())

		SET @NewRoomId = SCOPE_IDENTITY()

		--New (none) image port entry
		INSERT INTO ERS_ImagePort (OperatingHospitalId, PortName, MacAddress, [Static], PCName, IsActive, WhoCreatedId, WhenCreated, RoomId, FriendlyName, [Default])
		VALUES (@NewOHID, 'None', NULL, 1, '', 1, @LoggedInUserId, getdate(), @NewRoomId, 'None',1)
		
	   -- Added a default CAll in times by Ferdowsi
	   INSERT INTO  ERS_SCH_ProcedureCallInTimes
           ([ProcedureTypeId]
           ,[CallInMinutes]
           ,[OperatingHospitalId]
           ,[WhoCreatedId]
           ,[WhenCreated])    
       SELECT DISTINCT 
            [ProcedureTypeId]
           ,[CallInMinutes]
           ,@NewOHID
           ,@LoggedInUserId
           ,GETDATE() 
       FROM ERS_SCH_ProcedureCallInTimes
       WHERE [OperatingHospitalId] = @ExistingHospitalID;
	   -- End
	   -- Added a default points by Ferdowsi
       INSERT INTO ERS_SCH_PointMappings (Minutes,OperatingHospitalId,ProceduretypeId,Points,WhoUpdatedId,WhoCreatedId,
       WhenCreated,WhenUpdated,Training,NonGI,TherapeuticMinutes,TherapeuticPoints) 
       SELECT Minutes,@NewOHID,ProceduretypeId,Points,NULL,@LoggedInUserId,GETDATE(),NULL,
       Training,NonGI,TherapeuticMinutes,TherapeuticPoints  from ERS_SCH_PointMappings where OperatingHospitalId = @ExistingHospitalID;
	   --END

		INSERT INTO dbo.ERS_SystemConfig
		(
			HospitalID,
			OperatingHospitalID,
			ApplicationTimeOut,
			SystemDisabled,
			ScheduledShutdown,
			PwdRuleMinLength,
			PwdRuleNoOfSpecialChars,
			PwdRuleNoSpaces,
			PwdRuleCantBeUserId,
			PwdRuleDaysToExpiration,
			PwdRuleNoOfPastPwdsToAvoid,
			SiteIdentification,
			SiteRadius,
			OGDDiagnosis,
			UreaseTestsIncludeTickBoxes,
			OesophagitisClassification,
			BostonBowelPrepScale,
			ReportHeading,
			ReportTrustType,
			ReportSubHeading,
			DepartmentName,
			PatientConsent,
			SortReferringConsultantBy,
			CompleteWHOSurgicalSafetyCheckList,
			ReportLocking,
			LockingTime,
			LockingDays,
			CountryLabel,
			NED_HospitalSiteCode,
			NED_OrganisationCode,
			NED_APIKey,
			NED_BatchId,
			NED_ExportPath,
			NEDEnabled,
			AuditLogEnabled,
			ErrorLogEnabled,
			ImGrabEnabled,
			IncludeUGI,
			DefaultPatientStatus,
			DefaultPatientType,
			DefaultWard,
			BRTPulmonaryPhysiology,
			PhotosURL,
			PhotosUNC,
			MaxWorklistDays,
			WhoCreatedId,
			WhenCreated,
			ReportFooter
		)
		SELECT 
			HospitalID,
			@NewOHID,
			ApplicationTimeOut,
			SystemDisabled,
			ScheduledShutdown,
			PwdRuleMinLength,
			PwdRuleNoOfSpecialChars,
			PwdRuleNoSpaces,
			PwdRuleCantBeUserId,
			PwdRuleDaysToExpiration,
			PwdRuleNoOfPastPwdsToAvoid,
			SiteIdentification,
			SiteRadius,
			OGDDiagnosis,
			UreaseTestsIncludeTickBoxes,
			OesophagitisClassification,
			BostonBowelPrepScale,
			@ReportHeading,
			@ReportTrustType,
			@ReportSubHeading,
			@DepartmentName,
			PatientConsent,
			SortReferringConsultantBy,
			CompleteWHOSurgicalSafetyCheckList,
			ReportLocking,
			LockingTime,
			LockingDays,
			CountryLabel,
			@NEDODSCode,
			NED_OrganisationCode,
			NED_APIKey,
			NED_BatchId,
			(SELECT TOP 1 NED_ExportPath FROM ERS_SystemConfig),
			NEDEnabled,
			AuditLogEnabled,
			ErrorLogEnabled,
			ImGrabEnabled,
			IncludeUGI,
			DefaultPatientStatus,
			DefaultPatientType,
			DefaultWard,
			BRTPulmonaryPhysiology,
			PhotosURL,
			PhotosUNC,
			MaxWorklistDays,
			@LoggedInUserId,
			GETDATE(),
			@ReportFooter
		FROM ERS_SystemConfig
		WHERE ERS_SystemConfig.OperatingHospitalID= @OperatingHospitalId

		IF @CopyPrintSettings = 1 
		BEGIN
			INSERT INTO dbo.ERS_PrintOptionsGPReport
			(
				IncludeDiagram,
				IncludeDiagramOnlyIfSitesExist,
				IncludeListConsultant,
				IncludeNurses,
				IncludeInstrument,
				IncludeMissingCaseNote,
				IncludeIndications,
				IncludeCoMorbidities,
				IncludePlannedProcedures,
				IncludePremedication,
				IncludeProcedureNotes,
				IncludeSiteNotes,
				IncludeBowelPreparation,
				IncludeExtentOfIntubation,
				IncludePreviousGastricUlcer,
				IncludeExtentAndLimitingFactors,
				IncludeCannulation,
				IncludeExtentOfVisualisation,
				IncludeContrastMediaUsed,
				IncludePapillaryAnatomy,
				IncludeDiagnoses,
				IncludeFollowUp,
				IncludeTherapeuticProcedures,
				IncludeSpecimensTaken,
				IncludePeriOperativeComplications,
				DefaultNumberOfCopies,
				DefaultNumberOfPhotos,
				DefaultPhotoSize,
				OperatingHospitalId,
				WhoCreatedId,
				WhenCreated
			)
			SELECT 
				epog.IncludeDiagram, 
				epog.IncludeDiagramOnlyIfSitesExist, 
				epog.IncludeListConsultant, 
				epog.IncludeNurses, 
				epog.IncludeInstrument, 
				epog.IncludeMissingCaseNote, 
				epog.IncludeIndications, 
				epog.IncludeCoMorbidities, 
				epog.IncludePlannedProcedures, 
				epog.IncludePremedication, 
				epog.IncludeProcedureNotes, 
				epog.IncludeSiteNotes, 
				epog.IncludeBowelPreparation, 
				epog.IncludeExtentOfIntubation, 
				epog.IncludePreviousGastricUlcer, 
				epog.IncludeExtentAndLimitingFactors, 
				epog.IncludeCannulation, 
				epog.IncludeExtentOfVisualisation, 
				epog.IncludeContrastMediaUsed, 
				epog.IncludePapillaryAnatomy, 
				epog.IncludeDiagnoses, 
				epog.IncludeFollowUp, 
				epog.IncludeTherapeuticProcedures, 
				epog.IncludeSpecimensTaken, 
				epog.IncludePeriOperativeComplications, 
				epog.DefaultNumberOfCopies, 
				epog.DefaultNumberOfPhotos, 
				 2,
				@NewOHID, 
				@LoggedInUserId, 
				GETDATE()
			FROM dbo.ERS_PrintOptionsGPReport epog
			WHERE epog.OperatingHospitalId =@OperatingHospitalId


			INSERT INTO dbo.ERS_PrintOptionsLabRequestReport
			(
				--RequestReportID - this column value is auto-generated
				OneRequestForEverySpecimen,
				GroupSpecimensByDestination,
				RequestsPerA4Page,
				IncludeDiagram,
				IncludeTimeSpecimenCollected,
				IncludeHeading,
				Heading,
				IncludeIndications,
				IncludeProcedureNotes,
				IncludeAbnormalities,
				IncludeSiteNotes,
				IncludeDiagnoses,
				DefaultNumberOfCopies,
				OperatingHospitalId,
				WhoCreatedId,
				WhenCreated
			)
			SELECT
				OneRequestForEverySpecimen,
				GroupSpecimensByDestination,
				RequestsPerA4Page,
				IncludeDiagram,
				IncludeTimeSpecimenCollected,
				IncludeHeading,
				Heading,
				IncludeIndications,
				IncludeProcedureNotes,
				IncludeAbnormalities,
				IncludeSiteNotes,
				IncludeDiagnoses,
				DefaultNumberOfCopies,
				@NewOHID,
				@LoggedInUserId,
				GETDATE()
			FROM ERS_PrintOptionsLabRequestReport
			WHERE OperatingHospitalId = @OperatingHospitalId


			INSERT INTO dbo.ERS_PrintOptionsPatientFriendlyReport
			(
				IncludeNoFollowup,
				IncludeUreaseText,
				UreaseText,
				IncludePolypectomyText,
				PolypectomyText,
				IncludeOtherBiopsyText,
				OtherBiopsyText,
				IncludeAnyOtherBiopsyText,
				AnyOtherBiopsyText,
				IncludeAdviceComments,
				IncludePreceedAdviceComments,
				PreceedAdviceComments,
				IncludeFinalText,
				FinalText,
				DefaultNumberOfCopies,
				OperatingHospitalId,
				WhoCreatedId,
				WhenCreated
			)
			SELECT
				IncludeNoFollowup,
				IncludeUreaseText,
				UreaseText,
				IncludePolypectomyText,
				PolypectomyText,
				IncludeOtherBiopsyText,
				OtherBiopsyText,
				IncludeAnyOtherBiopsyText,
				AnyOtherBiopsyText,
				IncludeAdviceComments,
				IncludePreceedAdviceComments,
				PreceedAdviceComments,
				IncludeFinalText,
				FinalText,
				DefaultNumberOfCopies,
				@NewOHID,
				@LoggedInUserId,
				GETDATE()
			FROM ERS_PrintOptionsPatientFriendlyReport
			WHERE OperatingHospitalId = @OperatingHospitalId


			INSERT INTO dbo.ERS_PrintOptionsPatientFriendlyReportAdditional
			(
				--Id - this column value is auto-generated
				IncludeAdditionalText,
				AdditionalText,
				OperatingHospitalId,
				WhoCreatedId,
				WhenCreated
			)
			SELECT
				IncludeAdditionalText,
				AdditionalText,
				@NewOHID,
				@LoggedInUserId,
				GETDATE()
			FROM ERS_PrintOptionsPatientFriendlyReportAdditional
			WHERE OperatingHospitalId = @OperatingHospitalId
		END

		IF @CopyPhraseLibrary = 1
		BEGIN
			INSERT INTO dbo.ERS_PhraseLibrary
			(
				--PhraseID - this column value is auto-generated
				UserID,
				PhraseCategory,
				Phrase,
				UsageCount,
				OperatingHospitalId,
				WhoCreatedId,
				WhenCreated
			)
			SELECT
				UserID,
				PhraseCategory,
				Phrase,
				UsageCount,
				OperatingHospitalId,
				WhoCreatedId,
				WhenCreated
			FROM ERS_PhraseLibrary
			WHERE OperatingHospitalId = @OperatingHospitalId
		END

		SELECT CASE WHEN @TrustName IS NULL THEN @NewOHID ELSE @TrustId END
	END TRY

	BEGIN CATCH
		DECLARE @ErrorMessage NVARCHAR(4000);
		DECLARE @ErrorSeverity INT;
		DECLARE @ErrorState INT;

		SELECT @ErrorMessage = ERROR_MESSAGE(),
			  @ErrorSeverity = ERROR_SEVERITY(),
			   @ErrorState = ERROR_STATE();
    
		RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

		IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
	END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;


------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	No TFS - Item 1590,2420 by Ferdowsi
------------------------------------------------------------------------------------------------------------------------
GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ferdowsi	On 6 March 2024
-- TFS#	No TFS - Item 2878  
-- Description of change
--Increased length of gender title
------------------------------------------------------------------------------------------------------------------------
 
EXEC dbo.DropIfExist @ObjectName = 'fnGender',      -- varchar(100)
                     @ObjectTypePrefix = 'F' -- varchar(5)
GO

CREATE FUNCTION [dbo].[fnGender]
(
	-- Add the parameters for the function here
	@GenderId int
)
RETURNS varchar(15)
AS
BEGIN
	-- Declare the return variable here
	DECLARE @Gender varchar(15)

	-- Add the T-SQL statements to compute the return value here
	SELECT @Gender =  egt.Title FROM dbo.ERS_GenderTypes egt	WHERE egt.GenderId=ISNULL(@GenderId,1)

	-- Return the result of the function
	RETURN @Gender

END
Go
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	No TFS - Item 2878 by Ferdowsi
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ferdowsi On 10 March 2024
-- TFS#	No TFS - Item 2464  
-- Description of change
-- Retrived Site name for EBUS procedure

-- Updated by	:	MOSTAFIZUR RAHMAN
-- TFS#	3830
-- Description of change
-- Fixed Normal Procedure showing on DNA / Cancelled report 

------------------------------------------------------------------------------------------------------------------------
GO
EXEC dbo.DropIfExist @ObjectName = 'procedure_summary_update',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

 CREATE PROCEDURE [dbo].[procedure_summary_update]
(
	@ProcedureId INT
)
AS

SET NOCOUNT ON

DECLARE @summaryWhole VARCHAR(MAX)=''
DECLARE @summaryWholeWithHyperLinks VARCHAR(MAX)=''
DECLARE @procType INT
DECLARE @Region VARCHAR(150)
DECLARE @ResectedColonId INT
DECLARE @OperatingHospitalID INT 


BEGIN TRANSACTION

BEGIN TRY

	SELECT @ProcType=ProcedureType, @ResectedColonId=ResectedColonNo FROM ERS_Procedures WHERE ProcedureId = @ProcedureId
	SELECT @OperatingHospitalID = OperatingHospitalID FROM ERS_Procedures WHERE ProcedureId = @ProcedureId
	SELECT @summaryWhole = 
		CASE WHEN PatientNotes = 0 AND PatientReferralLetter = 1
              THEN  'Patient notes NOT available but referral letter/documentation WAS available.<br/>'
			 WHEN PatientNotes = 0 AND PatientReferralLetter = 0
              THEN  'Patient notes NOT available.<br />'
			 WHEN PatientNotes = 1
              THEN 'Patient notes available.<br />'
			 ELSE
			  ''
		END + @summaryWhole
	FROM ERS_Procedures WHERE ProcedureId = @ProcedureId
 	-- 'SiteNo is set to -77 for sites By Distance (Col & Sig only)
    SELECT CASE WHEN SiteNo = -77 THEN 
						CASE WHEN s.YCoordinate IS NULL OR s.YCoordinate=0 THEN 'At ' + CONVERT(VARCHAR,s.XCoordinate) + ' cm from anus'
						ELSE ('Starting at ' + CONVERT(VARCHAR,s.XCoordinate) + ' extending to ' + CONVERT(VARCHAR,s.YCoordinate) + ' cm from anus' ) END  + SPACE(400)
			ELSE 'Site ' + dbo.fnGetSiteTitle(SiteNo, @OperatingHospitalID) + ':'  + SPACE(400) END AS SiteName,

			CASE AntPos
				WHEN 1 THEN 'Anterior '
				WHEN 2 THEN 'Posterior '
				ELSE ''
			END +
			CASE 
				WHEN SiteNo = -77 THEN '' 
				WHEN AreaNo > 0 THEN dbo.fnSetAreaDescription(@ProcedureId, AreaNo, @ResectedColonId)
				WHEN AreaNo = 0 THEN ISNULL((SELECT r.Region FROM ERS_Regions r WHERE r.RegionId = s.RegionId),'') --TFS 4046
				WHEN ISNULL(@ResectedColonId,0) > 0  AND
						 EXISTS (SELECT 1 FROM ERS_Regions r 
								JOIN ERS_ResectedColonRegions rcr ON r.RegionId = rcr.RegionId
								WHERE r.RegionId = s.RegionId
								AND rcr.ResectedColonId = @ResectedColonId) THEN 'anastomosis'
				ELSE LOWER(ISNULL((SELECT CASE WHEN @ResectedColonId IN (7,6) AND LOWER(Region) = 'terminal ileum' 
			 
									THEN 'neo-terminal ileum' 
									WHEN @ResectedColonId = 9 AND LOWER(Region) = 'terminal ileum' 
									THEN 'ileal pouch' 
									ELSE 
										CASE @ProcType WHEN 11 THEN Region  ELSE  eeln2.Name END 
									END 
								FROM ERS_Regions r 
								WHERE r.RegionId = s.RegionId),''))
			END AS SiteDesc,
			
            CASE WHEN ISNULL(SiteSummary, '') <> '' THEN SiteSummary END AS FullSummaryAbnormalities,
            CASE WHEN ISNULL(SiteSummarySpecimens, '') <> '' THEN SiteSummarySpecimens END AS FullSummarySepcimens,
            CASE WHEN ISNULL(SiteSummaryTherapeutics, '') <> '' THEN SiteSummaryTherapeutics END AS FullSummaryTherapeutics,
            CASE WHEN ISNULL(SiteSummaryWithLinks, '') <> '' THEN SiteSummaryWithLinks END AS FullSummaryAbnormalitiesWithLinks,
            CASE WHEN ISNULL(SiteSummarySpecimensWithLinks, '') <> '' THEN SiteSummarySpecimensWithLinks END AS FullSummarySepcimensWithLinks,
            CASE WHEN ISNULL(SiteSummaryTherapeuticsWithLinks, '') <> '' THEN SiteSummaryTherapeuticsWithLinks END AS FullSummaryTherapeuticsWithLinks,
			CASE WHEN SiteNo = -77 THEN ISNULL(s.XCoordinate,0) + 5000 ELSE SiteNo END AS OrderBy
    INTO #Sites
    FROM ERS_Sites s
	LEFT JOIN dbo.ERS_EBUSLymphNodes AS eeln2
		ON s.EBUSLymphNodeSiteId = eeln2.EBUSLymphNodeId
    WHERE ProcedureId = @ProcedureId 
    ORDER BY SiteNo
    --AND ISNULL(SiteSummary, '') <> ''
	IF @procType = 11	--EBUS
		UPDATE #Sites SET SiteName = '<b style="color:#606060;">' + RTRIM(SiteName) + ' ' + dbo.fnFirstLastLetterUpper(SiteDesc) +'</b> '
	ELSE
		UPDATE #Sites SET SiteName = '<b style="color:#606060;">' + RTRIM(SiteName) + ' ' + dbo.fnFirstLetterUpper(SiteDesc) +'</b> '
    SELECT 
            CASE WHEN (FullSummaryAbnormalities is not null or FullSummarySepcimens is not null or FullSummaryTherapeutics is not null)
                    THEN SiteName + ISNULL(FullSummaryAbnormalities, '') + ISNULL(FullSummaryTherapeutics, '') + ISNULL(FullSummarySepcimens, '')
            END AS mysummary,
            CASE WHEN (FullSummaryAbnormalitiesWithLinks is not null or FullSummarySepcimensWithLinks is not null or FullSummaryTherapeuticsWithLinks is not null)
                    THEN SiteName + ISNULL(FullSummaryAbnormalitiesWithLinks, '') + ISNULL(FullSummaryTherapeuticsWithLinks, '') + ISNULL(FullSummarySepcimensWithLinks, '')
            END AS mysummaryWithLinks,
			OrderBy
    INTO #Sites2
    FROM #Sites
 

    --select * from #Sites2
 
    SELECT @summaryWhole = COALESCE (
                        --CASE WHEN @summaryWhole = '' THEN ISNULL(mysummary, '')
                        --ELSE 
                        @summaryWhole + CASE WHEN @summaryWhole <> '' THEN '<br />' END
                        --END
                    ,'') + mysummary,
                    @summaryWholeWithHyperLinks = COALESCE (
                        --CASE WHEN @@summaryWholeWithHyperLinks = '' THEN ISNULL(mysummaryWithLinks, '')
                        --ELSE 
                        @summaryWholeWithHyperLinks + CASE WHEN @summaryWholeWithHyperLinks <> '' THEN '<br />' END
                        --END
                    ,'') + mysummaryWithLinks
    FROM #Sites2
    where mysummary is not null
    order by OrderBy
    --SELECT @summaryWhole, @summaryWholeWithHyperLinks 

    --EXTENT OF INTUBATION
    IF @procType = 3 OR @procType = 4 
            BEGIN
            DECLARE @tSummary varchar(5000) = ''
            --DECLARE @lSummary varchar(5000) = ''
            --DECLARE @BowelPrepSettings bit
            --DECLARE @smry varchar(5000) = ''

            --DECLARE @oBPrep varchar(4000) = ISNULL((SELECT ISNULL([PP_Bowel_Prep],'') FROM [ERS_ProceduresReporting] WHERE [ProcedureID] = @ProcedureId),'')
            DECLARE @oExtent  varchar(4000) = ISNULL((SELECT TOP 1 ISNULL([Summary], '') FROM  ERS_ProcedureLowerExtent WHERE ProcedureId = @ProcedureId),'')
            DECLARE @oComplications varchar(4000) = ISNULL((SELECT ISNULL(Summary,'') FROM ERS_UpperGIQA WHERE ProcedureId = @ProcedureId),'')
			DECLARE @iPatientSedation_Col varchar(4000) = ISNULL((SELECT ISNULL(Summary,'') FROM ERS_ProcedureSedationScore WHERE ProcedureId = @ProcedureId),'')
            DECLARE @iPatientDiscomfort_Col varchar(4000) = ISNULL((SELECT ISNULL(Summary,'') FROM ERS_ProcedureDiscomfortScore WHERE ProcedureId = @ProcedureId),'')
            DECLARE @oAdverseEvents varchar(MAX) = ISNULL((SELECT dbo.ProcedureAdverseEventsSummary(@ProcedureId)), '')
			  
            --IF @oBPrep <> '' AND @oBPrep IS NOT NULL SET  @tSummary = @tSummary + @oBPrep + '<br/>'
            IF @oExtent <> '' SET  @tSummary = @tSummary + @oExtent + '<br/>'
            IF @oComplications <> '' SET  @tSummary = @tSummary + @oComplications + '<br/>'
			IF @iPatientSedation_Col IS NOT NULL AND @iPatientSedation_Col <> '' SET  @tSummary = @tSummary + @iPatientSedation_Col + '.<br/>'
			IF @iPatientDiscomfort_Col IS NOT NULL AND @iPatientDiscomfort_Col <> '' SET  @tSummary = @tSummary + @iPatientDiscomfort_Col + '.<br/>'
			IF @oAdverseEvents IS NOT NULL AND @oAdverseEvents <> '' SET  @tSummary = @tSummary + @oAdverseEvents + '.<br/>'

            SET @summaryWhole = @tSummary + @summaryWhole
            SET @summaryWholeWithHyperLinks = @tSummary + @summaryWholeWithHyperLinks
    END
    ELSE
            BEGIN
			DECLARE @iVisualisation varchar(5000) = ISNULL((SELECT ISNULL(summary,'') FROM ERS_Visualisation WHERE ProcedureId = @ProcedureId),'')
            DECLARE @iExtent  varchar(5000)= ISNULL((SELECT TOP 1 ISNULL(summary,'') FROM ERS_ProcedureUpperExtent WHERE ProcedureId = @ProcedureId),'')
            DECLARE @iNormalDiag varchar(1000) = ISNULL((SELECT CASE WHEN EXISTS(SELECT 1 FROM ERS_Diagnoses WHERE ProcedureID=@ProcedureId AND MatrixCode='OverallNormal' AND Value='True') THEN 'The whole upper gastro-intestinal track was normal' ELSE '' END),'')
            DECLARE @iPatientSedation varchar(4000) = ISNULL((SELECT ISNULL(Summary,'') FROM ERS_ProcedureSedationScore WHERE ProcedureId = @ProcedureId),'')
            DECLARE @iPatientDiscomfort varchar(4000) = ISNULL((SELECT ISNULL(Summary,'') FROM ERS_ProcedureDiscomfortScore WHERE ProcedureId = @ProcedureId),'')
            DECLARE @iComplications varchar(4000) = ISNULL((SELECT ISNULL(Summary,'') FROM ERS_UpperGIQA WHERE ProcedureId = @ProcedureId),'')
			DECLARE @iAdverseEvents varchar(MAX) = ISNULL((SELECT dbo.ProcedureAdverseEventsSummary(@ProcedureId)), '')
			DECLARE @PapillaryAnatomySummary varchar(4000)  = ISNULL((SELECT Summary FROM ERS_ERCPPapillaryAnatomy WHERE ProcedureId = @ProcedureId),'')
            DECLARE @VocalCordParalysis varchar(4000) = ISNULL((SELECT Description FROM ERS_ProcedureVocalCordParalysis pv INNER JOIN ERS_VocalCordParalysis p ON p.UniqueId = pv.VocalCordParalysisId WHERE ProcedureId = @ProcedureId), '')
			DECLARE @tSumm varchar(5000) = ''
			
			IF @iVisualisation IS NOT NULL AND @iVisualisation<>'' SET @tSumm = @tSumm + @iVisualisation +'<br/>'
			IF @iExtent IS NOT NULL AND  @iExtent <> '' SET  @tSumm = @tSumm + @iExtent + '.<br/>'
			IF @iNormalDiag IS NOT NULL AND @iNormalDiag <> '' SET  @tSumm = @tSumm + @iNormalDiag + '.<br/>'
			IF @iPatientSedation IS NOT NULL AND @iPatientSedation <> '' SET  @tSumm = @tSumm + @iPatientSedation + '.<br/>'
			IF @iPatientDiscomfort IS NOT NULL AND @iPatientDiscomfort <> '' SET  @tSumm = @tSumm + @iPatientDiscomfort + '.<br/>'
			IF @VocalCordParalysis IS NOT NULL AND @VocalCordParalysis <> '' SET @tSumm = @tSumm + 'Vocal cord paralysis: ' + @VocalCordParalysis + '.<br />'
			IF @iComplications IS NOT NULL AND @iComplications <> '' SET  @tSumm = @tSumm + @iComplications + '.<br/>'
			IF @iAdverseEvents IS NOT NULL AND @iAdverseEvents <> '' SET  @tSumm = @tSumm + @iAdverseEvents + '.<br/>'
			IF @PapillaryAnatomySummary <> '' SET  @tSumm = @tSumm + @PapillaryAnatomySummary + '.<br/>'
            
			IF @procType IN (10,11)
			BEGIN
				DECLARE @iAdditionalReportText varchar(max) = ISNULL((SELECT ISNULL(AdditionalNotes,'') FROM ERS_ProcedureAdditionalNotes WHERE ProcedureId = @ProcedureId),'')
				IF @iAdditionalReportText IS NOT NULL AND @iAdditionalReportText<>'' SET @tSumm = @tSumm + @iAdditionalReportText +'<br/>'
			END

			SET @summaryWhole = @tSumm +@summaryWhole
            SET @summaryWholeWithHyperLinks = @tSumm + @summaryWholeWithHyperLinks
    END

	-- Check for urease test and update summary with checkboxes if set in system settings
	If (Select UreaseTestsIncludeTickBoxes from ERS_SystemConfig where OperatingHospitalID = @OperatingHospitalID) = 1
	BEGIN
		-- now need to check for urease test taken and results unknown
		If (Select count(1) from ERS_UpperGISpecimens where SiteId in (Select SiteId from ERS_Sites where ProcedureId = @ProcedureId) and Urease = 1 and UreaseResult = 0) > 0
		BEGIN
			SET @summaryWhole = replace(@summaryWhole, 'Urease test.', 'Urease test +ve &#x25A1; &nbsp; -ve &#x25A1; &nbsp;')
		END
	END
 
	--EDITED BY MOSTAFIZ 3830
		DECLARE @DNA INT;		
		SELECT @DNA = DNA 
		FROM ERS_PROCEDURES 
		WHERE PROCEDUREID = @ProcedureId;

		IF @DNA IS NOT NULL
		BEGIN
			SET @summaryWhole=''
			SET @summaryWholeWithHyperLinks=''
		END		
	--EDITED BY MOSTAFIZ 3830

	UPDATE ERS_ProceduresReporting
    SET Summary = @summaryWhole,
            SummaryWithLinks = @summaryWholeWithHyperLinks
            --PP_MainReportBody = @summaryAbnormalities,
            --PP_SpecimenTaken = @summarySpecimens,
            --PP_Therapies = @summaryTherapeutics
    WHERE
            ProcedureId = @ProcedureId

    DROP TABLE #Sites
    DROP TABLE #Sites2
END TRY

BEGIN CATCH
       DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

       IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;

Go
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	No TFS - Item 2464 by Ferdowsi
-- End OF TSF# 3830
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	MOSTAFIZUR RAHMAN
-- TFS#	2360
-- Description of change
-- Added SEv2 Barretts questions, appear on if they are a smoker yes/no and for answer to appear on report
------------------------------------------------------------------------------------------------------------------------
GO
EXEC dbo.DropIfExist @ObjectName = 'TR_UpperGIAbnoBarrett_Delete',      -- varchar(100)
                     @ObjectTypePrefix = 'TR' -- varchar(5)

GO
EXEC dbo.DropIfExist @ObjectName = 'TR_UpperGIAbnoBarrett_Insert',      -- varchar(100)
                     @ObjectTypePrefix = 'TR' -- varchar(5)
GO

IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.COLUMNS
    WHERE TABLE_NAME = 'ERS_UpperGIAbnoBarrett'
      AND COLUMN_NAME IN ('SmokerRadioButtonListId')
)
BEGIN
    ALTER TABLE dbo.ERS_UpperGIAbnoBarrett
    ADD SmokerRadioButtonListId INT NULL;
END

GO

EXEC dbo.DropIfExist 
    @ObjectName = 'abnormalities_barrett_select', 
    @ObjectTypePrefix = 'S' 
GO


CREATE PROCEDURE [dbo].[abnormalities_barrett_select]
(
	@SiteId INT	
)
AS

SET NOCOUNT ON

SELECT
       [SiteId]
      ,[None]
      ,[BarrettIslands]
      ,[Proximal]
      ,[Distal]
      ,[DistanceC1]
      ,[DistanceC2]
      ,[DistanceC3]
      ,[DistanceM1]
      ,[DistanceM2]
	  ,[FocalLesions]
	  ,[FocalLesionQty]
	  ,[FocalLesionLargest]
	  ,[FocalLesionTumourTypeId]
	  ,[FocalLesionProbably]
	  ,[FocalLesionParisClassificationId]
	  ,[FocalLesionPitPatternId]
	  ,[InspectionTimeMins]
	  ,[SmokerRadioButtonListId] --added by mostafiz
	 

FROM
       ERS_UpperGIAbnoBarrett
WHERE 
       SiteId = @SiteId


GO

EXEC dbo.DropIfExist 
    @ObjectName = 'abnormalities_barrett_summary_update', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[abnormalities_barrett_summary_update]
(
       @SiteId INT
)
AS
       SET NOCOUNT ON

       DECLARE
              @summary VARCHAR(300),
              @None BIT,
              @BarrettIslands BIT,
              @Proximal INT,
              @Distal INT,
              @DistanceC1 INT,
              @DistanceC2 INT,
              @DistanceC3 INT,
              @DistanceM1 INT,
              @DistanceM2 INT,
			  @FocalLesions BIT,
			  @FocalLesionQty INT,
			  @FocalLesionLargest INT,
			  @FocalLesionTumourTypeId INT,
			  @FocalLesionProbably BIT,
			  @FocalLesionParisClassificationId INT,
			  @FocalLesionPitPatternId INT,
			  @SmokerRadioButtonListId INT--add by mostafiz 2360



       SELECT 
              @None=[None],
              @BarrettIslands = BarrettIslands,
              @Proximal = Proximal,
              @Distal = Distal,
              @DistanceC1 = DistanceC1,
              @DistanceC2 = DistanceC2,
              @DistanceC3 = DistanceC3,
              @DistanceM1 = DistanceM1,
              @DistanceM2 = DistanceM2,
			  @FocalLesions = FocalLesions,
			  @FocalLesionQty = FocalLesionQty,
			  @FocalLesionLargest = FocalLesionLargest,
			  @FocalLesionTumourTypeId = FocalLesionTumourTypeId,
			  @FocalLesionProbably = FocalLesionProbably,
			  @FocalLesionParisClassificationId = FocalLesionParisClassificationId,
			  @FocalLesionPitPatternId = FocalLesionPitPatternId,
			  @SmokerRadioButtonListId =SmokerRadioButtonListId --add by mostafiz 2360
       FROM
              ERS_UpperGIAbnoBarrett
       WHERE
              SiteId = @SiteId

       SET @Summary = ''
	DECLARE @BarrattsText varchar(500) ='', @Start varchar(500) ='', @End varchar(500)=''

       IF @None = 1 SET @summary = @summary + 'No Barrett''s epithelium'
       ELSE 
        BEGIN

		--add by mostafiz 2360
					
			IF (@SmokerRadioButtonListId =1 ) SET @summary=@summary+ ' Patient is smoker. '
			ELSE IF (@SmokerRadioButtonListId =2 ) SET @summary=@summary+ 'Patient is non-smoker. '
			
		--add by mostafiz 2360
			

			--FOCAL LESIONS
			IF @FocalLesions = 1 
			BEGIN
				--saves calling the table multiple times :)
				DECLARE @TumourTypes TABLE (TypeId int, [Description] varchar(100))
				INSERT INTO @TumourTypes
				SELECT UniqueId, [Description] 
				FROM ERS_TumourTypes 
				WHERE Suppressed = 0


				IF @FocalLesionQty > 1 SET @summary = @summary + CONVERT(VARCHAR(20), @FocalLesionQty) + ' '
				ELSE SET @summary = @summary + 'A '
		
				IF @FocalLesionProbably = 1 SET @summary = @summary + 'probably '

				SELECT @summary = @summary + LOWER([Description]) + ' ' FROM @TumourTypes WHERE TypeId = @FocalLesionTumourTypeId

				IF @FocalLesionQty > 1 SET @summary = @summary + 'focal lesions ' ELSE SET @summary = @summary + 'focal lesion ' 

				IF (@FocalLesionQty > 0 AND @FocalLesionLargest > 0) 
				BEGIN
					IF @FocalLesionQty > 1
						SET @summary = @summary + '(largest ' + CONVERT(VARCHAR(20), @FocalLesionLargest) + 'mm)'
					ELSE
						SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @FocalLesionLargest) + 'mm)'
				END

				SET @summary = @summary + '. '
			END

			IF @BarrettIslands=1 SET @Start='Islands of '
			IF (ISNULL(@Distal,0) <> 0) OR (ISNULL(@Proximal,0) <>0)
					BEGIN
					SET @End= ' from ' + cast(ISNULL(@Proximal,0) as varchar(50)) + 'cm'
					SET @End= @End + ' to ' + cast(ISNULL(@Distal,0) as varchar(50)) + 'cm'
					END
			IF ISNULL(@DistanceM1,0)<>0 OR ISNULL(@DistanceM2,0)<>0
					BEGIN
					SET @BarrattsText= ', Prague C'+cast(ISNULL(@DistanceM2,0) as varchar(50))
					SET @BarrattsText= @BarrattsText + 'M' +cast(ISNULL(@DistanceM1,0) as varchar(50))
					END
			ELSE
					BEGIN
					IF @DistanceC1>0 AND @DistanceC2>0 AND @DistanceC3>0
					BEGIN
					SET @BarrattsText = ', Prague C' +cast(ISNULL(@DistanceC3-@DistanceC1,0) as varchar(50))
					SET @BarrattsText= @BarrattsText + 'M' +cast(ISNULL(@DistanceC3 - @DistanceC2,0) as varchar(50))
					END
					END
			IF @BarrattsText ='' BEGIN IF @Start <> '' OR @End <> '' SET @summary = @Start + 'Barrett''s epithelium'+ @End END
			ELSE SET @summary = @summary + @Start + 'Barrett''s epithelium distance (ab oral)'+ @End+@BarrattsText --TFS--4079

        END
       -- Finally update the summary in abnormalities table
       UPDATE ERS_UpperGIAbnoBarrett
       SET Summary = @Summary 
       WHERE SiteId = @siteId
GO

EXEC dbo.DropIfExist 
    @ObjectName = 'abnormalities_barrett_save', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[abnormalities_barrett_save]
(
       @SiteId INT,
       @None BIT,
       @BarrettIslands BIT,
       @Proximal INT,
       @Distal INT,
       @DistanceC1 INT,
       @DistanceC2 INT,
       @DistanceC3 INT,
       @DistanceM1 INT,
       @DistanceM2 INT,
	   @FocalLesion BIT,
	   @FocalLesionQty INT,
	   @FocalLesionLargest INT,
	   @FocalLesionTumourTypeId INT,
	   @FocalLesionProbably BIT,
	   @FocalLesionParisClassificationId INT,
	   @FocalLesionPitPatternId INT,
	   @InspectionTimeMins INT,
	   @SmokerRadioButtonListId INT, --add by mostafiz 2360
	   @LoggedInUserId INT
)
AS

SET NOCOUNT ON

DECLARE @proc_id INT
DECLARE @proc_type INT

BEGIN TRANSACTION

BEGIN TRY
       SELECT 
              @proc_id = p.ProcedureId,
              @proc_type = p.ProcedureType
       FROM 
              ERS_Sites s
       JOIN 
              ERS_Procedures p ON s.ProcedureId = p.ProcedureId
       WHERE 
              SiteId = @SiteId
                     
       
       
       IF (@None=0 AND @BarrettIslands=0 AND @Proximal IS NULL AND @Distal IS NULL AND @DistanceC1 IS NULL AND @DistanceC2 IS NULL AND @DistanceC3 IS NULL AND @DistanceM1 IS NULL AND @DistanceM2 IS NULL AND @FocalLesion = NULL AND @InspectionTimeMins = NULL)
       BEGIN
              DELETE FROM ERS_UpperGIAbnoBarrett 
              WHERE SiteId = @SiteId
			  
			  DELETE FROM ERS_RecordCount 
              WHERE SiteId = @SiteId
              AND Identifier = 'Barretts'
       END
	   
       ELSE
		   BEGIN
				IF NOT EXISTS (SELECT 1 FROM ERS_UpperGIAbnoBarrett WHERE SiteId = @SiteId)
			   BEGIN
					  INSERT INTO ERS_UpperGIAbnoBarrett
									 ([SiteId]
									,[None]
									,[BarrettIslands]
									,[Proximal]
									,[Distal]
									,[DistanceC1]
									,[DistanceC2]
									,[DistanceC3]
									,[DistanceM1]
									,[DistanceM2]
									,[FocalLesions]
									,[FocalLesionQty]
									,[FocalLesionLargest]
									,[FocalLesionTumourTypeId]
									,[FocalLesionProbably]
									,[FocalLesionParisClassificationId]
									,[FocalLesionPitPatternId]
									,[InspectionTimeMins]
									,[WhoCreatedId]
									,[WhenCreated]
									,[SmokerRadioButtonListId]								
									)
							VALUES (@SiteId ,
									@None ,
									@BarrettIslands ,
									@Proximal ,
									@Distal ,
									NULLIF(@DistanceC1,0) ,
									NULLIF(@DistanceC2,0) ,
									NULLIF(@DistanceC3,0) ,
									NULLIF(@DistanceM1,0) ,
									@DistanceM2 ,
									@FocalLesion ,
									NULLIF(@FocalLesionQty,0) ,
									NULLIF(@FocalLesionLargest,0) ,
									NULLIF(@FocalLesionTumourTypeId,0) ,
									@FocalLesionProbably ,
									@FocalLesionParisClassificationId ,
									@FocalLesionPitPatternId ,
									@InspectionTimeMins ,
									@LoggedInUserId ,
									GETDATE(),
									NULLIF(@SmokerRadioButtonListId,0)) --add by mostafiz 2360	
																
					  INSERT INTO ERS_RecordCount (
							 [ProcedureId],
							 [SiteId],
							 [Identifier],
							 [RecordCount]
					  )
					  VALUES (
							 @proc_id,
							 @SiteId,
							 'Barretts',
							 1)
			   END
		   Else
			   BEGIN
				  UPDATE 
						 ERS_UpperGIAbnoBarrett
				  SET 
						[None]=@None  ,
						[BarrettIslands]=@BarrettIslands ,
						[Proximal]=@Proximal ,
						[Distal]=@Distal ,
						[DistanceC1]=NULLIF(@DistanceC1,0),
						[DistanceC2]=NULLIF(@DistanceC2,0) ,
						[DistanceC3]=NULLIF(@DistanceC3,0) ,
						[DistanceM1]= NULLIF(@DistanceM1,0) ,
						[DistanceM2]=@DistanceM2 ,
						[FocalLesions] =@FocalLesion,
						[FocalLesionQty] = NULLIF(@FocalLesionQty,0),
						[FocalLesionLargest] = NULLIF(@FocalLesionLargest,0),
						[FocalLesionTumourTypeId] =NULLIF(@FocalLesionTumourTypeId,0),
						[FocalLesionProbably] =@FocalLesionProbably,
						[FocalLesionParisClassificationId] =@FocalLesionParisClassificationId,
						[FocalLesionPitPatternId] = @FocalLesionPitPatternId,
						[InspectionTimeMins] =@InspectionTimeMins,
						[WhoUpdatedId] = @LoggedInUserId,
						[WhenUpdated] = GETDATE(),
						[SmokerRadioButtonListId]=@SmokerRadioButtonListId --add by mostafiz 2360						
				  WHERE 
						 SiteId = @SiteId 
			   END
		  EXEC abnormalities_Barrett_summary_update @SiteId
		  EXEC diagnoses_control_save @SiteId, 'N2003', @FocalLesion  --Focal Lesions

       END

	    --ADDED BY MOSTAFIZ 2360
	  EXEC sites_summary_update @SiteId
	  EXEC diagnoses_control_save @SiteId, 'D23P1', @BarrettIslands  --Barretts

	    --ADDED BY MOSTAFIZ 2360
END TRY

BEGIN CATCH
       DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

       IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;

------------------------------------------------------------------------------------------------------------------------
-- TFS#	2360 Ended
------------------------------------------------------------------------------------------------------------------------
GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rony
-- TFS#	3833
-- Description of change
-- OGD Oesophagal stricture 
------------------------------------------------------------------------------------------------------------------------
 IF NOT EXISTS (
        SELECT 1
        FROM INFORMATION_SCHEMA.COLUMNS
        WHERE TABLE_NAME = 'ERS_UpperGITherapeutics' AND
              COLUMN_NAME IN ('DilatationPerforation')
    )
    BEGIN
		
		ALTER TABLE ERS_UpperGITherapeutics
            ADD DilatationPerforation BIT
    END
GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	3833
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	MOSTAFIZUR RAHMAN
-- TFS#	2743
-- Description of change
-- Changed Balloon Dilation when it is selected within a colon additional options need to show the diameter and type 
-- TFS# 2430 By Siddikur Rahman
-- Description of change: SEv2 EBUS specimens add / therapeutics 
-- Updated by	:	Rony
-- TFS#	2970
-- Description of change
-- tattoo on tomour 
-- Updated by	:	Rony
-- TFS#	4085
-- Description of change
-- Oesophageal dilatation is correcting to no decimal ie 16.5mm becomes 17mm
-- Updated by	:	Rony
-- TFS#	3833
-- Description of change
-- OGD Oesophagal stricture 
------------------------------------------------------------------------------------------------------------------------

---adding 'Balloon dilatation units' in ers_listsmain
IF NOT EXISTS (SELECT 1 FROM ers_listsmain WHERE ListDescription = 'Balloon dilatation units')
BEGIN
    INSERT INTO ers_listsmain
        (ListDescription, AllowAddNewItem, OrderByDesc, FirstItemText, WhoUpdatedId, WhoCreatedId, whenCreated, whenUpdated, ReferenceTable)
    VALUES
        ('Balloon dilatation units', 0, 1, '', NULL, NULL, NULL, NULL, NULL);
END

DECLARE @ListMainId INT = SCOPE_IDENTITY();

---adding Fr in as unit of balloon dilatation in ers_lists

IF NOT EXISTS (
    SELECT 1 
    FROM ers_lists 
    WHERE ListDescription = 'Balloon dilatation units'
        AND ListItemText = 'Fr'
)
BEGIN
    INSERT INTO ers_lists
        (ListDescription, ListItemNo, ListItemText, Suppressed, ReadOnly, ListMainId, WhoUpdatedId, WhoCreatedId, whenCreated, whenUpdated)
    VALUES
        ('Balloon dilatation units', 0, 'Fr', 0, 0, @ListMainId, 0, 0, GETDATE(), GETDATE());
END

	---adding mm in as unit of balloon dilatation in ers_lists
IF NOT EXISTS (
    SELECT 1 
    FROM ers_lists 
    WHERE ListDescription = 'Balloon dilatation units'
        AND ListItemText = 'mm'
)
BEGIN
    INSERT INTO ers_lists
        (ListDescription, ListItemNo, ListItemText, Suppressed, ReadOnly, ListMainId, WhoUpdatedId, WhoCreatedId, whenCreated, whenUpdated)
    VALUES
        ('Balloon dilatation units', 1, 'mm', 0, 0, @ListMainId, 0, 0, GETDATE(), GETDATE());
END

GO

---adding 'Therapeutic Balloon Dilation Types' in ers_listsmain

IF NOT EXISTS (SELECT 1 FROM ers_listsmain WHERE ListDescription = 'Therapeutic Balloon Dilation Types')
BEGIN
    INSERT INTO ers_listsmain
        (ListDescription, AllowAddNewItem, OrderByDesc, FirstItemText, WhoUpdatedId, WhoCreatedId, whenCreated, whenUpdated, ReferenceTable)
    VALUES
        ('Therapeutic Balloon Dilation Types', 1, 1, '', NULL, NULL, NULL, NULL, NULL);
END
GO

-- Check if columns already exist in ERS_UpperGITherapeutics table
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.COLUMNS
    WHERE TABLE_NAME = 'ERS_UpperGITherapeutics'
    AND COLUMN_NAME IN ('BalloonDilationType', 'BalloonDilationDiameter', 'BalloonDilationDiameterUnits')
)
BEGIN
    -- Add the new columns to ERS_UpperGITherapeutics table
    ALTER TABLE dbo.ERS_UpperGITherapeutics
    ADD BalloonDilationType SMALLINT NULL,
        BalloonDilationDiameter INT NULL,
        BalloonDilationDiameterUnits TINYINT NULL;
END

-- TFS-4085
GO
 IF EXISTS (
        SELECT 1
        FROM INFORMATION_SCHEMA.COLUMNS
        WHERE TABLE_NAME = 'ERS_UpperGITherapeutics' AND
              COLUMN_NAME ='DilatedTo'
    )
    BEGIN
		
		ALTER TABLE dbo.ERS_UpperGITherapeutics
            ALTER Column DilatedTo Decimal(8,2)
    END
	-- TFS-4085
GO

IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.COLUMNS
    WHERE TABLE_NAME = 'ERS_UpperGITherapeutics'
      AND COLUMN_NAME IN ('BicapElectroType')
)
BEGIN
	alter table dbo.ERS_UpperGITherapeutics
	add BicapElectroType int NULL
END
GO
IF NOT EXISTS (SELECT 1 FROM ERS_ListsMain WHERE ListDescription = 'Bicap electrocautery')
	BEGIN
		INSERT INTO ERS_ListsMain (ListDescription, AllowAddNewItem,OrderByDesc, FirstItemText, WhoUpdatedId, WhoCreatedId,WhenCreated, WhenUpdated,ReferenceTable)
		Values('Bicap electrocautery',1,1,null,null,1,GETDATE(),GETDATE(), null)
		
		INSERT INTO ERS_Lists (ListDescription, ListItemNo,ListItemText, Suppressed, ReadOnly, ListMainId, WhoCreatedId,WhenCreated, WhenUpdated)
		Values('Bicap electrocautery',0,'Gold Probe',0,0,SCOPE_IDENTITY(),1,GETDATE(),GETDATE())
	END

GO 
EXEC dbo.DropIfExist 
    @ObjectName = 'therapeutics_ogd_summary_update', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[therapeutics_ogd_summary_update]
(
	@TherapeuticId AS INT,
	@SiteId INT
)
AS
	SET NOCOUNT ON
	DECLARE   @msg VARCHAR(1000)
			, @msg2 VARCHAR(1000)
			, @Details VARCHAR(1000)
			, @Summary VARCHAR(4000)=''
			, @Area VARCHAR(500)=''
			, @br VARCHAR(6) = '<br />'
			, @dilatationPerforationTxt VARCHAR(30); -- TFS-3833

	DECLARE 
		@None BIT,
		@YAGLaser BIT,
		@YAGLaserWatts INT,
		@YAGLaserPulses INT,
		@YAGLaserSecs DECIMAL(8,2),
		@YAGLaserKJ DECIMAL(8,2),
		@ArgonBeamDiathermy BIT,
		@ArgonBeamDiathermyWatts INT,
		@ArgonBeamDiathermyPulses INT,
		@ArgonBeamDiathermySecs DECIMAL(8,2),
		@ArgonBeamDiathermyKJ DECIMAL(8,2),
		@BalloonDilation BIT,
		--added by mostafiz tsf:2743
		@BalloonDilationType SMALLINT,
		@BalloonDilationDiameter INT,
		@BalloonDilationDiameterUnits TINYINT,
		--added by mostafiz tsf:2743
		@BandLigation BIT,
		@BandLigationPerformed INT,
		@BandLigationSuccess INT,
		@BotoxInjection BIT,
		@EndoloopPlacement BIT,
		@HeatProbe BIT,
		@BicapElectro BIT,
		@Diathermy BIT,
		@DiathermyWatt INT,	--Mahfuz added on 30 Jul 2021
		@Coil BIT,
		@CoilQty INT,
		@CoilType INT,
		@Valve BIT,
		@ValveQty INT,
		@ValveType INT,
		@Cryotherapy BIT,
		@PhotoDynamicTherapy BIT,
		@ForeignBody BIT,
		@HotBiopsy BIT,
		@Injection BIT,
		@InjectionType INT,
		@InjectionVolume INT,
		@InjectionNumber INT,
		@OesophagealDilatation BIT,
		@DilatedTo DECIMAL(8,2), --Added by rony tfs-4085
		@DilatationUnits TINYINT,
		@DilatorType TINYINT,
		@DilatorScopePass BIT,
		@OesoDilNilByMouth BIT,
		@OesoDilNilByMouthHrs INT,
		@OesoDilXRay BIT,
		@OesoDilXRayHrs INT,
		@OesoDilSoftDiet BIT,
		@OesoDilSoftDietDays INT,
		@OesoDilWarmFluids BIT,
		@OesoDilWarmFluidsHrs INT,
		@OesoDilMedicalReview BIT,
		@OesoYAGNilByMouth BIT,
		@OesoYAGNilByMouthHrs INT,
		@OesoYAGWarmFluids BIT,
		@OesoYAGWarmFluidsHrs INT,
		@OesoYAGSoftDiet BIT,
		@OesoYAGSoftDietDays INT,
		@OesoYAGMedicalReview BIT,
		@Polypectomy BIT,
		@PolypectomyRemoval TINYINT,
		@PolypectomyRemovalType TINYINT,
		@BandingPiles BIT,
		@BandingNum INT,
		@GastrostomyInsertion BIT,
		@GastrostomyInsertionSize NUMERIC(9,2),
		@GastrostomyInsertionUnits TINYINT,
		@GastrostomyInsertionType TINYINT,
		@GastrostomyInsertionBatchNo VARCHAR(100),
		@CorrectPEGPlacement TINYINT,
		@PEGPlacementFailureReason VARCHAR(500),
		@NGNJInsertion BIT,
		@NGNJTubeNostril TINYINT,
		@NGNJTubeLength NUMERIC(9,2),
		@NGNJTubeBridle BIT,
		@NGNJTubeBatch VARCHAR(20),
		@NilByMouth BIT,
		@NilByMouthHrs INT,
		@NilByProc BIT,
		@NilByProcHrs INT,
		@FlangePosition NUMERIC(9,2),
		@AttachmentToWard BIT,
		@GastrostomyRemoval BIT,
		@PyloricDilatation BIT,
		@VaricealSclerotherapy BIT,
		@VaricealSclerotherapyInjectionType SMALLINT,
		@VaricealSclerotherapyInjectionVol INT,
		@VaricealSclerotherapyInjectionNum INT,
		@VaricealBanding BIT,
		@VaricealBandingNum INT,
		@VaricealClip BIT,
		@StentInsertion BIT,
		@StentInsertionQty INT,
		@StentInsertionType SMALLINT,
		@StentInsertionLength INT,
		@StentInsertionDiameter INT,
		@StentInsertionDiameterUnits TINYINT,
		@StentInsertionBatchNo VARCHAR(100),
		@CorrectStentPlacement TINYINT,
		@StentPlacementFailureReason VARCHAR(500),
		@StentRemoval BIT,
		@StentRemovalTechnique INT,
		@EMR BIT,
		@EMRType TINYINT,
		@EMRFluid INT,
		@EMRFluidVolume INT,
		@RFA BIT,
		@RFAType TINYINT,
		@RFATreatmentFrom INT,
		@RFATreatmentTo INT,
		@RFAEnergyDel INT,
		@RFANumSegTreated INT,
		@RFANumTimesSegTreated INT,
		@pHProbeInsert BIT,
		@pHProbeInsertAt INT,
		@pHProbeInsertChk BIT,
		@pHProbeInsertChkTopTo INT,
		@Haemospray BIT,
		@Sigmoidopexy BIT,
		@SigmoidopexyQty SMALLINT,
		@SigmoidopexyMake SMALLINT,
		@SigmoidopexyFluidsDays SMALLINT,
		@SigmoidopexyAntibioticsDays SMALLINT,
		@Marking BIT,
		@MarkedQuantity SMALLINT,
		@TattooLocationDistal BIT,
		@TattooLocationProximal BIT,
		@MarkingType INT,
		@Clip BIT,
		@ClipNum INT,
		@ClipSuccess  INT,
		@Other VARCHAR(1000),
		@EUSProcType SMALLINT,
		@EndoClot BIT,
		@ColonicDecompression BIT,
		@FlatusTubeInsertion BIT,
		@PancolonicDyeSpray BIT,
		@BougieDilation BIT,
		@EndoscopicResection BIT,
		@FineNeedleAspiration BIT,
		@FineNeedleAspirationType TINYINT,
		@FineNeedleBiopsy BIT,
		@Homeostasis BIT,
		@HomeostasisType INT,
		@Diverticulotomy BIT,
		@BicapElectroType INT, -- TFS 3209
		@GastricBalloonInsertion BIT,
		@DilatationPerforation BIT; -- TFS-3833

	IF OBJECT_ID('tempdb..#tmp_UpperGITherapeutics') IS NOT NULL
        DROP TABLE #tmp_UpperGITherapeutics;

	SELECT * INTO #tmp_UpperGITherapeutics 
	FROM dbo.[ERS_UpperGITherapeutics] 
	WHERE (Id = @TherapeuticId OR SiteID = @SiteId)

--## 1) If 'CarriedOutRole=2 (EE)' record is found for a SiteId in [ERS_UpperGITherapeutics] means it has both EE/ER Entries...
	--IF EXISTS(SELECT 'ER' FROM dbo.[ERS_UpperGITherapeutics] WHERE SiteId=@SiteId AND CarriedOutRole=2)
	--	BEGIN
			--PRINT '[ERS_UpperGITherapeutics] has both EE/ER Entries...';
			;WITH eeRecord AS (
				SELECT * FROM #tmp_UpperGITherapeutics WHERE CarriedOutRole = (SELECT MAX(CarriedOutRole) FROM #tmp_UpperGITherapeutics) --## 2 is EE
				--WHERE SiteId=@SiteId AND CarriedOutRole=2
			)
			SELECT
				@None							= (CASE WHEN ISNULL(ER.[None], 0) = 0 THEN EE.[None] ELSE ER.[None] END),
				@YAGLaser						= (CASE WHEN ISNULL(ER.[YAGLaser], 0) = 0 THEN EE.[YAGLaser] ELSE ER.[YAGLaser] END),
				@YAGLaserWatts					= (CASE WHEN ISNULL(ER.[YAGLaserWatts], 0) = 0 THEN EE.[YAGLaserWatts] ELSE ER.[YAGLaserWatts] END),
				@YAGLaserPulses					= (CASE WHEN ISNULL(ER.[YAGLaserPulses], 0) = 0 THEN EE.[YAGLaserPulses] ELSE ER.[YAGLaserPulses] END),
				@YAGLaserSecs					= (CASE WHEN ISNULL(ER.[YAGLaserSecs], 0) = 0 THEN EE.[YAGLaserSecs] ELSE ER.[YAGLaserSecs] END),
				@YAGLaserKJ						= (CASE WHEN ISNULL(ER.[YAGLaserKJ], 0) = 0 THEN EE.[YAGLaserKJ] ELSE ER.[YAGLaserKJ] END),
				@ArgonBeamDiathermy				= (CASE WHEN ISNULL(ER.[ArgonBeamDiathermy], 0) = 0 THEN EE.[ArgonBeamDiathermy] ELSE ER.[ArgonBeamDiathermy] END),
				@ArgonBeamDiathermyWatts		= (CASE WHEN ISNULL(ER.[ArgonBeamDiathermyWatts], 0) = 0 THEN EE.[ArgonBeamDiathermyWatts] ELSE ER.[ArgonBeamDiathermyWatts] END),
				@ArgonBeamDiathermyPulses		= (CASE WHEN ISNULL(ER.[ArgonBeamDiathermyPulses], 0) = 0 THEN EE.[ArgonBeamDiathermyPulses] ELSE ER.[ArgonBeamDiathermyPulses] END),
				@ArgonBeamDiathermySecs			= (CASE WHEN ISNULL(ER.[ArgonBeamDiathermySecs], 0) = 0 THEN EE.[ArgonBeamDiathermySecs] ELSE ER.[ArgonBeamDiathermySecs] END),
				@ArgonBeamDiathermyKJ			= (CASE WHEN ISNULL(ER.[ArgonBeamDiathermyKJ], 0) = 0 THEN EE.[ArgonBeamDiathermyKJ] ELSE ER.[ArgonBeamDiathermyKJ] END),
				@BalloonDilation				= (CASE WHEN ISNULL(ER.[BalloonDilation], 0) = 0 THEN EE.[BalloonDilation] ELSE ER.[BalloonDilation] END),
				--added by mostafiz tsf:2743
				@BalloonDilationType			= (CASE WHEN IsNull(ER.[BalloonDilationType], 0) = 0 THEN EE.[BalloonDilationType] ELSE ER.[BalloonDilationType] END),
				@BalloonDilationDiameter		= (CASE WHEN IsNull(ER.[BalloonDilationDiameter], 0) = 0 THEN EE.[BalloonDilationDiameter] ELSE ER.[BalloonDilationDiameter] END),
				@BalloonDilationDiameterUnits	= (CASE WHEN IsNull(ER.[BalloonDilationDiameterUnits], 0) = 0 THEN EE.[BalloonDilationDiameterUnits] ELSE ER.[BalloonDilationDiameterUnits] END),
				--added by mostafiz tsf:2743
				@BandLigation					= (CASE WHEN ISNULL(ER.[BandLigation], 0) = 0 THEN EE.[BandLigation] ELSE ER.[BandLigation] END),
				@BandLigationPerformed			= (CASE WHEN ISNULL(ER.[BandLigationPerformed], 0) = 0 THEN EE.[BandLigationPerformed] ELSE ER.[BandLigationPerformed] END),
				@BandLigationSuccess			= (CASE WHEN ISNULL(ER.[BandLigationSuccessful], 0) = 0 THEN EE.[BandLigationSuccessful] ELSE ER.[BandLigationSuccessful] END),
				@BotoxInjection					= (CASE WHEN ISNULL(ER.[BotoxInjection], 0) = 0 THEN EE.[BotoxInjection] ELSE ER.[BotoxInjection] END),
				@EndoloopPlacement				= (CASE WHEN ISNULL(ER.[EndoloopPlacement], 0) = 0 THEN EE.[EndoloopPlacement] ELSE ER.[EndoloopPlacement] END),
				@HeatProbe						= (CASE WHEN ISNULL(ER.[HeatProbe], 0) = 0 THEN EE.[HeatProbe] ELSE ER.[HeatProbe] END),
				@BicapElectro					= (CASE WHEN ISNULL(ER.[BicapElectro], 0) = 0 THEN EE.[BicapElectro] ELSE ER.[BicapElectro] END),
				@Diathermy						= (CASE WHEN ISNULL(ER.[Diathermy], 0) = 0 THEN EE.[Diathermy] ELSE ER.[Diathermy] END),
				@DiathermyWatt					= (CASE WHEN ISNULL(ER.[DiathermyWatt], 0) = 0 THEN EE.[DiathermyWatt] ELSE ER.[DiathermyWatt] END),  
				@Coil							= (CASE WHEN ISNULL(ER.[Coil], 0) = 0 THEN EE.[Coil] ELSE ER.[Coil] END),
				@CoilQty						= (CASE WHEN ISNULL(ER.[CoilQty], 0) = 0 THEN EE.[CoilQty] ELSE ER.[CoilQty] END),
				@CoilType						= (CASE WHEN ISNULL(ER.[CoilType], 0) = 0 THEN EE.[CoilType] ELSE ER.[CoilType] END),
				@Valve							= (CASE WHEN ISNULL(ER.[Valve], 0) = 0 THEN EE.[Valve] ELSE ER.[Valve] END),
				@ValveQty						= (CASE WHEN ISNULL(ER.[ValveQty], 0) = 0 THEN EE.[ValveQty] ELSE ER.[ValveQty] END),
				@ValveType						= (CASE WHEN ISNULL(ER.[ValveType], 0) = 0 THEN EE.[ValveType] ELSE ER.[ValveType] END),
				@Cryotherapy					= (CASE WHEN ISNULL(ER.[Cryotherapy], 0) = 0 THEN EE.[Cryotherapy] ELSE ER.[Cryotherapy] END),
				@PhotoDynamicTherapy			= (CASE WHEN ISNULL(ER.[PhotoDynamicTherapy], 0) = 0 THEN EE.[PhotoDynamicTherapy] ELSE ER.[PhotoDynamicTherapy] END),
				@ForeignBody					= (CASE WHEN ISNULL(ER.[ForeignBody], 0) = 0 THEN EE.[ForeignBody] ELSE ER.[ForeignBody] END),
				@HotBiopsy						= (CASE WHEN ISNULL(ER.[HotBiopsy], 0) = 0 THEN EE.[HotBiopsy] ELSE ER.[HotBiopsy] END),
				@Injection						= (CASE WHEN ISNULL(ER.[Injection], 0) = 0 THEN EE.[Injection] ELSE ER.[Injection] END),
				@InjectionType					= (CASE WHEN ISNULL(ER.[InjectionType], 0) = 0 THEN EE.[InjectionType] ELSE ER.[InjectionType] END),
				@InjectionVolume				= (CASE WHEN ISNULL(ER.[InjectionVolume], 0) = 0 THEN EE.[InjectionVolume] ELSE ER.[InjectionVolume] END),
				@InjectionNumber				= (CASE WHEN ISNULL(ER.[InjectionNumber], 0) = 0 THEN EE.[InjectionNumber] ELSE ER.[InjectionNumber] END),
				@OesophagealDilatation			= (CASE WHEN ISNULL(ER.[OesophagealDilatation], 0) = 0 THEN EE.[OesophagealDilatation] ELSE ER.[OesophagealDilatation] END),
				@DilatedTo						= (CASE WHEN ISNULL(ER.[DilatedTo], 0) = 0 THEN EE.[DilatedTo] ELSE ER.[DilatedTo] END),
				@DilatationUnits				= (CASE WHEN ISNULL(ER.[DilatationUnits], 0) = 0 THEN EE.[DilatationUnits] ELSE ER.[DilatationUnits] END),
				@DilatorType					= (CASE WHEN ISNULL(ER.[DilatorType], 0) = 0 THEN EE.[DilatorType] ELSE ER.[DilatorType] END),
				@DilatorScopePass				= (CASE WHEN ISNULL(ER.[DilatorScopePass], 0) = 0 THEN EE.[DilatorScopePass] ELSE ER.[DilatorScopePass] END),
				@OesoDilNilByMouth				= (CASE WHEN ISNULL(ER.[OesoDilNilByMouth], 0) = 0 THEN EE.[OesoDilNilByMouth] ELSE ER.[OesoDilNilByMouth] END),
				@OesoDilNilByMouthHrs			= (CASE WHEN ISNULL(ER.[OesoDilNilByMouthHrs], 0) = 0 THEN EE.[OesoDilNilByMouthHrs] ELSE ER.[OesoDilNilByMouthHrs] END),
				@OesoDilXRay					= (CASE WHEN ISNULL(ER.[OesoDilXRay], 0) = 0 THEN EE.[OesoDilXRay] ELSE ER.[OesoDilXRay] END),
				@OesoDilXRayHrs					= (CASE WHEN ISNULL(ER.[OesoDilXRayHrs], 0) = 0 THEN EE.[OesoDilXRayHrs] ELSE ER.[OesoDilXRayHrs] END),
				@OesoDilSoftDiet				= (CASE WHEN ISNULL(ER.[OesoDilSoftDiet], 0) = 0 THEN EE.[OesoDilSoftDiet] ELSE ER.[OesoDilSoftDiet] END),
				@OesoDilSoftDietDays			= (CASE WHEN ISNULL(ER.[OesoDilSoftDietDays], 0) = 0 THEN EE.[OesoDilSoftDietDays] ELSE ER.[OesoDilSoftDietDays] END),
				@OesoDilWarmFluids				= (CASE WHEN ISNULL(ER.[OesoDilWarmFluids], 0) = 0 THEN EE.[OesoDilWarmFluids] ELSE ER.[OesoDilWarmFluids] END),
				@OesoDilWarmFluidsHrs			= (CASE WHEN ISNULL(ER.[OesoDilWarmFluidsHrs], 0) = 0 THEN EE.[OesoDilWarmFluidsHrs] ELSE ER.[OesoDilWarmFluidsHrs] END),
				@OesoDilMedicalReview			= (CASE WHEN ISNULL(ER.[OesoDilMedicalReview], 0) = 0 THEN EE.[OesoDilMedicalReview] ELSE ER.[OesoDilMedicalReview] END),
				@OesoYAGNilByMouth				= (CASE WHEN IsNull(ER.[OesoYAGNilByMouth], 0) = 0 THEN EE.[OesoYAGNilByMouth] ELSE ER.[OesoYAGNilByMouth] END),
				@OesoYAGNilByMouthHrs			= (CASE WHEN IsNull(ER.[OesoYAGNilByMouthHrs], 0) = 0 THEN EE.[OesoYAGNilByMouthHrs] ELSE ER.[OesoYAGNilByMouthHrs] END),
				@OesoYAGWarmFluids				= (CASE WHEN IsNull(ER.[OesoYAGWarmFluids], 0) = 0 THEN EE.[OesoYAGWarmFluids] ELSE ER.[OesoYAGWarmFluids] END),
				@OesoYAGWarmFluidsHrs			= (CASE WHEN IsNull(ER.[OesoYAGWarmFluidsHrs], 0) = 0 THEN EE.[OesoYAGWarmFluidsHrs] ELSE ER.[OesoYAGWarmFluidsHrs] END),
				@OesoYAGSoftDiet				= (CASE WHEN IsNull(ER.[OesoYAGSoftDiet], 0) = 0 THEN EE.[OesoYAGSoftDiet] ELSE ER.[OesoYAGSoftDiet] END),
				@OesoYAGSoftDietDays			= (CASE WHEN IsNull(ER.[OesoYAGSoftDietDays], 0) = 0 THEN EE.[OesoYAGSoftDietDays] ELSE ER.[OesoYAGSoftDietDays] END),
				@OesoYAGMedicalReview			= (CASE WHEN IsNull(ER.[OesoYAGMedicalReview], 0) = 0 THEN EE.[OesoYAGMedicalReview] ELSE ER.[OesoYAGMedicalReview] END),
				@Polypectomy					= (CASE WHEN IsNull(ER.[Polypectomy], 0) = 0 THEN EE.[Polypectomy] ELSE ER.[Polypectomy] END),
				@PolypectomyRemoval				= (CASE WHEN IsNull(ER.[PolypectomyRemoval], 0) = 0 THEN EE.[PolypectomyRemoval] ELSE ER.[PolypectomyRemoval] END),
				@PolypectomyRemovalType			= (CASE WHEN IsNull(ER.[PolypectomyRemovalType], 0) = 0 THEN EE.[PolypectomyRemovalType] ELSE ER.[PolypectomyRemovalType] END),
				@BandingPiles					= (CASE WHEN IsNull(ER.BandingPiles, 0) = 0 THEN EE.BandingPiles ELSE ER.BandingPiles END),
				@BandingNum						= (CASE WHEN IsNull(ER.BandingNum, 0) = 0 THEN EE.BandingNum ELSE ER.BandingNum END),
				@GastrostomyInsertion			= (CASE WHEN IsNull(ER.[GastrostomyInsertion], 0) = 0 THEN EE.[GastrostomyInsertion] ELSE ER.[GastrostomyInsertion] END),
				@GastrostomyInsertionSize		= (CASE WHEN IsNull(ER.[GastrostomyInsertionSize], 0) = 0 THEN EE.[GastrostomyInsertionSize] ELSE ER.[GastrostomyInsertionSize] END),
				@GastrostomyInsertionUnits		= (CASE WHEN IsNull(ER.[GastrostomyInsertionUnits], 0) = 0 THEN EE.[GastrostomyInsertionUnits] ELSE ER.[GastrostomyInsertionUnits] END),
				@GastrostomyInsertionType		= (CASE WHEN IsNull(ER.[GastrostomyInsertionType], 0) = 0 THEN EE.[GastrostomyInsertionType] ELSE ER.[GastrostomyInsertionType] END),
				@GastrostomyInsertionBatchNo	= (SELECT isnull((CASE WHEN IsNull(ER.[GastrostomyInsertionBatchNo], '') = '' THEN EE.[GastrostomyInsertionBatchNo] ELSE ER.[GastrostomyInsertionBatchNo] END), '') as [text()] FOR XML PATH('')),
				@CorrectPEGPlacement			= (CASE WHEN IsNull(ER.[CorrectPEGPlacement], 0) = 0 THEN EE.[CorrectPEGPlacement] ELSE ER.[CorrectPEGPlacement] END),
				@PEGPlacementFailureReason		= (SELECT isnull((CASE WHEN IsNull(ER.[PEGPlacementFailureReason], '') = '' THEN EE.[PEGPlacementFailureReason] ELSE ER.[PEGPlacementFailureReason] END), '') as [text()] FOR XML PATH('')),
				@NGNJInsertion 					= (CASE WHEN IsNull(ER.NGNJTubeInsertion, 0) = 0 THEN EE.NGNJTubeInsertion ELSE ER.NGNJTubeInsertion END),
				@NGNJTubeNostril				= (CASE WHEN IsNull(ER.NGNJTubeNostril, 0) = 0 THEN EE.NGNJTubeNostril ELSE ER.NGNJTubeNostril END),
				@NGNJTubeLength					= (CASE WHEN IsNull(ER.NGNJTubeLength, 0) = 0 THEN EE.NGNJTubeLength ELSE ER.NGNJTubeLength END),
				@NGNJTubeBridle					= (CASE WHEN IsNull(ER.NGNJTubeBridle, 0) = 0 THEN EE.NGNJTubeBridle ELSE ER.NGNJTubeBridle END),
				@NGNJTubeBatch					= (CASE WHEN IsNull(ER.NGNJTubeBatch, '') = '' THEN EE.NGNJTubeBatch ELSE ER.NGNJTubeBatch END),
				@NilByMouth						= (CASE WHEN IsNull(ER.[NilByMouth], 0) = 0 THEN EE.[NilByMouth] ELSE ER.[NilByMouth] END),
				@NilByMouthHrs					= (CASE WHEN IsNull(ER.[NilByMouthHrs], 0) = 0 THEN EE.[NilByMouthHrs] ELSE ER.[NilByMouthHrs] END),
				@NilByProc						= (CASE WHEN IsNull(ER.[NilByProc], 0) = 0 THEN EE.[NilByProc] ELSE ER.[NilByProc] END),
				@NilByProcHrs					= (CASE WHEN IsNull(ER.[NilByProcHrs], 0) = 0 THEN EE.[NilByProcHrs] ELSE ER.[NilByProcHrs] END),
				@FlangePosition					= (CASE WHEN IsNull(ER.[FlangePosition], 0) = 0 THEN EE.[FlangePosition] ELSE ER.[FlangePosition] END),
				@AttachmentToWard				= (CASE WHEN IsNull(ER.[AttachmentToWard], 0) = 0 THEN EE.[AttachmentToWard] ELSE ER.[AttachmentToWard] END),
				@GastrostomyRemoval				= (CASE WHEN IsNull(ER.[GastrostomyRemoval], 0) = 0 THEN EE.[GastrostomyRemoval] ELSE ER.[GastrostomyRemoval] END),
				@PyloricDilatation				= (CASE WHEN IsNull(ER.[PyloricDilatation], 0) = 0 THEN EE.[PyloricDilatation] ELSE ER.[PyloricDilatation] END),
				@VaricealSclerotherapy			= (CASE WHEN IsNull(ER.[VaricealSclerotherapy], 0) = 0 THEN EE.[VaricealSclerotherapy] ELSE ER.[VaricealSclerotherapy] END),
				@VaricealSclerotherapyInjectionType = (CASE WHEN IsNull(ER.[VaricealSclerotherapyInjectionType], 0) = 0 THEN EE.[VaricealSclerotherapyInjectionType] ELSE ER.[VaricealSclerotherapyInjectionType] END),
				@VaricealSclerotherapyInjectionVol  = (CASE WHEN IsNull(ER.[VaricealSclerotherapyInjectionVol], 0) = 0 THEN EE.[VaricealSclerotherapyInjectionVol] ELSE ER.[VaricealSclerotherapyInjectionVol] END),
				@VaricealSclerotherapyInjectionNum  = (CASE WHEN IsNull(ER.[VaricealSclerotherapyInjectionNum], 0) = 0 THEN EE.[VaricealSclerotherapyInjectionNum] ELSE ER.[VaricealSclerotherapyInjectionNum] END),
				@VaricealBanding				= (CASE WHEN IsNull(ER.[VaricealBanding], 0) = 0 THEN EE.[VaricealBanding] ELSE ER.[VaricealBanding] END),
				@VaricealBandingNum				= (CASE WHEN IsNull(ER.[VaricealBandingNum], 0) = 0 THEN EE.[VaricealBandingNum] ELSE ER.[VaricealBandingNum] END),
				@VaricealClip					= (CASE WHEN IsNull(ER.[VaricealClip], 0) = 0 THEN EE.[VaricealClip] ELSE ER.[VaricealClip] END),
				@StentInsertion					= (CASE WHEN IsNull(ER.[StentInsertion], 0) = 0 THEN EE.[StentInsertion] ELSE ER.[StentInsertion] END),
				@StentInsertionQty				= (CASE WHEN IsNull(ER.[StentInsertionQty], 0) = 0 THEN EE.[StentInsertionQty] ELSE ER.[StentInsertionQty] END),
				@StentInsertionType				= (CASE WHEN IsNull(ER.[StentInsertionType], 0) = 0 THEN EE.[StentInsertionType] ELSE ER.[StentInsertionType] END),
				@StentInsertionLength			= (CASE WHEN IsNull(ER.[StentInsertionLength], 0) = 0 THEN EE.[StentInsertionLength] ELSE ER.[StentInsertionLength] END),
				@StentInsertionDiameter			= (CASE WHEN IsNull(ER.[StentInsertionDiameter], 0) = 0 THEN EE.[StentInsertionDiameter] ELSE ER.[StentInsertionDiameter] END),
				@StentInsertionDiameterUnits	= (CASE WHEN IsNull(ER.[StentInsertionDiameterUnits], 0) = 0 THEN EE.[StentInsertionDiameterUnits] ELSE ER.[StentInsertionDiameterUnits] END),
				@StentInsertionBatchNo			= (CASE WHEN IsNull(ER.[StentInsertionBatchNo], '') = '' THEN EE.[StentInsertionBatchNo] ELSE ER.[StentInsertionBatchNo] END),
				@CorrectStentPlacement			= (CASE WHEN IsNull(ER.[CorrectStentPlacement], 0) = 0 THEN EE.[CorrectStentPlacement] ELSE ER.[CorrectStentPlacement] END),
				@StentPlacementFailureReason	= (SELECT isnull((CASE WHEN IsNull(ER.[StentPlacementFailureReason], '') = '' THEN EE.[StentPlacementFailureReason] ELSE ER.[StentPlacementFailureReason] END), '') as [text()] FOR XML PATH('')),
				@StentRemoval					= (CASE WHEN IsNull(ER.[StentRemoval], 0) = 0 THEN EE.[StentRemoval] ELSE ER.[StentRemoval] END),
				@StentRemovalTechnique			= (CASE WHEN IsNull(ER.[StentRemovalTechnique], 0) = 0 THEN EE.[StentRemovalTechnique] ELSE ER.[StentRemovalTechnique] END),
				@EMR							= (CASE WHEN IsNull(ER.[EMR], 0) = 0 THEN EE.[EMR] ELSE ER.[EMR] END),
				@EMRType						= (CASE WHEN IsNull(ER.[EMRType], 0) = 0 THEN EE.[EMRType] ELSE ER.[EMRType] END),
				@EMRFluid						= (CASE WHEN IsNull(ER.[EMRFluid], 0) = 0 THEN EE.[EMRFluid] ELSE ER.[EMRFluid] END),
				@EMRFluidVolume					= (CASE WHEN IsNull(ER.[EMRFluidVolume], 0) = 0 THEN EE.[EMRFluidVolume] ELSE ER.[EMRFluidVolume] END),
				@RFA							= (CASE WHEN IsNull(ER.[RFA], 0) = 0 THEN EE.[RFA] ELSE ER.[RFA] END),
				@RFAType						= (CASE WHEN IsNull(ER.[RFAType], 0) = 0 THEN EE.[RFAType] ELSE ER.[RFAType] END),
				@RFATreatmentFrom				= (CASE WHEN IsNull(ER.[RFATreatmentFrom], 0) = 0 THEN EE.[RFATreatmentFrom] ELSE ER.[RFATreatmentFrom] END),				
				@RFATreatmentTo					= (CASE WHEN IsNull(ER.[RFATreatmentTo], 0) = 0 THEN EE.[RFATreatmentTo] ELSE ER.[RFATreatmentTo] END),				
				@RFAEnergyDel					= (CASE WHEN IsNull(ER.[RFAEnergyDel], 0) = 0 THEN EE.[RFAEnergyDel] ELSE ER.[RFAEnergyDel] END),
				@RFANumSegTreated				= (CASE WHEN IsNull(ER.[RFANumSegTreated], 0) = 0 THEN EE.[RFANumSegTreated] ELSE ER.[RFANumSegTreated] END),
				@RFANumTimesSegTreated			= (CASE WHEN IsNull(ER.[RFANumTimesSegTreated], 0) = 0 THEN EE.[RFANumTimesSegTreated] ELSE ER.[RFANumTimesSegTreated] END),
				@pHProbeInsert					= (CASE WHEN IsNull(ER.[pHProbeInsert], 0) = 0 THEN EE.[pHProbeInsert] ELSE ER.[pHProbeInsert] END),
				@pHProbeInsertAt				= (CASE WHEN IsNull(ER.[pHProbeInsertAt], 0) = 0 THEN EE.[pHProbeInsertAt] ELSE ER.[pHProbeInsertAt] END),
				@pHProbeInsertChk				= (CASE WHEN IsNull(ER.[pHProbeInsertChk], 0) = 0 THEN EE.[pHProbeInsertChk] ELSE ER.[pHProbeInsertChk] END),
				@pHProbeInsertChkTopTo			= (CASE WHEN IsNull(ER.[pHProbeInsertChkTopTo], 0) = 0 THEN EE.[pHProbeInsertChkTopTo] ELSE ER.[pHProbeInsertChkTopTo] END),
				@Haemospray						= (CASE WHEN IsNull(ER.[Haemospray], 0) = 0 THEN EE.[Haemospray] ELSE ER.[Haemospray] END),
				@Sigmoidopexy					= (CASE WHEN IsNull(ER.[Sigmoidopexy], 0) = 0 THEN EE.[Sigmoidopexy] ELSE ER.[Sigmoidopexy] END),
				@SigmoidopexyQty				= (CASE WHEN IsNull(ER.[SigmoidopexyQty], 0) = 0 THEN EE.[SigmoidopexyQty] ELSE ER.[SigmoidopexyQty] END),
				@SigmoidopexyMake				= (CASE WHEN IsNull(ER.[SigmoidopexyMake], 0) = 0 THEN EE.[SigmoidopexyMake] ELSE ER.[SigmoidopexyMake] END),
				@SigmoidopexyFluidsDays			= (CASE WHEN IsNull(ER.[SigmoidopexyFluidsDays], 0) = 0 THEN EE.[SigmoidopexyFluidsDays] ELSE ER.[SigmoidopexyFluidsDays] END),
				@SigmoidopexyAntibioticsDays	= (CASE WHEN IsNull(ER.[SigmoidopexyAntibioticsDays], 0) = 0 THEN EE.[SigmoidopexyAntibioticsDays] ELSE ER.[SigmoidopexyAntibioticsDays] END),
				@Marking						= (CASE WHEN IsNull(ER.[Marking], 0) = 0 THEN EE.[Marking] ELSE ER.[Marking] END),
				--MH added on 19 Oct 2021
				--MH added on 19 Oct 2021 - later changed on 26 Nov 2021
				@TattooLocationDistal      = (CASE WHEN IsNull(ER.[TattooLocationDistal], 0) = 0 THEN EE.[TattooLocationDistal] ELSE ER.[TattooLocationDistal] END), 
				@TattooLocationProximal      = (CASE WHEN IsNull(ER.[TattooLocationProximal], 0) = 0 THEN EE.[TattooLocationProximal] ELSE ER.[TattooLocationProximal] END), 

				--MH added on 20 Oct 2021
				@MarkedQuantity    = (CASE WHEN IsNull(ER.[MarkedQuantity], 0) = 0 THEN EE.[MarkedQuantity] ELSE ER.[MarkedQuantity] END), 

				@MarkingType					= (CASE WHEN IsNull(ER.[MarkingType], 0) = 0 THEN EE.[MarkingType] ELSE ER.[MarkingType] END),
				@Clip							= (CASE WHEN IsNull(ER.[Clip], 0) = 0 THEN EE.[Clip] ELSE ER.[Clip] END),
				@ClipNum						= (CASE WHEN IsNull(ER.[ClipNum], 0) = 0 THEN EE.[ClipNum] ELSE ER.[ClipNum] END),
				@ClipSuccess                    = (CASE WHEN ISNULL(ER.ClipNumSuccess, 0) = 0 THEN EE.ClipNumSuccess ELSE ER.ClipNumSuccess END),
				@Other							= (SELECT isnull((CASE WHEN IsNull(ER.[Other], '') = '' THEN EE.[Other] ELSE ER.[Other] END), '') as [text()] FOR XML PATH('')),
				@EUSProcType					= (CASE WHEN IsNull(ER.[EUSProcType], 0) = 0 THEN EE.[EUSProcType] ELSE ER.[EUSProcType] END),
				@EndoClot						= (CASE WHEN IsNull(ER.[EndoClot], 0) = 0 THEN EE.[EndoClot] ELSE ER.[EndoClot] END),
				@ColonicDecompression			= (CASE WHEN IsNull(ER.[ColonicDecompression], 0) = 0 THEN EE.[ColonicDecompression] ELSE ER.[ColonicDecompression] END),
				@FlatusTubeInsertion			= (CASE WHEN IsNull(ER.[FlatusTubeInsertion], 0) = 0 THEN EE.[FlatusTubeInsertion] ELSE ER.[FlatusTubeInsertion] END),
				@PancolonicDyeSpray				= (CASE WHEN IsNull(ER.[PancolonicDyeSpray], 0) = 0 THEN EE.[PancolonicDyeSpray] ELSE ER.[PancolonicDyeSpray] END),
				@BougieDilation					= (CASE WHEN IsNull(ER.[BougieDilation], 0) = 0 THEN EE.[BougieDilation] ELSE ER.[BougieDilation] END),
				@EndoscopicResection			= (CASE WHEN IsNull(ER.[EndoscopicResection], 0) = 0 THEN EE.[EndoscopicResection] ELSE ER.[EndoscopicResection] END),
				@FineNeedleAspiration		    = (CASE WHEN IsNull(ER.FineNeedleAspiration, 0) = 0 THEN EE.FineNeedleAspiration ELSE ER.FineNeedleAspiration END),
				@FineNeedleAspirationType	    = (CASE WHEN IsNull(ER.FineNeedleAspirationType, 0) = 0 THEN EE.FineNeedleAspirationType ELSE ER.FineNeedleAspirationType END),
				@FineNeedleBiopsy			    = (CASE WHEN IsNull(ER.FineNeedleBiopsy, 0) = 0 THEN EE.FineNeedleBiopsy ELSE ER.FineNeedleBiopsy END),
				@Homeostasis					= (CASE WHEN ISNULL(ER.[Homeostasis], 0) = 0 THEN EE.[Homeostasis] ELSE ER.[Homeostasis] END),
				@HomeostasisType				= (CASE WHEN ISNULL(ER.[HomeostasisType], 0) = 0 THEN EE.[HomeostasisType] ELSE ER.[HomeostasisType] END),
				@Diverticulotomy				= (CASE WHEN ISNULL(ER.[Diverticulotomy], 0) = 0 THEN EE.[Diverticulotomy] ELSE ER.[Diverticulotomy] END),
				@GastricBalloonInsertion		= ISNULL(EE.[GastricBalloonInsertion], 0),
				@BicapElectroType			= (CASE WHEN ISNULL(ER.[BicapElectroType], 0) = 0 THEN EE.[BicapElectroType] ELSE ER.[BicapElectroType] END), -- TFS 3209
				@DilatationPerforation		= ISNULL(ER.DilatationPerforation, 0) -- TFS-3833
			FROM eeRecord AS EE
	  INNER JOIN #tmp_UpperGITherapeutics AS ER ON EE.SiteId = ER.SiteId

	 
	 
	SELECT @Area = m.Area FROM dbo.ERS_AbnormalitiesMatrixUpperGI m LEFT JOIN dbo.ERS_Regions r ON m.Region = r.Region LEFT JOIN dbo.ERS_Sites s ON r.RegionId  = s.RegionID  WHERE s.siteId = @SiteId;
	
	IF @None = 1
		SET @summary = @summary + 'No therapeutic procedures'
	ELSE
	BEGIN

	
------------------------------------------------------------------------------------------------------------------------
-- TFS#	No TFS - Item 4072
-- clip added
------------------------------------------------------------------------------------------------------------------------

	   IF @Clip = 1
			BEGIN
			SET @msg =' Clip :'

			IF @ClipNum > 0 SET @msg = @msg + ' performed ' + CAST(@ClipNum AS VARCHAR(100)) + CASE WHEN @ClipNum = 1 THEN ' procedure' ELSE ' procedures' END
			IF @ClipNum > 0 AND @ClipSuccess > 0 SET @msg = @msg + ' and ' + CAST(@ClipSuccess AS VARCHAR(100)) + CASE WHEN @ClipNum = 1 THEN ' was successful.' ELSE ' were successful.' END 
				ELSE IF @ClipNum = 0 AND @ClipSuccess > 0 SET @msg = @msg + ' ' + CAST(@ClipSuccess AS VARCHAR(100)) + CASE WHEN @ClipNum = 1 THEN ' procedure was successful.' ELSE ' procedures were successful.' END 
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			SET @summary = @summary + @msg + @br	
	    	END
------------------------------------------------------------------------------------------------------------------------
-- END TFS#	No TFS - Item 4072
------------------------------------------------------------------------------------------------------------------------
		IF @YAGLaser = 1
			BEGIN
			SET @msg =' YAG Laser'
			SET @Details = ''
			IF @YAGLaserWatts > 0 SET @Details = @Details + ' ' + CAST(@YAGLaserWatts as varchar(50)) + 'W'
			IF @YAGLaserSecs > 0 SET @Details = @Details + ' for ' + cast(CAST(@YAGLaserSecs AS FLOAT) as varchar(50)) + CASE WHEN @YAGLaserSecs <= 1 THEN ' second' else ' seconds' END
			IF @YAGLaserPulses > 0 SET @Details = @Details + ' in ' + cast(@YAGLaserPulses as varchar(50)) + CASE WHEN @YAGLaserPulses <= 1 THEN ' pulse' else ' pulses' END
			IF @YAGLaserKJ > 0 SET @Details = @Details + ' ('+ cast(CAST(@YAGLaserKJ AS FLOAT) as varchar(50)) + 'kJ)'
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg= @msg+'.'
			--------------
			SET @summary = @summary + @msg + @br
			END
		
		IF @ArgonBeamDiathermy= 1
			BEGIN
			SET @msg ='  Argon beam diathermy'
			SET @Details = ''
			IF @ArgonBeamDiathermyWatts > 0 SET @Details = @Details + ' ' + cast(@ArgonBeamDiathermyWatts as varchar(50)) + 'W'
			IF @ArgonBeamDiathermySecs > 0 SET @Details = @Details + ' for ' + cast(CAST(@ArgonBeamDiathermySecs AS FLOAT) as varchar(50)) + CASE WHEN @ArgonBeamDiathermySecs <= 1 THEN ' second' else ' seconds' END
			IF @ArgonBeamDiathermyPulses > 0 SET @Details = @Details + ' in ' + cast(@ArgonBeamDiathermyPulses as varchar(50)) + CASE WHEN @ArgonBeamDiathermyPulses <= 1 THEN ' pulse' else ' pulses' END
			IF @ArgonBeamDiathermyKJ > 0 SET @Details = @Details + ' ('+ cast(CAST(@ArgonBeamDiathermyKJ AS FLOAT) as varchar(50)) + 'kJ)'
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
			END

			
		IF @Injection= 1
			BEGIN
			SET @msg =' Injection therapy'
			SET @Details = ''
			IF @InjectionVolume > 0 SET @Details = @Details + '  ' + cast(@InjectionVolume as varchar(50)) + 'ml'
			IF @InjectionVolume > 0  AND @InjectionType > 0 SET @Details = @Details + ' of'
			IF @InjectionType > 0 SET @Details = @Details + ' ' +   (SELECT [ListItemText] FROM dbo.ERS_Lists WHERE ListDescription = 'Agent Upper GI' AND [ListItemNo] = @InjectionType)
			IF @InjectionVolume> 0  AND @InjectionNumber > 0 SET @Details = @Details + ' via'
			IF @InjectionNumber >0 SET @Details = @Details + ' ' + CASE WHEN @InjectionNumber > 1 THEN cast(@InjectionNumber as varchar(50)) + ' injections' ELSE cast(@InjectionNumber as varchar(50)) + ' injection' END
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
	    IF @Homeostasis = 1
			BEGIN
			SET @msg =' Haemostasis'
			SET @Details = ''
			IF @HomeostasisType > 0 SET @Details = @Details + ' ' +   (SELECT [ListItemText] FROM dbo.ERS_Lists WHERE ListDescription = 'Homeostasis' AND [ListItemNo] = @HomeostasisType)
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
	
		IF @Polypectomy= 1  
			BEGIN
			SET @msg =' Polypectomy'
			SET @Details = ''
			DECLARE @Se bit, @SeExcised int, @Pe bit, @PeExcised int, @Su bit, @SuExcised int, @countExcised int = 0
			SELECT @Se = [Sessile],@SeExcised =[SessileNumExcised], @Pe = [Pedunculated], @PeExcised= [PedunculatedNumExcised], @Su =[Submucosal], @SuExcised = [SubmucosalNumExcised] FROM [ERS_UpperGIAbnoPolyps] WHERE SiteId =@SiteId
			IF @Se =1 AND @SeExcised <> null SET @countExcised= @countExcised + @SeExcised 
			IF  @Pe = 1 AND @PeExcised <> null SET @countExcised= @countExcised + @peExcised
			IF  @Su = 1 AND @suExcised <> null SET @countExcised= @countExcised + @suExcised

			IF @countExcised > 0 SET @Details = @Details + cast(@countExcised as varchar(50)) +' excised '

			IF @PolypectomyRemoval <> 0 OR @PolypectomyRemovalType <> 0
			BEGIN
			SET @Details = @Details + '('
            IF @PolypectomyRemoval = 1 SET @Details = @Details + 'removed entirely ' ELSE IF @PolypectomyRemoval = 2 SET @Details = @Details + 'removed piecemeal '
			IF @PolypectomyRemovalType = 1 SET @Details = @Details + ' using partial snare'
			ELSE IF  @PolypectomyRemovalType = 2 SET @Details = @Details + 'using cold snare'
			ELSE IF  @PolypectomyRemovalType = 3 SET @Details = @Details + 'using hot snare cauterisation'
			ELSE IF  @PolypectomyRemovalType = 4 SET @Details = @Details + 'using hot biopsy'
			ELSE IF  @PolypectomyRemovalType = 5 SET @Details = @Details + 'using cold biopsy'
			ELSE IF  @PolypectomyRemovalType = 6 SET @Details = @Details + 'using hot snare EMR'
			ELSE IF  @PolypectomyRemovalType = 7 SET @Details = @Details + 'using cold snare by EMR'
			SET @Details = @Details + ')'
			END

			If @Details<>'' SET @msg = @msg + ': ' + @Details
				--Add full stop 
				SET @msg = RTrim(LTRIM(@msg))
				IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
				--------------
				SET @summary = @summary + @msg + @br
			exec specimens_ogd_summary_update @SiteId
		END

		IF @BandingPiles= 1
		BEGIN 
			SET @msg = CASE WHEN @BandingNum > 1 THEN ': ' + CAST(@BandingNum as varchar(5)) + ' bands'
							WHEN @BandingNum = 1 THEN ': ' + CAST(@BandingNum as varchar(5)) + ' band'
							ELSE ''
						END
			--Add full stop 
			SET @msg = 'Banding of piles' + RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

	
		IF @Diathermy = 1
		BEGIN
			SET @msg = ' Diathermy'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg 
		--------------  
		if @DiathermyWatt <> 0 Set @msg =   ' ' + @msg + ' ' + cast(@DiathermyWatt as varchar(10)) + ' Watt.'

		SET @summary = @summary + @msg + @br  
		END  

		
		
		IF @Diverticulotomy = 1
			BEGIN
			SET @msg =' Diverticulotomy'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		
		
		IF @GastricBalloonInsertion = 1
			BEGIN
			SET @msg =' Gastric balloon insertion'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
  
	-- ## Valve
	  IF @Valve = 1  
	  BEGIN  
	   SET @msg = 'Valve'  
	   if @ValveQty <> 0 Set @msg2 = ' ' + cast(@ValveQty as varchar(10))
	   if @ValveType <> 0 Set @msg2 = @msg2 + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'BRT Valve Type' AND [ListItemNo] = @ValveType)  
	   Set @msg2 = ltrim(rtrim(@msg2))
	   if @msg2 <> '' Set @msg = @msg2 + ' Valve.' else Set @msg = 'Valve.'

	   SET @summary = @summary + @msg +  @br  
	  END

	  --- ### Cryotherapy and PhotoDynamicTherapy
	  Set @msg = ''
	  set @msg2 = ''
	  if @Cryotherapy = 1 Set @msg2 = 'Cryotherapy'
	  if @PhotoDynamicTherapy = 1 
	  Begin
		if @msg2 <> '' Set @msg = @msg2 + ' and Photodynamic Therapy have been used.' else set @msg = 'Photodynamic Therapy has been used.'
	  end
	  else
	  begin
		if @msg2 <> '' Set @msg = @msg2 + '.' -- TFS# 2430
	  end
	  if @msg <> '' Set @summary = @summary + @msg + @br

		-- ## Coil
		IF @Coil = 1  
		BEGIN  
		SET @msg = 'Coil'  
		if @CoilQty <> 0 Set @msg2 = ' ' + cast(@CoilQty as varchar(10))
		if @CoilType <> 0 Set @msg2 = @msg2 + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'BRT Coil Type' AND [ListItemNo] = @CoilType)  
		Set @msg2 = ltrim(rtrim(@msg2))
		if @msg2 <> '' Set @msg = @msg2 + ' Coil.' else Set @msg = 'Coil.'

			--------------
			SET @summary = @summary + @msg + @br
		END

		-- START TFS 3209
		IF @BicapElectro = 1
		BEGIN
			SET @msg = ' Bicap electrocautery'
			SET @Details = ''
			IF @BicapElectroType >= 0 SET @Details = @Details + ' ' +   (SELECT [ListItemText] FROM dbo.ERS_Lists WHERE ListDescription = 'Bicap Electrocautery' AND [ListItemNo] = @BicapElectroType)
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + '<br/>'
		END
		-- END TFS 3209

		IF @HeatProbe = 1
		BEGIN
			SET @msg = ' Heater probe coagulation'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		--IF @BallDil = 1
		--	BEGIN
		--	SET @msg = ' Balloon dilatation'
		--	--Add full stop 
		--	SET @msg = RTrim(LTRIM(@msg))
		--	IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
		--	--------------
		--	SET @summary = @summary + @msg + @br
		--END
		
		IF @HotBiopsy = 1
		BEGIN
			SET @msg = ' Hot biopsy'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
		IF @BandLigation = 1
		BEGIN			
			SET @msg = ' Band ligation'
			IF @BandLigationPerformed > 0 SET @msg = @msg + ' performed ' + CAST(@BandLigationPerformed AS VARCHAR(100)) + CASE WHEN @BandLigationPerformed = 1 THEN ' procedure' ELSE ' procedures' END
			IF @BandLigationPerformed > 0 AND @BandLigationSuccess > 0 SET @msg = @msg + ' and ' + CAST(@BandLigationSuccess AS VARCHAR(100)) + CASE WHEN @BandLigationPerformed = 1 THEN ' was successful.' ELSE ' were successful.' END 
				ELSE IF @BandLigationPerformed = 0 AND @BandLigationSuccess > 0 SET @msg = @msg + ' ' + CAST(@BandLigationSuccess AS VARCHAR(100)) + CASE WHEN @BandLigationPerformed = 1 THEN ' procedure was successful.' ELSE ' procedures were successful.' END 
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br			
		END

		IF @BalloonDilation = 1
		BEGIN
			SET @msg = ' Balloon Dilation'
			--added by mostafiz tsf:2743
			SET @Details = ''
			
			IF @BalloonDilationType > 0 
				BEGIN
					SET @Details = @Details + ' ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Therapeutic Balloon Dilation Types' AND [ListItemNo] = @BalloonDilationType)
				END	

			IF  @BalloonDilationDiameter > 0 
				BEGIN
					SET @Details = @Details + ' (' 
					--IF @BalloonDilationDiameter > 0 SET @Details = @Details + ', ' 
					SET @Details = @Details + ' diameter ' + cast(@BalloonDilationDiameter as varchar(50))
					IF @BalloonDilationDiameterUnits >= 0 SET @Details = @Details+ ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Balloon dilatation units' AND [ListItemNo] = @BalloonDilationDiameterUnits)
					SET @Details = @Details + ' )' 
				END

			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--added by mostafiz tsf:2743
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
			
			
		END

		IF @BotoxInjection = 1
		BEGIN
			SET @msg = ' Botox injection'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @EndoscopicResection = 1
		BEGIN
			SET @msg = ' Endoscopic resection'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		-------------------------------
        -- FNA
        -------------------------------
		IF @FineNeedleAspiration= 1
		BEGIN
			SET @msg =' FNA'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		-------------------------------
        -- FNB
        -------------------------------
		IF @FineNeedleBiopsy= 1
		BEGIN
			SET @msg =' FNB'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @EndoloopPlacement = 1
		BEGIN
			SET @msg = ' Endoloop placement'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @ForeignBody = 1
		BEGIN
			SET @msg = ' Foreign body removal'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @StentInsertion= 1
			BEGIN
			SET @msg =' Stent insertion'
			SET @Details = ''
			IF @StentInsertionQty > 0 SET @Details = @Details + '  ' + cast(@StentInsertionQty as varchar(50))
			IF @StentInsertionType > 0 
				BEGIN
				IF @Area = 'Oesophagus'	 SET @Details = @Details + ' ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Therapeutic Stent Insertion Types' AND [ListItemNo] = @StentInsertionType)
				ELSE SET @Details = @Details + ' ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Therapeutic Stomach Stent Insertion Types' AND [ListItemNo] = @StentInsertionType)
				END	
			IF @StentInsertionLength > 0 AND @StentInsertionDiameter > 0 
				BEGIN
				SET @Details = @Details + ' (' 
				IF @StentInsertionLength > 0 SET @Details = @Details + ' length ' + cast(@StentInsertionLength as varchar(50)) + 'cm'
				IF @StentInsertionDiameter > 0 SET @Details = @Details + ', ' 
				SET @Details = @Details + ' diameter ' + cast(@StentInsertionDiameter as varchar(50))
				IF @StentInsertionDiameterUnits >= 0 SET @Details = @Details+ ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Oesophageal dilatation units' AND [ListItemNo] = @StentInsertionDiameterUnits)
				SET @Details = @Details + ')' 
				END
			IF @StentInsertionBatchNo <> ''  SET @Details = @Details + ' batch ' + LTRIM(RTRIM(@StentInsertionBatchNo))
			
			If @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @StentRemoval= 1
			BEGIN
			SET @msg =' Stent removal'
			SET @Details = ''
			IF @StentRemovalTechnique > 0  SET @Details = @Details + 'using ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Therapeutic Stent Removal Technique' AND [ListItemNo] = @StentRemovalTechnique)
			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @EMR= 1
			BEGIN
			IF @EMRType = 3
				SET @msg =' Endoscopic full thickness resection'
			ELSE IF @EMRType = 2
				SET @msg =' Endoscopic submucosal dissection'
			ELSE IF @EMRType = 1
				SET @msg =' Endoscopic mucosal resection'
			SET @Details = ''
			IF @EMRFluid > 0  SET @Details = @Details + 'using ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Therapeutic EMR Fluid' AND [ListItemNo] = @EMRFluid)
			IF @EMRFluidVolume >0 
				BEGIN
				IF @EMRFluid >0 SET  @Details = @Details + ', '
				SET  @Details = @Details + 'total volume ' + cast(@emrfluidvolume AS varchar(50)) + 'ml'
				END
			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		
		IF @OesophagealDilatation= 1
			BEGIN
			SET @msg =' Oesophageal dilatation'
			SET @Details = ''
			--Added by rony tfs-4085
			IF @DilatedTo > 0  SET @Details = @Details + ' dilated to ' + cast(CAST(@dilatedto AS FLOAT) as varchar(50)) +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Oesophageal dilatation units' AND [ListItemNo] = @DilatationUnits)
			IF @DilatorType > 0
				BEGIN
				DECLARE @DilatorStr varchar(500) = (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Oesophageal dilator' AND [ListItemNo] = @DilatorType)
				IF @DilatorStr like 'with%' OR @DilatorStr like 'by%'  SET @Details = @Details + ' ' +  @DilatorStr
				ELSE SET @Details = @Details + ' with ' +  @DilatorStr
				END
			IF @DilatorScopePass = 1 
			BEGIN
				SET @Details = @Details + ' (scope could pass)'
			END
			-- TFS-3833 start
			IF @DilatationPerforation = 1
			BEGIN
				SET @dilatationPerforationTxt = 'Complication: perforation'
			END
			ELSE 
				BEGIN
				SET @dilatationPerforationTxt = ''
			END
			-- TFS-3833 End
			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br + @dilatationPerforationTxt -- TFS-3833
		END

		IF @VaricealSclerotherapy= 1
			BEGIN
			SET @msg =' Oesophagus variceal sclerotherapy'
			SET @Details = ''
			IF @VaricealSclerotherapyInjectionVol > 0  SET @Details = @Details + ' ' + cast(@VaricealSclerotherapyInjectionVol as varchar(50)) + 'ml' 
			IF @VaricealSclerotherapyInjectionVol > 0 AND  @VaricealSclerotherapyInjectiontype > 0  SET @Details = @Details + ' of'
			IF @VaricealSclerotherapyInjectiontype > 0 SET @Details = @Details + ' ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Agent Upper GI' AND [ListItemNo] = @VaricealSclerotherapyInjectiontype)
			IF @VaricealSclerotherapyInjectionVol > 0 AND  @VaricealSclerotherapyInjectionNum > 0  SET @Details = @Details + ' via'
			IF @VaricealSclerotherapyInjectionNum > 0 SET @Details = @Details + ' ' + CASE WHEN @VaricealSclerotherapyInjectionNum >1 THEN CAST(@VaricealSclerotherapyInjectionNum as varchar(50))+' injections' ELSE  CAST(@VaricealSclerotherapyInjectionNum as varchar(50))+' injection' END
			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @VaricealBanding= 1
			BEGIN
			IF @Area ='Oesophagus' SET @msg =' Oesophagus variceal banding' ELSE SET @msg =' Gastric variceal banding'
			SET @Details = ''
			IF @VaricealBandingNum > 0 SET @Details = @Details + ' ' + CASE WHEN @VaricealBandingNum >1 THEN CAST(@VaricealBandingNum as varchar(50))+' bands' ELSE  CAST(@VaricealBandingNum as varchar(50)) + ' band' END
			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @RFA = 1
			BEGIN
			SET @msg =' Radio Frequency Ablation'
			SET @Details = ''
			IF @RFAType = 1	SET @Details = @Details + ' circumferential'
			ELSE IF @RFAType = 2 SET @Details = @Details + ' focal'
			IF ISNULL(@RFAEnergyDel,0) <> 0 SET @Details = @Details + ', ' + cast(@RFAEnergyDel as varchar(50)) + ' joules'
			IF ISNULL(@RFANumSegTreated,0) <> 0
				BEGIN
				SET @Details = @Details + ' delivered to ' + cast(@RFANumSegTreated as varchar(50))
				IF @RFAType =1 SET @Details = @Details + ' x 3cm'
				SET @Details = @Details + ' segment'
				IF @RFANumSegTreated > 1 SET @Details = @Details + 's'
				END
			IF ISNULL(@RFANumTimesSegTreated,0)<>0
				BEGIN
				SET @Details = @Details + ', treated '
				If @RFANumTimesSegTreated = 1 SET @Details = @Details + 'once'
				ELSE SET @Details = @Details + cast(@RFANumTimesSegTreated as varchar(50)) + ' times'
				END
			IF ISNULL(@RFATreatmentFrom,0) <>0 OR ISNULL(@RFATreatmentTo,0) <>0
				BEGIN
				IF ISNULL(@RFATreatmentFrom,0) <> 0  SET @Details = @Details + ', starting at ' + cast(@RFATreatmentFrom as varchar(50)) +' cm'
				IF ISNULL(@RFATreatmentTo,0) <> 0 
				BEGIN
				IF ISNULL(@RFATreatmentFrom,0) <> 0 SET @Details = @Details + ' and ending at ' + cast(@RFATreatmentTo as varchar(50)) +' cm'
				ELSE  SET @Details = @Details + ' ending at ' + cast(@RFATreatmentTo as varchar(50)) +' cm'
				END
				SET @Details = @Details + ' from the incisors'
				END				

			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @GastrostomyInsertion =1
			BEGIN
			DECLARE @G bit, @J bit, @N bit
			SELECT @j = i.[JejunostomyInsertion], @G =i.[GastrostomyInsertion],@N = i.[NasoDuodenalTube] FROM [ERS_UpperGIIndications] i LEFT JOIN [ERS_Sites] s ON i.ProcedureId = s.ProcedureId WHERE s.SiteId = @SiteID
			IF @N = 1 SET @msg =' Nasojejunal tube (NJT)' ELSE IF @J= 1 SET @msg =' Jejunostomy insertion (PEJ)' ELSE SET @msg =' Gastrostomy insertion (PEG)'
			SET @Details = ''

			IF @GastrostomyInsertionType > 0
				BEGIN
				IF @GastrostomyInsertionSize>0
					BEGIN
					SET @Details = @Details + cast(@GastrostomyInsertionSize as varchar(50))
					IF @J=1 SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG units' AND [ListItemNo] = @GastrostomyInsertionUnits)
					ELSE IF @N =1 SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG units' AND [ListItemNo] = @GastrostomyInsertionUnits)
					ELSE SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG units' AND [ListItemNo] = @GastrostomyInsertionUnits)
					END
				END
				IF @GastrostomyInsertionType>0
						BEGIN
						IF @J=1 SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG type' AND [ListItemNo] = @GastrostomyInsertiontype)
						ELSE IF @N =1 SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG type' AND [ListItemNo] = @GastrostomyInsertiontype)
						ELSE SET @Details = @Details + ' ' + (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Gastrostomy PEG type' AND [ListItemNo] = @GastrostomyInsertiontype)
						END
				IF ISNULL(@GastrostomyInsertionBatchNo, '') <> ''  SET @Details = @Details + ' batch ' + @GastrostomyInsertionBatchNo
				
				IF @CorrectPEGPlacement = 2 SET @Details = @Details + ' incorrectly placed ' + isnull(@PEGPlacementFailureReason, '')
				    
				
				IF @Details<>'' SET @msg = @msg + ': ' + @Details
				--Add full stop 
				SET @msg = RTrim(LTRIM(@msg))
				IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
				--------------
				SET @summary = @summary + @msg + @br
				END

		IF @GastrostomyRemoval = 1
		BEGIN
			SET @msg =' Gastrostomy PEG Removal'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		IF @PyloricDilatation= 1
		BEGIN
			SET @msg =' Pyloric dilatation'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @NGNJInsertion = 1 
		BEGIN
			Set @msg = ' NG/NJ tube insertion'
			IF isnull(@NGNJTubeBatch, '') <> '' 
				SET @msg = @msg + ' (batch ' + @NGNJTubeBatch + ')'
			IF isnull(@NGNJTubeLength, 0) > 0
			BEGIN
				SET @msg = @msg + '. Tube length ' + convert(varchar, @NGNJTubeLength) + 'cm'
				IF isnull(@NGNJTubeNostril, 0) > 0
				BEGIN
					SELECT @msg = @msg + CASE WHEN @NGNJTubeNostril = 1 THEN ' at the right nostril'
											  WHEN @NGNJTubeNostril = 2 THEN ' at the left nostril'
										 END
				END
			END
			ELSE
			BEGIN
				IF isnull(@NGNJTubeNostril, 0) > 0
				BEGIN
					SELECT @msg = @msg + CASE WHEN @NGNJTubeNostril = 1 THEN ' via the right nostril'
											  WHEN @NGNJTubeNostril = 2 THEN ' via the left nostril'
										 END
				END
			END
			IF isnull(@NGNJTubeBridle, 0) = 1 
				SET @msg = @msg + ', bridle used'

			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @pHProbeInsert= 1
			BEGIN
			SET @msg =' pH probe insertion'
			SET @Details = ''
			IF @pHProbeInsertAt > 0 SET @Details = @Details + ' inserted at ' + CAST(@pHProbeInsertAt as varchar(50))+' cm'
			IF ISNULL(@pHProbeInsertChkTopTo,0) <> 0 
			BEGIN
				IF @Details <> '' SET @Details = @Details + ', '
				SET @Details = @Details + 'endoscopic check performed, top of probe at ' + CAST(@pHProbeInsertChkTopTo as varchar(50))+' cm'
			END
			--ELSE  SET @Details = @Details + ', insertion checked endoscopically'

			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @Haemospray= 1
		BEGIN
			SET @msg =' Haemospray'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @Sigmoidopexy= 1
		BEGIN
			
			SET @msg =' Sigmoidopexy'
			SET @Details = ''
			IF @SigmoidopexyQty > 0 SET @Details = @Details + CONVERT(VARCHAR, @SigmoidopexyQty)
			IF @SigmoidopexyMake > 0 SET @Details = @Details + ' ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Sigmoidopexy make' AND [ListItemNo] = @SigmoidopexyMake)

			IF @Details<>'' SET @msg = @msg + ': ' + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @Marking= 1
		BEGIN
			--MH added on 19 Oct 2021
			Declare @TattoLocationMessage varchar(50)
			Declare @TattoMessage varchar(100)
			declare @MaxId int, @MinId int, @loopCounter int

			Set @TattoLocationMessage = ''
			Set @TattoMessage = ''
			If @TattooLocationDistal > 0 
			Begin
				Set @TattoLocationMessage = 'Distal'
			End

			If @TattooLocationProximal > 0 
			Begin
				if @TattoLocationMessage = ''			
					begin
						Set @TattoLocationMessage = 'Proximal'
					end
				else
					begin
						Set @TattoLocationMessage = @TattoLocationMessage + ',Proximal'
					end		
			End

			Select @MinId = Min(id),@MaxId=Max(id) from fnSplitString(@TattoLocationMessage,',') 
			Set @loopCounter = @MinId
			While @loopCounter < (@MaxId+1)
			begin
				if @loopCounter = 1
				begin
					Set @TattoMessage = (Select Item from fnSplitString(@TattoLocationMessage,',') Where Id = @loopCounter)
				end
				else
				begin
					if @loopCounter <> @MaxId 
					begin
						Set @TattoMessage = @TattoMessage + ', ' + (Select Item from fnSplitString(@TattoLocationMessage,',') Where Id = @loopCounter)
					end
					else
					begin
						Set @TattoMessage = @TattoMessage + ' and ' + (Select Item from fnSplitString(@TattoLocationMessage,',') Where Id = @loopCounter)
					end

				end

				set @loopCounter = @loopCounter + 1
			END

			SET @msg ='Abnormality marked '
			SET @Details = ''			
			IF @MarkingType > 0 SET @Details = ISNULL(@TattoMessage, '') + ' by ' +   (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Abno marking' AND [ListItemNo] = @MarkingType) -- tfs-2970

			IF @Details<>'' SET @msg = @msg + @Details
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br

		END

		  If @MarkedQuantity > 0
		begin
			IF @summary <> '' SET @summary = @summary
			SET @summary = @summary + 'Number of spots marked ' + Convert(varchar(5),@MarkedQuantity) + '.' + @br -- tfs-2970
		end		
		
		IF @EndoClot = 1
		BEGIN 
			SET @msg = 'EndoClot used'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
		IF @ColonicDecompression = 1
		BEGIN 
			SET @msg = 'Colonic decompression'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
		IF @FlatusTubeInsertion = 1
		BEGIN 
			SET @msg = 'Flatus tube insertion'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
		IF @PancolonicDyeSpray = 1
		BEGIN 
			SET @msg = 'Pancolonic dye spray'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END

		IF @BougieDilation = 1
		BEGIN 
			SET @msg = 'Bougie dilation'
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary = @summary + @msg + @br
		END
		
		IF LTRIM(RTRIM(@other)) <> ''
			BEGIN
			SET @msg =' ' + LTRIM(RTRIM(@other))
			--Add full stop 
			SET @msg = RTrim(LTRIM(@msg))
			IF @msg <> ''  AND (@msg NOT LIKE '%.')  SET @msg = @msg + '.'
			--------------
			SET @summary =  @summary + @msg  +@br
		END
		
		--Remove last <br />
		IF RIGHT(RTRIM(@summary),6) = '<br />'
		BEGIN
			SET @summary = RTRIM(@summary)
			SET @summary = LEFT(@summary, LEN(@summary) - 6)
		END

	--END
	
	-- Finally, update the summary in Therapeutics  table
	UPDATE dbo.ERS_UpperGITherapeutics 
	SET Summary=@summary 
	WHERE SiteId = @SiteId -- AND CarriedOutRole=1;	--### Summary text is Applicable only for TrainER....
	--WHERE Id = @TherapeuticId
	
	DECLARE @region VARCHAR(100)
	DECLARE @AreaNo INT
	DECLARE @insertionType VARCHAR(100)
	DECLARE @htmlAnchorCode VARCHAR(500)
	DECLARE @SummaryWithLinks VARCHAR(MAX)

	SELECT @region = CASE WHEN s.SiteNo = -77 THEN						--SiteNo is set to -77 for sites By Distance (Col & Sig only)
						CONVERT(VARCHAR,XCoordinate) +  
							CASE WHEN YCoordinate IS NULL OR YCoordinate=0 THEN ' cm' 
							ELSE (' to ' + CONVERT(VARCHAR,YCoordinate) + ' cm' ) 
							END
					ELSE (SELECT r.Region FROM ERS_Regions r WHERE r.RegionId = s.RegionId)
					END, 
			@AreaNo = ISNULL(AreaNo,0)
	FROM ERS_Sites s
	JOIN ERS_Procedures p ON s.ProcedureId = p.ProcedureId
	WHERE SiteId = @SiteId
	
	SET @htmlAnchorCode = '<a href="#" class="sitesummary" onclick="OpenSiteDetails(''' + @region + ''',' + CONVERT(VARCHAR(10),@SiteId) + ',''Therapeutic Procedures'', ''{0}'' , '''+ CONVERT(VARCHAR,@AreaNo) +  ''');">{1}</a>'

	SET @Summary = ''
	SET @SummaryWithLinks = ''
	DECLARE @SummaryHeading VARCHAR(200) = 'Post procedure patient care'
	
	IF @GastrostomyInsertion = 1
	BEGIN
		SET @insertionType = 'PEG'
		SET @SummaryHeading = 'Instructions for PEG care'
		IF @FlangePosition > 0 SET @Summary = 'Flange at ' + CONVERT(varchar, @FlangePosition) + ' cm.'
		IF @NilByMouth = 1
		BEGIN
			IF @Summary <> '' SET @Summary = @Summary + ' Nil by mouth' ELSE SET @Summary = 'Nil by mouth'
			IF @NilByMouthHrs > 0
			BEGIN
				SET @Summary = @Summary + ' for ' + CONVERT(varchar, @NilByMouthHrs)
				IF @NilByMouthHrs = 1
					SET @Summary = @Summary + ' hour'
				ELSE
					SET @Summary = @Summary + ' hours'
			END
		END
		IF @NilByProc = 1
		BEGIN
			IF @Summary <> '' SET @Summary = @Summary + ', nil by PEG' ELSE SET @Summary = 'Nil by PEG'
			IF @NilByProcHrs > 0
			BEGIN
				SET @Summary = @Summary + ' for ' + CONVERT(varchar, @NilByProcHrs)
				IF @NilByProcHrs = 1
					SET @Summary = @Summary + ' hour'
				ELSE
					SET @Summary = @Summary + ' hours'
			END
		END
		IF @Summary <> '' SET @Summary = @Summary + '.'
		IF @AttachmentToWard = 1
		BEGIN
			IF @Summary <> '' SET @Summary = @Summary + ' All attachments for feeding returned to the ward with patient.' ELSE SET @Summary = 'All attachments for feeding returned to the ward with patient.'
		END		
	END	
	ELSE
	BEGIN	
		IF @YAGLaser = 1
		BEGIN
			SET @insertionType = 'YAG'
			IF @OesoYAGNilByMouth = 1
			BEGIN
				SET @Summary = 'Nil by mouth'
				IF @OesoYAGNilByMouthHrs > 0
				BEGIN
					SET @Summary = @Summary + ' for ' + CONVERT(varchar, @OesoYAGNilByMouthHrs)
					IF @OesoYAGNilByMouthHrs = 1
						SET @Summary = @Summary + ' hour'
					ELSE
						SET @Summary = @Summary + ' hours'
				END
			END

			IF @OesoYAGWarmFluids = 1
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ', warm fluids only' ELSE SET @Summary = 'Warm fluids only'
				IF @OesoYAGWarmFluidsHrs > 0
				BEGIN
					SET @Summary = @Summary + ' for ' + CONVERT(varchar, @OesoYAGWarmFluidsHrs)
					IF @OesoYAGWarmFluidsHrs = 1
						SET @Summary = @Summary + ' hour'
					ELSE
						SET @Summary = @Summary + ' hours'
				END
			END

			IF @OesoYAGSoftDiet = 1
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ', soft diet' ELSE SET @Summary = 'Soft diet'
				IF @OesoYAGSoftDietDays > 0
				BEGIN
					SET @Summary = @Summary + ' for ' + CONVERT(varchar, @OesoYAGSoftDietDays)
					IF @OesoYAGSoftDietDays = 1
						SET @Summary = @Summary + ' day'
					ELSE
						SET @Summary = @Summary + ' days'
				END
			END

			IF @Summary <> '' SET @Summary = @Summary + '.'

			IF @OesoYAGMedicalReview = 1
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ' Medical review before discharge.' ELSE SET @Summary = 'Medical review before discharge.'
			END
		END

		IF @OesophagealDilatation = 1 OR @StentInsertion = 1
		BEGIN
			SET @insertionType = 'STENT'
			IF @OesoDilNilByMouth = 1
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ' Nil by mouth' ELSE SET @Summary = 'Nil by mouth'
				IF @OesoDilNilByMouthHrs > 0
				BEGIN
					SET @Summary = @Summary + ' for ' + CONVERT(varchar, @OesoDilNilByMouthHrs)
					IF @OesoDilNilByMouthHrs = 1
						SET @Summary = @Summary + ' hour'
					ELSE
						SET @Summary = @Summary + ' hours'
				END
			END

			IF @OesoDilWarmFluids = 1
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ', warm fluids only' ELSE SET @Summary = 'Warm fluids only'
				IF @OesoDilWarmFluidsHrs > 0
				BEGIN
					SET @Summary = @Summary + ' for ' + CONVERT(varchar, @OesoDilWarmFluidsHrs)
					IF @OesoDilWarmFluidsHrs = 1
						SET @Summary = @Summary + ' hour'
					ELSE
						SET @Summary = @Summary + ' hours'
				END
			END

			IF @OesoDilSoftDiet = 1
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ', soft diet' ELSE SET @Summary = 'Soft diet'
				IF @OesoDilSoftDietDays > 0
				BEGIN
					SET @Summary = @Summary + ' for ' + CONVERT(varchar, @OesoDilSoftDietDays)
					IF @OesoDilSoftDietDays = 1
						SET @Summary = @Summary + ' day'
					ELSE
						SET @Summary = @Summary + ' days'
				END
			END

			IF @OesoDilXRay = 1
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ', chest X-ray' ELSE SET @Summary = 'Chest X-ray'
				IF @OesoDilXRayHrs > 0
				BEGIN
					SET @Summary = @Summary + ' after ' + CONVERT(varchar, @OesoDilXRayHrs)
					IF @OesoDilXRayHrs = 1
						SET @Summary = @Summary + ' hour'
					ELSE
						SET @Summary = @Summary + ' hours'
				END
			END

			IF @Summary <> '' SET @Summary = @Summary + '.'

			IF @OesoDilMedicalReview = 1
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ' Medical review before discharge.' ELSE SET @Summary = 'Medical review before discharge.'
			END
		END

		IF @Sigmoidopexy= 1
		BEGIN
			SET @SummaryHeading = 'Ward instructions'
			IF ISNULL(@SigmoidopexyFluidsDays,0) > 0
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ' '
				SET @Summary = @Summary + 'Clear fluids for ' + CONVERT(varchar, @SigmoidopexyFluidsDays) 
								+ CASE WHEN @SigmoidopexyFluidsDays > 1 THEN ' days.' else ' day.' END
			END
			IF ISNULL(@SigmoidopexyAntibioticsDays,0) > 0
			BEGIN
				IF @Summary <> '' SET @Summary = @Summary + ' '
				SET @Summary = @Summary + 'Antibiotics for ' + CONVERT(varchar, @SigmoidopexyAntibioticsDays) 
								+ CASE WHEN @SigmoidopexyAntibioticsDays > 1 THEN ' days.' ELSE ' day.' END
			END
		END
	END

	IF @Summary = '' SET @SummaryHeading = ''

	-- Finally, update the summary in PP_InstForCare  table
	UPDATE p
	SET PP_InstForCare = @Summary
		, PP_InstForCareHeading = @SummaryHeading
		, PP_InstForCareWithLinks = REPLACE(REPLACE(@htmlAnchorCode, '{0}', @insertionType), '{1}', @Summary)
	FROM ERS_ProceduresReporting p
	INNER JOIN ERS_Sites s ON p.ProcedureId = s.ProcedureId
	WHERE s.SiteId = @SiteId;

	DROP TABLE #tmp_UpperGITherapeutics;

	DECLARE @ProcedureId INT = (SELECT ProcedureId FROM ERS_Sites WHERE SiteId = @SiteId)
	EXEC ogd_diagnoses_summary_update @ProcedureId
 END


------------------------------------------------------------------------------------------------------------------------
-- TFS#	2743 Ended
------------------------------------------------------------------------------------------------------------------------
GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ahmed 24/06/24
-- TFS#	3774
-- Description of change
-- Normal Cysto
------------------------------------------------------------------------------------------------------------------------
GO
EXEC dbo.DropIfExist 
    @ObjectName = 'abnormalities_cystoscopy_bladder_summary_update', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[abnormalities_cystoscopy_bladder_summary_update]
(
	@SiteId INT,
	@ProcedureId INT
)
AS
	SET NOCOUNT ON

	DECLARE
		@summary VARCHAR(200),
		
		@Normal BIT,
		@Tumor BIT,
		@TumorQuantity INT,
		@TumorSizeofLargest INT,
		@TumorMultiple BIT,
		@TumorFlat BIT,
		@TumorFungating BIT,
		@TumorPapilary BIT,
		@TumorSolid BIT,
		@CystitisCystica BIT,
		@Diverticulum BIT,
		@Fistula BIT,
		@RadiationCystitis BIT,
		@RedPatch BIT,
		@Stones BIT,
		@AbnormalPosition BIT,
		@CoveredWithTumour BIT,
		@ExtraUretericOrifice BIT,
		@Ureterocoele BIT,
		@Region VARCHAR(50)
	SELECT
			@Normal=Normal,
			@Tumor= Tumor,
			@TumorQuantity=TumorQuantity,
			@TumorSizeofLargest=TumorSizeofLargest,
			@TumorMultiple=TumorMultiple,
			@TumorFlat=TumorFlat,
			@TumorFungating=TumorFungating,
			@TumorPapilary=TumorPapilary,
			@TumorSolid=TumorSolid,
			@CystitisCystica=CystitisCystica,
			@Diverticulum=Diverticulum,
			@Fistula=Fistula,
			@RadiationCystitis=RadiationCystitis,
			@RedPatch=RedPatch,
			@Stones=Stones,
			@AbnormalPosition=AbnormalPosition,
			@CoveredWithTumour=CoveredWithTumour,
			@ExtraUretericOrifice=ExtraUretericOrifice,
			@Ureterocoele=Ureterocoele
	
	FROM
		ERS_CystoscopyAbnoBladder
	WHERE
		SiteId = @SiteId

	SELECT @Region = r.Region FROM ERS_Sites s JOIN ERS_Regions r ON s.RegionId = r.RegionId WHERE SiteId = @SiteId

	SET @Summary ='' 

	IF @Normal = 1
		
			SET @summary = @summary + ' Normal'
	
	ELSE 
	BEGIN
		IF @Tumor =1 
		begin
			if (@TumorQuantity>0 or @TumorMultiple=1)
				if @TumorMultiple=1
					set @summary = @summary +  'Multiple Tumour'
				else
				   if (	@TumorQuantity>0)
						set @summary = @summary + CONVERT(VARCHAR(20), @TumorQuantity) + ' Tumour'
					else
						set @summary = @summary +  ' Tumour'
			else
				SET @summary = @summary + 'Tumour'

			if @TumorSizeofLargest>0
				SET @summary = @summary +' (Largest '+CONVERT(VARCHAR(20), @TumorSizeofLargest) + 'mm)'

			if @TumorFlat=1
				SET @summary = @summary + ',Flat'
			if @TumorFungating=1
				SET @summary = @summary + ',Fungating'
			if @TumorPapilary=1
				SET @summary = @summary + ',Papilary'
			if @RedPatch=1
				SET @summary = @summary + ',Solid'
		end

		IF @CystitisCystica =1 SET @summary = @summary + ' , Cystitis Cystica'

		IF @Diverticulum =1 SET @summary = @summary + ' , Diverticulum'

		IF @Fistula =1 SET @summary = @summary + ' , Fistula'

		IF @RadiationCystitis =1 SET @summary = @summary + ' , Radiation Cystitis'

		IF @RedPatch =1 SET @summary = @summary + ' , Red Patch'

		IF @Stones =1 SET @summary = @summary + ' , Stones'
		
		IF @AbnormalPosition =1 or @CoveredWithTumour =1 or @ExtraUretericOrifice =1 or @Ureterocoele =1
		begin 
			SET @summary=''
			IF @AbnormalPosition =1 SET @summary = @summary + '  Abnormal Position'
			IF @CoveredWithTumour =1 SET @summary = @summary + ' , Covered With Tumour'
			IF @ExtraUretericOrifice =1 SET @summary = @summary + ' , Extra Ureteric Orifice'
			IF @Ureterocoele =1 SET @summary = @summary + ' , Ureterocoele'
		end 	
	END


	-- Finally update the summary in abnormalities table
	UPDATE ERS_CystoscopyAbnoBladder
	SET Summary = @Summary 
	WHERE SiteId = @siteId

	-- TFS 3774 Start
	DECLARE @FirstCharacter VARCHAR(max) = SUBSTRING(LTRIM(RTRIM(@Summary)), 1, 1)
	IF @FirstCharacter = ','
		SET @Summary = SUBSTRING(LTRIM(RTRIM(@Summary)), 2, LEN(LTRIM(RTRIM(@Summary))))
	UPDATE ERS_ProceduresReporting SET PP_Diagnoses = @Summary WHERE ProcedureId = @ProcedureId
	-- TFS 3774 End

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	3774
------------------------------------------------------------------------------------------------------------------------


GO
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	MOSTAFIZUR RAHMAN
-- TFS#	2327
-- Description of change
-- Changed SEv2 Cystoscopy - Cystitis Cystica diagnoses 

-- Updated by	:	Ahmed Shoud
-- TFS#	3774
-- Description of change
-- Normal Cysto
------------------------------------------------------------------------------------------------------------------------


--------------- Cystoscopy Bladder ------------

EXEC dbo.DropIfExist @ObjectName = 'TR_CystoscopyAbnoBladder_Insert',      -- varchar(100)
                     @ObjectTypePrefix = 'TR' -- varchar(5)
GO

EXEC dbo.DropIfExist 
    @ObjectName = 'abnormalities_cystoscopy_bladder_save', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[abnormalities_cystoscopy_bladder_save]
(
	@SiteId INT,
	@Normal BIT,
	@Tumor BIT,
	@TumorQuantity INT,
	@TumorSizeofLargest INT,
	@TumorMultiple BIT,
	@TumorFlat BIT,
	@TumorFungating BIT,
	@TumorPapilary BIT,
	@TumorSolid BIT,
	@CystitisCystica BIT,
	@Diverticulum BIT,
	@Fistula BIT,
	@RadiationCystitis BIT,
	@RedPatch BIT,
	@Stones BIT,
	@AbnormalPosition BIT,
	@CoveredWithTumour BIT,
	@ExtraUretericOrifice BIT,
	@Ureterocoele BIT,
	@LoggedInUserId INT
)
AS
SET NOCOUNT ON

DECLARE @proc_id INT
DECLARE @proc_type INT
DECLARE @region VARCHAR(200)

BEGIN TRANSACTION

BEGIN TRY
	SELECT 
		@proc_id = p.ProcedureId,
		@proc_type = p.ProcedureType,
		@region = r.Region
	FROM 
		ERS_Sites s
	JOIN 
		ERS_Procedures p ON s.ProcedureId = p.ProcedureId
	JOIN
		ERS_Regions r ON s.RegionId = r.RegionId
	WHERE 
		SiteId = @SiteId
	
	-- adding  @CystitisCystica here
	IF (@Normal=0 AND @Tumor=0 AND @TumorMultiple=0 AND @Fistula=0 AND @Stones=0 AND @RadiationCystitis=0 AND @RedPatch=0 AND @AbnormalPosition=0 AND @CoveredWithTumour = 0 AND @Diverticulum = 0 AND @Ureterocoele = 0 and @CystitisCystica=0) 
	BEGIN
		DELETE FROM ERS_CystoscopyAbnoBladder 
		WHERE SiteId = @SiteId

		DELETE FROM ERS_RecordCount 
		WHERE SiteId = @SiteId
		AND Identifier =  @region 
	END		

	ELSE IF NOT EXISTS (SELECT 1 FROM ERS_CystoscopyAbnoBladder WHERE SiteId = @SiteId)
	BEGIN
		INSERT INTO ERS_CystoscopyAbnoBladder (
			[SiteId]
           ,[Normal]
           ,[Tumor]
           ,[TumorQuantity]
           ,[TumorSizeofLargest]
           ,[TumorMultiple]
           ,[TumorFlat]
           ,[TumorFungating]
           ,[TumorPapilary]
           ,[TumorSolid]
           ,[CystitisCystica]
           ,[Diverticulum]
           ,[Fistula]
           ,[RadiationCystitis]
		   ,[RedPatch]
           ,[Stones]
           ,[AbnormalPosition]
           ,[CoveredWithTumour]
           ,[ExtraUretericOrifice]
          ,[Ureterocoele]
		   ,[WhoCreatedId]
		   ,[WhenCreated]) 
		VALUES (
			@SiteId,
			@Normal,
			@Tumor,
			@TumorQuantity,
			@TumorSizeofLargest,
			@TumorMultiple,
			@TumorFlat,
			@TumorFungating,
			@TumorPapilary,
			@TumorSolid,
			@CystitisCystica,
			@Diverticulum,
			@Fistula,
			@RadiationCystitis,
			@RedPatch,
			@Stones,
			@AbnormalPosition,
			@CoveredWithTumour,
			@ExtraUretericOrifice,
			@Ureterocoele,
			@LoggedInUserId,
			GETDATE())

		INSERT INTO ERS_RecordCount (
			[ProcedureId],
			[SiteId],
			[Identifier],
			[RecordCount]
		)
		VALUES (
			@proc_id,
			@SiteId,
			 'Bladder',
			1)
	END

	ELSE
	BEGIN
		UPDATE 
			ERS_CystoscopyAbnoBladder
		SET 
			Normal = @Normal,
			Tumor = @Tumor,
			TumorQuantity = @TumorQuantity,
			TumorSizeofLargest = @TumorSizeofLargest,
			TumorMultiple = @TumorMultiple,
			TumorFlat = @TumorFlat,
			TumorFungating = @TumorFungating,
			TumorPapilary = @TumorPapilary,
			TumorSolid = @TumorSolid,
			CystitisCystica = @CystitisCystica,
			Diverticulum = @Diverticulum,
			Fistula = @Fistula,
			RadiationCystitis = @RadiationCystitis,
			RedPatch = @RedPatch,
			Stones = @Stones,
			AbnormalPosition = @AbnormalPosition,
			CoveredWithTumour = @CoveredWithTumour,
			ExtraUretericOrifice = @ExtraUretericOrifice,
			Ureterocoele = @Ureterocoele,
			WhoUpdatedId = @LoggedInUserId,
			WhenUpdated = GETDATE()
		WHERE 
			SiteId = @SiteId
	END

	-- these two procedures will execute whenever save, delete, update happen. Before, these procedures are only call for update and 
	--insert through trigger. but now i drop the trigger and attach them here. 

	EXEC abnormalities_cystoscopy_bladder_summary_update @SiteId, @proc_id -- TFS 3774
	EXEC sites_summary_update @SiteId

END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;

GO
--------------- Cystoscopy Bladder ------------
--------------- Cystoscopy Therapeutics ------------

EXEC dbo.DropIfExist @ObjectName = 'TR_CystoscopyTherapeutics_Insert',      -- varchar(100)
                     @ObjectTypePrefix = 'TR' -- varchar(5)
GO

EXEC dbo.DropIfExist 
    @ObjectName = 'Therapeutic_cystoscopy_save', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[Therapeutic_cystoscopy_save]
(
	@SiteId INT,
	@None BIT,
	@Diathermy BIT,
	@DiathermyWatts Int,
	@DiathermyPulses Int,
	@DiathermySecs decimal,
	@DiathermyKJ Int,
	@Laser BIT,
	@LaserWatts Int,
	@LaserPulses Int,
	@LaserSecs decimal,
	@LaserKJ Int,
	@LoggedInUserId INT

)
AS

SET NOCOUNT ON

DECLARE @proc_id INT
DECLARE @proc_type INT

BEGIN TRANSACTION

BEGIN TRY
	SELECT 
		@proc_id = p.ProcedureId,
		@proc_type = p.ProcedureType
	FROM 
		ERS_Sites s
	JOIN 
		ERS_Procedures p ON s.ProcedureId = p.ProcedureId
	WHERE 
		SiteId = @SiteId

	IF NOT EXISTS (SELECT 1 FROM ERS_CystoscopyTherapeutics WHERE SiteId = @SiteId)
	BEGIN
		
		INSERT INTO ERS_CystoscopyTherapeutics (
			SiteId,
			[None],
			Diathermy,
			DiathermyWatts,
			DiathermyPulses,
			DiathermySecs,
			DiathermyKJ,
			Laser,
			LaserWatts,
			LaserPulses,
			LaserSecs,
			LaserKJ,	
			WhoCreatedId,
			WhenCreated)
		VALUES (
			@SiteId,
			@None,
			@Diathermy,
			@DiathermyWatts,
			@DiathermyPulses,
			@DiathermySecs,
			@DiathermyKJ,
			@Laser ,
			@LaserWatts,
			@LaserPulses,
			@LaserSecs,
			@LaserKJ,
			@LoggedInUserId,
			GETDATE())

		INSERT INTO ERS_RecordCount (
			[ProcedureId],
			[SiteId],
			[Identifier],
			[RecordCount]
		)
		VALUES (
			@proc_id,
			@SiteId,
			'Therapeutic procedures',
			1)
	END

	ELSE IF (@None = 0 AND @Diathermy = 0 AND @DiathermyWatts = 0 AND @DiathermyPulses = 0 AND @DiathermySecs = 0 AND @DiathermyKJ = 0 
	      AND @Laser = 0 AND @LaserWatts = 0 AND @LaserPulses = 0 AND @LaserSecs = 0 AND @LaserKJ = 0)
	BEGIN

		DELETE FROM ERS_CystoscopyTherapeutics
		WHERE SiteId = @SiteId

		DELETE FROM ERS_RecordCount 
		WHERE SiteId = @SiteId
		AND Identifier = 'Therapeutic Taken'
	END
	
	ELSE
	BEGIN
		
		UPDATE 
			ERS_CystoscopyTherapeutics
		SET 
			[None] = @None,
			Diathermy=@Diathermy,
			DiathermyWatts =@DiathermyWatts,
			DiathermyPulses =@DiathermyPulses,
			DiathermySecs =@DiathermySecs ,
			DiathermyKJ =@DiathermyKJ,
			Laser =@Laser,
			LaserWatts =@LaserWatts,
			LaserPulses =@LaserPulses,
			LaserSecs =@LaserSecs,
			LaserKJ =@LaserKJ,	
			WhoUpdatedId = @LoggedInUserId,
			WhenUpdated = GETDATE()
		WHERE 
			SiteId = @SiteId
	END

	--- same as bladder ... disable the trigeers and bring trigger's code here ( start ) --by mostafiz 

	EXEC Therapeutic_cystoscopy_summary_update @SiteId
	EXEC sites_summary_update @SiteId

	--- same as bladder ... disable the trigeers and trigger's their code here ( end ) 

END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;

--------------- Cystoscopy Therapeutics ------------

--------------- Cystoscopy Urethra ------------
GO

EXEC dbo.DropIfExist @ObjectName = 'TR_CystoscopyAbnoUrethra_Insert',      -- varchar(100)
                     @ObjectTypePrefix = 'TR' -- varchar(5)
GO

EXEC dbo.DropIfExist 
    @ObjectName = 'abnormalities_cystoscopy_Urethra_save', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[abnormalities_cystoscopy_Urethra_save]
(
	@SiteId INT,
	@Normal BIT,
	@Tumour BIT,
	@Blood BIT,
	@PosteriorUrethralValves BIT,
	@Stones BIT,
	@Stricture BIT,
	@RedPatch BIT,
	@Tear BIT,
	
	@Wart BIT,
    @Epispadias BIT,
	@Hypospadias  BIT,
    @Small  BIT,
	@LoggedInUserId INT
)
AS
SET NOCOUNT ON

DECLARE @proc_id INT
DECLARE @proc_type INT
DECLARE @region VARCHAR(200)

BEGIN TRANSACTION

BEGIN TRY
	SELECT 
		@proc_id = p.ProcedureId,
		@proc_type = p.ProcedureType,
		@region = r.Region
	FROM 
		ERS_Sites s
	JOIN 
		ERS_Procedures p ON s.ProcedureId = p.ProcedureId
	JOIN
		ERS_Regions r ON s.RegionId = r.RegionId
	WHERE 
		SiteId = @SiteId
	
	--add rest of option here in the condition by Mostafiz
	IF (@Normal=0 AND @Stones=0 AND @Stricture=0 AND @RedPatch=0  AND @PosteriorUrethralValves = 0 AND @Tumour=0 
	and @Blood=0 and @Tear=0 and @Wart=0 and @Epispadias=0 and  @Hypospadias=0 and @Small=0  )
	BEGIN
		DELETE FROM ERS_CystoscopyAbnoUrethra 
		WHERE SiteId = @SiteId

		DELETE FROM ERS_RecordCount 
		WHERE SiteId = @SiteId
		AND Identifier =  @region 
	END		

	ELSE IF NOT EXISTS (SELECT 1 FROM ERS_CystoscopyAbnoUrethra WHERE SiteId = @SiteId)
	BEGIN
		INSERT INTO ERS_CystoscopyAbnoUrethra (
			[SiteId]
           ,[Normal]
           ,[Blood]
           ,[PosteriorUrethralValves]
           ,[Stones]
           ,[Stricture]
		   ,[RedPatch]
			,[Tear] 
			,[Tumour]
			,[Wart] 
			,[Epispadias] 
			,[Hypospadias]
			,[Small] 
		   ,[WhoCreatedId]
		   ,[WhenCreated]) 
		VALUES (
			@SiteId,
			@Normal,
			@Blood,
			@PosteriorUrethralValves,
			@Stones,
			@Stricture,
			@RedPatch,
			@Tear,
			  @Tumour,
			  @Wart,
			  @Epispadias,
			  @Hypospadias,
			  @Small,
			@LoggedInUserId,
			GETDATE())

		INSERT INTO ERS_RecordCount (
			[ProcedureId],
			[SiteId],
			[Identifier],
			[RecordCount]
		)
		VALUES (
			@proc_id,
			@SiteId,
			 'Urethra',
			1)
	END

	ELSE
	BEGIN
		UPDATE 
			ERS_CystoscopyAbnoUrethra
		SET 
			Normal = @Normal,
			Blood = @Blood,
			PosteriorUrethralValves = @PosteriorUrethralValves,
			Stones = @Stones,
			Stricture = @Stricture,
			RedPatch = @RedPatch,
			Tear=@Tear,
			Tumour= @Tumour,
			Wart=  @Wart,
			Epispadias= @Epispadias,
			Hypospadias=  @Hypospadias,
			Small=  @Small,
			WhoUpdatedId = @LoggedInUserId,
			WhenUpdated = GETDATE()
		WHERE 
			SiteId = @SiteId
	END
	--- same as bladder ... disable the trigeers and bring trigger's code here ( start ) --by mostafiz
	EXEC abnormalities_cystoscopy_Urethra_summary_update @SiteId
	EXEC sites_summary_update @SiteId
	--- same as bladder ... disable the trigeers and bring trigger's code here ( end ) --by mostafiz
END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;

GO
--------------- Cystoscopy Urethra ------------


------------------------------------------------------------------------------------------------------------------------
-- TFS#	2327, 3774 Ended
------------------------------------------------------------------------------------------------------------------------

GO
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	MOSTAFIZUR RAHMAN
-- TFS#	1699
-- Description of change
-- Changed SE V2 Clo test Positive result color Black to Red

-- TFS#	3830
-- Description of change
-- Fixed Normal Procedure showing on DNA / Cancelled report 
------------------------------------------------------------------------------------------------------------------------

EXEC dbo.DropIfExist 
    @ObjectName = 'usp_PrintReport', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[usp_PrintReport]
(
	@ProcedureId INT,
	@Group VARCHAR(10),
	@EpisodeNo INT = 0,
    @PatientComboId VARCHAR(30) = NULL,
    @ProcedureType INT,
    @ColonType INT
)
AS
/*
	16 Feb 2024			:		MH added Diagnoses Colon normal if no Diagnoses provided
*/
SET NOCOUNT ON

	CREATE TABLE #Summary_Main (NodeName VARCHAR(200), NodeSummary NVARCHAR(MAX) ,[Group] VARCHAR(10))

	INSERT INTO #Summary_Main
	EXEC usp_PrintReport_Select @ProcedureId, @Group, @EpisodeNo, @PatientComboId, @ProcedureType, @ColonType
	
	--FOR EUS-HPB
	IF @Group = 'LS' AND @EpisodeNo > 0 AND @ProcedureType = 7 -- ONLY for EUS-HPB (ERCP Report should include OGD, upper tract findings)
	BEGIN
		CREATE TABLE #Summary_UpperTract (NodeName VARCHAR(200), NodeSummary NVARCHAR(MAX) ,[Group] VARCHAR(10))

		INSERT INTO #Summary_UpperTract
		EXEC usp_PrintReport_Select @ProcedureId, @Group, @EpisodeNo, @PatientComboId, 1, @ColonType

		IF (SELECT COUNT(*) FROM #Summary_UpperTract WHERE LTRIM(RTRIM(NodeSummary)) <> '') > 0
		BEGIN
			INSERT INTO #Summary_Main
			SELECT '', '<br /><u style="color:#bf4040;font-weight:bold;">Within the limitations of a side-viewing scope the following upper tract findings were observed.</u>', @Group
			UNION ALL
			SELECT * FROM #Summary_UpperTract
		END
		DROP TABLE #Summary_UpperTract
	END

	declare @ProcedureTypeId int
	Declare @ProcedureTypeName varchar(100)
	declare @dna SMALLINT --edited by mostafiz 3830

	Select @ProcedureTypeId = PR.ProcedureType, @ProcedureTypeName = PT.ProcedureType,@dna=PR.DNA --edited by mostafiz 3830
		from ERS_Procedures PR
		inner join ERS_ProcedureTypes PT on PR.ProcedureType = PT.ProcedureTypeId
		Where ProcedureId = @ProcedureId
	 --below line [and (@dna = 0 OR @dna IS NULL)] edited by mostafiz 3830 but the comment was previously written
	 -- TFS 3774 @ProcedureTypeId IN (3, 13)
	IF @Group = 'LS' and @ProcedureTypeId IN (3, 13) and (@dna = 0 OR @dna IS NULL) --Can be used for any other Procedure types as well
		declare @DiagnosesNormalText as varchar(50) = @ProcedureTypeName + ' normal'
		Begin
			If not exists(Select * from #Summary_Main Where NodeName = 'Diagnoses')
		Begin
			Insert into #Summary_Main(NodeName,NodeSummary,[Group]) Values('Diagnoses',@DiagnosesNormalText,'LS')
		End
		Else if Exists(Select * from #Summary_Main Where NodeName = 'Diagnoses' and IsNull(NodeSummary,'') = '')
		Begin
			Update #Summary_Main Set NodeSummary = @DiagnosesNormalText
			Where NodeName = 'Diagnoses' and IsNull(NodeSummary,'') = ''
		End
	End

	 --  Color updating part 

	SELECT 
    NodeName,
	-- Highlight the word "Positive" if its immediate next word is "Urease" and if '- Specimens taken:' is found
    NodeSummary = 
        CASE 
            WHEN CHARINDEX('Specimens taken', NodeSummary) > 0 AND
                 CHARINDEX('Positive', NodeSummary) > 0 AND
                 CHARINDEX('Urease', SUBSTRING(NodeSummary, CHARINDEX('Positive', NodeSummary) + LEN('Positive') + 1, LEN(NodeSummary))) > 0
            THEN
                REPLACE(NodeSummary, 'Positive', '<span style="color: red;">Positive</span>')
            ELSE
                NodeSummary
        END,
		[Group]
	FROM 
		#Summary_Main 
	WHERE 
		NodeSummary IS NOT NULL;

	 -- Color updating part 

	DROP TABLE #Summary_Main
GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	1699 Ended
-- TFS#	3830 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	MOSTAFIZUR RAHMAN
-- TFS#	3892
-- Description of change
-- TFS#	4037 BY Mahfuz
-- Description of change
-- Fixed Cystoscopy procedure Quality of life description issue 

-- Updated by	:	Ahmed Shoud
-- TFS#	4061
-- Description of change
-- Family History and Previous Disease appearing in the summary report of Brons or EBUS procedure

-- Updated by	:	Ferdowsi
-- TFS#	3866
-- Description of change
-- Staging added 
-- TFS#	3892
-- Description of change
-- Cystoscopy procedure Quality of life

-- TFS#	3544
-- Description of change
-- Split Medication section in clinical report 
------------------------------------------------------------------------------------------------------------------------
UPDATE ERS_Indications SET Description = 'elevated value' WHERE Description = 'elvated value'
GO

IF EXISTS (SELECT 1 FROM sys.columns WHERE name = 'StageType' AND object_id = OBJECT_ID('ERS_ProcedureStaging'))
BEGIN
	ALTER TABLE ERS_ProcedureStaging DROP COLUMN StageType
END
GO

IF NOT EXISTS (SELECT 1 FROM sys.columns WHERE name = 'StageLocation' AND object_id = OBJECT_ID('ERS_ProcedureStaging'))
BEGIN
	ALTER TABLE ERS_ProcedureStaging ADD StageLocation INT
END

GO

EXEC dbo.DropIfExist @ObjectName = 'ProcedureIndicationsSummary',      -- varchar(100)
                     @ObjectTypePrefix = 'F' -- varchar(5)
GO

CREATE FUNCTION [dbo].[ProcedureIndicationsSummary]
(
	@ProcedureId int
)
RETURNS varchar(max)
AS
BEGIN

DECLARE @StageString  varchar(max),@IndicationsString  varchar(max), @ComorbidityString varchar(max), @DamagingDrugsString varchar(max), @PatientAllergiesString varchar(max), @PreviousSurgeryString varchar(max), 
		@PreviousDiseasesString varchar(max), @FamilyDiseaseHistoryString varchar(max), @ImagingString varchar(max), @ImagingOutcomeString varchar(max),
		@RetVal varchar(max), @ProcedureTypeId INT

SELECT @ProcedureTypeId = ProcedureType FROM dbo.ERS_Procedures WHERE ProcedureId = @ProcedureId

SELECT @IndicationsString =
	LTRIM(STUFF((SELECT ', ' + CASE WHEN i.AdditionalInfo = 0 THEN [Description] ELSE AdditionalInformation END + 
	CASE WHEN ISNULL(ChildIndicationId, 0) > 0 THEN '-' + (SELECT [Description] FROM ERS_Indications WHERE UniqueId = epi.ChildIndicationId) ELSE '' END + 
	CASE WHEN i.AdditionalInfo = 0 AND ISNULL(AdditionalInformation, '') <> '' THEN ' ' + AdditionalInformation ELSE '' END AS [text()] 
	FROM ERS_ProcedureIndications epi 
	INNER JOIN ERS_Indications i on i.UniqueId = epi.IndicationId
	WHERE ProcedureId=@ProcedureId
	ORDER BY ISNULL(i.ListOrderBy, 0)
	FOR XML PATH('')),1,1,''))

--rockall and baltchford scoring
--changed by mostafiz 3702

SELECT @IndicationsString	= @IndicationsString + CASE WHEN CHARINDEX('melaena', @IndicationsString) > 0 OR CHARINDEX('haematemesis', @IndicationsString) > 0 THEN ' ' + dbo.fnBlatchfordRockallScores(@ProcedureId) ELSE '' END
--SELECT @IndicationsString = dbo.fnCapitalise(dbo.fnAddFullStop(@IndicationsString)) 

IF LEN(@IndicationsString) > 0
BEGIN
	IF charindex(',', reverse(@IndicationsString)) > 0
		SELECT @RetVal = STUFF(@IndicationsString, len(@IndicationsString) - charindex(' ,', reverse(@IndicationsString)) + 0, 1, ' and ')
	ELSE
		SELECT @RetVal = @IndicationsString
END
--changed by mostafiz 3702
-------------------CoMorbidity


SELECT @ComorbidityString =
	LTRIM(STUFF((SELECT ', ' + CASE WHEN AdditionalInformation = '' THEN [Description] ELSE AdditionalInformation END + CASE WHEN ISNULL(ChildComorbidityId, 0) > 0 THEN '-' + (SELECT [Description] FROM ERS_CoMorbidity WHERE UniqueId = ChildComorbidityId) ELSE '' END AS [text()] 
	FROM ERS_ProcedureComorbidity epc 
	INNER JOIN ERS_Comorbidity c on c.uniqueid = CoMorbidityId
	WHERE ProcedureId=@ProcedureId
	ORDER BY ISNULL(c.ListOrderBy, 0)
	FOR XML PATH('')),1,1,''))

--SELECT @ComorbidityString = dbo.fnCapitalise(dbo.fnAddFullStop(@ComorbidityString)) 

IF LEN(@ComorbidityString) > 0 
BEGIN
	IF charindex(',', reverse(@ComorbidityString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Co-morbidity: ' + STUFF(@ComorbidityString, len(@ComorbidityString) - charindex(' ,', reverse(@ComorbidityString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Co-morbidity: ' + @ComorbidityString
END

-------------------Damaging drugs

--TFS 3544 Start

DECLARE @AntiCoagDrugs bit = (SELECT AntiCoagDrugs FROM ERS_Procedures WHERE ProcedureId = @ProcedureId)
IF @AntiCoagDrugs IS NOT NULL
	If @AntiCoagDrugs = 1 SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'The patient is taking anti-coagulant or anti-platelet medication.'

SELECT @DamagingDrugsString =
	LTRIM(STUFF((SELECT ', ' + [Description] AS [text()] 
	FROM ERS_ProcedureDamagingDrugs edd 
	INNER JOIN ERS_PotentialDamagingDrugs d on d.uniqueid = edd.DamagingDrugId AND d.AntiCoag = 1
	WHERE edd.ProcedureId=@ProcedureId
	ORDER BY ISNULL(d.ListOrderBy, 0)
	FOR XML PATH('')),1,1,''))

IF LEN(@DamagingDrugsString) > 0
BEGIN
	IF charindex(',', reverse(@DamagingDrugsString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Anti-Coagulant drug(s): ' + STUFF(@DamagingDrugsString, len(@DamagingDrugsString) - charindex(' ,', reverse(@DamagingDrugsString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Anti-Coagulant drug(s): ' + @DamagingDrugsString
END


SELECT @DamagingDrugsString =
	LTRIM(STUFF((SELECT ', ' + [Description] AS [text()] 
	FROM ERS_ProcedureDamagingDrugs edd 
	INNER JOIN ERS_PotentialDamagingDrugs d on d.uniqueid = edd.DamagingDrugId AND d.AntiCoag = 0
	WHERE edd.ProcedureId=@ProcedureId
	ORDER BY ISNULL(d.ListOrderBy, 0)
	FOR XML PATH('')),1,1,''))

IF LEN(@DamagingDrugsString) > 0
BEGIN
	IF charindex(',', reverse(@DamagingDrugsString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Potentially Significant drugs(s): ' + STUFF(@DamagingDrugsString, len(@DamagingDrugsString) - charindex(' ,', reverse(@DamagingDrugsString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Potentially Significant drugs(s): ' + @DamagingDrugsString
END

--TFS 3544 End

-------------------Allergies

SELECT @PatientAllergiesString =
	CASE AllergyResult 
		WHEN -1 THEN 'unknown'
		WHEN 0 THEN 'none'
		WHEN 1 THEN a.AllergyDescription 
	END
	FROM ERS_PatientAllergies a
		INNER JOIN ERS_Procedures p ON p.PatientId = a.PatientId
	WHERE p.ProcedureId = @ProcedureId

--SELECT @PatientAllergiesString = dbo.fnCapitalise(dbo.fnAddFullStop(@PatientAllergiesString)) 

IF LEN(@PatientAllergiesString) > 0
BEGIN
	IF charindex(',', reverse(@PatientAllergiesString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Allergies: ' + STUFF(@PatientAllergiesString, len(@PatientAllergiesString) - charindex(' ,', reverse(@PatientAllergiesString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Allergies: ' + @PatientAllergiesString
END
------------------- Staging
--TFS#	3866
	SELECT @StageString=
  (SELECT   CONCAT(
	  --Staging Investigations
		CASE 
          WHEN StagingInvestigations <> 0 THEN 
			 (CASE WHEN [ClinicalGrounds] = 1 THEN 'Clinical Grounds only' ELSE '' END) +
			
			 (CASE WHEN [ImagingOfThorax] = 1 THEN 
			  CASE WHEN [ClinicalGrounds] = 1 THEN ', Cross sectional imaging of thorax' ELSE 'Cross sectional imaging of thorax' END
			  ELSE '' END) +
			
			 (CASE WHEN [PleuralHistology] = 1 THEN
			 CASE WHEN [ClinicalGrounds] = 1 OR [ImagingOfThorax] = 1 THEN ', Pleural cytology / histology' ELSE 'Pleural cytology / histology' END
			 ELSE '' END) +
			 (CASE WHEN [MediastinalSampling] = 1 THEN 
			 CASE WHEN [ClinicalGrounds] = 1 OR [ImagingOfThorax] = 1 OR [PleuralHistology] = 1 THEN ', Mediastinal Sampling' ELSE 'Mediastinal Sampling' END
			 ELSE '' END) +
			 (CASE WHEN [Metastases] = 1 THEN 
			 CASE WHEN [ClinicalGrounds] = 1 OR [ImagingOfThorax] = 1 OR [PleuralHistology] = 1 OR [MediastinalSampling] = 1 THEN ', Diagnostic tests for metastases' ELSE 'Diagnostic tests for metastases' END
			 ELSE '' END) + 
			 (CASE WHEN [Bronchoscopy] = 1 THEN 
			 CASE WHEN [ClinicalGrounds] = 1 OR [ImagingOfThorax] = 1 OR [PleuralHistology] = 1 OR [MediastinalSampling] = 1 OR [Metastases] = 1 THEN ', Bronchoscopy' ELSE 'Bronchoscopy' END
			 ELSE '' END)
         ELSE ''
       END,
	   CASE WHEN ([ClinicalGrounds] = 1 OR [ImagingOfThorax] = 1 OR [PleuralHistology] = 1 OR [MediastinalSampling] = 1 OR [Metastases] = 1 OR Bronchoscopy = 1 ) AND [Stage] = 1  THEN   ' <br/> '  ELSE ''END,
		--stage
		CASE WHEN [Stage] = 1 THEN
		     CONCAT (		 
			 CASE WHEN StageLocation <> 0 then 
			 CONCAT ('Location of primary tumour - ' , CASE WHEN StageLocation = 1 THEN 'Oesophagus' 
	         WHEN StageLocation = 2 THEN 'Oesophagogastric junction' 
	         WHEN StageLocation = 3 THEN 'Stomach' 
             ELSE ''
	         END)
	    ELSE '' END,
			 	 
	 CASE WHEN StageLocation <> 0  AND (StageT <> 0 OR StageN <> 0 OR StageM <> 0 ) THEN ' and ' ELSE ''END,	 
	 CASE WHEN StageT <> 0 then
	 CONCAT ('T - ', CASE WHEN StageT = 1 THEN 'TX' 
	      WHEN StageT = 2 THEN 'T0' 
	      WHEN StageT = 3 THEN 'Tis' 
		  WHEN StageT = 4 THEN 'T1' 
		  WHEN StageT = 5 THEN 'T1a' 
		  WHEN StageT = 6 THEN 'T1b' 
		  WHEN StageT = 7 THEN 'T2' 
	      WHEN StageT = 8 THEN 'T3'
	      WHEN StageT = 9 THEN 'T4'
	      WHEN StageT = 10 THEN 'T4a'
	      WHEN StageT = 11 THEN 'T4b'
	 ELSE ''
	 END )


	 ELSE '' END,
	 CASE WHEN (StageT <> 0  )  AND StageN <> 0 THEN ', ' ELSE ''END,
	 CASE WHEN StageN <> 0 THEN 
	 CONCAT ('N - ', CASE WHEN StageN = 1 THEN 'NX' 
	      WHEN StageN = 2 THEN 'N0' 
	      WHEN StageN = 3 THEN 'N1' 
		  WHEN StageN = 4 THEN 'N2' 
		  WHEN StageN = 5 THEN 'N3' 
	 ELSE ''
	 END)
	 ELSE '' END,
	 CASE WHEN (StageN <> 0 or StageT <> 0  ) AND StageM <> 0 THEN ', ' ELSE ''END,
	 	 CASE WHEN StageM <> 0 THEN
		    CONCAT ('M - ', CASE WHEN StageM = 1 THEN 'MX' 
	        WHEN StageM = 2 THEN 'M0' 
	        WHEN StageM = 3 THEN 'M1' 
	        ELSE ''
	        END)
	    ELSE '' end
           )
	ELSE '' END,
   CASE WHEN StagingInvestigations <> 0  OR [Stage] <> 0 THEN   '<br/> Performance Status - '  ELSE 'Performance Status - 'END,
   -- Performance Status
		CASE WHEN [PerformanceStatus] = 1 THEN
		CASE
		WHEN [PerformanceStatusType] = 1 THEN 'normal activity'
		WHEN [PerformanceStatusType] = 2 THEN 'able to carry out light work'
		WHEN [PerformanceStatusType] = 3 THEN 'unable to carry out any work'
		WHEN [PerformanceStatusType] = 4 THEN 'limited self care'
		WHEN [PerformanceStatusType] = 5 THEN 'completely disabled'
		ELSE ''
		END
		ELSE NULL
		END)
	FROM [ERS_ProcedureStaging] where ProcedureId = @ProcedureId
	 )
 
	IF LEN(@StageString) > 0
	BEGIN

	SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Staging: ' + @StageString
	END


	--   End of TFS#	3866
-------------------Previous surgery

SELECT @PreviousSurgeryString =
	LTRIM(STUFF((SELECT DISTINCT ', ' + [Description] 
	--+ CASE WHEN ListItemText = 'Unknown' THEN '' ELSE ' ' + ListItemText END 
	as [text()] 
	FROM ERS_PatientPreviousSurgery h
	INNER JOIN ERS_PreviousSurgery r on r.UniqueID = h.PreviousSurgeryID
	INNER JOIN dbo.ERS_PreviousSurgeryProcedureTypes pspt ON pspt.PreviousSurgeryId = r.UniqueId AND pspt.ProcedureTypeId = @ProcedureTypeId
	--INNER JOIN ERS_Lists l on l.ListItemNo = h.PreviousSurgeryPeriod and ListDescription = 'Follow up disease Period'
	INNER JOIN ERS_Procedures p on p.patientId = h.patientId 
	WHERE p.ProcedureId = @ProcedureId
	--ORDER BY ISNULL(r.ListOrderBy, 0)
	FOR XML PATH('')),1,1,''))

--SELECT @PreviousSurgeryString = dbo.fnCapitalise(dbo.fnAddFullStop(@PreviousSurgeryString)) 

IF LEN(@PreviousSurgeryString) > 0
BEGIN
	IF charindex(',', reverse(@PreviousSurgeryString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Previous surgery: ' + STUFF(@PreviousSurgeryString, len(@PreviousSurgeryString) - charindex(' ,', reverse(@PreviousSurgeryString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Previous surgery: ' + @PreviousSurgeryString
END

-------------------ASA Status
DECLARE @ASAStatusString varchar(max) = 
	(SELECT TOP 1 [description]
	FROM ERS_PatientASAStatus pa 
		INNER JOIN ERS_ASAStatus a on a.uniqueid = pa.asastatusid
		INNER JOIN ERS_Procedures p ON p.PatientId = pa.PatientId
	WHERE ProcedureId = @ProcedureId
	order by isnull(pa.WhenUpdated, pa.WhenCreated))

IF LEN(@ASAStatusString) > 0 
BEGIN
	SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'ASA Status: ' + @ASAStatusString
END
-------------------Previous diseases

SELECT @PreviousDiseasesString =
	LTRIM(STUFF((SELECT DISTINCT ', ' + [Description] as [text()] 
	FROM ERS_PatientPreviousDiseases pd
	INNER JOIN ERS_PreviousDiseases d on d.UniqueID = pd.PreviousDiseaseID
	INNER JOIN dbo.ERS_PreviousDiseaseProcedureTypes ppt ON ppt.PreviousDiseaseId = d.UniqueId AND ppt.ProcedureTypeId = @ProcedureTypeId
	INNER JOIN ERS_Procedures p on p.patientId = pd.patientId 
	WHERE p.ProcedureId = @ProcedureId
	--ORDER BY ISNULL(r.ListOrderBy, 0)
	FOR XML PATH('')),1,1,''))

--SELECT @PreviousDiseasesString = dbo.fnCapitalise(dbo.fnAddFullStop(@PreviousDiseasesString)) 

IF LEN(@PreviousDiseasesString) > 0
BEGIN
	IF charindex(',', reverse(@PreviousDiseasesString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Previous diseases: ' + STUFF(@PreviousDiseasesString, len(@PreviousDiseasesString) - charindex(' ,', reverse(@PreviousDiseasesString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Previous diseases: ' + @PreviousDiseasesString
END

-------------------Family disease history

SELECT @FamilyDiseaseHistoryString =
	LTRIM(STUFF((SELECT ', ' + CASE WHEN AdditionalInformation = '' THEN [Description] ELSE AdditionalInformation END AS [text()] 
	FROM ERS_PatientFamilyDiseaseHistory epi 
	INNER JOIN ERS_FamilyDiseaseHistory i on i.UniqueId = epi.FamilyDiseaseHistoryId
	INNER JOIN ERS_Procedures p on p.patientId = epi.patientId 
	WHERE ProcedureId=@ProcedureId
	ORDER BY ISNULL(i.ListOrderBy, 999)
	FOR XML PATH('')),1,1,''))

--SELECT @FamilyDiseaseHistoryString = dbo.fnCapitalise(dbo.fnAddFullStop(@FamilyDiseaseHistoryString)) 

IF LEN(@FamilyDiseaseHistoryString) > 0 AND @ProcedureTypeId NOT IN(10, 11) -- TFS 4061
BEGIN
	IF charindex(',', reverse(@FamilyDiseaseHistoryString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Family history: ' + STUFF(@FamilyDiseaseHistoryString, len(@FamilyDiseaseHistoryString) - charindex(' ,', reverse(@FamilyDiseaseHistoryString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Family history: ' + @FamilyDiseaseHistoryString
END


-------------------Imaging

SELECT @ImagingString =
	LTRIM(STUFF((SELECT ', ' + [Description] AS [text()] 
	FROM ERS_ImagingMethods im 
	INNER JOIN ERS_ProcedureImagingMethod pim on im.uniqueid = pim.ImagingMethodId
	WHERE pim.ProcedureId=@ProcedureId
	FOR XML PATH('')),1,1,''))


IF LEN(@ImagingString) > 0
BEGIN
	IF charindex(',', reverse(@ImagingString)) > 0
		SELECT @ImagingString = STUFF(@ImagingString, len(@ImagingString) - charindex(' ,', reverse(@ImagingString)), 2, ' and ')
END


SELECT @ImagingOutcomeString =
	LTRIM(STUFF((SELECT ', ' + [Description] AS [text()] 
	FROM ERS_ImagingOutcomes imo 
	INNER JOIN ERS_ProcedureImagingOutcome pio on imo.uniqueid = pio.ImagingOutcomeId
	WHERE pio.ProcedureId=@ProcedureId
	FOR XML PATH('')),1,1,''))

IF ISNULL(@ImagingOutcomeString,'') <> ''
BEGIN
	SELECT @ImagingString = CASE WHEN ISNULL(@ImagingString, '') <> '' THEN @ImagingString + ' revealed ' ELSE '' END  + @ImagingOutcomeString
END


--SELECT @ImagingString = dbo.fnCapitalise(dbo.fnAddFullStop(@ImagingString)) 

IF LEN(@ImagingString) > 0
BEGIN
	IF charindex(',', reverse(@ImagingString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Imaging: ' + STUFF(@ImagingString, len(@ImagingString) - charindex(' ,', reverse(@ImagingString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + 'Imaging: ' + @ImagingString
END


DECLARE @SmokingString varchar(max)


SELECT @SmokingString=
	LTRIM(STUFF((SELECT '  ' +SmokingDescription   AS [text()] 
	FROM ERS_ProcedureSmoking epi 
	WHERE ProcedureId=@ProcedureId
	FOR XML PATH('')),1,1,''))

--SELECT @SmokingString = dbo.fnCapitalise(dbo.fnAddFullStop(@SmokingString)) 

IF LEN(@SmokingString) > 0
BEGIN
	IF charindex(',', reverse(@SmokingString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>Smoking:</b> ' + @SmokingString
		--SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>Smoking:</b> ' + STUFF(@SmokingString, len(@SmokingString) - charindex(' ,', reverse(@SmokingString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>Smoking:</b> ' + @SmokingString
END

DECLARE @LUTSIPSSString varchar(max)
DECLARE @LUTSIPSSTotalScoreString varchar(max)
-- edited by mostafiz issue 3892
SELECT @LUTSIPSSString =
    LTRIM(STUFF((SELECT ', ' + 
                        CASE 
                            WHEN SectionName <> 'Quality of life due to urinary symptoms' THEN SectionName + '(Score:' + CAST(ls.ScoreValue AS VARCHAR(10)) + ')' -- TFS 3892
                        END AS [text()]
                FROM ERS_ProcedureLUTSIPSSSymptoms a
                INNER JOIN ERS_LUTSIPSSSymptoms b ON a.LUTSIPSSSymptomId = b.UniqueId
                INNER JOIN ERS_LUTSIPSSSymptomSections s ON b.LUTSIPSSSymptomSectionId = s.LUTSIPSSSymptomSectionId
                INNER JOIN ERS_IPSSScore ls ON a.SelectedScoreId = ls.ScoreId
                WHERE ProcedureId = @ProcedureId AND SelectedScoreId > 1
                FOR XML PATH('')), 1, 1, ''))
-- edited by mostafiz issue 3892
--SELECT @LUTSIPSSString = dbo.fnCapitalise(dbo.fnAddFullStop(@LUTSIPSSString)) 

select top 1  @LUTSIPSSTotalScoreString =  'Total Score :' + cast(TotalScoreValue as varchar(10)) 
from  ERS_ProcedureLUTSIPSSSymptoms where ProcedureId=@ProcedureId
IF LEN(@LUTSIPSSString) > 0
BEGIN
	IF charindex(',', reverse(@LUTSIPSSString)) > 0
		--TFS 3892 Start
		BEGIN
			SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>LUTS\IPSS symptom score:</b>' + @LUTSIPSSString
			SET @RetVal = @RetVal + ' ' + @LUTSIPSSTotalScoreString + ' '+'<br />'
		END 
		--TFS 3892 End
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>LUTS\IPSS symptom score:</b> ' + @LUTSIPSSString

	--SELECT @RetVal = ISNULL(@RetVal + '<br />', '') +  @LUTSIPSSTotalScoreString
END

-- TFS 3892 Start

DECLARE @QualityOfLife varchar(max)

SELECT @QualityOfLife =
    LTRIM(STUFF((SELECT ', ' + 
                        CASE
                            WHEN SectionName = 'Quality of life due to urinary symptoms' THEN (SectionName + '(Score:' + CAST(ls.ScoreValue AS VARCHAR(10)) + ' - ' + (SELECT ScoreDescription FROM ERS_IPSSScoreQuality WHERE ScoreId = ls.ScoreId)+')')
                        END AS [text()]
                FROM ERS_ProcedureLUTSIPSSSymptoms a
                INNER JOIN ERS_LUTSIPSSSymptoms b ON a.LUTSIPSSSymptomId = b.UniqueId
                INNER JOIN ERS_LUTSIPSSSymptomSections s ON b.LUTSIPSSSymptomSectionId = s.LUTSIPSSSymptomSectionId
                INNER JOIN ERS_IPSSScore ls ON a.SelectedScoreId = ls.ScoreId
                WHERE ProcedureId = @ProcedureId AND SelectedScoreId >= 1
                FOR XML PATH('')), 1, 1, ''))
IF LEN(@QualityOfLife) > 0
BEGIN
	SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + @QualityOfLife
END

DECLARE @PreviousDiseaseUrologyString varchar(max)

SELECT @PreviousDiseaseUrologyString=
	LTRIM(STUFF((SELECT ', ' +case 
       when a.Description='Other' then b.AdditionalInformation
	   else a.Description
	  end
   AS [text()] 
	from ERS_PreviousDiseasesUrology a, ERS_ProcedurePreviousDiseasesUrology b 
	where a.UniqueId=b.PreviousDiseaseId
	and b.ProcedureId=@ProcedureId
	order by PreviousDiseaseSectionId
	FOR XML PATH('')),1,1,''))

--SELECT @PreviousDiseaseUrologyString = dbo.fnCapitalise(dbo.fnAddFullStop(@PreviousDiseaseUrologyString)) 


IF LEN(@PreviousDiseaseUrologyString) > 0
BEGIN
	IF charindex(',', reverse(@PreviousDiseaseUrologyString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>Past Urological Histrory:</b>' + STUFF(@PreviousDiseaseUrologyString, len(@PreviousDiseaseUrologyString) - charindex(' ,', reverse(@PreviousDiseaseUrologyString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>Past Urological Histrory:</b> ' + @PreviousDiseaseUrologyString

	
END

DECLARE @UrineDipstickCytologyString varchar(max)

SELECT @UrineDipstickCytologyString=
	LTRIM(STUFF((SELECT ', ' + b.Description + ' '+c.Description 
   AS [text()] 
	from ERS_ProcedureUrineDipstickCytology a,ERS_UrineDipstickCytology b,ERS_UrineDipstickCytology c
	where a.ProcedureId=@ProcedureId
	and a.UrineDipstickCytologyId=b.UniqueId
	and a.ChildUrineDipstickCytologyId=c.UniqueId
	order by b.UrineDipstickCytologySectionId,b.ListOrderBy
	FOR XML PATH('')),1,1,''))

--SELECT @UrineDipstickCytologyString = dbo.fnCapitalise(dbo.fnAddFullStop(@UrineDipstickCytologyString)) 


IF LEN(@UrineDipstickCytologyString) > 0
BEGIN
	IF charindex(',', reverse(@UrineDipstickCytologyString)) > 0
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>Urine Dipstick And Cytology:</b>' + STUFF(@UrineDipstickCytologyString, len(@UrineDipstickCytologyString) - charindex(' ,', reverse(@UrineDipstickCytologyString)), 2, ' and ')
	ELSE
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + '<b>Urine Dipstick And Cytology:</b>' + @UrineDipstickCytologyString --MH closed bold tag </b> here on 18 Apr 2024
END


--------------Broncs referral data
DECLARE @BroncoReferralDataString varchar(max), @DateBronchRequested DATETIME,
		@DateOfReferral DATETIME,
		@LCaSuspectedBySpecialist BIT,
		@CTScanAvailable BIT,
		@DateOfScan DATETIME

	SELECT @DateBronchRequested=DateBronchRequested,
		   @DateOfReferral=DateOfReferral,
		   @LCaSuspectedBySpecialist=LCaSuspectedBySpecialist,
		   @CTScanAvailable=CTScanAvailable
	FROM ERS_ProcedureBronchoReferralData
	WHERE ProcedureId = @ProcedureId

	IF @DateBronchRequested IS NOT NULL SET @BroncoReferralDataString  = ISNULL(@BroncoReferralDataString,'') + 'Date bronchoscopy requested ' + CONVERT(VARCHAR, @DateBronchRequested, 105) + '. '
	IF @DateOfReferral IS NOT NULL SET @BroncoReferralDataString  = ISNULL(@BroncoReferralDataString,'') + 'Date of referral ' + CONVERT(VARCHAR, @DateOfReferral, 105) + '. '
	IF @LCaSuspectedBySpecialist = 1 SET @BroncoReferralDataString  = ISNULL(@BroncoReferralDataString,'') + 'Lung Ca suspected by lung Ca specialist' + '. '
	IF @CTScanAvailable = 1 SET @BroncoReferralDataString  = ISNULL(@BroncoReferralDataString,'') + 'CT scan available prior to bronchoscopy' + '. '
	IF @DateOfScan IS NOT NULL SET @BroncoReferralDataString  = ISNULL(@BroncoReferralDataString,'') + 'Date of scan ' + CONVERT(VARCHAR, @DateOfScan, 105) + '. '
	

	IF @BroncoReferralDataString IS NOT NULL SET @BroncoReferralDataString = 'Referal Data (' + RTRIM(@BroncoReferralDataString )+ ')'
	ELSE SET @BroncoReferralDataString = ''
	
	IF LEN(@BroncoReferralDataString) > 0
	BEGIN
		SELECT @RetVal = ISNULL(@RetVal + '<br />', '') + @BroncoReferralDataString
	END


RETURN @RetVal
END

------------------------------------------------------------------------------------------------------------------------
-- TFS#	3892, 4061, 3544, 3892 Ended
------------------------------------------------------------------------------------------------------------------------


GO
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	MOSTAFIZUR RAHMAN
-- TFS#	3891
-- Description of change
-- Copy To not saving details
------------------------------------------------------------------------------------------------------------------------

EXEC dbo.DropIfExist 
    @ObjectName = 'ogd_followup_summary_update', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[ogd_followup_summary_update]
(
	@ProcedureId INT
)
AS
	SET NOCOUNT ON

	DECLARE
		@summary NVARCHAR(MAX) = '',
		@NoFurtherTestsRequired BIT,
		@AwaitingPathologyResults BIT,
		@EvidenceOfCancerIdentified TINYINT,
		--@BleedRecordPresent INT,
		@ReBleed NVARCHAR(MAX),
		@PatientInformed BIT,
		@PatientRemovedFromFastTrack BIT,
		@NotInformedReason NVARCHAR(255) = '',
		@CnsMdtcInformed BIT,
		@ImagingRequested Bit,
		@FurtherProcedure BIT,
		@FurtherProcedureDueCount INT,
		@FurtherProcedureDueType TINYINT,
		@FurtherProcedureText NVARCHAR(MAX) = '',
		@ReturnTo SMALLINT,
		@NoFurtherFollowUp BIT,
		@ReviewLocation SMALLINT,
		@ReviewDueCount INT,
		@ReviewDueType TINYINT,
		@ReviewText NVARCHAR(MAX) = '',
		@Comments NVARCHAR(MAX) = '',
		@PP_PFRFollowUp NVARCHAR(MAX) = '',
		@CopyToPatient BIT,
		@CopyToPatientText NVARCHAR(MAX) = '',
		@PatientNotCopiedReason NVARCHAR(500),
		@CopyToRefCon BIT,
		@CopyToRefConText NVARCHAR(500) = '',
		@CopyToOther BIT,
		@CopyToOtherText NVARCHAR(500) ='',
		@Salutation NVARCHAR(200) = '',
		@AdviceComments NVARCHAR(MAX) = '',
		@ReBleedPlanRepeatGastroscopy BIT,
		@ReBleedPlanRequestSurgicalReview BIT,
		@ReBleedPlanOtherText NVARCHAR(MAX) = '',
		@ClinicalFindingAlert BIT,
		@UrgentTwoWeekReferral BIT,
		@CancerResultId INT,
		@WhoStatusId INT,
		@CancerNotDetected BIT


	SELECT 
		@NoFurtherTestsRequired=NoFurtherTestsRequired,
		@AwaitingPathologyResults=AwaitingPathologyResults,
		@EvidenceOfCancerIdentified=EvidenceOfCancerIdentified,
		@PatientInformed=PatientInformed,
		@PatientRemovedFromFastTrack=PatientRemovedFromFastTrack,
		@NotInformedReason=NotInformedReason,
		@CnsMdtcInformed=CnsMdtcInformed,
		@ImagingRequested = ImagingRequested,
		@FurtherProcedure=FurtherProcedure,
		@FurtherProcedureDueCount=FurtherProcedureDueCount,
		@FurtherProcedureDueType=FurtherProcedureDueType,
		@FurtherProcedureText=FurtherProcedureText,
		@ReturnTo=ReturnTo,
		@NoFurtherFollowUp=NoFurtherFollowUp,
		@ReviewLocation=ReviewLocation,
		@ReviewDueCount=ReviewDueCount,
		@ReviewDueType=ReviewDueType,
		@ReviewText=ReviewText,
		@Comments=Comments,
		@PP_PFRFollowUp=PP_PFRFollowUp,
		@CopyToPatient=CopyToPatient,
		@CopyToPatientText=CopyToPatientText,
		@PatientNotCopiedReason=PatientNotCopiedReason,
		@CopyToRefCon=CopyToRefCon,
		@CopyToRefConText=CopyToRefConText,
		@CopyToOther=CopyToOther,
		@CopyToOtherText=CopyToOtherText,
		@Salutation=Salutation,
		@ReBleedPlanRepeatGastroscopy=ISNULL(ReBleedPlanRepeatGastroscopy, 0),
		@ReBleedPlanRequestSurgicalReview=ISNULL(ReBleedPlanRequestSurgicalReview, 0),
		@ReBleedPlanOtherText=ReBleedPlanOtherText,
		@ClinicalFindingAlert=ClinicalFindingsAlert,
		@UrgentTwoWeekReferral = UrgentTwoWeekReferral,
		@CancerResultId = CancerResultId,
		@WhoStatusId = WhoStatusId,
		@CancerNotDetected = CancerNotDetected
	FROM
		ERS_UpperGIFollowUp
	WHERE
		ProcedureId = @ProcedureId	

	SET @summary = ''

	IF @NoFurtherTestsRequired = 1
		--IF @summary = '' 
		SET @summary = 'No further tests required. <br/>'
		--ELSE
			--SET @summary = @summary + 'No further tests required. '
	
	IF ISNULL(@ReviewText,'') <> ''
		IF RIGHT(@ReviewText, 1) = '.'
			SET @summary = @summary + @ReviewText + ' <br/>'
		ELSE
			SET @summary = @summary + @ReviewText + '. <br/>'
	ELSE
	BEGIN
		DECLARE @tmpFollowUp VARCHAR(100) = ''

		IF @ReturnTo > 0
			SET @tmpFollowUp = ISNULL((SELECT 'Return to the ' + [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Return or referred to' AND [ListItemNo] = @ReturnTo), '') 
	
		IF @NoFurtherFollowUp = 1 
			BEGIN
				IF ISNULL(@tmpFollowUp,'') <> '' 
					SET @tmpFollowUp = @tmpFollowUp + ' and no further follow up. '
				ELSE
					SET @tmpFollowUp = @tmpFollowUp + 'No further follow up. '
			END 
		ELSE
			BEGIN
				IF ISNULL(@tmpFollowUp,'') <> ''
					IF RIGHT(@FurtherProcedureText, 1) = '.'
						SET @tmpFollowUp = @tmpFollowUp + ' <br/>'
					ELSE
						SET @tmpFollowUp = @tmpFollowUp + '. <br/>'
			END

		IF @AwaitingPathologyResults = 1
			SET @tmpFollowUp = @tmpFollowUp + 'Awaiting pathology results. <br/>'

		
		SET @summary = CASE WHEN @summary + @tmpFollowUp = '' THEN '' ELSE @summary + @tmpFollowUp END
	END 
		
	IF ISNULL(@FurtherProcedureText,'') <> ''
		IF RIGHT(@FurtherProcedureText, 1) = '.'				
			SET @summary = @summary + 'Further procedure(s): ' + UPPER(LEFT(@FurtherProcedureText, 1)) + LOWER(SUBSTRING(@FurtherProcedureText, 2, LEN(@FurtherProcedureText))) + ' '

		ELSE 
			SET @summary = @summary + 'Further procedure(s): ' + UPPER(LEFT(@FurtherProcedureText, 1)) + LOWER(SUBSTRING(@FurtherProcedureText, 2, LEN(@FurtherProcedureText))) + '. '
	
		
	UPDATE ERS_UpperGIFollowUp
	SET Summary = @summary 
	WHERE ProcedureId = @ProcedureId


	--IF @Comments <> ''
		--IF @summary = '' SET @summary = 'Advice/comments: ' + @Comments
		--ELSE SET @summary = @summary + '. <br>Advice/comments: ' + @Comments

	--PRINT @summary

	--Update the summary column in diagnoses table and procedures tabler


	--IF @EvidenceOfCancerIdentified <> 3
	--BEGIN
	--	IF @EvidenceOfCancerIdentified = 1
	--		SET @AdviceComments = @AdviceComments + 'Evidence of cancer seen for this endoscopy - '
	--	ELSE IF @EvidenceOfCancerIdentified = 2 
	--		SET @AdviceComments = @AdviceComments + CASE WHEN ISNULL(@CancerNotDetected,0) = 1 THEN 'No cancer detected during this procedure - ' ELSE 'No evidence of cancer seen for this endoscopy - ' END
	--	ELSE IF @EvidenceOfCancerIdentified = 3 
	--		SET @AdviceComments = @AdviceComments + ''	

	--	IF @PatientInformed = 1	
	--		SET @AdviceComments = @AdviceComments + 'patient informed. <br/>'
	--	ELSE
	--	BEGIN
	--		SET @AdviceComments = @AdviceComments + 'patient not informed. <br/>'	

	--		IF @NotInformedReason <> ''
	--			IF RIGHT(@NotInformedReason, 1) = '.'
	--			BEGIN								
	--				SET @AdviceComments = @AdviceComments + 'Reason why patient not informed: ' + UPPER(LEFT(@NotInformedReason, 1)) + LOWER(SUBSTRING(@NotInformedReason, 2, LEN(@NotInformedReason))) + ' <br/>'
	--			END
	--			ELSE
	--				SET @AdviceComments = @AdviceComments + 'Reason why patient not informed: ' + UPPER(LEFT(@NotInformedReason, 1)) + LOWER(SUBSTRING(@NotInformedReason, 2, LEN(@NotInformedReason))) + '. <br/>'
	--	END	
	
	--	IF @PatientRemovedFromFastTrack = 1
	--		SET @AdviceComments = @AdviceComments + 'Patient removed from fast track. <br/>'
	--	--ELSE
	--	--	SET @AdviceComments = @AdviceComments + 'Patient not removed from fast track. <br>'
			
	--	IF @CnsMdtcInformed = 1
	--		SET @AdviceComments = @AdviceComments + 'CNS-MDTC informed. <br/>'
	--	--ELSE
	--	--	SET @AdviceComments = @AdviceComments + 'CNS-MDTC not informed. <br>'		
	--END	

	if @ImagingRequested = 1 Set @AdviceComments = @AdviceComments + 'Imaging has been requested. <br/>'
	
	SET @ReBleed = ''
	
	IF EXISTS (SELECT 1 FROM ERS_UpperGIBleeds WHERE ProcedureId = @ProcedureId) 
	BEGIN
		SET @ReBleed = 'Risk of Re-bleed - <b>' + ISNULL((SELECT [OverallRiskAssessment] FROM ERS_UpperGIBleeds WHERE ProcedureID = @ProcedureId),'') + '. </b><br/> '

		IF @ReBleedPlanRepeatGastroscopy = 1
			SET @ReBleed = @ReBleed + 'Repeat Gastroscopy. <br/> '

		IF @ReBleedPlanRequestSurgicalReview = 1
			SET @ReBleed = @ReBleed + 'Request surgical review. <br/> '

		IF @ReBleedPlanOtherText <> ''
			IF RIGHT(@ReBleedPlanOtherText, 1) = '.'
				SET @ReBleed = @ReBleed + @ReBleedPlanOtherText + ' '  
			ELSE
				SET @ReBleed = @ReBleed + @ReBleedPlanOtherText + '. '  
	END

	
	IF @UrgentTwoWeekReferral = 1
	SET @AdviceComments = @AdviceComments + 'Urgent 2 week referral. '
	
	IF @CancerResultId > 0 
	SET @AdviceComments	= @AdviceComments + 'Cancer ' + 
							CASE @CancerResultId 
								WHEN 1 THEN 'definate.' 
								WHEN 2 THEN 'suspected'
								WHEN 3 THEN 'excluded.'
								ELSE ''
							END
						
	IF @UrgentTwoWeekReferral = 1 
	SET @AdviceComments	= @AdviceComments + ' WHO status: ' + convert(varchar(10),@WhoStatusId) + '. <br />'
		
		
	IF @ClinicalFindingAlert = 1	
	SET @AdviceComments = @AdviceComments + '<br/><strong style="color:red;">Clinical Finding Alert</strong><br/>'

	-- Updated by	:	Siddikur Rahman
	-- TFS#	3902 Start

	--REPLACE cr (\r) and lf (\n) to preserve line breaks
	IF @Comments <> ''
	SET @Comments = REPLACE(REPLACE(@Comments, CHAR(13), '<br/>'), CHAR(10), '<br/>')

	-- TFS#	3902 End

	UPDATE ERS_ProceduresReporting
	SET PP_Followup = @summary, PP_ReBleed = @ReBleed, PP_AdviceAndComments = CASE WHEN @AdviceComments + @Comments = '' THEN '' ELSE @AdviceComments + @Comments END
	WHERE ProcedureId = @ProcedureId		

	IF @CopyToRefCon IS NOT NULL AND @CopyToRefCon=1    
		UPDATE ERS_ProceduresReporting  --edited bY MOSTAFIZ ISSUE 3891
		SET PP_CCRefCons= LTRIM(RTRIM((SELECT ISNULL(Title,'') + ' ' + ISNULL(Forename,'')+ ' '+ISNULL(Surname,'') 
										FROM ERS_Consultant 
										WHERE ConsultantID= @CopyToRefConText))) 
		WHERE ProcedureId = @ProcedureId
	ELSE 
		UPDATE ERS_ProceduresReporting SET PP_CCRefCons = NULL
		WHERE ProcedureId = @ProcedureId

	IF @CopyToPatient IS NOT NULL AND @CopyToPatient=1     
		UPDATE ERS_ProceduresReporting SET PP_CCPatient= @CopyToPatientText   
		WHERE ProcedureId = @ProcedureId
	ELSE 
		UPDATE ERS_ProceduresReporting SET PP_CCPatient= NULL
		WHERE ProcedureId = @ProcedureId
	
	IF @CopyToOther IS NOT NULL AND @CopyToOther=1             
		UPDATE ERS_ProceduresReporting 
		SET PP_CCOther = @CopyToOtherText     
		WHERE ProcedureId = @ProcedureId
	ELSE 
		UPDATE ERS_ProceduresReporting 
		SET PP_CCOther = NULL 
		WHERE ProcedureId = @ProcedureId
	
	GO

	EXEC dbo.DropIfExist 
    @ObjectName = 'ogd_followup_select', 
    @ObjectTypePrefix = 'S'
	
	GO
	CREATE PROCEDURE [dbo].[ogd_followup_select]
(
	@ProcedureId INT
)
AS

SET NOCOUNT ON

SELECT
	NoFurtherTestsRequired,
	AwaitingPathologyResults,
	EvidenceOfCancerIdentified,
    PatientInformed,
    PatientRemovedFromFastTrack,
    NotInformedReason,
    CnsMdtcInformed,
	ImagingRequested,
	FurtherProcedure,
	FurtherProcedureDueCount,
	FurtherProcedureDueType,
	FurtherProcedureText,
	ReturnTo,
	NoFurtherFollowUp,
	ReviewLocation,
	ReviewDueCount,
	ReviewDueType,
	ReviewText,
	Comments,
	PP_PFRFollowUp,
	CopyToPatient,
	CopyToPatientText,
	PatientNotCopiedReason,
	CopyToRefCon,
	CopyToRefConText,
	CopyToOther,
	CopyToOtherText,
	Salutation,
	ReBleedPlanRepeatGastroscopy,
    ReBleedPlanRequestSurgicalReview,
    ReBleedPlanOtherOption,
    ReBleedPlanOtherText,
	ClinicalFindingsAlert,
	CopyToGPEmailAddress, --changed by mostafiz 3891
	UrgentTwoWeekReferral,
	CancerResultId,
	WhoStatusId,
	CancerNotDetected
FROM
	ERS_UpperGIFollowUp
WHERE 
	ProcedureId = @ProcedureId

GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	3891 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Abul Kashim
-- TFS#	3570
-- Description of change: Amended report title 

-- Updated by	:	Ahmed Shoud
-- TFS#	3714
-- Description of change: Printing report displays the logged in hospital
-------------------------------------------------------------------------------------------------------------------------
EXEC dbo.DropIfExist 
    @ObjectName = 'printreport_header_select', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[printreport_header_select]
(
	@OperatingHospitalID SMALLINT,
	@ProcedureId INT=0,
	@EpisodeNo INT = 0,
	@PatientComboId VARCHAR(30) = NULL,
	@ProcedureType TINYINT,
	@EnableNHSType BIT = 0
)
AS
/**************************************************************************
 Author:		?
 Create date:	?
 Description:	Get report header information
***************************************************************************
*****                        Change History                           *****
***************************************************************************
** Rev	Date			Author		Description 
** --	-----------		---------	---------------------------------------
** 1	25 Jul 2019		Duncan		Added report footer from System Config
									Removed execute(@SQL) where possible
** 
**
**************************************************************************/
SET NOCOUNT ON

    DECLARE @RepHeader TABLE (ReportHeading VARCHAR(150), ReportSubHeading VARCHAR(150), ReportTrustType VARCHAR(150), OpHosp VARCHAR(150), ReportHeader varchar(500) )
    DECLARE @SQL NVARCHAR(MAX)

    IF @ProcedureId > 0
    BEGIN
	   declare @CystoscopyProcedureType varchar(50)=''
	   if @ProcedureType=13 
	   begin
	     select @CystoscopyProcedureType= CystoscopyProcedureType +' ' from ERS_ProcedureCystoscopyHeader
		 where ProcedureId=@ProcedureId
	   end

		IF @EnableNHSType = 0
        BEGIN
			SELECT	ISNULL(p.PP_RepHead, '') AS ReportHeading
					,ISNULL(p.PP_RepSubHead, '') AS ReportSubHeading
					, '' as ReportFooter
					,'' AS ReportTrustType
					,ISNULL(p.PP_OpHosp, '') AS OpHosp
					,ISNULL((SELECT @CystoscopyProcedureType + pt.[ReportHeader]  + ISNULL((SELECT TOP 1 CASE WHEN p.ReportUpdated = 1 THEN ' - Modified' 
																			WHEN count(d.ProcedureId) > 1 THEN ' - Modified'
																		ELSE '' END FROM ERS_DocumentStore d INNER JOIN ERS_Procedures p ON p.ProcedureId = d.ProcedureId WHERE d.ProcedureId = @ProcedureId GROUP BY ReportUpdated),'')
							FROM ERS_ProcedureTypes AS pt 
							WHERE [ProcedureTypeId] = CONVERT(VARCHAR,@ProcedureType)),'REPORT') AS ReportHeader
					, NULL AS LeftLogo
			FROM	ERS_ProceduresReporting p
			WHERE	p.[ProcedureId] = CONVERT(VARCHAR,@ProcedureId )
        END
		ELSE
		BEGIN
			SELECT  ISNULL(s.[ReportHeading],o.[HospitalName]) AS ReportHeading 
					,ISNULL(s.[ReportSubHeading],'') AS ReportSubHeading
					, ISNULL(s.ReportFooter, '') as ReportFooter
					,ISNULL(s.[ReportTrustType], 'NHS Trust') AS ReportTrustType 
					,'' AS OpHosp
					, ISNULL((SELECT top(1) @CystoscopyProcedureType + [ReportHeader] + ISNULL((SELECT TOP 1 CASE WHEN p.ReportUpdated = 1 THEN ' -Modified ' 
																			WHEN count(d.ProcedureId) > 1 THEN ' - Modified'
																		ELSE '' END FROM ERS_DocumentStore d INNER JOIN ERS_Procedures p ON p.ProcedureId = d.ProcedureId WHERE d.ProcedureId = @ProcedureId GROUP BY ReportUpdated),'')
										FROM ERS_ProcedureTypes 
										WHERE [ProcedureTypeId]= CONVERT(VARCHAR,@ProcedureType)),'REPORT') AS ReportHeader
					,s.LeftLogo
			FROM	[ERS_OperatingHospitals] o
			join	[ERS_SystemConfig] s 
							on o.OperatingHospitalID = s.OperatingHospitalID
			--TFS 3714 Start
			join    [ERS_Procedures] p
							on p.OperatingHospitalID = s.OperatingHospitalID
			WHERE p.ProcedureId = @ProcedureId
			--TFS 3714 End
		END
    END
    ELSE
    BEGIN
        IF @EnableNHSType = 0
        BEGIN
            SET @SQL =	N'SELECT ISNULL(p.PP_RepHead,'''') AS ReportHeading
						, ISNULL(p.PP_RepSubHead,'''') AS ReportSubHeading
						, '' as ReportFooter
						, '''' AS ReportTrustType
						, ISNULL(p.PP_OpHosp,'''') AS OpHosp
						, ISNULL(p.[PP_RepType],''REPORT'') AS ReportHeader 
						, NULL AS LeftLogo
						FROM ' + dbo.fnGetUGI_tablename(@ProcedureType,'procedure') + ' p
						WHERE p.[Episode No] = ' + CONVERT(VARCHAR,@EpisodeNo) + 
						' AND p.[Patient No] = ''' + @PatientComboId + '''' 
			INSERT INTO @RepHeader EXECUTE (@SQL)
			SELECT * FROM @RepHeader        
		END
        ELSE
        BEGIN
            SELECT	ISNULL(s.[ReportHeading],o.[HospitalName]) AS ReportHeading 
					, ISNULL(s.[ReportSubHeading],'') AS ReportSubHeading
					, ISNULL(s.ReportFooter, '') as ReportFooter
                    , ISNULL(s.[ReportTrustType], 'NHS Trust') AS ReportTrustType 
                    , '' AS OpHosp
					, ISNULL((SELECT top(1) [ReportHeader] 
								FROM ERS_ProcedureTypes 
								WHERE [ProcedureTypeId]= CONVERT(VARCHAR,@ProcedureType)),'REPORT') AS ReportHeader
					, NULL AS LeftLogo
            FROM	[ERS_OperatingHospitals] o
			JOIN	[ERS_SystemConfig] s 
							on o.OperatingHospitalID = s.OperatingHospitalID
			--TFS 3714 Start
			join    [ERS_Procedures] p
							on p.OperatingHospitalID = s.OperatingHospitalID
			WHERE p.ProcedureId = @ProcedureId
			--TFS 3714 End
        END
        --print @SQL

    END
GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	3570, 3714 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ferdowsi On 18 March 2024
-- TFS#	No TFS - Item 3866 
-- Description of change
--  added stage in ERS_ProceduresReporting  table
------------------------------------------------------------------------------------------------------------------------

GO
EXEC dbo.DropIfExist 
    @ObjectName = 'procedure_staging_select', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[procedure_staging_select]
(
	@ProcedureId int
)
AS
BEGIN
	SELECT	ProcedureId,
			StagingInvestigations,
			ClinicalGrounds,
			ImagingOfThorax,
			MediastinalSampling,
			Metastases,
			PleuralHistology,
			Bronchoscopy,
			Stage,
			StageT,
			StageN,
			StageM,
			StageLocation,
			PerformanceStatus,
			PerformanceStatusType,
			Suppressed,
			WhoCreatedId,
			WhenCreated,
			WhoUpdatedId,
			WhenUpdated
	FROM ERS_ProcedureStaging 
	WHERE ProcedureId = @ProcedureId
	  AND Suppressed = 0
END



GO

EXEC dbo.DropIfExist @ObjectName = 'procedure_staging_save',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

 CREATE PROCEDURE [dbo].[procedure_staging_save]
(
	@ProcedureId INT,@StagingInvestigations BIT,
	@ClinicalGrounds BIT,
	@ImagingOfThorax BIT,
	@MediastinalSampling BIT,
	@Metastases BIT,
	@PleuralHistology BIT,
	@Bronchoscopy BIT,
	@Stage BIT,
	@StageT INT,
	@StageN INT,
	@StageM INT,
	@StageLocation INT,
	@PerformanceStatus BIT,
	@PerformanceStatusType INT,
	@Suppressed BIT,
	@LoggedInUserId INT

)
AS

SET NOCOUNT ON

BEGIN TRANSACTION

BEGIN TRY
			
	IF NOT EXISTS (SELECT 1 FROM ERS_ProcedureStaging WHERE ProcedureId = @ProcedureId)
	BEGIN
		INSERT INTO ERS_ProcedureStaging (
			ProcedureId,StagingInvestigations,
			ClinicalGrounds,
			ImagingOfThorax,
			MediastinalSampling,
			Metastases,
			PleuralHistology,
			Bronchoscopy,
			Stage,
			StageT,
			StageN,
			StageM,
			StageLocation,
			PerformanceStatus,
			PerformanceStatusType,
			Suppressed,
			WhoCreatedId,
			WhenCreated) 
		VALUES (
			@ProcedureId,
			@StagingInvestigations,
			@ClinicalGrounds,
			@ImagingOfThorax,
			@MediastinalSampling,
			@Metastases,
			@PleuralHistology,
			@Bronchoscopy,
			@Stage,
			@StageT,
			@StageN,
			@StageM,
		    @StageLocation,
			@PerformanceStatus,
			@PerformanceStatusType,
			@Suppressed,
			@LoggedInUserId,
			GETDATE())
		
		-- Do we need to update the RecordCount ?
		--INSERT INTO ERS_RecordCount (
		--	[ProcedureId],
		--	[SiteId],
		--	[Identifier],
		--	[RecordCount]
		--)
		--VALUES (
		--	@ProcedureId,
		--	NULL,
		--	'Pathology',
		--	1)
	END
	
	ELSE
	BEGIN
		UPDATE 
			ERS_ProcedureStaging
		SET 
			StagingInvestigations = @StagingInvestigations,
			ClinicalGrounds = @ClinicalGrounds,
			ImagingOfThorax = @ImagingOfThorax,
			MediastinalSampling = @MediastinalSampling,
			Metastases = @Metastases,
			PleuralHistology = @PleuralHistology,
			Bronchoscopy = @Bronchoscopy,
			Stage = @Stage,
			StageT = @StageT,
			StageN = @StageN,
			StageM = @StageM,
			StageLocation = @StageLocation,
			PerformanceStatus = @PerformanceStatus,
			PerformanceStatusType = @PerformanceStatusType,
			Suppressed = @Suppressed,
			WhoUpdatedId = @LoggedInUserId,
			WhenUpdated = GETDATE()
		WHERE 
			ProcedureId = @ProcedureId
	END

	 
			
	UPDATE ERS_ProceduresReporting
	SET PP_Indic = dbo.ProcedureIndicationsSummary(@ProcedureId)
	WHERE ProcedureId = @ProcedureId
	 
END TRY



BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;

Go
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	No TFS - Item 3866  by Ferdowsi
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Muhammad Nasim
-- TFS#	3840
-- Description of change: when adding a sit in some locations it asks you it this was anterior / postieria / both, this selection no longer need to be there
-------------------------------------------------------------------------------------------------------------------------
UPDATE [dbo].[ERS_Regions] SET is3D=0 WHERE ProcedureType in (1,6,8) 
	and Region in ('Cardia',
	'Fundus','Lesser Curve Upper Body','Upper Body','Greater Curve Upper Body',
	'Lesser Curve Middle Body',
	'Middle Body',
	'Greater Curve Middle Body',
	'Angulus',
	'Lower Body',
	'Lesser Curve Antrum',
	'Greater Curve Lower Body',
	'Antrum',
	'Greater Curve Antrum',
	'Lesser Curve Prepyloric Region',
	'Prepyloric Region',
	'Greater Curve Prepyloric Region',
	'Superior Pylorus',
	'Pylorus',
	'Inferior Pylorus',
	'Superior Bulb',
	'Bulb',
	'Inferior Bulb',
	'Lateral Wall First Part',
	'First Part',
	'Medial First Part',
	'Lateral Wall Second Part',
	'Second Part',
	'Medial Second Part',
	'Third Part',
	'GOJ')
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#3840 	(when adding a sit in some locations it asks you it this was anterior / postieria / both, this selection no longer need to be there)
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Muhammad Nasim
-- TFS#	3438 & 4078
-- Description of change: Indication option tick and then untick will fulfill the progress condition & Other indications free text box
-------------------------------------------------------------------------------------------------------------------------
GO
dbo.DropIfExist
    @ObjectName = 'procedure_indications_save',      -- varchar(100)
    @ObjectTypePrefix = 'S' -- varchar(5)

GO
SET ANSI_NULLS ON

GO
SET QUOTED_IDENTIFIER ON

GO
CREATE PROCEDURE [dbo].[procedure_indications_save]
(
	@ProcedureId int, 
	@IndicationId int, 
	@ChildIndicationId int, 
	@Selected bit,
	@AdditionalInfo varchar(max),
	@LoggedInUserId int
)
AS
BEGIN
	IF @Selected = 1
	BEGIN
		IF NOT EXISTS (SELECT 1 FROM ERS_ProcedureIndications WHERE IndicationId = @IndicationId AND ProcedureId = @ProcedureId)
		BEGIN
			INSERT INTO [dbo].[ERS_ProcedureIndications] (ProcedureId, IndicationId, ChildIndicationId, AdditionalInformation, WhoCreatedId, WhenCreated)
			VALUES (@ProcedureId, @IndicationId, @ChildIndicationId, @AdditionalInfo, @LoggedInUserId, getdate())
		END
		ELSE
		BEGIN
			UPDATE 
				ERS_ProcedureIndications 
			SET 
				IndicationId = @IndicationId,
				ChildIndicationId = @ChildIndicationId,
				AdditionalInformation = @AdditionalInfo
			WHERE 
				ProcedureId = @ProcedureId AND IndicationId = @IndicationId 
		END
	END
	ELSE
	BEGIN
		DELETE FROM ERS_ProcedureIndications WHERE ProcedureId = @ProcedureId AND IndicationId = @IndicationId 
	END
	
	DECLARE @Summary VARCHAR(max) = 'Indications: ',
			@IndicationsCount int = (SELECT count(*) FROM ERS_ProcedureIndications WHERE ProcedureId = @ProcedureId)
			

	EXEC UI_update_procedure_summary @ProcedureId, 'Indications', @Summary, @IndicationsCount
	
	/*Check if theres any indications that require child indications to be filled out NED requirement, upload will fail otherwise*/
	--IF (SELECT COUNT(*) 
	--FROM 
	--	(SELECT ep.IndicationId, 
	--			ei.ParentId, 
	--			CASE WHEN ep.IndicationId IN (SELECT ParentId FROM dbo.ERS_Indications ei2)
	--AND ISNULL(ep.ChildIndicationId,0) = 0 THEN 0 
	--				 WHEN ep.IndicationId IN (SELECT UniqueId FROM dbo.ERS_Indications ei2 WHERE ei2.AdditionalInfo = 1)
	--AND ISNULL(ep.AdditionalInformation,'') = '' THEN 0 
	--				 ELSE 1 END 'Complete'
	--	FROM dbo.ERS_ProcedureIndications ep
	--		INNER JOIN dbo.ERS_Indications ei ON ei.UniqueId = ep.IndicationId
	--	WHERE procedureid = @ProcedureId) inds
	--WHERE inds.Complete = 0) = 0
	--BEGIN
	--	EXEC UI_update_procedure_summary @ProcedureId, 'Indications', @Summary, 1
	--END
	--ELSE
	--BEGIN
	--	EXEC UI_update_procedure_summary @ProcedureId, 'Indications', @Summary, 0
	--END
	--Start TFS 3438 & 4078
	select distinct ParentId into #tblParentId from ERS_Indications where 
	ParentId in (select IndicationId from ERS_ProcedureIndications where ProcedureId=@ProcedureId)
	
	if exists( select 1 from ERS_ProcedureIndications where ProcedureId=@ProcedureId 
	and IndicationId in (select ParentId from #tblParentId) and ChildIndicationId=0)
	begin
		EXEC UI_update_procedure_summary @ProcedureId, 'Indications', @Summary, 0
	end

	if exists(
		select 1 from ERS_ProcedureIndications where len(AdditionalInformation)=0 and ProcedureId=@ProcedureId and IndicationId in (select UniqueId from ERS_Indications where 
		UniqueId in(select IndicationId from ERS_ProcedureIndications where ProcedureId=@ProcedureId) and AdditionalInfo=1)
	)
	begin
		EXEC UI_update_procedure_summary @ProcedureId, 'Indications', @Summary, 0
	end

	drop table #tblParentId
	--END of TFS 3438 & 4078

	UPDATE ERS_ProceduresReporting
	SET PP_Indic = dbo.ProcedureIndicationsSummary(@ProcedureId)
	WHERE ProcedureId = @ProcedureId
END
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS# 3438 & 4078	(Indication option tick and then untick will fulfill the progress condition & Other indications free text box)
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Siddikur Rahman
-- TFS#	3216
-- Description of change: Added Cytology to cystoscopy specimens section and lab request form
-- TFS# 1880
-- Description of change: SE V1 Bronch TRAP Biopsy naming on lab form
-------------------------------------------------------------------------------------------------------------------------
GO

IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ERS_CystoscopySpecimens' AND COLUMN_NAME = 'QunatityCytology')
BEGIN
	ALTER TABLE dbo.ERS_CystoscopySpecimens
	ADD QunatityCytology INT NULL;
END
GO

EXEC dbo.DropIfExist @ObjectName = 'TR_CystoscopySpecimens_Insert',      -- varchar(100)
                     @ObjectTypePrefix = 'TR' -- varchar(5)
GO

EXEC dbo.DropIfExist @ObjectName = 'TR_CystoscopySpecimens_Delete',      -- varchar(100)
                     @ObjectTypePrefix = 'TR' -- varchar(5)
GO

EXEC dbo.DropIfExist 
    @ObjectName = 'specimens_cystoscopy_select', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[specimens_cystoscopy_select]
(
	@SiteId INT	
)
AS

SET NOCOUNT ON


SELECT 
	sp.SiteId,
	[None],
	Qunatity,
	QunatityCytology,
	ForcepsDisposable,
	ForcepsReusable,
	ForcepsReusableSerialNumber
FROM 
	[ERS_CystoscopySpecimens] sp
JOIN
	ERS_Sites s ON sp.SiteId = s.SiteId
JOIN
	ERS_Procedures p ON s.ProcedureId = p.ProcedureId
WHERE 
	sp.SiteId = @SiteId
GO


EXEC dbo.DropIfExist 
    @ObjectName = 'specimens_cystoscopy_summary_update', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[specimens_cystoscopy_summary_update]
(
	@SiteId INT
)
AS
	SET NOCOUNT ON

	DECLARE 
		@summary VARCHAR (8000),
		@RegionId INT,
		@None BIT,
		@ForcepsDisposable BIT = NULL,
		@ForcepsReusable BIT = NULL,
		@Qunatity INT = NULL,
		@QunatityCytology INT = NULL,
		@ForcepsReusableSerialNumber varchar(50)
	
	DECLARE @tmpSummary TABLE(Val VARCHAR(MAX))
	DECLARE @XMLlist XML

	SELECT 
		@summary = '',
		@RegionId = s.RegionId,
		@None=[None],
		@ForcepsDisposable=ForcepsDisposable,
		@ForcepsReusable=ForcepsReusable,
		@Qunatity=Qunatity,
		@QunatityCytology = QunatityCytology,
		@ForcepsReusableSerialNumber=ForcepsReusableSerialNumber
	
	FROM
		ERS_CystoscopySpecimens sp
	JOIN
		ERS_Sites s ON sp.SiteId = s.SiteId
	JOIN
		ERS_Procedures p ON s.ProcedureId = p.ProcedureId
	WHERE 
		sp.SiteId = @SiteId

	IF @None = 1
		SET @summary = @summary + 'No specimens taken'
	ELSE
	BEGIN
		SET @summary = 'Cystoscopy specimen:'
		IF @Qunatity > 0 
		BEGIN
			INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @Qunatity) + ' to Histology')
		END

		IF @QunatityCytology > 0 
		BEGIN
			INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @QunatityCytology) + ' to Cytology')
		END

		IF @ForcepsDisposable > 0 
		BEGIN
			INSERT INTO @tmpSummary (Val) VALUES( 'Forceps Disposable')
		END

		IF @ForcepsReusable > 0 
		BEGIN
			INSERT INTO @tmpSummary (Val) VALUES( 'Forceps Reusable and serial number is '+convert(varchar(10), @ForcepsReusableSerialNumber))
		END

		-- Build the XML list
		SET @XMLlist = (SELECT Val FROM @tmpSummary FOR XML  RAW, ELEMENTS, TYPE)
		SET @summary = @summary + ' ' + dbo.fnBuildString(@XMLlist)
	END

	-- Finally, update the summary in specimens table
	UPDATE ERS_CystoscopySpecimens 
	SET Summary=@summary 
	WHERE SiteId = @SiteId

GO

EXEC dbo.DropIfExist 
    @ObjectName = 'specimens_cystoscopy_save', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[specimens_cystoscopy_save]
(
	@SiteId INT,
	@None BIT,
	@qunatity Int,
	@qunatityCytology INT,
	@forcepsDisposable BIT,
	@forcepsReusable BIT,
	@forcepsReusableSerialNumber NVARCHAR(100) ,
	@LoggedInUserId INT
)
AS

SET NOCOUNT ON

DECLARE @proc_id INT
DECLARE @proc_type INT

BEGIN TRANSACTION

BEGIN TRY
	SELECT 
		@proc_id = p.ProcedureId,
		@proc_type = p.ProcedureType
	FROM 
		ERS_Sites s
	JOIN 
		ERS_Procedures p ON s.ProcedureId = p.ProcedureId
	WHERE 
		SiteId = @SiteId

	IF (@None = 0 AND @qunatity = 0 AND @qunatityCytology = 0 AND @forcepsDisposable = 0 AND @forcepsReusable = 0 AND @forcepsReusableSerialNumber = 0)
	BEGIN

		DELETE FROM ERS_CystoscopySpecimens
		WHERE SiteId = @SiteId

		DELETE FROM ERS_RecordCount 
		WHERE SiteId = @SiteId
		AND Identifier = 'Specimens Taken'
	END

	ELSE
	BEGIN
		IF NOT EXISTS (SELECT 1 FROM ERS_CystoscopySpecimens WHERE SiteId = @SiteId)
		BEGIN
			INSERT INTO ERS_CystoscopySpecimens (
				SiteId,
				[None],
				qunatity,
				qunatityCytology,
				forcepsDisposable,
				forcepsReusable,
				forcepsReusableSerialNumber,
				WhoCreatedId,
				WhenCreated)
			VALUES (
				@SiteId,
				@None,
				@qunatity,
				@qunatityCytology,
				@forcepsDisposable,
				@forcepsReusable,
				@forcepsReusableSerialNumber,
				@LoggedInUserId,
				GETDATE())

			INSERT INTO ERS_RecordCount (
				[ProcedureId],
				[SiteId],
				[Identifier],
				[RecordCount]
			)
			VALUES (
				@proc_id,
				@SiteId,
				'Specimens Taken',
				1)
		END

		ELSE
		BEGIN
			UPDATE 
				ERS_CystoscopySpecimens
			SET 
				[None] = @None,
				qunatity = @qunatity,
				qunatityCytology = @qunatityCytology,
				forcepsDisposable = @forcepsDisposable,
				forcepsReusable = @forcepsReusable,
				forcepsReusableSerialNumber = @forcepsReusableSerialNumber,
				WhoUpdatedId = @LoggedInUserId,
				WhenUpdated = GETDATE()
			WHERE 
				SiteId = @SiteId
		END	

		EXEC specimens_cystoscopy_summary_update @SiteId
		
	END
	--edited by siddik tfs# 4183
	IF EXISTS (SELECT 1 FROM ERS_UpperGIFollowUp WHERE ProcedureId = @proc_id AND AwaitingPathologyResults = 1)
	BEGIN
		IF NOT EXISTS (SELECT 1 FROM ERS_CystoscopySpecimens sp JOIN ERS_Sites s ON sp.SiteId = s.SiteId WHERE s.ProcedureId = @proc_id AND None <> 1)
		BEGIN
			EXEC ogd_followup_save
				@ProcedureId = @proc_id,
				@AwaitingPathologyResults = 0,
				@LoggedInUserId = @LoggedInUserId;
		END
	END
	ELSE
	BEGIN
		IF EXISTS (SELECT 1 FROM ERS_CystoscopySpecimens sp JOIN ERS_Sites s ON sp.SiteId = s.SiteId WHERE s.ProcedureId = @proc_id AND None <> 1)
		BEGIN
			EXEC ogd_followup_save
				@ProcedureId = @proc_id,
				@AwaitingPathologyResults = 1,
				@LoggedInUserId = @LoggedInUserId;
		END
	END
	--tfs# 4183 end
END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;

GO

EXEC dbo.DropIfExist 
    @ObjectName = 'printreport_specimens_select', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[printreport_specimens_select]
(
	@ProcedureId INT
)
AS
/***************************************************************************
*****                        Change History                           *****
***************************************************************************
** Rev	Date			Author			Description 
** --	-----------		---------		---------------------------------------
** 1	15 Sep 2021		Adrian (ARS)	New Bronchs section
** 2	21 Sep 2021		Adrian (ARS)	Add new reports for Bronchs
** 3	02 Feb 2024		Steve			Updated to return area description for area marking
**************************************************************************/

SET NOCOUNT ON

DECLARE 
       @procType INT,
       @siteIdentification TINYINT,
       @siteId INT, 
       @siteNo INT,
       @siteTitle VARCHAR(3),
	   @OperatingHospitalID TINYINT
DECLARE 
       @SpecimensSummary TABLE (
              SiteId INT,
              LabRequestReportName VARCHAR(200),
              SpecimenKey VARCHAR(1000),
              Specimen VARCHAR(2000))

SELECT @procType = ProcedureType FROM ERS_Procedures WHERE ProcedureId = @ProcedureId
SELECT @OperatingHospitalID = OperatingHospitalID FROM ERS_Procedures WHERE ProcedureId = @ProcedureId


       SELECT s.SiteNo, Case @procType WHEN 1 THEN ISNULL(m.Area,'') ELSE '' END AS RegionSection, CASE WHEN s.AreaNo > 0 Then dbo.fnSetAreaDescription(@ProcedureId, s.AreaNo, p.ResectedColonNo) ELSE r.Region END AS Region, sp.*, r.RegionId
       INTO #specimens
       FROM ERS_UpperGISpecimens sp
       JOIN ERS_Sites s ON sp.SiteId = s.SiteId
       JOIN ERS_Regions r ON s.RegionId = r.RegionId
       LEFT JOIN ERS_AbnormalitiesMatrixUpperGI m ON r.Region = m.Region AND m.ProcedureType = @procType
       LEFT JOIN [ERS_AbnormalitiesMatrixERCP] n ON r.Region = n.Region AND n.ProcedureType = @procType
       LEFT JOIN [ERS_AbnormalitiesMatrixColon] o ON r.Region = o.Region AND o.ProcedureType = @procType
	   JOIN ERS_Procedures p ON p.ProcedureId = s.ProcedureId
       WHERE s.ProcedureId = @ProcedureId 

UPDATE #specimens SET RegionSection = CASE RegionSection WHEN 'Oesophagus' THEN 'oesophageal' WHEN 'Stomach' THEN 'gastric' WHEN 'Duodenum' THEN 'duodenal' ELSE '' END

--update #specimens SET Region = CASE WHEN RegionId in (SELECT ercr.RegionId FROM dbo.ERS_ResectedColon erc
--															INNER JOIN dbo.ERS_ResectedColonRegions ercr ON erc.ResectedColonID = ercr.ResectedColonID
--															INNER JOIN dbo.ERS_Procedures ep ON erc.ResectedColonID = ep.ResectedColonNo
--															WHERE ep.ProcedureId=@ProcedureId)
--											THEN 'Anastomosis'
--											ELSE Region
--											END



DECLARE Site_Cursor CURSOR FOR
SELECT SiteId, SiteNo FROM #specimens ORDER BY SiteNo
       
OPEN Site_Cursor
FETCH NEXT FROM Site_Cursor INTO @siteId , @siteNo

WHILE @@FETCH_STATUS = 0
BEGIN
       SET @siteTitle = dbo.fnGetSiteTitle(@siteNo, @OperatingHospitalID)

       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Cytology', 
              CONVERT(VARCHAR, @siteId) + 'Brush', 
              LOWER(RegionSection) + ' brushings for cytology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND BrushCytology > 0
              
       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Histology', 
              CONVERT(VARCHAR, @siteId) + 'BiopsyHistology', 
              CONVERT(VARCHAR,BiopsyQtyHistology) + ' ' + LOWER(RegionSection) + CASE WHEN BiopsyQtyHistology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for histology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND BiopsyQtyHistology > 0

       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Microbiology', 
              CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
              CONVERT(VARCHAR,BiopsyQtyMicrobiology) + ' ' + LOWER(RegionSection) + CASE WHEN BiopsyQtyMicrobiology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for microbiology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND Biopsy = 1 AND BiopsyQtyMicrobiology > 0
              
       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Virology', 
              CONVERT(VARCHAR, @siteId) + 'BiopsyVirology', 
              CONVERT(VARCHAR,BiopsyQtyVirology) + ' ' + LOWER(RegionSection) + CASE WHEN BiopsyQtyVirology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for virology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND Biopsy = 1 AND BiopsyQtyVirology > 0
       
       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Histology', 
              CONVERT(VARCHAR, @siteId) + 'Polypectomy', 
              CONVERT(VARCHAR,PolypectomyQty) + ' ' + LOWER(RegionSection) + CASE WHEN PolypectomyQty > 1 THEN ' polyps' ELSE ' polyp' END + ' for histology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND Polypectomy = 1 AND PolypectomyQty > 0

       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Histology', 
              CONVERT(VARCHAR, @siteId) + 'HotBiopsy', 
              LOWER(RegionSection) + ' hot biopsy for histology from (' + LOWER(@siteTitle) + ' ) ' + Region + CASE WHEN HotBiopsyDistance > 0 THEN ' at ' + CONVERT(VARCHAR, HotBiopsyDistance) + 'cm' ELSE '' END 
       FROM #specimens 
       WHERE SiteId = @siteId AND HotBiopsy = 1
       
       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Cytology', 
              CONVERT(VARCHAR, @siteId) + 'NeedleAspirateHistology', 
              LOWER(RegionSection) + ' needle aspirate for cytology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND NeedleAspirate = 1 AND NeedleAspirateHistology = 1

       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Histology', 
              CONVERT(VARCHAR, @siteId) + 'NeedleBiopsyHistology', 
              LOWER(RegionSection) + ' needle biopsy for histology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND FNB = 1 AND NeedleBiopsyHistology = 1

       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Cytology', 
              CONVERT(VARCHAR, @siteId) + 'NeedleBiopsyCytology', 
              LOWER(RegionSection) + ' needle biopsy for cytology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND FNB = 1 AND NeedleBiopsyCytology = 1

       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Microbiology', 
              CONVERT(VARCHAR, @siteId) + 'NeedleBiopsyMicrobiology', 
              LOWER(RegionSection) + ' needle biopsy for microbiology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND FNB = 1 AND NeedleBiopsyMicrobiology = 1

       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Virology', 
              CONVERT(VARCHAR, @siteId) + 'NeedleBiopsyVirology', 
              LOWER(RegionSection) + ' needle biopsy for virology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND FNB = 1 AND NeedleBiopsyVirology = 1


       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Microbiology', 
              CONVERT(VARCHAR, @siteId) + 'NeedleAspirateMicrobiology', 
              LOWER(RegionSection) + ' needle aspirate for microbiology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND NeedleAspirate = 1 AND NeedleAspirateMicrobiology = 1

       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Virology', 
              CONVERT(VARCHAR, @siteId) + 'NeedleAspirateVirology', 
              LOWER(RegionSection) + ' needle aspirate for virology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND NeedleAspirate = 1 AND NeedleAspirateVirology = 1

       INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Microbiology', 
              CONVERT(VARCHAR, @siteId) + 'GastricWashing', 
              'gastric washing for microbiology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimens 
       WHERE SiteId = @siteId AND GastricWashing = 1

       FETCH NEXT FROM Site_Cursor INTO @siteId, @siteNo
END
CLOSE Site_Cursor;
DEALLOCATE Site_Cursor;

--biopsy series
INSERT INTO @SpecimensSummary
SELECT 
	ess.BiopsySiteId,
	'Histology',
	convert(varchar, ess.BiopsySiteId) + 'BiopsyHistology', 
	convert(varchar, ess.qty) + CASE WHEN ess.qty = 1 THEN ' biopsy' ELSE ' biopsies' END + ' for histology from ' + ebs.Description
FROM dbo.ERS_SiteSpecimens ess
	INNER JOIN dbo.ERS_BiopsySites ebs ON ess.BiopsySiteId = ebs.UniqueId
	INNER JOIN dbo.ERS_Sites es ON ess.SiteId = es.SiteId
WHERE ProcedureId = @ProcedureId


       SELECT s.SiteNo, Case @procType WHEN 1 THEN ISNULL(m.Area,'') ELSE '' END AS RegionSection, r.Region, sp.*, r.RegionId
       INTO #specimensCysto
       FROM ERS_CystoscopySpecimens sp
       JOIN ERS_Sites s ON sp.SiteId = s.SiteId
       JOIN ERS_Regions r ON s.RegionId = r.RegionId
       LEFT JOIN ERS_AbnormalitiesMatrixUpperGI m ON r.Region = m.Region AND m.ProcedureType = @procType
       LEFT JOIN [ERS_AbnormalitiesMatrixERCP] n ON r.Region = n.Region AND n.ProcedureType = @procType
       LEFT JOIN [ERS_AbnormalitiesMatrixColon] o ON r.Region = o.Region AND o.ProcedureType = @procType
       WHERE s.ProcedureId = @ProcedureId 
 
DECLARE Site_Cursor CURSOR FOR
SELECT SiteId, SiteNo FROM #specimensCysto ORDER BY SiteNo
       
OPEN Site_Cursor
FETCH NEXT FROM Site_Cursor INTO @siteId , @siteNo

WHILE @@FETCH_STATUS = 0
BEGIN
		SET @siteTitle = dbo.fnGetSiteTitle(@siteNo, @OperatingHospitalID)

		/****************************************************************
		*							MICROBIOLOGY						*
		****************************************************************/		
		/****************************************************************
		*	Microbiology Sub-section - EBUS Specimen					*
		****************************************************************/		
		INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Histology', 
              CONVERT(VARCHAR, @siteId) + 'BiopsyCystoHistology', 
              CONVERT(VARCHAR,Qunatity) + ' ' + LOWER(RegionSection) + CASE WHEN Qunatity > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for histology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimensCysto
       WHERE SiteId = @siteId AND Qunatity > 0

	   -- TFS 3216 Start
	   INSERT INTO @SpecimensSummary
       SELECT 
              @siteId, 
              'Cytology', 
              CONVERT(VARCHAR, @siteId) + 'BiopsyCystoCytology', 
              CONVERT(VARCHAR,QunatityCytology) + ' ' + LOWER(RegionSection) + CASE WHEN QunatityCytology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for cytology from (' + LOWER(@siteTitle) + ') ' + Region
       FROM #specimensCysto
       WHERE SiteId = @siteId AND QunatityCytology > 0
	   -- TFS 3216 End

       FETCH NEXT FROM Site_Cursor INTO @siteId, @siteNo
END
CLOSE Site_Cursor;
DEALLOCATE Site_Cursor;

/****************************************************************
ARS(15/09/21) - Bronchs Section
ARS(21/09/21) - Updated for reports
****************************************************************/
SELECT s.SiteNo, '' AS RegionSection, r.Region, ebs.SiteID AS SiteId, r.RegionId, 
		ebs.EBUSTB, ebs.EBUSCytology, ebs.EBUSHistology, ebs.EBUSBacteriology, ebs.EndobronchialTB, ebs.EndobronchialHistology, ebs.EndobronchialBacteriology,
		ebs.EndobronchialVirology, ebs.EndobronchialMycology, ebs.BrushCytology, ebs.BrushBacteriology, ebs.BrushVirology, ebs.BrushMycology, ebs.DistalBlindTB,
		ebs.DistalBlindHistology, ebs.DistalBlindVirology, ebs.DistalBlindBacteriology, ebs.DistalBlindMycology, ebs.TransbronchialTB, ebs.TransbronchialHistology,
		ebs.TransbronchialBacteriology, ebs.TransbronchialVirology, ebs.TransbronchialMycology, ebs.TranstrachealHistology, ebs.TranstrachealBacteriology,
		ebs.TranstrachealVirology, ebs.TranstrachealMycology, ebs.TrapPCP, ebs.TrapTB, ebs.TrapCytology, ebs.TrapBacteriology, ebs.TrapVirology, ebs.TrapMycology,
		ebs.BALPCP, ebs.BALTB, ebs.BALCytology, ebs.BALBacteriology, ebs.BALVirology, ebs.BALMycology, ebs.BALVolInfused, ebs.BALVolRecovered, ebs.FNATB,
		ebs.FNACytology, ebs.FNABacteriology, ebs.FNAVirology, ebs.FNAMycology, ebs.FNAHistology, ebs.CryoHistology, ebs.FungalCultureMycology, ebs.Summary
       INTO #specimensBRT
       FROM dbo.ERS_BRTSpecimens AS ebs
       JOIN ERS_Sites s ON s.SiteId = ebs.SiteID
       JOIN ERS_Regions r ON s.RegionId = r.RegionId
       LEFT JOIN dbo.ERS_AbnormalitiesMatrixBRT AS eamb ON eamb.Region = r.Region AND eamb.ProcedureType = @procType
       WHERE s.ProcedureId = @ProcedureId 
	   
DECLARE Site_Cursor CURSOR FOR
SELECT SiteId, SiteNo FROM #specimensBRT ORDER BY SiteNo
       
OPEN Site_Cursor
FETCH NEXT FROM Site_Cursor INTO @siteId , @siteNo

WHILE @@FETCH_STATUS = 0
BEGIN
		SET @siteTitle = dbo.fnGetSiteTitle(@siteNo, @OperatingHospitalID)

		/****************************************************************
		*							MICROBIOLOGY						*
		****************************************************************/		
		/****************************************************************
		*	Microbiology Sub-section - EBUS Specimen					*
		****************************************************************/		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'SpecimenMicrobiology', 
            CONVERT(VARCHAR,spec.EBUSTB) + ' ' + LOWER(RegionSection) + CASE WHEN spec.EBUSTB > 1 THEN ' EBUS specimens' ELSE ' EBUS specimen' END + ' for TB bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.EBUSTB > 0
		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'SpecimenMicrobiology', 
            CONVERT(VARCHAR,spec.EBUSBacteriology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.EBUSBacteriology > 1 THEN ' specimens' ELSE ' specimen' END + ' for bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.EBUSBacteriology > 0
			   
		/****************************************************************
		*	Microbiology Sub-section - Endobronchial Biopsy				*
		****************************************************************/		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.EndobronchialTB) + ' ' + LOWER(RegionSection) + CASE WHEN spec.EndobronchialTB > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for TB bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.EndobronchialTB > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.EndobronchialBacteriology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.EndobronchialBacteriology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.EndobronchialBacteriology > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.EndobronchialVirology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.EndobronchialVirology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for virology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.EndobronchialVirology > 0
		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.EndobronchialMycology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.EndobronchialMycology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for mycology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.EndobronchialMycology > 0

		/****************************************************************
		*	Microbiology Sub-section - Brush Biopsy						*
		****************************************************************/		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.BrushBacteriology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.BrushBacteriology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.BrushBacteriology > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.BrushVirology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.BrushVirology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for virology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.BrushVirology > 0
		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.EndobronchialMycology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.EndobronchialMycology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for mycology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.EndobronchialMycology > 0

		/****************************************************************
		*	Microbiology Sub-section - Distal Blind Biopsy				*
		****************************************************************/		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.DistalBlindTB) + ' ' + LOWER(RegionSection) + CASE WHEN spec.DistalBlindTB > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for TB bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.DistalBlindTB > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.DistalBlindBacteriology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.DistalBlindBacteriology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.DistalBlindBacteriology > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.DistalBlindVirology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.DistalBlindVirology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for virology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.DistalBlindVirology > 0
		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.DistalBlindMycology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.DistalBlindMycology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for mycology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.DistalBlindMycology > 0

		/****************************************************************
		*	Microbiology Sub-section - Transbronchial Biopsy			*
		****************************************************************/		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.TransbronchialTB) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TransbronchialTB > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for TB bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TransbronchialTB > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.TransbronchialBacteriology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TransbronchialBacteriology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TransbronchialBacteriology > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.TransbronchialVirology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TransbronchialVirology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for virology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TransbronchialVirology > 0
		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.TransbronchialMycology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TransbronchialMycology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for mycology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TransbronchialMycology > 0

		/****************************************************************
		*	Microbiology Sub-section - Transtracheal Biopsy				*
		****************************************************************/		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.TranstrachealBacteriology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TranstrachealBacteriology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TranstrachealBacteriology > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.TranstrachealVirology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TranstrachealVirology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for virology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TranstrachealVirology > 0
		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.TranstrachealMycology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TranstrachealMycology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for mycology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TranstrachealMycology > 0

		/****************************************************************
		*	Microbiology Sub-section - Trap								*
		****************************************************************/
		
		------------------------------------------------------------------------------------------------------------------------
		-- TFS#	1880
		-- Description of change: Fixed Bronch TRAP Biopsy naming on lab form
		-------------------------------------------------------------------------------------------------------------------------
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            'Trap sample(s)' + ' '  + CONVERT(VARCHAR,spec.TrapTB) + ' ' + 'from TB bacteriology'
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TrapTB > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
			'Trap sample(s)' + ' '  + CONVERT(VARCHAR,spec.TrapBacteriology) + ' ' + 'from bacteriology'
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TrapBacteriology > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
			'Trap sample(s)' + ' '  + CONVERT(VARCHAR,spec.TrapVirology) + ' ' + 'from virology'
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TrapVirology > 0
		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
			'Trap sample(s)' + ' '  + CONVERT(VARCHAR,spec.TrapMycology) + ' ' + 'from mycology'
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TrapMycology > 0

		------------------------------------------------------------------------------------------------------------------------
		-- TFS#	1880 Ended
		------------------------------------------------------------------------------------------------------------------------

		/****************************************************************
		*	Microbiology Sub-section - Bronchoalveolar Lavage (BAL)		*
		****************************************************************/		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.BALTB) + ' ' + LOWER(RegionSection) + CASE WHEN spec.BALTB > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for TB bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.BALTB > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.BALBacteriology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.BALBacteriology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.BALBacteriology > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.BALVirology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.BALVirology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for virology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.BALVirology > 0
		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.BALMycology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.BALMycology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for mycology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.BALMycology > 0

		/****************************************************************
		*	Microbiology Sub-section - Fine Needle Aspirate (FNA)		*
		****************************************************************/		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.FNABacteriology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.FNABacteriology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for bacteriology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.FNABacteriology > 0

		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.FNAVirology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.FNAVirology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for virology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.FNAVirology > 0
		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.FNAMycology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.FNAMycology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for mycology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.FNAMycology > 0

		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Microbiology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyMicrobiology', 
            CONVERT(VARCHAR,spec.FungalCultureMycology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.FungalCultureMycology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for mycology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.FungalCultureMycology > 0

		/****************************************************************
		*							HISTOLOGY							*
		****************************************************************/
		/****************************************************************
		*	Histology Sub-section - EBUS Specimen						*
		****************************************************************/
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Histology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyHistology', 
            CONVERT(VARCHAR,spec.EBUSHistology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.EBUSHistology > 1 THEN ' EBUS specimens' ELSE ' EBUS specimen' END + ' for histology from (' + LOWER(@siteTitle) + ') ' + Region			
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.EBUSHistology > 0

		/****************************************************************
		*	Histology Sub-section - Endobronchial Biopsy				*
		****************************************************************/
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Histology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyHistology', 
            CONVERT(VARCHAR,spec.EndobronchialHistology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.EndobronchialHistology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for histology from (' + LOWER(@siteTitle) + ') ' + Region			
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.EndobronchialHistology > 0

		/****************************************************************
		*	Histology Sub-section - Distal Blind Biopsy					*
		****************************************************************/
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Histology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyHistology', 
            CONVERT(VARCHAR,spec.DistalBlindHistology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.DistalBlindHistology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for histology from (' + LOWER(@siteTitle) + ') ' + Region			
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.DistalBlindHistology > 0

		/****************************************************************
		*	Histology Sub-section - Transbronchial Biopsy				*
		****************************************************************/
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Histology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyHistology', 
            CONVERT(VARCHAR,spec.TransbronchialHistology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TransbronchialHistology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for histology from (' + LOWER(@siteTitle) + ') ' + Region			
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TransbronchialHistology > 0

		/****************************************************************
		*	Histology Sub-section - Transtracheal Biopsy				*
		****************************************************************/
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Histology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyHistology', 
            CONVERT(VARCHAR,spec.TranstrachealHistology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TranstrachealHistology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for histology from (' + LOWER(@siteTitle) + ') ' + Region			
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TranstrachealHistology > 0

		/****************************************************************
		*	Histology Sub-section - Fine Needle Aspirate (FNA)			*
		****************************************************************/
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Histology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyHistology', 
            CONVERT(VARCHAR,spec.FNAHistology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.FNAHistology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for histology from (' + LOWER(@siteTitle) + ') ' + Region			
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.FNAHistology > 0

		/****************************************************************
		*	Histology Sub-section - Cryobiopsy							*
		****************************************************************/		
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Histology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyHistology', 
            CONVERT(VARCHAR,spec.CryoHistology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.CryoHistology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for histology from (' + LOWER(@siteTitle) + ') ' + Region
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.CryoHistology > 0

		/****************************************************************
		*							CYTOLOGY							*
		****************************************************************/
		/****************************************************************
		*	Cytology Sub-section - EBUS Specimen						*
		****************************************************************/
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Cytology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyCytology', 
            CONVERT(VARCHAR,spec.EBUSCytology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.EBUSCytology > 1 THEN ' EBUS specimens' ELSE ' EBUS specimen' END + ' for cytology from (' + LOWER(@siteTitle) + ') ' + Region			
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.EBUSCytology > 0

		/****************************************************************
		*	Cytology Sub-section - Brush Biopsy							*
		****************************************************************/
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Cytology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyCytology', 
            CONVERT(VARCHAR,spec.BrushCytology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.BrushCytology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for cytology from (' + LOWER(@siteTitle) + ') ' + Region			
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.BrushCytology > 0

		/****************************************************************
		*	Cytology Sub-section - Trap									*
		****************************************************************/
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Cytology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyCytology', 
            CONVERT(VARCHAR,spec.TrapCytology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.TrapCytology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for cytology from (' + LOWER(@siteTitle) + ') ' + Region			
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.TrapCytology > 0

		/****************************************************************
		*	Cytology Sub-section - Bronchoalveolar Lavage (BAL)			*
		****************************************************************/
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Cytology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyCytology', 
            CONVERT(VARCHAR,spec.BALCytology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.BALCytology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for cytology from (' + LOWER(@siteTitle) + ') ' + Region			
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.BALCytology > 0

		/****************************************************************
		*	Cytology Sub-section - Fine Needle Aspirate (FNA)			*
		****************************************************************/
		INSERT INTO @SpecimensSummary
		SELECT 
            @siteId, 
            'Cytology', 
            CONVERT(VARCHAR, @siteId) + 'BiopsyCytology', 
            CONVERT(VARCHAR,spec.FNACytology) + ' ' + LOWER(RegionSection) + CASE WHEN spec.FNACytology > 1 THEN ' biopsies' ELSE ' biopsy' END + ' for cytology from (' + LOWER(@siteTitle) + ') ' + Region			
		FROM #specimensBRT AS spec
		WHERE SiteId = @siteId AND spec.FNACytology > 0
	   
       FETCH NEXT FROM Site_Cursor INTO @siteId, @siteNo
END
CLOSE Site_Cursor;
DEALLOCATE Site_Cursor;

IF OBJECT_ID('tempdb..#specimens') IS NOT NULL DROP TABLE #specimens 
IF OBJECT_ID('tempdb..#specimensBRT') IS NOT NULL DROP TABLE #specimensBRT
SELECT * FROM @SpecimensSummary

GO

dbo.DropIfExist
    @ObjectName = 'specimens_brt_summary_update',
    @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[specimens_brt_summary_update]
(
	@SiteId INT
)
AS
	SET NOCOUNT ON

	DECLARE 
		@summary VARCHAR (8000),
		@RegionId INT,
		@None BIT,
		@EBUSTB INT = NULL,
		@EBUSHistology INT = NULL,
		@EBUSCytology INT = NULL,
		@EBUSBacteriology INT = NULL,
		@EndobronchialTB INT = NULL,
		@EndobronchialHistology INT = NULL,
		@EndobronchialBacteriology INT = NULL,
		@EndobronchialVirology INT = NULL,
		@EndobronchialMycology INT = NULL,
		@BrushCytology INT = NULL,
		@BrushBacteriology INT = NULL,
		@BrushVirology INT = NULL,
		@BrushMycology INT = NULL,
		@DistalBlindTB INT = NULL,
		@DistalBlindHistology INT = NULL,
		@DistalBlindBacteriology INT = NULL,
		@DistalBlindVirology INT = NULL,
		@DistalBlindMycology INT = NULL,
		@TransbronchialTB INT = NULL,
		@TransbronchialHistology INT = NULL,
		@TransbronchialBacteriology INT = NULL,
		@TransbronchialVirology INT = NULL,
		@TransbronchialMycology INT = NULL,
		@TranstrachealHistology INT = NULL,
		@TranstrachealBacteriology INT = NULL,
		@TranstrachealVirology INT = NULL,
		@TranstrachealMycology INT = NULL,
		@TrapPCP INT = NULL,
		@TrapTB INT = NULL,
		@TrapCytology INT = NULL,
		@TrapBacteriology INT = NULL,
		@TrapVirology INT = NULL,
		@TrapMycology INT = NULL,
		@BALPCP INT = NULL,
		@BALTB INT = NULL,
		@BALCytology INT = NULL,
		@BALBacteriology INT = NULL,
		@BALVirology INT = NULL,
		@BALMycology INT = NULL,
		@BALVolInfused DECIMAL(6,2),
		@BALVolRecovered DECIMAL(6,2),
		@FNATB INT = NULL,
		@FNACytology INT = NULL,
		@FNABacteriology INT = NULL,
		@FNAVirology INT = NULL,
		@FNAMycology INT = NULL,
		@FNAHistology INT = NULL,
		@CryoHistology INT,
		@FungalCultureMycology INT = NULL
	
	DECLARE @tmpSummary TABLE(Val VARCHAR(MAX))
	DECLARE @XMLlist XML

	SELECT 
		@summary = '',
		@RegionId = s.RegionId,
		@None=[None],
		@EBUSTB=EBUSTB,
		@EBUSHistology=EBUSHistology,
		@EBUSCytology=EBUSCytology,
		@EBUSBacteriology=EBUSBacteriology,
		@EndobronchialTB=EndobronchialTB,
		@EndobronchialHistology=EndobronchialHistology,
		@EndobronchialBacteriology=EndobronchialBacteriology,
		@EndobronchialVirology=EndobronchialVirology,
		@EndobronchialMycology=EndobronchialMycology,
		@BrushCytology=BrushCytology,
		@BrushBacteriology=BrushBacteriology,
		@BrushVirology=BrushVirology,
		@BrushMycology=BrushMycology,
		@DistalBlindTB=DistalBlindTB,
		@DistalBlindHistology=DistalBlindHistology,
		@DistalBlindBacteriology=DistalBlindBacteriology,
		@DistalBlindVirology=DistalBlindVirology,
		@DistalBlindMycology=DistalBlindMycology,
		@TransbronchialTB=TransbronchialTB,
		@TransbronchialHistology=TransbronchialHistology,
		@TransbronchialBacteriology=TransbronchialBacteriology,
		@TransbronchialVirology=TransbronchialVirology,
		@TransbronchialMycology=TransbronchialMycology,
		@TranstrachealHistology=TranstrachealHistology,
		@TranstrachealBacteriology=TranstrachealBacteriology,
		@TranstrachealVirology=TranstrachealVirology,
		@TranstrachealMycology=TranstrachealMycology,
		@TrapPCP=TrapPCP,
		@TrapTB=TrapTB,
		@TrapCytology=TrapCytology,
		@TrapBacteriology=TrapBacteriology,
		@TrapVirology=TrapVirology,
		@TrapMycology=TrapMycology,
		@BALPCP=BALPCP,
		@BALTB=BALTB,
		@BALCytology=BALCytology,
		@BALBacteriology=BALBacteriology,
		@BALVirology=BALVirology,
		@BALMycology=BALMycology,
		@BALVolInfused=BALVolInfused,
		@BALVolRecovered=BALVolRecovered,
		@FNATB=FNATB,
		@FNACytology=FNACytology,
		@FNABacteriology=FNABacteriology,
		@FNAVirology=FNAVirology,
		@FNAMycology=FNAMycology,
		@FNAHistology=FNAHistology,
		@CryoHistology=CryoHistology,
		@FungalCultureMycology = FungalCultureMycology
	FROM
		ERS_BRTSpecimens sp
	JOIN
		ERS_Sites s ON sp.SiteId = s.SiteId
	JOIN
		ERS_Procedures p ON s.ProcedureId = p.ProcedureId
	WHERE 
		sp.SiteId = @SiteId

	IF @None = 1
		SET @summary = @summary + 'No specimens taken'
	ELSE
	BEGIN
		IF @EBUSTB > 0 OR @EBUSHistology > 0 OR @EBUSCytology > 0 OR @EBUSBacteriology > 0
		BEGIN
			IF @EBUSTB > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @EBUSTB) + ' to TB bacteriology')
			IF @EBUSHistology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @EBUSHistology) + ' to histology')
			IF @EBUSCytology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @EBUSCytology) + ' to cytology')
			IF @EBUSBacteriology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @EBUSBacteriology) + ' to bacteriology')

			SET @XMLlist = (SELECT Val FROM @tmpSummary FOR XML  RAW, ELEMENTS, TYPE)
			SET @summary = 'EBUS specimen: ' + dbo.fnBuildString(@XMLlist)
		END

		IF @EndobronchialTB > 0 OR @EndobronchialHistology > 0 OR @EndobronchialBacteriology > 0 OR @EndobronchialVirology > 0 OR @EndobronchialMycology > 0
		BEGIN
			DELETE FROM @tmpSummary
			IF @summary <> '' SET @summary = @summary + '<br/>'
			IF @EndobronchialTB > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @EndobronchialTB) + ' to TB bacteriology')
			IF @EndobronchialHistology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @EndobronchialHistology) + ' to histology')
			IF @EndobronchialBacteriology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @EndobronchialBacteriology) + ' to bacteriology')
			IF @EndobronchialVirology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @EndobronchialVirology) + ' to virology')
			IF @EndobronchialMycology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @EndobronchialMycology) + ' to mycology')

			SET @XMLlist = (SELECT Val FROM @tmpSummary FOR XML  RAW, ELEMENTS, TYPE)
			SET @summary = @summary + 'Endobronchial biopsy: ' + dbo.fnBuildString(@XMLlist)
		END

		IF @BrushCytology > 0 OR @BrushBacteriology > 0 OR @BrushVirology > 0 OR @BrushMycology > 0
		BEGIN
			DELETE FROM @tmpSummary
			IF @summary <> '' SET @summary = @summary + '<br/>'
			IF @BrushCytology > 0  INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @BrushCytology) + ' to cytology')
			IF @BrushBacteriology > 0  INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @BrushBacteriology) + ' to bacteriology')
			IF @BrushVirology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @BrushVirology) + ' to virology')
			IF @BrushMycology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @BrushMycology) + ' to mycology')

			SET @XMLlist = (SELECT Val FROM @tmpSummary FOR XML  RAW, ELEMENTS, TYPE)
			SET @summary = @summary + 'Brush biopsy: ' + dbo.fnBuildString(@XMLlist)
		END

		IF @DistalBlindTB > 0 OR @DistalBlindHistology > 0 OR @DistalBlindBacteriology > 0 OR @DistalBlindVirology > 0 OR @DistalBlindMycology > 0
		BEGIN
			DELETE FROM @tmpSummary
			IF @summary <> '' SET @summary = @summary + '<br/>'
			IF @DistalBlindTB > 0  INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @DistalBlindTB) + ' to TB bacteriology')
			IF @DistalBlindHistology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @DistalBlindHistology) + ' to histology')
			IF @DistalBlindBacteriology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @DistalBlindBacteriology) + ' to bacteriology')
			IF @DistalBlindVirology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @DistalBlindVirology) + ' to virology')
			IF @DistalBlindMycology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @DistalBlindMycology) + ' to mycology')

			SET @XMLlist = (SELECT Val FROM @tmpSummary FOR XML  RAW, ELEMENTS, TYPE)
			SET @summary = @summary + 'Distal blind biopsy: ' + dbo.fnBuildString(@XMLlist)
		END

		IF @TransbronchialTB > 0 OR @TransbronchialHistology > 0 OR @TransbronchialBacteriology > 0 OR @TransbronchialVirology > 0 OR @TransbronchialMycology > 0
		BEGIN
			DELETE FROM @tmpSummary
			IF @summary <> '' SET @summary = @summary + '<br/>'
			IF @TransbronchialTB > 0  INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @TransbronchialTB) + ' to TB bacteriology')
			IF @TransbronchialHistology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @TransbronchialHistology) + ' to histology')
			IF @TransbronchialBacteriology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @TransbronchialBacteriology) + ' to bacteriology')
			IF @TransbronchialVirology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @TransbronchialVirology) + ' to virology')
			IF @TransbronchialMycology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @TransbronchialMycology) + ' to mycology')

			SET @XMLlist = (SELECT Val FROM @tmpSummary FOR XML  RAW, ELEMENTS, TYPE)
			SET @summary = @summary + 'Transbronchial biopsy: ' + dbo.fnBuildString(@XMLlist)
		END

		IF @TranstrachealHistology > 0 OR @TranstrachealBacteriology > 0 OR @TranstrachealVirology > 0 OR @TranstrachealMycology > 0
		BEGIN
			DELETE FROM @tmpSummary
			IF @summary <> '' SET @summary = @summary + '<br/>'
			IF @TranstrachealHistology > 0  INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @TranstrachealHistology) + ' to histology')
			IF @TranstrachealBacteriology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @TranstrachealBacteriology) + ' to bacteriology')
			IF @TranstrachealVirology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @TranstrachealVirology) + ' to virology')
			IF @TranstrachealMycology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @TranstrachealMycology) + ' to mycology')

			SET @XMLlist = (SELECT Val FROM @tmpSummary FOR XML  RAW, ELEMENTS, TYPE)
			SET @summary = @summary + 'Transtracheal biopsy: ' + dbo.fnBuildString(@XMLlist)
		END

		IF @TrapPCP > 0 OR @TrapTB > 0 OR @TrapCytology > 0 OR @TrapBacteriology > 0 OR @TrapVirology > 0 OR @TrapMycology > 0
		BEGIN
			DELETE FROM @tmpSummary
			IF @summary <> '' SET @summary = @summary + '<br/>'
			IF @TrapPCP > 0  INSERT INTO @tmpSummary (Val) VALUES(CONVERT(VARCHAR, @TrapPCP) + ' ' + 'from PCP mycology')
			IF @TrapTB > 0  INSERT INTO @tmpSummary (Val) VALUES(CONVERT(VARCHAR, @TrapTB) + ' ' + 'from TB bacteriology')
			IF @TrapCytology > 0 INSERT INTO @tmpSummary (Val) VALUES(CONVERT(VARCHAR, @TrapCytology) + ' ' + 'from cytology')
			IF @TrapBacteriology > 0 INSERT INTO @tmpSummary (Val) VALUES(CONVERT(VARCHAR, @TrapBacteriology) + ' ' + 'from bacteriology')
			IF @TrapVirology > 0 INSERT INTO @tmpSummary (Val) VALUES(CONVERT(VARCHAR, @TrapVirology) + ' ' + 'from virology')
			IF @TrapMycology > 0 INSERT INTO @tmpSummary (Val) VALUES(CONVERT(VARCHAR, @TrapMycology) + ' ' + 'from mycology')

			SET @XMLlist = (SELECT Val FROM @tmpSummary FOR XML  RAW, ELEMENTS, TYPE)
			SET @summary = @summary + 'Trap sample(s): ' + dbo.fnBuildString(@XMLlist)
		END

		IF @BALPCP > 0 OR @BALTB > 0 OR @BALCytology > 0 OR @BALBacteriology > 0 OR @BALVirology > 0 OR @BALMycology > 0 OR @BALVolInfused > 0 OR @BALVolRecovered > 0
		BEGIN
			DELETE FROM @tmpSummary
			IF @summary <> '' SET @summary = @summary + '<br/>'
			IF @BALPCP > 0  INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @BALPCP) + ' to PCP mycology')
			IF @BALTB > 0  INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @BALTB) + ' to TB bacteriology')
			IF @BALCytology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @BALCytology) + ' to cytology')
			IF @BALBacteriology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @BALBacteriology) + ' to bacteriology')
			IF @BALVirology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @BALVirology) + ' to virology')
			IF @BALMycology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @BALMycology) + ' to mycology')
			IF @BALVolInfused > 0 INSERT INTO @tmpSummary (Val) VALUES('Volume infused (' + dbo.fnRemoveDecTrailingZeroes(@BALVolInfused) + ' mls)')
			IF @BALVolRecovered > 0 INSERT INTO @tmpSummary (Val) VALUES('Volume recovered (' + dbo.fnRemoveDecTrailingZeroes(@BALVolRecovered) + ' mls)')

			SET @XMLlist = (SELECT Val FROM @tmpSummary FOR XML  RAW, ELEMENTS, TYPE)
			SET @summary = @summary + 'Bronchoalveolar Lavage: ' + dbo.fnBuildString(@XMLlist)
		END

		IF @FNATB > 0 OR @FNACytology > 0 OR @FNABacteriology > 0 OR @FNAVirology > 0 OR @FNAMycology > 0 OR @FNAHistology > 0
		BEGIN
			DELETE FROM @tmpSummary
			IF @summary <> '' SET @summary = @summary + '<br/>'
			IF @FNATB > 0  INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @FNATB) + ' to TB bacteriology')
			IF @FNAHistology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @FNAHistology) + ' to Histology')
			IF @FNACytology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @FNACytology) + ' to cytology')
			IF @FNABacteriology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @FNABacteriology) + ' to bacteriology')
			IF @FNAVirology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @FNAVirology) + ' to virology')
			IF @FNAMycology > 0 INSERT INTO @tmpSummary (Val) VALUES(convert(varchar(10), @FNAMycology) + ' to mycology')
			

			SET @XMLlist = (SELECT Val FROM @tmpSummary FOR XML  RAW, ELEMENTS, TYPE)
			SET @summary = @summary + 'Fine needle aspirate: ' + dbo.fnBuildString(@XMLlist)
		END

		IF @CryoHistology > 0
		BEGIN
			IF @summary <> '' SET @summary = @summary + '<br/>'
			SET @summary = @summary + 'Cryobiopsy: ' + convert(varchar(10), @CryoHistology) + ' to histology'
		END

		
		IF @FungalCultureMycology > 0
		BEGIN
			IF @summary <> '' SET @summary = @summary + '<br/>'
			SET @summary = @summary + 'Fungal culture: ' + convert(varchar(10), @FungalCultureMycology) + ' to bacteriology'
		END
	END 
		
	-- Finally, update the summary in specimens table
	UPDATE ERS_BRTSpecimens 
	SET Summary=@summary 
	WHERE SiteId = @SiteId

GO

------------------------------------------------------------------------------------------------------------------------
-- TFS#	3216 Ended
------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rony
-- TFS#	2816
-- Description of change
-- Multi trust sites adding a scope to all hospitals
------------------------------------------------------------------------------------------------------------------------
GO
EXEC dbo.DropIfExist 
    @ObjectName = 'scopes_GetOperatingHospitalForScopes', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[scopes_GetOperatingHospitalForScopes](
	@ScopeId int,
	@TrustId int
)
as
begin
	SELECT OH.HospitalName,OH.OperatingHospitalId,SOH.ScopeId 
	From ERS_OperatingHospitals OH 
	LEFT JOIN ERS_ScopeOperatingHospitals SOH On OH.OperatingHospitalId = SOH.OperatingHospitalId and SOH.ScopeId = @ScopeId 
	WHERE OH.TrustId= @TrustId
end
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	2816
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rezaul Karim
-- TFS#	4092
-- Description of change: Scope 1 must be mandatory
-------------------------------------------------------------------------------------------------------------------------

GO
dbo.DropIfExist
    @ObjectName = 'procedure_instruments_save',
    @ObjectTypePrefix = 'S' -- varchar(5)
GO
 
CREATE PROCEDURE [dbo].[procedure_instruments_save]
(
	@ProcedureId int,
	@Instrument1Id int,
	@Instrument2Id int,
	@ScopeGuideUsed bit
)
AS
BEGIN
	UPDATE ERS_Procedures 
	SET 
		Instrument1 = NULLIF(@Instrument1Id,0), 
		Instrument2 = NULLIF(@Instrument2Id, 0), 
		ScopeGuide = @ScopeGuideUsed
	WHERE ProcedureId = @ProcedureId

	DECLARE @SectionId int, @Summary varchar(max)

	
	/*Scope*/
	SET @Summary = 'Scopes:'
	IF @Instrument1Id > 0 
	BEGIN
		EXEC UI_update_procedure_summary @ProcedureId, 'Scopes', @Summary, @Instrument1Id
	END
	--ELSE IF @Instrument2Id > 0 
	--	EXEC UI_update_procedure_summary @ProcedureId, 'Scopes', @Summary, @Instrument2Id
	ELSE
		EXEC UI_update_procedure_summary @ProcedureId, 'Scopes', @Summary, 0

	--update reporting field for summary report
	DECLARE @InstrumentTxt varchar(200) = '', @Instru1Text varchar(200) = '', @Instru2Text varchar(200) = ''

	IF ISNULL(@Instrument1Id,0) > 0
		SELECT @Instru1Text = ScopeName FROM ERS_Scopes WHERE ScopeId = @Instrument1Id
	
	IF ISNULL(@Instrument2Id,0) > 0
		SELECT @Instru2Text = ScopeName FROM ERS_Scopes WHERE ScopeId = @Instrument2Id 
			
	--accessVia Part

	IF @ProcedureId IN (SELECT @ProcedureId  FROM ERS_Procedures WHERE ProcedureType IN (10, 11))
	BEGIN
		Select @Instru2Text = 'Access Via : ' + ListItemText
	FROM ers_lists WHERE ListItemNo=@Instrument2Id And ListDescription='AccessMethod Thoracic'
	END

	--accessVia Part
	
	If @Instru1Text <> '' 
		SET @InstrumentTxt = @Instru1Text

	
	If @Instru2Text <> '' 
		SET @InstrumentTxt = @InstrumentTxt + '<br /> ' + @Instru2Text

	IF @Instru1Text <> '' OR @Instru2Text <> ''
	BEGIN
		--transnasal check
		IF EXISTS (SELECT 1 FROM dbo.ERS_Procedures WHERE ProcedureId = @ProcedureId AND Transnasal = 1)
		BEGIN	
			SET @InstrumentTxt = @InstrumentTxt + ' (transnasal) '
		END

		UPDATE ERS_ProceduresReporting SET PP_Instrument = @InstrumentTxt WHERE ProcedureId = @ProcedureId
	END
END
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#4092 	Scope 1 must be mandatory
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rezaul Karim
-- TFS#	4053
-- Description of change: OGD - Gastritus abnormality 

-- Updated by	:	Ahmed Shoud
-- TFS#	3647
-- Description of change: abnormalities can select 'None' & an abnormality  
-------------------------------------------------------------------------------------------------------------------------
GO
dbo.DropIfExist
    @ObjectName = 'abnormalities_gastritis_summary_update',
    @ObjectTypePrefix = 'S' -- varchar(5)
GO


CREATE PROCEDURE [dbo].[abnormalities_gastritis_summary_update]
(
	@SiteId INT
)
AS
	SET NOCOUNT ON
	
	DECLARE @summary VARCHAR (8000)
	SET @summary=''

	SELECT * INTO #gastritis
	FROM ERS_UpperGIAbnoGastritis 
	WHERE SiteId = @SiteId

	SELECT 
		GastritisItem,
		CASE GastritisItem 
			WHEN 'FlatErosive' THEN 'flat erosive' 
			WHEN 'RaisedErosive' THEN 'raised erosive' 
			WHEN 'RugalHyperplastic' THEN 'rugal hyperplastic' 
			WHEN 'PromAreaeGastricae' THEN 'prom areae gastricae' 
			WHEN 'CorrosiveBurns' THEN 'corrosive ingestion burns' 
			WHEN 'Atrophic' THEN 'Gastric atrophy' 
			WHEN 'IntestinalMetaplasia' THEN 'Gastric intestinal metaplasia'
			WHEN 'None' THEN 'None' -- TFS 3647
			ELSE LOWER(GastritisItem) COLLATE Latin1_General_CI_AS
		END AS GastritisItemDesc, 
		Selected
		INTO #main
	FROM 
	(
		SELECT * FROM #gastritis
	) a
	UNPIVOT
	(
		Selected 
		FOR GastritisItem IN ([None],Erythematous,FlatErosive,RaisedErosive,Atrophic,Haemorrhagic,Reflux,
								RugalHyperplastic,Vomiting,PromAreaeGastricae,CorrosiveBurns, IntestinalMetaplasia)
	) b
	WHERE Selected = 1

	SELECT 
		GastritisSeverity, GastritisSeveritySelected
		INTO #sev
	FROM 
	(
		SELECT * FROM #gastritis
	) a
	UNPIVOT
	(
		GastritisSeveritySelected 
		FOR GastritisSeverity IN (ErythematousSeverity,FlatErosiveSeverity, RaisedErosiveSeverity,AtrophicSeverity,HaemorrhagicSeverity,
									RefluxSeverity,RugalHyperplasticSeverity,VomitingSeverity,PromAreaeGastricaeSeverity,CorrosiveBurnsSeverity, IntestinalMetaplasiaSeverity)
	) c
	WHERE ISNULL(GastritisSeveritySelected,0) <> 0
	
	SELECT 
		GastritisBleeding, GastritisBleedingSelected
		INTO #bld
	FROM 
	(
		SELECT * FROM #gastritis
	) a
	UNPIVOT
	(
		GastritisBleedingSelected 
		FOR GastritisBleeding IN (ErythematousBleeding,FlatErosiveBleeding,RaisedErosiveBleeding,AtrophicBleeding,HaemorrhagicBleeding,
									RefluxBleeding,RugalHyperplasticBleeding,VomitingBleeding,CorrosiveBurnsBleeding)
	) c
	WHERE ISNULL(GastritisBleedingSelected,0) <> 0
	
	--SELECT * from #main
	--SELECT * from #sev
	--SELECT * from #bld

	SELECT 
		GastritisItem, 
		c.codekey as GastritisSeverity, 
		c2.codekey as GastritisBleeding, 
		ISNULL(c.codekey,'') + ' ' + GastritisItemDesc +  ISNULL(' with ' + CASE c2.codekey WHEN 'None' THEN 'no' ELSE LOWER(c2.codekey) END + ' bleeding','') AS summary
	INTO #final
	FROM #main a 
	LEFT JOIN #sev b on a.GastritisItem + 'Severity' = b.GastritisSeverity
	LEFT JOIN #bld b2 on a.GastritisItem + 'Bleeding' = b2.GastritisBleeding
	LEFT JOIN ERS_Codes c on b.GastritisSeveritySelected = c.codevalue AND c.code='GastritisSeverity'
	LEFT JOIN ERS_Codes c2 on b2.GastritisBleedingSelected = c2.codevalue AND c2.code='GastritisBleeding'

	--select * from #final

	IF (SELECT COUNT(*) FROM #final) > 1
	BEGIN
		-- Get the concatenated string separated by a delimiter, say $$
		SELECT @summary = COALESCE (
							CASE WHEN @summary = '' THEN summary
							ELSE @summary + '$$' + summary
							END
						,'')
		FROM #final
		r
		-- Set the last occurence of $$ to "and"
		SET @summary = STUFF(@summary, len(@summary) - charindex('$$', reverse(@summary)), 2, ' and ')

		-- Replace all other occurences of $$ with commas
		SET @summary = REPLACE(@summary, '$$', ', ')
	END

	ELSE
	BEGIN
		SELECT @summary = summary FROM #final
	END
	SET @summary = LTRIM(RTRIM(@summary)) -- TFS 3647

	--TFS-4053--START
	IF EXISTS (SELECT * FROM #gastritis WHERE Atrophic = 1)
	BEGIN
    SELECT @summary = @summary + '.Inspection time : '+
        CAST(DATEDIFF(MINUTE, GastricInSpectionStartDateTime, GastricInSpectionEndDateTime) AS VARCHAR(10)) + ' minutes'
    FROM #gastritis
	END
	--TFS-4053--END
--SET @summary = LEFT(UPPER(@summary), 1) + RIGHT(LOWER(@summary), LEN(@summary)-1)
	--select @summary
	
	-- Finally, update the summary in gastritis table
	UPDATE ERS_UpperGIAbnoGastritis 
	SET Summary=@summary 
	WHERE SiteId = @SiteId

	DROP TABLE #gastritis
	DROP TABLE #main
	DROP TABLE #sev
	DROP TABLE #bld
	DROP TABLE #final
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#4053 	OGD - Gastritus abnormality 
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rezaul Karim
-- TFS#	2958
-- Description of change: Fundic gland polyp reported as "tumour" on pdf report
-------------------------------------------------------------------------------------------------------------------------
GO
dbo.DropIfExist
    @ObjectName = 'abnormalities_common_lesions_summary_update',
    @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[abnormalities_common_lesions_summary_update]
(
	@SiteId INT
)
AS
SET NOCOUNT ON
	
DECLARE 
	@summary VARCHAR (8000),
	@tempsummary VARCHAR (1000),
	@None BIT,
	@Polyp BIT,

	@Sessile BIT,
	@SessileQuantity INT,
	@SessileLargest INT,
	@SessileExcised INT,
	@SessileRetrieved INT,
	@SessileToLabs INT,
	@SessileRemoval TINYINT,
	@SessileRemovalMethod TINYINT,
	@SessileProbably BIT,
	@SessileType TINYINT,
	@SessileParisClass TINYINT,
	@SessilePitPattern TINYINT,
	@Pedunculated BIT,
	@PedunculatedQuantity INT,
	@PedunculatedLargest INT,
	@PedunculatedExcised INT,
	@PedunculatedRetrieved INT,
	@PedunculatedToLabs INT,
	@PedunculatedRemoval TINYINT,
	@PedunculatedRemovalMethod TINYINT,
	@PedunculatedProbably BIT,
	@PedunculatedType TINYINT,
	@PedunculatedParisClass TINYINT,
	@PedunculatedPitPattern TINYINT,
	@Pseudopolyps BIT,
	@PseudopolypsMultiple BIT,
	@PseudopolypsQuantity INT,
	@PseudopolypsLargest INT,
	@PseudopolypsExcised INT,
	@PseudopolypsRetrieved INT,
	@PseudopolypsToLabs INT,
	@PseudopolypsInflam BIT,
	@PseudopolypsPostInflam BIT,
	@PseudopolypsRemoval TINYINT,
	@PseudopolypsRemovalMethod TINYINT,
	@Submucosal BIT,
	@SubmucosalQuantity INT,
	@SubmucosalLargest INT,
	@SubmucosalProbably BIT,
	@SubmucosalTypeId TINYINT,
	@Focal BIT,
	@FocalQuantity INT,
	@FocalLargest INT,
	@FocalProbably BIT,
	@FocalTypeId TINYINT,
	@Villous BIT,
	@VillousQuantity INT,
	@VillousLargest INT,
	@VillousProbably BIT,
	@VillousType TINYINT,
	@Ulcerative BIT,
	@UlcerativeQuantity INT,
	@UlcerativeLargest INT,
	@UlcerativeProbably BIT,
	@UlcerativeType TINYINT,
	@Stricturing BIT,
	@StricturingQuantity INT,
	@StricturingLargest INT,
	@StricturingProbably BIT,
	@StricturingType TINYINT,
	@Polypoidal BIT,
	@PolypoidalQuantity INT,
	@PolypoidalLargest INT,
	@PolypoidalProbably BIT,
	@PolypoidalType TINYINT,
	@Granuloma BIT,
	@GranulomaQuantity INT,
	@GranulomaLargest INT,
	@Dysplastic BIT,
	@DysplasticQuantity INT,
	@DysplasticLargest INT,
	@PneumatosisColi BIT,
	@Tattooed BIT,
	@PreviouslyTattooed BIT,
	@TattooType INT,
	@TattooedQty INT,
	@FundicGlandPolyp BIT,
	@FundicGlandPolypQuantity INT,
	@FundicGlandPolypLargest Numeric(18,2),
	@PreviousESDScar BIT

SET @summary = ''
SET @tempsummary = ''

SELECT 
	@None=[None],
	@Polyp = Polyp,
	@Submucosal = Submucosal,
	@SubmucosalTypeId = SubmucosalTumourTypeId,
	@SubmucosalLargest = SubmucosalLargest,
	@SubmucosalProbably = SubmucosalProbably,
	@SubmucosalQuantity = SubmucosalQuantity,
	@Focal = Focal,
	@FocalTypeId = FocalTumourTypeId,
	@FocalLargest = FocalLargest,
	@FocalProbably = FocalProbably,
	@FocalQuantity = FocalQuantity,
	@Granuloma=Granuloma,
	@GranulomaQuantity=GranulomaQuantity,
	@GranulomaLargest=GranulomaLargest,
	@Dysplastic=Dysplastic,
	@DysplasticQuantity=DysplasticQuantity,
	@DysplasticLargest=DysplasticLargest,
	@PneumatosisColi=PneumatosisColi,
	@Tattooed = Tattooed,
	@PreviouslyTattooed = PreviouslyTattooed,
	@TattooType = TattooType,
	@TattooedQty = TattooedQuantity,
	@FundicGlandPolyp = FundicGlandPolyp,
	@FundicGlandPolypQuantity = FundicGlandPolypQuantity,
	@FundicGlandPolypLargest = FundicGlandPolypLargest,
	@PreviousESDScar = PreviousESDScar
FROM
	ERS_CommonAbnoLesions
WHERE
	SiteId = @SiteId

SET @Summary = ''

IF NOT EXISTS (SELECT 1 FROM ERS_CommonAbnoLesions WHERE SiteId = @SiteId) return

IF @None = 1 SET @summary = 'No lesions'

ELSE
BEGIN
	--saves calling the table multiple times :)
	DECLARE @TumourTypes TABLE (TypeId int, [Description] varchar(100))
	INSERT INTO @TumourTypes
	SELECT UniqueId, [Description] 
	FROM ERS_TumourTypes 
	WHERE Suppressed = 0
	------------------------------------------------------------------------------------------
	-------	TUMOUR: VILLOUS -------
	------------------------------------------------------------------------------------------
	IF @Villous > 0
	BEGIN
		IF @summary <> '' SET @summary = @summary + '##'

		IF @VillousQuantity > 1 SET @summary = @summary + CONVERT(VARCHAR(20), @VillousQuantity) + ' '
		ELSE SET @summary = @summary + 'A '
		
		IF @VillousProbably = 1 SET @summary = @summary + 'probably '

		IF @VillousType = 1 SET @summary = @summary + 'benign '
		ELSE IF @VillousType = 2 SET @summary = @summary + 'malignant '

		IF @VillousQuantity > 1 SET @summary = @summary + 'villous tumours ' ELSE SET @summary = @summary + 'villous tumour ' 

		IF (@VillousQuantity > 0 AND @VillousLargest > 0) 
		BEGIN
			IF @VillousQuantity > 1
				SET @summary = @summary + '(largest ' + CONVERT(VARCHAR(20), @VillousLargest) + 'mm) '
			ELSE
				SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @VillousLargest) + 'mm) '
		END
	END

	------------------------------------------------------------------------------------------
	-------	TUMOUR: ULCERATIVE -------
	------------------------------------------------------------------------------------------
	IF @Ulcerative > 0
	BEGIN
		DECLARE @UlcerSummary VARCHAR(300) = ''
		IF @summary <> '' SET @summary = @summary + '##'

		IF @UlcerativeQuantity > 1 SET @UlcerSummary = @UlcerSummary + CONVERT(VARCHAR(20), @UlcerativeQuantity) + ' '
		
		IF @UlcerativeProbably = 1 SET @UlcerSummary = @UlcerSummary + 'probably '

		IF @UlcerativeType = 1 SET @UlcerSummary = @UlcerSummary + 'benign '
		ELSE IF @UlcerativeType = 2 SET @UlcerSummary = @UlcerSummary + 'malignant '

		IF @UlcerativeQuantity > 1 SET @UlcerSummary = @UlcerSummary + 'ulcerative tumours ' ELSE SET @UlcerSummary = @UlcerSummary + 'ulcerative tumour ' 

		IF LEFT(@UlcerSummary,1) = 'u' SET @UlcerSummary =  'An ' + @UlcerSummary
		ELSE IF ISNULL(@UlcerativeQuantity,0) <= 1 SET @UlcerSummary =  'A ' + @UlcerSummary

		IF (@UlcerativeQuantity > 0 AND @UlcerativeLargest > 0) 
		BEGIN
			IF @UlcerativeQuantity > 1
				SET @UlcerSummary = @UlcerSummary + '(largest ' + CONVERT(VARCHAR(20), @UlcerativeLargest) + 'mm) '
			ELSE
				SET @UlcerSummary = @UlcerSummary + '(' + CONVERT(VARCHAR(20), @UlcerativeLargest) + 'mm) '
		END

		SET @summary = @summary + @UlcerSummary
	END

	------------------------------------------------------------------------------------------
	-------	TUMOUR: STRICTURING -------
	------------------------------------------------------------------------------------------
	IF @Stricturing > 0
	BEGIN
		IF @summary <> '' SET @summary = @summary + '##'

		IF @StricturingQuantity > 1 SET @summary = @summary + CONVERT(VARCHAR(20), @StricturingQuantity) + ' '
		ELSE SET @summary = @summary + 'A '
		
		IF @StricturingProbably = 1 SET @summary = @summary + 'probably '

		IF @StricturingType = 1 SET @summary = @summary + 'benign '
		ELSE IF @StricturingType = 2 SET @summary = @summary + 'malignant '

		IF @StricturingQuantity > 1 SET @summary = @summary + 'stricturing tumours ' ELSE SET @summary = @summary + 'stricturing tumour ' 

		IF (@StricturingQuantity > 0 AND @StricturingLargest > 0) 
		BEGIN
			IF @StricturingQuantity > 1
				SET @summary = @summary + '(largest ' + CONVERT(VARCHAR(20), @StricturingLargest) + 'mm) '
			ELSE
				SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @StricturingLargest) + 'mm) '
		END
	END

	------------------------------------------------------------------------------------------
	-------	TUMOUR: POLYPOIDAL -------
	------------------------------------------------------------------------------------------
	IF @Polypoidal > 0
	BEGIN
		IF @summary <> '' SET @summary = @summary + '##'

		IF @PolypoidalQuantity > 1 SET @summary = @summary + CONVERT(VARCHAR(20), @PolypoidalQuantity) + ' '
		ELSE SET @summary = @summary + 'A '
		
		IF @PolypoidalProbably = 1 SET @summary = @summary + 'probably '

		IF @PolypoidalType = 1 SET @summary = @summary + 'benign '
		ELSE IF @PolypoidalType = 2 SET @summary = @summary + 'malignant '

		IF @PolypoidalQuantity > 1 SET @summary = @summary + 'polypoidal tumours ' ELSE SET @summary = @summary + 'polypoidal tumour ' 

		IF (@PolypoidalQuantity > 0 AND @PolypoidalLargest > 0) 
		BEGIN
			IF @PolypoidalQuantity > 1
				SET @summary = @summary + '(largest ' + CONVERT(VARCHAR(20), @PolypoidalLargest) + 'mm) '
			ELSE
				SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @PolypoidalLargest) + 'mm) '
		END
	END

	------------------------------------------------------------------------------------------
	-------	SUTURE GRANULOMA -------
	------------------------------------------------------------------------------------------
	IF @Granuloma > 0
	BEGIN
		IF @summary <> '' SET @summary = @summary + '##'

		IF @GranulomaQuantity > 1 SET @summary = @summary + CONVERT(VARCHAR(20), @GranulomaQuantity) + ' '
		ELSE SET @summary = @summary + 'A '
		
		IF @GranulomaQuantity > 1 SET @summary = @summary + 'granuloma tumours ' ELSE SET @summary = @summary + 'granuloma tumour ' 

		IF (@GranulomaQuantity > 0 AND @GranulomaLargest > 0) 
		BEGIN
			IF @GranulomaQuantity > 1
				SET @summary = @summary + '(largest ' + CONVERT(VARCHAR(20), @GranulomaLargest) + 'mm) '
			ELSE
				SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @GranulomaLargest) + 'mm) '
		END
	END

	------------------------------------------------------------------------------------------
	-------	DYSPLASTIC LESION -------
	------------------------------------------------------------------------------------------
	IF @Dysplastic > 0
	BEGIN
		IF @summary <> '' SET @summary = @summary + '##'

		IF @DysplasticQuantity > 1 SET @summary = @summary + CONVERT(VARCHAR(20), @DysplasticQuantity) + ' '
		ELSE SET @summary = @summary + 'A '
		
		IF @DysplasticQuantity > 1 SET @summary = @summary + 'dysplastic tumours ' ELSE SET @summary = @summary + 'dysplastic tumour ' 

		IF (@DysplasticQuantity > 0 AND @DysplasticLargest > 0) 
		BEGIN
			IF @DysplasticQuantity > 1
				SET @summary = @summary + '(largest ' + CONVERT(VARCHAR(20), @DysplasticLargest) + 'mm) '
			ELSE
				SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @DysplasticLargest) + 'mm) '
		END

	END

	------------------------------------------------------------------------------------------
	-------	PNEUMATOSIS COLI -------
	------------------------------------------------------------------------------------------
	IF @PneumatosisColi > 0
	BEGIN
		BEGIN
			IF @summary <> '' SET @summary = @summary + '##'

			SET @summary = @summary + 'pneumatosis coli '
		END
	END	
	
	------------------------------------------------------------------------------------------
	-------	SUBMUCOSAL LESION -------
	------------------------------------------------------------------------------------------
	IF @Submucosal > 0
	BEGIN
		IF @summary <> '' SET @summary = @summary + '##'

		IF @SubmucosalQuantity > 1 SET @summary = @summary + CONVERT(VARCHAR(20), @SubmucosalQuantity) + ' '
		ELSE SET @summary = @summary + 'A '
		
		IF @SubmucosalProbably = 1 SET @summary = @summary + 'probably '

		SELECT @summary = @summary + LOWER([Description]) + ' ' FROM @TumourTypes WHERE TypeId = @SubmucosalTypeId

		IF @SubmucosalQuantity > 1 SET @summary = @summary + 'submucosal lesions ' ELSE SET @summary = @summary + 'submucosal lesion ' 

		IF (@SubmucosalQuantity > 0 AND @SubmucosalLargest > 0) 
		BEGIN
			IF @SubmucosalQuantity > 1
				SET @summary = @summary + '(largest ' + CONVERT(VARCHAR(20), @SubmucosalLargest) + 'mm) '
			ELSE
				SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @SubmucosalLargest) + 'mm) '
		END
	END

	------------------------------------------------------------------------------------------
	-------	FOCAL LESIONS -------
	------------------------------------------------------------------------------------------
	IF @Focal > 0
	BEGIN
		IF @summary <> '' SET @summary = @summary + '##'

		IF @FocalQuantity > 1 SET @summary = @summary + CONVERT(VARCHAR(20), @FocalQuantity) + ' '
		ELSE SET @summary = @summary + 'A '
		
		IF @FocalProbably = 1 SET @summary = @summary + 'probably '

		SELECT @summary = @summary + LOWER([Description]) + ' ' FROM @TumourTypes WHERE TypeId = @FocalTypeId

		IF @FocalQuantity > 1 SET @summary = @summary + 'focal lesions ' ELSE SET @summary = @summary + 'submucosal lesion ' 

		IF (@FocalQuantity > 0 AND @FocalLargest > 0) 
		BEGIN
			IF @FocalQuantity > 1
				SET @summary = @summary + '(largest ' + CONVERT(VARCHAR(20), @FocalLargest) + 'mm) '
			ELSE
				SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @FocalLargest) + 'mm) '
		END
	END

	-------------------------------------------------------------------------------------------
	-------	Fundic Gland Polyp -------
	------------------------------------------------------------------------------------------
	IF @FundicGlandPolyp > 0
	BEGIN
		IF @summary <> '' SET @summary = @summary + '##'

		IF @FundicGlandPolypQuantity > 1 SET @summary = @summary + CONVERT(VARCHAR(20), @FundicGlandPolypQuantity) + ' '
		ELSE SET @summary = @summary + 'A '
		
		IF @FundicGlandPolypQuantity > 1 SET @summary = @summary + 'Fundic Gland Polyp found ' ELSE SET @summary = @summary + 'Fundic Gland Polyp found ' --TFS-2958---

		IF (@FundicGlandPolypQuantity > 0 AND @FundicGlandPolypLargest > 0) 
		BEGIN
			IF @FundicGlandPolypQuantity > 1
				SET @summary = @summary + '(largest ' + CONVERT(VARCHAR(20), @FundicGlandPolypLargest) + ' mm) '
			ELSE
				SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @FundicGlandPolypLargest) + ' mm) '
		END
	END
	
	------------------------------------------------------------------------------------------
	-------	Previous ESD Scar -------
	------------------------------------------------------------------------------------------
	IF @PreviousESDScar > 0
	BEGIN
		BEGIN
			IF @summary <> '' SET @summary = @summary + '##'

			SET @summary = @summary + 'previous ESD scar '
		END
	END	

	------------------------------------------------------------------------------------------
	-------	POLYPS	-------
	------------------------------------------------------------------------------------------
	IF @Polyp = 1
	BEGIN
		IF EXISTS (SELECT TOP 1 1 FROM dbo.ERS_CommonAbnoPolypDetails WHERE SiteId = @SiteId)
		BEGIN
			SET @summary = @summary + '<br />' + dbo.common_polpydetails_summary(@SiteId, NULL)
		END
	END


	------------------------------------------------------------------------------------------
	-------	POLYPS TATTOO ----------
	------------------------------------------------------------------------------------------
	/*IF @Tattooed > 0 
	BEGIN
		DECLARE @TattooTypeText varchar(50)

		SELECT @TattooType = MarkingType, @TattooedQty = MarkedQuantity FROM dbo.ERS_UpperGITherapeutics WHERE SiteId = @SiteID AND Marking = 1
		
		IF @summary <> '' SET @summary = @summary + '## <br />'

		SET @summary = @summary + ' Tattooed, '
		
		IF @TattooType IS NOT NULL AND @TattooType > 0
		BEGIN
			SELECT @TattooTypeText = ListItemText FROM dbo.ERS_Lists el WHERE el.ListDescription = 'Abno marking' AND el.ListItemNo = @TattooType AND ListItemText IS NOT NULL

			SET @summary = @summary + CASE WHEN @TattooedQty IS NOT NULL AND @TattooedQty > 0 THEN + CONVERT(varchar(5), @TattooedQty) ELSE '' END + ' marked using ' + @TattooTypeText
		END	
	END	
	ELSE IF @PreviouslyTattooed > 0
	BEGIN
		IF @summary <> '' SET @summary = @summary + '##'

		SET @summary = @summary + ' previously tattooed '
	END	
	*/
END

SET @summary = LTRIM(RTRIM(@summary))
SET @summary = REPLACE(@summary, '##', '. ')
SET @summary = REPLACE(@summary, ' ,', ',')
SET @summary = REPLACE(@summary, ' )', ')')
SET @summary = REPLACE(@summary, ' .', '.')

DECLARE @finalSummary VARCHAR(8000) =''
----Set first letter to upper after full stop.
SELECT @finalSummary = @finalSummary + COALESCE(dbo.fnFirstLetterUpper(item) + '. ', '') 
FROM dbo.fnSplitString(@summary, '.')

SET @summary = LTRIM(RTRIM(@finalSummary))
IF @None <> 1 SET @summary = LOWER(LEFT(@summary,1)) + RIGHT(@summary,LEN(@summary)-1)
IF RIGHT(@summary,1) = '.' SET @summary = LEFT(@summary, LEN(@summary)-1)

-- Finally, update the summary in Diverticulum table
UPDATE ERS_CommonAbnoLesions
SET Summary = @summary 
WHERE SiteId = @SiteId


EXEC sites_summary_update @SiteId
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#2958 	Fundic gland polyp reported as "tumour" on pdf report
------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rony
-- TFS#	2964
-- Description of change
-- identify sent report to EPR
------------------------------------------------------------------------------------------------------------------------
GO
EXEC dbo.DropIfExist
@ObjectName = 'fnGetOcsProcessProcedureId',
@ObjectTypePrefix = 'F'
GO

EXEC dbo.DropIfExist @ObjectName = 'ERS_VW_OcsProcessAuditProcedureId', 
                     @ObjectTypePrefix = 'V' 
GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	2964
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ferdowsi On 16 May 2024
-- TFS#	No TFS - Item 3655
-- Description of change
-- Locking Reports
-- Updated by	:	Rony
-- TFS#	2964
-- Description of change
-- identify sent reprot to EPR
------------------------------------------------------------------------------------------------------------------------

GO
 ------------------- Adding New Column ---------------------

IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.COLUMNS
    WHERE TABLE_NAME = 'ERS_Procedures'
      AND COLUMN_NAME IN ('LockedBy' , 'LockedAt')
)
BEGIN 
  ALTER TABLE dbo.ERS_Procedures 
  ADD LockedBy VARCHAR(20) NULL, LockedAt DATETIME NULL 
END

GO
IF NOT EXISTS (SELECT 1 from sys.objects WHERE object_id = OBJECT_ID('ERS_ProcedureEditHistory'))
BEGIN
CREATE TABLE ERS_ProcedureEditHistory
        ( EditId [int] IDENTITY(1,1) NOT NULL, 
		  ProcedureId  [int] NOT NULL,  
		  LockedBy [varchar](20) NULL,
	      LockedAt [datetime] NULL,
           [LockedEnd] [datetime] NULL,
		  [WhoUpdatedId] [int] NULL,
	      [WhoCreatedId] [int] NULL,
	      [WhenCreated] [datetime] NULL,
	      [WhenUpdated] [datetime] NULL)
END

GO
EXEC dbo.DropIfExist @ObjectName = 'get_ProcedureEditHistory',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)

GO

CREATE Procedure [dbo].[get_ProcedureEditHistory]
	 
	@ProcedureId As INT 
AS
BEGIN
       SELECT  [ProcedureId] ,ISNULL( users.[Title] + ' '+users.[Forename] +' '+ users.[Surname],'') as LockedBy , FORMAT(LockedAt, 'dd MMM yyyy HH:mm') as  LockedAt  ,   FORMAT(LockedEnd, 'dd MMM yyyy HH:mm') AS LockedEnd
       FROM [ERS_ProcedureEditHistory]   LEFT JOIN ERS_Users users on  Username = LockedBy  where [ProcedureId] = @ProcedureId order by LockedAt desc	
END

GO
EXEC dbo.DropIfExist @ObjectName = 'lockProcedure',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE Procedure [dbo].[lockProcedure]
	@UserName  Varchar(200),
	@ProcedureId As Int 
AS
BEGIN
    DECLARE @lockedStatus AS VARCHAR(50)  = 'false' 
    DECLARE @LockedAt DATETIME
	 DECLARE @LockedEND DATETIME
    DECLARE @ProcedureLockedBy VARCHAR(200)

 
	 SELECT TOP  (1) @lockedStatus = CASE WHEN LockedEnd IS NOT NULL THEN 'false' ELSE
	  CASE WHEN  DATEDIFF(minute, ISNULL(LockedAt,GETDATE()), GETDATE()) <61 then  'true' ELSE 'false' END 
	  END
	  from ERS_ProcedureEditHistory WHERE ProcedureId= @ProcedureId  ORDER BY [EditId] DESC
	--  SELECT @lockedStatus
      IF @lockedStatus = 'false'
	  BEGIN
	    INSERT INTO ERS_ProcedureEditHistory ([ProcedureId],[LockedBy],[LockedAt],[WhoUpdatedId],[WhoCreatedId],[WhenCreated],[WhenUpdated])
		VALUES (@ProcedureId,  @UserName, GETDATE(), NULL, NUll, GETDATE(), NULL )
		SELECT @lockedStatus
	  END
	  ELSE 
	  BEGIN
	 	Select ISNULL( users.[Title] +  ' '+users.[Forename] +' '+ users.[Surname],'') As LockedUser FROM ERS_ProcedureEditHistory edit
		LEFT JOIN ERS_Users users  ON users.Username = edit.LockedBy where edit.ProcedureId = @ProcedureId
	  END
END
 
 
 
GO
EXEC dbo.DropIfExist @ObjectName = 'RemoveLoggedUser',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

Create Procedure [dbo].[RemoveLoggedUser]
	 
	@userId As  INT,
	@UserName As Varchar(100)

AS
BEGIN
       UPDATE ERS_Users SET LoggedOn = 0  WHERE UserID = @UserId 
	   DELETE FROM ERS_UserLogins WHERE UserId = @UserId 
END
 
GO
EXEC dbo.DropIfExist @ObjectName = 'unLockProcedure',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE Procedure [dbo].[unLockProcedure]
	 
	@ProcedureId As Int 
AS
BEGIN
	   Update  TOP (1) ERS_ProcedureEditHistory set LockedEnd = GETDATE()  where  [EditId] = (SELECT TOP (1) [EditId] FROM ERS_ProcedureEditHistory where ProcedureId= @ProcedureId ORDER BY [EditId] DESC)
END


GO
EXEC dbo.DropIfExist @ObjectName = 'usp_Procedures_SelectByPatient',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[usp_Procedures_SelectByPatient]
(
    @UserName Varchar(200),
	@PatientId INT,
	@IncludeOldProcs BIT = 1,
	@ActiveProceduresOnly BIT = 1 -- Only Select the Active Records-> IsActive=True!
)
AS

SET NOCOUNT ON

 
DECLARE @AdminIDs  VARCHAR(100)
DECLARE @Admin Bit
DECLARE @HasRole NVARCHAR(5); 
 
 
     SELECT @AdminIDs = COALESCE(@AdminIDs + ', ', '') +  CAST(RoleId AS NVARCHAR)
	 FROM ERS_Roles where RoleName in ('System Administrators','GlobalAdmin')
	  
     SELECT  @HasRole = CASE WHEN Count(T2.[Item]) > 0 THEN 'true' ELSE 'false' END FROM fnSplitString(@AdminIDs,',') AS T1
            LEFT JOIN fnSplitString((SELECT RoleID  FROM ERS_Users WHERE Username =  @UserName),',')
            AS T2 on T1.[Item] = T2.[Item] WHERE T2.[Item] is not null 

	UPDATE ERS_ProcedureEditHistory SET LockedEnd =  GetDATE()  WHERE  LockedBy = @UserName  
	--Added by rony tfs-2964 start
	DECLARE @GREENCIRCLE VARCHAR(MAX) = '<IMG SRC="../Images/NEDJAG/Mand.png" />';
	DECLARE @RedCIRCLE VARCHAR(MAX) = '<IMG SRC="../Images/NEDJAG/Red.png" />';
	--End

	SELECT * INTO #procs FROM (
		SELECT 
			p.ProcedureId AS ProcedureId,
			0 AS EpisodeNo,
			0 AS PreviousProcedureId,
			p.ProcedureType AS ProcedureType,
			CONVERT(VARCHAR(50),'') AS PatientComboId,
			p.DiagramNumber AS DiagramNumber,
			--Added by rony tfs-2964 start
			CASE WHEN p.ProcedureId = OPAPI.ProcedureId THEN 
			 @GREENCIRCLE + ' ' + CONVERT(VARCHAR(100), CONVERT(VARCHAR, p.CreatedOn, 103) + ' - ' + pt.ProcedureType)
			ELSE  
			@RedCIRCLE + ' ' + CONVERT(VARCHAR(100), CONVERT(VARCHAR, p.CreatedOn, 103) + ' - ' + pt.ProcedureType) 
			END AS DisplayName,
			--End
			1 AS ERS,
			p.CreatedOn,
			p.ModifiedOn,
            
            @HasRole AS Administrator,
			ISNULL((SELECT TOP (1) CASE WHEN LockedEnd IS NOT NULL THEN 'false' ELSE
	         CASE WHEN  DATEDIFF(minute, ISNULL(LockedAt,GETDATE()), GETDATE()) <61 then  'true' ELSE 'false' END  END
	        from ERS_ProcedureEditHistory WHERE ProcedureId=p.ProcedureId ORDER BY [EditId] DESC ), 'false')   AS procedureLocked , 

			(SELECT CASE  WHEN ISNULL((SELECT TOP (1) LockedBy FROM ERS_ProcedureEditHistory WHERE ProcedureId = p.ProcedureId), '') <> '' THEN 'true'  ELSE 'false'   END) AS hasHistory,

			ISNULL((SELECT  TOP (1) 	ISNULL( users.[Title] + ' '+users.[Forename] +' '+ users.[Surname],'')  from ERS_ProcedureEditHistory edit  LEFT JOIN ERS_Users users on
			Username = edit.LockedBy WHERE edit.ProcedureId = p.ProcedureId ),'') AS LockedUser,
		
			ISNULL((SELECT  TOP (1) format(LockedAt ,'HH:mm') from ERS_ProcedureEditHistory  WHERE ProcedureId = p.ProcedureId order by LockedAt desc),'') AS LockedAt,
			0 AS Locked,--ISNULL(pa.Locked,0), 
			0 AS LockedBy,--ISNULL(pa.LockedBy,0), 
			NULL AS LockedOn,--pa.LockedOn,
			ISNULL(CAST(SurgicalSafetyCheckListCompleted AS VARCHAR(50)),'') AS SurgicalSafetyCheckListCompleted,
			CASE s.ReportLocking 
			WHEN 1 
			THEN 0
			ELSE
				CASE 
				WHEN p.ModifiedOn <= DATEADD(DAY, 0 - s.LockingDays, DATEADD(HOUR, convert(int,left(isnull(s.LockingTime, '0'), 2)), DATEADD(dd, 0, DATEDIFF(dd, 0, GETDATE()))))
				THEN  CASE WHEN p.ProcedureCompleted = 1 THEN 1 ELSE 0 END
				ELSE 0
				END
			END AS isProcedureLocked
			, -1 AS  ColonType
			, CONVERT(INT,ISNULL(ProcedureCompleted,0)) AS ProcedureCompleted
			, IsNull(P.DNA,'')		AS DNA_Reason	
			, IsNull(PR.PP_DNA,'')	AS DNA_Reason_PP_Text	
			, p.BreathTestResult AS BreathTest
			, CASE WHEN pho.photoCount IS NULL THEN 0 ELSE 1 END HasPhotos
		FROM 
			ERS_Procedures p
		INNER JOIN 
			ERS_ProcedureTypes pt ON p.ProcedureType = pt.ProcedureTypeId
		INNER JOIN 
			ERS_Patients pa ON p.PatientId = pa.PatientId
		LEFT JOIN ERS_ProceduresReporting AS PR ON p.ProcedureId=PR.ProcedureId
		LEFT JOIN (SELECT count(dbo.ers_photos.PhotoId) AS photoCount, procedureid FROM ers_photos GROUP BY procedureid) as pho ON p.ProcedureId = pho.ProcedureId
		JOIN ERS_SystemConfig s on p.OperatingHospitalID = s.OperatingHospitalID 
		--Added by rony tfs-2964 start
		LEFT JOIN (select CAST('<x>' + REPLACE(Process,'|','</x><x>') + '</x>' AS XML).value('/x[4]','int') as ProcedureId from ERS_OCS_Process_Audit) OPAPI on OPAPI.ProcedureId = p.ProcedureId
		--End
		WHERE 
			p.PatientId = @PatientId
			AND p.IsActive  = @ActiveProceduresOnly
	) AS temptemp


	INSERT INTO #procs
		SELECT 
			DISTINCT 0,
			0,
			pp.PreviousProcedureID,
			0,
			'',
			0,
			CONVERT(VARCHAR(100), CONVERT(VARCHAR, pp.ProcedureDate, 103) + 
				' - ' + 
				pp.ProcedureType),
			2,
			pp.ProcedureDate,
			pp.ProcedureDate,
			'',
			0,
			'',
			'',
			'',
			1,0,null,
			'', 1, -1, -1,
			1, '', null, CASE WHEN epi.ImageID IS NULL THEN 0 ELSE 1 END
		FROM 
			ERS_PreviousProcedures pp
			LEFT OUTER JOIN ERS_PreviousImages epi ON epi.PreviousProcedureID = pp.PreviousProcedureID
		WHERE
			pp.PatientId = @PatientId
			AND pp.IsActive = 1

	SELECT * FROM #procs ORDER BY CreatedOn DESC, ModifiedOn DESC

	DROP TABLE #procs
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	No TFS - Item 3655  by Ferdowsi
------------------------------------------------------------------------------------------------------------------------


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ferdowsi On 22 May 2024
-- TFS#	No TFS - Item 2079
-- Description of change
-- phrase Library 
------------------------------------------------------------------------------------------------------------------------
GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.COLUMNS
    WHERE TABLE_NAME = 'ERS_Users'
    AND COLUMN_NAME = 'GeneralLibrary'
)
BEGIN
    ALTER TABLE dbo.ERS_Users
    ADD GeneralLibrary BIT;
END;

GO

UPDATE ERS_MenuMap set Suppressed = 0 where  NodeName = 'Phrase Library'

IF  (SELECT ISNULL(OBJECT_DEFINITION(default_object_id), '') AS definition
	FROM   sys.columns
	WHERE  name      ='GeneralLibrary'
	AND    object_id = object_id('dbo.ERS_Users ')) = '' 
BEGIN
    ALTER TABLE dbo.ERS_Users
    ADD CONSTRAINT [DF_ERS_Users_GeneralLibrary] DEFAULT 0 FOR GeneralLibrary;
END
GO 
	IF NOT EXISTS (
	    SELECT 1
	    FROM INFORMATION_SCHEMA.COLUMNS
	    WHERE TABLE_NAME = 'ERS_PhraseLibrary'
	    AND COLUMN_NAME = 'ProcedureTypeId'
	)
	BEGIN
	    ALTER TABLE dbo.ERS_PhraseLibrary
	    ADD ProcedureTypeId INT;
	END
	ELSE 
	 BEGIN
	 ALTER TABLE dbo.ERS_PhraseLibrary
	   ALTER COLUMN ProcedureTypeId INT;
	END

Go

EXEC dbo.DropIfExist @ObjectName = 'get_user',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[get_user]
(
	@UserId INT,
	@TrustId INT
)
AS

BEGIN

	--Gather users Roles for user and current trust into temporary table
	DECLARE @RoleId VARCHAR(max)
	SELECT @RoleID = RoleID FROM ERS_Users where UserID = @UserId
	SELECT [item] AS RoleId, r.RoleName INTO #tmpRoles FROM dbo.fnSplitString(@RoleId,','), ERS_Roles r WHERE [item] = r.RoleId  AND (r.TrustId = @TrustId OR r.TrustId IS NULL)

	--Get User and Comma seperated list of role names
	SELECT [UserID]
      ,[ExpiresOn]
      ,[Username]
      ,[Title]
      ,[Forename]
      ,[Surname]
      ,[Initials]
      ,[Qualifications]
      ,u.[JobTitleID]
      ,[RoleID]
      ,CanRunAK
      ,[IsListConsultant]
      ,[IsEndoscopist1]
      ,[IsEndoscopist2]
      ,[IsAssistantOrTrainee]
      ,[IsNurse1]
      ,[IsNurse2]
      ,[ResetPassword]
      ,u.[Suppressed] 
      ,[ShowTooltips]     
      ,[GMCCode]
      ,[CanEditDropdowns]
      ,[CanViewAllUserAudits]
      ,ISNULL([GeneralLibrary],0) AS GeneralLibrary,
	  jt.Description AS JobTitle,
	(select substring((select ',' + convert(varchar(12),RoleName)
				  from #tmpRoles
				  order by CAST(RoleId AS NUMERIC(4,0)) asc
				  for xml path('')),2,70)) AS Permissions
	FROM ERS_Users u
	LEFT JOIN ERS_JobTitles jt ON u.JobTitleID = jt.JobTitleID
	WHERE UserId = @UserId
END
GO

EXEC dbo.DropIfExist @ObjectName = 'get_ProcedureTypes',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO
CREATE PROCEDURE [dbo].[get_ProcedureTypes]
AS

BEGIN
  SELECT
      proce.[ProcedureTypeId],
	  proce.[ProcedureType] AS ChildNode,
	  pt.ProductTypeId AS ParentId,
	  pt.Description AS ParentNode
  FROM ERS_ProductTypes pt   join [ERS_ProcedureTypes] proce on pt.ProductTypeId =proce.[ProductTypeId]
END
Go
 
EXEC dbo.DropIfExist @ObjectName = 'GetFilteredPhrases',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[GetFilteredPhrases]
    @OperatingHospitalId INT,
    @ProcedureTypeIds VARCHAR(MAX) = NULL,
    @PhraseCategory VARCHAR(50) = NULL,
    @PhraseText NVARCHAR(MAX) = NULL,
	@UserName NVARCHAR(MAX) = NULL
AS
BEGIN
    SET NOCOUNT ON;
	DECLARE @subQuery NVARCHAR(MAX)
    DECLARE @subQueryForGeneral NVARCHAR(MAX)
	DECLARE @subQueryForPersonal NVARCHAR(MAX)
    DECLARE @query NVARCHAR(MAX)
   IF @UserName <> ''
	BEGIN 
	   SET @subQuery = 'LEFT JOIN [ERS_Users] u ON p.UserID = u.UserID WHERE u.Username = @UserName'
	END
	ELSE
	BEGIN
	 SET @subQuery ='WHERE UserID = 0'
	 END
    
    SET @query = 'SELECT p.Phrase, p.PhraseID FROM [ERS_PhraseLibrary] p '+ @subQuery +' AND OperatingHospitalId = @OperatingHospitalId'

    IF @ProcedureTypeIds IS NOT NULL
    BEGIN
        SET @query = @query + ' AND ProcedureTypeId IN (' + @ProcedureTypeIds + ')'
    END

    IF @PhraseCategory IS NOT NULL
    BEGIN
        SET @query = @query + ' AND PhraseCategory = @PhraseCategory'
    END

    IF @PhraseText IS NOT NULL AND @PhraseText <> ''
    BEGIN
       SET @query = @query + ' AND Phrase LIKE ''%' + @PhraseText + '%'''
    END
    EXEC sp_executesql @query, N'@OperatingHospitalId INT, @PhraseCategory VARCHAR(50), @PhraseText NVARCHAR(MAX),@UserName NVARCHAR(MAX)', @OperatingHospitalId, @PhraseCategory, @PhraseText, @UserName
END
Go

 
GO
EXEC dbo.DropIfExist @ObjectName = 'common_phraselibrary_save',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[common_phraselibrary_save]
(
	@UserName varchar(50),
	@PhraseCategory varchar(50),
	@Phrase varchar(8000),
	@OperatingHospitalId INT,
    @ProcedureTypeId Varchar(200),
	@LoggedInUserId INT
)
AS

SET NOCOUNT ON

BEGIN TRANSACTION

BEGIN TRY
DECLARE @UserID int
SELECT @UserID = UserID FROM tvfUsersByOperatingHospital(@OperatingHospitalId) WHERE Username = @UserName
SET @UserID = ISNULL(@UserID,0)
IF NOT EXISTS(SELECT 1 FROM [ERS_PhraseLibrary] WHERE UserID = @UserID  AND PhraseCategory = @PhraseCategory AND Phrase = @Phrase AND ProcedureTypeId = @ProcedureTypeId) 
	BEGIN
	 INSERT INTO [ERS_PhraseLibrary] (UserID,PhraseCategory,Phrase,OperatingHospitalId, ProcedureTypeId,WhoCreatedId,WhenCreated) VALUES (@UserID, @PhraseCategory, @Phrase,@OperatingHOspitalId,@ProcedureTypeId,@LoggedInUserId,GETDATE());
	 SELECT SCOPE_IDENTITY()
	END	

END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;


GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	No TFS - Item 2079  by Ferdowsi
------------------------------------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ferdowsi On 22 May 2024
-- TFS#	No TFS - Item  4122
-- Description of change
-- Letter Printing : Search Dates using wrong table/column
------------------------------------------------------------------------------------------------------------------------

GO
EXEC dbo.DropIfExist @ObjectName = 'letGetQueueList',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[letGetQueueList]
(
	@StartDate DATE,
	@EndDate DATE,
	@IncludePrinted INT,
	@HospitalNumber INT,
	@HospitalIds varchar(100),
	@AppointmentStatusId INT
)
AS
BEGIN
	SELECT 
		lq.AppointmentId, 
		lq.OperationalHospitalId,
		LetterQueueId,
		STUFF((SELECT DISTINCT ', ' + HospitalNumber from ERS_PatientTrusts where PatientId = pt.PatientId for xml path('')), 1, 2, '') AS HospitalNumber,
		pt.NHSNo,
		pt.PatientId,
		lq.ProcedureId, 
		lq.AppointmentStatusId,
		pt.Forename1 AS Forname,
		pt.Surname,
		DescriptionForLetter,
		CASE WHEN Printed = 1 THEN 'Yes' ELSE 'No' END AS Printed,
		CASE WHEN Edited = 1 THEN 'Yes' ELSE '' END AS Edited,
		CASE WHEN EditedAfterPrint = 1 THEN 'Yes' ELSE '' END AS EditedAfterPrint,
		Convert(varchar,lq.whencreated,23) AS whencreated, 
		Convert(varchar,appoint.StartDateTime,120)  AS AppointmentDate,
		eu.Username AS WhoEdited,
		pu.Username AS WhoPrinted,
		lq.PrintCount
	FROM ERS_LetterQueue lq 
	JOIN ERS_Patients pt ON lq.PatientId = pt.PatientId
	JOIN ERS_AppointmentStatus apptSt ON lq.AppointmentStatusId = apptSt.UniqueId
	JOIN ERS_Appointments appoint On lq.AppointmentId = appoint.AppointmentId
	LEFT JOIN ERS_Users eu ON lq.WhoEdited = eu.UserID
	LEFT JOIN ERS_Users pu ON lq.WhoPrinted = pu.UserID
	JOIN ERS_LetterType lt ON lt.LetterName = apptSt.DescriptionForLetter AND lt.OperationalHospitalId = lq.OperationalHospitalId
	WHERE  CAST(appoint.StartDateTime AS DATE) BETWEEN @StartDate AND @EndDate
	AND (Printed = @IncludePrinted OR @IncludePrinted = 1)
	AND (pt.patientId in (Select PatientId from ERS_PatientTrusts where HospitalNumber like @HospitalNumber) OR @HospitalNumber IS NULL)
	AND lq.OperationalHospitalId in ( SELECT item FROM splitString(@HospitalIds, ',') )
	AND (lq.AppointmentStatusId = @AppointmentStatusId OR @AppointmentStatusId = 0)
	AND lt.IsActive = 1
	ORDER BY Convert(varchar,lq.whencreated,106) DESC
END

GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	No TFS - Item 4122  by Ferdowsi
------------------------------------------------------------------------------------------------------------------------
GO

 ------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 22.05.24
-- TFS#	
-- Description of change
-- Check required fields to validate against all updated reports 
------------------------------------------------------------------------------------------------------------------------
GO
IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ERS_ProcedurePathwayPlanAnswers' AND COLUMN_NAME = 'EvidenceOfCancer')
BEGIN
    ALTER TABLE [dbo].[ERS_ProcedurePathwayPlanAnswers]
    ADD EvidenceOfCancer INT NULL;
END
GO


IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ERS_PathwayPlanQuestions' AND COLUMN_NAME = 'ProcedureType')
BEGIN
    ALTER TABLE [dbo].[ERS_PathwayPlanQuestions]
    ADD ProcedureType INT NULL;
END
GO

IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ERS_PathwayPlanQuestions' AND COLUMN_NAME = 'OperatingHospital')
BEGIN
    ALTER TABLE [dbo].[ERS_PathwayPlanQuestions]
    ADD OperatingHospital INT NULL;
END
GO

	IF (Select count(1) from ERS_PathwayPlanQuestions where ProcedureType is null) > 0
		-- update the Pathway Plan Questions for each procedure type in each operating hospital
	BEGIN
		Declare @ProcedureType int, @OperatingHospital int

		Select ProcedureTypeId 
		into #ProcedureTypes
		from ERS_ProcedureTypes where ProductTypeId in (1, 2, 3)

		WHILE (Select count(1) from #ProcedureTypes) > 0
		BEGIN
			Select top 1 @ProcedureType = ProcedureTypeId
			from #ProcedureTypes

			Select OperatingHospitalId 
			into #OperatingHospitals
			from ERS_OperatingHospitals
			where Suppressed = 0

			while (Select count(1) from #OperatingHospitals) > 0
			BEGIN
				Select top 1 @OperatingHospital = OperatingHospitalId
				from #OperatingHospitals

				Insert into ERS_PathwayPlanQuestions(Question, Optional, CanFreeText, Mandatory, Suppressed, OrderById, UnknownOption, IsSystem, ProcedureType, OperatingHospital)
				Select Question, Optional, CanFreeText, Mandatory, Suppressed, OrderById, UnknownOption, IsSystem, @ProcedureType, @OperatingHospital
				from ERS_PathwayPlanQuestions where ProcedureType is null

				Delete from #OperatingHospitals where OperatingHospitalId = @OperatingHospital
			END
			drop table #OperatingHospitals
			Delete from #ProcedureTypes where ProcedureTypeId = @ProcedureType 
		END
	
		-- Now update existing procedures witht the new pathway plan questions
		--Select pppa.ProcedureId, p.ProcedureType, p.OperatingHospitalId, pppa.QuestionId, ppq.Question, ppq2.QuestionId, ppq2.ProcedureType, ppq2.OperatingHospital, ppq2.Question 
		update pppa
		set pppa.QuestionId = ppq2.QuestionId 
		from ERS_ProcedurePathwayPlanAnswers  pppa
		join ERS_PathwayPlanQuestions ppq on pppa.QuestionId = ppq.QuestionId 
		join ERS_Procedures p on pppa.ProcedureId = p.ProcedureId 
		join ERS_PathwayPlanQuestions ppq2 on ppq.Question = ppq2.Question and p.ProcedureType = ppq2.ProcedureType and p.OperatingHospitalID = ppq2.OperatingHospital 

		-- and we can delete the pathway questions that do not have a procedure type
		DELETE FROM ERS_PathwayPlanQuestions where ProcedureType is null
		drop table #ProcedureTypes
	END

GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ferdowsi On 20 March 2024
-- TFS#	No TFS - Item 3894
-- Description of change
-- EBUS Coding being removed from the report which are unchecked
------------------------------------------------------------------------------------------------------------------------
GO
EXEC dbo.DropIfExist @ObjectName = 'broncho_coding_save',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[broncho_coding_save]
(
	@ProcedureId INT,
	@CodeId INT,
	@checkboxStatus BIT,
	@checkboxType VARCHAR(50),
	@LoggedInUserId INT

)
AS

SET NOCOUNT ON
    DECLARE @Type NVARCHAR(MAX) 
	DECLARE @RigidCodeValue BIT 
	DECLARE @FibreOpticCodeValue BIT

	-- Condition for insert data
    if @checkboxType ='Fibre'
     BEGIN
       SET @FibreOpticCodeValue =  @checkboxStatus
     END
    ELSE 
	 BEGIN 
	   SET @RigidCodeValue =@checkboxStatus
	 END


  
BEGIN TRANSACTION

BEGIN TRY

	IF NOT EXISTS (SELECT 1 FROM ERS_BRT_BronchoCoding WHERE ProcedureId = @ProcedureId AND CodeId = @CodeId) 
	BEGIN 
		INSERT INTO ERS_BRT_BronchoCoding (
			ProcedureId, 
			CodeId, 
			FibreOpticCodeValue, 
			RigidCodeValue,
			WhoCreatedId,
			WhenCreated) 
        VALUES (
			@ProcedureId, 
			@CodeId, 
			@FibreOpticCodeValue, 
			@RigidCodeValue,
			@LoggedInUserId,
			GETDATE()) 

		INSERT INTO ERS_RecordCount (
			[ProcedureId],
			[SiteId],
			[Identifier],
			[RecordCount]
		)
		VALUES (
			@ProcedureId,
			NULL,
			'Coding',
			1)
	END 

    ELSE 
    BEGIN
		UPDATE 
			ERS_BRT_BronchoCoding 
        SET 
			FibreOpticCodeValue = CASE WHEN @checkboxType ='Fibre'THEN @checkboxStatus ELSE FibreOpticCodeValue END, 
			RigidCodeValue =  CASE WHEN  @checkboxType ='Rigid' THEN @checkboxStatus ELSE RigidCodeValue END ,
			WhoUpdatedId = @LoggedInUserId,
			WhenUpdated = GETDATE()
        WHERE 
			ProcedureId = @ProcedureId 
			AND CodeId = @CodeId 
	END

END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;

Go
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	No TFS - Item 3894 by Ferdowsi
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea
-- TFS#	23.5.24
-- Description of change
-- Exclude unnecessary procedures from returning a jmanovure value
------------------------------------------------------------------------------------------------------------------------

ALTER PROCEDURE [dbo].[usp_NED_Generate_Report]
(
		@ProcedureId AS INT
)
AS
BEGIN
	SET NOCOUNT ON;

/*
	<xs:schema xmlns="https://www.jets.nhs.uk/schema/hospital.sendbatchmessage-version2.xsd" 
	xmlns:mstns="https://www.jets.nhs.uk/schema/hospital.sendbatchmessage-version2.xsd" 
	xmlns:xs="http://www.w3.org/2001/XMLSchema" 
	targetNamespace="https://www.jets.nhs.uk/schema/hospital.sendbatchmessage-version2.xsd" 
	elementFormDefault="qualified" id="SendBatchMessageFile">		

*/
Declare @site AS VARCHAR(50);
DECLARE 
		@description	AS VARCHAR(1000),
		@uniqueid		AS VARCHAR(15),
		@previousLocalProcedureId AS VARCHAR(15),
		@PatientId		AS INT,
		@sessionType	AS VARCHAR(50),
		@operatingHospitalId AS INT,
		@ProcedureTypeId AS INT,
		@ExportFolderPath AS VARCHAR(100);	--## XML Export Folder path.. Set by Admin in the [ERS_SystemConfig] Table

DECLARE @returnXML XML;

	Set @description = 'NED List';
	SELECT @operatingHospitalId = OperatingHospitalId FROM ERS_Procedures WHERE ProcedureId = @ProcedureId;
	SELECT @site = [NED_HospitalSiteCode], @ExportFolderPath=[NED_ExportPath] FROM [dbo].[ERS_SystemConfig] WHERE OperatingHospitalId = @operatingHospitalId;

	SELECT @ProcedureTypeId = ProcedureType,
		   @uniqueid = RIGHT(('00000' + CAST(@ProcedureId AS VARCHAR(6))),6) --## Procedure Id
							+ RIGHT(('0' + CAST(ProcedureType AS VARCHAR(2))),2)  --## Procedure Type; ie: OGD=1/ERCP=2/COLON=3/FLEXI=13
								+ (CASE ProcedureType	WHEN  1 THEN 'o' 
														WHEN  2 THEN 'e'
														WHEN  4 THEN 's' 
														WHEN  3 THEN 'c'
														WHEN  6 THEN 'u'
														WHEN  7 THEN 'u'
														WHEN  8 THEN 'n'
														WHEN  9 THEN 't'
									END)	--## Procedure Letter
		 , @sessionType=Case ListType	When 1 Then 'Service List' 
										When 2 Then 'Adhoc Training List' 
											   Else 'Dedicated Training List' End 
		, @PatientId = PatientId
	From dbo.ERS_Procedures Where ProcedureId=@ProcedureId;


	--## UniqueId is generated- so UPDATE this new value now in the ERS_Procedures Table
	UPDATE dbo.ERS_Procedures
	SET [NEDProcedureId] = @uniqueid
	WHERE ProcedureId=@ProcedureId;

	--## Now get the Previous NED Unique Id- of the same Patient... We know the Patient Id already! Use it!!
	SELECT @previousLocalProcedureId = IsNull([NEDProcedureId], '') 
			 FROM dbo.ERS_Procedures 
			WHERE PatientId = @PatientId AND ProcedureId<@ProcedureId
		 ORDER BY ProcedureID DESC;

	print '@uniqueid: ' + @uniqueid;

SET @returnXML=(
SELECT 
	  @uniqueid											AS '@uniqueId'
	, @description										AS '@description'
	, REPLACE(convert(varchar, p.CreatedOn, 106), ' ', '/')	AS '@date'	--### '10 Oct 2020' ==> '10/Oct/2020'
	, P.ProcedureTime AS '@time'
	, @sessionType										AS '@type'	-- SessionTypeEnum
	, @site												AS '@site'	--## Hospital Code

	/*	##### Procedure info	*/
	, (
	Select 
		  @uniqueid										AS '@localProcedureId'
		, @previousLocalProcedureId						AS '@previousLocalProcedureId'
		, (CASE P.ProcedureType WHEN 1 THEN 'OGD' 
								WHEN 2 THEN 'ERCP' 
								WHEN 3 THEN 'COLON' 
								WHEN 4 THEN 'FLEXI' 
								WHEN 6 THEN 'EUS' 
								WHEN 7 THEN 'EUS' 
								WHEN 8 THEN 'ENT' 
								WHEN 9 THEN 'ENT' 
		   END) AS '@procedureName'
		, Dis.NEDTerm AS '@procedureDiscomfort'	
		, PPDD.NEDTerm AS '@postProcedureDiscomfort' -- **************************** TO DO *********************************
		, dbo.fnNED_ProcedureExtent(@ProcedureId, 0) AS '@extent'	--## OverAll Extent info - EE/ER- whoever has gone Furthest distance!!
		, (CASE WHEN Drug.entonox IS NULL THEN 'No' ELSE 'Yes' END) AS '@entonox'
		, CASE WHEN ISNULL((Select DrugNo from ERS_UpperGIPremedication where ProcedureId = @ProcedureID and DrugNo = -2), 0) = -2 THEN 'Yes' ELSE 'No' END AS '@generalAnaes'
		, convert(varchar, P.StartDateTime, 126) AS '@procedureStartTime'
		, convert(varchar, P.EndDateTime, 126) AS '@procedureEndTime'
		, Ins.NEDTerm AS '@insufflation' 
		, PS.NEDTerm AS '@providerSector'
		, RT.NEDTerm AS '@referrer'
		, CASE WHEN isnull(P.ReferrerTypeOther, '') = '' THEN NULL ELSE P.ReferrerTypeOther END AS '@referrerOther' -- ***************** Only if referrer is 'Other' *******************************
		, PO.NEDTerm AS '@providerOrganisation' 
		, CASE WHEN isnull(P.ProviderOther, '') = '' THEN NULL ELSE P.ProviderOther END AS '@providerOrganisationOther' -- **************** Only if providerOrganisation is 'Other' *************************
		, CASE WHEN P.ChecklistComplete = 0 THEN 'No' ELSE 'Yes' END AS '@checklist' 
		, CASE WHEN PatStat.ListItemText = 'Day patient' THEN 'Inpatient' ELSE PatStat.ListItemText END AS '@admissionType'
		, Urgency.Description AS '@urgencyType' 
		, Ext.NEDTerm AS '@plannedExtent'
		, ISNULL(AIS.NEDTerm, 'None')  AS '@artificialintelligence'
		, CASE WHEN AIS.NEDTerm = 'Other' THEN PAIS.AISoftwareOther ELSE NULL END AS '@artificialintelligenceOther' -- **************** Only if artificialintelligence is 'Other' *************************
		, CASE WHEN PAIS.AISoftwareName IS NULL OR AIS.NEDTerm = 'None' THEN NULL ELSE PAIS.AISoftwareName END AS '@nameOfAISoftware' -- **************** Only if artificialintelligence is NOT 'None' *************************
		, CASE WHEN CHARINDEX('.00',P.Points,0) > 0 THEN convert(varchar(10), convert(int, P.Points)) ELSE convert(varchar(10), P.Points) END AS '@procedurePoints'


		/*	##### Patient Info	*/		
		, (CASE Pat.Gender WHEN 'Not Known' THEN 'Other' WHEN 'Not Specif' THEN 'Other' ELSE Pat.Gender END)		AS 'patient/@gender'
		, (0+ FORMAT(getdate(),'yyyyMMdd') - FORMAT(Pat.DateOfBirth,'yyyyMMdd') ) /10000 AS 'patient/@age'


		/*	##### Drugs	*/
		, CASE WHEN CHARINDEX('.00',IsNull(Drug.pethidine,0),0) > 0 THEN convert(varchar(10), convert(int,IsNull(Drug.pethidine,0))) ELSE CONVERT(varchar(10),IsNull(Drug.pethidine,0)) END	As 'drugs/@pethidine'	--## Required
		, CASE WHEN CHARINDEX('.00',IsNull(Drug.midazolam,0),0) > 0 THEN convert(varchar(10), convert(int,IsNull(Drug.midazolam,0))) ELSE CONVERT(varchar(10),IsNull(Drug.midazolam,0)) END	As 'drugs/@midazolam'	--## Required
		, CASE WHEN CHARINDEX('.00',IsNull(Drug.fentanyl,0),0) > 0 THEN convert(varchar(10), convert(int,IsNull(Drug.fentanyl,0))) ELSE CONVERT(varchar(10),IsNull(Drug.fentanyl,0))	END As 'drugs/@fentanyl'	--## Required
		, CASE WHEN CHARINDEX('.00',IsNull(Drug.buscopan,0),0) > 0 THEN convert(varchar(10), convert(int,IsNull(Drug.buscopan,0))) ELSE CONVERT(varchar(10),IsNull(Drug.buscopan,0))	END As 'drugs/@buscopan'	--## Required
		, CASE WHEN CHARINDEX('.00',IsNull(Drug.remimazolam,0),0) > 0 THEN convert(varchar(10), convert(int,IsNull(Drug.remimazolam,0))) ELSE CONVERT(varchar(10),IsNull(Drug.remimazolam,0))	END As 'drugs/@remimazolam'	--## Required
		, CASE WHEN IsNull(Drug.propofol, 0) = 0 THEN 'No' ELSE	'Yes' END			As 'drugs/@propofol'	--## YesNo
		, ISNULL(Drug.noDrugsAdministered, 'Yes')	As 'drugs/@noDrugsAdministered'


		/*	##### Staff.Members: 1 Procedure to MANY staff.. So - need a SQL Subquery- to return a RecordSet		*/
		,(
			SELECT 
			  Staff.professionalBodyCode AS '@professionalBodyCode'
			, Staff.EndoscopistRole		AS '@endoscopistRole'
			, Staff.ProcedureRole		AS '@procedureRole'	-- ProcedureRoleTypeEnum
			, Staff.Extent				AS '@extent'
			, CASE WHEN @ProcedureTypeId IN (1,3,4) THEN CASE Staff.[jManoeuvre] WHEN 1 THEN 'Yes' WHEN 0 THEN 'No' ELSE NULL END END	AS '@jManoeuvre'	-- Opt -- Mandatory for OGD, Colon and Flexi procedures (Rectal retroversion)
			/*	##### Therapeutic = Sesion->Procedure-> Staff.members-> Staff-> Therapeutic; 1 [Staff] to Many [Therapeutic sessions]	*/
			, (
				Select * from (select 
					   T.NedName	AS '@type'	-- M	--## The type of therapeutic procedure.
					 , CASE WHEN rc.RegionId IS NULL THEN T.[Site] ELSE 'Anastomosis' END		AS '@site'	-- O -- BiopsyEnum  --## The location where the therapeutic procedure was performed.
					 , ISNULL(T.EndoRole, Staff.ProcedureRole) AS '@role' -- O	-- ProcedureRoleTypeEnum
					 , T.polypSize	AS '@polypSize' -- O	-- PolypSizeEnum --## The size of polyp (if found) -> is ONLY for COLON/FLEXI
					 , T.PolypSizeInt AS '@polypSizeInteger'  
					 , T.Detected AS '@observed' 
					 , T.Tattooed	AS '@tattooed'	-- O	-- TattooEnum
					 , sum(T.Performed)	AS '@performed'	-- M	-- REQUIRED; INT	-- ## Number performed
					 , sum(T.Successful)	AS '@successful' -- M	-- REQUIRED; INT -- Number of successful
					 , sum(T.Retrieved)	AS '@retrieved'	-- O	-- INT	-- ## Number of Polyp retrieved -> is ONLY for COLON/FLEXI
					 , T.comment 	AS '@comment'	-- O	--## Use this field to define what “Other” is when selected.
					 , T.Morphology AS '@morphology' -- **************************** TO DO *********************************

				FROM dbo.tvfNED_ProcedureTherapeutic(P.ProcedureType, @ProcedureId, Staff.ConsultantTypeId) AS T --## Which Consultant's Record in the Procedure?
					LEFT JOIN dbo.ERS_Sites ES ON es.SiteId = T.SiteId
					LEFT JOIN tvfProcedureResectedColon(@ProcedureId) RC ON RC.RegionId = ES.RegionId
				group by T.SiteId,T.NedName, 
						CASE WHEN rc.RegionId IS NULL THEN T.[Site] ELSE 'Anastomosis' END,
						T.EndoRole,
						T.polypSize,
						T.PolypSizeInt,
						T.Detected,
						T.Tattooed, 
						T.comment,
						T.Morphology) as a
				FOR XML PATH('therapeutic'), ROOT('therapeutics'), TYPE
			)/* End of: Therapeutic List- for a Staff Member		*/
			FROM dbo.tvfNED_ProcedureConsultants(@ProcedureId, P.ProcedureType) AS Staff
			WHERE Staff.EndosId > 0
			FOR XML PATH('Staff'), ROOT('staff.members'), TYPE
		)
			/*	##### Indications: -- 1 or Many	*/		
			, (
				SELECT 
					  dbo.HTMLDecode(I.NedTerm) As '@indication'
					, I.Comment AS '@comment'
					, I.elevatedCalprotectinValue AS '@elevatedCalprotectinValue' -- When indication is Elevated calprotectin then specify the value in (micrograms/gram)
					FROM dbo.tvfNED_ProcedureIndication(@ProcedureId) AS I
					FOR XML PATH('indication'), ROOT('indications'), TYPE
			)
			/*	##### subIndications: -- 0 or Many	*/	
			, (
				SELECT 
					  I.NedTerm As '@type'
					, I.Comment AS '@comment'
					FROM dbo.tvfNED_ProcedureSubIndication(@ProcedureId) AS I
					FOR XML PATH('subIndication'), ROOT('subIndications'), TYPE
			)
			
			/*	##### Limitations: */
			,(
				Select 	
					  L.Limitation As '@limitation'
					, L.Comment As '@comment'
				from [dbo].[tvfNED_ProcedureLimitation](P.ProcedureType, @ProcedureId) AS L
					FOR XML PATH('limitation'), ROOT('limitations'), TYPE
			)	

			/*	##### Biopsy: 0 or Many		*/ --## For Colon/Flexi/OGD
			, (	SELECT 
						  B.BiopsySite		AS '@biopsySite'
						, B.NumberPerformed AS '@numberPerformed'
					FROM [dbo].[tvfNED_ProcedureBiopsy](p.ProcedureType, @ProcedureId) AS B				
					 FOR XML PATH('biopsy'), ROOT('biopsies'), TYPE
			)
			/*	##### Diagnoses: 1 or Many		*/ 
			, (	SELECT 
						  D.Ned_Name	AS '@diagnosis'
						, D.tattooed	AS '@tattooed'
						, CASE WHEN RIGHT(D.Site,2) = ', '
							THEN (LEFT(D.Site, LEN(D.Site)-1))
							ELSE  D.Site END		AS '@site'
						, CASE WHEN RIGHT(D.Comment,2)=', ' 
							THEN (LEFT(D.Comment, LEN(D.Comment)-1)) 
							ELSE D.Comment END
									AS '@comment'	--## Remove the extra ',' at the end!
						,D.barrettsLengthCircumferential as '@barrettsLengthCircumferential' --Required for diagnosis of Barretts
						,D.barrettsLengthMaximum AS '@barrettsLengthMaximum'--, barrettsLengthMaximum --Required for diagnosis of Barretts
						,D.barretsInspectionTime AS '@barretsInspectionTime'--, barretsInspectionTime --Required for diagnosis of Barretts
						,D.gastricInspectiontime AS '@gastricInspectionTime'--, gastricInspectiontime --Required if diagnosis of gastric atrophy OR gastric intestinal metaplasia
						,D.oesophagitisLaClassification AS '@oesophagitisLAClassification'--, oesophagitisLaClassification --Required if diagnosis of Oesophagitis - reflux
						,D.DICAScore AS '@DICAScore'--, DICAScore --required if diagnosis of Diverticulosis
						,D.UCEIS AS '@UCEIS'--, UCEIS --If diagnosis is ‘Ulcerative Colitis’ either UCEIS or Mayo scores must be provided
						,D.mayoScore AS '@mayoScore'--, mayoScore --If diagnosis is ‘Ulcerative Colitis’ either UCEIS or Mayo scores must be provided
						--, site --If diagnosis is ‘Crohns Colitis’ or ‘Crohn`s- terminal ileum’ and [ExtentLookup]= ‘Neo-terminal ileum’
						,NULLIF(RutgeertsScore,'') AS '@rutgeertsScore' --If diagnosis is ‘Crohns Colitis’ or ‘Crohn`s- terminal ileum’ and [ExtentLookup]= ‘Neo-terminal ileum’
						, CDEIS AS '@CDEIS' --If diagnosis is ‘Crohns Colitis’ or ‘Crohn`s- terminal ileum’
					FROM [dbo].[tvfNED_Diagnoses](p.ProcedureType, @ProcedureId) AS D
					 FOR XML PATH('diagnose'), ROOT('diagnoses'), TYPE
			)
			/*	##### Adverse events: -- 1 or Many	*/
			,(	SELECT 
					  IsNull(AD.adverseEvent,'None')	As '@adverseEvent'
					, (CASE WHEN AD.adverseEvent = 'Other' THEN AD.Comment END) 						As '@comment'
				FROM dbo.tvfNED_ProcedureAdverseEvents(@ProcedureId)		AS AD
				FOR XML PATH('adverse.event'), ROOT('adverse.events'), TYPE			
			)
			, ( Select * from (Select isnull(scog.NEDTerm, 'other') as '@manufacturerGeneration'
						, CASE WHEN scog.NEDTerm IS NULL THEN scog.Description ELSE NULL END as '@other'
				from ERS_Scopes sco
				join ERS_Procedures p on p.Instrument1 = sco.ScopeId
				join ERS_ScopeGenerations scog on sco.ScopeGenerationId = scog.UniqueId
				where p.ProcedureId = @ProcedureId
				union
				Select isnull(scog.NEDTerm, 'other') as '@manufacturerGeneration'
						, CASE WHEN scog.NEDTerm IS NULL THEN scog.Description ELSE NULL END as '@other'
				from ERS_Scopes sco
				join ERS_Procedures p on p.Instrument2 = sco.ScopeId
				join ERS_ScopeGenerations scog on sco.ScopeGenerationId = scog.UniqueId
				where p.ProcedureId = @ProcedureId) as a
				FOR XML PATH('scopes'), ROOT('scopes'), TYPE
			   )
			 , (
				SELECT ISNULL(C.NEDTerm, 'None') AS '@type', 
				(CASE WHEN C.NEDTerm = 'Other' THEN PC.AdditionalInfo END) 						AS '@comment'

				 FROM ERS_Procedures p
				 LEFT JOIN ERS_ProcedureChromendosopy PC ON p.ProcedureId= PC.ProcedureId
				 LEFT JOIN ERS_Chromendoscopies C ON C.UniqueId = PC.ChromendoscopyId
				 WHERE P.ProcedureId = @ProcedureId 
				 FOR XML PATH('chromendoscopy'), ROOT('chromendoscopies'), TYPE
				)  
				 ,( 
					SELECT CASE 
						WHEN @ProcedureTypeId = 1 THEN
							(SELECT DISTINCT * FROM (SELECT 
								CASE WHEN (SELECT COUNT(*) FROM ERS_UpperGIPremedication WHERE DrugName = 'Pharyngeal Anaesthesia' AND ProcedureId = @ProcedureId) = 1 THEN 'Yes' ELSE 'No' END as '@pharyngealAnaes'
								,pe.WithdrawalMins as '@scopeWithdrawalTime'
								,ISNULL(DA.NEDTerm,'None') as '@distalAttachment'
								,CASE WHEN LOWER(DA.NEDTerm) = 'other' THEN PD.AdditionalInfo ELSE NULL END as '@distalAttachmentOther'
								,CASE WHEN p.Transnasal = 1 THEN 'Nasal' ELSE 'Oral' END as '@OGDRoute'
								,V.NEDTerm as '@OGDMucosalVisualisation'
								,CASE WHEN (SELECT COUNT(*) FROM ERS_ProcedureMucosalCleaning WHERE ProcedureId = @ProcedureId) > 1 THEN 'Other' ELSE ISNULL(C.NEDTerm, 'None') END as '@OGDMucosalCleaning'
								,CASE WHEN (SELECT COUNT(*) FROM ERS_ProcedureMucosalCleaning WHERE ProcedureId = @ProcedureId) > 1 THEN dbo.fnNED_MucosalCleaning(@ProcedureId) WHEN LOWER(C.NEDTerm) = 'other' THEN C.Description ELSE NULL END as '@OGDMucosalCleaningOther'
								,CASE WHEN P.FormerProcedureId IS NOT NULL THEN 'Yes' WHEN (SELECT COUNT(*) FROM ERS_Procedures pq WHERE pq.FormerProcedureId = p.ProcedureId) > 0 THEN 'Yes' ELSE 'No' END as '@dualProcedure'
								,CASE WHEN dbo.fnNED_GetOGDPhotoDocumentation(@ProcedureId) = 1 THEN 'Yes' ELSE 'No' END '@photoDocumentation'
								from ERS_Procedures AS P 
									LEFT JOIN ERS_ProcedureMucosalVisualisation PV ON PV.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_MucosalVisualisation V ON V.UniqueId = PV.MucosalVisualisationId
									LEFT JOIN ERS_ProcedureUpperExtent PE ON PE.ProcedureId = P.ProcedureId AND PE.WithdrawalMins IS NOT NULL /*there may be more than 1 record in the table where there's 2 endos on a procedure*/
									LEFT JOIN ERS_ProcedureDistalAttachment PD ON PD.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_DistalAttachments DA ON DA.UniqueId = PD.DistalAttachmentId
									LEFT JOIN ERS_ProcedureMucosalCleaning PC ON PC.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_MucosalCleaning C ON C.UniqueId = PC.MucosalCleaningId
								Where P.ProcedureId=@ProcedureId) ogd
							FOR XML PATH('OGD'),TYPE)
						WHEN @ProcedureTypeId = 2 THEN
							(SELECT * FROM (SELECT DISTINCT 
								CASE WHEN (SELECT COUNT(*) FROM ERS_UpperGIPremedication WHERE DrugName = 'Pharyngeal Anaesthesia' AND ProcedureId = @ProcedureId) = 1 THEN 'Yes' ELSE 'No' END as '@pharyngealAnaes'
								,CASE WHEN (SELECT COUNT(*) FROM ERS_UpperGIPremedication WHERE DrugName = 'Prophylactic Antibiotics' AND ProcedureId = @ProcedureId) = 1 THEN 'Yes' ELSE 'No' END as '@antibioticGiven'
								,NULLIF(CASE WHEN ((ev.IntendedBileDuct = 1 AND ev.MajorPapillaBile = 1) OR (ev.IntendedBileDuct_ER = 1 AND ev.MajorPapillaBile_ER = 1)) OR
												  ((ev.IntendedPancreaticDuct = 1 AND ev.MajorPapillaPancreatic = 1) OR (ev.IntendedPancreaticDuct_ER = 1 AND ev.MajorPapillaPancreatic_ER = 1)) THEN 'Yes' 
											 WHEN ((ev.IntendedBileDuct = 1 AND ev.MajorPapillaBile <> 1) OR (ev.IntendedBileDuct_ER = 1 AND ev.MajorPapillaBile_ER <> 1)) OR
												  ((ev.IntendedPancreaticDuct = 1 AND ev.MajorPapillaPancreatic <> 1) OR (ev.IntendedPancreaticDuct_ER = 1 AND ev.MajorPapillaPancreatic_ER <> 1)) THEN 'No'
											ELSE 'Not Applicable' END,'') as '@successfulCannulation'
								,ISNULL((SELECT MAX(ISNULL(convert(int, d.StonesSize),0)) FROM ERS_ERCPAbnoDuct d INNER JOIN ERS_Sites s ON S.SiteId = d.SiteId WHERE S.ProcedureId = @ProcedureId),0) AS '@sizeLargestStone'
								--,ISNULL(CASE WHEN ExtractionOutcome = 1 THEN CONVERT(varchar(max),'Yes') 
								--       WHEN ExtractionOutcome <> 0 THEN CONVERT(varchar(max),'No') END,'Not Applicable') AS '@completeStoneClearance'
								,ISNULL((SELECT TOP 1 CASE WHEN ISNULL(ExtractionOutcome,0) = 1 THEN convert(varchar(max),'Yes') 
											  WHEN StoneRemoval = 0 or ExtractionOutcome <> 1 THEN 'No' END 
								 FROM dbo.ERS_ERCPTherapeutics ET WHERE SiteId IN (SELECT SiteId FROM ERS_Sites WHERE ProcedureId = @ProcedureId)),'Not Applicable') as '@completeStoneClearance'
								,ISNULL((SELECT CASE WHEN LOWER(Region) LIKE '%hepatic%' THEN convert(varchar(max), 'Yes') ELSE convert(varchar(max), 'No') END
											FROM ERS_ERCPAbnoDuct eed 
											INNER JOIN dbo.ERS_Sites es ON eed.SiteId = es.SiteId
												INNER JOIN dbo.ERS_Regions er ON es.RegionId = er.RegionId
											WHERE es.ProcedureId = @ProcedureId AND Stricture = 1),convert(varchar(max), 'Not Applicable')) AS '@extraHepaticStricture'
								,ISNULL((SELECT CASE WHEN eed.Stricture = 1 AND eug.BrushCytology = 1 THEN convert(varchar(max),'Yes') WHEN eed.Stricture = 1 AND eug.BrushCytology = 0 THEN convert(varchar(max),'No') WHEN eed.Stricture = 0 THEN 'Not Applicable' END 
										 FROM ERS_ERCPAbnoDuct eed 
												INNER JOIN dbo.ERS_Sites es ON eed.SiteId = es.SiteId
												INNER JOIN dbo.ERS_Regions er ON es.RegionId = er.RegionId
												INNER JOIN dbo.ERS_UpperGISpecimens eug ON es.SiteId = eug.SiteId
											WHERE es.ProcedureId = @ProcedureId AND
												LOWER(Region) LIKE '%hepatic%'),convert(varchar(max),'Not Applicable')) AS '@extrahepaticStrictureCytologyHistologyTaken'
								,ISNULL((SELECT CASE WHEN eug.CorrectStentPlacement = 1 OR ert.CorrectStentPlacement = 1 THEN convert(varchar(max),'Yes') ELSE convert(varchar(max),'No') END
											FROM ERS_ERCPAbnoDuct eed 
												INNER JOIN dbo.ERS_Sites es ON eed.SiteId = es.SiteId
												INNER JOIN dbo.ERS_Regions er ON es.RegionId = er.RegionId
												LEFT JOIN dbo.ERS_UpperGITherapeutics eug ON es.SiteId = eug.SiteId
												LEFT JOIN dbo.ERS_ERCPTherapeutics ert ON es.SiteId = ert.SiteId
											WHERE es.ProcedureId = @ProcedureId AND eed.Stricture = 1 AND eug.StentInsertion = 1 AND
												LOWER(Region) LIKE '%hepatic%'),convert(varchar(max),'Not Applicable')) AS '@extrahepaticStrictureStentSuccessfullyPlaced'
								,CASE WHEN ISNULL(eea.MajorBilrothRoux,0) = 1 THEN 'Yes' ELSE 'No' END AS '@previousSurgeryBilrothRoux'
								,NULLIF(lc.NEDTerm,0) AS '@levelOfComplexity'
								,CASE WHEN (SELECT COUNT(*) FROM ERS_UpperGIPremedication WHERE DrugName = 'Prophylactic Rectal NSAIDS' AND ProcedureId = @ProcedureId) = 1 THEN 'Yes' ELSE 'No' END as '@prophylacticRectalNSAIDS'
								,CASE WHEN eea.MinorSiteLocation IN (1,2) THEN 'No' ELSE 'Yes' END AS '@nativePapilla'
								from ERS_Procedures AS P 
									LEFT JOIN (SELECT eed.AbnoDuctId, es.ProcedureId, eed.Stricture, er.Region 
												FROM ERS_ERCPAbnoDuct eed 
													INNER JOIN dbo.ERS_Sites es ON eed.SiteId = es.SiteId
													INNER JOIN dbo.ERS_Regions er ON es.RegionId = er.RegionId
											WHERE es.ProcedureId = @ProcedureId AND
												LOWER(Region) LIKE '%hepatic%')  ercs ON ercs.ProcedureId = P.ProcedureId
									LEFT JOIN (SELECT Stones, ISNULL(t.ExtractionOutcome,0) ExtractionOutcome, es.ProcedureId 
												FROM ERS_ERCPAbnoDuct a
													 INNER JOIN dbo.ERS_Sites es ON a.SiteId = es.SiteId
													 LEFT JOIN ERS_ERCPTherapeutics t ON t.siteId = a.SiteId
												 WHERE a.Stones = 1) estones ON estones.ProcedureId = P.ProcedureId
									LEFT JOIN dbo.ERS_ERCPPapillaryAnatomy eea ON P.ProcedureId = eea.ProcedureId
									LEFT JOIN dbo.ERS_Visualisation ev ON P.ProcedureId = ev.ProcedureID
									LEFT JOIN dbo.ERS_ProcedureLevelOfComplexity cl ON cl.ProcedureId = P.ProcedureId
									LEFT JOIN dbo.ERS_LevelOfComplexity lc ON lc.UniqueId = cl.ComplexityId
								Where P.ProcedureId=@ProcedureId) ercp
							FOR XML PATH('ERCP'),TYPE) 
						WHEN @ProcedureTypeId = 3 THEN
							(SELECT TOP 1 * FROM (SELECT 
								(SELECT ISNULL(SUM(Detected),0) FROM tvfNED_PolypsDetailsView(@ProcedureTypeId, @ProcedureId)) as '@polypsDetected'
								,CASE WHEN p.ScopeGuide = 1 THEN 'Yes' ELSE 'No' END AS '@magneticEndoscopeImagerUsed'
								,LE.WithdrawalMins AS '@scopeWithdrawalTime'
								,CASE WHEN LE.RectalExamPerformed = 1 THEN 'Yes' ELSE 'No' END AS '@digitalRectalExamination'
								,CONVERT(VARCHAR(19),LE.CaecumIntubationStart, 126) AS '@caecumTime'
								,ISNULL(DA.NEDTerm,'None') as '@distalAttachment'
								,NULLIF(CASE WHEN LOWER(DA.NEDTerm) = 'other' THEN PD.AdditionalInfo ELSE '' END,'') as '@distalAttachmentOther'
								,IT.NEDTerm as '@insertionTechnique'
								,PB.LeftPrepScore as '@bowelPrepLeft'
								,PB.RightPrepScore as '@bowelPrepRight'
								,PB.TransversePrepScore as '@bowelPrepTransverse'
								,PB.TotalPrepScore as '@bowelPrepTotal'
								,ISNULL(B.NEDTerm,'None') as '@bowelPrep'
								,NULLIF(CASE WHEN LOWER(B.NEDTerm) = 'other' THEN B.[Description] ELSE '' END,'') as '@bowelPrepOther'
								,CASE WHEN P.FormerProcedureId IS NOT NULL THEN 'Yes' WHEN (SELECT COUNT(*) FROM ERS_Procedures pq WHERE pq.FormerProcedureId = p.ProcedureId) > 0 THEN 'Yes' ELSE 'No' END as '@dualProcedure'
								,CASE WHEN NULLIF(fit.FITValue,'') IS NOT NULL THEN fit.FITValue END AS '@fitValue'
								,CASE WHEN fit.FITNotKnownId IS NOT NULL THEN fnk.NEDTerm END AS '@fitNotKnown'
								FROM ERS_Procedures AS P 
									LEFT JOIN ERS_ProcedureLowerExtent LE ON LE.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_ProcedureDistalAttachment PD ON PD.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_DistalAttachments DA ON DA.UniqueId = PD.DistalAttachmentId
									LEFT JOIN ERS_ProcedureInsertionTechnique PIT ON PIT.ProcedureId = p.ProcedureId
									LEFT JOIN ERS_InsertionTechniques IT ON IT.UniqueId = PIT.InsertionTechniqueId
									LEFT JOIN ERS_ProcedureBowelPrep PB ON PB.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_BowelPrep B ON B.UniqueId = PB.BowelPrepId
									LEFT JOIN ERS_ProcedureFITValue fit ON fit.ProcedureId = p.ProcedureId
									LEFT JOIN ERS_FitNotKnownReasons fnk ON fnk.UniqueId = fit.FITNotKnownId
								Where P.ProcedureId=@ProcedureId) col
							FOR XML PATH('Colon'),TYPE)
						WHEN @ProcedureTypeId = 4 THEN
							(SELECT * FROM (SELECT 
								(SELECT ISNULL(SUM(Detected),0) FROM tvfNED_PolypsDetailsView(@ProcedureTypeId, @ProcedureId)) as '@polypsDetected'
								,CASE WHEN LE.RectalExamPerformed = 1 THEN 'Yes' ELSE 'No' END AS '@digitalRectalExamination'
								,CASE WHEN p.ScopeGuide = 1 THEN 'Yes' ELSE 'No' END AS '@magneticEndoscopeImagerUsed'
								,ISNULL(DA.NEDTerm,'None') as '@distalAttachment'
								,CASE WHEN LOWER(DA.NEDTerm) = 'other' THEN PD.AdditionalInfo ELSE NULL END as '@distalAttachmentOther'
								,IT.NEDTerm as '@insertionTechnique'
								,PB.LeftPrepScore as '@bowelPrepLeft'
								,PB.TransversePrepScore as '@bowelPrepTransverse'
								,PB.RightPrepScore as '@bowelPrepRight'
								,PB.TotalPrepScore as '@bowelPrepTotal'
								,ISNULL(B.NEDTerm,'None') as '@bowelPrep'
								,CASE WHEN LOWER(B.NEDTerm) = 'other' THEN B.[Description] ELSE NULL END as '@bowelPrepOther'
								,CASE WHEN NULLIF(fit.FITValue,'') IS NOT NULL THEN fit.FITValue END AS '@fitValue'
								,CASE WHEN fit.FITNotKnownId IS NOT NULL THEN fnk.NEDTerm END AS '@fitNotKnown'
								FROM ERS_Procedures AS P 
									LEFT JOIN (Select ProcedureId, Max(CONVERT(int,RectalExamPerformed)) as RectalExamPerformed from ERS_ProcedureLowerExtent group by ProcedureId) LE ON LE.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_ProcedureDistalAttachment PD ON PD.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_DistalAttachments DA ON DA.UniqueId = PD.DistalAttachmentId
									LEFT JOIN ERS_ProcedureInsertionTechnique PIT ON PIT.ProcedureId = p.ProcedureId
									LEFT JOIN ERS_InsertionTechniques IT ON IT.UniqueId = PIT.InsertionTechniqueId
									LEFT JOIN ERS_ProcedureBowelPrep PB ON PB.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_BowelPrep B ON B.UniqueId = PB.BowelPrepId
									LEFT JOIN ERS_ProcedureFITValue fit ON fit.ProcedureId = p.ProcedureId
									LEFT JOIN ERS_FitNotKnownReasons fnk ON fnk.UniqueId = fit.FITNotKnownId
								Where P.ProcedureId=@ProcedureId) flexi
							FOR XML PATH('Flexi'),TYPE)  
						WHEN @ProcedureTypeId IN (6,7) THEN
							(SELECT * FROM (SELECT DISTINCT CASE WHEN pm.DrugName = '' THEN 'Yes' ELSE 'No' END AS '@prophylacticAntibioticsBeforeEUS',
												ISNULL(dbo.fnNED_FNAFNBSolidLesions(@ProcedureId, P.ProcedureType),'Not applicable') AS '@FNAorFNBSolidLesions',
												ISNULL(dbo.fnNED_FNAFNBTissueAdequacy(@ProcedureId),'Not Applicable') AS '@FNAorFNBTissueAdequacy'
											FROM ERS_UpperGIPremedication pm
												LEFT JOIN ERS_Sites s ON s.ProcedureId = pm.ProcedureId
												LEFT JOIN ERS_UpperGITherapeutics T ON S.SiteId = T.SiteId
												LEFT JOIN ERS_UpperGISpecimens AS SP  ON SP.SiteId = S.SiteId
												LEFT JOIN ERS_ERCPTherapeutics ET ON ET.SiteId = S.SiteId
											WHERE pm.ProcedureId = @ProcedureId) eushpb
								FOR XML PATH('EUS'),TYPE)  
						WHEN @ProcedureTypeId IN (8,9) THEN
							 (SELECT * FROM (SELECT DISTINCT 
								 (SELECT ISNULL(SUM(Detected),0) FROM tvfNED_PolypsTotalsView(@ProcedureId)) AS '@polypsDetected'
								 ,ISNULL(DA.NEDTerm,'None') as '@distalAttachment'
								 ,CASE WHEN LOWER(DA.NEDTerm) = 'other' THEN PDA.AdditionalInfo ELSE NULL END as '@distalAttachmentOther'
								 ,ISNULL(ET.NEDTerm,'None') as '@enteroscopyTechnique'
								 ,CASE WHEN LOWER(ET.NEDTerm) = 'other' THEN PET.AdditionalInfo ELSE NULL END as '@enteroscopyTechniqueOther'
								 ,PID.InsertionLength AS '@depthOfInsertion'
								 ,CASE PID.Tattooed WHEN 1 THEN 'Yes' WHEN 0 THEN 'No' ELSE 'Not Applicable' END AS '@tattooMaxDepthInsertion'
								 ,CASE WHEN PE.RectalExamPerformed = 1 AND ET.NEDTerm IN ('Single balloon anal','Double balloon anal') THEN 'Yes' ELSE 'No' END AS '@digitalRectalExamination'
									FROM ERS_Procedures AS P 
										LEFT JOIN ERS_ProcedureDistalAttachment PDA ON PDA.ProcedureId = P.ProcedureId
										LEFT JOIN ERS_DistalAttachments DA ON DA.UniqueId = PDA.DistalAttachmentId
										LEFT JOIN ERS_ProcedureEnteroscopyTechniques PET ON PET.ProcedureId = P.ProcedureId
										LEFT JOIN ERS_EnteroscopyTechniques ET ON ET.UniqueId = PET.TechniqueId
										LEFT JOIN ERS_ProcedureInsertionDepth PID ON PID.ProcedureId = P.ProcedureId
										LEFT JOIN ERS_ProcedureLowerExtent PE ON PE.ProcedureId = P.ProcedureId
									Where P.ProcedureId=@ProcedureId) ent
								FOR XML PATH('ENT'),TYPE)
					END
				  )
		from ERS_Procedures AS P 
		Where P.ProcedureId=@ProcedureId
		FOR XML PATH('procedure'), ROOT('procedures'), TYPE
		)	

    FROM dbo.ERS_Procedures AS P
    LEFT join dbo.ERS_ProcedureDiscomfortScore as DisNo on P.ProcedureId = DisNo.ProcedureId
    LEFT Join dbo.ERS_DiscomfortScores as Dis on DisNo.DiscomfortScoreId = Dis.UniqueId
	LEFT join dbo.ERS_PostProcedureDiscomfortScore PPD on PPD.ProcedureId = P.ProcedureId 
	LEFT join dbo.ERS_DiscomfortScores as PPDD on PPD.DiscomfortScoreId = PPDD.UniqueId
	Left join dbo.ers_lists as PatStat on PatStat.ListDescription = 'Patient Status' and PatStat.ListItemNo = P.PatientStatus 
	Left Join dbo.ERS_UrgencyTypes as Urgency on P.CategoryListId = Urgency.UniqueId
	Left join dbo.ERS_ProcedurePlannedExtent as PPE on P.ProcedureId = PPE.ProcedureId 
	Left Join dbo.ERS_Extent as Ext on PPE.ExtentId = Ext.UniqueId 
	Left join dbo.ERS_ProcedureInsufflation as PIns on P.ProcedureId = PIns.ProcedureId
	Left Join dbo.ERS_Insufflation as Ins on PIns.InsufflationId = Ins.UniqueId 
	Left Join dbo.ERS_ProviderSectors as PS on P.PatientType = PS.UniqueId 
	Left Join dbo.ERS_ReferrerTypes as RT on P.ReferrerType = RT.UniqueId 
	Left join dbo.ERS_ProviderOrganisation as PO on P.ProviderTypeId = PO.UniqueId 
	Left Join dbo.ERS_ProcedureAISoftware as PAIS on P.ProcedureId = PAIS.ProcedureId 
	Left Join dbo.ERS_AISoftware as AIS on PAIS.AISoftwareId = AIS.UniqueId 
	Left Join dbo.ERS_ProcedureChromendosopy as PCHR on PCHR.ProcedureId = p.ProcedureId


  INNER JOIN dbo.ERS_VW_Patients			AS Pat  ON P.PatientId=Pat.[PatientId]
   LEFT JOIN dbo.tvfNED_ProcedureDrugList(@ProcedureId)	AS Drug		ON P.ProcedureId = Drug.ProcedureId	
   --LEFT JOIN dbo.ERS_UpperGIQA				AS QA   ON P.ProcedureId = QA.ProcedureId	-- Patient DIscomfort
   LEFT JOIN dbo.ERS_BowelPreparation		AS BP   ON P.ProcedureId=BP.ProcedureID	-- DIscomfort for Nurse
   LEFT JOIN dbo.ERS_ColonExtentOfIntubation   EL	ON P.ProcedureId = EL.ProcedureId
	   where P.ProcedureId= @ProcedureId
		 for XML PATH ('session'), ROOT('hospital.SendBatchMessage'), ELEMENTS
);

DECLARE   @xmlFileName AS varchar(100)
		, @ReportDate AS VARCHAR(10)
		, @ReportTime AS VARCHAR(8)
		, @xmlPreviousExportFileName AS VARCHAR(100);

SELECT    @ReportDate = CONVERT(VARCHAR(10), CreatedOn, 103)
		, @ReportTime = CONVERT(VARCHAR(8), ModifiedOn, 108) 
FROM dbo.ERS_Procedures WHERE ProcedureId=@ProcedureId;

--== Check whether Admin has added/removed the '\' at the end of the Path.. 
SET @ExportFolderPath = (CASE WHEN RIGHT(@ExportFolderPath, 1)='\' THEN @ExportFolderPath ELSE (@ExportFolderPath + '\') END);

SELECT top 1 @xmlPreviousExportFileName = xmlFileName FROM [dbo].[ERS_NedFilesLog] WHERE ProcedureId=@ProcedureId ORDER BY [LogId] desc;

--### File Path and Name example: 'NED_xml_output\74_22-09-2017_09-32-53_00831101o.xml' vs '99_19-10-2017_16-24-16_00205602e.xml'
SET @xmlFileName =    @ExportFolderPath 
					+ @site + '_' 
					+ replace(@ReportDate, '/', '-') + '_' 
					+ replace(@ReportTime, ':', '-') + '_' 
					+ @uniqueid	
					+ '.xml';					

SELECT @returnXML AS returnXML
				 , '<hospital.SendBatchMessage xmlns:xsd="http://www.w3.org/2001/XMLSchema"'
				  + 
				 ' xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"'
				  +
				 ' xmlns="https://www.jets.nhs.uk/schema/hospital.sendbatchmessage-version2.xsd"'
				  +
				 ' softwareVersion="2"' AS NS_Info		--## These extra info will be added to the Actual XML file in .NET while exporting;
				 , @xmlFileName AS xmlFileName
				 , IsNull(@xmlPreviousExportFileName, 'x') AS PreviousFileName;

END

GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO
------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rony
-- TFS#	3583
-- Description of change
-- Nurse Drop dropdown on create procedure page not mandatory 
------------------------------------------------------------------------------------------------------------------------

update dbo.ERS_FieldLabels set FieldName='Nurse', Required=1, CannotBeSuppressed=1 where FieldLabelID=56 

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	3583
------------------------------------------------------------------------------------------------------------------------
GO
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rezaul Karim
-- TFS#	3887
-- Description of change: Updating Cancellation reason suppresses the reason
-------------------------------------------------------------------------------------------------------------------------
GO
dbo.DropIfExist
    @ObjectName = 'sch_CancellationReasons_insert_update',
    @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[sch_CancellationReasons_insert_update](
	@CancelReasonId int,
	@Code VARCHAR(30),
	@Detail varChar(50),
	@CancelledByHospital bit,
	@UserId Int
)

AS 
	SET NOCOUNT ON
	BEGIN TRANSACTION
	BEGIN TRY
		IF Exists (SELECT CancelReasonId FROM ERS_CancelReasons WHERE CancelReasonId = @CancelReasonId)
		BEGIN
			declare @suppressed BIT = (select  suppressed FROM ERS_CancelReasons where CancelReasonId = @CancelReasonId)
			--exists so Update with new values
			UPDATE ERS_CancelReasons
			SET Code = @Code,
				Detail = @Detail,
				CancelledByHospital = @CancelledByHospital,
				Suppressed = @suppressed,
				WhoUpdatedId = @UserId,
				WhenUpdated = GetDate()
			WHERE CancelReasonId = @CancelReasonId 
		END
		ELSE
		BEGIN
			INSERT ERS_CancelReasons(
				Code,
				CancelCodeId,
				Detail,
				CancelledByHospital,
				Suppressed,
				WhoCreatedId,
				WhenCreated,
				WhoUpdatedId,
				WhenUpdated)
			VALUES (@Code,
					1,
					@Detail,
					@CancelledByHospital,
					0,
					@UserId,
					GetDate(),
					@UserId,
					GetDate())
		END
	END TRY

	BEGIN CATCH
		DECLARE @ErrorMessage NVARCHAR(4000);
		DECLARE @ErrorSeverity INT;
		DECLARE @ErrorState INT;

		SELECT @ErrorMessage = ERROR_MESSAGE(),
			   @ErrorSeverity = ERROR_SEVERITY(),
			   @ErrorState = ERROR_STATE();
    
		RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

		IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
	END CATCH
	IF @@TRANCOUNT > 0 COMMIT TRANSACTION;
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	No TFS - Item 3887  by Rezaul
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rezaul Karim
-- TFS#	3835
-- Description of change: polyp removed - then edited
-------------------------------------------------------------------------------------------------------------------------
dbo.DropIfExist
    @ObjectName = 'usp_CheckUpperGISpecimensForRecordDeletion',
    @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [DBO].[usp_CheckUpperGISpecimensForRecordDeletion]
    @SiteId INT
AS
BEGIN
    DECLARE @None BIT = NULL,
            @Biopsy BIT,
            @BrushCytology BIT,
            @FNA int = 0,
            @FNB BIT,
            @HOTBiopsy BIT,
            @POLYPS BIT
    SELECT @None = None, @Biopsy = Biopsy, @BrushCytology = BrushCytology, @FNA = EUSFNANumberOfPasses,@FNB = FNB, @HOTBiopsy = HotBiopsy, @POLYPS = Polypectomy 
			FROM dbo.ERS_UpperGISpecimens WHERE SiteId = @SiteId;
    IF @None > 0 OR
		@Biopsy > 0 OR
       @BrushCytology > 0 OR
       @FNA > 0 OR
       @FNA > 0 OR
       @HOTBiopsy > 0 OR
       @POLYPS > 0
     
    BEGIN
        
        declare @Result BIT = 0
    END
    ELSE
    BEGIN
		DELETE FROM ERS_UpperGISpecimens WHERE SiteId = @SiteId
		DELETE FROM ERS_RecordCount WHERE  SiteId = @SiteId AND Identifier = 'Specimens Taken'
    END
END

GO
dbo.DropIfExist
    @ObjectName = 'abnormalities_common_polyp_specimen_details_save',
    @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[abnormalities_common_polyp_specimen_details_save]
(
		@SiteId int,
		@LoggedInUserId int
)
AS

BEGIN TRANSACTION

BEGIN TRY
	
	--update specimen table
	DECLARE @SpecimenTotal INT = (SELECT COUNT(*) FROM ERS_CommonAbnoPolypDetails WHERE Successful  > 0 AND SiteId = @SiteId)

	IF @SpecimenTotal > 0
	BEGIN
		DECLARE @ProcedureId int = (SELECT ProcedureId FROM ERS_Sites WHERE SiteId = @SiteId)

		IF NOT EXISTS (SELECT 1 FROM dbo.ERS_UpperGISpecimens WHERE SiteId = @SiteId)
			BEGIN
				INSERT INTO ERS_UpperGISpecimens (SiteId, Polypectomy,	PolypectomyQty, WhoCreatedId, WhenCreated) 
				VALUES (@SiteId, 1, @SpecimenTotal, @LoggedInUserId, GETDATE())

				IF NOT EXISTS (SELECT 1 FROM ERS_RecordCount WHERE ProcedureId = @ProcedureId AND SiteId = @SiteId AND Identifier = 'Specimens Taken')
				BEGIN
					INSERT INTO ERS_RecordCount ([ProcedureId],	[SiteId], [Identifier], [RecordCount])
					VALUES (@ProcedureId, @SiteId, 'Specimens Taken', 1)
				END 
			END
		ELSE
			BEGIN
				UPDATE ERS_UpperGISpecimens
				SET
					Polypectomy = (SELECT CASE WHEN @SpecimenTotal > 0 THEN 1 ELSE 0 END),
					PolypectomyQty = @SpecimenTotal
				WHERE SiteId = @SiteId
			END
		IF NOT EXISTS (SELECT 1 FROM ERS_UpperGIFollowUp WHERE ProcedureId = @ProcedureId)
		BEGIN
			INSERT INTO ERS_UpperGIFollowUp (ProcedureId, AwaitingPathologyResults) 
			VALUES (@ProcedureId, 1)
		END


		   --Will set follow up section as complete
		   exec UI_update_procedure_summary @ProcedureId, 'Follow up', 'Follow up', 1

			INSERT INTO ERS_RecordCount ([ProcedureId], [SiteId], [Identifier],[RecordCount])
			VALUES (@ProcedureId,NULL,'Follow Up', 1)

	END

	IF @SpecimenTotal = 0

		BEGIN
			IF EXISTS(SELECT 1 FROM ERS_UpperGISpecimens WHERE SiteId = @SiteId)
				BEGIN
					UPDATE ERS_UpperGISpecimens
					SET
						Polypectomy = (SELECT CASE WHEN @SpecimenTotal > 0 THEN 1 ELSE 0 END),
						PolypectomyQty = @SpecimenTotal
					WHERE SiteId = @SiteId
				END
			exec usp_CheckUpperGISpecimensForRecordDeletion @SiteId
		END
END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;

GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#3835	polyp removed - then edited
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rony
-- TFS#	2970
-- Description of change: tattoo on tomour
-- Updated by	:	Rezaul
-- TFS#	3597
-- Description of change: tattoo on bug
------------------------------------------------------------------------------------------------------------------------
GO
 IF NOT EXISTS (
        SELECT 1
        FROM INFORMATION_SCHEMA.COLUMNS
        WHERE TABLE_NAME = 'ERS_CommonAbnoPolypDetails' AND
              COLUMN_NAME IN ('TattooLocationDistal', 'TattooLocationProximal')
    )
    BEGIN
		
		ALTER TABLE dbo.ERS_CommonAbnoPolypDetails
            ADD TattooLocationDistal bit,
             TattooLocationProximal bit;
    END
GO

dbo.DropIfExist
    @ObjectName = 'usp_CheckUpperGITherapeuticsForRecordDeletion',
    @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[usp_CheckUpperGITherapeuticsForRecordDeletion]
    @SiteId INT
AS
BEGIN
    DECLARE @ArgonBeamDiathermy BIT = NULL,
            @EMR BIT,
            @BandLigation BIT,
            @BandingPiles BIT,
            @BalloonDilation BIT,
            @BicapElectro BIT,
            @Clip BIT,
            @Diverticulotomy BIT,
            @EndoloopPlacement BIT = NULL,
            @EndoscopicResection BIT = NULL,
            @ForeignBody BIT,
            @FlatusTubeInsertion BIT,
            @HeatProbe BIT,
            @HotBiopsy BIT,
            @Haemospray BIT,
            @Injection BIT,
            @Marking BIT,
            @Polypectomy BIT,
            @StentInsertion BIT,
            @StentRemoval BIT;
    SELECT @ArgonBeamDiathermy = ArgonBeamDiathermy, @EMR = EMR, @BandLigation = BandLigation, @BandingPiles = BandingPiles,@BalloonDilation = BalloonDilation, @BicapElectro = BicapElectro, @Clip = Clip,@Diverticulotomy = Diverticulotomy,@EndoloopPlacement = EndoloopPlacement, 
		@EndoscopicResection = EndoscopicResection, @ForeignBody = ForeignBody, @FlatusTubeInsertion = FlatusTubeInsertion,  @HeatProbe = HeatProbe, @HotBiopsy = HotBiopsy,@Haemospray = Haemospray,@Injection = Injection, @Marking = Marking, @Polypectomy = Polypectomy, @StentInsertion = StentInsertion, @StentRemoval = StentRemoval
			FROM dbo.ERS_UpperGITherapeutics WHERE SiteId = @SiteId;
    IF @EMR > 0 OR
		@ArgonBeamDiathermy > 0 OR
       @BandLigation > 0 OR
       @BandingPiles > 0 OR
       @BalloonDilation > 0 OR
       @BicapElectro > 0 OR
       @Clip > 0 OR
       @Diverticulotomy > 0 OR
       @EndoloopPlacement > 0 OR
       @EndoscopicResection > 0 OR
       @ForeignBody > 0 OR
       @FlatusTubeInsertion > 0 OR
       @HeatProbe > 0 OR
       @HotBiopsy > 0 OR
       @Haemospray > 0 OR
       @Injection > 0 OR
       @Marking > 0 OR
       @Polypectomy > 0 OR
       @StentInsertion > 0 OR
       @StentRemoval > 0 
    BEGIN
        
        declare @Result BIT = 0
    END
    ELSE
    BEGIN
		DELETE FROM DBO.ERS_UpperGITherapeutics WHERE SiteId=@SiteId
        	DELETE FROM dbo.ERS_RecordCount WHERE SiteId=@SiteId AND Identifier='Therapeutic Procedures';
    END
END
GO

EXEC dbo.DropIfExist 
    @ObjectName = 'abnormalities_common_polyp_details_save', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[abnormalities_common_polyp_details_save]
(
		@SiteId int,
		@Size int,
		@Excised bit,
		@Retreived bit,
		@Successful bit,
		@Labs bit,
		@Removal int,
		@RemovalMethod int,
		@Probably bit,
		@TumorTypeId int,
		@ParisClass int,
		@PitPattern int, 
		@Infammatory bit,
		@PostInflammatory bit,
		@TattooedId int,
		@TattooMarkingTypeId int,
		@PolypConditionIds varchar(500),
		@PolypTypeId int,
		@TattooLocationDistal bit,
		@TattooLocationProximal bit,
		@LoggedInUserId int
)
AS

BEGIN TRANSACTION

BEGIN TRY
	DECLARE @PolypDetailsId int
	
	INSERT INTO ERS_CommonAbnoPolypDetails (
		SiteId,
		Size,
		Excised,
		Retreived,
		Successful,
		Labs,
		Removal,
		RemovalMethod,
		Probably,
		Type,
		ParisClass,
		PitPattern, 
		Infammatory,
		PostInflammatory,
		TattooedId,
		TattooedMarkingTypeId,
		PolypTypeId,
		TattooLocationDistal,
		TattooLocationProximal)
	VALUES(
		@SiteId,
		@Size,
		@Excised,
		@Retreived,
		@Successful,
		@Labs,
		@Removal,
		@RemovalMethod,
		@Probably,
		@TumorTypeId,
		@ParisClass,
		@PitPattern, 
		@Infammatory,
		@PostInflammatory,
		@TattooedId,
		@TattooMarkingTypeId,
		@PolypTypeId,
		@TattooLocationDistal,
		@TattooLocationProximal)

	SELECT @PolypDetailsId = Scope_Identity()

	DELETE FROM ERS_CommonAbnoPolypConditions WHERE PolypDetailId = @PolypDetailsId

	INSERT INTO ERS_CommonAbnoPolypConditions (PolypDetailId, PolypConditionId)
	SELECT @PolypDetailsId, Item FROM fnSplitString(@PolypConditionIds,',')

	--summary
	UPDATE ERS_CommonAbnoPolypDetails SET Summary = dbo.common_polpydetails_summary(@SiteId, @PolypDetailsId) WHERE PolypDetailId = @PolypDetailsId

END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;

GO
EXEC dbo.DropIfExist 
    @ObjectName = 'abnormalities_common_polyp_therapy_details_save', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[abnormalities_common_polyp_therapy_details_save]
(
		@SiteId int,
		@LoggedInUserId int
)
AS

BEGIN TRANSACTION

BEGIN TRY
	
	--update therapeutics table
	DECLARE @PolypectomyTotal INT = (SELECT COUNT(*) FROM ERS_CommonAbnoPolypDetails WHERE (Excised > 0 OR Retreived > 0 OR Successful > 0) AND SiteId = @SiteId),
			@TattooedTotal INT = (SELECT COUNT(*) FROM ERS_CommonAbnoPolypDetails WHERE TattooedId = (SELECT UniqueId FROM ERS_TattooOptions WHERE LOWER(Description) = 'yes') AND SiteId = @SiteId),
			@TattooedMarkingTypeId INT = (SELECT top 1 TattooedMarkingTypeId FROM ERS_CommonAbnoPolypDetails WHERE TattooedId = (SELECT UniqueId FROM ERS_TattooOptions WHERE LOWER(Description) = 'yes') AND SiteId = @SiteId ORDER BY PolypDetailId DESC), --TFS 3597
			@TattooLocationDistal bit = (SELECT top 1 TattooLocationDistal FROM ERS_CommonAbnoPolypDetails WHERE SiteId = @SiteId ORDER BY PolypDetailId DESC),
			@TattooLocationProximal bit = (SELECT top 1 TattooLocationProximal FROM ERS_CommonAbnoPolypDetails WHERE SiteId = @SiteId ORDER BY PolypDetailId DESC)
	IF @PolypectomyTotal > 0 OR @TattooedTotal > 0 
	BEGIN
		DECLARE @ProcedureId int = (SELECT ProcedureId FROM ERS_Sites WHERE SiteId = @SiteId)

		IF NOT EXISTS (SELECT 1 FROM ERS_UpperGITherapeutics WHERE SiteId = @SiteId)
		BEGIN
			INSERT INTO ERS_UpperGITherapeutics (SiteId, Marking,MarkingType,	MarkedQuantity,	Polypectomy, PolypectomyQty, CarriedOutRole, EndoRole, TattooLocationDistal,TattooLocationProximal,WhoCreatedId, WhenCreated) 
			VALUES (@SiteId, (SELECT CASE WHEN @TattooedTotal > 0 THEN 1 ELSE 0 END), NULLIF(@TattooedMarkingTypeId,0),NULLIF(@TattooedTotal,0), (SELECT CASE WHEN @PolypectomyTotal > 0 THEN 1 ELSE 0 END), NULLIF(@PolypectomyTotal, 0), 1, 1, @TattooLocationDistal,@TattooLocationProximal,@LoggedInUserId, GETDATE())--TFS 3597

			IF NOT EXISTS (SELECT 1 FROM ERS_RecordCount WHERE ProcedureId = @ProcedureId AND SiteId = @SiteId AND Identifier = 'Therapeutic Procedures')
			BEGIN
				INSERT INTO ERS_RecordCount ([ProcedureId],	[SiteId], [Identifier], [RecordCount])
				VALUES (@ProcedureId, @SiteId, 'Therapeutic Procedures', 1)
			END 
		END
		ELSE
		BEGIN
			UPDATE ERS_UpperGITherapeutics
			SET
				Polypectomy = (SELECT CASE WHEN @PolypectomyTotal > 0 THEN 1 ELSE 0 END),
				PolypectomyQty = NULLIF(@PolypectomyTotal, 0),
				Marking = (SELECT CASE WHEN @TattooedTotal > 0 THEN 1 ELSE 0 END),
				MarkedQuantity = NULLIF(@TattooedTotal,0),
				TattooLocationDistal = @TattooLocationDistal,
				TattooLocationProximal = @TattooLocationProximal
			WHERE SiteId = @SiteId
		END
	END

	--TFS 3835 Start
	IF @PolypectomyTotal = 0
		BEGIN
			UPDATE ERS_UpperGITherapeutics
			SET
				Polypectomy = 0,
				PolypectomyQty = 0,
				Marking = (SELECT CASE WHEN @TattooedTotal > 0 THEN 1 ELSE 0 END),
				MarkedQuantity = NULLIF(@TattooedTotal,0),
				MarkingType = NULLIF(@TattooedMarkingTypeId,0),
				TattooLocationDistal = @TattooLocationDistal,
				TattooLocationProximal = @TattooLocationProximal
				WHERE SiteId = @SiteId
			EXEC usp_CheckUpperGITherapeuticsForRecordDeletion @SiteId
		END
	--TFS 3835 End

END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;

GO
EXEC dbo.DropIfExist 
    @ObjectName = 'abnormalities_common_polyp_details_select', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[abnormalities_common_polyp_details_select]
(
	@SiteId INT
)
AS
BEGIN
	SELECT 
		PolypDetailId,
		t.Description as PolypType,
		d.SiteId,
		Size,
		Excised,
		Retreived,
		Successful,
		Labs,
		Removal,
		RemovalMethod,
		Probably,
		Type,
		ParisClass,
		PitPattern, 
		Infammatory,
		PostInflammatory,
		TattooedId,
		TattooedMarkingTypeId,
		TattooLocationDistal,
		TattooLocationProximal,
		(SELECT STUFF((SELECT ',' + convert(varchar(10), c.PolypConditionId) as [text()] FROM ERS_CommonAbnoPolypConditions c WHERE c.PolypDetailId = d.PolypDetailId FOR XML PATH('')),1,1,'')) as PolypConditionIds
	FROM ERS_CommonAbnoPolypDetails d
		INNER JOIN ERS_PolypTypes t on t.UniqueId = d.PolypTypeId
	WHERE d.SiteId = @SiteId
END
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	2970,3597
------------------------------------------------------------------------------------------------------------------------


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rezaul Karim
-- TFS#	3836
-- Description of change: Tumour / lesion - theraputics 
-------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by				:	Adrian Schaal 
-- Updated on				:	25th June, 2024
-- TFS#						:	3208
-- Description of change	:	Tumours to be available on all gastros
-- SP						:	abnormalities_colon_tumour_save - added Tumour field
------------------------------------------------------------------------------------------------------------------------

GO

IF NOT EXISTS (
        SELECT 1
        FROM INFORMATION_SCHEMA.COLUMNS
        WHERE TABLE_NAME = 'ERS_ColonAbnoTumour' AND
              COLUMN_NAME IN ('Tumour')
    )
    BEGIN
		ALTER TABLE [dbo].[ERS_ColonAbnoTumour] 
			ADD Tumour BIT NOT NULL CONSTRAINT [DF_ERS_ColonAbnoTumour_Tumour] DEFAULT ((0))
    END

GO

dbo.DropIfExist
    @ObjectName = 'abnormalities_colon_tumour_save',
    @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[abnormalities_colon_tumour_save]
(
	@SiteId INT,
	@None BIT,
	@Submucosal BIT,
	@SubmucosalQuantity INT,
	@SubmucosalLargest INT,
	@SubmucosalProbably BIT,
	@SubmucosalType INT,
	@Villous BIT,
	@VillousQuantity INT,
	@VillousLargest INT,
	@VillousProbably BIT,
	@VillousType INT,
	@Ulcerative BIT,
	@UlcerativeQuantity INT,
	@UlcerativeLargest INT,
	@UlcerativeProbably BIT,
	@UlcerativeType INT,
	@Stricturing BIT,
	@StricturingQuantity INT,
	@StricturingLargest INT,
	@StricturingProbably BIT,
	@StricturingType INT,
	@Polypoidal BIT,
	@PolypoidalQuantity INT,
	@PolypoidalLargest INT,
	@PolypoidalProbably BIT,
	@PolypoidalType INT,
	@Granuloma BIT,
	@GranulomaQuantity INT,
	@GranulomaLargest INT,
	@Dysplastic BIT,
	@DysplasticQuantity INT,
	@DysplasticLargest INT,
	@TattooId INT NULL,
	@TattooMarkingTypeId  INT NULL ,
	@TattooQuantity INT NULL,
	@LoggedInUserId INT,
	@Tumour BIT
)
AS

SET NOCOUNT ON

DECLARE @proc_id INT
DECLARE @proc_type INT
Declare @isTumourUnchecked BIT = 0
BEGIN TRANSACTION

BEGIN TRY
	SELECT 
		@proc_id = p.ProcedureId,
		@proc_type = p.ProcedureType
	FROM 
		ERS_Sites s
	JOIN 
		ERS_Procedures p ON s.ProcedureId = p.ProcedureId
	WHERE 
		SiteId = @SiteId
			
	IF NOT EXISTS (SELECT 1 FROM ERS_ColonAbnoTumour WHERE SiteId = @SiteId)
	BEGIN
		INSERT INTO ERS_ColonAbnoTumour (
			SiteId
		   ,[None]
		   ,[Submucosal]
		   ,[SubmucosalQuantity]
		   ,[SubmucosalLargest]
		   ,[SubmucosalProbably]
		   ,[SubmucosalType]
		   ,[Villous]
		   ,[VillousQuantity]
		   ,[VillousLargest]
		   ,[VillousProbably]
		   ,[VillousType]
		   ,[Ulcerative]
		   ,[UlcerativeQuantity]
		   ,[UlcerativeLargest]
		   ,[UlcerativeProbably]
		   ,[UlcerativeType]
		   ,[Stricturing]
		   ,[StricturingQuantity]
		   ,[StricturingLargest]
		   ,[StricturingProbably]
		   ,[StricturingType]
		   ,[Polypoidal]
		   ,[PolypoidalQuantity]
		   ,[PolypoidalLargest]
		   ,[PolypoidalProbably]
		   ,[PolypoidalType]
		   ,[Granuloma]
		   ,[GranulomaQuantity]
		   ,[GranulomaLargest]
		   ,[Dysplastic]
		   ,[DysplasticQuantity]
		   ,[DysplasticLargest]
		   ,[PneumatosisColi]
		   ,[TattooedId]
		   ,[TattooMarkingTypeId]
		   ,[TattooedQuantity]
		   ,WhoCreatedId
		   ,WhenCreated
		   ,Tumour)
		VALUES (
			@SiteId,
			@None,
			@Submucosal,
		    @SubmucosalQuantity,
		    @SubmucosalLargest,
		    @SubmucosalProbably,
		    @SubmucosalType,
		    @Villous,
		    @VillousQuantity,
		    @VillousLargest,
		    @VillousProbably,
		    @VillousType,
		    @Ulcerative,
		    @UlcerativeQuantity,
		    @UlcerativeLargest,
		    @UlcerativeProbably,
		    @UlcerativeType,
		    @Stricturing,
		    @StricturingQuantity,
		    @StricturingLargest,
		    @StricturingProbably,
		    @StricturingType,
		    @Polypoidal,
		    @PolypoidalQuantity,
		    @PolypoidalLargest,
		    @PolypoidalProbably,
		    @PolypoidalType,
		    @Granuloma,
		    @GranulomaQuantity,
		    @GranulomaLargest,
		    @Dysplastic,
		    @DysplasticQuantity,
		    @DysplasticLargest,
		    0,
			@TattooId,
		    NULLIF(@TattooMarkingTypeId, 0),
		    @TattooQuantity,
			@LoggedInUserId,
			GETDATE(),
			@Tumour) 

		INSERT INTO ERS_RecordCount (
			[ProcedureId],
			[SiteId],
			[Identifier],
			[RecordCount]
		)
		VALUES (
			@proc_id,
			@SiteId,
			'Tumour',
			1)
	END

	ELSE IF (@None = 0 AND @Submucosal = 0 AND @Villous = 0 AND @Ulcerative = 0 AND @Stricturing = 0 AND @Polypoidal = 0 AND @Granuloma = 0 AND @Dysplastic = 0)
	BEGIN
		DELETE FROM ERS_ColonAbnoTumour 
		WHERE SiteId = @SiteId

		DELETE FROM ERS_RecordCount 
		WHERE SiteId = @SiteId
		AND Identifier = 'Tumour'
		SET @isTumourUnchecked = 1
	END
	
	ELSE
	BEGIN
		UPDATE 
			ERS_ColonAbnoTumour
		SET 
			[None] = @None,
			Submucosal= @Submucosal,
		    SubmucosalQuantity = @SubmucosalQuantity,
		    SubmucosalLargest = @SubmucosalLargest,
		    SubmucosalProbably = @SubmucosalProbably,
		    SubmucosalType = @SubmucosalType,
		    Villous = @Villous,
		    VillousQuantity = @VillousQuantity,
		    VillousLargest = @VillousLargest,
		    VillousProbably = @VillousProbably,
		    VillousType = @VillousType,
		    Ulcerative = @Ulcerative,
		    UlcerativeQuantity = @UlcerativeQuantity,
		    UlcerativeLargest = @UlcerativeLargest,
		    UlcerativeProbably = @UlcerativeProbably,
		    UlcerativeType = @UlcerativeType,
		    Stricturing = @Stricturing,
		    StricturingQuantity = @StricturingQuantity,
		    StricturingLargest = @StricturingLargest,
		    StricturingProbably = @StricturingProbably,
		    StricturingType = @StricturingType,
		    Polypoidal = @Polypoidal,
		    PolypoidalQuantity = @PolypoidalQuantity,
		    PolypoidalLargest = @PolypoidalLargest,
		    PolypoidalProbably = @PolypoidalProbably,
		    PolypoidalType = @PolypoidalType,
		    Granuloma =@Granuloma,
		    GranulomaQuantity = @GranulomaQuantity,
		    GranulomaLargest = @GranulomaLargest,
		    Dysplastic = @Dysplastic,
		    DysplasticQuantity = @DysplasticQuantity,
		    DysplasticLargest = @DysplasticLargest,
			TattooedId = @TattooId,
			TattooedQuantity = @TattooQuantity,
			TattooMarkingTypeId = NULLIF(@TattooMarkingTypeId, 0),
			WhoUpdatedId = @LoggedInUserId,
			WhenUpdated = GETDATE(),
			Tumour = @Tumour
		WHERE 
			SiteId = @SiteId
	END


	IF @TattooId >= 2
		BEGIN
			IF NOT EXISTS (SELECT 1 FROM ERS_UpperGITherapeutics WHERE SiteId = @SiteId)
			BEGIN
				INSERT INTO ERS_UpperGITherapeutics (SiteId, Marking,	MarkingType, MarkedQuantity, CarriedOutRole, EndoRole, WhoCreatedId, WhenCreated) 
				VALUES (@SiteId, 1, NULLIF(@TattooMarkingTypeId, 0), @TattooQuantity, 1, 1, @LoggedInUserId, GETDATE())

				IF NOT EXISTS (SELECT 1 FROM ERS_RecordCount WHERE ProcedureId = @proc_id AND SiteId = @SiteId AND Identifier = 'Therapeutic Procedures')
				BEGIN
					INSERT INTO ERS_RecordCount ([ProcedureId],	[SiteId], [Identifier], [RecordCount])
					VALUES (@proc_id, @SiteId, 'Therapeutic Procedures', 1)
				END 
			END
			ELSE IF EXISTS (SELECT 1 FROM ERS_UpperGITherapeutics WHERE SiteId = @SiteId AND CarriedOutRole = 1)
			BEGIN
				UPDATE ERS_UpperGITherapeutics
				SET 
					Marking = CASE WHEN @TattooId > 0 THEN 1 ELSE 0 END,	
					MarkingType = NULLIF(@TattooMarkingTypeId, 0),
					MarkedQuantity = @TattooQuantity,
					WhoUpdatedId = @LoggedInUserId,
					WhenUpdated = GETDATE()
				WHERE
					SiteId = @SiteId AND
					CarriedOutRole = 1
			END
			ELSE
			BEGIN
				UPDATE ERS_UpperGITherapeutics
				SET 
					Marking = CASE WHEN @TattooId > 0 THEN 1 ELSE 0 END,	
					MarkingType = NULLIF(@TattooMarkingTypeId, 0), 
					MarkedQuantity = @TattooQuantity,
					WhoUpdatedId = @LoggedInUserId,
					WhenUpdated = GETDATE()
				WHERE 
					SiteId = @SiteId AND
					CarriedOutRole = 2
			END
		END
	IF EXISTS(SELECT 1 FROM ERS_UpperGITherapeutics WHERE SiteId = @SiteId) and (@TattooId IS NULL OR @TattooId < 2)
		BEGIN
			UPDATE ERS_UpperGITherapeutics
				SET 
					Marking = 0,	
					MarkingType = NULLIF(@TattooMarkingTypeId, 0),
					MarkedQuantity = @TattooQuantity,
					WhoUpdatedId = @LoggedInUserId,
					WhenUpdated = GETDATE()
				WHERE
					SiteId = @SiteId
		END
	IF  @isTumourUnchecked > 0  OR @TattooId IS NULL OR @TattooId < 2
		BEGIN
			EXEC usp_CheckUpperGITherapeuticsForRecordDeletion @SiteId
		END
END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#3836
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rezaul Karim
-- TFS#	3838
-- Description of change: OGD post surgical diagnoses
-------------------------------------------------------------------------------------------------------------------------
GO
dbo.DropIfExist
    @ObjectName = 'abnormalities_postsurgery_summary_update',
    @ObjectTypePrefix = 'S' -- varchar(5)
GO


CREATE PROCEDURE [dbo].[abnormalities_postsurgery_summary_update]
(
	@SiteId INT
)
AS
	SET NOCOUNT ON

	DECLARE
		@summary VARCHAR(4000),
		@none BIT,
		@previousSurgery BIT,
		@surgicalProcedure SMALLINT,
		@surgicalProcedureFindings VARCHAR(1000),
		@duodenumPresent BIT,
		@jejunum BIT,
		@jejunumState TINYINT,
		@jejunumAbnormalText VARCHAR(500)

	SELECT 
		@none=[None],
		@surgicalProcedure=SurgicalProcedure,
		@surgicalProcedureFindings=(SELECT isnull(SurgicalProcedureFindings, '') as [text()] FOR XML PATH('')),
		@duodenumPresent=DuodenumPresent,
		@jejunumState=JejunumState,
		@jejunumAbnormalText=(SELECT isnull(JejunumAbnormalText, '') as [text()] FOR XML PATH(''))
	FROM
		ERS_UpperGIAbnoPostSurgery
	WHERE
		SiteId = @SiteId

	SET @Summary = ''

	IF @none = 1
		SET @summary = @summary + 'No evidence of previous surgery'
	
	ELSE 
	BEGIN
		IF @surgicalProcedure > 0
		BEGIN
			--SET @summary = @summary + 'surgical procedure - '

			SELECT @summary = @summary + [ListItemText]
			FROM ERS_Lists 
			WHERE [ListDescription] = 'Surgical procedures' 
			AND [ListItemNo] = @surgicalProcedure
		END

		IF ISNULL(@surgicalProcedureFindings, '') <> '' SET @summary = @summary + ' ' + @surgicalProcedureFindings

		IF @summary <> '' SET @summary = @summary + ', '

		IF @duodenumPresent = 1  SET @summary = @summary + 'duodenum removed'

		IF @jejunumState > 0
		BEGIN
			IF @summary <> '' SET @summary = @summary + ', '
			ELSE SET @summary = @summary + 'jejunum '

			IF @jejunumState = 1 SET @summary = @summary + 'normal jejunum'
			ELSE IF @jejunumState = 2 
			BEGIN
				SET @summary = @summary + 'abnormal jejunum'
				IF @jejunumAbnormalText <> '' SET @summary = @summary + ' - ' + @jejunumAbnormalText
			END
			
		END
	END

	SET @Summary = LTRIM(RTRIM(@Summary))
	IF RIGHT(@Summary,1) = ',' SET @Summary = LEFT(@Summary, LEN(@Summary) - 1)
	--PRINT @summary

	-- Finally update the summary in abnormalities table
	UPDATE ERS_UpperGIAbnoPostSurgery
	SET Summary = @Summary 
	WHERE SiteId = @siteId
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#3838 	OGD post surgical diagnoses
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	MOSTAFIZUR RAHMAN
-- TFS#	4090
-- Description of change
-- Fixed Anti-Coag option not selected
------------------------------------------------------------------------------------------------------------------------
GO
EXEC dbo.DropIfExist 
    @ObjectName = 'GetAntiCoagDrugs', 
    @ObjectTypePrefix = 'F' 
GO

        CREATE FUNCTION [dbo].[GetAntiCoagDrugs]
        (
            @ProcedureId INT
        )
        RETURNS INT
        AS
        BEGIN
            DECLARE @antiCoagDrugsValue INT

            SELECT @antiCoagDrugsValue = COALESCE(AntiCoagDrugs,-1)
            FROM ERS_Procedures
            WHERE ProcedureId = @ProcedureId

            RETURN @antiCoagDrugsValue
        END
GO

GO
EXEC dbo.DropIfExist 
    @ObjectName = 'patient_anti_coag_drugs_save', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[patient_anti_coag_drugs_save]
(
	@ProcedureId int,
	@AntiCoagDrugs bit
)
AS
BEGIN
	BEGIN
	    UPDATE ERS_Procedures SET AntiCoagDrugs = @AntiCoagDrugs WHERE ProcedureId = @ProcedureId
	    	DECLARE  @SectionId int = (SELECT UISectionId FROM UI_Sections WHERE SectionName = 'Anti-coag drugs')
	    
	    	DELETE FROM ERS_ProcedureSummary WHERE ProcedureId = @ProcedureId AND SectionId = @SectionId
	    	IF @AntiCoagDrugs = 1 AND 
	    			(SELECT count(*) FROM ERS_ProcedureDamagingDrugs WHERE ProcedureId = @ProcedureId AND DamagingDrugId IN (SELECT UniqueId FROM ERS_PotentialDamagingDrugs WHERE AntiCoag = 1)) > 0 
	    	BEGIN
	    		exec UI_update_procedure_summary @ProcedureId, 'Anti-coag drugs', 'Anti-coag drugs', 1
				--check RX status incase this was an update
				IF (SELECT count(*) FROM ERS_UpperGIRx WHERE ProcedureId = @ProcedureId AND Summary <> '') = 0
				BEGIN
					exec UI_update_procedure_summary @ProcedureId, 'RX', 'RX', 0
				END
	    	END
	    	ELSE IF @AntiCoagDrugs = 1 AND 
	    			(SELECT count(*) FROM ERS_ProcedureDamagingDrugs WHERE ProcedureId = @ProcedureId AND DamagingDrugId IN (SELECT UniqueId FROM ERS_PotentialDamagingDrugs WHERE AntiCoag = 1)) = 0 
	    	BEGIN
	    		exec UI_update_procedure_summary @ProcedureId, 'Anti-coag drugs', 'Anti-coag drugs', 0
				--check RX status incase this was an update
				IF (SELECT count(*) FROM ERS_UpperGIRx WHERE ProcedureId = @ProcedureId AND Summary <> '') = 0
				BEGIN
					exec UI_update_procedure_summary @ProcedureId, 'RX', 'RX', 0
				END
	    	END
	    	ELSE IF @AntiCoagDrugs = 0
	    	BEGIN
			
				Delete FROM ERS_ProcedureDamagingDrugs WHERE ProcedureId = @ProcedureId AND DamagingDrugId IN  
				(SELECT UniqueId FROM ERS_PotentialDamagingDrugs WHERE AntiCoag = 1) --edited by mostafiz 4090

	    		exec UI_update_procedure_summary @ProcedureId, 'Anti-coag drugs', 'Anti-coag drugs', 1
				exec UI_update_procedure_summary @ProcedureId, 'RX', 'RX', 1

				UPDATE ERS_ProceduresReporting 
				SET PP_Indic = dbo.ProcedureIndicationsSummary(@ProcedureId)
				WHERE ProcedureId = @ProcedureId --edited by mostafiz 4090
	    	END
	END
END
GO

------------------------------------------------------------------------------------------------------------------------
-- TFS#	4090 Ended
------------------------------------------------------------------------------------------------------------------------


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	MOSTAFIZUR RAHMAN
-- TFS#	4052
-- Description of change
-- Fixed OGD Normal
------------------------------------------------------------------------------------------------------------------------
GO
EXEC dbo.DropIfExist 
    @ObjectName = 'sites_delete', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[sites_delete]
(
	@SiteId INT
)
AS

SET NOCOUNT ON

DECLARE @ProcedureId INT, @AreaNo INT, @SiteNo INT, @ProcedureType INT

-- AS (08/SEP/2021) - Adding IsLymphNode column to distinguish between EBUS and EBUS BRT subtype of EBUS.
DECLARE @IsLymphNode BIT

BEGIN TRANSACTION

BEGIN TRY
	SELECT @ProcedureId = s.ProcedureId, @AreaNo = s.AreaNo, @SiteNo = s.SiteNo, @ProcedureType = p.ProcedureType, @IsLymphNode = CASE WHEN s.IsLymphNode = 1 THEN 'True' ELSE 'False' END
	FROM ERS_Procedures p
	INNER JOIN ERS_Sites s ON p.ProcedureId = s.ProcedureId
	WHERE s.SiteId = @SiteId

	IF @ProcedureType IN (1, 6, 8) --Gastroscopy, EUS_OGD, ENT Ant
	BEGIN
		DELETE FROM ERS_UpperGIAbnoDeformity WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoAchalasia WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoGastricUlcer WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoGastritis WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoLumen WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoMalignancy WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoPolyps WHERE SiteId = @SiteId
		DELETE FROM ERS_CommonAbnoLesions WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoPostSurgery WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoVarices WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoHiatusHernia WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoOesophagitis WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoBarrett WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoMiscellaneous WHERE SiteId = @SiteId
		DELETE FROM ERS_EUSAbnoMediastinal WHERE SiteId = @SiteId
	END
	ELSE IF @ProcedureType IN (2, 7)   --ERCP, EUS_HPB
	BEGIN
		DELETE FROM ERS_ERCPAbnoDuct WHERE SiteId = @SiteId
		DELETE FROM ERS_ERCPAbnoParenchyma WHERE SiteId = @SiteId
		DELETE FROM ERS_ERCPAbnoAppearance WHERE SiteId = @SiteId
		DELETE FROM ERS_ERCPAbnoDiverticulum WHERE SiteId = @SiteId
		DELETE FROM ERS_ERCPAbnoTumour WHERE SiteId = @SiteId
		DELETE FROM ERS_ERCPAbnoIntrahepatic WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoVarices WHERE SiteId = @SiteId
		IF EXISTS (SELECT TOP 1 Id FROM ERS_ERCPTherapeutics WHERE SiteId = @SiteId)
		BEGIN
			DECLARE @TherapeuticId INT
			SET @TherapeuticId = (SELECT TOP 1 Id FROM ERS_ERCPTherapeutics WHERE SiteId = @SiteId)
			DELETE FROM ERS_ERCPTherapeuticStentInsertions WHERE TherapeuticId = @TherapeuticId
			DELETE FROM ERS_ERCPTherapeutics WHERE SiteId = @SiteId
		END
		DELETE FROM ERS_EUSAbnoMediastinal WHERE SiteId = @SiteId
	END
	ELSE IF @ProcedureType IN (3,4,5,9)   --Colonoscopy, Sigmoidscopy, Proctoscopy, ENT Retro
	BEGIN
		DELETE FROM ERS_ColonAbnoMucosa WHERE SiteId = @SiteId
		DELETE FROM ERS_ColonAbnoVascularity WHERE SiteId = @SiteId
		DELETE FROM ERS_CommonAbnoLesions WHERE SiteId = @SiteId
		DELETE FROM ERS_ColonAbnoDiverticulum WHERE SiteId = @SiteId
		DELETE FROM ERS_ColonAbnoHaemorrhage WHERE SiteId = @SiteId
		DELETE FROM ERS_ColonAbnoPerianalLesions WHERE SiteId = @SiteId
		DELETE FROM ERS_ColonAbnoCalibre WHERE SiteId = @SiteId
		DELETE FROM ERS_ColonAbnoMiscellaneous WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoVarices WHERE SiteId = @SiteId
		if exists(select 1 FROM ERS_ColonAbnoTumour WHERE SiteId = @SiteId)
			DELETE FROM ERS_ColonAbnoTumour WHERE SiteId = @SiteId
	END
	ELSE IF @ProcedureType IN (10)
	BEGIN
		DELETE FROM dbo.ERS_BRTAbnoDescriptions WHERE SiteId = @SiteId
	END

	ELSE IF @ProcedureType IN (11)
	BEGIN
		IF @IsLymphNode = 'True'
			DELETE FROM dbo.ERS_EBUSAbnoDescriptions WHERE SiteId = @SiteId
		ELSE
			DELETE FROM dbo.ERS_BRTAbnoDescriptions WHERE SiteId = @SiteId
	END

	DELETE FROM ERS_CommonAbnoDiverticulum WHERE SiteId = @SiteId
	DELETE FROM dbo.ERS_ProcedureDICAScores WHERE SiteId = @SiteId
	DELETE FROM ERS_CommonAbnoTumour WHERE SiteId = @SiteId		
	DELETE FROM ERS_CommonAbnoDuodenitis WHERE SiteId = @SiteId	
	DELETE FROM ERS_CommonAbnoDuodenalUlcer WHERE SiteId = @SiteId
	DELETE FROM ERS_CommonAbnoScaring WHERE SiteId = @SiteId	
	DELETE FROM ERS_CommonAbnoVascularLesions WHERE SiteId = @SiteId	
	DELETE FROM ERS_CommonAbnoAtrophic WHERE SiteId = @SiteId

	DELETE FROM ERS_CommonAbnoOther WHERE SiteId = @SiteId

	DELETE FROM ERS_UpperGISpecimens WHERE SiteId = @SiteId
	DELETE FROM ERS_BRTSpecimens WHERE SiteId = @SiteId
	DELETE FROM ERS_UpperGITherapeutics WHERE SiteId = @SiteId		

	DELETE FROM ERS_Photos WHERE SiteId = @SiteId

	DELETE FROM ERS_RecordCount WHERE SiteId = @SiteId	

	IF @AreaNo > 0 AND @SiteNo > 0 --Main Site of an Area
		DELETE FROM ERS_Sites WHERE ProcedureId = @ProcedureId AND AreaNo = @AreaNo 
	ELSE
		DELETE FROM ERS_Sites WHERE SiteId = @SiteId

	IF EXISTS (SELECT 1 FROM ERS_Diagnoses WHERE ProcedureId = @ProcedureId AND ( SiteId = @SiteId OR SiteId IS NULL )) --EDITED BY MOSTAFIZ 4052
	BEGIN
		DELETE FROM ERS_Diagnoses WHERE ProcedureId = @ProcedureId  AND (SiteId = @SiteId OR SiteId IS NULL) --EDITED BY MOSTAFIZ 4052
		EXEC ogd_diagnoses_summary_update @ProcedureId
	END

	EXEC sites_reorder @ProcedureId
	EXEC procedure_summary_update @ProcedureId
END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;

GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	4052 Ended
------------------------------------------------------------------------------------------------------------------------
GO
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea
-- TFS#	2975
-- Description of change
-- Additional fields returned in the select statement when building the diary slot

-- Updated by	:	Ferdowsi On 10 june 2024
-- TFS#	No TFS - Item 3248
-- Description of change  
--  V2 Scheduler Cancellation List Audit 
------------------------------------------------------------------------------------------------------------------------


if NOT EXISTS (SELECT 1 from sys.objects WHERE object_id = OBJECT_ID('ERS_ListCancelReasons'))
BEGIN
	CREATE TABLE [dbo].[ERS_ListCancelReasons](
		[CancelReasonId] [INT] IDENTITY(1,1) NOT NULL,
		[Code] [VARCHAR](30) NOT NULL,
		[CancelCodeId] [INT] NOT NULL,
		[Detail] [VARCHAR](200) NOT NULL,
		[SortOrder] [INT] NULL,
		[WhoUpdatedId] [INT] NULL,
		[WhoCreatedId] [INT] NULL,
		[WhenCreated] [DATETIME] NULL,
		[WhenUpdated] [DATETIME] NULL,
		[Active] [BIT] NOT NULL,
		[CancelledByHospital] [BIT] NULL,
		[Suppressed] [BIT] NULL,
		[ValidFrom] [DATETIME2](7) GENERATED ALWAYS AS ROW START HIDDEN NOT NULL,
		[ValidTo] [DATETIME2](7) GENERATED ALWAYS AS ROW END HIDDEN NOT NULL,
	 CONSTRAINT [PK_ERS_ListCancelReasons] PRIMARY KEY CLUSTERED 
	(
		[CancelReasonId] ASC
	)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY],
		PERIOD FOR SYSTEM_TIME ([ValidFrom], [ValidTo])
	) ON [PRIMARY]
	WITH
	(
	SYSTEM_VERSIONING = ON (HISTORY_TABLE = [dbo].[ERS_ListCancelReasonsHistory])
	)

	ALTER TABLE [dbo].[ERS_ListCancelReasons] ADD  DEFAULT ((0)) FOR [WhoCreatedId]

	ALTER TABLE [dbo].[ERS_ListCancelReasons] ADD  DEFAULT (GETDATE()) FOR [WhenCreated]

	ALTER TABLE [dbo].[ERS_ListCancelReasons] ADD  DEFAULT ((1)) FOR [Active]

	ALTER TABLE [dbo].[ERS_ListCancelReasons] ADD  DEFAULT ((0)) FOR [CancelledByHospital]

	ALTER TABLE [dbo].[ERS_ListCancelReasons] ADD  CONSTRAINT [DF_ERS_ListCancelReasons_ValidFrom]  DEFAULT (SYSUTCDATETIME()) FOR [ValidFrom]

	ALTER TABLE [dbo].[ERS_ListCancelReasons] ADD  CONSTRAINT [DF_ERS_ListCancelReasons_ValidTo]  DEFAULT (CONVERT([DATETIME2],'9999-12-31 23:59:59.9999999')) FOR [ValidTo]

	ALTER TABLE [dbo].[ERS_ListCancelReasons]  WITH CHECK ADD  CONSTRAINT [FK_ERS_ListCancelReasons_ERS_CancelCodes] FOREIGN KEY([CancelCodeId])
	REFERENCES [dbo].[ERS_CancelCodes] ([CancelId])

	ALTER TABLE [dbo].[ERS_ListCancelReasons] CHECK CONSTRAINT [FK_ERS_ListCancelReasons_ERS_CancelCodes]

END
GO

IF EXISTS (SELECT 1 FROM sys.columns WHERE name = 'CancelReasonId' AND object_id = OBJECT_ID('ERS_ListCancelReasons'))
BEGIN
    exec sp_rename 'ERS_ListCancelReasons.CancelReasonId', 'ListCancelReasonId'
END
GO

  IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.COLUMNS
    WHERE TABLE_NAME = 'ERS_SCH_DiaryPages'
    AND COLUMN_NAME IN ('SuppressedBy', 'CancelComment','CancelReasonId')
)
BEGIN
    ALTER TABLE dbo.ERS_SCH_DiaryPages
    ADD SuppressedBy BIT, CancelComment varchar(100),CancelReasonId INT;
END;
GO
IF   EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.COLUMNS
    WHERE TABLE_NAME = 'ERS_SCH_DiaryPages'
    AND COLUMN_NAME = 'SuppressedBy' 
)
BEGIN
 ALTER TABLE [ERS_SCH_DiaryPages]  ALTER COLUMN SuppressedBy INT  
 END
Go

IF NOT EXISTS(SELECT 1 FROM ERS_Pages WHERE PageName = 'CancelledScheduleList' )
	BEGIN
	 INSERT INTO ERS_Pages ( PageId,PageName,PageAlias,AppPageName,GroupId ,PageURL,WhoUpdatedId,WhoCreatedId ,WhenCreated ,WhenUpdated) VALUES
	 ((SELECT TOP 1 PageId FROM ERS_Pages ORDER BY PageId DESC)+1,'CancelledScheduleList', 'Cancelled ScheduleList','products_scheduler_cancelledschedulelist_aspx',5,NULL,NULL,0,GETDATE(),NULL);
END
GO
-- Insert new page value

IF NOT EXISTS(SELECT 1 FROM ERS_Pages WHERE PageName = 'CancelledScheduleList' )
	BEGIN
	 INSERT INTO ERS_Pages ( PageId,PageName,PageAlias,AppPageName,GroupId ,PageURL,WhoUpdatedId,WhoCreatedId ,WhenCreated ,WhenUpdated) VALUES
	 ((SELECT TOP 1 PageId FROM ERS_Pages ORDER BY PageId DESC)+1,'CancelledScheduleList', 'Cancelled ScheduleList','products_scheduler_cancelledschedulelist_aspx',5,NULL,NULL,0,GETDATE(),NULL);
END	

GO
EXEC dbo.DropIfExist @ObjectName = 'sch_ScheduleList_Cancellation_Reasons_insert_update',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[sch_ScheduleList_Cancellation_Reasons_insert_update](
	@CancelReasonId int,
	@Code VARCHAR(30),
	@Detail varChar(50),
	@CancelledByHospital bit,
	@UserId Int
)

AS 
	IF Exists (SELECT ListCancelReasonId FROM ERS_ListCancelReasons WHERE ListCancelReasonId = @CancelReasonId)
	BEGIN
			
		UPDATE ERS_ListCancelReasons
		SET Code = @Code,
			Detail = @Detail,
			CancelledByHospital = @CancelledByHospital,
			WhoUpdatedId = @UserId,
			WhenUpdated = GetDate()
		WHERE ListCancelReasonId = @CancelReasonId 
	END
	ELSE
	BEGIN
		INSERT ERS_ListCancelReasons(
			Code,
			CancelCodeId,
			Detail,
			CancelledByHospital,
		    Suppressed,
			WhoCreatedId,
			WhenCreated,
			WhoUpdatedId,
			WhenUpdated)
		VALUES (@Code,
				1,
				@Detail,
				@CancelledByHospital,
				0,
				@UserId,
				GetDate(),
				@UserId,
				GetDate())
	END

GO
EXEC dbo.DropIfExist @ObjectName = 'get_ScheduleList_Cancel_Data',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)

GO
CREATE PROCEDURE [dbo].[get_ScheduleList_Cancel_Data]
AS
	SELECT ListCancelReasonId, Code, Detail, ISNULL(CancelledByHospital, 0) AS CancelledByHospital,  Suppressed 
	FROM ERS_ListCancelReasons where  Active = 1 
	Order By ListCancelReasonId DESC	 

GO
EXEC dbo.DropIfExist @ObjectName = 'sch_get_day_diary',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)

GO
CREATE PROCEDURE [dbo].[sch_get_day_diary]
(
	@OperatingHospitalID INT,
	@DiaryDate DATETIME,
	@RoomIds VARCHAR(MAX)
)
AS

	IF OBJECT_ID ('tempdb..#tmpDiaryRooms') IS NOT NULL
		DROP TABLE #tmpDiaryRooms

	SELECT Item
	INTO #tmpDiaryRooms
	FROM dbo.fnSplitString(@RoomIds, ',')

	SELECT DISTINCT
		d.DiaryId,
		d.DiaryStart,
		CASE WHEN (SELECT MAX(DATEADD(MINUTE, CONVERT(int, ersa.AppointmentDuration), StartDateTime)) FROM ERS_Appointments ersa LEFT JOIN ERS_AppointmentStatus aps on aps.UniqueId = ersa.AppointmentStatusId WHERE ISNULL(aps.HDCKEY,'') NOT IN ('C','H','E') AND ersa.DiaryId = d.DiaryId) > d.DiaryEnd THEN (SELECT MAX(DATEADD(MINUTE, CONVERT(int, ersa.AppointmentDuration), StartDateTime)) FROM ERS_Appointments ersa  LEFT JOIN ERS_AppointmentStatus aps on aps.UniqueId = ersa.AppointmentStatusId WHERE ISNULL(aps.HDCKEY,'') NOT IN ('C','H','E') AND  ersa.DiaryId = d.DiaryId) ELSE d.DiaryEnd END AS DiaryEnd,
		d.[DiaryEnd] ActualDiaryEnd,
		d.[UserID], 
		d.[RoomID], 
		d.ListRulesId, 
		s.SlotMinutes AS [Minutes],
		CASE WHEN ept.ProcedureType IS NULL THEN ss.Description 
		ELSE 'Reserved for ' + ss.Description + ' '+ ept.ProcedureType END AS [Subject],
		ss.Description,
		ISNULL(s.ProcedureTypeID,0) AS ProcedureTypeID,
		s.ListSlotId,
		ss.ForeColor,
		ss.StatusId,
		ISNULL(s.Points, 1) AS Points,
		ISNULL(l.Endoscopist,0) AS EndoscopistId,
		(CASE WHEN  ISNULL(u.Title,'') <> '' THEN u.Title + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(u.Forename,'') <> '' THEN u.Forename + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(u.Surname,'') <> '' THEN u.Surname + ' ' ELSE '' END) as EndoscopistName,
	  (CASE WHEN  ISNULL(c.Title,'') <> '' THEN c.Title + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(c.Forename,'') <> '' THEN c.Forename + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(c.Surname,'') <> '' THEN c.Surname + ' ' ELSE '' END) as ListConsultant,
		l.ListName,
		(CASE WHEN  ISNULL(u.Title,'') <> '' THEN u.Title + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(u.Forename,'') <> '' THEN u.Forename + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(u.Surname,'') <> '' THEN u.Surname + ' ' ELSE '' END) +
	  '  [' + CONVERT(VARCHAR(5),cast(d.DiaryStart as time)) + '-' + CONVERT(VARCHAR(5),cast(d.[DiaryEnd] as time)) + ']' +
	  CASE WHEN  ISNULL(l.Points,0) <> 0 THEN '  [' + CONVERT(VARCHAR, l.Points) + ' slots]' ELSE '' END  AS ListDescription
		,d.suppressed
		,d.SuppressedFromDate
		,d.Training
		,l.GIProcedure
		,ISNULL(apt.AppointmentId, 0) AppointmentId
		,apt.StartDateTime AppointmentStart
		,ISNULL(apt.TotalPoints,0) AppointmentPoints
		,ISNULL(apt.AppointmentDuration,0) AppointmentDuration
		,DATEADD(minute, convert(int, apt.AppointmentDuration), apt.StartDateTime) AppointmentEnd
		,ISNULL(apt.StatusCode,'') AppointmentStatusCode
		,ISNULL(apt.Notes,'') AppointmentNotes
		,p.HospitalNumber + ' - ' + p.Forename1 + ' ' + p.Surname + '<br />' + apt.Description AS [AppointmentSubject]
		,STUFF(REPLACE(apt.Procs, CHAR(10), '+'), LEN(apt.procs),1,'') AS [AppointmentProcedures]
		,ISNULL(apt.GeneralInformation, '') GeneralInformation
		,CASE WHEN apt.AppointmentId IS NULL THEN s.Locked ELSE CASE WHEN ISNULL(apt.StatusCode,'') = 'BS' THEN 1 ELSE 0 END END AS Locked
		,d.OperatingHospitalId
		,ISNULL(d.RecurrenceParentID,0)RecurrenceParentID
		,ISNULL(d.locked,0) LockedDiary
		,r.RoomName
		,apt.StaffBooked,
		apt.DateBooked
	FROM ERS_SCH_DiaryPages d
		INNER JOIN #tmpDiaryRooms tr ON tr.Item = d.RoomID
		INNER JOIN dbo.ERS_SCH_Rooms r ON r.RoomId = tr.Item
		INNER JOIN ERS_SCH_ListRules l ON l.ListRulesId = d.ListRulesId
		INNER JOIN ERS_SCH_ListSlots s ON d.ListRulesId = s.ListRulesId AND s.Active = 1
		INNER JOIN dbo.ERS_SCH_SlotStatus ss ON ss.StatusId = s.SlotId
		LEFT JOIN dbo.ERS_ProcedureTypes ept ON s.ProceduretypeId = ept.ProcedureTypeId
		LEFT JOIN ERS_Users u ON u.UserID = d.UserId
		LEFT JOIN ERS_Users c ON c.UserID = d.ListConsultantId
		LEFT JOIN (SELECT ea.AppointmentId, SUM(eapt.Points) AS TotalPoints, SUM(eapt.Minutes) AS TotalMinutes, ea.ListSlotId, ea.DiaryId, 
					MAX(aps.HDCKEY) StatusCode, ass.Description, ea.PatientId, ea.GeneralInformation, ea.Notes, ea.AppointmentDuration,ea.StartDateTime,
					ISNULL(usr.Forename + ' ' + usr.Surname, '') AS StaffBooked, DateEntered as DateBooked,
						(SELECT
							AppointmentProcedures + char(10) AS [text()] 
						FROM dbo.SCH_AppointmentProcedures(ea.AppointmentId)
						WHERE AppointmentId = ea.AppointmentId
						FOR XML PATH('')) AS procs
					FROM dbo.ERS_Appointments ea
						INNER JOIN dbo.ERS_AppointmentProcedureTypes eapt ON ea.AppointmentId = eapt.AppointmentID
						INNER JOIN dbo.ERS_SCH_SlotStatus ass ON ea.SlotStatusID = ass.StatusId
						LEFT JOIN ERS_AppointmentStatus aps on aps.UniqueId = ea.AppointmentStatusId
						LEFT JOIN dbo.ERS_Users usr ON usr.UserID = ea.StaffBookedId
					 WHERE ISNULL(aps.HDCKEY,'') NOT IN ('C')
					GROUP BY ea.AppointmentId, ea.ListSlotId, ea.DiaryId, ass.Description, ea.PatientId,ea.GeneralInformation, ea.Notes, ea.AppointmentDuration,ea.StartDateTime, usr.Forename,usr.Surname, DateEntered) AS apt 
											ON apt.DiaryId = d.DiaryId and  apt.ListSlotId = s.ListSlotId
		LEFT JOIN ERS_Patients p ON p.patientId = apt.PatientId
	WHERE d.OperatingHospitalId = @OperatingHospitalID AND convert(varchar(10), DiaryStart, 103) = convert(varchar(10), @DiaryDate, 103)
	AND d.Suppressed = 0
	ORDER BY d.DiaryId, apt.StartDateTime, s.ListSlotId

GO

GO
EXEC dbo.DropIfExist @ObjectName = 'sch_diary_overview_select',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)

GO
CREATE PROCEDURE [dbo].[sch_diary_overview_select]
(
	@Month int,
	@Year int,
	@OperatingHospitalId int
)
AS
SET NOCOUNT ON

BEGIN TRANSACTION

BEGIN TRY
  SELECT d.DiaryId, d.Subject, d.DiaryStart, d.DiaryEnd, d.RoomID,d.Suppressed, r.RoomName as Room, d.UserID, e.Title + ' ' + e.Forename + ' ' + e.Surname as Endoscopist, c.Title + ' ' + c.Title + ' ' + c.Forename + ' ' + c.Surname as ListConsultant, 
		l.ListName, l.TotalMins, l.Points PointsAvailable, l.ListRulesId, ISNULL(l.ListName, '') [Description], l.GIProcedure,d.Training, d.OperatingHospitalId,
		NULL RecurrenceRule,
		NULL AS RecurrenceParentID,
		ListGenderId,
		Notes,
		d.IsGI,
		d.Locked,
		ISNULL((SELECT sum(apt.Points) FROM ERS_Appointments a INNER JOIN ERS_AppointmentProcedureTypes apt on apt.AppointmentID = a.AppointmentId LEFT JOIN dbo.ERS_AppointmentStatus aps ON aps.UniqueId = a.AppointmentStatusId WHERE DiaryId = d.DiaryId AND ISNULL(aps.HDCKEY,'') <> 'C'),0) AppointmentPoints,
		ISNULL((SELECT SUM(ls.Points) FROM dbo.ERS_SCH_ListSlots ls WHERE ls.Locked = 1 AND ls.ListRulesId = d.ListRulesId),0) BlockedPoints
  FROM ERS_SCH_DiaryPages d
		INNER JOIN ERS_SCH_Rooms r ON r.RoomId = d.RoomID
	  INNER JOIN ERS_SCH_ListRules l ON l.ListRulesId = d.ListRulesId
	  LEFT JOIN ERS_Users e ON e.UserID = d.UserId
	  LEFT JOIN ERS_Users c ON c.UserID = d.ListConsultantId
  WHERE d.OperatingHospitalId = @OperatingHospitalId AND ( DATEPART(month, d.DiaryStart) = @Month and datepart(year, d.DiaryStart) = @Year) 
  ORDER BY d.DiaryStart
END TRY

BEGIN CATCH
       DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

       IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH

IF @@TRANCOUNT > 0 COMMIT TRANSACTION;

 
GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	2975,3248
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	: Andrea 04.06.24	
-- TFS#	4138
-- Description of change
-- correct saving of empty insertion technique
------------------------------------------------------------------------------------------------------------------------
GO

SET QUOTED_IDENTIFIER ON
SET ANSI_NULLS ON
GO
ALTER PROCEDURE [dbo].[procedure_insertion_technique_save]
(
	@ProcedureId int,
	@InsertionTechniqueId int,
	@LoggedInUserId int
)
AS
BEGIN
	IF @InsertionTechniqueId > 0 
	BEGIN
	    IF NOT EXISTS (SELECT 1 FROM ERS_ProcedureInsertionTechnique WHERE ProcedureId = @ProcedureId)
	    BEGIN
	    	INSERT INTO ERS_ProcedureInsertionTechnique (ProcedureId, InsertionTechniqueId, WhoCreatedId, WhenCreated)
	    	VALUES (@ProcedureId, @InsertionTechniqueId, @LoggedInUserId, getdate())
	    END
	    ELSE
	    BEGIN
	    	UPDATE ERS_ProcedureInsertionTechnique
	    	SET InsertionTechniqueId = @InsertionTechniqueId
	    	WHERE ProcedureId = @ProcedureId
	    END
	    
	    DECLARE @Summary VARCHAR(max) = 'Insertion technique:'
	    EXEC UI_update_procedure_summary @ProcedureId, 'Insertion techniques', @Summary, @InsertionTechniqueId
	END
	ELSE
	BEGIN
	    DELETE FROM ERS_ProcedureInsertionTechnique WHERE ProcedureId = @ProcedureId
	    EXEC UI_update_procedure_summary @ProcedureId, 'Insertion techniques', @Summary, 0
	END
END
GO



------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 04.06.24
-- TFS#	3914
-- Description of change
-- Extent limitation of food added
------------------------------------------------------------------------------------------------------------------------
GO

IF NOT EXISTS (SELECT 1 FROM dbo.ERS_Limitations WHERE Description = 'Food')
BEGIN
    INSERT INTO ERS_Limitations (Description, NEDTerm, AdditionalInfo, ListOrderBy, Suppressed)
	VALUES ('Food', 'Other', 0, NULL, 0)

	INSERT INTO ERS_LimitationProcedureTypes (LimitationId, ProcedureTypeId)
	VALUES (SCOPE_IDENTITY(), 1)
END
GO


ALTER PROCEDURE [dbo].[limitations_select]
(
	@ProcedureTypeId int
)
AS
BEGIN
	SELECT UniqueId, Description, AdditionalInfo
	FROM ERS_Limitations l
		INNER JOIN ERS_LimitationProcedureTypes pt on l.UniqueId = pt.LimitationId
	WHERE ProcedureTypeId = @ProcedureTypeId AND Suppressed = 0
	ORDER BY ISNULL(ListOrderBy, 999), l.Description
END
GO


------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	MOSTAFIZUR RAHMAN
-- TFS#	4084
-- Description of change
-- GOJ in clinical reprot 
------------------------------------------------------------------------------------------------------------------------
EXEC dbo.DropIfExist 
    @ObjectName = 'procedure_upper_extent_save', 
    @ObjectTypePrefix = 'S' 
GO

CREATE  PROCEDURE [dbo].[procedure_upper_extent_save]
(
	@ProcedureId int,
	@ExtentId int,
	@AdditionalInfo varchar(max),
	@EndoscopistId int,
	@JManoeuvreId int, 
	@LimitedById int, 
	@WithdrawalMins int,
	@MucosalJunctionDistance int,
	@LimitationOther varchar(max),
	@LoggedInUserId int
)
AS
/*
--	Update History
01.			04 Jan 2023		MH added Order Message Send block while saving Extent of Intubation TFS #2475
							No extra parameter required. ProcedureId will have associated OrderId and Extent Limited By value
02.			21 March 2023	AJ j manouver handled if -1 (not specified)
03.			27 March 2023	AJ Set sections as not entered based on the extent reached
04.			08 June 2023	SG Add call to ogd_diagnoses_summary_update to ensure report gets populated with Normal if no abnormalities are added
05.         08 Nov 2023     MS Add MucosalJunctionDistance column and related logic
							
*/
BEGIN
	Declare @bitHasProcedureFailed as bit
	Set @bitHasProcedureFailed = 0

	IF NOT EXISTS (SELECT 1 FROM ERS_ProcedureUpperExtent WHERE ProcedureId = @ProcedureId AND EndoscopistId = @EndoscopistId)
	BEGIN
		INSERT INTO ERS_ProcedureUpperExtent (ProcedureId, ExtentId, AdditionalInfo, EndoscopistId, JManoeuvreId, LimitationId, MucosalJunctionDistance, WhoUpdatedId, WhenUpdated, LimitationOther)
		VALUES (@ProcedureId, NULLIF(@ExtentId,0), NULLIF(@AdditionalInfo,''), @EndoscopistId, NULLIF(@JManoeuvreId,-1), NULLIF(@LimitedById,0), NULLIF(@MucosalJunctionDistance,0), @LoggedInUserId, getdate(), NULLIF(@LimitationOther,''))
	END
	ELSE
	BEGIN

		/*Check if new values been added for limitations */
		IF ISNULL(@LimitationOther,'') <> ''
		BEGIN
			IF NOT EXISTS (SELECT 1 FROM dbo.ERS_Limitations WHERE Description = @LimitationOther)
			BEGIN
				/*get and set the new items order id so it appears 1 above 'other' we always want other to be last*/

				DECLARE @OtherListOrderBy_l int = (SELECT ListOrderBy FROM ERS_Limitations WHERE Description = 'Other')
				INSERT INTO ERS_Limitations (Description, NEDTerm, ListOrderBy) VALUES (@LimitationOther, 'Other', @OtherListOrderBy_l)
			
				UPDATE dbo.ERS_Limitations SET ListOrderBy = @OtherListOrderBy_l + 1 WHERE Description = 'Other'
		

			SELECT @LimitedById = UniqueId FROM ERS_Limitations WHERE Description = @LimitationOther
		
			DECLARE @ProcTypeId int = (SELECT ProcedureType FROM ERS_Procedures WHERE ProcedureId = @ProcedureId)
			INSERT INTO ERS_LimitationProcedureTypes (ProcedureTypeId, LimitationId) VALUES (@ProcTypeId, @LimitedById)
			END
			ELSE
				SELECT @LimitedById = UniqueId FROM ERS_Limitations WHERE Description = @LimitationOther
		END 

		UPDATE ERS_ProcedureUpperExtent
		SET 
			ExtentId = NULLIF(@ExtentId,0),
			AdditionalInfo = NULLIF(@AdditionalInfo,''),
			EndoscopistId = @EndoscopistId,
			JManoeuvreId = NULLIF(@JManoeuvreId,-1),
			LimitationId = NULLIF(@LimitedById,0),
			MucosalJunctionDistance = NULLIF(@MucosalJunctionDistance,0),
			WithdrawalMins =NULLIF(@WithdrawalMins,0), --edited by mostafiz 2830
			WhoUpdatedId = @LoggedInUserId,
			WhenUpdated = getdate(),
			LimitationOther = NULLIF(@LimitationOther,'')
		WHERE 
			ProcedureId = @ProcedureId AND
			EndoscopistId = @EndoscopistId
	END

	DECLARE @SectionId int, @ProceureTypeId int, @ExtentIsSuccess bit, @ExtentDescription varchar(200), @SummaryText varchar(max) = ''
	SELECT @SectionID = UISectionId FROM UI_Sections WHERE SectionName = 'Extent'

	SELECT @ProceureTypeId = ProcedureType FROM ERS_Procedures WHERE ProcedureId = @ProcedureId
	
	/*Furthest extent*/
	SELECT TOP 1 @ExtentDescription = ee.Description, @AdditionalInfo = epue.AdditionalInfo, @ExtentIsSuccess = ee.IsSuccess
								FROM dbo.ERS_ProcedureUpperExtent epue 
									INNER JOIN dbo.ERS_Extent ee ON epue.ExtentId = ee.UniqueId
								WHERE epue.ProcedureId=@ProcedureId
								ORDER BY ee.ListOrderBy DESC
	
	/*Handle failed procedures*/
	
	IF @ExtentDescription IN ('intubation failed','abandoned')
	Begin
	
		EXEC diagnoses_set_procedure_failed @ProcedureId
		Set @bitHasProcedureFailed = 1
	END
    
	IF ISNULL(@MucosalJunctionDistance,0) > 0
	BEGIN

		SET @SummaryText = 'The apparent mucosal junction: ' + Convert(varchar(50), @MucosalJunctionDistance) + ' cm ' -- edited by mostafiz 4084
	END

	IF (SELECT COUNT(*) FROM ERS_ProcedureUpperExtent WHERE ProcedureId = @ProcedureId AND NULLIF(JManoeuvreId,-1) IS NOT NULL) > 0
	BEGIN
		DECLARE @JManouvreResult varchar(100)

		/*Overall JManouvre result regardless of who done it, was it done*/
		IF EXISTS (SELECT 1 FROM ERS_ProcedureUpperExtent WHERE ProcedureId = @ProcedureId AND ISNULL(JManoeuvreId,0) = 1)
			SET @JManouvreResult = 'performed. '
		ELSE
			SET @JManouvreResult = 'not carried out. '

		SET @SummaryText = @SummaryText + 'J manoeuvre ' + @JManouvreResult
	END
		
	SET @SummaryText = @SummaryText +   
						CASE LOWER(@ExtentDescription )
							WHEN 'intubation failed' THEN 'Failed intubation' + CASE WHEN ISNULL(@AdditionalInfo,'') <> '' THEN ': ' + @AdditionalInfo ELSE '' END
							WHEN 'abandoned' THEN 'Procedure failed (abandoned)' + CASE WHEN ISNULL(@AdditionalInfo,'') <> '' THEN ': ' + @AdditionalInfo ELSE '' END
							WHEN 'other' THEN  'Procedure failed' + CASE WHEN ISNULL(@AdditionalInfo,'') <> '' THEN ': ' + @AdditionalInfo ELSE '' END
							ELSE 'The procedure was completed successfully to the ' + @ExtentDescription
						END
	
	--limited by...?
	IF ISNULL(@LimitedById, 0) > 0
	BEGIN
		SET @SummaryText = @SummaryText + ' but limited by ' + (SELECT LOWER(Description) FROM ERS_Limitations WHERE UniqueId = @LimitedById)
	END

	IF ISNULL(@SummaryText,'') <> ''
	BEGIN
		UPDATE ERS_ProcedureUpperExtent
		SET Summary = @SummaryText
		WHERE ProcedureId = @ProcedureId

		EXEC procedure_summary_update @ProcedureId
	END
	
	DECLARE @Summary VARCHAR(max) = 'Extent:'


	--remove complete section entry incase conditions no longer apply. Will get re-evaluated after
	EXEC UI_update_procedure_summary @ProcedureId, 'Extent', @Summary, 0, @EndoscopistId

	--Check if the Extent has reached or exceeded the planned extent, if so mark as success
	IF @ExtentId > 0 
	BEGIN
		DECLARE @ExtentListOrder int = (SELECT ListOrderBy FROM ERS_Extent WHERE UniqueId = @ExtentId)
		DECLARE @PlannedExtentListOrder int = (SELECT e.ListOrderBy FROM ERS_ProcedurePlannedExtent ppe JOIN ERS_Extent e ON e.UniqueId = ppe.ExtentId WHERE ppe.ProcedureId = @ProcedureId)

		IF (@ExtentListOrder >= @PlannedExtentListOrder AND @ExtentListOrder > 0)
				SET @ExtentIsSuccess = 1
	END
	
	IF @ExtentId > 0 AND @ExtentIsSuccess = 1
		EXEC UI_update_procedure_summary @ProcedureId, 'Extent', 'Extent:', @ExtentId, @EndoscopistId
	ELSE IF @ExtentIsSuccess = 0 AND @LimitedById > 1
	BEGIN
		IF (SELECT LOWER(NEDTerm) FROM dbo.ERS_Limitations WHERE UniqueId = @LimitedById) = 'other'
		BEGIN
			IF ISNULL(@LimitationOther,'') <> ''
			BEGIN
				EXEC UI_update_procedure_summary @ProcedureId, 'Extent', 'Extent:' , @ExtentId, @EndoscopistId
			END
		END
		ELSE
		BEGIN
			EXEC UI_update_procedure_summary @ProcedureId, 'Extent', 'Extent:', @ExtentId, @EndoscopistId
		END
	END

	IF ISNULL(@WithdrawalMins,0) > 0
	BEGIN
		EXEC UI_update_procedure_summary @ProcedureId, 'Total withdrawal time', 'Total withdrawal time:', 1, @EndoscopistId
	END

	IF @JManoeuvreId > -1
	BEGIN
		EXEC UI_update_procedure_summary @ProcedureId, 'JManoevre', 'JManoevre:', 1, @EndoscopistId
	END
	ELSE
	BEGIN
		EXEC UI_update_procedure_summary @ProcedureId, 'JManoevre', 'JManoevre:', 0 , @EndoscopistId
	END
	
	--MH Added on 04 Jan 2023 
	Exec usp_SendIntubationExtentOrderMessageByProcedureId @ProcedureId, @bitHasProcedureFailed, @LoggedInUserId

	EXEC ogd_diagnoses_summary_update @ProcedureID

	--Handle unentered sections
	DECLARE @MatrixCode VARCHAR(100)

	--based on extent reached
	IF LOWER(@ExtentDescription)= 'oesophagus'
	BEGIN
		--check if a diagnoses is present or not (will say OverallNorml if nothing's been found)
		IF EXISTS (SELECT 1 FROM dbo.ERS_Diagnoses WHERE ProcedureID = @ProcedureId AND LOWER(MatrixCode) = 'overallnormal')
		BEGIN
		    --if its overallnormal delete it
			DELETE FROM dbo.ERS_Diagnoses WHERE ProcedureID = @ProcedureId AND LOWER(MatrixCode) = 'overallnormal'

			--add oesophagus normal
			INSERT INTO [ERS_Diagnoses] (ProcedureID, SiteID, MatrixCode, [Value], [Region]) 
			VALUES (@ProcedureID, 0, 'OesophagusNormal','true','Oesophagus') 
		END

		--Stomach region is not updated if a abnormality/diagnoses is present
		IF EXISTS (SELECT 1 FROM dbo.ERS_Diagnoses WHERE @ProcedureId = @ProcedureId AND Region = 'Stomach')
		BEGIN
			IF EXISTS (SELECT 1 FROM dbo.ERS_Diagnoses WHERE @ProcedureId = @ProcedureId AND Region = 'Stomach' AND MatrixCode = 'StomachNormal') 
			BEGIN
				DELETE FROM dbo.ERS_Diagnoses WHERE ProcedureID = @ProcedureId AND Region = 'Stomach' AND MatrixCode = 'StomachNormal'

				INSERT INTO [ERS_Diagnoses] (ProcedureID, SiteID, MatrixCode, [Value], [Region]) 
				VALUES (@ProcedureID, 0, 'StomachNotEntered','true','Stomach') 
			END
		END
		ELSE
		BEGIN
		    INSERT INTO [ERS_Diagnoses] (ProcedureID, SiteID, MatrixCode, [Value], [Region]) 
		    VALUES (@ProcedureID, 0, 'StomachNotEntered','true','Stomach') 
		END

		--Duodenum region is not updated if a abnormality/diagnoses is present
		IF EXISTS (SELECT 1 FROM dbo.ERS_Diagnoses WHERE @ProcedureId = @ProcedureId AND Region = 'Duodenum')
		BEGIN
		     IF EXISTS (SELECT 1 FROM dbo.ERS_Diagnoses WHERE @ProcedureId = @ProcedureId AND Region = 'Duodenum' AND MatrixCode = 'DuodenumNormal')
			 BEGIN
				DELETE FROM dbo.ERS_Diagnoses WHERE ProcedureID = @ProcedureId AND Region = 'Duodenum' AND MatrixCode = 'DuodenumNormal'

				INSERT INTO [ERS_Diagnoses] (ProcedureID, SiteID, MatrixCode, [Value], [Region]) 
				VALUES (@ProcedureID, 0, 'DuodenumNotEntered','true','Duodenum')
			 END
		END
		ELSE	
		BEGIN
		    INSERT INTO [ERS_Diagnoses] (ProcedureID, SiteID, MatrixCode, [Value], [Region]) 
		    VALUES (@ProcedureID, 0, 'DuodenumNotEntered','true','Duodenum')
		END

		

		EXEC dbo.ogd_diagnoses_summary_update @ProcedureId
	END
	IF LOWER(@ExtentDescription)= 'stomach'
	BEGIN
		--check if a diagnoses is present or not (will say OverallNorml if nothing's been found)
		IF EXISTS (SELECT 1 FROM dbo.ERS_Diagnoses WHERE ProcedureID = @ProcedureId AND LOWER(MatrixCode) = 'overallnormal')
		BEGIN
		    --if its overallnormal delete it
			DELETE FROM dbo.ERS_Diagnoses WHERE ProcedureID = @ProcedureId AND LOWER(MatrixCode) = 'overallnormal'

			--add oesophagus normal
			INSERT INTO [ERS_Diagnoses] (ProcedureID, SiteID, MatrixCode, [Value], [Region]) 
			VALUES (@ProcedureID, 0, 'OesophagusNormal','true','Oesophagus') 

			--add stomach normal
			INSERT INTO [ERS_Diagnoses] (ProcedureID, SiteID, MatrixCode, [Value], [Region]) 
			VALUES (@ProcedureID, 0, 'StomachNormal','true','Stomach') 
		END
		
		--Stomach region is not updated if a abnormality/diagnoses is present
		IF EXISTS (SELECT 1 FROM dbo.ERS_Diagnoses WHERE @ProcedureId = @ProcedureId AND Region = 'Oesophagus' AND MatrixCode = 'OesophagusNotEntered')
		BEGIN
			DELETE FROM dbo.ERS_Diagnoses WHERE ProcedureID = @ProcedureId AND Region = 'Oesophagus' AND MatrixCode = 'OesophagusNotEntered'
			
			--add Oesophagus normal
			INSERT INTO [ERS_Diagnoses] (ProcedureID, SiteID, MatrixCode, [Value], [Region]) 
			VALUES (@ProcedureID, 0, 'OesophagusNormal','true','Oesophagus') 
		END

		--Stomach region is not updated if a abnormality/diagnoses is present
		IF NOT EXISTS (SELECT 1 FROM dbo.ERS_Diagnoses WHERE @ProcedureId = @ProcedureId AND Region = 'Stomach')
		BEGIN
			--add stomach normal
			INSERT INTO [ERS_Diagnoses] (ProcedureID, SiteID, MatrixCode, [Value], [Region]) 
			VALUES (@ProcedureID, 0, 'StomachNormal','true','Stomach') 
		END

		--Duodenum region is not updated if a abnormality/diagnoses is present
		IF EXISTS (SELECT 1 FROM dbo.ERS_Diagnoses WHERE @ProcedureId = @ProcedureId AND Region = 'Duodenum')
		BEGIN
		     IF EXISTS (SELECT 1 FROM dbo.ERS_Diagnoses WHERE @ProcedureId = @ProcedureId AND Region = 'Duodenum' AND MatrixCode = 'DuodenumNormal')
			 BEGIN
				DELETE FROM dbo.ERS_Diagnoses WHERE ProcedureID = @ProcedureId AND Region = 'Duodenum' AND MatrixCode = 'DuodenumNormal'

				INSERT INTO [ERS_Diagnoses] (ProcedureID, SiteID, MatrixCode, [Value], [Region]) 
				VALUES (@ProcedureID, 0, 'DuodenumNotEntered','true','Duodenum')
			 END
		END
		ELSE	
		BEGIN
		    INSERT INTO [ERS_Diagnoses] (ProcedureID, SiteID, MatrixCode, [Value], [Region]) 
		    VALUES (@ProcedureID, 0, 'DuodenumNotEntered','true','Duodenum')
		END
		
		EXEC dbo.ogd_diagnoses_summary_update @ProcedureId
	END
END

GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	4084 Ended
------------------------------------------------------------------------------------------------------------------------


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ahmed Shoud
-- TFS#	No TFS - Item 2827 
-- Description of change
--  Show selected Patient category on Lab Request Form 
------------------------------------------------------------------------------------------------------------------------

GO
EXEC dbo.DropIfExist @ObjectName = 'printreport_patient_info_select',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)

GO
CREATE PROCEDURE [dbo].[printreport_patient_info_select]
(
	@ProcedureId INT,
	@EpisodeNo INT = 0,
    @PatientComboId VARCHAR(30) = NULL,
    @ProcedureType INT
)
AS

SET NOCOUNT ON

IF @ProcedureId IS NOT NULL AND @ProcedureId > 0
BEGIN

	DECLARE @PP_GPAddress VARCHAR(1000), @PP_GPName VARCHAR(1000)
	SELECT @PP_GPAddress =PP_GPAddress, @PP_GPName= PP_GPName FROM dbo.[ERS_ProceduresReporting] WHERE ProcedureId = @ProcedureId;

	SELECT 
			ISNULL(p.Title + ' ', '') + ISNULL(p.Forename1 + ' ', '') + ISNULL(p.Surname, '') AS PatientName, 
			ISNULL(p.Forename1, '') AS Forename,
			ISNULL(p.Surname, '') AS Surname,
			ISNULL(p.Gender, '') AS Gender,
			ISNULL(p.[DateOfBirth], '') AS DateOfBirth,
			ISNULL(p.[NHSNo],'') AS NHSNo, 
			ISNULL(p.[HospitalNumber], '') as CaseNoteNo, 
			ISNULL(REPLACE(p.[Address],',', CHAR(10)),'') AS [Address],
			ISNULL(REPLACE(p.GPName, CHAR(44),'<br />'),'')  AS GPName,
			CASE WHEN p.GPName IS NOT NULL then REPLACE(p.GPName, CHAR(44),'') + '<br />' ELSE '' END + 
				ISNULL(REPLACE(REPLACE(LTRIM(RTRIM(p.PracticeName)), CHAR(13), '<br/>'), CHAR(10), '<br/>'),'<br/>') + 
				ISNULL(REPLACE(REPLACE(LTRIM(RTRIM(p.GPAddressHTML)), CHAR(13), '<br/>'), CHAR(10), '<br/>'),'<br/>') AS GPAddress,
			ISNULL(CONVERT(VARCHAR(11),pj.ProcedureStartTime,106) + ' (' + CONVERT(VARCHAR(5),pj.ProcedureStartTime,108) + CASE WHEN pj.ProcedureEndTime is null THEN ')' ELSE ' - ' + CONVERT(VARCHAR(5), pj.ProcedureEndTime, 108) + ')' END,'') AS ProcedureDate, 
			ISNULL(ps.ListItemText, '') AS PatientStatus, 
			ISNULL(oh.HospitalName,'') AS HospitalName,
			ISNULL(oh.ContactNumber,'') AS HospitalPhoneNumber,
			ISNULL(w.WardDescription,'') AS Ward,
			ISNULL(eut.Description,'') AS PatientPriority,
			pr.PatientType AS PatientType
	FROM 
			ERS_VW_PatientswithGP p 
	INNER JOIN 
			ERS_Procedures pr ON p.[PatientId] = pr.PatientId 
	LEFT JOIN 
			ERS_Lists ps ON pr.PatientStatus = ps.ListItemNo AND ps.ListDescription = 'Patient Status'
	LEFT JOIN 
			ERS_Wards w ON pr.Ward = w.WardId
	LEFT JOIN 
			ERS_Lists c ON pr.CategoryListId = c.ListItemNo AND c.ListDescription = 'Procedure Category'
	INNER JOIN 
			ERS_OperatingHospitals oh ON pr.OperatingHospitalID = oh.OperatingHospitalId
	LEFT JOIN ERS_PatientJourney pj ON pr.ProcedureId = pj.ProcedureId 
	LEFT JOIN dbo.ERS_UrgencyTypes eut ON eut.UniqueId = pr.CategoryListId
	WHERE 
			pr.ProcedureId = @ProcedureId 
END

ELSE
BEGIN

       DECLARE @TableName VARCHAR(100) = (SELECT dbo.fnGetUGI_tablename(@ProcedureType,'procedure') 
										FROM [Episode]  
										WHERE CHARINDEX('1', [Status]) BETWEEN 1 AND 12 
										AND [Patient No] = @PatientComboId 
										AND [Episode No] = @EpisodeNo)

	DECLARE @SQL NVARCHAR(MAX) = 'DECLARE @HospId INT, @PP_RepDateAndTime VARCHAR(100), @PP_PatAddress VARCHAR(100), @PP_GP VARCHAR(1000), @HospName VARCHAR(50) '
	SET @SQL = @SQL + ' SELECT @HospId = [Operating Hospital ID], @PP_RepDateAndTime = [PP_RepDateAndTime], @PP_PatAddress = [PP_PatAddress], @PP_GP= ISNULL(PP_GP ,'''') FROM '
						+ @TableName +'  WHERE [Episode No] = ' + cast(@EpisodeNo as varchar(50))  
       
	SET @SQL = @SQL + ' SELECT @HospName = Name FROM [Operating Hospital] WHERE ID = @HospId '

	SET @SQL = @sql +  N'SELECT 
			ISNULL(p.Title,'''') + '' '' + ISNULL(p.Forename, '''') + '' '' + p.Surname AS PatientName, 
			ISNULL(p.Forename, '''') AS Forename,
			ISNULL(p.Surname, '''') AS Surname,
			ISNULL(Gender, '''') AS Gender,
			ISNULL([Date of Birth], '''') AS DateOfBirth, 
			ISNULL([NHS No],'''') AS NHSNo, 
			ISNULL([Case note no], '''') AS CaseNoteNo, 
			--ISNULL(REPLACE(REPLACE(p.[Address], CHAR(13),''), CHAR(10),''<br />''), '''') +  ISNULL(REPLACE(REPLACE(p.[Post code], CHAR(13),''''), CHAR(10),''''), '''') AS [Address],
			ISNULL(@PP_PatAddress,'''') AS [Address], 
			'''' AS GPName, --ISNULL(p.[GP Name], '''') AS GPName, 
			ISNULL(@PP_GP, '''') AS GPAddress, --ISNULL(p.[GP Address], '''') AS GPAddress,
			--LEFT(CONVERT(VARCHAR(30), e.[Procedure time], 113), 17) AS ProcedureDate, 
			--FORMAT(e.[Episode date], ''dd MMMM yyyy'', ''en-GB'') + FORMAT(e.[Procedure time], '' (HH:mm:ss)'', ''en-GB'') AS ProcedureDate, 
			--CONVERT(VARCHAR(11),e.[Episode date],106) + '' ('' + CONVERT(VARCHAR(5),e.[Procedure time],108) + '')'' AS ProcedureDate, 
			ISNULL(@PP_RepDateAndTime,'''') AS ProcedureDate, 
			ISNULL(ps.[List item text], '''') AS PatientStatus, 
			--ISNULL(p.Hospitals, '''') AS HospitalName,
			ISNULL(@HospName ,'''') AS HospitalName,
			'''' AS HospitalPhoneNumber,
			ISNULL(w.[List item text], '''') AS Ward
	FROM 
			Patient p 
	INNER JOIN
			Episode e ON p.[Combo ID] = e.[Patient No]
	LEFT JOIN 
			Lists ps ON p.[Patient Status 1] = ps.[List item no] AND ps.[List description] = ''PatientStatus''
	LEFT JOIN 
			Lists w ON p.Ward = w.[List item no] AND w.[List description] = ''Ward''
	WHERE 
			p.[Combo ID] = ''' + @PatientComboId + ''' AND
			e.[Episode No] = ' + CAST(@EpisodeNo AS VARCHAR(10))

	EXEC sp_executesql @SQL
END
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	No TFS - Item 2827
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ahmed Shoud
-- TFS#	No TFS - Item 4071 
-- Description of change
-- Referral Type (GP) add free text box
------------------------------------------------------------------------------------------------------------------------
GO

IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.COLUMNS
    WHERE TABLE_NAME = 'ERS_Procedures'
      AND COLUMN_NAME IN ('GPReferrer')
)
BEGIN
    ALTER TABLE dbo.ERS_Procedures
    ADD GPReferrer VARCHAR(500) NULL;
END

GO

IF NOT EXISTS(SELECT * FROM ERS_XMLMap WHERE FieldName = 'PP_RefConsName' AND NodeName = 'RefConsName' AND [Group] = 'GPD' AND Active = -1 AND OrderID IS NULL)
	BEGIN 
		INSERT INTO ERS_XMLMap(FieldName, NodeName, [Group], Active, OrderID) VALUES('PP_RefConsName', 'RefConsName', 'GPD', -1, NULL)
	END 

GO

EXEC dbo.DropIfExist @ObjectName = 'usp_Procedures_Insert',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[usp_Procedures_Insert]
(
	@ProcedureType		INT,
	--@PatientNo		VARCHAR(24),
	@PatientId			INT,
	@ProcedureDate		DATETIME,
	@ProcedureTime		VARCHAR(2),
	@PatientStatus		INT,
	@PatientWard		INT,
	@PatientType		INT,
	@OperatingHospitalId INT,
	@ListConsultant		INT,
	@Endoscopist1		INT,
	@Endoscopist2		INT,
	@Assistant			INT,
	@Nurse1				INT,
	@Nurse2				INT,
	@Nurse3				INT,
	@Nurse4				INT,
	@ReferralHospitalNo INT,
	@ReferralConsultantNo INT,
	@ReferralConsultantSpeciality INT,
	@PatientConsent		TINYINT,
	@DefaultCheckBox	BIT,
	@UserID				INT,
	@ProductType		TINYINT,
	@ListType			TINYINT,
	@Endo1Role			TINYINT,
	@Endo2Role			TINYINT,
	@CategoryListId		INT,
	@OnWaitingList		BIT,
	@OpenAccessProc		TINYINT,
	@EmergencyProcType	TINYINT,
	@NewProcedureId		INT OUTPUT,	-- This will return the newly created ProcedureId to the GUI! To play
	@ImagePortId		INT,
	@Points				DECIMAL,
	@ChecklistComplete	BIT,
	@ReferrerType		INT,
	@GPReferrer VARCHAR(500) = NULL,
	@ReferrerTypeOther  VARCHAR(500),
	@ProviderId			INT,
	@ProviderOther		VARCHAR(500),
	@PatientNotes		BIT,
	@PatientReferralLetter	BIT,
	@ImageGenderID	int,
	@OrderId	int
)
AS

SET NOCOUNT ON

DECLARE @newProcId INT
DECLARE @ppEndos VARCHAR(2000), @GPName varchar(255), @GPAddress varchar(max), @Endo1 varchar(500), @Endo2 varchar(500), @RefCons varchar(50), @RefHosp varchar(50)

BEGIN TRANSACTION
--sp_help 'dbo.ERS_Procedures'
	BEGIN TRY
		INSERT INTO ERS_Procedures
			(ProcedureType,
			CreatedBy,	
			CreatedOn,			
			ModifiedOn,
			ProcedureTime,
			PatientId,
			CategoryListId,
			OnWaitingList,
			OpenAccessProc,
			EmergencyProcType,
			OperatingHospitalID,
			ListConsultant,
			Endoscopist1,
			Endoscopist2,
			Assistant,
			Nurse1,
			Nurse2,
			Nurse3,
			Nurse4,
			ReferralHospitalNo,
			ReferralConsultantNo,
			ReferralConsultantSpeciality,
			PatientStatus,
			Ward,
			PatientType,
			PatientConsent,
			ListType,
			Endo1Role,
			Endo2Role,
			ImagePortId,
			WhoCreatedId,
			WhenCreated,
			Points,
			ChecklistComplete,
			ReferrerType,
			GPReferrer,
			ReferrerTypeOther,
			ProviderTypeId,
			ProviderOther,
			PatientNotes,
			PatientReferralLetter,
			ImageGenderID,
			OrderId)
		VALUES (
			@ProcedureType,
			@UserID,
			@ProcedureDate, --CASE WHEN CONVERT(DATE, GETDATE()) = @ProcedureDate THEN GETDATE() ELSE @ProcedureDate END, --Insert date and time if Procedure date is current date
			GETDATE(),
			@ProcedureTime,
			@PatientId,
			@CategoryListId,
			@OnWaitingList,
			@OpenAccessProc,
			@EmergencyProcType,
			@OperatingHospitalID,
			@ListConsultant,
			@Endoscopist1,
			@Endoscopist2,
			@Assistant,
			@Nurse1,
			@Nurse2,
			@Nurse3,
			@Nurse4,
			@ReferralHospitalNo,
			@ReferralConsultantNo,
			@ReferralConsultantSpeciality,
			@PatientStatus,
			@PatientWard,
			@PatientType,
			@PatientConsent, 
			@ListType,
			@Endo1Role,
			@Endo2Role,
			@ImagePortId,
			@UserID,
			GETDATE(),
			@Points,
			@ChecklistComplete,
			@ReferrerType,
			@GPReferrer,
			@ReferrerTypeOther,
			@ProviderId,
			@ProviderOther,
			@PatientNotes,
			@PatientReferralLetter,
			@ImageGenderID,
			@OrderId)

		SET @newProcId = SCOPE_IDENTITY();
	
		--## Important Work- Insert a Blank Record in the ERS_ProceduresReorting- with this Unique ID! So, you can simply Update the PP fields later..!! 
		INSERT INTO dbo.ERS_ProceduresReporting(ProcedureId)VALUES(@newProcId);

		SET @ppEndos = ''
		IF @ListConsultant > 0 SELECT @ppEndos = @ppEndos + '$$List Consultant: ' + Title + ' ' + Forename + ' ' + Surname FROM ERS_Users WHERE UserID = @ListConsultant
		IF @Endoscopist1 > 0 
		BEGIN
			SELECT @Endo1 = Title + ' ' + Forename + ' ' + Surname FROM ERS_Users WHERE UserID = @Endoscopist1
			SELECT @ppEndos = @ppEndos + '$$Endoscopist No1: ' + @Endo1
			SELECT  @Endo1 = Title + ' ' + Forename + ' ' + Surname + 
					CASE WHEN isnull(Qualifications, '') != '' THEN ', ' + Qualifications else '' END + 
					CASE WHEN isnull(u.JobTitleID, 0) > 0 THEN CHAR(13)+CHAR(10) + jt.Description ELSE '' END  
			FROM ERS_Users u
			LEFT JOIN ERS_JobTitles jt on u.JobTitleID = jt.JobTitleID 
			WHERE UserID = @Endoscopist1
		END
		IF @Endoscopist2 > 0 
		BEGIN
			SELECT @Endo2 = Title + ' ' + Forename + ' ' + Surname FROM ERS_Users WHERE UserID = @Endoscopist2
			SELECT @ppEndos = @ppEndos + '$$Endoscopist No2: ' + @Endo2
			SELECT  @Endo2 = Title + ' ' + Forename + ' ' + Surname + 
					CASE WHEN isnull(Qualifications, '') != '' THEN ', ' + Qualifications else '' END + 
					CASE WHEN isnull(u.JobTitleID, 0) > 0 THEN CHAR(13)+CHAR(10) + jt.Description ELSE '' END  
			FROM ERS_Users u
			LEFT JOIN ERS_JobTitles jt on u.JobTitleID = jt.JobTitleID 		
			WHERE UserID = @Endoscopist2
		END
		IF @Nurse1 > 0 OR @Nurse2 > 0 OR @Nurse3 > 0 OR @Nurse4 > 0 
		BEGIN
			SELECT @ppEndos = @ppEndos + '$$' + 'Nurses: '
			IF @Nurse1 > 0 SELECT @ppEndos = @ppEndos + '##' + Title + ' ' + Forename + ' ' + Surname FROM ERS_Users WHERE UserID = @Nurse1
			IF @Nurse2 > 0 SELECT @ppEndos = @ppEndos + '##' + Title + ' ' + Forename + ' ' + Surname FROM ERS_Users WHERE UserID = @Nurse2
			IF @Nurse3 > 0 SELECT @ppEndos =  @ppEndos + '##' + Title + ' ' + Forename + ' ' + Surname FROM ERS_Users WHERE UserID = @Nurse3
			IF @Nurse4 > 0 SELECT @ppEndos =  @ppEndos + '##' + Title + ' ' + Forename + ' ' + Surname FROM ERS_Users WHERE UserID = @Nurse4
		END
		IF CHARINDEX('$$', @ppEndos) > 0 SET @ppEndos = REPLACE(STUFF(@ppEndos, charindex('$$', @ppEndos), 2, ''), '$$', '<br/>')
		IF CHARINDEX('##', @ppEndos) > 0 SET @ppEndos = REPLACE(STUFF(@ppEndos, charindex('##', @ppEndos), 2, ''), '##', '<br/>')
	
		SET @RefCons=''
		IF @ReferrerType = 1
		BEGIN
			SET @RefCons = 'GP'
		END
		ELSE IF @ReferrerType = 5
		BEGIN
			SET @RefCons = @ReferrerTypeOther
		END
		ELSE
		BEGIN
			SELECT @RefCons = Upper(ec.Forename) FROM dbo.ERS_Consultant ec WHERE ec.ConsultantID = @ReferralConsultantNo --TFS 4184
		END	
		--SELECT @GPName = p.[GP Name] , @GPAddress = p.[GP Address] FROM Patient p left join  ERS_Procedures pr ON p.[Patient No]= pr.PatientId WHERE pr.ProcedureId = @newProcId
		--SELECT @GPName = p.[GP Name] , @GPAddress = p.[GP Address] FROM ERS_Patients p WHERE p.[Patient No]= @PatientId

		SET @RefHosp = ''
		SELECT @RefHosp = rh.HospitalName FROM dbo.ERS_ReferralHospitals rh WHERE rh.HospitalID = @ReferralHospitalNo

		--Get GP practice name and address
		SELECT 	TOP 1 
			@GPName		= g.CompleteName,
			@GPAddress	= replace(dbo.fnFullAddress(ep.[Name], ep.Address1, ep.Address2, CASE WHEN ep.Address3 Is null THEN EP.Address4 ELSE ep.Address3 + ' ' + EP.Address4 END, ep.PostCode), ',', ', <br />')
		FROM ERS_Patients p 
		LEFT JOIN ERS_GPs g ON g.GPId = p.RegGpId
		LEFT JOIN dbo.ERS_Practices ep ON p.RegGpPracticeId = ep.PracticeID
		where p.PatientId = @PatientId 

		UPDATE ERS_ProceduresReporting SET PP_Endos = @ppEndos, PP_GPName = @GPName, PP_GPAddress = @GPAddress, PP_Endo1 = @Endo1, PP_Endo2 = @Endo2, PP_RefCons = @RefCons, PP_RefHosp = @RefHosp WHERE ProcedureId = @newProcId

		UPDATE ERS_Consultant SET SortOrder = ISNULL(SortOrder,0) + 1 WHERE ConsultantID = @ReferralConsultantNo

		EXEC procedure_summary_update @newProcId

		--SELECT @newProcId AS ProcedureId
		SELECT @NewProcedureId=@newProcId;

	END TRY

	BEGIN CATCH
		DECLARE @ErrorMessage NVARCHAR(4000);
		DECLARE @ErrorSeverity INT;
		DECLARE @ErrorState INT;

		SELECT @ErrorMessage = ERROR_MESSAGE(),
			   @ErrorSeverity = ERROR_SEVERITY(),
			   @ErrorState = ERROR_STATE();
    
		RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

		IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
	END CATCH


	IF @@TRANCOUNT > 0 COMMIT TRANSACTION;
GO

EXEC dbo.DropIfExist @ObjectName = 'usp_PrintReport_Select',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[usp_PrintReport_Select]  
(  
 @ProcedureId INT,  
 @Group VARCHAR(10),  
 @EpisodeNo INT = 0,  
       @PatientComboId VARCHAR(30) = NULL,  
       @ProcedureType INT,  
       @ColonType INT  
)  
/*
	Update History:
	01 Feb 2024			:		MH	removed Diagnoses part for DNA / Cancelled reports TFS : 2885 - Cancelled reports
*/
AS  
  
SET NOCOUNT ON  
  
 DECLARE @SQLString NVARCHAR(MAX),  
   @FieldName VARCHAR(150),  
   @NodeName VARCHAR(50),  
   @TableName VARCHAR(50),  
   @Condition VARCHAR(100),  
   @ReportStyle SMALLINT,  
   @ExecQuery BINARY = 0,  
   @IncludeUGI BIT = 0,
   @DNAProcedure smallint = 0,
   @SummaryOrder	INT = 0;  
  
 DECLARE @Procedure_Reporting_TableJoinText VARCHAR(255);  
 select @EpisodeNo=(CASE WHEN dbo.fnShouldIncludeUGI()=1 THEN @EpisodeNo ELSE 0 END);  
 
 select @DNAProcedure  = IsNull(DNA,0) from ERS_Procedures Where ProcedureId = @ProcedureId

 CREATE TABLE #Summary (NodeName VARCHAR(200), NodeSummary NVARCHAR(MAX) ,[Group] VARCHAR(10), [SummaryOrder] INT)  
 CREATE TABLE #xmlmap ([FieldName] [varchar](50), [NodeName] [varchar](50), [Group] [varchar](10), [Active] [smallint], [OrderID] [int])  
  
 --DECLARE @ProcedureTypeId INT  
 --SELECT @ProcedureTypeId = ProcedureType FROM ERS_Procedures WHERE ProcedureId = @ProcedureId  
 
IF @Group = 'AD'  
 INSERT INTO #xmlmap  
 SELECT FieldName, NodeName, [Group], Active, OrderID  
 FROM ERS_XMLMap   
 WHERE [FieldName] IN ('PP_Site_Legend', 'PP_SpecimenTaken')  
 ORDER BY OrderID  
ELSE IF @Group='Premed'  
       INSERT INTO #xmlmap  
       SELECT FieldName, NodeName, [Group], Active, OrderID   
    FROM ERS_XMLMap WHERE [FieldName] IN ('PP_Premed', 'PP_Bowel_Prep') AND [Group]='RS'  
ELSE  
 INSERT INTO #xmlmap  
 SELECT FieldName, NodeName, [Group], Active, OrderID  
 FROM ERS_XMLMap   
 WHERE [Group] = @Group AND [FieldName] NOT IN ('PP_Site_Legend', 'PP_SpecimenTaken')  
 ORDER BY OrderID  
  
  --MH Added on 01 Feb 2024 - TFS 2885 - Cancelled reports
  if @DNAProcedure > 0
  Begin
	Delete from #xmlmap Where FieldName = 'PP_Diagnoses'
  End

 IF @ProcedureId IS NOT NULL AND @ProcedureId > 0  
  BEGIN  
   SET @TableName = '[ERS_Procedures]'  
   SET @Procedure_Reporting_TableJoinText = '  AS P LEFT JOIN dbo.ERS_ProceduresReporting AS PR ON P.ProcedureId = PR.ProcedureId '  
   SET @Condition = 'P.ProcedureId = @ProcedureId'  
  
   IF (SELECT isnull(PP_Pathology, '') from ERS_ProceduresReporting where ProcedureID = @ProcedureId) != ''  
    AND @Group = 'RS'  
    INSERT INTO #Summary   
    Select 'Revised', 'Revised report following pathology report dated ' + isnull(convert(varchar, DateOfReport, 106), ''), 'RS', @SummaryOrder  from ERS_UpperGIPathologyResults where ProcedureId = @ProcedureId  
  END  
 ELSE IF @EpisodeNo > 0  
  BEGIN  
      SELECT TOP 1 @TableName = LTRIM(RTRIM(dbo.fnGetUGI_tablename(@ProcedureType,'procedure')))  
   FROM [Episode]   
   WHERE CHARINDEX('1', [Status]) BETWEEN 1 AND 8 AND [Patient No] = @PatientComboId AND [Episode No] = @EpisodeNo  
   SET @Condition = '[Patient No] = @PatientComboId AND [Episode No] = @EpisodeNo'  
      IF @ColonType >= 0 SET @Condition = @Condition + ' AND [Procedure type] = ' +CAST( @ColonType as varchar(50))  
  END  
  
 DECLARE report_cursor CURSOR FOR   
 SELECT FieldName FROM #xmlmap ORDER BY OrderID ASC  
  
 OPEN report_cursor   
 FETCH NEXT FROM report_cursor INTO @FieldName  
  
 WHILE @@FETCH_STATUS = 0  
 BEGIN  
  SELECT @NodeName = NodeName, @Group = [Group], @SummaryOrder = OrderID FROM #xmlmap WHERE FieldName = @FieldName
	IF (@SummaryOrder IS NULL)
	BEGIN
		SET @SummaryOrder = 0
	END
   
  IF @ProcedureId IS NOT NULL AND @ProcedureId > 0  
  BEGIN  
   IF @FieldName = 'Endoscribe comments' SET @FieldName = 'EndoscribeComments'  
   ELSE IF @FieldName = 'Procedure date' SET @FieldName = 'CreatedOn'  
   ELSE IF @FieldName = 'Time of procedure' SET @FieldName = 'CreatedOn'  
   ELSE IF @FieldName = 'PP2_CompiledOn' SET @FieldName = 'ModifiedOn'  
   ELSE IF @FieldName = 'PP2_SiteData' SET @FieldName = 'PP_Site_Legend'  
   --ELSE IF @FieldName = 'PP_MainReportBody' SET @FieldName = 'Summary'    
  END  
  
  IF @FieldName = 'PP_Premed' AND @ProcedureType in (10, 11) --Bronchoscopy or EBUS
   SET @NodeName = 'Sedation and anaesthesia'  
  
  --IF [Report Style] = 1 -> New style report, select from PP2 field  
  IF @TableName <> '[ERS_Procedures]' AND @EpisodeNo > 0 AND @FieldName = 'PP_MainReportBody'  
    SET @FieldName = 'CASE WHEN ISNULL([Report Style],0) = 0 THEN PP_MainReportBody ELSE PP2_MainReportBody END'  
  ELSE IF @FieldName = 'PP_MainReportBody' AND @ProcedureId > 0 SET @FieldName = 'PR.Summary'    
  ELSE IF @FieldName = 'Resected colon no' AND @ProcedureId > 0 SET @FieldName = 'ResectedColonNo'   
  ELSE IF @FieldName = 'PP_RefConsName' AND @ProcedureId > 0 SET @FieldName = 'P.GPReferrer'
  ELSE  
   SET @FieldName = '[' + @FieldName + ']'  
   
  SET @SQLString = 'INSERT INTO #Summary ' +   
       ' SELECT ''' + @NodeName + ''', ' + @FieldName + ', ' + '''' + @Group + '''' + ', ' + CAST(@SummaryOrder AS NVARCHAR(10)) +  
       ' FROM ' + @TableName +   
       CASE WHEN @ProcedureId>0 THEN @Procedure_Reporting_TableJoinText ELSE '' END +  
       ' WHERE ' + @Condition;  
   
  --PP_Therapies (Therapeutic procedures) should be displayed for UGI old style report only, else should be part of the site  
  IF @TableName <> '[ERS_Procedures]' AND @EpisodeNo > 0   
  BEGIN  
   IF @FieldName IN ('[PP_Therapies]', '[PP_SpecimenTaken]' )  
    SET @SQLString = @SQLString + ' AND ISNULL([Report Style],0) = 0'  
   --PP2_SiteData (Site Data) should not be displayed for UGI old style report  
   ELSE IF @FieldName = '[PP2_SiteData]'  
    SET @SQLString = @SQLString + ' AND ISNULL([Report Style],0) = 1'  
  END   
  
  SET @ExecQuery =   
   CASE   
    WHEN @FieldName = '[PP_NPSAalert]' AND @TableName <> '[Upper GI Procedure]' THEN 0  
    WHEN @FieldName = '[PP_ResectedColon]' AND @EpisodeNo > 0 THEN 0  
    WHEN @FieldName = '[Resected colon no]' AND @TableName <> '[Colon Procedure]' THEN 0  
    WHEN @FieldName = '[PP_Coding]' AND @TableName <> '[ERS_Procedures]' THEN 0  
    WHEN @FieldName = '[Report style]' AND @TableName = '[ERS_Procedures]' THEN 0  
    WHEN LEFT(@FieldName,10) = '[PP2_Patho' AND @TableName = '[ERS_Procedures]' THEN 0  
    ELSE 1  
   END  
  
  --Select @ProcedureId, @EpisodeNo, @PatientComboId, @sqlstring  
  IF @ExecQuery = 1   
  BEGIN  
   EXEC sp_executesql @SQLString,  
    N'@ProcedureId INT, @EpisodeNo INT, @PatientComboId VARCHAR(30)',  
    @ProcedureId, @EpisodeNo, @PatientComboId  
  END  
  
  FETCH NEXT FROM report_cursor INTO @FieldName  
 END  
  
 CLOSE report_cursor  
 DEALLOCATE report_cursor  
  
 IF @EpisodeNo > 0 --UGI  
 BEGIN  
  UPDATE #Summary SET NodeSummary = REPLACE(NodeSummary,char(13),'<BR />') WHERE NodeName in ('Report', 'Indications', 'Advice/comments')   
  --UPDATE #Summary SET NodeSummary = REPLACE(NodeSummary,'<br><b>','<b>') WHERE NodeName in ('Site Data')  
  UPDATE #Summary SET NodeSummary = REPLACE(NodeSummary,'</b>','</b><BR />') WHERE NodeName in ('Site Data')   
  --UPDATE #Summary SET NodeSummary = REPLACE(NodeSummary,char(13),'<BR />&nbsp;&nbsp;') WHERE NodeName in ('Site Data')   
  --UPDATE #Summary SET NodeSummary = REPLACE(NodeSummary,'<BR />&nbsp;&nbsp;<b>','<BR /><b>') WHERE NodeName in ('Site Data')   
 END   
  
 IF EXISTS(SELECT TOP 1 NodeName FROM #Summary WHERE NodeName = 'InstForCare')  
 BEGIN   
  UPDATE #Summary SET NodeName = (SELECT TOP 1 NodeSummary FROM #Summary WHERE NodeName = 'InstForCareHeading')  
   ,NodeSummary = dbo.fnFirstLetterUpper(NodeSummary)  
  WHERE NodeName = 'InstForCare'  
  
  DELETE #Summary WHERE NodeName = 'InstForCareHeading'  
 END  
  
 --Append NPSA alert to end of report section  
 IF (SELECT COUNT(*) FROM #Summary WHERE NodeName = 'Report') > 0  
 BEGIN  
  DECLARE @NPSAalert NVARCHAR(MAX)   
  IF @EpisodeNo > 0  
   SELECT @NPSAalert=CONVERT(NVARCHAR(MAX),[PP_NPSAalert]) FROM  [Upper GI Procedure] WHERE [Patient No] = @PatientComboId AND [Episode No] = @EpisodeNo  
  ELSE IF @ProcedureId IS NOT NULL AND @ProcedureId > 0  
   SELECT @NPSAalert=CONVERT(NVARCHAR(MAX),[PP_NPSAalert]) FROM [ERS_ProceduresReporting] WHERE ProcedureId = @ProcedureId  
  
  IF ISNULL(@NPSAalert,'') <> ''  
   UPDATE #Summary  
   SET NodeSummary = NodeSummary + '<table style="border: 1px solid red;border-radius:10px;-moz-border-radius:10px;-webkit-border-radius:10px;width:95%;"><tr><td style="padding:10px;color:red;">' + @NPSAalert + '</td><td style="width:5%;padding:5px;"><img src="/images/icons/alert.png" style="vertical-align:middle; padding:0px 2px 0px 2px;" /></td></tr></table>'  
   WHERE NodeName = CASE WHEN @EpisodeNo > 0 THEN 'Site Data' ELSE 'Report' END  
 END  
  
	SELECT S.[NodeName], S.[NodeSummary], S.[Group]
	FROM #Summary S
	left outer join #xmlmap x on x.NodeName = S.NodeName
	WHERE S.NodeSummary IS NOT NULL
	order by S.SummaryOrder --x.OrderID 
  
 DROP TABLE #xmlmap  
 DROP TABLE #Summary
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	No TFS - Item 4071
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ahmed Shoud
-- TFS#	No TFS - Item 3708 
-- Description of change
-- Anti Coag free text box
------------------------------------------------------------------------------------------------------------------------
GO

IF EXISTS (SELECT 1 FROM dbo.UI_Sections WHERE SectionName = 'Anti-coag drugs')
BEGIN
    UPDATE UI_Sections
	SET ReferenceTableName = 'ERS_PotentialDamagingDrugs', DataTableName = 'ERS_ProcedureDamagingDrugs'
	WHERE SectionName = 'Anti-coag drugs'
END

GO

EXEC dbo.DropIfExist @ObjectName = 'add_new_reference_item',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)

GO
CREATE PROCEDURE [dbo].[add_new_reference_item]
(
	@SectionName varchar(200), 
	@NewItem varchar(200), 
	@LoggedInUserId int,
	@NewId int output --TFS 3708
)
AS
BEGIN
	DECLARE @TableName varchar(200)

	SELECT @TableName = ReferenceTableName FROM UI_Sections WHERE SectionName = @SectionName
	IF ISNULL(@TableName,'') <> ''
	BEGIN
		DECLARE @SQL nvarchar(max)

		IF (SELECT count(1)
			FROM INFORMATION_SCHEMA.COLUMNS
			WHERE TABLE_NAME = @TableName
			AND COLUMN_NAME = 'Suppressed') > 0
		BEGIN
			-- TFS 3708 Start
			DECLARE @COLUMNS_NAME nvarchar(max) = 'INSERT INTO ' + @TableName + ' ([Description], WhoCreatedId, WhenCreated, Suppressed'
			IF @SectionName = 'Anti-coag drugs'
				SET @COLUMNS_NAME = @COLUMNS_NAME + ', AntiCoag'
			SET @SQL = @COLUMNS_NAME + ') VALUES (''' + @NewItem + ''', ' + CONVERT(VARCHAR(10), @LoggedInUserId) +', getdate(), 0'

			IF @SectionName = 'Anti-coag drugs'
				SET @SQL = @SQL + ', 1'	
			SET @SQL = @SQL + ')

			SELECT @NewId = Scope_Identity()'

			-- TFS 3708 End
		END
		ELSE
		BEGIN
			SET @SQL = 
				'INSERT INTO ' + @TableName + ' ([Description], WhoCreatedId, WhenCreated) 
				VALUES (''' + @NewItem + ''', ' + CONVERT(VARCHAR(10), @LoggedInUserId) +', getdate())
				
				SELECT @NewId = Scope_Identity()'
		END
		EXECUTE sp_executesql @SQL, N'@NewId int out', @NewId out

		Select @NewId

	END
END

GO

EXEC dbo.DropIfExist @ObjectName = 'procedure_damaging_drugs_save',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)

GO

CREATE PROCEDURE [dbo].[procedure_damaging_drugs_save]
(
	@ProcedureId int, 
	@DrugId varchar(255), 
	@LoggedInUserId int,
	@AntiCoag bit,
	@SectionName varchar(200), 
	@NewItem varchar(200)
)
AS
BEGIN
	--check if is an anticoag drug
	DECLARE @AntiCoagDrugs bit = (SELECT AntiCoagDrugs FROM ERS_Procedures WHERE ProcedureId = @ProcedureId),
				@SectionId int = (SELECT UISectionId FROM UI_Sections WHERE SectionName = 'Anti-coag drugs'),
				@NewAntiCoagId int

	--delete existing drugs
	DELETE FROM ERS_ProcedureDamagingDrugs WHERE ProcedureId = @ProcedureId AND DamagingDrugId IN (SELECT UniqueId FROM ERS_PotentialDamagingDrugs WHERE AntiCoag = @AntiCoag)

	IF @AntiCoag = 1 
	BEGIN
		--TFS 3708 Start
		IF @SectionName IS NOT NULL AND @NewItem IS NOT NULL AND LTRIM(RTRIM(@NewItem)) <> ''
		BEGIN
			EXEC add_new_reference_item @SectionName,@NewItem,@LoggedInUserId,@NewAntiCoagId output
			SET @DrugId = @DrugId + ',' + CONVERT(VARCHAR(100), @NewAntiCoagId)
		END
		--TFS 3708 End
		IF @AntiCoagDrugs = 1 
			exec UI_update_procedure_summary @ProcedureId, 'Anti-coag drugs', '', 0
		ELSE IF @AntiCoagDrugs = 0
		BEGIN
			exec UI_update_procedure_summary @ProcedureId, 'Anti-coag drugs', '', 1
			exec UI_update_procedure_summary @ProcedureId, 'RX', '', 1
		END

		EXEC patient_anti_coag_drugs_save @ProcedureId, @AntiCoag
	END

	--save existing drugs
	DECLARE @SelectedID int;
	DECLARE db_cursor CURSOR FOR  
	SELECT item  FROM fnSplitString( @DrugId, ',')

	OPEN db_cursor   
	FETCH NEXT FROM db_cursor INTO @SelectedID 
	WHILE @@FETCH_STATUS = 0   
	BEGIN

		INSERT INTO [dbo].[ERS_ProcedureDamagingDrugs] (ProcedureId, DamagingDrugId, WhoCreatedId, WhenCreated)
		VALUES (@ProcedureId, @SelectedID, @LoggedInUserId, getdate())
	
		DECLARE @Summary VARCHAR(max) = 'Significant drugs',
				@DamagingDrugsCount int = (SELECT count(*) FROM ERS_ProcedureDamagingDrugs WHERE ProcedureId = @ProcedureId)

		EXEC UI_update_procedure_summary @ProcedureId, 'Significant drugs', @Summary, @DamagingDrugsCount

		IF @AntiCoagDrugs IS NOT NULL
		BEGIN
			DELETE FROM ERS_ProcedureSummary WHERE ProcedureId = @ProcedureId AND SectionId = @SectionId

			INSERT INTO ERS_ProcedureSummary (SectionId, ProcedureId, Summary) VALUES (@SectionId, @ProcedureId, 'Anti-Coag drugs')
		END

	FETCH NEXT FROM db_cursor INTO @SelectedID   
	END   

	CLOSE db_cursor   
	DEALLOCATE db_cursor

	UPDATE ERS_ProceduresReporting
	SET PP_Indic = dbo.ProcedureIndicationsSummary(@ProcedureId)
	WHERE ProcedureId = @ProcedureId
END

GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	No TFS - Item 3708
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rezaul Karim
-- TFS#	4092
-- Description of change: Scope 1 must be mandatory
-------------------------------------------------------------------------------------------------------------------------

GO
dbo.DropIfExist
    @ObjectName = 'procedure_instruments_save',
    @ObjectTypePrefix = 'S' -- varchar(5)
GO
 
CREATE PROCEDURE [dbo].[procedure_instruments_save]
(
	@ProcedureId int,
	@Instrument1Id int,
	@Instrument2Id int,
	@ScopeGuideUsed bit
)
AS
BEGIN
	UPDATE ERS_Procedures 
	SET 
		Instrument1 = NULLIF(@Instrument1Id,0), 
		Instrument2 = NULLIF(@Instrument2Id, 0), 
		ScopeGuide = @ScopeGuideUsed
	WHERE ProcedureId = @ProcedureId

	DECLARE @SectionId int, @Summary varchar(max)

	
	/*Scope*/
	SET @Summary = 'Scopes:'
	IF @Instrument1Id > 0 
	BEGIN
		EXEC UI_update_procedure_summary @ProcedureId, 'Scopes', @Summary, @Instrument1Id
	END
	--ELSE IF @Instrument2Id > 0 
	--	EXEC UI_update_procedure_summary @ProcedureId, 'Scopes', @Summary, @Instrument2Id
	ELSE
		EXEC UI_update_procedure_summary @ProcedureId, 'Scopes', @Summary, 0

	--update reporting field for summary report
	DECLARE @InstrumentTxt varchar(200) = '', @Instru1Text varchar(200) = '', @Instru2Text varchar(200) = ''

	IF ISNULL(@Instrument1Id,0) > 0
		SELECT @Instru1Text = ScopeName FROM ERS_Scopes WHERE ScopeId = @Instrument1Id
	
	IF ISNULL(@Instrument2Id,0) > 0
		SELECT @Instru2Text = ScopeName FROM ERS_Scopes WHERE ScopeId = @Instrument2Id 
			
	--accessVia Part

	IF @ProcedureId IN (SELECT @ProcedureId  FROM ERS_Procedures WHERE ProcedureType IN (10, 11))
	BEGIN
		Select @Instru2Text = 'Access Via : ' + ListItemText
	FROM ers_lists WHERE ListItemNo=@Instrument2Id And ListDescription='AccessMethod Thoracic'
	END

	--accessVia Part
	
	If @Instru1Text <> '' 
		SET @InstrumentTxt = @Instru1Text

	
	If @Instru2Text <> '' 
		SET @InstrumentTxt = @InstrumentTxt + '<br /> ' + @Instru2Text

	IF @Instru1Text <> '' OR @Instru2Text <> ''
	BEGIN
		--transnasal check
		IF EXISTS (SELECT 1 FROM dbo.ERS_Procedures WHERE ProcedureId = @ProcedureId AND Transnasal = 1)
		BEGIN	
			SET @InstrumentTxt = @InstrumentTxt + ' (transnasal) '
		END

		UPDATE ERS_ProceduresReporting SET PP_Instrument = @InstrumentTxt WHERE ProcedureId = @ProcedureId
	END
END
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#4092 	Scope 1 must be mandatory
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rezaul Karim
-- TFS#	2958
-- Description of change: Fundic gland polyp reported as "tumour" on pdf report
-------------------------------------------------------------------------------------------------------------------------
GO
dbo.DropIfExist
    @ObjectName = 'abnormalities_common_lesions_summary_update',
    @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[abnormalities_common_lesions_summary_update]
(
	@SiteId INT
)
AS
SET NOCOUNT ON
	
DECLARE 
	@summary VARCHAR (8000),
	@tempsummary VARCHAR (1000),
	@None BIT,
	@Polyp BIT,

	@Sessile BIT,
	@SessileQuantity INT,
	@SessileLargest INT,
	@SessileExcised INT,
	@SessileRetrieved INT,
	@SessileToLabs INT,
	@SessileRemoval TINYINT,
	@SessileRemovalMethod TINYINT,
	@SessileProbably BIT,
	@SessileType TINYINT,
	@SessileParisClass TINYINT,
	@SessilePitPattern TINYINT,
	@Pedunculated BIT,
	@PedunculatedQuantity INT,
	@PedunculatedLargest INT,
	@PedunculatedExcised INT,
	@PedunculatedRetrieved INT,
	@PedunculatedToLabs INT,
	@PedunculatedRemoval TINYINT,
	@PedunculatedRemovalMethod TINYINT,
	@PedunculatedProbably BIT,
	@PedunculatedType TINYINT,
	@PedunculatedParisClass TINYINT,
	@PedunculatedPitPattern TINYINT,
	@Pseudopolyps BIT,
	@PseudopolypsMultiple BIT,
	@PseudopolypsQuantity INT,
	@PseudopolypsLargest INT,
	@PseudopolypsExcised INT,
	@PseudopolypsRetrieved INT,
	@PseudopolypsToLabs INT,
	@PseudopolypsInflam BIT,
	@PseudopolypsPostInflam BIT,
	@PseudopolypsRemoval TINYINT,
	@PseudopolypsRemovalMethod TINYINT,
	@Submucosal BIT,
	@SubmucosalQuantity INT,
	@SubmucosalLargest INT,
	@SubmucosalProbably BIT,
	@SubmucosalTypeId TINYINT,
	@Focal BIT,
	@FocalQuantity INT,
	@FocalLargest INT,
	@FocalProbably BIT,
	@FocalTypeId TINYINT,
	@Villous BIT,
	@VillousQuantity INT,
	@VillousLargest INT,
	@VillousProbably BIT,
	@VillousType TINYINT,
	@Ulcerative BIT,
	@UlcerativeQuantity INT,
	@UlcerativeLargest INT,
	@UlcerativeProbably BIT,
	@UlcerativeType TINYINT,
	@Stricturing BIT,
	@StricturingQuantity INT,
	@StricturingLargest INT,
	@StricturingProbably BIT,
	@StricturingType TINYINT,
	@Polypoidal BIT,
	@PolypoidalQuantity INT,
	@PolypoidalLargest INT,
	@PolypoidalProbably BIT,
	@PolypoidalType TINYINT,
	@Granuloma BIT,
	@GranulomaQuantity INT,
	@GranulomaLargest INT,
	@Dysplastic BIT,
	@DysplasticQuantity INT,
	@DysplasticLargest INT,
	@PneumatosisColi BIT,
	@Tattooed BIT,
	@PreviouslyTattooed BIT,
	@TattooType INT,
	@TattooedQty INT,
	@FundicGlandPolyp BIT,
	@FundicGlandPolypQuantity INT,
	@FundicGlandPolypLargest Numeric(18,2),
	@PreviousESDScar BIT

SET @summary = ''
SET @tempsummary = ''

SELECT 
	@None=[None],
	@Polyp = Polyp,
	@Submucosal = Submucosal,
	@SubmucosalTypeId = SubmucosalTumourTypeId,
	@SubmucosalLargest = SubmucosalLargest,
	@SubmucosalProbably = SubmucosalProbably,
	@SubmucosalQuantity = SubmucosalQuantity,
	@Focal = Focal,
	@FocalTypeId = FocalTumourTypeId,
	@FocalLargest = FocalLargest,
	@FocalProbably = FocalProbably,
	@FocalQuantity = FocalQuantity,
	@Granuloma=Granuloma,
	@GranulomaQuantity=GranulomaQuantity,
	@GranulomaLargest=GranulomaLargest,
	@Dysplastic=Dysplastic,
	@DysplasticQuantity=DysplasticQuantity,
	@DysplasticLargest=DysplasticLargest,
	@PneumatosisColi=PneumatosisColi,
	@Tattooed = Tattooed,
	@PreviouslyTattooed = PreviouslyTattooed,
	@TattooType = TattooType,
	@TattooedQty = TattooedQuantity,
	@FundicGlandPolyp = FundicGlandPolyp,
	@FundicGlandPolypQuantity = FundicGlandPolypQuantity,
	@FundicGlandPolypLargest = FundicGlandPolypLargest,
	@PreviousESDScar = PreviousESDScar
FROM
	ERS_CommonAbnoLesions
WHERE
	SiteId = @SiteId

SET @Summary = ''

IF NOT EXISTS (SELECT 1 FROM ERS_CommonAbnoLesions WHERE SiteId = @SiteId) return

IF @None = 1 SET @summary = 'No lesions'

ELSE
BEGIN
	--saves calling the table multiple times :)
	DECLARE @TumourTypes TABLE (TypeId int, [Description] varchar(100))
	INSERT INTO @TumourTypes
	SELECT UniqueId, [Description] 
	FROM ERS_TumourTypes 
	WHERE Suppressed = 0
	------------------------------------------------------------------------------------------
	-------	TUMOUR: VILLOUS -------
	------------------------------------------------------------------------------------------
	IF @Villous > 0
	BEGIN
		IF @summary <> '' SET @summary = @summary + '##'

		IF @VillousQuantity > 1 SET @summary = @summary + CONVERT(VARCHAR(20), @VillousQuantity) + ' '
		ELSE SET @summary = @summary + 'A '
		
		IF @VillousProbably = 1 SET @summary = @summary + 'probably '

		IF @VillousType = 1 SET @summary = @summary + 'benign '
		ELSE IF @VillousType = 2 SET @summary = @summary + 'malignant '

		IF @VillousQuantity > 1 SET @summary = @summary + 'villous tumours ' ELSE SET @summary = @summary + 'villous tumour ' 

		IF (@VillousQuantity > 0 AND @VillousLargest > 0) 
		BEGIN
			IF @VillousQuantity > 1
				SET @summary = @summary + '(largest ' + CONVERT(VARCHAR(20), @VillousLargest) + 'mm) '
			ELSE
				SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @VillousLargest) + 'mm) '
		END
	END

	------------------------------------------------------------------------------------------
	-------	TUMOUR: ULCERATIVE -------
	------------------------------------------------------------------------------------------
	IF @Ulcerative > 0
	BEGIN
		DECLARE @UlcerSummary VARCHAR(300) = ''
		IF @summary <> '' SET @summary = @summary + '##'

		IF @UlcerativeQuantity > 1 SET @UlcerSummary = @UlcerSummary + CONVERT(VARCHAR(20), @UlcerativeQuantity) + ' '
		
		IF @UlcerativeProbably = 1 SET @UlcerSummary = @UlcerSummary + 'probably '

		IF @UlcerativeType = 1 SET @UlcerSummary = @UlcerSummary + 'benign '
		ELSE IF @UlcerativeType = 2 SET @UlcerSummary = @UlcerSummary + 'malignant '

		IF @UlcerativeQuantity > 1 SET @UlcerSummary = @UlcerSummary + 'ulcerative tumours ' ELSE SET @UlcerSummary = @UlcerSummary + 'ulcerative tumour ' 

		IF LEFT(@UlcerSummary,1) = 'u' SET @UlcerSummary =  'An ' + @UlcerSummary
		ELSE IF ISNULL(@UlcerativeQuantity,0) <= 1 SET @UlcerSummary =  'A ' + @UlcerSummary

		IF (@UlcerativeQuantity > 0 AND @UlcerativeLargest > 0) 
		BEGIN
			IF @UlcerativeQuantity > 1
				SET @UlcerSummary = @UlcerSummary + '(largest ' + CONVERT(VARCHAR(20), @UlcerativeLargest) + 'mm) '
			ELSE
				SET @UlcerSummary = @UlcerSummary + '(' + CONVERT(VARCHAR(20), @UlcerativeLargest) + 'mm) '
		END

		SET @summary = @summary + @UlcerSummary
	END

	------------------------------------------------------------------------------------------
	-------	TUMOUR: STRICTURING -------
	------------------------------------------------------------------------------------------
	IF @Stricturing > 0
	BEGIN
		IF @summary <> '' SET @summary = @summary + '##'

		IF @StricturingQuantity > 1 SET @summary = @summary + CONVERT(VARCHAR(20), @StricturingQuantity) + ' '
		ELSE SET @summary = @summary + 'A '
		
		IF @StricturingProbably = 1 SET @summary = @summary + 'probably '

		IF @StricturingType = 1 SET @summary = @summary + 'benign '
		ELSE IF @StricturingType = 2 SET @summary = @summary + 'malignant '

		IF @StricturingQuantity > 1 SET @summary = @summary + 'stricturing tumours ' ELSE SET @summary = @summary + 'stricturing tumour ' 

		IF (@StricturingQuantity > 0 AND @StricturingLargest > 0) 
		BEGIN
			IF @StricturingQuantity > 1
				SET @summary = @summary + '(largest ' + CONVERT(VARCHAR(20), @StricturingLargest) + 'mm) '
			ELSE
				SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @StricturingLargest) + 'mm) '
		END
	END

	------------------------------------------------------------------------------------------
	-------	TUMOUR: POLYPOIDAL -------
	------------------------------------------------------------------------------------------
	IF @Polypoidal > 0
	BEGIN
		IF @summary <> '' SET @summary = @summary + '##'

		IF @PolypoidalQuantity > 1 SET @summary = @summary + CONVERT(VARCHAR(20), @PolypoidalQuantity) + ' '
		ELSE SET @summary = @summary + 'A '
		
		IF @PolypoidalProbably = 1 SET @summary = @summary + 'probably '

		IF @PolypoidalType = 1 SET @summary = @summary + 'benign '
		ELSE IF @PolypoidalType = 2 SET @summary = @summary + 'malignant '

		IF @PolypoidalQuantity > 1 SET @summary = @summary + 'polypoidal tumours ' ELSE SET @summary = @summary + 'polypoidal tumour ' 

		IF (@PolypoidalQuantity > 0 AND @PolypoidalLargest > 0) 
		BEGIN
			IF @PolypoidalQuantity > 1
				SET @summary = @summary + '(largest ' + CONVERT(VARCHAR(20), @PolypoidalLargest) + 'mm) '
			ELSE
				SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @PolypoidalLargest) + 'mm) '
		END
	END

	------------------------------------------------------------------------------------------
	-------	SUTURE GRANULOMA -------
	------------------------------------------------------------------------------------------
	IF @Granuloma > 0
	BEGIN
		IF @summary <> '' SET @summary = @summary + '##'

		IF @GranulomaQuantity > 1 SET @summary = @summary + CONVERT(VARCHAR(20), @GranulomaQuantity) + ' '
		ELSE SET @summary = @summary + 'A '
		
		IF @GranulomaQuantity > 1 SET @summary = @summary + 'granuloma tumours ' ELSE SET @summary = @summary + 'granuloma tumour ' 

		IF (@GranulomaQuantity > 0 AND @GranulomaLargest > 0) 
		BEGIN
			IF @GranulomaQuantity > 1
				SET @summary = @summary + '(largest ' + CONVERT(VARCHAR(20), @GranulomaLargest) + 'mm) '
			ELSE
				SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @GranulomaLargest) + 'mm) '
		END
	END

	------------------------------------------------------------------------------------------
	-------	DYSPLASTIC LESION -------
	------------------------------------------------------------------------------------------
	IF @Dysplastic > 0
	BEGIN
		IF @summary <> '' SET @summary = @summary + '##'

		IF @DysplasticQuantity > 1 SET @summary = @summary + CONVERT(VARCHAR(20), @DysplasticQuantity) + ' '
		ELSE SET @summary = @summary + 'A '
		
		IF @DysplasticQuantity > 1 SET @summary = @summary + 'dysplastic tumours ' ELSE SET @summary = @summary + 'dysplastic tumour ' 

		IF (@DysplasticQuantity > 0 AND @DysplasticLargest > 0) 
		BEGIN
			IF @DysplasticQuantity > 1
				SET @summary = @summary + '(largest ' + CONVERT(VARCHAR(20), @DysplasticLargest) + 'mm) '
			ELSE
				SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @DysplasticLargest) + 'mm) '
		END

	END

	------------------------------------------------------------------------------------------
	-------	PNEUMATOSIS COLI -------
	------------------------------------------------------------------------------------------
	IF @PneumatosisColi > 0
	BEGIN
		BEGIN
			IF @summary <> '' SET @summary = @summary + '##'

			SET @summary = @summary + 'pneumatosis coli '
		END
	END	
	
	------------------------------------------------------------------------------------------
	-------	SUBMUCOSAL LESION -------
	------------------------------------------------------------------------------------------
	IF @Submucosal > 0
	BEGIN
		IF @summary <> '' SET @summary = @summary + '##'

		IF @SubmucosalQuantity > 1 SET @summary = @summary + CONVERT(VARCHAR(20), @SubmucosalQuantity) + ' '
		ELSE SET @summary = @summary + 'A '
		
		IF @SubmucosalProbably = 1 SET @summary = @summary + 'probably '

		SELECT @summary = @summary + LOWER([Description]) + ' ' FROM @TumourTypes WHERE TypeId = @SubmucosalTypeId

		IF @SubmucosalQuantity > 1 SET @summary = @summary + 'submucosal lesions ' ELSE SET @summary = @summary + 'submucosal lesion ' 

		IF (@SubmucosalQuantity > 0 AND @SubmucosalLargest > 0) 
		BEGIN
			IF @SubmucosalQuantity > 1
				SET @summary = @summary + '(largest ' + CONVERT(VARCHAR(20), @SubmucosalLargest) + 'mm) '
			ELSE
				SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @SubmucosalLargest) + 'mm) '
		END
	END

	------------------------------------------------------------------------------------------
	-------	FOCAL LESIONS -------
	------------------------------------------------------------------------------------------
	IF @Focal > 0
	BEGIN
		IF @summary <> '' SET @summary = @summary + '##'

		IF @FocalQuantity > 1 SET @summary = @summary + CONVERT(VARCHAR(20), @FocalQuantity) + ' '
		ELSE SET @summary = @summary + 'A '
		
		IF @FocalProbably = 1 SET @summary = @summary + 'probably '

		SELECT @summary = @summary + LOWER([Description]) + ' ' FROM @TumourTypes WHERE TypeId = @FocalTypeId

		IF @FocalQuantity > 1 SET @summary = @summary + 'focal lesions ' ELSE SET @summary = @summary + 'submucosal lesion ' 

		IF (@FocalQuantity > 0 AND @FocalLargest > 0) 
		BEGIN
			IF @FocalQuantity > 1
				SET @summary = @summary + '(largest ' + CONVERT(VARCHAR(20), @FocalLargest) + 'mm) '
			ELSE
				SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @FocalLargest) + 'mm) '
		END
	END

	-------------------------------------------------------------------------------------------
	-------	Fundic Gland Polyp -------
	------------------------------------------------------------------------------------------
	IF @FundicGlandPolyp > 0
	BEGIN
		IF @summary <> '' SET @summary = @summary + '##'

		IF @FundicGlandPolypQuantity > 1 SET @summary = @summary + CONVERT(VARCHAR(20), @FundicGlandPolypQuantity) + ' '
		ELSE SET @summary = @summary + 'A '
		
		IF @FundicGlandPolypQuantity > 1 SET @summary = @summary + 'Fundic Gland Polyp found ' ELSE SET @summary = @summary + 'Fundic Gland Polyp found ' --TFS-2958---

		IF (@FundicGlandPolypQuantity > 0 AND @FundicGlandPolypLargest > 0) 
		BEGIN
			IF @FundicGlandPolypQuantity > 1
				SET @summary = @summary + '(largest ' + CONVERT(VARCHAR(20), @FundicGlandPolypLargest) + ' mm) '
			ELSE
				SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @FundicGlandPolypLargest) + ' mm) '
		END
	END
	
	------------------------------------------------------------------------------------------
	-------	Previous ESD Scar -------
	------------------------------------------------------------------------------------------
	IF @PreviousESDScar > 0
	BEGIN
		BEGIN
			IF @summary <> '' SET @summary = @summary + '##'

			SET @summary = @summary + 'previous ESD scar '
		END
	END	

	------------------------------------------------------------------------------------------
	-------	POLYPS	-------
	------------------------------------------------------------------------------------------
	IF @Polyp = 1
	BEGIN
		IF EXISTS (SELECT TOP 1 1 FROM dbo.ERS_CommonAbnoPolypDetails WHERE SiteId = @SiteId)
		BEGIN
			SET @summary = @summary + '<br />' + dbo.common_polpydetails_summary(@SiteId, NULL)
		END
	END


	------------------------------------------------------------------------------------------
	-------	POLYPS TATTOO ----------
	------------------------------------------------------------------------------------------
	/*IF @Tattooed > 0 
	BEGIN
		DECLARE @TattooTypeText varchar(50)

		SELECT @TattooType = MarkingType, @TattooedQty = MarkedQuantity FROM dbo.ERS_UpperGITherapeutics WHERE SiteId = @SiteID AND Marking = 1
		
		IF @summary <> '' SET @summary = @summary + '## <br />'

		SET @summary = @summary + ' Tattooed, '
		
		IF @TattooType IS NOT NULL AND @TattooType > 0
		BEGIN
			SELECT @TattooTypeText = ListItemText FROM dbo.ERS_Lists el WHERE el.ListDescription = 'Abno marking' AND el.ListItemNo = @TattooType AND ListItemText IS NOT NULL

			SET @summary = @summary + CASE WHEN @TattooedQty IS NOT NULL AND @TattooedQty > 0 THEN + CONVERT(varchar(5), @TattooedQty) ELSE '' END + ' marked using ' + @TattooTypeText
		END	
	END	
	ELSE IF @PreviouslyTattooed > 0
	BEGIN
		IF @summary <> '' SET @summary = @summary + '##'

		SET @summary = @summary + ' previously tattooed '
	END	
	*/
END

SET @summary = LTRIM(RTRIM(@summary))
SET @summary = REPLACE(@summary, '##', '. ')
SET @summary = REPLACE(@summary, ' ,', ',')
SET @summary = REPLACE(@summary, ' )', ')')
SET @summary = REPLACE(@summary, ' .', '.')

DECLARE @finalSummary VARCHAR(8000) =''
----Set first letter to upper after full stop.
SELECT @finalSummary = @finalSummary + COALESCE(dbo.fnFirstLetterUpper(item) + '. ', '') 
FROM dbo.fnSplitString(@summary, '.')

SET @summary = LTRIM(RTRIM(@finalSummary))
IF @None <> 1 SET @summary = LOWER(LEFT(@summary,1)) + RIGHT(@summary,LEN(@summary)-1)
IF RIGHT(@summary,1) = '.' SET @summary = LEFT(@summary, LEN(@summary)-1)

-- Finally, update the summary in Diverticulum table
UPDATE ERS_CommonAbnoLesions
SET Summary = @summary 
WHERE SiteId = @SiteId


EXEC sites_summary_update @SiteId
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#2958 	Fundic gland polyp reported as "tumour" on pdf report
------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ferdowsi On 22 May 2024
-- TFS#	No TFS - Item  4122
-- Description of change
-- Letter Printing : Search Dates using wrong table/column
------------------------------------------------------------------------------------------------------------------------

GO
EXEC dbo.DropIfExist @ObjectName = 'letGetQueueList',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[letGetQueueList]
(
	@StartDate DATE,
	@EndDate DATE,
	@IncludePrinted INT,
	@HospitalNumber INT,
	@HospitalIds varchar(100),
	@AppointmentStatusId INT
)
AS
BEGIN
	SELECT 
		lq.AppointmentId, 
		lq.OperationalHospitalId,
		LetterQueueId,
		STUFF((SELECT DISTINCT ', ' + HospitalNumber from ERS_PatientTrusts where PatientId = pt.PatientId for xml path('')), 1, 2, '') AS HospitalNumber,
		pt.NHSNo,
		pt.PatientId,
		lq.ProcedureId, 
		lq.AppointmentStatusId,
		pt.Forename1 AS Forname,
		pt.Surname,
		DescriptionForLetter,
		CASE WHEN Printed = 1 THEN 'Yes' ELSE 'No' END AS Printed,
		CASE WHEN Edited = 1 THEN 'Yes' ELSE '' END AS Edited,
		CASE WHEN EditedAfterPrint = 1 THEN 'Yes' ELSE '' END AS EditedAfterPrint,
		Convert(varchar,lq.whencreated,23) AS whencreated, 
		Convert(varchar,appoint.StartDateTime,120)  AS AppointmentDate,
		eu.Username AS WhoEdited,
		pu.Username AS WhoPrinted,
		lq.PrintCount
	FROM ERS_LetterQueue lq 
	JOIN ERS_Patients pt ON lq.PatientId = pt.PatientId
	JOIN ERS_AppointmentStatus apptSt ON lq.AppointmentStatusId = apptSt.UniqueId
	JOIN ERS_Appointments appoint On lq.AppointmentId = appoint.AppointmentId
	LEFT JOIN ERS_Users eu ON lq.WhoEdited = eu.UserID
	LEFT JOIN ERS_Users pu ON lq.WhoPrinted = pu.UserID
	JOIN ERS_LetterType lt ON lt.LetterName = apptSt.DescriptionForLetter AND lt.OperationalHospitalId = lq.OperationalHospitalId
	WHERE  CAST(appoint.StartDateTime AS DATE) BETWEEN @StartDate AND @EndDate
	AND (Printed = @IncludePrinted OR @IncludePrinted = 1)
	AND (pt.patientId in (Select PatientId from ERS_PatientTrusts where HospitalNumber like @HospitalNumber) OR @HospitalNumber IS NULL)
	AND lq.OperationalHospitalId in ( SELECT item FROM splitString(@HospitalIds, ',') )
	AND (lq.AppointmentStatusId = @AppointmentStatusId OR @AppointmentStatusId = 0)
	AND lt.IsActive = 1
	ORDER BY Convert(varchar,lq.whencreated,106) DESC
END

GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	No TFS - Item 4122  by Ferdowsi
------------------------------------------------------------------------------------------------------------------------
GO


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ferdowsi On 20 March 2024
-- TFS#	No TFS - Item 3894
-- Description of change
-- EBUS Coding being removed from the report which are unchecked
------------------------------------------------------------------------------------------------------------------------
GO
EXEC dbo.DropIfExist @ObjectName = 'broncho_coding_save',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[broncho_coding_save]
(
	@ProcedureId INT,
	@CodeId INT,
	@checkboxStatus BIT,
	@checkboxType VARCHAR(50),
	@LoggedInUserId INT

)
AS

SET NOCOUNT ON
    DECLARE @Type NVARCHAR(MAX) 
	DECLARE @RigidCodeValue BIT 
	DECLARE @FibreOpticCodeValue BIT

	-- Condition for insert data
    if @checkboxType ='Fibre'
     BEGIN
       SET @FibreOpticCodeValue =  @checkboxStatus
     END
    ELSE 
	 BEGIN 
	   SET @RigidCodeValue =@checkboxStatus
	 END


  
BEGIN TRANSACTION

BEGIN TRY

	IF NOT EXISTS (SELECT 1 FROM ERS_BRT_BronchoCoding WHERE ProcedureId = @ProcedureId AND CodeId = @CodeId) 
	BEGIN 
		INSERT INTO ERS_BRT_BronchoCoding (
			ProcedureId, 
			CodeId, 
			FibreOpticCodeValue, 
			RigidCodeValue,
			WhoCreatedId,
			WhenCreated) 
        VALUES (
			@ProcedureId, 
			@CodeId, 
			@FibreOpticCodeValue, 
			@RigidCodeValue,
			@LoggedInUserId,
			GETDATE()) 

		INSERT INTO ERS_RecordCount (
			[ProcedureId],
			[SiteId],
			[Identifier],
			[RecordCount]
		)
		VALUES (
			@ProcedureId,
			NULL,
			'Coding',
			1)
	END 

    ELSE 
    BEGIN
		UPDATE 
			ERS_BRT_BronchoCoding 
        SET 
			FibreOpticCodeValue = CASE WHEN @checkboxType ='Fibre'THEN @checkboxStatus ELSE FibreOpticCodeValue END, 
			RigidCodeValue =  CASE WHEN  @checkboxType ='Rigid' THEN @checkboxStatus ELSE RigidCodeValue END ,
			WhoUpdatedId = @LoggedInUserId,
			WhenUpdated = GETDATE()
        WHERE 
			ProcedureId = @ProcedureId 
			AND CodeId = @CodeId 
	END

END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;

Go
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	No TFS - Item 3894 by Ferdowsi
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea	23.5.24
-- TFS#	3181
-- Description of change
-- New user permission to allow user to add a slot to full list
-- option to add a slot to a full list 

-- Updated by	:	Ferdowsi On 10 june 2024
-- TFS#	No TFS - Item 3248
-- Description of change  
--  V2 Scheduler Cancellation List Audit 
------------------------------------------------------------------------------------------------------------------------
GO

EXEC dbo.DropIfExist @ObjectName = 'sch_add_list_slot',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE dbo.sch_add_list_slot
(
	@ListRulesId int, 
	@SlotId int, 
	@ProcedureTypeId int, 
	@OperatingHospitalId int, 
	@LoggedInUserId int, 
	@SlotMinutes decimal(18,2), 
	@Points decimal
)
AS
BEGIN
    INSERT INTO ERS_SCH_ListSlots (ListRulesId, SlotId, ProcedureTypeId,OperatingHospitalId, WhoCreatedId, WhenCreated, SlotMinutes, Points,Locked, IsOverBookedSlot, Suppressed)
    VALUES (@ListRulesId, @SlotId, @ProcedureTypeId, @OperatingHospitalId, @LoggedInUserId, GETDATE(), @SlotMinutes, @Points, 0, 1, 0)

	DECLARE @DiaryId INT = (SELECT TOP 1 DiaryId FROM dbo.ERS_SCH_DiaryPages d WHERE d.ListRulesId = @ListRulesId)
	UPDATE dbo.ERS_SCH_DiaryPages SET DiaryEnd = dbo.fnSCH_DiaryEnd(@ListRulesId, DiaryStart) WHERE DiaryId = @DiaryId
END
GO


IF NOT EXISTS (SELECT 1 FROM sys.columns WHERE name = 'CanOverbookLists' AND object_id = OBJECT_ID('ERS_Users'))
BEGIN
    ALTER TABLE dbo.ERS_Users ADD CanOverBookLists BIT NOT NULL CONSTRAINT [DF_ERS_Users_CanOverbookLists] DEFAULT 0
END
GO


EXEC dbo.DropIfExist @ObjectName = 'get_user',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[get_user]
(
	@UserId INT,
	@TrustId INT
)
AS

BEGIN

	--Gather users Roles for user and current trust into temporary table
	DECLARE @RoleId VARCHAR(max)
	SELECT @RoleID = RoleID FROM ERS_Users where UserID = @UserId
	SELECT [item] AS RoleId, r.RoleName INTO #tmpRoles FROM dbo.fnSplitString(@RoleId,','), ERS_Roles r WHERE [item] = r.RoleId  AND (r.TrustId = @TrustId OR r.TrustId IS NULL)

	--Get User and Comma seperated list of role names
	SELECT [UserID]
      ,[ExpiresOn]
      ,[Username]
      ,[Title]
      ,[Forename]
      ,[Surname]
      ,[Initials]
      ,[Qualifications]
      ,u.[JobTitleID]
      ,[RoleID]
      ,CanRunAK
      ,[IsListConsultant]
      ,[IsEndoscopist1]
      ,[IsEndoscopist2]
      ,[IsAssistantOrTrainee]
      ,[IsNurse1]
      ,[IsNurse2]
      ,[ResetPassword]
      ,u.[Suppressed] 
      ,[ShowTooltips]     
      ,[GMCCode]
      ,[CanEditDropdowns]
      ,[CanViewAllUserAudits]
      ,ISNULL([GeneralLibrary],0) AS GeneralLibrary,
	  jt.Description AS JobTitle,
	(select substring((select ',' + convert(varchar(12),RoleName)
				  from #tmpRoles
				  order by CAST(RoleId AS NUMERIC(4,0)) asc
				  for xml path('')),2,70)) AS Permissions
	  ,CanOverBookLists
	FROM ERS_Users u
	LEFT JOIN ERS_JobTitles jt ON u.JobTitleID = jt.JobTitleID
	WHERE UserId = @UserId
END
GO

EXEC dbo.DropIfExist @ObjectName = 'insert_user',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[insert_user]
(
	@Username VARCHAR(100),
	@Title VARCHAR(10),
	@Forename VARCHAR(100),
	@Surname VARCHAR(100),
	@Qualifications VARCHAR(30),
	@IsGI BIT,
	@JobTitleId INT,
	@RoleID VARCHAR(70),
	@CanRunAK BIT,
	@CanViewAllUserAudits BIT,
	@IsListConsultant BIT,
	@IsEndoscopist1 BIT,
	@IsEndoscopist2 BIT,
	@IsAssistantOrTrainee BIT,
	@IsNurse1 BIT,
	@IsNurse2 BIT,
	@Suppressed BIT,
	@ExpiresOn DATETIME,
	@ShowTooltips BIT,
	@GMCCode VARCHAR(50),
	@CanEditDropdowns BIT,
	@CanOverbookLists BIT,
	@Password VARCHAR(200),
	@Initials VARCHAR(10),
	@GeneralLibrary BIT,
	@CanOverrideSchedule BIT,
	@LoggedInUserId int
)
AS
BEGIN
	INSERT INTO ERS_Users (RecordCreated, LastUpdated, ExpiresOn, Username, [Password], PasswordExpiresOn, Title, Forename, Surname, Initials, Qualifications, IsGIConsultant, JobTitleId, RoleID, CanRunAK, IsListConsultant, IsEndoscopist1, IsEndoscopist2, IsAssistantOrTrainee, IsNurse1, IsNurse2, ResetPassword, Suppressed, ShowTooltips, GMCCode, CanEditDropdowns, CanViewAllUserAudits, WhoCreatedId, WhenCreated, CanOverbookLists,GeneralLibrary, CanOverrideSchedule)
	VALUES (GETDATE(), GETDATE(), @ExpiresOn, @Username, @Password, GETDATE(), @Title, @Forename, @Surname, @Initials, @Qualifications, @IsGI, @JobTitleId, @RoleID, @CanRunAK, @IsListConsultant, @IsEndoscopist1, @IsEndoscopist2, @IsAssistantOrTrainee, @IsNurse1, @IsNurse2, 1, @Suppressed, @ShowTooltips, @GMCCode, @CanEditDropdowns, @CanViewAllUserAudits, @LoggedInUserId, GETDATE(), @CanOverbookLists, @GeneralLibrary, @CanOverrideSchedule)
	SELECT SCOPE_IDENTITY()
END
GO


EXEC dbo.DropIfExist @ObjectName = 'get_user_scheduler_permissions',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[get_user_scheduler_permissions]
(
	@UserId INT
)
AS

BEGIN

	SELECT CanOverbookLists
	FROM ERS_Users u
	WHERE UserId = @UserId

END

GO


EXEC dbo.DropIfExist @ObjectName = 'sch_get_cancelled_diary',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)

GO
CREATE PROCEDURE [dbo].[sch_get_cancelled_diary]
(
	@DiaryDate datetime
)
AS
	SELECT DISTINCT
		d.DiaryId,
		d.DiaryStart, 
		d.[DiaryEnd],
	    r.RoomName,
		( CASE WHEN   reason.Detail <> 'other' THEN reason.Detail  ELSE d.CancelComment END)  As Reason,
		d.Subject,
		(CASE WHEN  ISNULL(u.Title,'') <> '' THEN u.Title + ' ' ELSE '' END +
	    CASE WHEN  ISNULL(u.Forename,'') <> '' THEN u.Forename + ' ' ELSE '' END +
	    CASE WHEN  ISNULL(u.Surname,'') <> '' THEN u.Surname + ' ' ELSE '' END) as EndoscopistName,
	    (CASE WHEN  ISNULL(c.Title,'') <> '' THEN c.Title + ' ' ELSE '' END +
	    CASE WHEN  ISNULL(c.Forename,'') <> '' THEN c.Forename + ' ' ELSE '' END +
	    CASE WHEN  ISNULL(c.Surname,'') <> '' THEN c.Surname + ' ' ELSE '' END) as ListConsultant
	    FROM ERS_SCH_DiaryPages d
		  INNER JOIN ERS_Users u ON u.UserID = d.UserId 
		  LEFT JOIN ERS_Users c ON c.UserID = d.ListConsultantId 
		  LEFT JOIN ERS_ListCancelReasons reason ON reason.ListCancelReasonId = d.CancelReasonId
		  INNER JOIN dbo.ERS_SCH_Rooms r ON r.RoomId =  d.RoomID
	    WHERE convert(varchar(10), d.DiaryStart, 103) = convert(varchar(10),@DiaryDate, 103) AND d.Suppressed = 1

GO
 
EXEC dbo.DropIfExist @ObjectName = 'sch_get_cancelled_diary_details',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)

GO
CREATE PROCEDURE [dbo].[sch_get_cancelled_diary_details]
(
	@DiaryId VARCHAR(MAX)
)
AS
	SELECT DISTINCT
		d.DiaryId,
		Convert(varchar,d.DiaryStart,106) AS DiaryDate,
		d.DiaryStart,
		CASE WHEN (SELECT MAX(DATEADD(MINUTE, CONVERT(int, ersa.AppointmentDuration), StartDateTime)) FROM ERS_Appointments ersa WHERE ersa.DiaryId = d.DiaryId) >
		d.DiaryEnd THEN (SELECT MAX(DATEADD(MINUTE, CONVERT(int, ersa.AppointmentDuration), StartDateTime)) FROM ERS_Appointments ersa WHERE ersa.DiaryId = d.DiaryId)
		ELSE d.DiaryEnd END AS DiaryEnd,
		d.[DiaryEnd] ActualDiaryEnd,
		d.[UserID], 
		d.[RoomID], 
		d.ListRulesId, 
		s.SlotMinutes AS [Minutes],
		CASE WHEN ept.ProcedureType IS NULL THEN ss.Description 
		ELSE 'Reserved for ' + ss.Description + ' '+ ept.ProcedureType END AS [Subject],
		ss.Description,
		--ISNULL(s.ProcedureTypeID,0) AS ProcedureTypeID,
		ept.ProcedureType,
		s.ListSlotId,
	    ISNULL(s.Points, 1) AS Points,
		(CASE WHEN  ISNULL(users.Title,'') <> '' THEN users.Title + ' ' ELSE '' END +
	    CASE WHEN  ISNULL(users.Forename,'') <> '' THEN users.Forename + ' ' ELSE '' END +
	    CASE WHEN  ISNULL(users.Surname,'') <> '' THEN users.Surname + ' ' ELSE '' END) as CreatedBy,
		(CASE WHEN  ISNULL(us.Title,'') <> '' THEN us.Title + ' ' ELSE '' END +
	    CASE WHEN  ISNULL(us.Forename,'') <> '' THEN us.Forename + ' ' ELSE '' END +
	    CASE WHEN  ISNULL(us.Surname,'') <> '' THEN us.Surname + ' ' ELSE '' END) as CancelledBy,
		(CASE WHEN  ISNULL(u.Title,'') <> '' THEN u.Title + ' ' ELSE '' END +
	    CASE WHEN  ISNULL(u.Forename,'') <> '' THEN u.Forename + ' ' ELSE '' END +
	    CASE WHEN  ISNULL(u.Surname,'') <> '' THEN u.Surname + ' ' ELSE '' END) as EndoscopistName,
	    (CASE WHEN  ISNULL(c.Title,'') <> '' THEN c.Title + ' ' ELSE '' END +
	    CASE WHEN  ISNULL(c.Forename,'') <> '' THEN c.Forename + ' ' ELSE '' END +
	    CASE WHEN  ISNULL(c.Surname,'') <> '' THEN c.Surname + ' ' ELSE '' END) as ListConsultant,
		l.ListName,
		(CASE WHEN  ISNULL(u.Title,'') <> '' THEN u.Title + ' ' ELSE '' END +
	    CASE WHEN  ISNULL(u.Forename,'') <> '' THEN u.Forename + ' ' ELSE '' END +
	    CASE WHEN  ISNULL(u.Surname,'') <> '' THEN u.Surname + ' ' ELSE '' END) +
	    '  [' + CONVERT(VARCHAR(5),cast(d.DiaryStart as time)) + '-' + CONVERT(VARCHAR(5),cast(d.[DiaryEnd] as time)) + ']' +
	    CASE WHEN  ISNULL(l.Points,0) <> 0 THEN '  [' + CONVERT(VARCHAR, l.Points) + ' slots]' ELSE '' END  AS ListDescription
		,d.suppressed
		, FORMAT(d.SuppressedFromDate, 'MMM d yyyy h:mm') AS  SuppressedFromDate
		,FORMAT(d.WhenCreated, 'MMM d yyyy h:mm') AS  WhenCreated 
		,d.Training
		,l.GIProcedure
		,hos.HospitalName
	    ,( CASE WHEN   reason.Detail <> 'other' THEN reason.Detail  ELSE d.CancelComment END)  As CancelReason
		,r.RoomName
	FROM ERS_SCH_DiaryPages d
	--	INNER JOIN #tmpDiaryRooms tr ON tr.Item = d.RoomID
		INNER JOIN dbo.ERS_SCH_Rooms r ON r.RoomId =  d.RoomID
		INNER JOIN ERS_SCH_ListRules l ON l.ListRulesId = d.ListRulesId
		INNER JOIN ERS_SCH_ListSlots s ON d.ListRulesId = s.ListRulesId AND s.Active = 1
		INNER JOIN dbo.ERS_SCH_SlotStatus ss ON ss.StatusId = s.SlotId
		LEFT JOIN dbo.ERS_ProcedureTypes ept ON s.ProceduretypeId = ept.ProcedureTypeId
		LEFT JOIN ERS_Users u ON u.UserID = d.UserId
		LEFT JOIN ERS_Users c ON c.UserID = d.ListConsultantId
		LEFT JOIN ERS_Users users ON users.UserID = d.WhoCreatedId
		LEFT JOIN ERS_OperatingHospitals hos ON hos.OperatingHospitalId = d.OperatingHospitalId
	    LEFT JOIN ERS_Users us ON us.UserID = d.SuppressedBy
		LEFT JOIN ERS_ListCancelReasons reason ON reason.ListCancelReasonId = d.CancelReasonId
	WHERE
	d.DiaryId = @DiaryId
ORDER BY d.DiaryId, s.ListSlotId

GO

EXEC dbo.DropIfExist @ObjectName = 'sch_diary_page_delete',    
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[sch_diary_page_delete]
(
	@DiaryId INT, 
	@CancelReasonId Int, 
	@CancelComment VARCHAR(100), -- other text
	@CancelledBy INT,
	@Suppressed Bit
)
AS
      UPDATE ERS_SCH_DiaryPages SET Suppressed = @Suppressed ,  CancelReasonId = @CancelReasonId ,  CancelComment = @CancelComment , SuppressedBy = @CancelledBy ,SuppressedFromDate = GETDATE()
	  WHERE DiaryId = @DiaryId

GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	3181, 3248
------------------------------------------------------------------------------------------------------------------------
GO
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea
-- TFS#	23.5.24
-- Description of change
-- Exclude unnecessary procedures from returning a jmanovure value
------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 04.07.24
-- TFS#
-- Description of change
-- Corrected the location of Chromendoscopy other value
------------------------------------------------------------------------------------------------------------------------
GO



ALTER PROCEDURE [dbo].[usp_NED_Generate_Report]
(
		@ProcedureId AS INT
)
AS
BEGIN
	SET NOCOUNT ON;

/*
	<xs:schema xmlns="https://www.jets.nhs.uk/schema/hospital.sendbatchmessage-version2.xsd" 
	xmlns:mstns="https://www.jets.nhs.uk/schema/hospital.sendbatchmessage-version2.xsd" 
	xmlns:xs="http://www.w3.org/2001/XMLSchema" 
	targetNamespace="https://www.jets.nhs.uk/schema/hospital.sendbatchmessage-version2.xsd" 
	elementFormDefault="qualified" id="SendBatchMessageFile">		

*/
Declare @site AS VARCHAR(50);
DECLARE 
		@description	AS VARCHAR(1000),
		@uniqueid		AS VARCHAR(15),
		@previousLocalProcedureId AS VARCHAR(15),
		@PatientId		AS INT,
		@sessionType	AS VARCHAR(50),
		@operatingHospitalId AS INT,
		@ProcedureTypeId AS INT,
		@ExportFolderPath AS VARCHAR(100);	--## XML Export Folder path.. Set by Admin in the [ERS_SystemConfig] Table

DECLARE @returnXML XML;

	Set @description = 'NED List';
	SELECT @operatingHospitalId = OperatingHospitalId FROM ERS_Procedures WHERE ProcedureId = @ProcedureId;
	SELECT @site = [NED_HospitalSiteCode], @ExportFolderPath=[NED_ExportPath] FROM [dbo].[ERS_SystemConfig] WHERE OperatingHospitalId = @operatingHospitalId;

	SELECT @ProcedureTypeId = ProcedureType,
		   @uniqueid = RIGHT(('00000' + CAST(@ProcedureId AS VARCHAR(6))),6) --## Procedure Id
							+ RIGHT(('0' + CAST(ProcedureType AS VARCHAR(2))),2)  --## Procedure Type; ie: OGD=1/ERCP=2/COLON=3/FLEXI=13
								+ (CASE ProcedureType	WHEN  1 THEN 'o' 
														WHEN  2 THEN 'e'
														WHEN  4 THEN 's' 
														WHEN  3 THEN 'c'
														WHEN  6 THEN 'u'
														WHEN  7 THEN 'u'
														WHEN  8 THEN 'n'
														WHEN  9 THEN 't'
									END)	--## Procedure Letter
		 , @sessionType=Case ListType	When 1 Then 'Service List' 
										When 2 Then 'Adhoc Training List' 
											   Else 'Dedicated Training List' End 
		, @PatientId = PatientId
	From dbo.ERS_Procedures Where ProcedureId=@ProcedureId;


	--## UniqueId is generated- so UPDATE this new value now in the ERS_Procedures Table
	UPDATE dbo.ERS_Procedures
	SET [NEDProcedureId] = @uniqueid
	WHERE ProcedureId=@ProcedureId;

	--## Now get the Previous NED Unique Id- of the same Patient... We know the Patient Id already! Use it!!
	SELECT @previousLocalProcedureId = IsNull([NEDProcedureId], '') 
			 FROM dbo.ERS_Procedures 
			WHERE PatientId = @PatientId AND ProcedureId<@ProcedureId
		 ORDER BY ProcedureID DESC;

	print '@uniqueid: ' + @uniqueid;

SET @returnXML=(
SELECT 
	  @uniqueid											AS '@uniqueId'
	, @description										AS '@description'
	, REPLACE(convert(varchar, p.CreatedOn, 106), ' ', '/')	AS '@date'	--### '10 Oct 2020' ==> '10/Oct/2020'
	, P.ProcedureTime AS '@time'
	, @sessionType										AS '@type'	-- SessionTypeEnum
	, @site												AS '@site'	--## Hospital Code

	/*	##### Procedure info	*/
	, (
	Select 
		  @uniqueid										AS '@localProcedureId'
		, @previousLocalProcedureId						AS '@previousLocalProcedureId'
		, (CASE P.ProcedureType WHEN 1 THEN 'OGD' 
								WHEN 2 THEN 'ERCP' 
								WHEN 3 THEN 'COLON' 
								WHEN 4 THEN 'FLEXI' 
								WHEN 6 THEN 'EUS' 
								WHEN 7 THEN 'EUS' 
								WHEN 8 THEN 'ENT' 
								WHEN 9 THEN 'ENT' 
		   END) AS '@procedureName'
		, Dis.NEDTerm AS '@procedureDiscomfort'	
		, PPDD.NEDTerm AS '@postProcedureDiscomfort' -- **************************** TO DO *********************************
		, dbo.fnNED_ProcedureExtent(@ProcedureId, 0) AS '@extent'	--## OverAll Extent info - EE/ER- whoever has gone Furthest distance!!
		, (CASE WHEN Drug.entonox IS NULL THEN 'No' ELSE 'Yes' END) AS '@entonox'
		, CASE WHEN ISNULL((Select DrugNo from ERS_UpperGIPremedication where ProcedureId = @ProcedureID and DrugNo = -2), 0) = -2 THEN 'Yes' ELSE 'No' END AS '@generalAnaes'
		, convert(varchar, P.StartDateTime, 126) AS '@procedureStartTime'
		, convert(varchar, P.EndDateTime, 126) AS '@procedureEndTime'
		, Ins.NEDTerm AS '@insufflation' 
		, PS.NEDTerm AS '@providerSector'
		, RT.NEDTerm AS '@referrer'
		, CASE WHEN isnull(P.ReferrerTypeOther, '') = '' THEN NULL ELSE P.ReferrerTypeOther END AS '@referrerOther' -- ***************** Only if referrer is 'Other' *******************************
		, PO.NEDTerm AS '@providerOrganisation' 
		, CASE WHEN isnull(P.ProviderOther, '') = '' THEN NULL ELSE P.ProviderOther END AS '@providerOrganisationOther' -- **************** Only if providerOrganisation is 'Other' *************************
		, CASE WHEN P.ChecklistComplete = 0 THEN 'No' ELSE 'Yes' END AS '@checklist' 
		, CASE WHEN PatStat.ListItemText = 'Day patient' THEN 'Inpatient' ELSE PatStat.ListItemText END AS '@admissionType'
		, Urgency.Description AS '@urgencyType' 
		, Ext.NEDTerm AS '@plannedExtent'
		, ISNULL(AIS.NEDTerm, 'None')  AS '@artificialintelligence'
		, CASE WHEN AIS.NEDTerm = 'Other' THEN PAIS.AISoftwareOther ELSE NULL END AS '@artificialintelligenceOther' -- **************** Only if artificialintelligence is 'Other' *************************
		, CASE WHEN PAIS.AISoftwareName IS NULL OR AIS.NEDTerm = 'None' THEN NULL ELSE PAIS.AISoftwareName END AS '@nameOfAISoftware' -- **************** Only if artificialintelligence is NOT 'None' *************************
		, CASE WHEN CHARINDEX('.00',P.Points,0) > 0 THEN convert(varchar(10), convert(int, P.Points)) ELSE convert(varchar(10), P.Points) END AS '@procedurePoints'


		/*	##### Patient Info	*/		
		, (CASE Pat.Gender WHEN 'Not Known' THEN 'Other' WHEN 'Not Specif' THEN 'Other' ELSE Pat.Gender END)		AS 'patient/@gender'
		, (0+ FORMAT(getdate(),'yyyyMMdd') - FORMAT(Pat.DateOfBirth,'yyyyMMdd') ) /10000 AS 'patient/@age'


		/*	##### Drugs	*/
		, CASE WHEN CHARINDEX('.00',IsNull(Drug.pethidine,0),0) > 0 THEN convert(varchar(10), convert(int,IsNull(Drug.pethidine,0))) ELSE CONVERT(varchar(10),IsNull(Drug.pethidine,0)) END	As 'drugs/@pethidine'	--## Required
		, CASE WHEN CHARINDEX('.00',IsNull(Drug.midazolam,0),0) > 0 THEN convert(varchar(10), convert(int,IsNull(Drug.midazolam,0))) ELSE CONVERT(varchar(10),IsNull(Drug.midazolam,0)) END	As 'drugs/@midazolam'	--## Required
		, CASE WHEN CHARINDEX('.00',IsNull(Drug.fentanyl,0),0) > 0 THEN convert(varchar(10), convert(int,IsNull(Drug.fentanyl,0))) ELSE CONVERT(varchar(10),IsNull(Drug.fentanyl,0))	END As 'drugs/@fentanyl'	--## Required
		, CASE WHEN CHARINDEX('.00',IsNull(Drug.buscopan,0),0) > 0 THEN convert(varchar(10), convert(int,IsNull(Drug.buscopan,0))) ELSE CONVERT(varchar(10),IsNull(Drug.buscopan,0))	END As 'drugs/@buscopan'	--## Required
		, CASE WHEN CHARINDEX('.00',IsNull(Drug.remimazolam,0),0) > 0 THEN convert(varchar(10), convert(int,IsNull(Drug.remimazolam,0))) ELSE CONVERT(varchar(10),IsNull(Drug.remimazolam,0))	END As 'drugs/@remimazolam'	--## Required
		, CASE WHEN IsNull(Drug.propofol, 0) = 0 THEN 'No' ELSE	'Yes' END			As 'drugs/@propofol'	--## YesNo
		, ISNULL(Drug.noDrugsAdministered, 'Yes')	As 'drugs/@noDrugsAdministered'


		/*	##### Staff.Members: 1 Procedure to MANY staff.. So - need a SQL Subquery- to return a RecordSet		*/
		,(
			SELECT 
			  Staff.professionalBodyCode AS '@professionalBodyCode'
			, Staff.EndoscopistRole		AS '@endoscopistRole'
			, Staff.ProcedureRole		AS '@procedureRole'	-- ProcedureRoleTypeEnum
			, Staff.Extent				AS '@extent'
			, CASE WHEN @ProcedureTypeId IN (1,3,4) THEN CASE Staff.[jManoeuvre] WHEN 1 THEN 'Yes' WHEN 0 THEN 'No' ELSE NULL END END	AS '@jManoeuvre'	-- Opt -- Mandatory for OGD, Colon and Flexi procedures (Rectal retroversion)
			/*	##### Therapeutic = Sesion->Procedure-> Staff.members-> Staff-> Therapeutic; 1 [Staff] to Many [Therapeutic sessions]	*/
			, (
				Select * from (select 
					   T.NedName	AS '@type'	-- M	--## The type of therapeutic procedure.
					 , CASE WHEN rc.RegionId IS NULL THEN T.[Site] ELSE 'Anastomosis' END		AS '@site'	-- O -- BiopsyEnum  --## The location where the therapeutic procedure was performed.
					 , ISNULL(T.EndoRole, Staff.ProcedureRole) AS '@role' -- O	-- ProcedureRoleTypeEnum
					 , T.polypSize	AS '@polypSize' -- O	-- PolypSizeEnum --## The size of polyp (if found) -> is ONLY for COLON/FLEXI
					 , T.PolypSizeInt AS '@polypSizeInteger'  
					 , T.Detected AS '@observed' 
					 , T.Tattooed	AS '@tattooed'	-- O	-- TattooEnum
					 , sum(T.Performed)	AS '@performed'	-- M	-- REQUIRED; INT	-- ## Number performed
					 , sum(T.Successful)	AS '@successful' -- M	-- REQUIRED; INT -- Number of successful
					 , sum(T.Retrieved)	AS '@retrieved'	-- O	-- INT	-- ## Number of Polyp retrieved -> is ONLY for COLON/FLEXI
					 , T.comment 	AS '@comment'	-- O	--## Use this field to define what “Other” is when selected.
					 , T.Morphology AS '@morphology' -- **************************** TO DO *********************************

				FROM dbo.tvfNED_ProcedureTherapeutic(P.ProcedureType, @ProcedureId, Staff.ConsultantTypeId) AS T --## Which Consultant's Record in the Procedure?
					LEFT JOIN dbo.ERS_Sites ES ON es.SiteId = T.SiteId
					LEFT JOIN tvfProcedureResectedColon(@ProcedureId) RC ON RC.RegionId = ES.RegionId
				group by T.SiteId,T.NedName, 
						CASE WHEN rc.RegionId IS NULL THEN T.[Site] ELSE 'Anastomosis' END,
						T.EndoRole,
						T.polypSize,
						T.PolypSizeInt,
						T.Detected,
						T.Tattooed, 
						T.comment,
						T.Morphology) as a
				FOR XML PATH('therapeutic'), ROOT('therapeutics'), TYPE
			)/* End of: Therapeutic List- for a Staff Member		*/
			FROM dbo.tvfNED_ProcedureConsultants(@ProcedureId, P.ProcedureType) AS Staff
			WHERE Staff.EndosId > 0
			FOR XML PATH('Staff'), ROOT('staff.members'), TYPE
		)
			/*	##### Indications: -- 1 or Many	*/		
			, (
				SELECT 
					  dbo.HTMLDecode(I.NedTerm) As '@indication'
					, I.Comment AS '@comment'
					, I.elevatedCalprotectinValue AS '@elevatedCalprotectinValue' -- When indication is Elevated calprotectin then specify the value in (micrograms/gram)
					FROM dbo.tvfNED_ProcedureIndication(@ProcedureId) AS I
					FOR XML PATH('indication'), ROOT('indications'), TYPE
			)
			/*	##### subIndications: -- 0 or Many	*/	
			, (
				SELECT 
					  I.NedTerm As '@type'
					, I.Comment AS '@comment'
					FROM dbo.tvfNED_ProcedureSubIndication(@ProcedureId) AS I
					FOR XML PATH('subIndication'), ROOT('subIndications'), TYPE
			)
			
			/*	##### Limitations: */
			,(
				Select 	
					  L.Limitation As '@limitation'
					, L.Comment As '@comment'
				from [dbo].[tvfNED_ProcedureLimitation](P.ProcedureType, @ProcedureId) AS L
					FOR XML PATH('limitation'), ROOT('limitations'), TYPE
			)	

			/*	##### Biopsy: 0 or Many		*/ --## For Colon/Flexi/OGD
			, (	SELECT 
						  B.BiopsySite		AS '@biopsySite'
						, B.NumberPerformed AS '@numberPerformed'
					FROM [dbo].[tvfNED_ProcedureBiopsy](p.ProcedureType, @ProcedureId) AS B				
					 FOR XML PATH('biopsy'), ROOT('biopsies'), TYPE
			)
			/*	##### Diagnoses: 1 or Many		*/ 
			, (	SELECT 
						  D.Ned_Name	AS '@diagnosis'
						, D.tattooed	AS '@tattooed'
						, CASE WHEN RIGHT(D.Site,2) = ', '
							THEN (LEFT(D.Site, LEN(D.Site)-1))
							ELSE  D.Site END		AS '@site'
						, CASE WHEN RIGHT(D.Comment,2)=', ' 
							THEN (LEFT(D.Comment, LEN(D.Comment)-1)) 
							ELSE D.Comment END
									AS '@comment'	--## Remove the extra ',' at the end!
						,D.barrettsLengthCircumferential as '@barrettsLengthCircumferential' --Required for diagnosis of Barretts
						,D.barrettsLengthMaximum AS '@barrettsLengthMaximum'--, barrettsLengthMaximum --Required for diagnosis of Barretts
						,D.barretsInspectionTime AS '@barretsInspectionTime'--, barretsInspectionTime --Required for diagnosis of Barretts
						,D.gastricInspectiontime AS '@gastricInspectionTime'--, gastricInspectiontime --Required if diagnosis of gastric atrophy OR gastric intestinal metaplasia
						,D.oesophagitisLaClassification AS '@oesophagitisLAClassification'--, oesophagitisLaClassification --Required if diagnosis of Oesophagitis - reflux
						,D.DICAScore AS '@DICAScore'--, DICAScore --required if diagnosis of Diverticulosis
						,D.UCEIS AS '@UCEIS'--, UCEIS --If diagnosis is ‘Ulcerative Colitis’ either UCEIS or Mayo scores must be provided
						,D.mayoScore AS '@mayoScore'--, mayoScore --If diagnosis is ‘Ulcerative Colitis’ either UCEIS or Mayo scores must be provided
						--, site --If diagnosis is ‘Crohns Colitis’ or ‘Crohn`s- terminal ileum’ and [ExtentLookup]= ‘Neo-terminal ileum’
						,NULLIF(RutgeertsScore,'') AS '@rutgeertsScore' --If diagnosis is ‘Crohns Colitis’ or ‘Crohn`s- terminal ileum’ and [ExtentLookup]= ‘Neo-terminal ileum’
						, CDEIS AS '@CDEIS' --If diagnosis is ‘Crohns Colitis’ or ‘Crohn`s- terminal ileum’
					FROM [dbo].[tvfNED_Diagnoses](p.ProcedureType, @ProcedureId) AS D
					 FOR XML PATH('diagnose'), ROOT('diagnoses'), TYPE
			)
			/*	##### Adverse events: -- 1 or Many	*/
			,(	SELECT 
					  IsNull(AD.adverseEvent,'None')	As '@adverseEvent'
					, (CASE WHEN AD.adverseEvent = 'Other' THEN AD.Comment END) 						As '@comment'
				FROM dbo.tvfNED_ProcedureAdverseEvents(@ProcedureId)		AS AD
				FOR XML PATH('adverse.event'), ROOT('adverse.events'), TYPE			
			)
			, ( Select * from (Select isnull(scog.NEDTerm, 'other') as '@manufacturerGeneration'
						, CASE WHEN scog.NEDTerm IS NULL THEN scog.Description ELSE NULL END as '@other'
				from ERS_Scopes sco
				join ERS_Procedures p on p.Instrument1 = sco.ScopeId
				join ERS_ScopeGenerations scog on sco.ScopeGenerationId = scog.UniqueId
				where p.ProcedureId = @ProcedureId
				union
				Select isnull(scog.NEDTerm, 'other') as '@manufacturerGeneration'
						, CASE WHEN scog.NEDTerm IS NULL THEN scog.Description ELSE NULL END as '@other'
				from ERS_Scopes sco
				join ERS_Procedures p on p.Instrument2 = sco.ScopeId
				join ERS_ScopeGenerations scog on sco.ScopeGenerationId = scog.UniqueId
				where p.ProcedureId = @ProcedureId) as a
				FOR XML PATH('scopes'), ROOT('scopes'), TYPE
			   )
			 , (
				SELECT ISNULL(C.NEDTerm, 'None') AS '@type', 
				(CASE WHEN C.NEDTerm = 'Other' THEN C.Description END) 						AS '@comment'

				 FROM ERS_Procedures p
				 LEFT JOIN ERS_ProcedureChromendosopy PC ON p.ProcedureId= PC.ProcedureId
				 LEFT JOIN ERS_Chromendoscopies C ON C.UniqueId = PC.ChromendoscopyId
				 WHERE P.ProcedureId = @ProcedureId 
				 FOR XML PATH('chromendoscopy'), ROOT('chromendoscopies'), TYPE
				)  
				 ,( 
					SELECT CASE 
						WHEN @ProcedureTypeId = 1 THEN
							(SELECT DISTINCT * FROM (SELECT 
								CASE WHEN (SELECT COUNT(*) FROM ERS_UpperGIPremedication WHERE DrugName = 'Pharyngeal Anaesthesia' AND ProcedureId = @ProcedureId) = 1 THEN 'Yes' ELSE 'No' END as '@pharyngealAnaes'
								,pe.WithdrawalMins as '@scopeWithdrawalTime'
								,ISNULL(DA.NEDTerm,'None') as '@distalAttachment'
								,CASE WHEN LOWER(DA.NEDTerm) = 'other' THEN PD.AdditionalInfo ELSE NULL END as '@distalAttachmentOther'
								,CASE WHEN p.Transnasal = 1 THEN 'Nasal' ELSE 'Oral' END as '@OGDRoute'
								,V.NEDTerm as '@OGDMucosalVisualisation'
								,CASE WHEN (SELECT COUNT(*) FROM ERS_ProcedureMucosalCleaning WHERE ProcedureId = @ProcedureId) > 1 THEN 'Other' ELSE ISNULL(C.NEDTerm, 'None') END as '@OGDMucosalCleaning'
								,CASE WHEN (SELECT COUNT(*) FROM ERS_ProcedureMucosalCleaning WHERE ProcedureId = @ProcedureId) > 1 THEN dbo.fnNED_MucosalCleaning(@ProcedureId) WHEN LOWER(C.NEDTerm) = 'other' THEN C.Description ELSE NULL END as '@OGDMucosalCleaningOther'
								,CASE WHEN P.FormerProcedureId IS NOT NULL THEN 'Yes' WHEN (SELECT COUNT(*) FROM ERS_Procedures pq WHERE pq.FormerProcedureId = p.ProcedureId) > 0 THEN 'Yes' ELSE 'No' END as '@dualProcedure'
								,CASE WHEN dbo.fnNED_GetOGDPhotoDocumentation(@ProcedureId) = 1 THEN 'Yes' ELSE 'No' END '@photoDocumentation'
								from ERS_Procedures AS P 
									LEFT JOIN ERS_ProcedureMucosalVisualisation PV ON PV.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_MucosalVisualisation V ON V.UniqueId = PV.MucosalVisualisationId
									LEFT JOIN ERS_ProcedureUpperExtent PE ON PE.ProcedureId = P.ProcedureId AND PE.WithdrawalMins IS NOT NULL /*there may be more than 1 record in the table where there's 2 endos on a procedure*/
									LEFT JOIN ERS_ProcedureDistalAttachment PD ON PD.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_DistalAttachments DA ON DA.UniqueId = PD.DistalAttachmentId
									LEFT JOIN ERS_ProcedureMucosalCleaning PC ON PC.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_MucosalCleaning C ON C.UniqueId = PC.MucosalCleaningId
								Where P.ProcedureId=@ProcedureId) ogd
							FOR XML PATH('OGD'),TYPE)
						WHEN @ProcedureTypeId = 2 THEN
							(SELECT * FROM (SELECT DISTINCT 
								CASE WHEN (SELECT COUNT(*) FROM ERS_UpperGIPremedication WHERE DrugName = 'Pharyngeal Anaesthesia' AND ProcedureId = @ProcedureId) = 1 THEN 'Yes' ELSE 'No' END as '@pharyngealAnaes'
								,CASE WHEN (SELECT COUNT(*) FROM ERS_UpperGIPremedication WHERE DrugName = 'Prophylactic Antibiotics' AND ProcedureId = @ProcedureId) = 1 THEN 'Yes' ELSE 'No' END as '@antibioticGiven'
								,NULLIF(CASE WHEN ((ev.IntendedBileDuct = 1 AND ev.MajorPapillaBile = 1) OR (ev.IntendedBileDuct_ER = 1 AND ev.MajorPapillaBile_ER = 1)) OR
												  ((ev.IntendedPancreaticDuct = 1 AND ev.MajorPapillaPancreatic = 1) OR (ev.IntendedPancreaticDuct_ER = 1 AND ev.MajorPapillaPancreatic_ER = 1)) THEN 'Yes' 
											 WHEN ((ev.IntendedBileDuct = 1 AND ev.MajorPapillaBile <> 1) OR (ev.IntendedBileDuct_ER = 1 AND ev.MajorPapillaBile_ER <> 1)) OR
												  ((ev.IntendedPancreaticDuct = 1 AND ev.MajorPapillaPancreatic <> 1) OR (ev.IntendedPancreaticDuct_ER = 1 AND ev.MajorPapillaPancreatic_ER <> 1)) THEN 'No'
											ELSE 'Not Applicable' END,'') as '@successfulCannulation'
								,ISNULL((SELECT MAX(ISNULL(convert(int, d.StonesSize),0)) FROM ERS_ERCPAbnoDuct d INNER JOIN ERS_Sites s ON S.SiteId = d.SiteId WHERE S.ProcedureId = @ProcedureId),0) AS '@sizeLargestStone'
								--,ISNULL(CASE WHEN ExtractionOutcome = 1 THEN CONVERT(varchar(max),'Yes') 
								--       WHEN ExtractionOutcome <> 0 THEN CONVERT(varchar(max),'No') END,'Not Applicable') AS '@completeStoneClearance'
								,ISNULL((SELECT TOP 1 CASE WHEN ISNULL(ExtractionOutcome,0) = 1 THEN convert(varchar(max),'Yes') 
											  WHEN StoneRemoval = 0 or ExtractionOutcome <> 1 THEN 'No' END 
								 FROM dbo.ERS_ERCPTherapeutics ET WHERE SiteId IN (SELECT SiteId FROM ERS_Sites WHERE ProcedureId = @ProcedureId)),'Not Applicable') as '@completeStoneClearance'
								,ISNULL((SELECT CASE WHEN LOWER(Region) LIKE '%hepatic%' THEN convert(varchar(max), 'Yes') ELSE convert(varchar(max), 'No') END
											FROM ERS_ERCPAbnoDuct eed 
											INNER JOIN dbo.ERS_Sites es ON eed.SiteId = es.SiteId
												INNER JOIN dbo.ERS_Regions er ON es.RegionId = er.RegionId
											WHERE es.ProcedureId = @ProcedureId AND Stricture = 1),convert(varchar(max), 'Not Applicable')) AS '@extraHepaticStricture'
								,ISNULL((SELECT CASE WHEN eed.Stricture = 1 AND eug.BrushCytology = 1 THEN convert(varchar(max),'Yes') WHEN eed.Stricture = 1 AND eug.BrushCytology = 0 THEN convert(varchar(max),'No') WHEN eed.Stricture = 0 THEN 'Not Applicable' END 
										 FROM ERS_ERCPAbnoDuct eed 
												INNER JOIN dbo.ERS_Sites es ON eed.SiteId = es.SiteId
												INNER JOIN dbo.ERS_Regions er ON es.RegionId = er.RegionId
												INNER JOIN dbo.ERS_UpperGISpecimens eug ON es.SiteId = eug.SiteId
											WHERE es.ProcedureId = @ProcedureId AND
												LOWER(Region) LIKE '%hepatic%'),convert(varchar(max),'Not Applicable')) AS '@extrahepaticStrictureCytologyHistologyTaken'
								,ISNULL((SELECT CASE WHEN eug.CorrectStentPlacement = 1 OR ert.CorrectStentPlacement = 1 THEN convert(varchar(max),'Yes') ELSE convert(varchar(max),'No') END
											FROM ERS_ERCPAbnoDuct eed 
												INNER JOIN dbo.ERS_Sites es ON eed.SiteId = es.SiteId
												INNER JOIN dbo.ERS_Regions er ON es.RegionId = er.RegionId
												LEFT JOIN dbo.ERS_UpperGITherapeutics eug ON es.SiteId = eug.SiteId
												LEFT JOIN dbo.ERS_ERCPTherapeutics ert ON es.SiteId = ert.SiteId
											WHERE es.ProcedureId = @ProcedureId AND eed.Stricture = 1 AND eug.StentInsertion = 1 AND
												LOWER(Region) LIKE '%hepatic%'),convert(varchar(max),'Not Applicable')) AS '@extrahepaticStrictureStentSuccessfullyPlaced'
								,CASE WHEN ISNULL(eea.MajorBilrothRoux,0) = 1 THEN 'Yes' ELSE 'No' END AS '@previousSurgeryBilrothRoux'
								,NULLIF(lc.NEDTerm,0) AS '@levelOfComplexity'
								,CASE WHEN (SELECT COUNT(*) FROM ERS_UpperGIPremedication WHERE DrugName = 'Prophylactic Rectal NSAIDS' AND ProcedureId = @ProcedureId) = 1 THEN 'Yes' ELSE 'No' END as '@prophylacticRectalNSAIDS'
								,CASE WHEN eea.MinorSiteLocation IN (1,2) THEN 'No' ELSE 'Yes' END AS '@nativePapilla'
								from ERS_Procedures AS P 
									LEFT JOIN (SELECT eed.AbnoDuctId, es.ProcedureId, eed.Stricture, er.Region 
												FROM ERS_ERCPAbnoDuct eed 
													INNER JOIN dbo.ERS_Sites es ON eed.SiteId = es.SiteId
													INNER JOIN dbo.ERS_Regions er ON es.RegionId = er.RegionId
											WHERE es.ProcedureId = @ProcedureId AND
												LOWER(Region) LIKE '%hepatic%')  ercs ON ercs.ProcedureId = P.ProcedureId
									LEFT JOIN (SELECT Stones, ISNULL(t.ExtractionOutcome,0) ExtractionOutcome, es.ProcedureId 
												FROM ERS_ERCPAbnoDuct a
													 INNER JOIN dbo.ERS_Sites es ON a.SiteId = es.SiteId
													 LEFT JOIN ERS_ERCPTherapeutics t ON t.siteId = a.SiteId
												 WHERE a.Stones = 1) estones ON estones.ProcedureId = P.ProcedureId
									LEFT JOIN dbo.ERS_ERCPPapillaryAnatomy eea ON P.ProcedureId = eea.ProcedureId
									LEFT JOIN dbo.ERS_Visualisation ev ON P.ProcedureId = ev.ProcedureID
									LEFT JOIN dbo.ERS_ProcedureLevelOfComplexity cl ON cl.ProcedureId = P.ProcedureId
									LEFT JOIN dbo.ERS_LevelOfComplexity lc ON lc.UniqueId = cl.ComplexityId
								Where P.ProcedureId=@ProcedureId) ercp
							FOR XML PATH('ERCP'),TYPE) 
						WHEN @ProcedureTypeId = 3 THEN
							(SELECT TOP 1 * FROM (SELECT 
								(SELECT ISNULL(SUM(Detected),0) FROM tvfNED_PolypsDetailsView(@ProcedureTypeId, @ProcedureId)) as '@polypsDetected'
								,CASE WHEN p.ScopeGuide = 1 THEN 'Yes' ELSE 'No' END AS '@magneticEndoscopeImagerUsed'
								,LE.WithdrawalMins AS '@scopeWithdrawalTime'
								,CASE WHEN LE.RectalExamPerformed = 1 THEN 'Yes' ELSE 'No' END AS '@digitalRectalExamination'
								,CONVERT(VARCHAR(19),LE.CaecumIntubationStart, 126) AS '@caecumTime'
								,ISNULL(DA.NEDTerm,'None') as '@distalAttachment'
								,NULLIF(CASE WHEN LOWER(DA.NEDTerm) = 'other' THEN PD.AdditionalInfo ELSE '' END,'') as '@distalAttachmentOther'
								,IT.NEDTerm as '@insertionTechnique'
								,PB.LeftPrepScore as '@bowelPrepLeft'
								,PB.RightPrepScore as '@bowelPrepRight'
								,PB.TransversePrepScore as '@bowelPrepTransverse'
								,PB.TotalPrepScore as '@bowelPrepTotal'
								,ISNULL(B.NEDTerm,'None') as '@bowelPrep'
								,NULLIF(CASE WHEN LOWER(B.NEDTerm) = 'other' THEN B.[Description] ELSE '' END,'') as '@bowelPrepOther'
								,CASE WHEN P.FormerProcedureId IS NOT NULL THEN 'Yes' WHEN (SELECT COUNT(*) FROM ERS_Procedures pq WHERE pq.FormerProcedureId = p.ProcedureId) > 0 THEN 'Yes' ELSE 'No' END as '@dualProcedure'
								,CASE WHEN NULLIF(fit.FITValue,'') IS NOT NULL THEN fit.FITValue END AS '@fitValue'
								,CASE WHEN fit.FITNotKnownId IS NOT NULL THEN fnk.NEDTerm END AS '@fitNotKnown'
								FROM ERS_Procedures AS P 
									LEFT JOIN ERS_ProcedureLowerExtent LE ON LE.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_ProcedureDistalAttachment PD ON PD.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_DistalAttachments DA ON DA.UniqueId = PD.DistalAttachmentId
									LEFT JOIN ERS_ProcedureInsertionTechnique PIT ON PIT.ProcedureId = p.ProcedureId
									LEFT JOIN ERS_InsertionTechniques IT ON IT.UniqueId = PIT.InsertionTechniqueId
									LEFT JOIN ERS_ProcedureBowelPrep PB ON PB.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_BowelPrep B ON B.UniqueId = PB.BowelPrepId
									LEFT JOIN ERS_ProcedureFITValue fit ON fit.ProcedureId = p.ProcedureId
									LEFT JOIN ERS_FitNotKnownReasons fnk ON fnk.UniqueId = fit.FITNotKnownId
								Where P.ProcedureId=@ProcedureId) col
							FOR XML PATH('Colon'),TYPE)
						WHEN @ProcedureTypeId = 4 THEN
							(SELECT * FROM (SELECT 
								(SELECT ISNULL(SUM(Detected),0) FROM tvfNED_PolypsDetailsView(@ProcedureTypeId, @ProcedureId)) as '@polypsDetected'
								,CASE WHEN LE.RectalExamPerformed = 1 THEN 'Yes' ELSE 'No' END AS '@digitalRectalExamination'
								,CASE WHEN p.ScopeGuide = 1 THEN 'Yes' ELSE 'No' END AS '@magneticEndoscopeImagerUsed'
								,ISNULL(DA.NEDTerm,'None') as '@distalAttachment'
								,CASE WHEN LOWER(DA.NEDTerm) = 'other' THEN PD.AdditionalInfo ELSE NULL END as '@distalAttachmentOther'
								,IT.NEDTerm as '@insertionTechnique'
								,PB.LeftPrepScore as '@bowelPrepLeft'
								,PB.TransversePrepScore as '@bowelPrepTransverse'
								,PB.RightPrepScore as '@bowelPrepRight'
								,PB.TotalPrepScore as '@bowelPrepTotal'
								,ISNULL(B.NEDTerm,'None') as '@bowelPrep'
								,CASE WHEN LOWER(B.NEDTerm) = 'other' THEN B.[Description] ELSE NULL END as '@bowelPrepOther'
								,CASE WHEN NULLIF(fit.FITValue,'') IS NOT NULL THEN fit.FITValue END AS '@fitValue'
								,CASE WHEN fit.FITNotKnownId IS NOT NULL THEN fnk.NEDTerm END AS '@fitNotKnown'
								FROM ERS_Procedures AS P 
									LEFT JOIN (Select ProcedureId, Max(CONVERT(int,RectalExamPerformed)) as RectalExamPerformed from ERS_ProcedureLowerExtent group by ProcedureId) LE ON LE.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_ProcedureDistalAttachment PD ON PD.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_DistalAttachments DA ON DA.UniqueId = PD.DistalAttachmentId
									LEFT JOIN ERS_ProcedureInsertionTechnique PIT ON PIT.ProcedureId = p.ProcedureId
									LEFT JOIN ERS_InsertionTechniques IT ON IT.UniqueId = PIT.InsertionTechniqueId
									LEFT JOIN ERS_ProcedureBowelPrep PB ON PB.ProcedureId = P.ProcedureId
									LEFT JOIN ERS_BowelPrep B ON B.UniqueId = PB.BowelPrepId
									LEFT JOIN ERS_ProcedureFITValue fit ON fit.ProcedureId = p.ProcedureId
									LEFT JOIN ERS_FitNotKnownReasons fnk ON fnk.UniqueId = fit.FITNotKnownId
								Where P.ProcedureId=@ProcedureId) flexi
							FOR XML PATH('Flexi'),TYPE)  
						WHEN @ProcedureTypeId IN (6,7) THEN
							(SELECT * FROM (SELECT DISTINCT CASE WHEN pm.DrugName = '' THEN 'Yes' ELSE 'No' END AS '@prophylacticAntibioticsBeforeEUS',
												ISNULL(dbo.fnNED_FNAFNBSolidLesions(@ProcedureId, P.ProcedureType),'Not applicable') AS '@FNAorFNBSolidLesions',
												ISNULL(dbo.fnNED_FNAFNBTissueAdequacy(@ProcedureId),'Not Applicable') AS '@FNAorFNBTissueAdequacy'
											FROM ERS_UpperGIPremedication pm
												LEFT JOIN ERS_Sites s ON s.ProcedureId = pm.ProcedureId
												LEFT JOIN ERS_UpperGITherapeutics T ON S.SiteId = T.SiteId
												LEFT JOIN ERS_UpperGISpecimens AS SP  ON SP.SiteId = S.SiteId
												LEFT JOIN ERS_ERCPTherapeutics ET ON ET.SiteId = S.SiteId
											WHERE pm.ProcedureId = @ProcedureId) eushpb
								FOR XML PATH('EUS'),TYPE)  
						WHEN @ProcedureTypeId IN (8,9) THEN
							 (SELECT * FROM (SELECT DISTINCT 
								 (SELECT ISNULL(SUM(Detected),0) FROM tvfNED_PolypsTotalsView(@ProcedureId)) AS '@polypsDetected'
								 ,ISNULL(DA.NEDTerm,'None') as '@distalAttachment'
								 ,CASE WHEN LOWER(DA.NEDTerm) = 'other' THEN PDA.AdditionalInfo ELSE NULL END as '@distalAttachmentOther'
								 ,ISNULL(ET.NEDTerm,'None') as '@enteroscopyTechnique'
								 ,CASE WHEN LOWER(ET.NEDTerm) = 'other' THEN PET.AdditionalInfo ELSE NULL END as '@enteroscopyTechniqueOther'
								 ,PID.InsertionLength AS '@depthOfInsertion'
								 ,CASE PID.Tattooed WHEN 1 THEN 'Yes' WHEN 0 THEN 'No' ELSE 'Not Applicable' END AS '@tattooMaxDepthInsertion'
								 ,CASE WHEN PE.RectalExamPerformed = 1 AND ET.NEDTerm IN ('Single balloon anal','Double balloon anal') THEN 'Yes' ELSE 'No' END AS '@digitalRectalExamination'
									FROM ERS_Procedures AS P 
										LEFT JOIN ERS_ProcedureDistalAttachment PDA ON PDA.ProcedureId = P.ProcedureId
										LEFT JOIN ERS_DistalAttachments DA ON DA.UniqueId = PDA.DistalAttachmentId
										LEFT JOIN ERS_ProcedureEnteroscopyTechniques PET ON PET.ProcedureId = P.ProcedureId
										LEFT JOIN ERS_EnteroscopyTechniques ET ON ET.UniqueId = PET.TechniqueId
										LEFT JOIN ERS_ProcedureInsertionDepth PID ON PID.ProcedureId = P.ProcedureId
										LEFT JOIN ERS_ProcedureLowerExtent PE ON PE.ProcedureId = P.ProcedureId
									Where P.ProcedureId=@ProcedureId) ent
								FOR XML PATH('ENT'),TYPE)
					END
				  )
		from ERS_Procedures AS P 
		Where P.ProcedureId=@ProcedureId
		FOR XML PATH('procedure'), ROOT('procedures'), TYPE
		)	

    FROM dbo.ERS_Procedures AS P
    LEFT join dbo.ERS_ProcedureDiscomfortScore as DisNo on P.ProcedureId = DisNo.ProcedureId
    LEFT Join dbo.ERS_DiscomfortScores as Dis on DisNo.DiscomfortScoreId = Dis.UniqueId
	LEFT join dbo.ERS_PostProcedureDiscomfortScore PPD on PPD.ProcedureId = P.ProcedureId 
	LEFT join dbo.ERS_DiscomfortScores as PPDD on PPD.DiscomfortScoreId = PPDD.UniqueId
	Left join dbo.ers_lists as PatStat on PatStat.ListDescription = 'Patient Status' and PatStat.ListItemNo = P.PatientStatus 
	Left Join dbo.ERS_UrgencyTypes as Urgency on P.CategoryListId = Urgency.UniqueId
	Left join dbo.ERS_ProcedurePlannedExtent as PPE on P.ProcedureId = PPE.ProcedureId 
	Left Join dbo.ERS_Extent as Ext on PPE.ExtentId = Ext.UniqueId 
	Left join dbo.ERS_ProcedureInsufflation as PIns on P.ProcedureId = PIns.ProcedureId
	Left Join dbo.ERS_Insufflation as Ins on PIns.InsufflationId = Ins.UniqueId 
	Left Join dbo.ERS_ProviderSectors as PS on P.PatientType = PS.UniqueId 
	Left Join dbo.ERS_ReferrerTypes as RT on P.ReferrerType = RT.UniqueId 
	Left join dbo.ERS_ProviderOrganisation as PO on P.ProviderTypeId = PO.UniqueId 
	Left Join dbo.ERS_ProcedureAISoftware as PAIS on P.ProcedureId = PAIS.ProcedureId 
	Left Join dbo.ERS_AISoftware as AIS on PAIS.AISoftwareId = AIS.UniqueId 
	Left Join dbo.ERS_ProcedureChromendosopy as PCHR on PCHR.ProcedureId = p.ProcedureId


  INNER JOIN dbo.ERS_VW_Patients			AS Pat  ON P.PatientId=Pat.[PatientId]
   LEFT JOIN dbo.tvfNED_ProcedureDrugList(@ProcedureId)	AS Drug		ON P.ProcedureId = Drug.ProcedureId	
   --LEFT JOIN dbo.ERS_UpperGIQA				AS QA   ON P.ProcedureId = QA.ProcedureId	-- Patient DIscomfort
   LEFT JOIN dbo.ERS_BowelPreparation		AS BP   ON P.ProcedureId=BP.ProcedureID	-- DIscomfort for Nurse
   LEFT JOIN dbo.ERS_ColonExtentOfIntubation   EL	ON P.ProcedureId = EL.ProcedureId
	   where P.ProcedureId= @ProcedureId
		 for XML PATH ('session'), ROOT('hospital.SendBatchMessage'), ELEMENTS
);

DECLARE   @xmlFileName AS varchar(100)
		, @ReportDate AS VARCHAR(10)
		, @ReportTime AS VARCHAR(8)
		, @xmlPreviousExportFileName AS VARCHAR(100);

SELECT    @ReportDate = CONVERT(VARCHAR(10), CreatedOn, 103)
		, @ReportTime = CONVERT(VARCHAR(8), ModifiedOn, 108) 
FROM dbo.ERS_Procedures WHERE ProcedureId=@ProcedureId;

--== Check whether Admin has added/removed the '\' at the end of the Path.. 
SET @ExportFolderPath = (CASE WHEN RIGHT(@ExportFolderPath, 1)='\' THEN @ExportFolderPath ELSE (@ExportFolderPath + '\') END);

SELECT top 1 @xmlPreviousExportFileName = xmlFileName FROM [dbo].[ERS_NedFilesLog] WHERE ProcedureId=@ProcedureId ORDER BY [LogId] desc;

--### File Path and Name example: 'NED_xml_output\74_22-09-2017_09-32-53_00831101o.xml' vs '99_19-10-2017_16-24-16_00205602e.xml'
SET @xmlFileName =    @ExportFolderPath 
					+ @site + '_' 
					+ replace(@ReportDate, '/', '-') + '_' 
					+ replace(@ReportTime, ':', '-') + '_' 
					+ @uniqueid	
					+ '.xml';					

SELECT @returnXML AS returnXML
				 , '<hospital.SendBatchMessage xmlns:xsd="http://www.w3.org/2001/XMLSchema"'
				  + 
				 ' xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"'
				  +
				 ' xmlns="https://www.jets.nhs.uk/schema/hospital.sendbatchmessage-version2.xsd"'
				  +
				 ' softwareVersion="2"' AS NS_Info		--## These extra info will be added to the Actual XML file in .NET while exporting;
				 , @xmlFileName AS xmlFileName
				 , IsNull(@xmlPreviousExportFileName, 'x') AS PreviousFileName;

END

GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO
------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rony
-- TFS#	3583
-- Description of change
-- Nurse Drop dropdown on create procedure page not mandatory 
------------------------------------------------------------------------------------------------------------------------

update dbo.ERS_FieldLabels set FieldName='Nurse', Required=1, CannotBeSuppressed=1 where FieldLabelID=56 

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	3583
------------------------------------------------------------------------------------------------------------------------
GO
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rezaul Karim
-- TFS#	3887
-- Description of change: Updating Cancellation reason suppresses the reason
-------------------------------------------------------------------------------------------------------------------------
GO
dbo.DropIfExist
    @ObjectName = 'sch_CancellationReasons_insert_update',
    @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[sch_CancellationReasons_insert_update](
	@CancelReasonId int,
	@Code VARCHAR(30),
	@Detail varChar(50),
	@CancelledByHospital bit,
	@UserId Int
)

AS 
	SET NOCOUNT ON
	BEGIN TRANSACTION
	BEGIN TRY
		IF Exists (SELECT CancelReasonId FROM ERS_CancelReasons WHERE CancelReasonId = @CancelReasonId)
		BEGIN
			declare @suppressed BIT = (select  suppressed FROM ERS_CancelReasons where CancelReasonId = @CancelReasonId)
			--exists so Update with new values
			UPDATE ERS_CancelReasons
			SET Code = @Code,
				Detail = @Detail,
				CancelledByHospital = @CancelledByHospital,
				Suppressed = @suppressed,
				WhoUpdatedId = @UserId,
				WhenUpdated = GetDate()
			WHERE CancelReasonId = @CancelReasonId 
		END
		ELSE
		BEGIN
			INSERT ERS_CancelReasons(
				Code,
				CancelCodeId,
				Detail,
				CancelledByHospital,
				Suppressed,
				WhoCreatedId,
				WhenCreated,
				WhoUpdatedId,
				WhenUpdated)
			VALUES (@Code,
					1,
					@Detail,
					@CancelledByHospital,
					0,
					@UserId,
					GetDate(),
					@UserId,
					GetDate())
		END
	END TRY

	BEGIN CATCH
		DECLARE @ErrorMessage NVARCHAR(4000);
		DECLARE @ErrorSeverity INT;
		DECLARE @ErrorState INT;

		SELECT @ErrorMessage = ERROR_MESSAGE(),
			   @ErrorSeverity = ERROR_SEVERITY(),
			   @ErrorState = ERROR_STATE();
    
		RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

		IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
	END CATCH
	IF @@TRANCOUNT > 0 COMMIT TRANSACTION;
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	No TFS - Item 3887  by Rezaul
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rezaul Karim
-- TFS#	3835
-- Description of change: polyp removed - then edited
-------------------------------------------------------------------------------------------------------------------------
dbo.DropIfExist
    @ObjectName = 'usp_CheckUpperGISpecimensForRecordDeletion',
    @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [DBO].[usp_CheckUpperGISpecimensForRecordDeletion]
    @SiteId INT
AS
BEGIN
    DECLARE @None BIT = NULL,
            @Biopsy BIT,
            @BrushCytology BIT,
            @FNA int = 0,
            @FNB BIT,
            @HOTBiopsy BIT,
            @POLYPS BIT
    SELECT @None = None, @Biopsy = Biopsy, @BrushCytology = BrushCytology, @FNA = EUSFNANumberOfPasses,@FNB = FNB, @HOTBiopsy = HotBiopsy, @POLYPS = Polypectomy 
			FROM dbo.ERS_UpperGISpecimens WHERE SiteId = @SiteId;
    IF @None > 0 OR
		@Biopsy > 0 OR
       @BrushCytology > 0 OR
       @FNA > 0 OR
       @FNA > 0 OR
       @HOTBiopsy > 0 OR
       @POLYPS > 0
     
    BEGIN
        
        declare @Result BIT = 0
    END
    ELSE
    BEGIN
		DELETE FROM ERS_UpperGISpecimens WHERE SiteId = @SiteId
		DELETE FROM ERS_RecordCount WHERE  SiteId = @SiteId AND Identifier = 'Specimens Taken'
    END
END

GO
dbo.DropIfExist
    @ObjectName = 'abnormalities_common_polyp_specimen_details_save',
    @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[abnormalities_common_polyp_specimen_details_save]
(
		@SiteId int,
		@LoggedInUserId int
)
AS

BEGIN TRANSACTION

BEGIN TRY
	
	--update specimen table
	DECLARE @SpecimenTotal INT = (SELECT COUNT(*) FROM ERS_CommonAbnoPolypDetails WHERE Successful  > 0 AND SiteId = @SiteId)

	IF @SpecimenTotal > 0
	BEGIN
		DECLARE @ProcedureId int = (SELECT ProcedureId FROM ERS_Sites WHERE SiteId = @SiteId)

		IF NOT EXISTS (SELECT 1 FROM dbo.ERS_UpperGISpecimens WHERE SiteId = @SiteId)
			BEGIN
				INSERT INTO ERS_UpperGISpecimens (SiteId, Polypectomy,	PolypectomyQty, WhoCreatedId, WhenCreated) 
				VALUES (@SiteId, 1, @SpecimenTotal, @LoggedInUserId, GETDATE())

				IF NOT EXISTS (SELECT 1 FROM ERS_RecordCount WHERE ProcedureId = @ProcedureId AND SiteId = @SiteId AND Identifier = 'Specimens Taken')
				BEGIN
					INSERT INTO ERS_RecordCount ([ProcedureId],	[SiteId], [Identifier], [RecordCount])
					VALUES (@ProcedureId, @SiteId, 'Specimens Taken', 1)
				END 
			END
		ELSE
			BEGIN
				UPDATE ERS_UpperGISpecimens
				SET
					Polypectomy = (SELECT CASE WHEN @SpecimenTotal > 0 THEN 1 ELSE 0 END),
					PolypectomyQty = @SpecimenTotal
				WHERE SiteId = @SiteId
			END
		IF NOT EXISTS (SELECT 1 FROM ERS_UpperGIFollowUp WHERE ProcedureId = @ProcedureId)
		BEGIN
			INSERT INTO ERS_UpperGIFollowUp (ProcedureId, AwaitingPathologyResults) 
			VALUES (@ProcedureId, 1)
		END


		   --Will set follow up section as complete
		   exec UI_update_procedure_summary @ProcedureId, 'Follow up', 'Follow up', 1

			INSERT INTO ERS_RecordCount ([ProcedureId], [SiteId], [Identifier],[RecordCount])
			VALUES (@ProcedureId,NULL,'Follow Up', 1)

	END

	IF @SpecimenTotal = 0

		BEGIN
			IF EXISTS(SELECT 1 FROM ERS_UpperGISpecimens WHERE SiteId = @SiteId)
				BEGIN
					UPDATE ERS_UpperGISpecimens
					SET
						Polypectomy = (SELECT CASE WHEN @SpecimenTotal > 0 THEN 1 ELSE 0 END),
						PolypectomyQty = @SpecimenTotal
					WHERE SiteId = @SiteId
				END
			exec usp_CheckUpperGISpecimensForRecordDeletion @SiteId
		END
END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;

GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#3835	polyp removed - then edited
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rezaul Karim
-- TFS#	3838
-- Description of change: OGD post surgical diagnoses
-------------------------------------------------------------------------------------------------------------------------
GO
dbo.DropIfExist
    @ObjectName = 'abnormalities_postsurgery_summary_update',
    @ObjectTypePrefix = 'S' -- varchar(5)
GO


CREATE PROCEDURE [dbo].[abnormalities_postsurgery_summary_update]
(
	@SiteId INT
)
AS
	SET NOCOUNT ON

	DECLARE
		@summary VARCHAR(4000),
		@none BIT,
		@previousSurgery BIT,
		@surgicalProcedure SMALLINT,
		@surgicalProcedureFindings VARCHAR(1000),
		@duodenumPresent BIT,
		@jejunum BIT,
		@jejunumState TINYINT,
		@jejunumAbnormalText VARCHAR(500)

	SELECT 
		@none=[None],
		@surgicalProcedure=SurgicalProcedure,
		@surgicalProcedureFindings=(SELECT isnull(SurgicalProcedureFindings, '') as [text()] FOR XML PATH('')),
		@duodenumPresent=DuodenumPresent,
		@jejunumState=JejunumState,
		@jejunumAbnormalText=(SELECT isnull(JejunumAbnormalText, '') as [text()] FOR XML PATH(''))
	FROM
		ERS_UpperGIAbnoPostSurgery
	WHERE
		SiteId = @SiteId

	SET @Summary = ''

	IF @none = 1
		SET @summary = @summary + 'No evidence of previous surgery'
	
	ELSE 
	BEGIN
		IF @surgicalProcedure > 0
		BEGIN
			--SET @summary = @summary + 'surgical procedure - '

			SELECT @summary = @summary + [ListItemText]
			FROM ERS_Lists 
			WHERE [ListDescription] = 'Surgical procedures' 
			AND [ListItemNo] = @surgicalProcedure
		END

		IF ISNULL(@surgicalProcedureFindings, '') <> '' SET @summary = @summary + ' ' + @surgicalProcedureFindings

		IF @summary <> '' SET @summary = @summary + ', '

		IF @duodenumPresent = 1  SET @summary = @summary + 'duodenum removed'

		IF @jejunumState > 0
		BEGIN
			IF @summary <> '' SET @summary = @summary + ', '
			ELSE SET @summary = @summary + 'jejunum '

			IF @jejunumState = 1 SET @summary = @summary + 'normal jejunum'
			ELSE IF @jejunumState = 2 
			BEGIN
				SET @summary = @summary + 'abnormal jejunum'
				IF @jejunumAbnormalText <> '' SET @summary = @summary + ' - ' + @jejunumAbnormalText
			END
			
		END
	END

	SET @Summary = LTRIM(RTRIM(@Summary))
	IF RIGHT(@Summary,1) = ',' SET @Summary = LEFT(@Summary, LEN(@Summary) - 1)
	--PRINT @summary

	-- Finally update the summary in abnormalities table
	UPDATE ERS_UpperGIAbnoPostSurgery
	SET Summary = @Summary 
	WHERE SiteId = @siteId
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#3838 	OGD post surgical diagnoses
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rezaul Karim
-- TFS#	3915
-- Description of change: lower procedure - retroflection not done
-- Updated by	:	MOSTAFIZUR RAHMAN
-- TFS#	3924
-- Description of change
-- Fixed SE Colon extent selection remains after changing options
-------------------------------------------------------------------------------------------------------------------------
GO
 IF NOT EXISTS (
        SELECT 1
        FROM INFORMATION_SCHEMA.COLUMNS
        WHERE TABLE_NAME = 'ERS_ProcedureLowerExtent' AND
              COLUMN_NAME IN ('NoRetroflectionReason')
    )
    BEGIN
		ALTER TABLE dbo.ERS_ProcedureLowerExtent
            ADD NoRetroflectionReason VARCHAR(150)
    END

GO
dbo.DropIfExist
    @ObjectName = 'procedure_lower_extent_summary_update',
    @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[procedure_lower_extent_summary_update]
(
	@ProcedureId INT,
	@EndoscopistId INT = NULL
)
AS
BEGIN
	
	DECLARE 
	@ExtentId INT,
	@AdditionalInfo VARCHAR(MAX),
	@ConfirmedById INT,
	@ConfirmedByOther VARCHAR(200),
	@CaecumIdentifiedById INT,
	@LimitationId INT,
	@DifficultyEncounteredId INT,
	@DifficultyOther VARCHAR(200),
	@PR INT,
	@Retroflexion INT,
	@NoRetroflexionReason VARCHAR(150),
	@InsertionVia INT,
	@LimitationOther VARCHAR(MAX),
	@ProcedureAbandoned BIT, 
	@IntubationFailed BIT,
	@LoggedInUserId INT


	DECLARE @SectionId INT, @ProceureTypeId INT, @ExtentDescription VARCHAR(200), @IsSuccess BIT, @ScopeType VARCHAR(200), @SummaryText VARCHAR(MAX), @RetroflexionDone BIT, @PRDone BIT
	SELECT @SectionID = UISectionId FROM UI_Sections WHERE SectionName = 'Extent'

	SELECT @ProceureTypeId = ProcedureType FROM ERS_Procedures WHERE ProcedureId = @ProcedureId
	--SELECT @ExtentDescription = LOWER(Description) FROM ERS_Extent WHERE UniqueId = @ExtentId

	/*Furthest extent*/
	SELECT TOP 1 @ExtentDescription = ee.Description, 
				 @EndoscopistId = epue.EndoscopistId, 
				 @DifficultyEncounteredId = epue.DifficultiesEncounteredId,
				 @LimitationId = epue.LimitationId,
				 @LimitationOther= epue.LimitationOther,
				 @Retroflexion = epue.RetroflectionPerformed,
				 @ExtentId = epue.ExtentId,
				 @ConfirmedById = epue.ConfirmedById,
				 @InsertionVia = epue.InsertionAccessViaId,
				 @ProcedureAbandoned = epue.Abandoned,
				 @IntubationFailed = epue.IntubationFailed,
				 @NoRetroflexionReason = epue.NoRetroflectionReason
								FROM dbo.ERS_ProcedureLowerExtent epue 
									INNER JOIN dbo.ERS_Extent ee ON epue.ExtentId = ee.UniqueId
								WHERE epue.ProcedureId=@ProcedureId and EndoscopistId = @EndoscopistId
								ORDER BY ee.ListOrderBy
	


	/*PR Exam*/
	IF (SELECT COUNT(*) FROM ERS_ProcedureLowerExtent eple WHERE ProcedureId = @ProcedureId AND eple.RectalExamPerformed IS NOT NULL) > 0
	BEGIN
		/*Overall PR result regardless of who done it, was it done*/
		IF EXISTS (SELECT 1 FROM ERS_ProcedureLowerExtent WHERE ProcedureId = @ProcedureId AND ISNULL(RectalExamPerformed,0) = 1)
			SET @PRDone = 1
		ELSE
			SET @PRDone = 0
	END
	
	/*Retroflexion*/
	IF (SELECT COUNT(*) FROM ERS_ProcedureLowerExtent eple WHERE ProcedureId = @ProcedureId AND eple.RetroflectionPerformed IS NOT NULL) > 0
	BEGIN
		/*Overall PR result regardless of who done it, was it done*/
		IF EXISTS (SELECT 1 FROM ERS_ProcedureLowerExtent WHERE ProcedureId = @ProcedureId AND ISNULL(RetroflectionPerformed,0) = 1 AND EndoscopistId = @EndoscopistId)
			SET @RetroflexionDone = 1
		ELSE
			SET @RetroflexionDone = 0
	END


	DECLARE @A varchar(5000), @B VARCHAR(5000), @Rectal varchar(500), @Retro varchar(500), @ProcType int

	SET @SummaryText = ''

	IF @ProceureTypeId = 4 
	BEGIN
		SET @ScopeType = 'sigmoidoscope'
	END
	ELSE 
	BEGIN 
		SET @ScopeType = 'colonoscope'
	END

	IF @PRDone IS NOT NULL 
	BEGIN
		IF @PR = 1 
		BEGIN
			SET @SummaryText = @SummaryText + 'A digital rectal examination was performed. '
		END
	END

	ELSE 
	BEGIN
		SET @SummaryText = @SummaryText + 'A digital rectal examination was not performed. '
	END

	DECLARE @InsertionSummaryText varchar(4000) = '', @ExtentSummaryText varchar(4000) = ''

	IF ISNULL(@InsertionVia,0) > 0 
	BEGIN
		SET @InsertionSummaryText = 'The ' + @ScopeType +  ' was inserted via ' + 
		(SELECT LOWER(CASE WHEN Description = 'anus' THEN 'the ' + Description ELSE Description END) FROM ERS_ExtentInsertionRoutes WHERE UniqueId = @InsertionVia)
	END
	
	IF ISNULL(@ExtentId,0) > 0 
	BEGIN
		SET @ExtentSummaryText = CASE WHEN @InsertionSummaryText = '' THEN 'The ' + @ScopeType +  ' was inserted ' ELSE '' END + ' to the ' + @ExtentDescription + ''
	END

	SET @SummaryText = @SummaryText + @InsertionSummaryText + @ExtentSummaryText
	
	IF @ProcedureAbandoned = 1
	BEGIN
		SET @SummaryText = @SummaryText + CASE WHEN @ExtentSummaryText <> '' OR @InsertionSummaryText <> '' THEN ' but the procedure was abandoned' ELSE ' The procedure was abandoned' END
	END
	
	IF @IntubationFailed = 1
	BEGIN
		SET @SummaryText = @SummaryText + ' intubation failed '
	END
	--edited by mostafiz 3924
	IF @ExtentDescription='Caecum' or @ExtentDescription='Terminal ileum'
	BEGIN
		--DECLARE @IdentifiedByConfidence varchar(max) = (SELECT [Description]
		--												FROM ERS_ProcedureCaecumIdentifiedBy epi 
		--													INNER JOIN ERS_ExtentConfirmedByList i on i.UniqueId = epi.ExtentIdentifiedById
		--												WHERE ProcedureId=@ProcedureId AND EndoscopistId = @EndoscopistId)
		
		DECLARE @IdentifiedByText varchar(max) = '. The caecum was identified by '

		SET @IdentifiedByText = @IdentifiedByText + LTRIM(STUFF((SELECT ', ' + CASE WHEN ISNULL(ChildId, 0) > 0 THEN (SELECT [Description] FROM ERS_ExtentConfirmedByList WHERE UniqueId = epi.ChildId) ELSE LOWER([Description]) END AS [text()] 
		FROM ERS_ProcedureCaecumIdentifiedBy epi 
			INNER JOIN ERS_ExtentConfirmedByList i on i.UniqueId = epi.ExtentIdentifiedById
		WHERE ProcedureId=@ProcedureId and EndoscopistId = @EndoscopistId and ISNULL(ChildId, 0) = 0
		ORDER BY ISNULL(i.ListOrderBy, 0)
		FOR XML PATH('')),1,1,''))

		SELECT @IdentifiedByText = dbo.fnAddFullStop(@IdentifiedByText)

		IF LEN(@IdentifiedByText) > 0
		BEGIN
			IF charindex(',', reverse(@IdentifiedByText)) > 0
				SET @SummaryText = @SummaryText + STUFF(@IdentifiedByText, len(@IdentifiedByText) - charindex(' ,', reverse(@IdentifiedByText)), 2, ' and ')
			ELSE
				SET @SummaryText = @SummaryText +  @IdentifiedByText
		END

	

	END
	
	--edited by mostafiz


	IF ISNULL(@ConfirmedById, 0) > 0
	BEGIN
		SET @SummaryText = @SummaryText + ', insertion confirmed by ' + (SELECT LOWER(Description) FROM ERS_ExtentConfirmedByList WHERE UniqueId = @ConfirmedById)
	END
	
	IF ISNULL(@LimitationId, 0) > 0
	BEGIN
		SET @SummaryText = @SummaryText + CASE WHEN ISNULL(@ConfirmedById, 0) > 0 THEN ' and  ' ELSE ', ' END + 'insertion limited by ' + (SELECT LOWER(Description) FROM ERS_Limitations WHERE UniqueId = @LimitationId) + '.<br />'
	END

	IF ISNULL(@DifficultyEncounteredId, 0) > 0 
	BEGIN
		SET @SummaryText = @SummaryText + ' Difficulties encountered: ' + (SELECT LOWER(Description) FROM ERS_ExtentDifficultiesEncountered WHERE UniqueId = @DifficultyEncounteredId) + '.'
	END

	IF @RetroflexionDone = 1
	BEGIN
		SET @SummaryText = @SummaryText + ' .The scope was retroflexed in the rectum.'
	END
	IF @RetroflexionDone = 0
	BEGIN
		declare @reason varchar(150) 
		set @reason =( select  NoRetroflectionReason from ERS_ProcedureLowerExtent where ProcedureId = @ProcedureId and EndoscopistId = @EndoscopistId)
		SET @SummaryText = @SummaryText + CASE WHEN @reason <> '' and @reason is not null then '.The scope was not retroflexed due to ' + @reason + '.' else '' END
	END
		
	
	UPDATE ERS_ProcedureLowerExtent
	SET Summary = @SummaryText
	WHERE ProcedureId = @ProcedureId and EndoscopistId = @EndoscopistId

	--remove complete section entry incase conditions no longer apply
	EXEC UI_update_procedure_summary @ProcedureId, 'Extent', 'Extent:', 0, @EndoscopistId
	
	--set extent id to whatever necessary only for completion purposes as no extent has reached 
	SELECT @IsSuccess = IsSuccess FROM ERS_Extent WHERE UniqueId = @ExtentId

	IF ISNULL(@ExtentId,0) = 0 AND (@ProcedureAbandoned = 1 OR @IntubationFailed = 1)
	BEGIN
		--set record in database??????
		IF @ProcedureAbandoned = 1
		BEGIN
			SELECT @ExtentId = UniqueId, @IsSuccess = IsSuccess
			FROM ERS_Extent
			WHERE NEDTerm = 'Abandoned'
		END
		ELSE IF @IntubationFailed = 1
		BEGIN
			SELECT @ExtentId = UniqueId, @IsSuccess = IsSuccess
			FROM ERS_Extent
			WHERE NEDTerm = 'Intubation failed'
		END
	END

	--if extent is > 0 and extent.issuccess = 1 or (limitation id > 0 and (limitation id <> other or (limitationid = other and other text filled in)))
	--If Sigmoid, check if the Extent has reached or exceeded the planned extent
	IF @ExtentId > 0 AND @ProceureTypeId = 4
	BEGIN
		DECLARE @ExtentListOrder int = (SELECT ListOrderBy FROM ERS_Extent WHERE UniqueId = @ExtentId)
		DECLARE @PlannedExtentListOrder int = (SELECT e.ListOrderBy FROM ERS_ProcedurePlannedExtent ppe JOIN ERS_Extent e ON e.UniqueId = ppe.ExtentId WHERE ppe.ProcedureId = @ProcedureId)

		IF (@ExtentListOrder <= @PlannedExtentListOrder AND @ExtentListOrder > 0)
				SET @IsSuccess = 1
			ELSE
				SET @IsSuccess = 0
	END

	IF @ExtentId > 0 AND @IsSuccess = 1
		EXEC UI_update_procedure_summary @ProcedureId, 'Extent', 'Extent:', @ExtentId, @EndoscopistId
	ELSE IF @IsSuccess = 0 AND @LimitationId > 1
	BEGIN
		IF (SELECT LOWER(NEDTerm) FROM dbo.ERS_Limitations WHERE UniqueId = @LimitationId) = 'other'
		BEGIN
			SELECT @LimitationOther = Description FROM dbo.ERS_Limitations WHERE UniqueId = @LimitationId AND LOWER(Description) <> 'other' -- meaning they've entered their own description
			IF ISNULL(@LimitationOther,'') <> ''
			BEGIN
				EXEC UI_update_procedure_summary @ProcedureId, 'Extent', 'Extent:' , @ExtentId, @EndoscopistId
			END
		END
		ELSE
		BEGIN
			EXEC UI_update_procedure_summary @ProcedureId, 'Extent', 'Extent:', @ExtentId, @EndoscopistId
		END
	END

	--retroflexion
	IF @Retroflexion > -1
	BEGIN
		EXEC UI_update_procedure_summary @ProcedureId, 'Retroflexion', 'Retroflexion:', 1, @EndoscopistId
	END
	ELSE
	BEGIN
		EXEC UI_update_procedure_summary @ProcedureId, 'Retroflexion', 'Retroflexion:', 0, @EndoscopistId
	END

END
GO

dbo.DropIfExist
    @ObjectName = 'procedure_lower_extent_select',
    @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[procedure_lower_extent_select]
(
	@ProcedureId int
)
AS
BEGIN
	SELECT pe.ExtentId, Description, e.NEDTerm, pe.AdditionalInfo, EndoscopistId, ConfirmedById, CaecumIdentifiedById, DifficultiesEncounteredId, LimitationId,
		   RectalExamPerformed, RetroflectionPerformed,NoRetroflectionReason, InsertionAccessViaId, e.IsSuccess, pe.WithdrawalMins, pe.CaecumIntubationStart, LimitationOther, pe.Abandoned,
		   pe.IntubationFailed
	FROM ERS_ProcedureLowerExtent pe
		LEFT JOIN ERS_Extent e on e.UniqueId = pe.ExtentId
	WHERE 
		ProcedureId = @ProcedureId
END

GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#3924,3915 	lower procedure - retroflection not done
------------------------------------------------------------------------------------------------------------------------


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	MOSTAFIZUR RAHMAN
-- TFS#	4090
-- Description of change
-- Fixed Anti-Coag option not selected
------------------------------------------------------------------------------------------------------------------------
GO
EXEC dbo.DropIfExist 
    @ObjectName = 'GetAntiCoagDrugs', 
    @ObjectTypePrefix = 'F' 
GO

        CREATE FUNCTION [dbo].[GetAntiCoagDrugs]
        (
            @ProcedureId INT
        )
        RETURNS INT
        AS
        BEGIN
            DECLARE @antiCoagDrugsValue INT

            SELECT @antiCoagDrugsValue = COALESCE(AntiCoagDrugs,-1)
            FROM ERS_Procedures
            WHERE ProcedureId = @ProcedureId

            RETURN @antiCoagDrugsValue
        END
GO

GO
EXEC dbo.DropIfExist 
    @ObjectName = 'patient_anti_coag_drugs_save', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[patient_anti_coag_drugs_save]
(
	@ProcedureId int,
	@AntiCoagDrugs bit
)
AS
BEGIN
	BEGIN
	    UPDATE ERS_Procedures SET AntiCoagDrugs = @AntiCoagDrugs WHERE ProcedureId = @ProcedureId
	    	DECLARE  @SectionId int = (SELECT UISectionId FROM UI_Sections WHERE SectionName = 'Anti-coag drugs')
	    
	    	DELETE FROM ERS_ProcedureSummary WHERE ProcedureId = @ProcedureId AND SectionId = @SectionId
	    	IF @AntiCoagDrugs = 1 AND 
	    			(SELECT count(*) FROM ERS_ProcedureDamagingDrugs WHERE ProcedureId = @ProcedureId AND DamagingDrugId IN (SELECT UniqueId FROM ERS_PotentialDamagingDrugs WHERE AntiCoag = 1)) > 0 
	    	BEGIN
	    		exec UI_update_procedure_summary @ProcedureId, 'Anti-coag drugs', 'Anti-coag drugs', 1
				--check RX status incase this was an update
				IF (SELECT count(*) FROM ERS_UpperGIRx WHERE ProcedureId = @ProcedureId AND Summary <> '') = 0
				BEGIN
					exec UI_update_procedure_summary @ProcedureId, 'RX', 'RX', 0
				END
	    	END
	    	ELSE IF @AntiCoagDrugs = 1 AND 
	    			(SELECT count(*) FROM ERS_ProcedureDamagingDrugs WHERE ProcedureId = @ProcedureId AND DamagingDrugId IN (SELECT UniqueId FROM ERS_PotentialDamagingDrugs WHERE AntiCoag = 1)) = 0 
	    	BEGIN
	    		exec UI_update_procedure_summary @ProcedureId, 'Anti-coag drugs', 'Anti-coag drugs', 0
				--check RX status incase this was an update
				IF (SELECT count(*) FROM ERS_UpperGIRx WHERE ProcedureId = @ProcedureId AND Summary <> '') = 0
				BEGIN
					exec UI_update_procedure_summary @ProcedureId, 'RX', 'RX', 0
				END
	    	END
	    	ELSE IF @AntiCoagDrugs = 0
	    	BEGIN
			
				Delete FROM ERS_ProcedureDamagingDrugs WHERE ProcedureId = @ProcedureId AND DamagingDrugId IN  
				(SELECT UniqueId FROM ERS_PotentialDamagingDrugs WHERE AntiCoag = 1) --edited by mostafiz 4090

	    		exec UI_update_procedure_summary @ProcedureId, 'Anti-coag drugs', 'Anti-coag drugs', 1
				exec UI_update_procedure_summary @ProcedureId, 'RX', 'RX', 1

				UPDATE ERS_ProceduresReporting 
				SET PP_Indic = dbo.ProcedureIndicationsSummary(@ProcedureId)
				WHERE ProcedureId = @ProcedureId --edited by mostafiz 4090
	    	END
	END
END
GO

------------------------------------------------------------------------------------------------------------------------
-- TFS#	4090 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	MOSTAFIZUR RAHMAN
-- TFS#	2983
-- Description of change
-- Fixed OGD individually regions not showing in report
------------------------------------------------------------------------------------------------------------------------
GO
EXEC dbo.DropIfExist 
    @ObjectName = 'ogd_diagnoses_summary_update', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[ogd_diagnoses_summary_update]
(
	@ProcedureId INT
)
AS

SET NOCOUNT ON

--check for procedure DNA
DECLARE @ProcNotCarriedOut bit = ISNULL((SELECT 1 FROM ERS_Procedures WHERE ProcedureId = @ProcedureId AND DNA IS NOT NULL), 0)

IF @ProcNotCarriedOut = 1
	RETURN --DNA procs do not procude a diagnosis

DECLARE @ProcedureType INT
DECLARE @Summary varchar(MAX)=''
DECLARE @tmpSummary varchar(MAX)=''
DECLARE @XMLlist XML
DECLARE @OperatingHospitalId INT
DECLARE @OGDDiagnosisOption INT
DECLARE @Extent INT
DECLARE @ExtentItem VARCHAR(MAX)
DECLARE @ExtentDescription VARCHAR(MAX)
DECLARE @StomachExtent INT = (SELECT UniqueId FROM ERS_Extent WHERE Description = 'Stomach')
DECLARE @DuodenumExtent INT = (SELECT UniqueId FROM ERS_Extent WHERE Description = 'D1')
DECLARE @FurthestExtentReached INT = 0
DECLARE @BlockingStricure BIT = 0
Declare @checkedOesophagusNotEntered INT =0

SELECT 
	@ProcedureType = ProcedureType, 
	@OperatingHospitalId = COALESCE(OperatingHospitalId, 0, OperatingHospitalID)
FROM ERS_Procedures 
WHERE ProcedureId = @ProcedureId

SELECT 
	@OGDDiagnosisOption = OGDDiagnosis
FROM dbo.ERS_SystemConfig 
WHERE OperatingHospitalId = @OperatingHospitalId

--Get furthest recored Extent
SELECT TOP 1 @FurthestExtentReached = ee.UniqueId
FROM dbo.ERS_ProcedureUpperExtent epue 
	INNER JOIN dbo.ERS_Extent ee ON epue.ExtentId = ee.UniqueId
WHERE epue.ProcedureId=@ProcedureId
ORDER BY ee.ListOrderBy DESC

IF (SELECT ugam.SiteId
	FROM ERS_UpperGIAbnoMiscellaneous ugam
	JOIN ERS_Sites s ON s.SiteId = ugam.SiteId
	JOIN ERS_Regions r ON r.RegionId = s.RegionId
	JOIN ERS_AbnormalitiesMatrixUpperGI amug ON amug.Region = r.Region AND amug.ProcedureType = @ProcedureType
	LEFT JOIN ERS_UpperGITherapeutics ugt ON ugt.SiteId = s.SiteId 
	WHERE ugam.SiteId in (SELECT SiteId FROM ERS_Sites WHERE ProcedureId = @ProcedureId)
	AND amug.area = 'Oesophagus'
	AND ugam.StrictureScopeNotPass = 1 
	AND ISNULL(ugt.DilatorScopePass,0) != 1) > 0
BEGIN
	SET @BlockingStricure = 1
END

	 
IF @ProcedureType IN (2, 7)    --For ERCP & EUS_HPB, execute a different SP
BEGIN
	EXEC ercp_diagnoses_summary_update @ProcedureId
	RETURN
END

BEGIN TRANSACTION

BEGIN TRY

SELECT * INTO #tbl_ERS_Diagnoses FROM ERS_Diagnoses WHERE ProcedureId=@ProcedureId 

IF @ProcedureType IN (1,6,8)   --Gastroscopy
BEGIN
	IF OBJECT_ID('tempdb..#Oesophagus') IS NOT NULL DROP TABLE #Oesophagus
	IF OBJECT_ID('tempdb..#Stomach') IS NOT NULL DROP TABLE #Stomach
	IF OBJECT_ID('tempdb..#Duodenum') IS NOT NULL DROP TABLE #Duodenum

    IF OBJECT_ID('tempdb..#OesophagusTemp') IS NOT NULL DROP TABLE #OesophagusTemp
                             create table #OesophagusTemp ([cx] Int null, [Text] varchar(MAX) null)
    IF OBJECT_ID('tempdb..#StomachTemp') IS NOT NULL DROP TABLE #StomachTemp
                             create table #StomachTemp ([cx] Int null, [Text] varchar(MAX) null)
    IF OBJECT_ID('tempdb..#DuodenumTemp') IS NOT NULL DROP TABLE #DuodenumTemp
                             create table #DuodenumTemp ([cx] Int null, [Text] varchar(MAX) null)
	
	IF (SELECT COUNT(*) FROM #tbl_ERS_Diagnoses ted) = 0
	BEGIN
		INSERT INTO ERS_Diagnoses (ProcedureID, MatrixCode, [Value], IsOtherData)
		VALUES (@ProcedureId, 'OverallNormal', '1', 1)
	END
	ELSE
	BEGIN
		/*OESOPHAGUS REGION*/
		IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Region='Oesophagus' AND Value IN ('True', '1') AND MatrixCode NOT IN ('OesophagusNormal', 'OesophagusNotEntered'))
		BEGIN
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'OesophagusNormal') DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'OesophagusNormal' AND Value IN ('True', '1')
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'OesophagusNotEntered')  DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'OesophagusNotEntered' AND Value IN ('True', '1')
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'OverallNormal') DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'OverallNormal'
		END
		ELSE IF NOT EXISTS (SELECT 1 FROM #tbl_ERS_Diagnoses WHERE Region = 'Oesophagus' OR MatrixCode = 'OverallNormal')
		BEGIN
			INSERT INTO [ERS_Diagnoses] (ProcedureId, MatrixCode, Value, Region, IsOtherData) VALUES (@ProcedureId, 'OesophagusNormal', 'True', 'Oesophagus', 1)
		END
		
		--edited by Mostafizur 3831
	 
	
		IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Region='Oesophagus' AND Value IN ('True', '1') AND MatrixCode = 'OesophagusNotEntered')
			set @checkedOesophagusNotEntered=1
			SELECT TOP 1 @ExtentDescription = ee.Description
								FROM dbo.ERS_ProcedureUpperExtent epue 
									INNER JOIN dbo.ERS_Extent ee ON epue.ExtentId = ee.UniqueId
								WHERE epue.ProcedureId=@ProcedureId
								ORDER BY ee.ListOrderBy DESC

		--edited by Mostafizur 3831

		/*STOMACH REGION*/
		IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Region='Stomach' AND Value IN ('True', '1') AND MatrixCode NOT IN ('StomachNormal', 'StomachNotEntered'))
		BEGIN
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'StomachNormal')  DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'StomachNormal' AND Value IN ('True', '1')
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'StomachNotEntered')  DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'StomachNotEntered' AND Value IN ('True', '1')
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'OverallNormal')  DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'OverallNormal'

			/*Oesophagus must've been entered to get a diagnoses*/
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'OesophagusNotEntered')  DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'OesophagusNotEntered' AND Value IN ('True', '1')
		END
		ELSE IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Region='Stomach' AND Value IN ('True', '1') AND MatrixCode IN ('StomachNormal', 'StomachNotEntered'))
		BEGIN
				IF @FurthestExtentReached >= @StomachExtent AND @BlockingStricure = 0
				and  @ExtentDescription Not IN ('intubation failed','abandoned')  --only this edited by Mostafizur 3831
				BEGIN
					DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'StomachNotEntered' AND Value IN ('True', '1')
					IF NOT EXISTS (SELECT 1 FROM #tbl_ERS_Diagnoses WHERE MatrixCode = 'StomachNormal' OR MatrixCode = 'OverallNormal')
					BEGIN
						INSERT INTO [ERS_Diagnoses] (ProcedureId, MatrixCode, Value, Region, IsOtherData) VALUES (@ProcedureId, 'StomachNormal', 'True', 'Stomach', 1)
					END
				END
				ELSE
				BEGIN
					DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'StomachNormal' AND Value IN ('True', '1')
					IF NOT EXISTS (SELECT 1 FROM #tbl_ERS_Diagnoses WHERE MatrixCode = 'StomachNotEntered' OR MatrixCode = 'OverallNormal')
					BEGIN
						INSERT INTO [ERS_Diagnoses] (ProcedureId, MatrixCode, Value, Region, IsOtherData) VALUES (@ProcedureId, 'StomachNotEntered', 'True', 'Stomach', 1)
					END
				END
		END
		ELSE IF NOT EXISTS (SELECT 1 FROM #tbl_ERS_Diagnoses WHERE Region = 'Stomach' OR MatrixCode = 'OverallNormal')
		BEGIN
			INSERT INTO [ERS_Diagnoses] (ProcedureId, MatrixCode, Value, Region, IsOtherData) VALUES (@ProcedureId, 'StomachNormal', 'True', 'Stomach', 1)
		END

		/*DUODENUM REGION*/
		IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Region='Duodenum' AND Value IN ('True', '1') AND MatrixCode NOT IN ('DuodenumNormal', 'DuodenumNotEntered'))
		BEGIN
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'DuodenumNormal')  DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'DuodenumNormal' AND Value IN ('True', '1')
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'DuodenumNotEntered')  DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'DuodenumNotEntered' AND Value IN ('True', '1')
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'OverallNormal')   DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'OverallNormal'

			/*Oesophagus and stomach must've been entered to get a diagnoses*/
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'OesophagusNotEntered')  DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'OesophagusNotEntered' AND Value IN ('True', '1')
			IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True', '1') AND MatrixCode = 'StomachNotEntered')  DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'StomachNotEntered' AND Value IN ('True', '1')

		END
		ELSE IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Region='Duodenum' AND Value IN ('True', '1') AND MatrixCode IN ('DuodenumNormal', 'DuodenumNotEntered'))
		BEGIN
			IF @FurthestExtentReached >= @DuodenumExtent AND @BlockingStricure = 0
			and  @ExtentDescription Not IN ('intubation failed','abandoned')  --only this edited by Mostafizur 3831
			BEGIN
				DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'DuodenumNotEntered' AND Value IN ('True', '1')
				IF NOT EXISTS (SELECT 1 FROM #tbl_ERS_Diagnoses WHERE MatrixCode = 'DuodenumNormal' OR MatrixCode = 'OverallNormal')
				BEGIN
					INSERT INTO [ERS_Diagnoses] (ProcedureId, MatrixCode, Value, Region, IsOtherData) VALUES (@ProcedureId, 'DuodenumNormal', 'True', 'Duodenum', 1)
				END
			END
			ELSE
			BEGIN
				DELETE FROM [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'DuodenumNormal' AND Value IN ('True', '1')
				IF NOT EXISTS (SELECT 1 FROM #tbl_ERS_Diagnoses WHERE MatrixCode = 'DuodenumNotEntered' OR MatrixCode = 'OverallNormal')
				BEGIN
					INSERT INTO [ERS_Diagnoses] (ProcedureId, MatrixCode, Value, Region, IsOtherData) VALUES (@ProcedureId, 'DuodenumNotEntered', 'True', 'Duodenum', 1)
				END
			END
		END
		ELSE IF NOT EXISTS (SELECT 1 FROM #tbl_ERS_Diagnoses WHERE Region = 'Duodenum' OR MatrixCode = 'OverallNormal')
		BEGIN
			INSERT INTO [ERS_Diagnoses] (ProcedureId, MatrixCode, Value, Region, IsOtherData) VALUES (@ProcedureId, 'DuodenumNormal', 'True', 'Duodenum', 1)
		END

	END

	IF EXISTS (SELECT 1 FROM #tbl_ERS_Diagnoses ted WHERE Region = 'Oesophagus' AND MatrixCode = 'OesophagusNormal' AND ted.[Value] IN ('True', '1')) AND
			EXISTS (SELECT 1 FROM #tbl_ERS_Diagnoses ted WHERE Region = 'Stomach' AND MatrixCode = 'StomachNormal' AND ted.[Value] IN ('True', '1')) AND
			EXISTS (SELECT 1 FROM #tbl_ERS_Diagnoses ted WHERE Region = 'Duodenum' AND MatrixCode = 'DuodenumNormal' AND ted.[Value] IN ('True', '1')) AND
			NOT EXISTS (SELECT 1 FROM #tbl_ERS_Diagnoses ted WHERE MatrixCode <> 'Summary' AND MatrixCode NOT IN ('OesophagusNormal','StomachNormal','DuodenumNormal'))
	BEGIN
		DELETE FROM ERS_Diagnoses WHERE MatrixCode IN ('OesophagusNormal','StomachNormal','DuodenumNormal')

		INSERT INTO ERS_Diagnoses (ProcedureID, MatrixCode, [Value], IsOtherData)
		VALUES (@ProcedureId, 'OverallNormal', '1', 1)

	END
	

	-- Don't repeat diagnoses
	IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE MatrixCode in ('D39P1', 'D84P1')) DELETE FROM ERS_Diagnoses WHERE MatrixCode = 'D49P1' and ProcedureID = @ProcedureId
	IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE MatrixCode in ('D90P1', 'D91P1')) DELETE FROM ERS_Diagnoses WHERE MatrixCode = 'D53P1' and ProcedureID = @ProcedureId

	DELETE FROM #tbl_ERS_Diagnoses
	INSERT INTO #tbl_ERS_Diagnoses
	(
	    ProcedureID,
	    SiteId,
	    MatrixCode,
	    [Value],
	    Region,
	    IsOtherData
	)
	SELECT  
	    ProcedureID,
	    SiteId,
	    MatrixCode,
	    [Value],
	    Region,
	    IsOtherData 
	FROM ERS_Diagnoses WHERE ProcedureId=@ProcedureId 



    SELECT  RowNum = ROW_NUMBER() OVER(ORDER BY [DiagnosesID]),d.*, convert(varchar(Max), m.DisplayName) AS DisplayName	INTO #Oesophagus	FROM #tbl_ERS_Diagnoses d	LEFT JOIN ERS_DiagnosesMatrix m ON d.matrixcode=m.Code WHERE Region='Oesophagus'	AND [Value] IS NOT NULL AND [Value]<>'False' AND [Value]<>'' AND MatrixCode <>'Summary'
    SELECT  RowNum = ROW_NUMBER() OVER(ORDER BY [DiagnosesID]),d.*, convert(varchar(Max), m.DisplayName) AS DisplayName	INTO #Stomach		FROM #tbl_ERS_Diagnoses d	LEFT JOIN ERS_DiagnosesMatrix m ON d.matrixcode=m.Code WHERE Region='Stomach'		AND [Value] IS NOT NULL AND [Value]<>'False' AND [Value]<>'' AND MatrixCode <>'Summary'
    SELECT  RowNum = ROW_NUMBER() OVER(ORDER BY [DiagnosesID]),d.*, convert(varchar(Max), m.DisplayName) AS DisplayName	INTO #Duodenum		FROM #tbl_ERS_Diagnoses d	LEFT JOIN ERS_DiagnosesMatrix m ON d.matrixcode=m.Code WHERE Region='Duodenum'		AND [Value] IS NOT NULL AND [Value]<>'False' AND [Value]<>'' AND MatrixCode <>'Summary'
	

	--Insert Other Abnormality
	If EXISTS(Select 1 from ERS_CommonAbnoOther CAO join ERS_Sites S On CAO.SiteId = s.SiteId where S.ProcedureId = @ProcedureId)
	BEGIN

		Insert into #Oesophagus (DiagnosesID, DisplayName, SiteId, ProcedureID, MatrixCode)
		SELECT 999, STUFF((
			SELECT DISTINCT ', ' + OA.Diagnoses  
			FROM ERS_OtherAbnormalities OA
			JOIN ERS_CommonAbnoOther CAO ON OA.OtherId = CAO.OtherId
			JOIN ERS_Sites S ON CAO.SiteId = s.SiteId
			JOIN ERS_Regions R ON S.RegionId = R.RegionId
			JOIN ERS_AbnormalitiesMatrixUpperGI AMU ON R.Region = AMU.Region
			WHERE S.ProcedureId = @ProcedureId
			AND AMU.Area = 'Oesophagus'
			AND AMU.ProcedureType = @ProcedureType
			FOR XML PATH('')), 1, 1, '') Code, 2, @ProcedureId, 'D999P0'

		Insert into #Stomach (DiagnosesID, DisplayName, SiteId, ProcedureID, MatrixCode)
		SELECT 999, STUFF((
			SELECT DISTINCT ', ' + OA.Diagnoses  
			FROM ERS_OtherAbnormalities OA
			JOIN ERS_CommonAbnoOther CAO ON OA.OtherId = CAO.OtherId
			JOIN ERS_Sites S ON CAO.SiteId = s.SiteId
			JOIN ERS_Regions R ON S.RegionId = R.RegionId
			JOIN ERS_AbnormalitiesMatrixUpperGI AMU ON R.Region = AMU.Region
			WHERE S.ProcedureId = @ProcedureId
			AND AMU.Area = 'Stomach'
			AND AMU.ProcedureType = @ProcedureType
			FOR XML PATH('')), 1, 1, '') Code, 2, @ProcedureId, 'D999P0'

		Insert into #Duodenum (DiagnosesID, DisplayName, SiteId, ProcedureID, MatrixCode)
		SELECT 999, STUFF((
			SELECT DISTINCT ', ' + OA.Diagnoses  
			FROM ERS_OtherAbnormalities OA
			JOIN ERS_CommonAbnoOther CAO ON OA.OtherId = CAO.OtherId
			JOIN ERS_Sites S ON CAO.SiteId = s.SiteId
			JOIN ERS_Regions R ON S.RegionId = R.RegionId
			JOIN ERS_AbnormalitiesMatrixUpperGI AMU ON R.Region = AMU.Region
			WHERE S.ProcedureId = @ProcedureId
			AND AMU.Area = 'Duodenum'
			AND AMU.ProcedureType = @ProcedureType
			FOR XML PATH('')), 1, 1, '') Code, 2, @ProcedureId, 'D999P0'
	END
	--Delete duplicates
	--DELETE FROM #Oesophagus WHERE RowNum NOT IN (SELECT MIN(RowNum) FROM #Oesophagus GROUP BY MatrixCode)
	--DELETE FROM #Stomach	WHERE RowNum NOT IN (SELECT MIN(RowNum) FROM #Stomach	GROUP BY MatrixCode)
	--DELETE FROM #Duodenum	WHERE RowNum NOT IN (SELECT MIN(RowNum) FROM #Duodenum	GROUP BY MatrixCode)
	--Delete duplicates
	
	--OESOPHAGUS
	INSERT INTO #OesophagusTemp ([cx],[Text]) 	--UNION to exclude duplicates for Abnormalities!
		--'Not Entered' or 'Normal' selected from the diagnoses screen
		SELECT 1, 'not entered' FROM #Oesophagus WHERE MatrixCode = 'OesophagusNotEntered'
		UNION
		SELECT 2, 'normal' FROM #Oesophagus WHERE MatrixCode = 'OesophagusNormal'
		UNION
		SELECT 3, CAST([Value] as Varchar(MAX)) FROM #Oesophagus WHERE MatrixCode = 'OesophagusOtherDiagnosis'
		UNION
		SELECT 0, DisplayName FROM #Oesophagus WHERE SiteId > 0 --Abnormalities for each sites 

	
	--STOMACH          
	INSERT INTO #StomachTemp ([cx],[Text]) 	--UNION to exclude duplicates for Abnormalities!
		--'Not Entered' or 'Normal' selected from the diagnoses screen
		SELECT 1, 'not entered' FROM #Stomach WHERE MatrixCode = 'StomachNotEntered'
		UNION
		SELECT 2, 'normal' FROM #Stomach WHERE MatrixCode = 'StomachNormal'
		UNION
		SELECT 3, CAST([Value] as Varchar(MAX)) FROM #Stomach WHERE MatrixCode = 'StomachOtherDiagnosis'
		UNION
		SELECT 0, DisplayName FROM #Stomach WHERE SiteId > 0 --Abnormalities for each sites 


	--DUODENUM      
	INSERT INTO #DuodenumTemp ([cx],[Text]) 	--UNION to exclude duplicates for Abnormalities!
		--'Not Entered' or 'Normal' selected from the diagnoses screen
		SELECT 1, 'not entered' FROM #Duodenum WHERE MatrixCode = 'DuodenumNotEntered'
		UNION
		SELECT 2, 'normal' FROM #Duodenum WHERE MatrixCode = 'DuodenumNormal'
		UNION
		SELECT 4, '2nd part not entered' FROM #Duodenum WHERE MatrixCode = 'Duodenum2ndPartNotEntered'
		UNION
		SELECT 3, CAST([Value] as Varchar(MAX)) FROM #Duodenum WHERE MatrixCode = 'DuodenumOtherDiagnosis'
		UNION
		SELECT 0, DisplayName FROM #Duodenum WHERE SiteId > 0 --Abnormalities for each sites 

--Determining the OGD diagnoses option set in System Settings
-- 0: Whole upper tract normal
-- 1: Individually Oesophagus normal, Stomach normal, Duodenum normal

	DECLARE @overallStatus AS INT
	IF EXISTS(SELECT 1 FROM #tbl_ERS_Diagnoses WHERE Value = 1 AND MatrixCode = 'OverallNormal')
	BEGIN
		SET @overallStatus = 1
	END
	ELSE
	BEGIN
		SET @overallStatus = 0
	END

	IF @OGDDiagnosisOption = 0 AND @overallStatus = 1
    BEGIN	
		SET @Summary = @Summary + 'Whole upper gastro-intestinal tract normal.<br/>'			
	END
	--edited by mostafiz 2983
	Else If @OGDDiagnosisOption = 1 AND @overallStatus = 1
	Begin

	SET @Summary = @Summary + '<b>Oesophagus: </b>' + 'normal' + '.<br/>'
	SET @Summary = @Summary + '<b>Stomach: </b>' + 'normal' + '.<br/>'
	SET @Summary = @Summary + '<b>Duodenum: </b>' + 'normal' + '.<br/>'
	End 
	--edited by mostafiz 2983

	ELSE 
	BEGIN
		--Oesophagus
		IF EXISTS(select 1 from #OesophagusTemp)
		BEGIN
			SET @XMLlist = (SELECT [text] AS Val FROM #OesophagusTemp FOR XML  RAW, ELEMENTS, TYPE)
			SET @tmpSummary = dbo.fnBuildString(@XMLlist)
			IF @tmpSummary <> '' SET @Summary = @Summary + '<b>Oesophagus: </b>' + @tmpSummary + '.<br/>'
		END
		
		--Stomach 
		IF EXISTS(select 1 from #StomachTemp)
		BEGIN
			SET @XMLlist = (SELECT [text] AS Val FROM #StomachTemp FOR XML  RAW, ELEMENTS, TYPE)
			SET @tmpSummary = dbo.fnBuildString(@XMLlist)
			IF @tmpSummary <> '' SET @Summary = @Summary + '<b>Stomach: </b>' + @tmpSummary + '.<br/>'
		END
		
		--Duodenum 
		IF EXISTS(select 1 from #DuodenumTemp) --AND @ExtentLevelReached = 1
		BEGIN
			SET @XMLlist = (SELECT [text] AS Val FROM #DuodenumTemp FOR XML  RAW, ELEMENTS, TYPE)
			SET @tmpSummary = dbo.fnBuildString(@XMLlist)
			IF @tmpSummary <> '' SET @Summary = @Summary + '<b>Duodenum: </b>' + @tmpSummary + '.<br/>'
		END
		--ELSE
		--IF EXISTS(select 1 from #DuodenumTemp)
		--BEGIN
		--	SET @XMLlist = (SELECT [text] AS Val FROM #DuodenumTemp FOR XML  RAW, ELEMENTS, TYPE)
		--	SET @tmpSummary = dbo.fnBuildString(@XMLlist)
		--	IF @tmpSummary <> '' SET @Summary = @Summary + '<b>Duodenum: </b>' + 'not entered.<br/>'
		--END		
	END	

	--IF EXISTS(SELECT 1 FROM ERS_UpperGIBleeds WHERE ProcedureID = @ProcedureId)
	--BEGIN
	--	SET @Summary = @Summary +'<b>RISK OF REBLEED: </b>' + ISNULL((SELECT [OverallRiskAssessment] FROM ERS_UpperGIBleeds WHERE ProcedureID = @ProcedureId),'') + '. <br/> '
	--END

    DROP TABLE #Oesophagus
    DROP TABLE #OesophagusTemp
    DROP TABLE #Stomach
    DROP TABLE #StomachTemp
    DROP TABLE #Duodenum
    DROP TABLE #DuodenumTemp
END
ELSE IF @ProcedureType IN (3,4,5,9) --Colonoscopy, Sigmoidscopy, Proctoscopy
BEGIN
	IF OBJECT_ID('tempdb..#Colon') IS NOT NULL DROP TABLE #Colon
	IF OBJECT_ID('tempdb..#ColonTemp') IS NOT NULL DROP TABLE #ColonTemp
		create table #ColonTemp ([cx] Int null,	[Text] VARCHAR(MAX) null)

	IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True','1') AND MatrixCode <> 'ColonNormal' )
	BEGIN
		DELETE [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'ColonNormal'
		DELETE #tbl_ERS_Diagnoses WHERE MatrixCode = 'ColonNormal'
	END;

	--Select first row in each group (in case there's more than 1 record for a given MatrixCode)
	WITH colSummary AS (
    SELECT p.DiagnosesID, p.MatrixCode, p.Value, p.Region,
           ROW_NUMBER() OVER(PARTITION BY p.MatrixCode ORDER BY p.DiagnosesID DESC) AS rk
    FROM #tbl_ERS_Diagnoses p)

	SELECT d.*, cast(m.DisplayName as varchar(500)) as DisplayName
	INTO #Colon
	FROM colSummary d 
	LEFT JOIN ERS_DiagnosesMatrix m ON d.matrixcode = m.Code AND m.ProcedureTypeID = @ProcedureType
	WHERE rk = 1 -- Get the first record only
	AND Region = 'Colon'	AND [Value] IS NOT NULL	AND [Value] <> 'False'
	AND [Value] <> ''		AND [Value] <> '0'		--AND MatrixCode <> 'Summary'

	If EXISTS(Select 1 from ERS_CommonAbnoOther CAO join ERS_Sites S On CAO.SiteId = s.SiteId where S.ProcedureId = @ProcedureId)
	BEGIN

		Insert into #Colon (DiagnosesID, DisplayName, MatrixCode)
		SELECT 999, STUFF((
			SELECT DISTINCT ', ' + OA.Diagnoses  
			FROM ERS_OtherAbnormalities OA
			JOIN ERS_CommonAbnoOther CAO ON OA.OtherId = CAO.OtherId
			JOIN ERS_Sites S ON CAO.SiteId = s.SiteId
			WHERE S.ProcedureId = @ProcedureId
			FOR XML PATH('')), 1, 1, '') Code, 'D999P3'
	END

	IF ISNULL((SELECT CASE WHEN Abandoned = 1 OR NED_Abandoned = 1 THEN 1 ELSE 0 END FROM ERS_ColonExtentOfIntubation WHERE ProcedureId = @ProcedureId), 0) = 0
	BEGIN
		INSERT INTO #ColonTemp ([cx],[Text]) 
		SELECT 1, CONVERT(VARCHAR(MAX), 'The examination to the point of insertion was normal.') FROM #Colon WHERE MatrixCode = 'ColonNormal'
		UNION
		SELECT 2, 'The rest of the examination to the point of insertion was normal' FROM #Colon WHERE MatrixCode = 'ColonRestNormal'
	END
	ELSE
	BEGIN
		INSERT INTO #ColonTemp ([cx],[Text]) 
		SELECT 300, CONVERT(VARCHAR(MAX), 'Procedure abandoned')
	END

	INSERT INTO #ColonTemp ([cx],[Text])
	SELECT 4, MatrixCode FROM #Colon WHERE MatrixCode = 'Colitis'
	UNION
	SELECT 5, (SELECT m.DisplayName FROM ERS_DiagnosesMatrix m WHERE m.code= d.Value AND m.ProcedureTypeID = @ProcedureType)  FROM #Colon d WHERE d.MatrixCode = 'ColitisType' AND VALUE NOT IN ('D85P3', 'S85P3', 'P85P3') -- '?85P3' = None specified
	UNION
	SELECT 6, (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Diagnoses Colon Extent' AND [ListItemNo] = Value) FROM #Colon WHERE MatrixCode = 'ColitisExtent'
	UNION
	SELECT 7, (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Mayo Score' AND [ListItemNo] = Value) FROM #Colon WHERE MatrixCode = 'MayoScore'
	UNION
	SELECT 8, (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Simple Endoscopic Score – Crohn''s Disease' AND [ListItemNo] = Value) FROM #Colon WHERE MatrixCode = 'SEScore'
	UNION
	SELECT 9, MatrixCode FROM #Colon WHERE MatrixCode = 'Ileitis'
	UNION
	SELECT 10, MatrixCode FROM #Colon WHERE MatrixCode = 'Proctitis'
	UNION
	SELECT 0, LOWER(DisplayName) FROM #Colon WHERE RIGHT(MatrixCode,2) = 'P3'
	UNION
	SELECT 300, Value FROM #Colon WHERE MatrixCode = 'ColonOtherDiagnosis'
	

	IF EXISTS(select 1 from #ColonTemp)
	BEGIN
		SET @Summary = ''

		IF EXISTS(SELECT 1 FROM #ColonTemp WHERE cx =1) -- no need to check further if "point of insertion was normal"
			SET @Summary = (SELECT TOP 1 [text] from #ColonTemp where cx=1)
		ELSE 
		BEGIN
			--IF EXISTS(SELECT 1 FROM #ColonTemp WHERE cx IN (9)) --Ileitis checked
			--BEGIN
			--	SET @Summary = (SELECT TOP 1 [text] from #ColonTemp where cx=9)
			--END

			IF EXISTS(SELECT 1 FROM #ColonTemp WHERE cx IN (4, 9, 10)) --Colitis checked
			BEGIN
				DECLARE @ck varchar(1000) =''
				DECLARE @ms varchar(1000) = ''
				DECLARE @ses varchar(1000) = ''
				DECLARE @ColitisType VARCHAR(200) = ''
				IF EXISTS(SELECT 1 FROM #ColonTemp WHERE cx =6) 
					SET @ck=  (SELECT CASE @ck WHEN '' THEN (SELECT TOP 1 [text] from #ColonTemp where cx=6) ELSE @ck + ' ' + (SELECT TOP 1 [text] from #ColonTemp where cx=6) END)

				IF EXISTS(SELECT 1 FROM #ColonTemp WHERE cx =7) 
					SET @ms=  (SELECT CASE @ms WHEN '' THEN (SELECT TOP 1 [text] from #ColonTemp where cx=7) ELSE @ms + ' ' + (SELECT TOP 1 [text] from #ColonTemp where cx=7) END)

				IF EXISTS(SELECT 1 FROM #ColonTemp WHERE cx =8) 
					SET @ses=  (SELECT CASE @ses WHEN '' THEN (SELECT TOP 1 [text] from #ColonTemp where cx=8) ELSE @ses + ' ' + (SELECT TOP 1 [text] from #ColonTemp where cx=8) END)
				
				IF EXISTS(SELECT 1 FROM #ColonTemp WHERE cx = 9) --Ileitis checked
				BEGIN
					INSERT INTO #ColonTemp ([cx],[Text])  SELECT 50, 'Ileitis'
				END

				IF EXISTS(SELECT 1 FROM #ColonTemp WHERE cx =5) 
				BEGIN
					SET @ColitisType = ISNULL((SELECT TOP 1 [text] from #ColonTemp where cx=5),'')
				
					IF @ColitisType = '' SET @ColitisType = ISNULL((SELECT TOP 1 [text] from #ColonTemp where cx=4),'')

					IF @ms = '' AND @ses = ''
						SET @ColitisType = @ColitisType + (SELECT CASE @ck WHEN '' THEN '' ELSE ' (' + @ck +')' END)
					ELSE
					BEGIN
						IF @ms <> ''
							SET @ColitisType = @ColitisType + LOWER((SELECT CASE @ms WHEN '' THEN '' ELSE ': ' + @ms  END) + (SELECT CASE @ck WHEN '' THEN '' ELSE ', ' + @ck  END))
						
						IF @ses <> ''
							SET @ColitisType = @ColitisType + LOWER((SELECT CASE @ses WHEN '' THEN '' ELSE ': ' + @ses  END) + (SELECT CASE @ck WHEN '' THEN '' ELSE ', ' + @ck END))
					END
				END
				ELSE SET @ColitisType = LOWER((SELECT TOP 1 [text] from #ColonTemp where cx=4))

				--Concatnate text for colitis (4,5,6,7) and insert into #ColonTemp with id 100
				INSERT INTO #ColonTemp ([cx],[Text])  SELECT 100, @ColitisType

				IF EXISTS(SELECT 1 FROM #ColonTemp WHERE cx = 10) --Ileitis checked
				BEGIN
					INSERT INTO #ColonTemp ([cx],[Text])  SELECT 200, 'Proctitis'
				END
			END

			-- 0 = diag matrix ending with 'P3'  ;  100 = colitis   ;  300 = others
			SET @XMLlist = (SELECT [Text] AS Val FROM #ColonTemp WHERE [cx] in (0,50,100,200,300) ORDER BY [cx] FOR XML  RAW, ELEMENTS, TYPE)
			SET @Summary =  dbo.fnBuildString(@XMLlist) 

			SET @Summary = ISNULL((SELECT TOP 1 [text] + '.<br/>' FROM #ColonTemp WHERE cx=2),'')  + 
					CASE WHEN  @Summary <> '' THEN dbo.fnFirstLetterUpper(@Summary) + '.<br/>' ELSE '' END
		END

	END

	DROP TABLE #Colon
	DROP TABLE #ColonTemp
END
ELSE IF @ProcedureType IN (999) --Colonoscopy, Sigmoidscopy, Proctoscopy
BEGIN
	IF OBJECT_ID('tempdb..#Colon') IS NOT NULL DROP TABLE #ENT
	IF OBJECT_ID('tempdb..#ColonTemp') IS NOT NULL DROP TABLE #ENTTemp
		create table #ENTTemp ([cx] Int null,	[Text] VARCHAR(MAX) null)

	IF EXISTS(SELECT TOP(1) 1 FROM #tbl_ERS_Diagnoses WHERE Value IN ('True','1') AND MatrixCode <> 'ColonNormal' )
	BEGIN
		DELETE [ERS_Diagnoses] WHERE ProcedureID = @ProcedureID AND MatrixCode = 'ColonNormal'
		DELETE #tbl_ERS_Diagnoses WHERE MatrixCode = 'ColonNormal'
	END;

	--Select first row in each group (in case there's more than 1 record for a given MatrixCode)
	WITH colSummary AS (
    SELECT p.DiagnosesID, p.MatrixCode, p.Value, p.Region,
           ROW_NUMBER() OVER(PARTITION BY p.MatrixCode ORDER BY p.DiagnosesID DESC) AS rk
    FROM #tbl_ERS_Diagnoses p)

	SELECT d.*, cast(m.DisplayName as varchar(500)) as DisplayName
	INTO #ENT
	FROM colSummary d 
	LEFT JOIN ERS_DiagnosesMatrix m ON d.matrixcode = m.Code AND m.ProcedureTypeID = @ProcedureType
	WHERE rk = 1 -- Get the first record only
	AND Region = 'Colon'	AND [Value] IS NOT NULL	AND [Value] <> 'False'
	AND [Value] <> ''		AND [Value] <> '0'		--AND MatrixCode <> 'Summary'

	If EXISTS(Select 1 from ERS_CommonAbnoOther CAO join ERS_Sites S On CAO.SiteId = s.SiteId where S.ProcedureId = @ProcedureId)
	BEGIN

		Insert into #ENT (DiagnosesID, DisplayName, MatrixCode)
		SELECT 999, STUFF((
			SELECT DISTINCT ', ' + OA.Diagnoses  
			FROM ERS_OtherAbnormalities OA
			JOIN ERS_CommonAbnoOther CAO ON OA.OtherId = CAO.OtherId
			JOIN ERS_Sites S ON CAO.SiteId = s.SiteId
			WHERE S.ProcedureId = @ProcedureId
			FOR XML PATH('')), 1, 1, '') Code, 'D999P9'
	END

	IF ISNULL((SELECT CASE WHEN Abandoned = 1 OR NED_Abandoned = 1 THEN 1 ELSE 0 END FROM ERS_ColonExtentOfIntubation WHERE ProcedureId = @ProcedureId), 0) = 0
	BEGIN
		INSERT INTO #ENTTemp ([cx],[Text]) 
		SELECT 1, CONVERT(VARCHAR(MAX), 'The examination to the point of insertion was normal.') FROM #ENT WHERE MatrixCode = 'ColonNormal'
		UNION
		SELECT 2, 'The rest of the examination to the point of insertion was normal' FROM #ENT WHERE MatrixCode = 'ColonRestNormal'
	END
	ELSE
	BEGIN
		INSERT INTO #ENTTemp ([cx],[Text]) 
		SELECT 300, CONVERT(VARCHAR(MAX), 'Procedure abandoned')
	END

	INSERT INTO #ENTTemp ([cx],[Text])
	SELECT 4, MatrixCode FROM #ENT WHERE MatrixCode = 'Colitis'
	UNION
	SELECT 5, (SELECT m.DisplayName FROM ERS_DiagnosesMatrix m WHERE m.code= d.Value AND m.ProcedureTypeID = @ProcedureType)  FROM #ENT d WHERE d.MatrixCode = 'ColitisType' AND VALUE NOT IN ('D85P3', 'S85P3', 'P85P3') -- '?85P3' = None specified
	UNION
	SELECT 6, (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Diagnoses Colon Extent' AND [ListItemNo] = Value) FROM #ENT WHERE MatrixCode = 'ColitisExtent'
	UNION
	SELECT 7, (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Mayo Score' AND [ListItemNo] = Value) FROM #ENT WHERE MatrixCode = 'MayoScore'
	UNION
	SELECT 8, (SELECT [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Simple Endoscopic Score – Crohn''s Disease' AND [ListItemNo] = Value) FROM #ENT WHERE MatrixCode = 'SEScore'
	UNION
	SELECT 9, MatrixCode FROM #ENT WHERE MatrixCode = 'Ileitis'
	UNION
	SELECT 10, MatrixCode FROM #ENT WHERE MatrixCode = 'Proctitis'
	UNION
	SELECT 0, LOWER(DisplayName) FROM #ENT WHERE RIGHT(MatrixCode,2) = 'P9'
	UNION
	SELECT 300, Value FROM #ENT WHERE MatrixCode = 'ColonOtherDiagnosis'
	

	IF EXISTS(select 1 from #ENTTemp)
	BEGIN
		SET @Summary = ''

		IF EXISTS(SELECT 1 FROM #ENTTemp WHERE cx =1) -- no need to check further if "point of insertion was normal"
			SET @Summary = (SELECT TOP 1 [text] from #ENTTemp where cx=1)
		ELSE 
		BEGIN
			--IF EXISTS(SELECT 1 FROM #ColonTemp WHERE cx IN (9)) --Ileitis checked
			--BEGIN
			--	SET @Summary = (SELECT TOP 1 [text] from #ColonTemp where cx=9)
			--END

			IF EXISTS(SELECT 1 FROM #ENTTemp WHERE cx IN (4, 9, 10)) --Colitis checked
			BEGIN
				SET @ck =''
				SET @ms = ''
				SET @ses = ''
				SET @ColitisType = ''
				IF EXISTS(SELECT 1 FROM #ENTTemp WHERE cx =6) 
					SET @ck=  (SELECT CASE @ck WHEN '' THEN (SELECT TOP 1 [text] from #ENTTemp where cx=6) ELSE @ck + ' ' + (SELECT TOP 1 [text] from #ENTTemp where cx=6) END)

				IF EXISTS(SELECT 1 FROM #ENTTemp WHERE cx =7) 
					SET @ms=  (SELECT CASE @ms WHEN '' THEN (SELECT TOP 1 [text] from #ENTTemp where cx=7) ELSE @ms + ' ' + (SELECT TOP 1 [text] from #ENTTemp where cx=7) END)

				IF EXISTS(SELECT 1 FROM #ENTTemp WHERE cx =8) 
					SET @ses=  (SELECT CASE @ses WHEN '' THEN (SELECT TOP 1 [text] from #ENTTemp where cx=8) ELSE @ses + ' ' + (SELECT TOP 1 [text] from #ENTTemp where cx=8) END)
				
				IF EXISTS(SELECT 1 FROM #ENTTemp WHERE cx = 9) --Ileitis checked
				BEGIN
					INSERT INTO #ENTTemp ([cx],[Text])  SELECT 50, 'Ileitis'
				END

				IF EXISTS(SELECT 1 FROM #ENTTemp WHERE cx =5) 
				BEGIN
					SET @ColitisType = ISNULL((SELECT TOP 1 [text] from #ENTTemp where cx=5),'')
				
					IF @ColitisType = '' SET @ColitisType = ISNULL((SELECT TOP 1 [text] from #ENTTemp where cx=4),'')

					IF @ms = '' AND @ses = ''
						SET @ColitisType = @ColitisType + (SELECT CASE @ck WHEN '' THEN '' ELSE ' (' + @ck +')' END)
					ELSE
					BEGIN
						IF @ms <> ''
							SET @ColitisType = @ColitisType + LOWER((SELECT CASE @ms WHEN '' THEN '' ELSE ': ' + @ms  END) + (SELECT CASE @ck WHEN '' THEN '' ELSE ', ' + @ck  END))
						
						IF @ses <> ''
							SET @ColitisType = @ColitisType + LOWER((SELECT CASE @ses WHEN '' THEN '' ELSE ': ' + @ses  END) + (SELECT CASE @ck WHEN '' THEN '' ELSE ', ' + @ck END))
					END
				END
				ELSE SET @ColitisType = LOWER((SELECT TOP 1 [text] from #ENTTemp where cx=4))

				--Concatnate text for colitis (4,5,6,7) and insert into #ColonTemp with id 100
				INSERT INTO #ENTTemp ([cx],[Text])  SELECT 100, @ColitisType

				IF EXISTS(SELECT 1 FROM #ENTTemp WHERE cx = 10) --Ileitis checked
				BEGIN
					INSERT INTO #ENTTemp ([cx],[Text])  SELECT 200, 'Proctitis'
				END
			END

			-- 0 = diag matrix ending with 'P3'  ;  100 = colitis   ;  300 = others
			SET @XMLlist = (SELECT [Text] AS Val FROM #ENTTemp WHERE [cx] in (0,50,100,200,300) ORDER BY [cx] FOR XML  RAW, ELEMENTS, TYPE)
			SET @Summary =  dbo.fnBuildString(@XMLlist) 

			SET @Summary = ISNULL((SELECT TOP 1 [text] + '.<br/>' FROM #ENTTemp WHERE cx=2),'')  + 
					CASE WHEN  @Summary <> '' THEN dbo.fnFirstLetterUpper(@Summary) + '.<br/>' ELSE '' END
		END

	END

	DROP TABLE #ENT
	DROP TABLE #ENTTemp
END

--edited by Mostafizur 3774
--IF @ProcedureType IN (13,14)
--BEGIN
--	IF EXISTS (SELECT 1 FROM ers_sites WHERE ProcedureID = @ProcedureID AND (SiteSummary IS NULL OR SiteSummary = ''))
--	BEGIN
--		Set @Summary='Normal Cystoscopy'
		
--		IF EXISTS(SELECT 1 FROM #tbl_ERS_Diagnoses WHERE MatrixCode='Summary') UPDATE [ERS_Diagnoses] SET [Value] = @Summary WHERE Procedureid=@ProcedureID AND MatrixCode='Summary'
--		ELSE INSERT INTO [ERS_Diagnoses] (ProcedureID,MatrixCode,[Value]) VALUES (@ProcedureID,'Summary', @Summary)
--	END
--	ELSE 
--	BEGIN
--	IF EXISTS(SELECT 1 FROM #tbl_ERS_Diagnoses WHERE MatrixCode='Summary') UPDATE [ERS_Diagnoses] SET [Value] = @Summary WHERE Procedureid=@ProcedureID AND MatrixCode='Summary'
--	ELSE INSERT INTO [ERS_Diagnoses] (ProcedureID,MatrixCode,[Value]) VALUES (@ProcedureID,'Summary', @Summary)

--	END
	
--END

--ELSE 
--BEGIN
--IF EXISTS(SELECT 1 FROM #tbl_ERS_Diagnoses WHERE MatrixCode='Summary') UPDATE [ERS_Diagnoses] SET [Value] = @Summary WHERE Procedureid=@ProcedureID AND MatrixCode='Summary'
--ELSE INSERT INTO [ERS_Diagnoses] (ProcedureID,MatrixCode,[Value]) VALUES (@ProcedureID,'Summary', @Summary)

--END
--edited by Mostafizur 3774

UPDATE ERS_ProceduresReporting SET PP_Diagnoses = @Summary WHERE ProcedureId = @ProcedureId

print @Summary

IF ISNULL(@Summary,'') = '' AND NOT EXISTS (SELECT 1 FROM #tbl_ERS_Diagnoses WHERE [Value]<>'False' AND ISNULL([Value],'')<>'' AND MatrixCode <>'Summary')
	DELETE FROM ERS_RecordCount	WHERE [ProcedureId] = @ProcedureId AND [Identifier] = 'Diagnoses'
ELSE
	BEGIN
		IF NOT EXISTS (SELECT 1 FROM ERS_RecordCount WHERE [ProcedureId] = @ProcedureId AND [Identifier] = 'Diagnoses')
			INSERT INTO ERS_RecordCount ([ProcedureId], [SiteId], [Identifier], [RecordCount])
			VALUES (@ProcedureId, NULL, 'Diagnoses', 1)
	END

DROP TABLE #tbl_ERS_Diagnoses

--EXEC procedure_summary_update @procedureID

END TRY

BEGIN CATCH
       DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);
	
       IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;

GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	2983 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	MOSTAFIZUR RAHMAN
-- TFS#	4052
-- Description of change
-- Fixed OGD Normal
------------------------------------------------------------------------------------------------------------------------
GO
EXEC dbo.DropIfExist 
    @ObjectName = 'sites_delete', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[sites_delete]
(
	@SiteId INT
)
AS

SET NOCOUNT ON

DECLARE @ProcedureId INT, @AreaNo INT, @SiteNo INT, @ProcedureType INT

-- AS (08/SEP/2021) - Adding IsLymphNode column to distinguish between EBUS and EBUS BRT subtype of EBUS.
DECLARE @IsLymphNode BIT

BEGIN TRANSACTION

BEGIN TRY
	SELECT @ProcedureId = s.ProcedureId, @AreaNo = s.AreaNo, @SiteNo = s.SiteNo, @ProcedureType = p.ProcedureType, @IsLymphNode = CASE WHEN s.IsLymphNode = 1 THEN 'True' ELSE 'False' END
	FROM ERS_Procedures p
	INNER JOIN ERS_Sites s ON p.ProcedureId = s.ProcedureId
	WHERE s.SiteId = @SiteId

	IF @ProcedureType IN (1, 6, 8) --Gastroscopy, EUS_OGD, ENT Ant
	BEGIN
		DELETE FROM ERS_UpperGIAbnoDeformity WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoAchalasia WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoGastricUlcer WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoGastritis WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoLumen WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoMalignancy WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoPolyps WHERE SiteId = @SiteId
		DELETE FROM ERS_CommonAbnoLesions WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoPostSurgery WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoVarices WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoHiatusHernia WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoOesophagitis WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoBarrett WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoMiscellaneous WHERE SiteId = @SiteId
		DELETE FROM ERS_EUSAbnoMediastinal WHERE SiteId = @SiteId
	END
	ELSE IF @ProcedureType IN (2, 7)   --ERCP, EUS_HPB
	BEGIN
		DELETE FROM ERS_ERCPAbnoDuct WHERE SiteId = @SiteId
		DELETE FROM ERS_ERCPAbnoParenchyma WHERE SiteId = @SiteId
		DELETE FROM ERS_ERCPAbnoAppearance WHERE SiteId = @SiteId
		DELETE FROM ERS_ERCPAbnoDiverticulum WHERE SiteId = @SiteId
		DELETE FROM ERS_ERCPAbnoTumour WHERE SiteId = @SiteId
		DELETE FROM ERS_ERCPAbnoIntrahepatic WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoVarices WHERE SiteId = @SiteId
		IF EXISTS (SELECT TOP 1 Id FROM ERS_ERCPTherapeutics WHERE SiteId = @SiteId)
		BEGIN
			DECLARE @TherapeuticId INT
			SET @TherapeuticId = (SELECT TOP 1 Id FROM ERS_ERCPTherapeutics WHERE SiteId = @SiteId)
			DELETE FROM ERS_ERCPTherapeuticStentInsertions WHERE TherapeuticId = @TherapeuticId
			DELETE FROM ERS_ERCPTherapeutics WHERE SiteId = @SiteId
		END
		DELETE FROM ERS_EUSAbnoMediastinal WHERE SiteId = @SiteId
	END
	ELSE IF @ProcedureType IN (3,4,5,9)   --Colonoscopy, Sigmoidscopy, Proctoscopy, ENT Retro
	BEGIN
		DELETE FROM ERS_ColonAbnoMucosa WHERE SiteId = @SiteId
		DELETE FROM ERS_ColonAbnoVascularity WHERE SiteId = @SiteId
		DELETE FROM ERS_CommonAbnoLesions WHERE SiteId = @SiteId
		DELETE FROM ERS_ColonAbnoDiverticulum WHERE SiteId = @SiteId
		DELETE FROM ERS_ColonAbnoHaemorrhage WHERE SiteId = @SiteId
		DELETE FROM ERS_ColonAbnoPerianalLesions WHERE SiteId = @SiteId
		DELETE FROM ERS_ColonAbnoCalibre WHERE SiteId = @SiteId
		DELETE FROM ERS_ColonAbnoMiscellaneous WHERE SiteId = @SiteId
		DELETE FROM ERS_UpperGIAbnoVarices WHERE SiteId = @SiteId
		if exists(select 1 FROM ERS_ColonAbnoTumour WHERE SiteId = @SiteId)
			DELETE FROM ERS_ColonAbnoTumour WHERE SiteId = @SiteId
	END
	ELSE IF @ProcedureType IN (10)
	BEGIN
		DELETE FROM dbo.ERS_BRTAbnoDescriptions WHERE SiteId = @SiteId
	END

	ELSE IF @ProcedureType IN (11)
	BEGIN
		IF @IsLymphNode = 'True'
			DELETE FROM dbo.ERS_EBUSAbnoDescriptions WHERE SiteId = @SiteId
		ELSE
			DELETE FROM dbo.ERS_BRTAbnoDescriptions WHERE SiteId = @SiteId
	END

	DELETE FROM ERS_CommonAbnoDiverticulum WHERE SiteId = @SiteId
	DELETE FROM dbo.ERS_ProcedureDICAScores WHERE SiteId = @SiteId
	DELETE FROM ERS_CommonAbnoTumour WHERE SiteId = @SiteId		
	DELETE FROM ERS_CommonAbnoDuodenitis WHERE SiteId = @SiteId	
	DELETE FROM ERS_CommonAbnoDuodenalUlcer WHERE SiteId = @SiteId
	DELETE FROM ERS_CommonAbnoScaring WHERE SiteId = @SiteId	
	DELETE FROM ERS_CommonAbnoVascularLesions WHERE SiteId = @SiteId	
	DELETE FROM ERS_CommonAbnoAtrophic WHERE SiteId = @SiteId

	DELETE FROM ERS_CommonAbnoOther WHERE SiteId = @SiteId

	DELETE FROM ERS_UpperGISpecimens WHERE SiteId = @SiteId
	DELETE FROM ERS_BRTSpecimens WHERE SiteId = @SiteId
	DELETE FROM ERS_UpperGITherapeutics WHERE SiteId = @SiteId		

	DELETE FROM ERS_Photos WHERE SiteId = @SiteId

	DELETE FROM ERS_RecordCount WHERE SiteId = @SiteId	

	IF @AreaNo > 0 AND @SiteNo > 0 --Main Site of an Area
		DELETE FROM ERS_Sites WHERE ProcedureId = @ProcedureId AND AreaNo = @AreaNo 
	ELSE
		DELETE FROM ERS_Sites WHERE SiteId = @SiteId

	IF EXISTS (SELECT 1 FROM ERS_Diagnoses WHERE ProcedureId = @ProcedureId AND ( SiteId = @SiteId OR SiteId IS NULL )) --EDITED BY MOSTAFIZ 4052
	BEGIN
		DELETE FROM ERS_Diagnoses WHERE ProcedureId = @ProcedureId  AND (SiteId = @SiteId OR SiteId IS NULL) --EDITED BY MOSTAFIZ 4052
		EXEC ogd_diagnoses_summary_update @ProcedureId
	END

	EXEC sites_reorder @ProcedureId
	EXEC procedure_summary_update @ProcedureId
END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;

GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	4052 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea
-- TFS#	3839
-- Description of change
-- Flexi bowel prep scores are now optional based on extent reached
------------------------------------------------------------------------------------------------------------------------
GO

EXEC dbo.DropIfExist @ObjectName = 'procedure_bowel_prep_completion_check',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE dbo.procedure_bowel_prep_completion_check
(
	@ProcedureId INT,
	@BowelPrepId INT = NULL,
	@LeftScore INT = NULL,
	@RightScore INT = NULL,
	@TransverseScore INT = NULL
)
AS	
BEGIN
	IF @BowelPrepId IS NULL 
	BEGIN
	    SELECT @LeftScore = LeftPrepScore, @RightScore = RightPrepScore, @TransverseScore = TransversePrepScore, @BowelPrepId = BowelPrepId FROM dbo.ERS_ProcedureBowelPrep WHERE ProcedureId = @ProcedureId
	END

	DECLARE @Summary VARCHAR(200) = 'Bowel prep'
    DECLARE @ProcedureTypeId INT = (SELECT ProcedureType FROM dbo.ERS_Procedures WHERE ProcedureId = @ProcedureId)
	DECLARE @ExtentId INT = (SELECT TOP 1 pe.ExtentId FROM dbo.ERS_ProcedureLowerExtent pe WHERE pe.ProcedureId = @ProcedureId)
	DECLARE @SplenicFlexureId INT = (SELECT UniqueId FROM dbo.ERS_Extent WHERE NEDTerm = 'Splenic flexure')
	DECLARE @HepaticFlexureId INT = (SELECT UniqueId FROM dbo.ERS_Extent WHERE NEDTerm = 'Hepatic flexure')

	/*For colonoscopy and flexi sig, where the extent is ‘anastamosis’, 
	‘ileo-colon anastamosis’ or ‘neo-terminal ileum’, segmental BBPS scores 
	or a total BBPS score is no longer mandated.*/
	IF EXISTS (SELECT 1 FROM dbo.ERS_ProcedureLowerExtent pe WHERE pe.ProcedureId = @ProcedureId AND pe.ExtentId IN (
		SELECT e.UniqueId FROM dbo.ERS_Extent e WHERE e.NEDTerm IN ('Ileo-colon anastomosis','Neo-terminal ileum','Terminal ileum','Anastomosis')))
			BEGIN
				EXEC UI_update_procedure_summary   @ProcedureId, 'Bowel Prep', @Summary, 1	
			END
	ELSE
	BEGIN
		IF (@BowelPrepId = (SELECT bp.UniqueId FROM dbo.ERS_BowelPrep bp WHERE bp.NEDTerm = 'No preparation'))
			EXEC UI_update_procedure_summary   @ProcedureId, 'Bowel Prep', @Summary, 1	
		ELSE IF @ProcedureTypeId = 3 AND (@LeftScore > -1 AND @RightScore > -1 AND @TransverseScore > -1)
			EXEC UI_update_procedure_summary   @ProcedureId, 'Bowel Prep', @Summary, 1	
		ELSE IF @ProcedureTypeId = 4 AND @LeftScore > -1 
		BEGIN
			IF (@ExtentId < @HepaticFlexureId) --if extent if beyond hepatic flexure, it must have a transverse and right score
			BEGIN
				IF (ISNULL(@TransverseScore,-1) > -1 AND ISNULL(@RightScore,-1) > -1)
				BEGIN
	    			EXEC UI_update_procedure_summary   @ProcedureId, 'Bowel Prep', @Summary, 1	
				END
				ELSE IF (ISNULL(@TransverseScore,-1) = -1 OR ISNULL(@RightScore,-1) = -1)
				BEGIN
	    			EXEC UI_update_procedure_summary   @ProcedureId, 'Bowel Prep', @Summary, 0	
				END
			END
			ELSE IF (@ExtentId < @SplenicFlexureId) --if extent if beyond splenic flexure, it must have a transverse score
			BEGIN
				IF ISNULL(@TransverseScore,-1) > -1
				BEGIN
	    			EXEC UI_update_procedure_summary   @ProcedureId, 'Bowel Prep', @Summary, 1	
				END
				ELSE
				BEGIN
	    			EXEC UI_update_procedure_summary   @ProcedureId, 'Bowel Prep', @Summary, 0	
				END
			END
			ELSE
			BEGIN
				EXEC UI_update_procedure_summary   @ProcedureId, 'Bowel Prep', @Summary, 1	
			END
		END
		ELSE
			EXEC UI_update_procedure_summary   @ProcedureId, 'Bowel Prep', @Summary, 0	
	END
END
GO


SET QUOTED_IDENTIFIER ON
SET ANSI_NULLS ON
GO

ALTER procedure [dbo].[procedure_bowel_prep_save]
(
	@ProcedureId int,
	@BowelPrepId int,
	@LeftScore int,
	@RightScore int,
	@TransverseScore int,
	@TotalScore int,
	@Quantity decimal(18,2),
	@EnemaId int,
	@EnemaOther varchar(200),
	@AdditionalInfo varchar(max),
	@LoggedInUserId int
)
AS
BEGIN
	IF @BowelPrepId >0 
	BEGIN
	    /*Check if new values been */
	    	IF ISNULL(@AdditionalInfo,'') <> ''
	    	BEGIN
	    		IF NOT EXISTS (SELECT 1 FROM ERS_BowelPrep WHERE Description = @AdditionalInfo)
	    		BEGIN
	    			/*get and set the new items order id so it appears 1 above 'other' we always want other to be last*/
	    
	    			DECLARE @OtherListOrderBy int = (SELECT ListOrderBy FROM ERS_BowelPrep WHERE Description = 'Other')
	    			INSERT INTO ERS_BowelPrep (Description, NEDTerm, ListOrderBy) VALUES (@AdditionalInfo, 'Other', @OtherListOrderBy)
	    			
	    			UPDATE dbo.ERS_BowelPrep SET ListOrderBy = @OtherListOrderBy + 1 WHERE Description = 'Other'
	    		END
	    
	    		SELECT @BowelPrepId = UniqueId FROM ERS_BowelPrep WHERE Description = @AdditionalInfo
	    	END
	    
	    	/*Check if new values been */
	    	IF ISNULL(@EnemaOther,'') <> ''
	    	BEGIN
	    		IF NOT EXISTS (SELECT 1 FROM ERS_BowelPrepEnemas WHERE Description = @EnemaOther)
	    		BEGIN
	    			/*get and set the new items order id so it appears 1 above 'other' we always want other to be last*/
	    
	    			DECLARE @EOtherListOrderBy int = (SELECT ListOrderBy FROM ERS_BowelPrepEnemas WHERE Description = 'Other')
	    			INSERT INTO ERS_BowelPrepEnemas (Description, NEDTerm, ListOrderBy) VALUES (@EnemaOther, 'Other', @EOtherListOrderBy)
	    			
	    			UPDATE dbo.ERS_BowelPrepEnemas SET ListOrderBy = @EOtherListOrderBy + 1 WHERE Description = 'Other'
	    		END
	    
	    		SELECT @EnemaId = UniqueId FROM ERS_BowelPrepEnemas WHERE Description = @EnemaOther
	    	END
	    
	    	IF NOT EXISTS (SELECT 1 FROM ERS_ProcedureBowelPrep WHERE ProcedureId = @ProcedureId)
	    	BEGIN
	    		INSERT INTO ERS_ProcedureBowelPrep (ProcedureId, BowelPrepId, Quantity, LeftPrepScore, RightPrepScore, TransversePrepScore, TotalPrepScore, AdditionalInfo, EnemaId, WhoCreatedId, WhenCreated)
	    		VALUES (@ProcedureId, @BowelPrepId, @Quantity, NULLIF(@LeftScore, -1), NULLIF(@RightScore, -1), NULLIF(@TransverseScore,-1), NULLIF(@TotalScore, -1), '', @EnemaId, @LoggedInUserId, getdate())
	    	END
	    	ELSE
	    	BEGIN
	    		UPDATE ERS_ProcedureBowelPrep
	    		SET BowelPrepId = NULLIF(@BowelPrepId,0),
	    			Quantity = @Quantity,
	    			LeftPrepScore = NULLIF(@LeftScore, -1),
	    			RightPrepScore = NULLIF(@RightScore, -1),
	    			TransversePrepScore = NULLIF(@TransverseScore, -1),
	    			TotalPrepScore = NULLIF(@TotalScore, -1),
	    			AdditionalInfo = @AdditionalInfo,
	    			EnemaId = @EnemaId,
	    			WhoUpdatedId = @LoggedInUserId,
	    			WhenUpdated = getdate()
	    		WHERE ProcedureId = @ProcedureId
	    	END
	END
	ELSE
	BEGIN
	    DELETE FROM dbo.ERS_ProcedureBowelPrep WHERE ProcedureId =@ProcedureId
	END
	

	DECLARE @Summary VARCHAR(max), 
			@BowelPrepFormula varchar(max) = (SELECT [Description] FROM ERS_BowelPrep WHERE UniqueId = @BowelPrepId) + 
				CASE WHEN ISNULL(@EnemaId,0) > 0 THEN ' + ' + (SELECT [Description] FROM dbo.ERS_BowelPrepEnemas WHERE UniqueId = @EnemaId) ELSE '' END +
				CASE WHEN ISNULL(@Quantity,0) > 0 THEN ' (Volume ' + CONVERT(varchar(10), convert(int, @Quantity))  + ')' ELSE '' END

	
	SET @Summary = @BowelPrepFormula + '. '
	
	IF NULLIF(@TotalScore, -1) IS NOT NULL 
	BEGIN
		SET @Summary = @Summary + ' Boston Bowel Prep Total Score ' +  cast( @TotalScore as varchar(10))
	END 

	--UPDATE  [ERS_BowelPreparation] SET Summary = @Summary WHERE ProcedureID=@ProcedureId
	UPDATE [ERS_ProceduresReporting] SET [PP_Bowel_Prep] = @Summary WHERE ProcedureID=@ProcedureId
	EXEC procedure_summary_update @ProcedureId

	DECLARE @SectionId int = (SELECT UISectionId FROM UI_Sections WHERE SectionName = 'Bowel Prep')

	DELETE FROM ERS_ProcedureSummary WHERE ProcedureId = @ProcedureId AND SectionId = @SectionId
	
	--validate completion
	IF @BowelPrepId > 0
	BEGIN
		--check extent for completion rules
		DECLARE @ProcedureTypeId INT = (SELECT ProcedureType FROM dbo.ERS_Procedures WHERE ProcedureId = @ProcedureId)
		
		/*For colonoscopy and flexi sig, where the extent is ‘anastamosis’, 
		‘ileo-colon anastamosis’ or ‘neo-terminal ileum’, segmental BBPS scores 
		or a total BBPS score is no longer mandated.*/
		IF EXISTS (SELECT 1 FROM dbo.ERS_ProcedureLowerExtent pe WHERE pe.ProcedureId = @ProcedureId AND pe.ExtentId IN (
			SELECT e.UniqueId FROM dbo.ERS_Extent e WHERE e.NEDTerm IN ('Ileo-colon anastomosis','Neo-terminal ileum','Terminal ileum','Anastomosis')))
				BEGIN
				    EXEC UI_update_procedure_summary   @ProcedureId, 'Bowel Prep', @Summary, 1	
				END
		ELSE
			BEGIN
			    IF (@BowelPrepId = (SELECT bp.UniqueId FROM dbo.ERS_BowelPrep bp WHERE bp.NEDTerm = 'No preparation'))
					EXEC UI_update_procedure_summary   @ProcedureId, 'Bowel Prep', @Summary, 1	
				ELSE IF @ProcedureTypeId = 3 AND (@LeftScore > -1 AND @RightScore > -1 AND @TransverseScore > -1)
					EXEC UI_update_procedure_summary   @ProcedureId, 'Bowel Prep', @Summary, 1	
				ELSE IF @ProcedureTypeId = 4 AND @LeftScore > -1 
				BEGIN
					DECLARE @ExtentId INT = (SELECT TOP 1 pe.ExtentId FROM dbo.ERS_ProcedureLowerExtent pe WHERE pe.ProcedureId = @ProcedureId ORDER BY pe.ExtentId desc) --this will get the furtherst extent
					DECLARE @SplenicFlexureId INT = (SELECT UniqueId FROM dbo.ERS_Extent WHERE NEDTerm = 'Splenic flexure')
					DECLARE @HepaticFlexureId INT = (SELECT UniqueId FROM dbo.ERS_Extent WHERE NEDTerm = 'Hepatic flexure')

					IF (@ExtentId < @HepaticFlexureId) --if extent if beyond hepatic flexure, it must have a transverse and right score
					BEGIN
						IF (ISNULL(@TransverseScore,-1) > -1 AND ISNULL(@RightScore,-1) > -1)
						BEGIN
	    					EXEC UI_update_procedure_summary   @ProcedureId, 'Bowel Prep', @Summary, 1	
						END
						ELSE IF (ISNULL(@TransverseScore,-1) = -1 OR ISNULL(@RightScore,-1) = -1)
						BEGIN
	    					EXEC UI_update_procedure_summary   @ProcedureId, 'Bowel Prep', @Summary, 0	
						END
					END
					ELSE IF (@ExtentId < @SplenicFlexureId) --if extent if beyond splenic flexure, it must have a transverse score
					BEGIN
						IF ISNULL(@TransverseScore,-1) > -1
						BEGIN
	    					EXEC UI_update_procedure_summary   @ProcedureId, 'Bowel Prep', @Summary, 1	
						END
						ELSE
						BEGIN
	    					EXEC UI_update_procedure_summary   @ProcedureId, 'Bowel Prep', @Summary, 0	
						END
					END
					ELSE
					BEGIN
						EXEC UI_update_procedure_summary   @ProcedureId, 'Bowel Prep', @Summary, 1	
					END
				END
				ELSE
					EXEC UI_update_procedure_summary   @ProcedureId, 'Bowel Prep', @Summary, 0	
			END
			
	END

	
END
GO



dbo.DropIfExist
    @ObjectName = 'procedure_lower_extent_save',
    @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[procedure_lower_extent_save]
(
	@ProcedureId int,
	@ExtentId int,
	@AdditionalInfo varchar(max),
	@EndoscopistId int,
	@ConfirmedById int,
	@ConfirmedByOther varchar(200),
	@CaecumIdentifiedById int,
	@LimitationId int,
	@DifficultyEncounteredId int,
	@DifficultyOther varchar(200),
	@PR int,
	@Retroflexion int,
	@NoRetroflexionReason VARCHAR(150),
	@InsertionVia int,
	@LimitationOther varchar(max),
	@ProcedureAbandoned bit, 
	@IntubationFailed bit,
	@LoggedInUserId INT
)
AS
BEGIN TRANSACTION

BEGIN TRY
	/*Check if new values been for confirmed by*/
	IF ISNULL(@ConfirmedByOther,'') <> ''
	BEGIN
		IF NOT EXISTS (SELECT 1 FROM dbo.ERS_ExtentConfirmedByList WHERE Description = @ConfirmedByOther)
		BEGIN
			/*get and set the new items order id so it appears 1 above 'other' we always want other to be last*/

			DECLARE @OtherListOrderBy int = (SELECT ListOrderBy FROM ERS_ExtentConfirmedByList WHERE Description = 'Other')
			INSERT INTO ERS_ExtentConfirmedByList (Description, NEDTerm, ListOrderBy, LimitationReason) VALUES (@ConfirmedByOther, 'Other', @OtherListOrderBy, 1)
			
			UPDATE dbo.ERS_ExtentConfirmedByList SET ListOrderBy = @OtherListOrderBy + 1 WHERE Description = 'Other'
		END

		SELECT @ConfirmedById = UniqueId FROM ERS_ExtentConfirmedByList WHERE Description = @ConfirmedByOther
	END

	/*Check if new values been added for limitations */
	IF ISNULL(@LimitationOther,'') <> ''
	BEGIN
		IF NOT EXISTS (SELECT 1 FROM dbo.ERS_Limitations WHERE Description = @LimitationOther)
		BEGIN
			/*get and set the new items order id so it appears 1 above 'other' we always want other to be last*/

			DECLARE @OtherListOrderBy_l int = (SELECT ListOrderBy FROM ERS_Limitations WHERE Description = 'Other')
			INSERT INTO ERS_Limitations (Description, NEDTerm, ListOrderBy) VALUES (@LimitationOther, 'Other', @OtherListOrderBy_l)
			
			UPDATE dbo.ERS_Limitations SET ListOrderBy = @OtherListOrderBy_l + 1 WHERE Description = 'Other'
		

		SELECT @LimitationId = UniqueId FROM ERS_Limitations WHERE Description = @LimitationOther
		
		DECLARE @ProcTypeId int = (SELECT ProcedureType FROM ERS_Procedures WHERE ProcedureId = @ProcedureId)
		INSERT INTO ERS_LimitationProcedureTypes (ProcedureTypeId, LimitationId) VALUES (@ProcTypeId, @LimitationId)
		END
		ELSE
			SELECT @LimitationId = UniqueId FROM ERS_Limitations WHERE Description = @LimitationOther
	END 

	/*Check if new values been added for limitations */
	IF ISNULL(@DifficultyOther,'') <> ''
	BEGIN
		IF NOT EXISTS (SELECT 1 FROM dbo.ERS_ExtentDifficultiesEncountered WHERE Description = @DifficultyOther)
		BEGIN
			/*get and set the new items order id so it appears 1 above 'other' we always want other to be last*/

			DECLARE @OtherListOrderBy_d int = (SELECT ListOrderBy FROM ERS_ExtentDifficultiesEncountered WHERE Description = 'Other')
			INSERT INTO ERS_ExtentDifficultiesEncountered (Description, NEDTerm, ListOrderBy) VALUES (@DifficultyOther, 'Other', @OtherListOrderBy_d)
			
			UPDATE dbo.ERS_ExtentDifficultiesEncountered SET ListOrderBy = @OtherListOrderBy_d + 1 WHERE Description = 'Other'
			

			SELECT @DifficultyEncounteredId = UniqueId FROM ERS_ExtentDifficultiesEncountered WHERE Description = @DifficultyOther
		END
		ELSE
		BEGIN
			SELECT @DifficultyEncounteredId = UniqueId FROM ERS_ExtentDifficultiesEncountered WHERE Description = @DifficultyOther
		END

	END

	IF NOT EXISTS (SELECT 1 FROM ERS_ProcedureLowerExtent WHERE ProcedureId = @ProcedureId AND EndoscopistId = @EndoscopistId)
	BEGIN
		INSERT INTO ERS_ProcedureLowerExtent (ProcedureId, ExtentId, AdditionalInfo, EndoscopistId, ConfirmedById, CaecumIdentifiedById, LimitationId, LimitationOther,
											  DifficultiesEncounteredId,RectalExamPerformed, RetroflectionPerformed, InsertionAccessViaId, Abandoned, IntubationFailed,
											  WhoUpdatedId, WhenUpdated,NoRetroflectionReason)
		VALUES (@ProcedureId, NULLIF(@ExtentId, 0), @AdditionalInfo, @EndoscopistId, NULLIF(@ConfirmedById,0), NULLIF(@CaecumIdentifiedById,0), NULLIF(@LimitationId,0), @LimitationOther,
				NULLIF(@DifficultyEncounteredId,0), NULLIF(@PR, -1), NULLIF(@Retroflexion, -1), NULLIF(@InsertionVia,0),
				ISNULL(@ProcedureAbandoned,CONVERT(bit,0)), 
				ISNULL(@IntubationFailed,CONVERT(bit,0)), @LoggedInUserId, getdate(),@NoRetroflexionReason)
	END
	ELSE
	BEGIN
		UPDATE ERS_ProcedureLowerExtent
		SET 
			ExtentId = NULLIF(@ExtentId,0),
			AdditionalInfo = @AdditionalInfo,
			EndoscopistId = @EndoscopistId,
			ConfirmedById = NULLIF(@ConfirmedById,0),
			CaecumIdentifiedById = NULLIF(@CaecumIdentifiedById,0),
			LimitationId = NULLIF(@LimitationId,0),
			LimitationOther = @LimitationOther,
			DifficultiesEncounteredId = NULLIF(@DifficultyEncounteredId,0),
			RectalExamPerformed = NULLIF(@PR, -1),
			RetroflectionPerformed = NULLIF(@Retroflexion, -1),
			NoRetroflectionReason = @NoRetroflexionReason,
			InsertionAccessViaId = NULLIF(@InsertionVia,0),
			Abandoned = ISNULL(@ProcedureAbandoned,CONVERT(bit,0)),
			IntubationFailed = ISNULL(@IntubationFailed,CONVERT(bit,0)),
			WhoUpdatedId = @LoggedInUserId,
			WhenUpdated = getdate()
		WHERE 
			ProcedureId = @ProcedureId AND
			EndoscopistId = @EndoscopistId
	END

	EXEC procedure_lower_extent_summary_update @ProcedureId, @EndoscopistId

	DECLARE @ProcedureTypeId INT = (SELECT ProcedureType FROM ERS_Procedures WHERE ProcedureId = @ProcedureId)
	IF @ProcedureTypeId = 4 
	BEGIN
	    EXEC procedure_bowel_prep_completion_check @ProcedureId
	END

END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;
GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO


------------------------------------------------------------------------------------------------------------------------
-- Updated by	: Andrea 04.06.24	
-- TFS#	4138
-- Description of change
-- correct saving of empty insertion technique
------------------------------------------------------------------------------------------------------------------------
GO

SET QUOTED_IDENTIFIER ON
SET ANSI_NULLS ON
GO
ALTER PROCEDURE [dbo].[procedure_insertion_technique_save]
(
	@ProcedureId int,
	@InsertionTechniqueId int,
	@LoggedInUserId int
)
AS
BEGIN
	IF @InsertionTechniqueId > 0 
	BEGIN
	    IF NOT EXISTS (SELECT 1 FROM ERS_ProcedureInsertionTechnique WHERE ProcedureId = @ProcedureId)
	    BEGIN
	    	INSERT INTO ERS_ProcedureInsertionTechnique (ProcedureId, InsertionTechniqueId, WhoCreatedId, WhenCreated)
	    	VALUES (@ProcedureId, @InsertionTechniqueId, @LoggedInUserId, getdate())
	    END
	    ELSE
	    BEGIN
	    	UPDATE ERS_ProcedureInsertionTechnique
	    	SET InsertionTechniqueId = @InsertionTechniqueId
	    	WHERE ProcedureId = @ProcedureId
	    END
	    
	    DECLARE @Summary VARCHAR(max) = 'Insertion technique:'
	    EXEC UI_update_procedure_summary @ProcedureId, 'Insertion techniques', @Summary, @InsertionTechniqueId
	END
	ELSE
	BEGIN
	    DELETE FROM ERS_ProcedureInsertionTechnique WHERE ProcedureId = @ProcedureId
	    EXEC UI_update_procedure_summary @ProcedureId, 'Insertion techniques', @Summary, 0
	END
END
GO



------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 04.06.24
-- TFS#	3914
-- Description of change
-- Extent limitation of food added
------------------------------------------------------------------------------------------------------------------------
GO

IF NOT EXISTS (SELECT 1 FROM dbo.ERS_Limitations WHERE Description = 'Food')
BEGIN
    INSERT INTO ERS_Limitations (Description, NEDTerm, AdditionalInfo, ListOrderBy, Suppressed)
	VALUES ('Food', 'Other', 0, NULL, 0)

	INSERT INTO ERS_LimitationProcedureTypes (LimitationId, ProcedureTypeId)
	VALUES (SCOPE_IDENTITY(), 1)
END
GO


ALTER PROCEDURE [dbo].[limitations_select]
(
	@ProcedureTypeId int
)
AS
BEGIN
	SELECT UniqueId, Description, AdditionalInfo
	FROM ERS_Limitations l
		INNER JOIN ERS_LimitationProcedureTypes pt on l.UniqueId = pt.LimitationId
	WHERE ProcedureTypeId = @ProcedureTypeId AND Suppressed = 0
	ORDER BY ISNULL(ListOrderBy, 999), l.Description
END
GO


------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	MOSTAFIZUR RAHMAN
-- TFS#	4084
-- Description of change
-- GOJ in clinical reprot 
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 12.07.24
-- TFS#	Issue 111
-- Description of change
-- Diagnoses set based on the extent 
------------------------------------------------------------------------------------------------------------------------
EXEC dbo.DropIfExist 
    @ObjectName = 'procedure_upper_extent_save', 
    @ObjectTypePrefix = 'S' 
GO

CREATE  PROCEDURE [dbo].[procedure_upper_extent_save]
(
	@ProcedureId int,
	@ExtentId int,
	@AdditionalInfo varchar(max),
	@EndoscopistId int,
	@JManoeuvreId int, 
	@LimitedById int, 
	@WithdrawalMins int,
	@MucosalJunctionDistance int,
	@LimitationOther varchar(max),
	@LoggedInUserId int
)
AS
/*
--	Update History
01.			04 Jan 2023		MH added Order Message Send block while saving Extent of Intubation TFS #2475
							No extra parameter required. ProcedureId will have associated OrderId and Extent Limited By value
02.			21 March 2023	AJ j manouver handled if -1 (not specified)
03.			27 March 2023	AJ Set sections as not entered based on the extent reached
04.			08 June 2023	SG Add call to ogd_diagnoses_summary_update to ensure report gets populated with Normal if no abnormalities are added
05.         08 Nov 2023     MS Add MucosalJunctionDistance column and related logic
06.         12 July 2024    AJ Diagnoses set based on the extent
							
*/
BEGIN
	Declare @bitHasProcedureFailed as bit
	Set @bitHasProcedureFailed = 0

	IF NOT EXISTS (SELECT 1 FROM ERS_ProcedureUpperExtent WHERE ProcedureId = @ProcedureId AND EndoscopistId = @EndoscopistId)
	BEGIN
		INSERT INTO ERS_ProcedureUpperExtent (ProcedureId, ExtentId, AdditionalInfo, EndoscopistId, JManoeuvreId, LimitationId, MucosalJunctionDistance, WhoUpdatedId, WhenUpdated, LimitationOther)
		VALUES (@ProcedureId, NULLIF(@ExtentId,0), NULLIF(@AdditionalInfo,''), @EndoscopistId, NULLIF(@JManoeuvreId,-1), NULLIF(@LimitedById,0), NULLIF(@MucosalJunctionDistance,0), @LoggedInUserId, getdate(), NULLIF(@LimitationOther,''))
	END
	ELSE
	BEGIN

		/*Check if new values been added for limitations */
		IF ISNULL(@LimitationOther,'') <> ''
		BEGIN
			IF NOT EXISTS (SELECT 1 FROM dbo.ERS_Limitations WHERE Description = @LimitationOther)
			BEGIN
				/*get and set the new items order id so it appears 1 above 'other' we always want other to be last*/

				DECLARE @OtherListOrderBy_l int = (SELECT ListOrderBy FROM ERS_Limitations WHERE Description = 'Other')
				INSERT INTO ERS_Limitations (Description, NEDTerm, ListOrderBy) VALUES (@LimitationOther, 'Other', @OtherListOrderBy_l)
			
				UPDATE dbo.ERS_Limitations SET ListOrderBy = @OtherListOrderBy_l + 1 WHERE Description = 'Other'
		

			SELECT @LimitedById = UniqueId FROM ERS_Limitations WHERE Description = @LimitationOther
		
			DECLARE @ProcTypeId int = (SELECT ProcedureType FROM ERS_Procedures WHERE ProcedureId = @ProcedureId)
			INSERT INTO ERS_LimitationProcedureTypes (ProcedureTypeId, LimitationId) VALUES (@ProcTypeId, @LimitedById)
			END
			ELSE
				SELECT @LimitedById = UniqueId FROM ERS_Limitations WHERE Description = @LimitationOther
		END 

		UPDATE ERS_ProcedureUpperExtent
		SET 
			ExtentId = NULLIF(@ExtentId,0),
			AdditionalInfo = NULLIF(@AdditionalInfo,''),
			EndoscopistId = @EndoscopistId,
			JManoeuvreId = NULLIF(@JManoeuvreId,-1),
			LimitationId = NULLIF(@LimitedById,0),
			MucosalJunctionDistance = NULLIF(@MucosalJunctionDistance,0),
			WithdrawalMins =NULLIF(@WithdrawalMins,0), --edited by mostafiz 2830
			WhoUpdatedId = @LoggedInUserId,
			WhenUpdated = getdate(),
			LimitationOther = NULLIF(@LimitationOther,'')
		WHERE 
			ProcedureId = @ProcedureId AND
			EndoscopistId = @EndoscopistId
	END

	DECLARE @SectionId int, @ProceureTypeId int, @ExtentIsSuccess bit, @ExtentDescription varchar(200), @SummaryText varchar(max) = ''
	SELECT @SectionID = UISectionId FROM UI_Sections WHERE SectionName = 'Extent'

	SELECT @ProceureTypeId = ProcedureType FROM ERS_Procedures WHERE ProcedureId = @ProcedureId
	
	/*Furthest extent*/
	SELECT TOP 1 @ExtentDescription = ee.Description, @AdditionalInfo = epue.AdditionalInfo
								FROM dbo.ERS_ProcedureUpperExtent epue 
									INNER JOIN dbo.ERS_Extent ee ON epue.ExtentId = ee.UniqueId
								WHERE epue.ProcedureId=@ProcedureId
								ORDER BY ee.ListOrderBy DESC
	
	/*Handle failed procedures*/
	
	IF @ExtentDescription IN ('intubation failed','abandoned')
	Begin
	
		EXEC diagnoses_set_procedure_failed @ProcedureId
		Set @bitHasProcedureFailed = 1
	END
    
	IF ISNULL(@MucosalJunctionDistance,0) > 0
	BEGIN

		SET @SummaryText = 'The apparent mucosal junction: ' + Convert(varchar(50), @MucosalJunctionDistance) + ' cm ' -- edited by mostafiz 4084
	END

	IF (SELECT COUNT(*) FROM ERS_ProcedureUpperExtent WHERE ProcedureId = @ProcedureId AND NULLIF(JManoeuvreId,-1) IS NOT NULL) > 0
	BEGIN
		DECLARE @JManouvreResult varchar(100)

		/*Overall JManouvre result regardless of who done it, was it done*/
		IF EXISTS (SELECT 1 FROM ERS_ProcedureUpperExtent WHERE ProcedureId = @ProcedureId AND ISNULL(JManoeuvreId,0) = 1)
			SET @JManouvreResult = 'performed. '
		ELSE
			SET @JManouvreResult = 'not carried out. '

		SET @SummaryText = @SummaryText + 'J manoeuvre ' + @JManouvreResult
	END
		
	SET @SummaryText = @SummaryText +   
						CASE LOWER(@ExtentDescription )
							WHEN 'intubation failed' THEN 'Failed intubation' + CASE WHEN ISNULL(@AdditionalInfo,'') <> '' THEN ': ' + @AdditionalInfo ELSE '' END
							WHEN 'abandoned' THEN 'Procedure failed (abandoned)' + CASE WHEN ISNULL(@AdditionalInfo,'') <> '' THEN ': ' + @AdditionalInfo ELSE '' END
							WHEN 'other' THEN  'Procedure failed' + CASE WHEN ISNULL(@AdditionalInfo,'') <> '' THEN ': ' + @AdditionalInfo ELSE '' END
							ELSE 'The procedure was completed successfully to the ' + @ExtentDescription
						END
	
	--limited by...?
	IF ISNULL(@LimitedById, 0) > 0
	BEGIN
		SET @SummaryText = @SummaryText + ' but limited by ' + (SELECT LOWER(Description) FROM ERS_Limitations WHERE UniqueId = @LimitedById)
	END

	IF ISNULL(@SummaryText,'') <> ''
	BEGIN
		UPDATE ERS_ProcedureUpperExtent
		SET Summary = @SummaryText
		WHERE ProcedureId = @ProcedureId

		EXEC procedure_summary_update @ProcedureId
	END
	
	DECLARE @Summary VARCHAR(max) = 'Extent:'


	--remove complete section entry incase conditions no longer apply. Will get re-evaluated after
	EXEC UI_update_procedure_summary @ProcedureId, 'Extent', @Summary, 0, @EndoscopistId

	--Check if the Extent has reached or exceeded the planned extent, if so mark as success
	IF @ExtentId > 0 
	BEGIN
		DECLARE @ExtentListOrder INT
		SELECT @ExtentListOrder = ListOrderBy, @ExtentIsSuccess = IsSuccess FROM ERS_Extent WHERE UniqueId = @ExtentId
		DECLARE @PlannedExtentListOrder int = (SELECT e.ListOrderBy FROM ERS_ProcedurePlannedExtent ppe JOIN ERS_Extent e ON e.UniqueId = ppe.ExtentId WHERE ppe.ProcedureId = @ProcedureId)

		IF (@ExtentListOrder >= @PlannedExtentListOrder AND @ExtentListOrder > 0)
				SET @ExtentIsSuccess = 1
	END
	
	IF @ExtentId > 0 AND @ExtentIsSuccess = 1
		EXEC UI_update_procedure_summary @ProcedureId, 'Extent', 'Extent:', @ExtentId, @EndoscopistId
	ELSE IF @ExtentIsSuccess = 0 AND @LimitedById > 1
	BEGIN
		IF (SELECT LOWER(NEDTerm) FROM dbo.ERS_Limitations WHERE UniqueId = @LimitedById) = 'other'
		BEGIN
			IF ISNULL(@LimitationOther,'') <> ''
			BEGIN
				EXEC UI_update_procedure_summary @ProcedureId, 'Extent', 'Extent:' , @ExtentId, @EndoscopistId
			END
		END
		ELSE
		BEGIN
			EXEC UI_update_procedure_summary @ProcedureId, 'Extent', 'Extent:', @ExtentId, @EndoscopistId
		END
	END

	IF ISNULL(@WithdrawalMins,0) > 0
	BEGIN
		EXEC UI_update_procedure_summary @ProcedureId, 'Total withdrawal time', 'Total withdrawal time:', 1, @EndoscopistId
	END

	IF @JManoeuvreId > -1
	BEGIN
		EXEC UI_update_procedure_summary @ProcedureId, 'JManoevre', 'JManoevre:', 1, @EndoscopistId
	END
	ELSE
	BEGIN
		EXEC UI_update_procedure_summary @ProcedureId, 'JManoevre', 'JManoevre:', 0 , @EndoscopistId
	END
	
	--MH Added on 04 Jan 2023 
	Exec usp_SendIntubationExtentOrderMessageByProcedureId @ProcedureId, @bitHasProcedureFailed, @LoggedInUserId

	EXEC ogd_diagnoses_summary_update @ProcedureID

	--Handle unentered sections
	DECLARE @MatrixCode VARCHAR(100)

	--based on extent reached
	IF LOWER(@ExtentDescription)= 'oesophagus'
	BEGIN
		--check if a diagnoses is present or not (will say OverallNorml if nothing's been found)
		IF EXISTS (SELECT 1 FROM dbo.ERS_Diagnoses WHERE ProcedureID = @ProcedureId AND LOWER(MatrixCode) = 'overallnormal')
		BEGIN
		    --if its overallnormal delete it
			DELETE FROM dbo.ERS_Diagnoses WHERE ProcedureID = @ProcedureId AND LOWER(MatrixCode) = 'overallnormal'

			--add oesophagus normal
			INSERT INTO [ERS_Diagnoses] (ProcedureID, SiteID, MatrixCode, [Value], [Region]) 
			VALUES (@ProcedureID, 0, 'OesophagusNormal','true','Oesophagus') 
		END

		--Stomach region is not updated if a abnormality/diagnoses is present
		IF EXISTS (SELECT 1 FROM dbo.ERS_Diagnoses WHERE @ProcedureId = @ProcedureId AND Region = 'Stomach')
		BEGIN
			IF EXISTS (SELECT 1 FROM dbo.ERS_Diagnoses WHERE @ProcedureId = @ProcedureId AND Region = 'Stomach' AND MatrixCode = 'StomachNormal') 
			BEGIN
				DELETE FROM dbo.ERS_Diagnoses WHERE ProcedureID = @ProcedureId AND Region = 'Stomach' AND MatrixCode = 'StomachNormal'

				INSERT INTO [ERS_Diagnoses] (ProcedureID, SiteID, MatrixCode, [Value], [Region]) 
				VALUES (@ProcedureID, 0, 'StomachNotEntered','true','Stomach') 
			END
		END
		ELSE
		BEGIN
		    INSERT INTO [ERS_Diagnoses] (ProcedureID, SiteID, MatrixCode, [Value], [Region]) 
		    VALUES (@ProcedureID, 0, 'StomachNotEntered','true','Stomach') 
		END

		--Duodenum region is not updated if a abnormality/diagnoses is present
		IF EXISTS (SELECT 1 FROM dbo.ERS_Diagnoses WHERE @ProcedureId = @ProcedureId AND Region = 'Duodenum')
		BEGIN
		     IF EXISTS (SELECT 1 FROM dbo.ERS_Diagnoses WHERE @ProcedureId = @ProcedureId AND Region = 'Duodenum' AND MatrixCode = 'DuodenumNormal')
			 BEGIN
				DELETE FROM dbo.ERS_Diagnoses WHERE ProcedureID = @ProcedureId AND Region = 'Duodenum' AND MatrixCode = 'DuodenumNormal'

				INSERT INTO [ERS_Diagnoses] (ProcedureID, SiteID, MatrixCode, [Value], [Region]) 
				VALUES (@ProcedureID, 0, 'DuodenumNotEntered','true','Duodenum')
			 END
		END
		ELSE	
		BEGIN
		    INSERT INTO [ERS_Diagnoses] (ProcedureID, SiteID, MatrixCode, [Value], [Region]) 
		    VALUES (@ProcedureID, 0, 'DuodenumNotEntered','true','Duodenum')
		END

		

		EXEC dbo.ogd_diagnoses_summary_update @ProcedureId
	END
	IF LOWER(@ExtentDescription)= 'stomach'
	BEGIN
		--check if a diagnoses is present or not (will say OverallNorml if nothing's been found)
		IF EXISTS (SELECT 1 FROM dbo.ERS_Diagnoses WHERE ProcedureID = @ProcedureId AND LOWER(MatrixCode) = 'overallnormal')
		BEGIN
		    --if its overallnormal delete it
			DELETE FROM dbo.ERS_Diagnoses WHERE ProcedureID = @ProcedureId AND LOWER(MatrixCode) = 'overallnormal'

			--add oesophagus normal
			INSERT INTO [ERS_Diagnoses] (ProcedureID, SiteID, MatrixCode, [Value], [Region]) 
			VALUES (@ProcedureID, 0, 'OesophagusNormal','true','Oesophagus') 

			--add stomach normal
			INSERT INTO [ERS_Diagnoses] (ProcedureID, SiteID, MatrixCode, [Value], [Region]) 
			VALUES (@ProcedureID, 0, 'StomachNormal','true','Stomach') 
		END
		
		--Stomach region is not updated if a abnormality/diagnoses is present
		IF EXISTS (SELECT 1 FROM dbo.ERS_Diagnoses WHERE @ProcedureId = @ProcedureId AND Region = 'Oesophagus' AND MatrixCode = 'OesophagusNotEntered')
		BEGIN
			DELETE FROM dbo.ERS_Diagnoses WHERE ProcedureID = @ProcedureId AND Region = 'Oesophagus' AND MatrixCode = 'OesophagusNotEntered'
			
			--add Oesophagus normal
			INSERT INTO [ERS_Diagnoses] (ProcedureID, SiteID, MatrixCode, [Value], [Region]) 
			VALUES (@ProcedureID, 0, 'OesophagusNormal','true','Oesophagus') 
		END

		--Stomach region is not updated if a abnormality/diagnoses is present
		IF NOT EXISTS (SELECT 1 FROM dbo.ERS_Diagnoses WHERE @ProcedureId = @ProcedureId AND Region = 'Stomach')
		BEGIN
			--add stomach normal
			INSERT INTO [ERS_Diagnoses] (ProcedureID, SiteID, MatrixCode, [Value], [Region]) 
			VALUES (@ProcedureID, 0, 'StomachNormal','true','Stomach') 
		END

		--Duodenum region is not updated if a abnormality/diagnoses is present
		IF EXISTS (SELECT 1 FROM dbo.ERS_Diagnoses WHERE @ProcedureId = @ProcedureId AND Region = 'Duodenum')
		BEGIN
		     IF EXISTS (SELECT 1 FROM dbo.ERS_Diagnoses WHERE @ProcedureId = @ProcedureId AND Region = 'Duodenum' AND MatrixCode = 'DuodenumNormal')
			 BEGIN
				DELETE FROM dbo.ERS_Diagnoses WHERE ProcedureID = @ProcedureId AND Region = 'Duodenum' AND MatrixCode = 'DuodenumNormal'

				INSERT INTO [ERS_Diagnoses] (ProcedureID, SiteID, MatrixCode, [Value], [Region]) 
				VALUES (@ProcedureID, 0, 'DuodenumNotEntered','true','Duodenum')
			 END
		END
		ELSE	
		BEGIN
		    INSERT INTO [ERS_Diagnoses] (ProcedureID, SiteID, MatrixCode, [Value], [Region]) 
		    VALUES (@ProcedureID, 0, 'DuodenumNotEntered','true','Duodenum')
		END
		
		EXEC dbo.ogd_diagnoses_summary_update @ProcedureId
	END
END

GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	4084 Ended
------------------------------------------------------------------------------------------------------------------------


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ahmed Shoud
-- TFS#	No TFS - Item 2827 
-- Description of change
--  Show selected Patient category on Lab Request Form 
------------------------------------------------------------------------------------------------------------------------

GO
EXEC dbo.DropIfExist @ObjectName = 'printreport_patient_info_select',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)

GO
CREATE PROCEDURE [dbo].[printreport_patient_info_select]
(
	@ProcedureId INT,
	@EpisodeNo INT = 0,
    @PatientComboId VARCHAR(30) = NULL,
    @ProcedureType INT
)
AS

SET NOCOUNT ON

IF @ProcedureId IS NOT NULL AND @ProcedureId > 0
BEGIN

	DECLARE @PP_GPAddress VARCHAR(1000), @PP_GPName VARCHAR(1000)
	SELECT @PP_GPAddress =PP_GPAddress, @PP_GPName= PP_GPName FROM dbo.[ERS_ProceduresReporting] WHERE ProcedureId = @ProcedureId;

	SELECT 
			ISNULL(p.Title + ' ', '') + ISNULL(p.Forename1 + ' ', '') + ISNULL(p.Surname, '') AS PatientName, 
			ISNULL(p.Forename1, '') AS Forename,
			ISNULL(p.Surname, '') AS Surname,
			ISNULL(p.Gender, '') AS Gender,
			ISNULL(p.[DateOfBirth], '') AS DateOfBirth,
			ISNULL(p.[NHSNo],'') AS NHSNo, 
			ISNULL(p.[HospitalNumber], '') as CaseNoteNo, 
			ISNULL(REPLACE(p.[Address],',', CHAR(10)),'') AS [Address],
			ISNULL(REPLACE(p.GPName, CHAR(44),'<br />'),'')  AS GPName,
			CASE WHEN p.GPName IS NOT NULL then REPLACE(p.GPName, CHAR(44),'') + '<br />' ELSE '' END + 
				ISNULL(REPLACE(REPLACE(LTRIM(RTRIM(p.PracticeName)), CHAR(13), '<br/>'), CHAR(10), '<br/>'),'<br/>') + 
				ISNULL(REPLACE(REPLACE(LTRIM(RTRIM(p.GPAddressHTML)), CHAR(13), '<br/>'), CHAR(10), '<br/>'),'<br/>') AS GPAddress,
			ISNULL(CONVERT(VARCHAR(11),pj.ProcedureStartTime,106) + ' (' + CONVERT(VARCHAR(5),pj.ProcedureStartTime,108) + CASE WHEN pj.ProcedureEndTime is null THEN ')' ELSE ' - ' + CONVERT(VARCHAR(5), pj.ProcedureEndTime, 108) + ')' END,'') AS ProcedureDate, 
			ISNULL(ps.ListItemText, '') AS PatientStatus, 
			ISNULL(oh.HospitalName,'') AS HospitalName,
			ISNULL(oh.ContactNumber,'') AS HospitalPhoneNumber,
			ISNULL(w.WardDescription,'') AS Ward,
			ISNULL(eut.Description,'') AS PatientPriority,
			pr.PatientType AS PatientType
	FROM 
			ERS_VW_PatientswithGP p 
	INNER JOIN 
			ERS_Procedures pr ON p.[PatientId] = pr.PatientId 
	LEFT JOIN 
			ERS_Lists ps ON pr.PatientStatus = ps.ListItemNo AND ps.ListDescription = 'Patient Status'
	LEFT JOIN 
			ERS_Wards w ON pr.Ward = w.WardId
	LEFT JOIN 
			ERS_Lists c ON pr.CategoryListId = c.ListItemNo AND c.ListDescription = 'Procedure Category'
	INNER JOIN 
			ERS_OperatingHospitals oh ON pr.OperatingHospitalID = oh.OperatingHospitalId
	LEFT JOIN ERS_PatientJourney pj ON pr.ProcedureId = pj.ProcedureId 
	LEFT JOIN dbo.ERS_UrgencyTypes eut ON eut.UniqueId = pr.CategoryListId
	WHERE 
			pr.ProcedureId = @ProcedureId 
END

ELSE
BEGIN

       DECLARE @TableName VARCHAR(100) = (SELECT dbo.fnGetUGI_tablename(@ProcedureType,'procedure') 
										FROM [Episode]  
										WHERE CHARINDEX('1', [Status]) BETWEEN 1 AND 12 
										AND [Patient No] = @PatientComboId 
										AND [Episode No] = @EpisodeNo)

	DECLARE @SQL NVARCHAR(MAX) = 'DECLARE @HospId INT, @PP_RepDateAndTime VARCHAR(100), @PP_PatAddress VARCHAR(100), @PP_GP VARCHAR(1000), @HospName VARCHAR(50) '
	SET @SQL = @SQL + ' SELECT @HospId = [Operating Hospital ID], @PP_RepDateAndTime = [PP_RepDateAndTime], @PP_PatAddress = [PP_PatAddress], @PP_GP= ISNULL(PP_GP ,'''') FROM '
						+ @TableName +'  WHERE [Episode No] = ' + cast(@EpisodeNo as varchar(50))  
       
	SET @SQL = @SQL + ' SELECT @HospName = Name FROM [Operating Hospital] WHERE ID = @HospId '

	SET @SQL = @sql +  N'SELECT 
			ISNULL(p.Title,'''') + '' '' + ISNULL(p.Forename, '''') + '' '' + p.Surname AS PatientName, 
			ISNULL(p.Forename, '''') AS Forename,
			ISNULL(p.Surname, '''') AS Surname,
			ISNULL(Gender, '''') AS Gender,
			ISNULL([Date of Birth], '''') AS DateOfBirth, 
			ISNULL([NHS No],'''') AS NHSNo, 
			ISNULL([Case note no], '''') AS CaseNoteNo, 
			--ISNULL(REPLACE(REPLACE(p.[Address], CHAR(13),''), CHAR(10),''<br />''), '''') +  ISNULL(REPLACE(REPLACE(p.[Post code], CHAR(13),''''), CHAR(10),''''), '''') AS [Address],
			ISNULL(@PP_PatAddress,'''') AS [Address], 
			'''' AS GPName, --ISNULL(p.[GP Name], '''') AS GPName, 
			ISNULL(@PP_GP, '''') AS GPAddress, --ISNULL(p.[GP Address], '''') AS GPAddress,
			--LEFT(CONVERT(VARCHAR(30), e.[Procedure time], 113), 17) AS ProcedureDate, 
			--FORMAT(e.[Episode date], ''dd MMMM yyyy'', ''en-GB'') + FORMAT(e.[Procedure time], '' (HH:mm:ss)'', ''en-GB'') AS ProcedureDate, 
			--CONVERT(VARCHAR(11),e.[Episode date],106) + '' ('' + CONVERT(VARCHAR(5),e.[Procedure time],108) + '')'' AS ProcedureDate, 
			ISNULL(@PP_RepDateAndTime,'''') AS ProcedureDate, 
			ISNULL(ps.[List item text], '''') AS PatientStatus, 
			--ISNULL(p.Hospitals, '''') AS HospitalName,
			ISNULL(@HospName ,'''') AS HospitalName,
			'''' AS HospitalPhoneNumber,
			ISNULL(w.[List item text], '''') AS Ward
	FROM 
			Patient p 
	INNER JOIN
			Episode e ON p.[Combo ID] = e.[Patient No]
	LEFT JOIN 
			Lists ps ON p.[Patient Status 1] = ps.[List item no] AND ps.[List description] = ''PatientStatus''
	LEFT JOIN 
			Lists w ON p.Ward = w.[List item no] AND w.[List description] = ''Ward''
	WHERE 
			p.[Combo ID] = ''' + @PatientComboId + ''' AND
			e.[Episode No] = ' + CAST(@EpisodeNo AS VARCHAR(10))

	EXEC sp_executesql @SQL
END
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	No TFS - Item 2827
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ahmed Shoud
-- TFS#	No TFS - Item 4071 
-- Description of change
-- Referral Type (GP) add free text box
------------------------------------------------------------------------------------------------------------------------
GO

IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.COLUMNS
    WHERE TABLE_NAME = 'ERS_Procedures'
      AND COLUMN_NAME IN ('GPReferrer')
)
BEGIN
    ALTER TABLE dbo.ERS_Procedures
    ADD GPReferrer VARCHAR(500) NULL;
END

GO

IF NOT EXISTS(SELECT * FROM ERS_XMLMap WHERE FieldName = 'PP_RefConsName' AND NodeName = 'RefConsName' AND [Group] = 'GPD' AND Active = -1 AND OrderID IS NULL)
	BEGIN 
		INSERT INTO ERS_XMLMap(FieldName, NodeName, [Group], Active, OrderID) VALUES('PP_RefConsName', 'RefConsName', 'GPD', -1, NULL)
	END 

GO

EXEC dbo.DropIfExist @ObjectName = 'usp_Procedures_Insert',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[usp_Procedures_Insert]
(
	@ProcedureType		INT,
	--@PatientNo		VARCHAR(24),
	@PatientId			INT,
	@ProcedureDate		DATETIME,
	@ProcedureTime		VARCHAR(2),
	@PatientStatus		INT,
	@PatientWard		INT,
	@PatientType		INT,
	@OperatingHospitalId INT,
	@ListConsultant		INT,
	@Endoscopist1		INT,
	@Endoscopist2		INT,
	@Assistant			INT,
	@Nurse1				INT,
	@Nurse2				INT,
	@Nurse3				INT,
	@Nurse4				INT,
	@ReferralHospitalNo INT,
	@ReferralConsultantNo INT,
	@ReferralConsultantSpeciality INT,
	@PatientConsent		TINYINT,
	@DefaultCheckBox	BIT,
	@UserID				INT,
	@ProductType		TINYINT,
	@ListType			TINYINT,
	@Endo1Role			TINYINT,
	@Endo2Role			TINYINT,
	@CategoryListId		INT,
	@OnWaitingList		BIT,
	@OpenAccessProc		TINYINT,
	@EmergencyProcType	TINYINT,
	@NewProcedureId		INT OUTPUT,	-- This will return the newly created ProcedureId to the GUI! To play
	@ImagePortId		INT,
	@Points				DECIMAL,
	@ChecklistComplete	BIT,
	@ReferrerType		INT,
	@GPReferrer VARCHAR(500) = NULL,
	@ReferrerTypeOther  VARCHAR(500),
	@ProviderId			INT,
	@ProviderOther		VARCHAR(500),
	@PatientNotes		BIT,
	@PatientReferralLetter	BIT,
	@ImageGenderID	int,
	@OrderId	int
)
AS

SET NOCOUNT ON

DECLARE @newProcId INT
DECLARE @ppEndos VARCHAR(2000), @GPName varchar(255), @GPAddress varchar(max), @Endo1 varchar(500), @Endo2 varchar(500), @RefCons varchar(50), @RefHosp varchar(50)

BEGIN TRANSACTION
--sp_help 'dbo.ERS_Procedures'
	BEGIN TRY
		INSERT INTO ERS_Procedures
			(ProcedureType,
			CreatedBy,	
			CreatedOn,			
			ModifiedOn,
			ProcedureTime,
			PatientId,
			CategoryListId,
			OnWaitingList,
			OpenAccessProc,
			EmergencyProcType,
			OperatingHospitalID,
			ListConsultant,
			Endoscopist1,
			Endoscopist2,
			Assistant,
			Nurse1,
			Nurse2,
			Nurse3,
			Nurse4,
			ReferralHospitalNo,
			ReferralConsultantNo,
			ReferralConsultantSpeciality,
			PatientStatus,
			Ward,
			PatientType,
			PatientConsent,
			ListType,
			Endo1Role,
			Endo2Role,
			ImagePortId,
			WhoCreatedId,
			WhenCreated,
			Points,
			ChecklistComplete,
			ReferrerType,
			GPReferrer,
			ReferrerTypeOther,
			ProviderTypeId,
			ProviderOther,
			PatientNotes,
			PatientReferralLetter,
			ImageGenderID,
			OrderId)
		VALUES (
			@ProcedureType,
			@UserID,
			@ProcedureDate, --CASE WHEN CONVERT(DATE, GETDATE()) = @ProcedureDate THEN GETDATE() ELSE @ProcedureDate END, --Insert date and time if Procedure date is current date
			GETDATE(),
			@ProcedureTime,
			@PatientId,
			@CategoryListId,
			@OnWaitingList,
			@OpenAccessProc,
			@EmergencyProcType,
			@OperatingHospitalID,
			@ListConsultant,
			@Endoscopist1,
			@Endoscopist2,
			@Assistant,
			@Nurse1,
			@Nurse2,
			@Nurse3,
			@Nurse4,
			@ReferralHospitalNo,
			@ReferralConsultantNo,
			@ReferralConsultantSpeciality,
			@PatientStatus,
			@PatientWard,
			@PatientType,
			@PatientConsent, 
			@ListType,
			@Endo1Role,
			@Endo2Role,
			@ImagePortId,
			@UserID,
			GETDATE(),
			@Points,
			@ChecklistComplete,
			@ReferrerType,
			@GPReferrer,
			@ReferrerTypeOther,
			@ProviderId,
			@ProviderOther,
			@PatientNotes,
			@PatientReferralLetter,
			@ImageGenderID,
			@OrderId)

		SET @newProcId = SCOPE_IDENTITY();
	
		--## Important Work- Insert a Blank Record in the ERS_ProceduresReorting- with this Unique ID! So, you can simply Update the PP fields later..!! 
		INSERT INTO dbo.ERS_ProceduresReporting(ProcedureId)VALUES(@newProcId);

		SET @ppEndos = ''
		IF @ListConsultant > 0 SELECT @ppEndos = @ppEndos + '$$List Consultant: ' + Title + ' ' + Forename + ' ' + Surname FROM ERS_Users WHERE UserID = @ListConsultant
		IF @Endoscopist1 > 0 
		BEGIN
			SELECT @Endo1 = Title + ' ' + Forename + ' ' + Surname FROM ERS_Users WHERE UserID = @Endoscopist1
			SELECT @ppEndos = @ppEndos + '$$Endoscopist No1: ' + @Endo1
			SELECT  @Endo1 = Title + ' ' + Forename + ' ' + Surname + 
					CASE WHEN isnull(Qualifications, '') != '' THEN ', ' + Qualifications else '' END + 
					CASE WHEN isnull(u.JobTitleID, 0) > 0 THEN CHAR(13)+CHAR(10) + jt.Description ELSE '' END  
			FROM ERS_Users u
			LEFT JOIN ERS_JobTitles jt on u.JobTitleID = jt.JobTitleID 
			WHERE UserID = @Endoscopist1
		END
		IF @Endoscopist2 > 0 
		BEGIN
			SELECT @Endo2 = Title + ' ' + Forename + ' ' + Surname FROM ERS_Users WHERE UserID = @Endoscopist2
			SELECT @ppEndos = @ppEndos + '$$Endoscopist No2: ' + @Endo2
			SELECT  @Endo2 = Title + ' ' + Forename + ' ' + Surname + 
					CASE WHEN isnull(Qualifications, '') != '' THEN ', ' + Qualifications else '' END + 
					CASE WHEN isnull(u.JobTitleID, 0) > 0 THEN CHAR(13)+CHAR(10) + jt.Description ELSE '' END  
			FROM ERS_Users u
			LEFT JOIN ERS_JobTitles jt on u.JobTitleID = jt.JobTitleID 		
			WHERE UserID = @Endoscopist2
		END
		IF @Nurse1 > 0 OR @Nurse2 > 0 OR @Nurse3 > 0 OR @Nurse4 > 0 
		BEGIN
			SELECT @ppEndos = @ppEndos + '$$' + 'Nurses: '
			IF @Nurse1 > 0 SELECT @ppEndos = @ppEndos + '##' + Title + ' ' + Forename + ' ' + Surname FROM ERS_Users WHERE UserID = @Nurse1
			IF @Nurse2 > 0 SELECT @ppEndos = @ppEndos + '##' + Title + ' ' + Forename + ' ' + Surname FROM ERS_Users WHERE UserID = @Nurse2
			IF @Nurse3 > 0 SELECT @ppEndos =  @ppEndos + '##' + Title + ' ' + Forename + ' ' + Surname FROM ERS_Users WHERE UserID = @Nurse3
			IF @Nurse4 > 0 SELECT @ppEndos =  @ppEndos + '##' + Title + ' ' + Forename + ' ' + Surname FROM ERS_Users WHERE UserID = @Nurse4
		END
		IF CHARINDEX('$$', @ppEndos) > 0 SET @ppEndos = REPLACE(STUFF(@ppEndos, charindex('$$', @ppEndos), 2, ''), '$$', '<br/>')
		IF CHARINDEX('##', @ppEndos) > 0 SET @ppEndos = REPLACE(STUFF(@ppEndos, charindex('##', @ppEndos), 2, ''), '##', '<br/>')
	
		SET @RefCons=''
		IF @ReferrerType = 1
		BEGIN
			SET @RefCons = 'GP'
		END
		ELSE IF @ReferrerType = 5
		BEGIN
			SET @RefCons = @ReferrerTypeOther
		END
		ELSE
		BEGIN
			SELECT @RefCons = ec.CompleteName FROM dbo.ERS_Consultant ec WHERE ec.ConsultantID = @ReferralConsultantNo
		END	
		--SELECT @GPName = p.[GP Name] , @GPAddress = p.[GP Address] FROM Patient p left join  ERS_Procedures pr ON p.[Patient No]= pr.PatientId WHERE pr.ProcedureId = @newProcId
		--SELECT @GPName = p.[GP Name] , @GPAddress = p.[GP Address] FROM ERS_Patients p WHERE p.[Patient No]= @PatientId

		SET @RefHosp = ''
		SELECT @RefHosp = rh.HospitalName FROM dbo.ERS_ReferralHospitals rh WHERE rh.HospitalID = @ReferralHospitalNo

		--Get GP practice name and address
		SELECT 	TOP 1 
			@GPName		= g.CompleteName,
			@GPAddress	= replace(dbo.fnFullAddress(ep.[Name], ep.Address1, ep.Address2, CASE WHEN ep.Address3 Is null THEN EP.Address4 ELSE ep.Address3 + ' ' + EP.Address4 END, ep.PostCode), ',', ', <br />')
		FROM ERS_Patients p 
		LEFT JOIN ERS_GPs g ON g.GPId = p.RegGpId
		LEFT JOIN dbo.ERS_Practices ep ON p.RegGpPracticeId = ep.PracticeID
		where p.PatientId = @PatientId 

		UPDATE ERS_ProceduresReporting SET PP_Endos = @ppEndos, PP_GPName = @GPName, PP_GPAddress = @GPAddress, PP_Endo1 = @Endo1, PP_Endo2 = @Endo2, PP_RefCons = @RefCons, PP_RefHosp = @RefHosp WHERE ProcedureId = @newProcId

		UPDATE ERS_Consultant SET SortOrder = ISNULL(SortOrder,0) + 1 WHERE ConsultantID = @ReferralConsultantNo

		EXEC procedure_summary_update @newProcId

		--SELECT @newProcId AS ProcedureId
		SELECT @NewProcedureId=@newProcId;

	END TRY

	BEGIN CATCH
		DECLARE @ErrorMessage NVARCHAR(4000);
		DECLARE @ErrorSeverity INT;
		DECLARE @ErrorState INT;

		SELECT @ErrorMessage = ERROR_MESSAGE(),
			   @ErrorSeverity = ERROR_SEVERITY(),
			   @ErrorState = ERROR_STATE();
    
		RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

		IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
	END CATCH


	IF @@TRANCOUNT > 0 COMMIT TRANSACTION;
GO

EXEC dbo.DropIfExist @ObjectName = 'usp_PrintReport_Select',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[usp_PrintReport_Select]  
(  
 @ProcedureId INT,  
 @Group VARCHAR(10),  
 @EpisodeNo INT = 0,  
       @PatientComboId VARCHAR(30) = NULL,  
       @ProcedureType INT,  
       @ColonType INT  
)  
/*
	Update History:
	01 Feb 2024			:		MH	removed Diagnoses part for DNA / Cancelled reports TFS : 2885 - Cancelled reports
*/
AS  
  
SET NOCOUNT ON  
  
 DECLARE @SQLString NVARCHAR(MAX),  
   @FieldName VARCHAR(150),  
   @NodeName VARCHAR(50),  
   @TableName VARCHAR(50),  
   @Condition VARCHAR(100),  
   @ReportStyle SMALLINT,  
   @ExecQuery BINARY = 0,  
   @IncludeUGI BIT = 0,
   @DNAProcedure smallint = 0,
   @SummaryOrder	INT = 0;  
  
 DECLARE @Procedure_Reporting_TableJoinText VARCHAR(255);  
 select @EpisodeNo=(CASE WHEN dbo.fnShouldIncludeUGI()=1 THEN @EpisodeNo ELSE 0 END);  
 
 select @DNAProcedure  = IsNull(DNA,0) from ERS_Procedures Where ProcedureId = @ProcedureId

 CREATE TABLE #Summary (NodeName VARCHAR(200), NodeSummary NVARCHAR(MAX) ,[Group] VARCHAR(10), [SummaryOrder] INT)  
 CREATE TABLE #xmlmap ([FieldName] [varchar](50), [NodeName] [varchar](50), [Group] [varchar](10), [Active] [smallint], [OrderID] [int])  
  
 --DECLARE @ProcedureTypeId INT  
 --SELECT @ProcedureTypeId = ProcedureType FROM ERS_Procedures WHERE ProcedureId = @ProcedureId  
 
IF @Group = 'AD'  
 INSERT INTO #xmlmap  
 SELECT FieldName, NodeName, [Group], Active, OrderID  
 FROM ERS_XMLMap   
 WHERE [FieldName] IN ('PP_Site_Legend', 'PP_SpecimenTaken')  
 ORDER BY OrderID  
ELSE IF @Group='Premed'  
       INSERT INTO #xmlmap  
       SELECT FieldName, NodeName, [Group], Active, OrderID   
    FROM ERS_XMLMap WHERE [FieldName] IN ('PP_Premed', 'PP_Bowel_Prep') AND [Group]='RS'  
ELSE  
 INSERT INTO #xmlmap  
 SELECT FieldName, NodeName, [Group], Active, OrderID  
 FROM ERS_XMLMap   
 WHERE [Group] = @Group AND [FieldName] NOT IN ('PP_Site_Legend', 'PP_SpecimenTaken')  
 ORDER BY OrderID  
  
  --MH Added on 01 Feb 2024 - TFS 2885 - Cancelled reports
  if @DNAProcedure > 0
  Begin
	Delete from #xmlmap Where FieldName = 'PP_Diagnoses'
  End

 IF @ProcedureId IS NOT NULL AND @ProcedureId > 0  
  BEGIN  
   SET @TableName = '[ERS_Procedures]'  
   SET @Procedure_Reporting_TableJoinText = '  AS P LEFT JOIN dbo.ERS_ProceduresReporting AS PR ON P.ProcedureId = PR.ProcedureId '  
   SET @Condition = 'P.ProcedureId = @ProcedureId'  
  
   IF (SELECT isnull(PP_Pathology, '') from ERS_ProceduresReporting where ProcedureID = @ProcedureId) != ''  
    AND @Group = 'RS'  
    INSERT INTO #Summary   
    Select 'Revised', 'Revised report following pathology report dated ' + isnull(convert(varchar, DateOfReport, 106), ''), 'RS', @SummaryOrder  from ERS_UpperGIPathologyResults where ProcedureId = @ProcedureId  
  END  
 ELSE IF @EpisodeNo > 0  
  BEGIN  
      SELECT TOP 1 @TableName = LTRIM(RTRIM(dbo.fnGetUGI_tablename(@ProcedureType,'procedure')))  
   FROM [Episode]   
   WHERE CHARINDEX('1', [Status]) BETWEEN 1 AND 8 AND [Patient No] = @PatientComboId AND [Episode No] = @EpisodeNo  
   SET @Condition = '[Patient No] = @PatientComboId AND [Episode No] = @EpisodeNo'  
      IF @ColonType >= 0 SET @Condition = @Condition + ' AND [Procedure type] = ' +CAST( @ColonType as varchar(50))  
  END  
  
 DECLARE report_cursor CURSOR FOR   
 SELECT FieldName FROM #xmlmap ORDER BY OrderID ASC  
  
 OPEN report_cursor   
 FETCH NEXT FROM report_cursor INTO @FieldName  
  
 WHILE @@FETCH_STATUS = 0  
 BEGIN  
  SELECT @NodeName = NodeName, @Group = [Group], @SummaryOrder = OrderID FROM #xmlmap WHERE FieldName = @FieldName
	IF (@SummaryOrder IS NULL)
	BEGIN
		SET @SummaryOrder = 0
	END
   
  IF @ProcedureId IS NOT NULL AND @ProcedureId > 0  
  BEGIN  
   IF @FieldName = 'Endoscribe comments' SET @FieldName = 'EndoscribeComments'  
   ELSE IF @FieldName = 'Procedure date' SET @FieldName = 'CreatedOn'  
   ELSE IF @FieldName = 'Time of procedure' SET @FieldName = 'CreatedOn'  
   ELSE IF @FieldName = 'PP2_CompiledOn' SET @FieldName = 'ModifiedOn'  
   ELSE IF @FieldName = 'PP2_SiteData' SET @FieldName = 'PP_Site_Legend'  
   --ELSE IF @FieldName = 'PP_MainReportBody' SET @FieldName = 'Summary'    
  END  
  
  IF @FieldName = 'PP_Premed' AND @ProcedureType in (10, 11) --Bronchoscopy or EBUS
   SET @NodeName = 'Sedation and anaesthesia'  
  
  --IF [Report Style] = 1 -> New style report, select from PP2 field  
  IF @TableName <> '[ERS_Procedures]' AND @EpisodeNo > 0 AND @FieldName = 'PP_MainReportBody'  
    SET @FieldName = 'CASE WHEN ISNULL([Report Style],0) = 0 THEN PP_MainReportBody ELSE PP2_MainReportBody END'  
  ELSE IF @FieldName = 'PP_MainReportBody' AND @ProcedureId > 0 SET @FieldName = 'PR.Summary'    
  ELSE IF @FieldName = 'Resected colon no' AND @ProcedureId > 0 SET @FieldName = 'ResectedColonNo'   
  ELSE IF @FieldName = 'PP_RefConsName' AND @ProcedureId > 0 SET @FieldName = 'P.GPReferrer'
  ELSE  
   SET @FieldName = '[' + @FieldName + ']'  
   
  SET @SQLString = 'INSERT INTO #Summary ' +   
       ' SELECT ''' + @NodeName + ''', ' + @FieldName + ', ' + '''' + @Group + '''' + ', ' + CAST(@SummaryOrder AS NVARCHAR(10)) +  
       ' FROM ' + @TableName +   
       CASE WHEN @ProcedureId>0 THEN @Procedure_Reporting_TableJoinText ELSE '' END +  
       ' WHERE ' + @Condition;  
   
  --PP_Therapies (Therapeutic procedures) should be displayed for UGI old style report only, else should be part of the site  
  IF @TableName <> '[ERS_Procedures]' AND @EpisodeNo > 0   
  BEGIN  
   IF @FieldName IN ('[PP_Therapies]', '[PP_SpecimenTaken]' )  
    SET @SQLString = @SQLString + ' AND ISNULL([Report Style],0) = 0'  
   --PP2_SiteData (Site Data) should not be displayed for UGI old style report  
   ELSE IF @FieldName = '[PP2_SiteData]'  
    SET @SQLString = @SQLString + ' AND ISNULL([Report Style],0) = 1'  
  END   
  
  SET @ExecQuery =   
   CASE   
    WHEN @FieldName = '[PP_NPSAalert]' AND @TableName <> '[Upper GI Procedure]' THEN 0  
    WHEN @FieldName = '[PP_ResectedColon]' AND @EpisodeNo > 0 THEN 0  
    WHEN @FieldName = '[Resected colon no]' AND @TableName <> '[Colon Procedure]' THEN 0  
    WHEN @FieldName = '[PP_Coding]' AND @TableName <> '[ERS_Procedures]' THEN 0  
    WHEN @FieldName = '[Report style]' AND @TableName = '[ERS_Procedures]' THEN 0  
    WHEN LEFT(@FieldName,10) = '[PP2_Patho' AND @TableName = '[ERS_Procedures]' THEN 0  
    ELSE 1  
   END  
  
  --Select @ProcedureId, @EpisodeNo, @PatientComboId, @sqlstring  
  IF @ExecQuery = 1   
  BEGIN  
   EXEC sp_executesql @SQLString,  
    N'@ProcedureId INT, @EpisodeNo INT, @PatientComboId VARCHAR(30)',  
    @ProcedureId, @EpisodeNo, @PatientComboId  
  END  
  
  FETCH NEXT FROM report_cursor INTO @FieldName  
 END  
  
 CLOSE report_cursor  
 DEALLOCATE report_cursor  
  
 IF @EpisodeNo > 0 --UGI  
 BEGIN  
  UPDATE #Summary SET NodeSummary = REPLACE(NodeSummary,char(13),'<BR />') WHERE NodeName in ('Report', 'Indications', 'Advice/comments')   
  --UPDATE #Summary SET NodeSummary = REPLACE(NodeSummary,'<br><b>','<b>') WHERE NodeName in ('Site Data')  
  UPDATE #Summary SET NodeSummary = REPLACE(NodeSummary,'</b>','</b><BR />') WHERE NodeName in ('Site Data')   
  --UPDATE #Summary SET NodeSummary = REPLACE(NodeSummary,char(13),'<BR />&nbsp;&nbsp;') WHERE NodeName in ('Site Data')   
  --UPDATE #Summary SET NodeSummary = REPLACE(NodeSummary,'<BR />&nbsp;&nbsp;<b>','<BR /><b>') WHERE NodeName in ('Site Data')   
 END   
  
 IF EXISTS(SELECT TOP 1 NodeName FROM #Summary WHERE NodeName = 'InstForCare')  
 BEGIN   
  UPDATE #Summary SET NodeName = (SELECT TOP 1 NodeSummary FROM #Summary WHERE NodeName = 'InstForCareHeading')  
   ,NodeSummary = dbo.fnFirstLetterUpper(NodeSummary)  
  WHERE NodeName = 'InstForCare'  
  
  DELETE #Summary WHERE NodeName = 'InstForCareHeading'  
 END  
  
 --Append NPSA alert to end of report section  
 IF (SELECT COUNT(*) FROM #Summary WHERE NodeName = 'Report') > 0  
 BEGIN  
  DECLARE @NPSAalert NVARCHAR(MAX)   
  IF @EpisodeNo > 0  
   SELECT @NPSAalert=CONVERT(NVARCHAR(MAX),[PP_NPSAalert]) FROM  [Upper GI Procedure] WHERE [Patient No] = @PatientComboId AND [Episode No] = @EpisodeNo  
  ELSE IF @ProcedureId IS NOT NULL AND @ProcedureId > 0  
   SELECT @NPSAalert=CONVERT(NVARCHAR(MAX),[PP_NPSAalert]) FROM [ERS_ProceduresReporting] WHERE ProcedureId = @ProcedureId  
  
  IF ISNULL(@NPSAalert,'') <> ''  
   UPDATE #Summary  
   SET NodeSummary = NodeSummary + '<table style="border: 1px solid red;border-radius:10px;-moz-border-radius:10px;-webkit-border-radius:10px;width:95%;"><tr><td style="padding:10px;color:red;">' + @NPSAalert + '</td><td style="width:5%;padding:5px;"><img src="/images/icons/alert.png" style="vertical-align:middle; padding:0px 2px 0px 2px;" /></td></tr></table>'  
   WHERE NodeName = CASE WHEN @EpisodeNo > 0 THEN 'Site Data' ELSE 'Report' END  
 END  
  
	SELECT S.[NodeName], S.[NodeSummary], S.[Group]
	FROM #Summary S
	left outer join #xmlmap x on x.NodeName = S.NodeName
	WHERE S.NodeSummary IS NOT NULL
	order by S.SummaryOrder --x.OrderID 
  
 DROP TABLE #xmlmap  
 DROP TABLE #Summary
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	No TFS - Item 4071
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ahmed Shoud
-- TFS#	No TFS - Item 3676 
-- Description of change
--  Pathway plan on report out of set order in system setting 
------------------------------------------------------------------------------------------------------------------------

GO
EXEC dbo.DropIfExist @ObjectName = 'procedure_pathway_plan_answers_save',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)

GO
CREATE PROCEDURE [dbo].[procedure_pathway_plan_answers_save]
(
	@ProcedureId int,
	@QuestionId	int,
	@OptionAnswer int = null,
	@FreeTextAnswer varchar(max) = NULL,
	@ComboBoxItemId INT,
	@LoggedInUserId int
)
AS
BEGIN
	DECLARE @Optional BIT = (SELECT eppq.Optional FROM dbo.ERS_PathwayPlanQuestions eppq WHERE eppq.QuestionId=@QuestionId)

	IF NOT EXISTS (SELECT 1 FROM ERS_ProcedurePathwayPlanAnswers WHERE QuestionId = @QuestionId AND ProcedureId = @ProcedureId)
	BEGIN
		INSERT INTO ERS_ProcedurePathwayPlanAnswers (ProcedureId, QuestionId, OptionAnswer, FreeTextAnswer, EvidenceOfCancer, WhoCreatedId, WhenCreated)
		VALUES (@ProcedureId, @QuestionId, CASE WHEN @Optional = 1 THEN @OptionAnswer ELSE NULL END, @FreeTextAnswer, @ComboBoxItemId, @LoggedInUserId, getdate())
	END
	ELSE
	BEGIN
		UPDATE ERS_ProcedurePathwayPlanAnswers
		SET OptionAnswer= CASE WHEN @Optional = 1 THEN @OptionAnswer ELSE NULL END, FreeTextAnswer = @FreeTextAnswer, EvidenceOfCancer = @ComboBoxItemId, WhoUpdatedId = @LoggedInUserId	, WhenUpdated = getdate()
		WHERE ProcedureId = @ProcedureId AND QuestionId = @QuestionId	
	END

	DECLARE @ComboBoxItemText VARCHAR(200) = ''
	DECLARE @EvidenceOfCancer INT = (SELECT EvidenceOfCancer FROM ERS_ProcedurePathwayPlanAnswers WHERE EvidenceOfCancer > 0 AND ProcedureId = @ProcedureId)
	IF @EvidenceOfCancer > 0
	BEGIN
		SET @ComboBoxItemText = (SELECT ListItemText FROM ers_lists WHERE ListId = @EvidenceOfCancer)
	END
	
	DECLARE @PathwayPlan varchar(max) = 
	(SELECT efuq.Question + ' ' + ISNULL(CASE OptionAnswer WHEN 1 THEN 'Yes' WHEN 0 THEN 'No' WHEN -1 THEN 'Unknown' END, '') + 
			CASE WHEN OptionAnswer IS NOT NULL AND NULLIF(FreeTextAnswer,'') IS NOT NULL THEN ', ' ELSE '' END 
	+ ISNULL(FreeTextAnswer, '') + ' ' + CASE WHEN efuq.Question IN ('Evidence of cancer?') AND @ComboBoxItemText <> ''
	THEN '(' + @ComboBoxItemText + ')' ELSE '' END + ' ** ' AS [text()]
	FROM dbo.ERS_PathwayPlanQuestions efuq
	INNER JOIN ERS_ProcedurePathwayPlanAnswers epfuqa ON efuq.QuestionId = epfuqa.QuestionId
	WHERE ProcedureId = @ProcedureId
	ORDER BY efuq.OrderById
	FOR XML PATH (''))

	UPDATE ERS_ProceduresReporting SET PP_PathwayPlan = REPLACE(@PathwayPlan, '**', '<br />') WHERE ProcedureId = @ProcedureId

END
Go
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	No TFS - Item 3676
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ahmed Shoud
-- TFS#	No TFS - Item 3673 
-- Description of change
--  Terminal ulcer
------------------------------------------------------------------------------------------------------------------------

UPDATE ERS_DiagnosesMatrix SET DisplayName = 'Terminal Ileum Ulcer(s)'
WHERE Section = 'Colon' AND ProcedureTypeID = 3 AND CODE = 'D100p3'

GO
EXEC dbo.DropIfExist @ObjectName = 'TR_ColonAbnoMucosa',      -- varchar(100)
                     @ObjectTypePrefix = 'TR' -- varchar(5)

GO
CREATE TRIGGER [dbo].[TR_ColonAbnoMucosa]
ON [dbo].[ERS_ColonAbnoMucosa]
AFTER INSERT, UPDATE, DELETE
AS 
	DECLARE @site_id INT, @RedundantRectal VARCHAR(10), @HasUlcer VARCHAR(10), @UserID as int, @Mucosa VARCHAR(10), @UlcerativeMucosa VARCHAR(10), @Action CHAR(1) ='I', @ProcedureTypeId INT
	DECLARE @MucosalInflammation VARCHAR(10), @Ulcerative VARCHAR(10), @Region varchar(50)

    IF EXISTS(SELECT * FROM DELETED) SET @Action = CASE WHEN EXISTS(SELECT * FROM INSERTED) THEN 'U' ELSE 'D' END

	IF @Action IN ('I', 'U') 
	BEGIN
		SELECT @site_id=SiteId, 
			@RedundantRectal = (CASE WHEN (RedundantRectal=1) THEN 'True' ELSE 'False' END),
			@HasUlcer = (CASE WHEN (SmallUlcers=1 OR LargeUlcers=1 OR PleomorphicUlcers=1 OR SerpiginousUlcers=1 
									OR AphthousUlcers=1 OR ConfluentUlceration=1 OR DeepUlceration=1 OR SolitaryUlcer=1)
									THEN 'True' ELSE 'False' END),
			@UserID = (CASE WHEN ISNULL(WhoUpdatedId,0) = 0 THEN WhoCreatedId ELSE WhoUpdatedId END),
			@Mucosa = (CASE WHEN ([None] = 0 AND InflammatoryColitis = 0 AND InflammatoryIleitis = 0 AND InflammatoryProctitis = 0) THEN 'True' ELSE 'False' END),
			@UlcerativeMucosa = (CASE WHEN (CobblestoneMucosa = 1) THEN 'True' ELSE 'False' END),
			@Ulcerative = (CASE WHEN (Inserted.Ulcerative = 1) THEN 'True' ELSE 'False' END),
			@MucosalInflammation = CASE WHEN (Atrophic = 1 OR Congested = 1 OR Erythematous = 1 OR Granular = 1 OR Exudate = 1 OR Pigmented = 1) THEN 'True' ELSE 'False' END

		FROM INSERTED
	END
	
	--insert into ERS_ErrorLog(ErrorMessage, ErrorTimestamp, ProductId, ProductVersion, UserId, HospitalId, OperatingHospitalId) 
	--		VALUES (	
	--					'RedundantRectal: ' + @RedundantRectal + ', ' + 
	--					'HasUlcer: ' + @HasUlcer + ', ' +	--					
	--					'UlcerativeMucosa: ' + @UlcerativeMucosa + ', ' + 
	--					'MucosalInflammation: ' + @MucosalInflammation,
	--					GETDATE(), 1, '1', 1, 1, 1)	

	IF @MucosalInflammation = 'True'
		SET @Mucosa = 'False'
		
	IF @HasUlcer = 'True' 	
		SET @Ulcerative = 'False'	-- Ulcerative checkbox only	
	ELSE IF @UlcerativeMucosa = 'True'
		SET @Ulcerative = 'False'	-- Ulcerative checkbox only	
	
	-- DELETED
	IF @Action = 'D'
	BEGIN
		SELECT @site_id=SiteId FROM DELETED
	END
	
	EXEC infer_mucosa_diagnoses @site_id, @UserID

	--insert into ERS_ErrorLog(ErrorMessage, ErrorTimestamp, ProductId, ProductVersion, UserId, HospitalId, OperatingHospitalId) 
	--		VALUES (	
	--					'RedundantRectal: ' + @RedundantRectal + ', ' + 
	--					'HasUlcer: ' + @HasUlcer + ', ' +	
	--					'UlcerativeMucosa: ' + @UlcerativeMucosa + ', ' + 
	--					'MucosalInflammation: ' + @MucosalInflammation,
	--					GETDATE(), 1, '1', 1, 1, 1)	

	SELECT @ProcedureTypeId = ep.ProcedureType FROM dbo.ERS_Procedures AS ep WHERE ep.ProcedureId IN (SELECT es.ProcedureId FROM dbo.ERS_Sites AS es WHERE es.SiteId = @site_id)
	SET @Region=(select x.Region from [ERS_AbnormalitiesMatrixColon] x inner join ERS_Regions r on x.region = r.Region AND r.ProcedureType= x.ProcedureType inner join ers_sites s on r.RegionId = s.RegionId where s.SiteId = @site_id )

	IF @ProcedureTypeId = 3	--COL
	BEGIN
		EXEC diagnoses_control_save @site_id, 'D15P3', @RedundantRectal			-- 'Redundant anterior rectal mucosa'
		
		IF @MucosalInflammation = 'True'
		BEGIN						
			--EXEC diagnoses_control_save @site_id, 'D21P3', 'False'				-- 'Mucosa'
			EXEC diagnoses_control_save @site_id, 'D26P3', 'False'				-- 'Rectal mucosa'			

			IF  @Region not in ('Rectum', 'Anal Margin', 'Terminal Ileum') --TFS 3673
			BEGIN				
				EXEC diagnoses_control_save @site_id, 'D80P3', 'False'			-- 'Rectal ulcer(s)'
				EXEC diagnoses_control_save @site_id, 'D83P3', @HasUlcer		-- 'Colonic ulcer(s)'
			END
			ELSE
			BEGIN				
				EXEC diagnoses_control_save @site_id, 'D80P3', @HasUlcer		-- 'Rectal ulcer(s)'				
			END
		END
		ELSE	--@MucosalInflammation = 'False'
		BEGIN						
			IF  @Region not in ('Rectum', 'Anal Margin', 'Terminal Ileum') --TFS 3673
			BEGIN
				--EXEC diagnoses_control_save @site_id, 'D21P3', 'True'			-- 'Mucosa'
				EXEC diagnoses_control_save @site_id, 'D26P3', 'False'			-- 'Rectal mucosa'				
				EXEC diagnoses_control_save @site_id, 'D80P3', 'False'			-- 'Rectal ulcer(s)'
				EXEC diagnoses_control_save @site_id, 'D83P3', @HasUlcer		-- 'Colonic ulcer(s)'
			END
			ELSE
			BEGIN
				--EXEC diagnoses_control_save @site_id, 'D21P3', 'False'			-- 'Mucosa'
				EXEC diagnoses_control_save @site_id, 'D26P3', 'False'			-- 'Rectal mucosa'		-- TFS 3673		
				EXEC diagnoses_control_save @site_id, 'D80P3', @HasUlcer		-- 'Rectal ulcer(s)'
				EXEC diagnoses_control_save @site_id, 'D83P3', 'False'			-- 'Colonic ulcer(s)'
			END
		END
		EXEC diagnoses_control_save @site_id, 'D25P3', @UlcerativeMucosa
		EXEC diagnoses_control_save @site_id, 'DUlcerativeP3', @Ulcerative	-- Ulcerative checkbox only
		EXEC diagnoses_control_save @site_id, 'DMucInfAllP3', @MucosalInflammation	-- Mucosal inflammation
	END
	ELSE IF @ProcedureTypeId = 4	--SIG
	BEGIN
		EXEC diagnoses_control_save @site_id, 'S15P3', @RedundantRectal		-- 'Redundant anterior rectal mucosa'
		
		IF @MucosalInflammation = 'True'
		BEGIN						
			--EXEC diagnoses_control_save @site_id, 'S21P3', 'False'				-- 'Mucosa'
			EXEC diagnoses_control_save @site_id, 'S26P3', 'False'				-- 'Rectal mucosa'			

			IF  @Region not in ('Rectum', 'Anal Margin')
			BEGIN				
				EXEC diagnoses_control_save @site_id, 'S80P3', 'False'			-- 'Rectal ulcer(s)'
				EXEC diagnoses_control_save @site_id, 'S83P3', @HasUlcer		-- 'Colonic ulcer(s)'
			END
			ELSE
			BEGIN				
				EXEC diagnoses_control_save @site_id, 'S80P3', @HasUlcer		-- 'Rectal ulcer(s)'				
			END
		END
		ELSE	--@MucosalInflammation = 'False'
		BEGIN						
			IF  @Region not in ('Rectum', 'Anal Margin')
			BEGIN
				--EXEC diagnoses_control_save @site_id, 'S21P3', 'True'			-- 'Mucosa'
				EXEC diagnoses_control_save @site_id, 'S26P3', 'False'			-- 'Rectal mucosa'				
				EXEC diagnoses_control_save @site_id, 'S80P3', 'False'			-- 'Rectal ulcer(s)'
				EXEC diagnoses_control_save @site_id, 'S83P3', @HasUlcer		-- 'Colonic ulcer(s)'
			END
			ELSE
			BEGIN
				--EXEC diagnoses_control_save @site_id, 'S21P3', 'False'			-- 'Mucosa'
				EXEC diagnoses_control_save @site_id, 'S26P3', 'True'			-- 'Rectal mucosa'				
				EXEC diagnoses_control_save @site_id, 'S80P3', @HasUlcer		-- 'Rectal ulcer(s)'
				EXEC diagnoses_control_save @site_id, 'S83P3', 'False'			-- 'Colonic ulcer(s)'
			END
		END

		EXEC diagnoses_control_save @site_id, 'S25P3', @UlcerativeMucosa
		EXEC diagnoses_control_save @site_id, 'DUlcerativeP4', @Ulcerative	-- Ulcerative checkbox only
		EXEC diagnoses_control_save @site_id, 'DMucInfAllP4', @MucosalInflammation	-- Mucosal inflammation
	END
	ELSE IF @ProcedureTypeId = 5	--PROCT
	BEGIN
		EXEC diagnoses_control_save @site_id, 'P15P3', @RedundantRectal			-- 'Redundant anterior rectal mucosa'
		
		IF @MucosalInflammation = 'True'
		BEGIN						
			--EXEC diagnoses_control_save @site_id, 'P21P3', 'False'				-- 'Mucosa'
			EXEC diagnoses_control_save @site_id, 'P26P3', 'False'				-- 'Rectal mucosa'			

			IF  @Region NOT IN ('Rectum', 'Anal Margin')
			BEGIN				
				EXEC diagnoses_control_save @site_id, 'P80P3', 'False'			-- 'Rectal ulcer(s)'
				EXEC diagnoses_control_save @site_id, 'P83P3', @HasUlcer		-- 'Colonic ulcer(s)'
			END
			ELSE
			BEGIN				
				EXEC diagnoses_control_save @site_id, 'P80P3', @HasUlcer		-- 'Rectal ulcer(s)'				
			END
		END
		ELSE	--@MucosalInflammation = 'False'
		BEGIN						
			IF  @Region NOT IN ('Rectum', 'Anal Margin')
			BEGIN
				--EXEC diagnoses_control_save @site_id, 'P21P3', 'True'			-- 'Mucosa'
				EXEC diagnoses_control_save @site_id, 'P26P3', 'False'			-- 'Rectal mucosa'				
				EXEC diagnoses_control_save @site_id, 'P80P3', 'False'			-- 'Rectal ulcer(s)'
				EXEC diagnoses_control_save @site_id, 'P83P3', @HasUlcer		-- 'Colonic ulcer(s)'
			END
			ELSE
			BEGIN
				--EXEC diagnoses_control_save @site_id, 'P21P3', 'False'			-- 'Mucosa'
				EXEC diagnoses_control_save @site_id, 'P26P3', 'True'			-- 'Rectal mucosa'				
				EXEC diagnoses_control_save @site_id, 'P80P3', @HasUlcer		-- 'Rectal ulcer(s)'
				EXEC diagnoses_control_save @site_id, 'P83P3', 'False'			-- 'Colonic ulcer(s)'
			END
		END

		EXEC diagnoses_control_save @site_id, 'P25P3', @UlcerativeMucosa
		EXEC diagnoses_control_save @site_id, 'DUlcerativeP5', @Ulcerative	-- Ulcerative checkbox only
		EXEC diagnoses_control_save @site_id, 'DMucInfAllP5', @MucosalInflammation	-- Mucosal inflammation
	END
	ELSE IF @ProcedureTypeId = 9	--ENT RETRO
	BEGIN
		EXEC diagnoses_control_save @site_id, 'D15P9', @RedundantRectal		-- 'Redundant anterior rectal mucosa'

		IF @MucosalInflammation = 'True'
		BEGIN
			EXEC diagnoses_control_save @site_id, 'D80P9', 'False'			-- 'Rectal ulcer(s)', D83P9 for 'Colonic ulcer(s)'
			EXEC diagnoses_control_save @site_id, 'D83P9', 'True'			-- 'Rectal ulcer(s)', D83P9 for 'Colonic ulcer(s)'
		END
		ELSE
			EXEC diagnoses_control_save @site_id, 'D80P9', @HasUlcer			-- 'Rectal ulcer(s)', D83P9 for 'Colonic ulcer(s)'
							
		EXEC diagnoses_control_save @site_id, 'D26P9', @Mucosa
		EXEC diagnoses_control_save @site_id, 'D25P9', @UlcerativeMucosa
		EXEC diagnoses_control_save @site_id, 'DUlcerativeP9', @Ulcerative	-- Ulcerative checkbox only
		EXEC diagnoses_control_save @site_id, 'DMucInfAllP9', @MucosalInflammation	-- Mucosal inflammation
	END

	EXEC abnormalities_mucosa_summary_update @site_id
	EXEC sites_summary_update @site_id
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	No TFS - Item 3673
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ahmed Shoud
-- TFS#	No TFS - Item 2994 
-- Description of change
--  Allow search Orders & Waiting List across all Hospitals/Sites 
------------------------------------------------------------------------------------------------------------------------

GO
EXEC dbo.DropIfExist @ObjectName = 'get_OrderCommsList',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)

GO
CREATE PROCEDURE [dbo].[get_OrderCommsList]  
(@OperatingHospitalId varchar(50),
 @intOrderStatusId int,
 @intProcedureTypeId int,
 @intPriorityId int
)  
AS  
BEGIN  
-- Created on		:		16 July 2021		for Order Comms - Get paitients in OrderComms
-- Update History	:		19 July 2021		Mahfuz added Status column -> table with Lists/ListsMain
--					:		14 Jun 2022			Mahfuz removed some columns, change link to Priority tables
 SELECT
 alert = 
		Case 
			when datediff(day, GETDATE(), DATEADD(Day, OP.BreachDays,oc.OrderDate)) <= 7 then '<img src="../../Images/ocsred.png" width="20px" title="Breach days 7 days or less" />'
			when datediff(day, GETDATE(), DATEADD(Day, OP.BreachDays,oc.OrderDate)) <= 14 then '<img src="../../Images/ocsamber.png" width="20px" title="Breach days 14 days or less" />'
			when datediff(day, GETDATE(), DATEADD(Day, OP.BreachDays,oc.OrderDate)) <= 21 then '<img src="../../Images/ocsgreen.png" width="20px"  title="Breach days 21 days or less"/>'
		end,
  datediff(day, GETDATE(), DATEADD(Day, OP.BreachDays,oc.OrderDate)) as BreachDays,
  oc.OrderId,  
  pat.PatientId,  
  pt.ProcedureTypeId,  
  pt.ProcedureType,  
  oc.OrderDate,  
  pat.Forename1 as Forename,  
  pat.Surname,  
  pat.DateOfBirth,  
  pat.HospitalNumber,  
  PAT.NHSNo,  
  OP.PriorityDescription as 'Priority',  
  oc.DueDate,  
  --oc.AssignedCareProfessional,  
  --oc.Referrer,
  oc.TestSite,
  oc.BedLocation,
  oc.OrderNumber,
  ocSource.ListItemText as OrderSource,
  ocStatus.ListItemText as [Status],
  oph.HospitalName
 FROM ERS_Orders oc  
  INNER JOIN ERS_Patients pat ON oc.PatientId = pat.PatientId  
  --INNER JOIN dbo.ERS_SCH_SlotStatus esss ON esss.StatusId = oc.PriorityId  
  left join ERS_OrdersPriority OP on oc.OrdersPriorityId = OP.OrdersPriorityId
  INNER JOIN dbo.ERS_ProcedureTypes pt ON oc.ProcedureType = pt.ProcedureTypeId  
  Left Join (Select l.* from dbo.ERS_Lists l
  inner join  ERS_ListsMain lm on l.ListMainId=lm.ListMainId Where lm.ListDescription = 'OrderComms Status' and l.ListDescription='OrderComms Status') as ocStatus on oc.StatusId=ocStatus.ListItemNo
  Left Join (Select l.* from dbo.ERS_Lists l
  inner join  ERS_ListsMain lm on l.ListMainId=lm.ListMainId Where lm.ListDescription = 'OrderComms Order Source' and l.ListDescription='OrderComms Order Source') as ocSource on
  oc.OrderSourceListNo = ocSource.ListItemNo
  INNER JOIN ERS_OperatingHospitals oph ON oc.OperatingHospitalId = oph.OperatingHospitalId
 WHERE oc.OperatingHospitalId IN (
	SELECT item FROM fnSplitString(@OperatingHospitalId, ',')
 )
 and oc.StatusId = IsNull(@intOrderStatusId,oc.StatusId)
 and oc.ProcedureType = IsNull(@intProcedureTypeId,oc.ProcedureType)
 and oc.OrdersPriorityId = IsNull(@intPriorityId,oc.OrdersPriorityId)
 
END

GO

GO
EXEC dbo.DropIfExist @ObjectName = 'get_waitlist_patients_book_from_wailtlist',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)

GO
CREATE PROCEDURE [dbo].[get_waitlist_patients_book_from_wailtlist]
(
	@OperatingHospitalId VARCHAR(max)
)
AS
/* Update History		:		07 Sept 2021		MH added OrderComm OrderID if record came from OrderComm 
						:		08 Sept 2021		MH added default Scheduler diagnostic and therapeutic procedure
						:		15 Dec 2022			MH changed image icons location
*/
BEGIN
	SELECT 
		alert = 
		Case 
			when datediff(day, GETDATE(), DATEADD(Day, esss.BreachDays,ewl.DateRaised)) <= 7 then '<img src="../../../Images/ocsred.png" width="45%" />'
			when datediff(day, GETDATE(), DATEADD(Day, esss.BreachDays,ewl.DateRaised)) <= 14 then '<img src="../../../Images/ocsamber.png" width="45%" />'
			when datediff(day, GETDATE(), DATEADD(Day, esss.BreachDays,ewl.DateRaised)) <= 21 then '<img src="../../../Images/ocsgreen.png" width="45%" />'
		end,
		ewl.PatientId,
		ep.Forename1,
		ep.Surname,
		dbo.fnGender(ep.GenderId) AS Gender,
		dbo.fnFullAddress(ep.Address1, ep.Address2, ep.Address3, ep.Address4, ep.Postcode) AS Address,
		ep.DateOfBirth,
		ep.Postcode,
		ep.NHSNo,
		ep.HospitalNumber,
		ewl.WaitingListId, 
		ewl.PatientId, 
		ewl.DateEntered,
		ewl.PriorityId,
		esss.Description AS PriorityDescription, 
		ewl.DueDate, 
		DATEADD(Day, esss.BreachDays,ewl.DateRaised) AS BookBy,
		datediff(day, GETDATE(), DATEADD(Day, esss.BreachDays,ewl.DateRaised)) as DaysToBreach,
		datediff(day, ewl.DateRaised, getdate()) as WaitDays,
		ewl.WaitingListStatusId, 
		ewl.Notes, 
		ewl.OperatingHospitalId, 
		ewl.DateRaised, 
		ewl.Duration, 
		ewl.ProcedureTypeId,
		ewl.ReferrerId,
		ec.CompleteName AS Referrer,
		ept.ProcedureType,
		ewl.ProcedureTypeId,
		ewl.DiagnosticProcedure,
		ewl.TherapeuticProcedure,
		ept.SchedulerDiagnostic as DefaultSchedulerDiagnostic,
		ept.SchedulerTherapeutic as DefaultSchedulerTherapeutic,
		ewl.AdmissionTypeId,
		oc.OrderId,
		oph.HospitalName
	FROM dbo.ERS_Waiting_List ewl
		INNER JOIN dbo.ERS_Patients ep ON ewl.PatientId = ep.PatientId
		INNER JOIN dbo.ERS_SCH_SlotStatus esss ON esss.StatusId = ewl.PriorityId
		LEFT JOIN dbo.ERS_Consultant ec ON ec.ConsultantID = ewl.ReferrerId
		INNER JOIN dbo.ERS_ProcedureTypes ept ON ewl.ProcedureTypeId = ept.ProcedureTypeId
		left join dbo.ERS_Orders oc on oc.WaitingListId = ewl.WaitingListId
		INNER JOIN ERS_OperatingHospitals oph ON ewl.OperatingHospitalId = oph.OperatingHospitalId
	WHERE ewl.OperatingHospitalId IN
		(SELECT item FROM fnSplitString(@OperatingHospitalId, ','))
	  AND ewl.WaitingListStatusId = (SELECT UniqueId FROM ERS_AppointmentStatus WHERE HDCKey = 'R')
	order by datediff(day, GETDATE(), DATEADD(Day, esss.BreachDays,ewl.DateRaised)) 
END

GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	No TFS - Item 2994
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ahmed Shoud
-- TFS#	No TFS - Item 2827 
-- Description of change
--  Show selected Patient category on Lab Request Form 
------------------------------------------------------------------------------------------------------------------------

GO
EXEC dbo.DropIfExist @ObjectName = 'printreport_patient_info_select',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)

GO
CREATE PROCEDURE [dbo].[printreport_patient_info_select]
(
	@ProcedureId INT,
	@EpisodeNo INT = 0,
    @PatientComboId VARCHAR(30) = NULL,
    @ProcedureType INT
)
AS

SET NOCOUNT ON

IF @ProcedureId IS NOT NULL AND @ProcedureId > 0
BEGIN

	DECLARE @PP_GPAddress VARCHAR(1000), @PP_GPName VARCHAR(1000)
	SELECT @PP_GPAddress =PP_GPAddress, @PP_GPName= PP_GPName FROM dbo.[ERS_ProceduresReporting] WHERE ProcedureId = @ProcedureId;

	SELECT 
			ISNULL(p.Title + ' ', '') + ISNULL(p.Forename1 + ' ', '') + ISNULL(p.Surname, '') AS PatientName, 
			ISNULL(p.Forename1, '') AS Forename,
			ISNULL(p.Surname, '') AS Surname,
			ISNULL(p.Gender, '') AS Gender,
			ISNULL(p.[DateOfBirth], '') AS DateOfBirth,
			ISNULL(p.[NHSNo],'') AS NHSNo, 
			ISNULL(p.[HospitalNumber], '') as CaseNoteNo, 
			ISNULL(REPLACE(p.[Address],',', CHAR(10)),'') AS [Address],
			ISNULL(REPLACE(p.GPName, CHAR(44),'<br />'),'')  AS GPName,
			CASE WHEN p.GPName IS NOT NULL then REPLACE(p.GPName, CHAR(44),'') + '<br />' ELSE '' END + 
				ISNULL(REPLACE(REPLACE(LTRIM(RTRIM(p.PracticeName)), CHAR(13), '<br/>'), CHAR(10), '<br/>'),'<br/>') + 
				ISNULL(REPLACE(REPLACE(LTRIM(RTRIM(p.GPAddressHTML)), CHAR(13), '<br/>'), CHAR(10), '<br/>'),'<br/>') AS GPAddress,
			ISNULL(CONVERT(VARCHAR(11),pj.ProcedureStartTime,106) + ' (' + CONVERT(VARCHAR(5),pj.ProcedureStartTime,108) + CASE WHEN pj.ProcedureEndTime is null THEN ')' ELSE ' - ' + CONVERT(VARCHAR(5), pj.ProcedureEndTime, 108) + ')' END,'') AS ProcedureDate, 
			ISNULL(ps.ListItemText, '') AS PatientStatus, 
			ISNULL(oh.HospitalName,'') AS HospitalName,
			ISNULL(oh.ContactNumber,'') AS HospitalPhoneNumber,
			ISNULL(w.WardDescription,'') AS Ward,
			ISNULL(eut.Description,'') AS PatientPriority,
			pr.PatientType AS PatientType
	FROM 
			ERS_VW_PatientswithGP p 
	INNER JOIN 
			ERS_Procedures pr ON p.[PatientId] = pr.PatientId 
	LEFT JOIN 
			ERS_Lists ps ON pr.PatientStatus = ps.ListItemNo AND ps.ListDescription = 'Patient Status'
	LEFT JOIN 
			ERS_Wards w ON pr.Ward = w.WardId
	LEFT JOIN 
			ERS_Lists c ON pr.CategoryListId = c.ListItemNo AND c.ListDescription = 'Procedure Category'
	INNER JOIN 
			ERS_OperatingHospitals oh ON pr.OperatingHospitalID = oh.OperatingHospitalId
	LEFT JOIN ERS_PatientJourney pj ON pr.ProcedureId = pj.ProcedureId 
	LEFT JOIN dbo.ERS_UrgencyTypes eut ON eut.UniqueId = pr.CategoryListId
	WHERE 
			pr.ProcedureId = @ProcedureId 
END

ELSE
BEGIN

       DECLARE @TableName VARCHAR(100) = (SELECT dbo.fnGetUGI_tablename(@ProcedureType,'procedure') 
										FROM [Episode]  
										WHERE CHARINDEX('1', [Status]) BETWEEN 1 AND 12 
										AND [Patient No] = @PatientComboId 
										AND [Episode No] = @EpisodeNo)

	DECLARE @SQL NVARCHAR(MAX) = 'DECLARE @HospId INT, @PP_RepDateAndTime VARCHAR(100), @PP_PatAddress VARCHAR(100), @PP_GP VARCHAR(1000), @HospName VARCHAR(50) '
	SET @SQL = @SQL + ' SELECT @HospId = [Operating Hospital ID], @PP_RepDateAndTime = [PP_RepDateAndTime], @PP_PatAddress = [PP_PatAddress], @PP_GP= ISNULL(PP_GP ,'''') FROM '
						+ @TableName +'  WHERE [Episode No] = ' + cast(@EpisodeNo as varchar(50))  
       
	SET @SQL = @SQL + ' SELECT @HospName = Name FROM [Operating Hospital] WHERE ID = @HospId '

	SET @SQL = @sql +  N'SELECT 
			ISNULL(p.Title,'''') + '' '' + ISNULL(p.Forename, '''') + '' '' + p.Surname AS PatientName, 
			ISNULL(p.Forename, '''') AS Forename,
			ISNULL(p.Surname, '''') AS Surname,
			ISNULL(Gender, '''') AS Gender,
			ISNULL([Date of Birth], '''') AS DateOfBirth, 
			ISNULL([NHS No],'''') AS NHSNo, 
			ISNULL([Case note no], '''') AS CaseNoteNo, 
			--ISNULL(REPLACE(REPLACE(p.[Address], CHAR(13),''), CHAR(10),''<br />''), '''') +  ISNULL(REPLACE(REPLACE(p.[Post code], CHAR(13),''''), CHAR(10),''''), '''') AS [Address],
			ISNULL(@PP_PatAddress,'''') AS [Address], 
			'''' AS GPName, --ISNULL(p.[GP Name], '''') AS GPName, 
			ISNULL(@PP_GP, '''') AS GPAddress, --ISNULL(p.[GP Address], '''') AS GPAddress,
			--LEFT(CONVERT(VARCHAR(30), e.[Procedure time], 113), 17) AS ProcedureDate, 
			--FORMAT(e.[Episode date], ''dd MMMM yyyy'', ''en-GB'') + FORMAT(e.[Procedure time], '' (HH:mm:ss)'', ''en-GB'') AS ProcedureDate, 
			--CONVERT(VARCHAR(11),e.[Episode date],106) + '' ('' + CONVERT(VARCHAR(5),e.[Procedure time],108) + '')'' AS ProcedureDate, 
			ISNULL(@PP_RepDateAndTime,'''') AS ProcedureDate, 
			ISNULL(ps.[List item text], '''') AS PatientStatus, 
			--ISNULL(p.Hospitals, '''') AS HospitalName,
			ISNULL(@HospName ,'''') AS HospitalName,
			'''' AS HospitalPhoneNumber,
			ISNULL(w.[List item text], '''') AS Ward
	FROM 
			Patient p 
	INNER JOIN
			Episode e ON p.[Combo ID] = e.[Patient No]
	LEFT JOIN 
			Lists ps ON p.[Patient Status 1] = ps.[List item no] AND ps.[List description] = ''PatientStatus''
	LEFT JOIN 
			Lists w ON p.Ward = w.[List item no] AND w.[List description] = ''Ward''
	WHERE 
			p.[Combo ID] = ''' + @PatientComboId + ''' AND
			e.[Episode No] = ' + CAST(@EpisodeNo AS VARCHAR(10))

	EXEC sp_executesql @SQL
END
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	No TFS - Item 2827
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ahmed Shoud
-- TFS#	No TFS - Item 4071 
-- Description of change
-- Referral Type (GP) add free text box
------------------------------------------------------------------------------------------------------------------------
GO

IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.COLUMNS
    WHERE TABLE_NAME = 'ERS_Procedures'
      AND COLUMN_NAME IN ('GPReferrer')
)
BEGIN
    ALTER TABLE dbo.ERS_Procedures
    ADD GPReferrer VARCHAR(500) NULL;
END

GO

IF NOT EXISTS(SELECT * FROM ERS_XMLMap WHERE FieldName = 'PP_RefConsName' AND NodeName = 'RefConsName' AND [Group] = 'GPD' AND Active = -1 AND OrderID IS NULL)
	BEGIN 
		INSERT INTO ERS_XMLMap(FieldName, NodeName, [Group], Active, OrderID) VALUES('PP_RefConsName', 'RefConsName', 'GPD', -1, NULL)
	END 

GO

EXEC dbo.DropIfExist @ObjectName = 'usp_Procedures_Insert',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[usp_Procedures_Insert]
(
	@ProcedureType		INT,
	--@PatientNo		VARCHAR(24),
	@PatientId			INT,
	@ProcedureDate		DATETIME,
	@ProcedureTime		VARCHAR(2),
	@PatientStatus		INT,
	@PatientWard		INT,
	@PatientType		INT,
	@OperatingHospitalId INT,
	@ListConsultant		INT,
	@Endoscopist1		INT,
	@Endoscopist2		INT,
	@Assistant			INT,
	@Nurse1				INT,
	@Nurse2				INT,
	@Nurse3				INT,
	@Nurse4				INT,
	@ReferralHospitalNo INT,
	@ReferralConsultantNo INT,
	@ReferralConsultantSpeciality INT,
	@PatientConsent		TINYINT,
	@DefaultCheckBox	BIT,
	@UserID				INT,
	@ProductType		TINYINT,
	@ListType			TINYINT,
	@Endo1Role			TINYINT,
	@Endo2Role			TINYINT,
	@CategoryListId		INT,
	@OnWaitingList		BIT,
	@OpenAccessProc		TINYINT,
	@EmergencyProcType	TINYINT,
	@NewProcedureId		INT OUTPUT,	-- This will return the newly created ProcedureId to the GUI! To play
	@ImagePortId		INT,
	@Points				DECIMAL,
	@ChecklistComplete	BIT,
	@ReferrerType		INT,
	@GPReferrer VARCHAR(500) = NULL,
	@ReferrerTypeOther  VARCHAR(500),
	@ProviderId			INT,
	@ProviderOther		VARCHAR(500),
	@PatientNotes		BIT,
	@PatientReferralLetter	BIT,
	@ImageGenderID	int,
	@OrderId	int
)
AS

SET NOCOUNT ON

DECLARE @newProcId INT
DECLARE @ppEndos VARCHAR(2000), @GPName varchar(255), @GPAddress varchar(max), @Endo1 varchar(500), @Endo2 varchar(500), @RefCons varchar(50), @RefHosp varchar(50)

BEGIN TRANSACTION
--sp_help 'dbo.ERS_Procedures'
	BEGIN TRY
		INSERT INTO ERS_Procedures
			(ProcedureType,
			CreatedBy,	
			CreatedOn,			
			ModifiedOn,
			ProcedureTime,
			PatientId,
			CategoryListId,
			OnWaitingList,
			OpenAccessProc,
			EmergencyProcType,
			OperatingHospitalID,
			ListConsultant,
			Endoscopist1,
			Endoscopist2,
			Assistant,
			Nurse1,
			Nurse2,
			Nurse3,
			Nurse4,
			ReferralHospitalNo,
			ReferralConsultantNo,
			ReferralConsultantSpeciality,
			PatientStatus,
			Ward,
			PatientType,
			PatientConsent,
			ListType,
			Endo1Role,
			Endo2Role,
			ImagePortId,
			WhoCreatedId,
			WhenCreated,
			Points,
			ChecklistComplete,
			ReferrerType,
			GPReferrer,
			ReferrerTypeOther,
			ProviderTypeId,
			ProviderOther,
			PatientNotes,
			PatientReferralLetter,
			ImageGenderID,
			OrderId)
		VALUES (
			@ProcedureType,
			@UserID,
			@ProcedureDate, --CASE WHEN CONVERT(DATE, GETDATE()) = @ProcedureDate THEN GETDATE() ELSE @ProcedureDate END, --Insert date and time if Procedure date is current date
			GETDATE(),
			@ProcedureTime,
			@PatientId,
			@CategoryListId,
			@OnWaitingList,
			@OpenAccessProc,
			@EmergencyProcType,
			@OperatingHospitalID,
			@ListConsultant,
			@Endoscopist1,
			@Endoscopist2,
			@Assistant,
			@Nurse1,
			@Nurse2,
			@Nurse3,
			@Nurse4,
			@ReferralHospitalNo,
			@ReferralConsultantNo,
			@ReferralConsultantSpeciality,
			@PatientStatus,
			@PatientWard,
			@PatientType,
			@PatientConsent, 
			@ListType,
			@Endo1Role,
			@Endo2Role,
			@ImagePortId,
			@UserID,
			GETDATE(),
			@Points,
			@ChecklistComplete,
			@ReferrerType,
			@GPReferrer,
			@ReferrerTypeOther,
			@ProviderId,
			@ProviderOther,
			@PatientNotes,
			@PatientReferralLetter,
			@ImageGenderID,
			@OrderId)

		SET @newProcId = SCOPE_IDENTITY();
	
		--## Important Work- Insert a Blank Record in the ERS_ProceduresReorting- with this Unique ID! So, you can simply Update the PP fields later..!! 
		INSERT INTO dbo.ERS_ProceduresReporting(ProcedureId)VALUES(@newProcId);

		SET @ppEndos = ''
		IF @ListConsultant > 0 SELECT @ppEndos = @ppEndos + '$$List Consultant: ' + Title + ' ' + Forename + ' ' + Surname FROM ERS_Users WHERE UserID = @ListConsultant
		IF @Endoscopist1 > 0 
		BEGIN
			SELECT @Endo1 = Title + ' ' + Forename + ' ' + Surname FROM ERS_Users WHERE UserID = @Endoscopist1
			SELECT @ppEndos = @ppEndos + '$$Endoscopist No1: ' + @Endo1
			SELECT  @Endo1 = Title + ' ' + Forename + ' ' + Surname + 
					CASE WHEN isnull(Qualifications, '') != '' THEN ', ' + Qualifications else '' END + 
					CASE WHEN isnull(u.JobTitleID, 0) > 0 THEN CHAR(13)+CHAR(10) + jt.Description ELSE '' END  
			FROM ERS_Users u
			LEFT JOIN ERS_JobTitles jt on u.JobTitleID = jt.JobTitleID 
			WHERE UserID = @Endoscopist1
		END
		IF @Endoscopist2 > 0 
		BEGIN
			SELECT @Endo2 = Title + ' ' + Forename + ' ' + Surname FROM ERS_Users WHERE UserID = @Endoscopist2
			SELECT @ppEndos = @ppEndos + '$$Endoscopist No2: ' + @Endo2
			SELECT  @Endo2 = Title + ' ' + Forename + ' ' + Surname + 
					CASE WHEN isnull(Qualifications, '') != '' THEN ', ' + Qualifications else '' END + 
					CASE WHEN isnull(u.JobTitleID, 0) > 0 THEN CHAR(13)+CHAR(10) + jt.Description ELSE '' END  
			FROM ERS_Users u
			LEFT JOIN ERS_JobTitles jt on u.JobTitleID = jt.JobTitleID 		
			WHERE UserID = @Endoscopist2
		END
		IF @Nurse1 > 0 OR @Nurse2 > 0 OR @Nurse3 > 0 OR @Nurse4 > 0 
		BEGIN
			SELECT @ppEndos = @ppEndos + '$$' + 'Nurses: '
			IF @Nurse1 > 0 SELECT @ppEndos = @ppEndos + '##' + Title + ' ' + Forename + ' ' + Surname FROM ERS_Users WHERE UserID = @Nurse1
			IF @Nurse2 > 0 SELECT @ppEndos = @ppEndos + '##' + Title + ' ' + Forename + ' ' + Surname FROM ERS_Users WHERE UserID = @Nurse2
			IF @Nurse3 > 0 SELECT @ppEndos =  @ppEndos + '##' + Title + ' ' + Forename + ' ' + Surname FROM ERS_Users WHERE UserID = @Nurse3
			IF @Nurse4 > 0 SELECT @ppEndos =  @ppEndos + '##' + Title + ' ' + Forename + ' ' + Surname FROM ERS_Users WHERE UserID = @Nurse4
		END
		IF CHARINDEX('$$', @ppEndos) > 0 SET @ppEndos = REPLACE(STUFF(@ppEndos, charindex('$$', @ppEndos), 2, ''), '$$', '<br/>')
		IF CHARINDEX('##', @ppEndos) > 0 SET @ppEndos = REPLACE(STUFF(@ppEndos, charindex('##', @ppEndos), 2, ''), '##', '<br/>')
	
		SET @RefCons=''
		IF @ReferrerType = 1
		BEGIN
			SET @RefCons = 'GP'
		END
		ELSE IF @ReferrerType = 5
		BEGIN
			SET @RefCons = @ReferrerTypeOther
		END
		ELSE
		BEGIN
			SELECT @RefCons = ec.CompleteName FROM dbo.ERS_Consultant ec WHERE ec.ConsultantID = @ReferralConsultantNo
		END	
		--SELECT @GPName = p.[GP Name] , @GPAddress = p.[GP Address] FROM Patient p left join  ERS_Procedures pr ON p.[Patient No]= pr.PatientId WHERE pr.ProcedureId = @newProcId
		--SELECT @GPName = p.[GP Name] , @GPAddress = p.[GP Address] FROM ERS_Patients p WHERE p.[Patient No]= @PatientId

		SET @RefHosp = ''
		SELECT @RefHosp = rh.HospitalName FROM dbo.ERS_ReferralHospitals rh WHERE rh.HospitalID = @ReferralHospitalNo

		--Get GP practice name and address
		SELECT 	TOP 1 
			@GPName		= g.CompleteName,
			@GPAddress	= replace(dbo.fnFullAddress(ep.[Name], ep.Address1, ep.Address2, CASE WHEN ep.Address3 Is null THEN EP.Address4 ELSE ep.Address3 + ' ' + EP.Address4 END, ep.PostCode), ',', ', <br />')
		FROM ERS_Patients p 
		LEFT JOIN ERS_GPs g ON g.GPId = p.RegGpId
		LEFT JOIN dbo.ERS_Practices ep ON p.RegGpPracticeId = ep.PracticeID
		where p.PatientId = @PatientId 

		UPDATE ERS_ProceduresReporting SET PP_Endos = @ppEndos, PP_GPName = @GPName, PP_GPAddress = @GPAddress, PP_Endo1 = @Endo1, PP_Endo2 = @Endo2, PP_RefCons = @RefCons, PP_RefHosp = @RefHosp WHERE ProcedureId = @newProcId

		UPDATE ERS_Consultant SET SortOrder = ISNULL(SortOrder,0) + 1 WHERE ConsultantID = @ReferralConsultantNo

		EXEC procedure_summary_update @newProcId

		--SELECT @newProcId AS ProcedureId
		SELECT @NewProcedureId=@newProcId;

	END TRY

	BEGIN CATCH
		DECLARE @ErrorMessage NVARCHAR(4000);
		DECLARE @ErrorSeverity INT;
		DECLARE @ErrorState INT;

		SELECT @ErrorMessage = ERROR_MESSAGE(),
			   @ErrorSeverity = ERROR_SEVERITY(),
			   @ErrorState = ERROR_STATE();
    
		RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

		IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
	END CATCH


	IF @@TRANCOUNT > 0 COMMIT TRANSACTION;
GO

EXEC dbo.DropIfExist @ObjectName = 'usp_PrintReport_Select',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[usp_PrintReport_Select]  
(  
 @ProcedureId INT,  
 @Group VARCHAR(10),  
 @EpisodeNo INT = 0,  
       @PatientComboId VARCHAR(30) = NULL,  
       @ProcedureType INT,  
       @ColonType INT  
)  
/*
	Update History:
	01 Feb 2024			:		MH	removed Diagnoses part for DNA / Cancelled reports TFS : 2885 - Cancelled reports
*/
AS  
  
SET NOCOUNT ON  
  
 DECLARE @SQLString NVARCHAR(MAX),  
   @FieldName VARCHAR(150),  
   @NodeName VARCHAR(50),  
   @TableName VARCHAR(50),  
   @Condition VARCHAR(100),  
   @ReportStyle SMALLINT,  
   @ExecQuery BINARY = 0,  
   @IncludeUGI BIT = 0,
   @DNAProcedure smallint = 0,
   @SummaryOrder	INT = 0;  
  
 DECLARE @Procedure_Reporting_TableJoinText VARCHAR(255);  
 select @EpisodeNo=(CASE WHEN dbo.fnShouldIncludeUGI()=1 THEN @EpisodeNo ELSE 0 END);  
 
 select @DNAProcedure  = IsNull(DNA,0) from ERS_Procedures Where ProcedureId = @ProcedureId

 CREATE TABLE #Summary (NodeName VARCHAR(200), NodeSummary NVARCHAR(MAX) ,[Group] VARCHAR(10), [SummaryOrder] INT)  
 CREATE TABLE #xmlmap ([FieldName] [varchar](50), [NodeName] [varchar](50), [Group] [varchar](10), [Active] [smallint], [OrderID] [int])  
  
 --DECLARE @ProcedureTypeId INT  
 --SELECT @ProcedureTypeId = ProcedureType FROM ERS_Procedures WHERE ProcedureId = @ProcedureId  
 
IF @Group = 'AD'  
 INSERT INTO #xmlmap  
 SELECT FieldName, NodeName, [Group], Active, OrderID  
 FROM ERS_XMLMap   
 WHERE [FieldName] IN ('PP_Site_Legend', 'PP_SpecimenTaken')  
 ORDER BY OrderID  
ELSE IF @Group='Premed'  
       INSERT INTO #xmlmap  
       SELECT FieldName, NodeName, [Group], Active, OrderID   
    FROM ERS_XMLMap WHERE [FieldName] IN ('PP_Premed', 'PP_Bowel_Prep') AND [Group]='RS'  
ELSE  
 INSERT INTO #xmlmap  
 SELECT FieldName, NodeName, [Group], Active, OrderID  
 FROM ERS_XMLMap   
 WHERE [Group] = @Group AND [FieldName] NOT IN ('PP_Site_Legend', 'PP_SpecimenTaken')  
 ORDER BY OrderID  
  
  --MH Added on 01 Feb 2024 - TFS 2885 - Cancelled reports
  if @DNAProcedure > 0
  Begin
	Delete from #xmlmap Where FieldName = 'PP_Diagnoses'
  End

 IF @ProcedureId IS NOT NULL AND @ProcedureId > 0  
  BEGIN  
   SET @TableName = '[ERS_Procedures]'  
   SET @Procedure_Reporting_TableJoinText = '  AS P LEFT JOIN dbo.ERS_ProceduresReporting AS PR ON P.ProcedureId = PR.ProcedureId '  
   SET @Condition = 'P.ProcedureId = @ProcedureId'  
  
   IF (SELECT isnull(PP_Pathology, '') from ERS_ProceduresReporting where ProcedureID = @ProcedureId) != ''  
    AND @Group = 'RS'  
    INSERT INTO #Summary   
    Select 'Revised', 'Revised report following pathology report dated ' + isnull(convert(varchar, DateOfReport, 106), ''), 'RS', @SummaryOrder  from ERS_UpperGIPathologyResults where ProcedureId = @ProcedureId  
  END  
 ELSE IF @EpisodeNo > 0  
  BEGIN  
      SELECT TOP 1 @TableName = LTRIM(RTRIM(dbo.fnGetUGI_tablename(@ProcedureType,'procedure')))  
   FROM [Episode]   
   WHERE CHARINDEX('1', [Status]) BETWEEN 1 AND 8 AND [Patient No] = @PatientComboId AND [Episode No] = @EpisodeNo  
   SET @Condition = '[Patient No] = @PatientComboId AND [Episode No] = @EpisodeNo'  
      IF @ColonType >= 0 SET @Condition = @Condition + ' AND [Procedure type] = ' +CAST( @ColonType as varchar(50))  
  END  
  
 DECLARE report_cursor CURSOR FOR   
 SELECT FieldName FROM #xmlmap ORDER BY OrderID ASC  
  
 OPEN report_cursor   
 FETCH NEXT FROM report_cursor INTO @FieldName  
  
 WHILE @@FETCH_STATUS = 0  
 BEGIN  
  SELECT @NodeName = NodeName, @Group = [Group], @SummaryOrder = OrderID FROM #xmlmap WHERE FieldName = @FieldName
	IF (@SummaryOrder IS NULL)
	BEGIN
		SET @SummaryOrder = 0
	END
   
  IF @ProcedureId IS NOT NULL AND @ProcedureId > 0  
  BEGIN  
   IF @FieldName = 'Endoscribe comments' SET @FieldName = 'EndoscribeComments'  
   ELSE IF @FieldName = 'Procedure date' SET @FieldName = 'CreatedOn'  
   ELSE IF @FieldName = 'Time of procedure' SET @FieldName = 'CreatedOn'  
   ELSE IF @FieldName = 'PP2_CompiledOn' SET @FieldName = 'ModifiedOn'  
   ELSE IF @FieldName = 'PP2_SiteData' SET @FieldName = 'PP_Site_Legend'  
   --ELSE IF @FieldName = 'PP_MainReportBody' SET @FieldName = 'Summary'    
  END  
  
  IF @FieldName = 'PP_Premed' AND @ProcedureType in (10, 11) --Bronchoscopy or EBUS
   SET @NodeName = 'Sedation and anaesthesia'  
  
  --IF [Report Style] = 1 -> New style report, select from PP2 field  
  IF @TableName <> '[ERS_Procedures]' AND @EpisodeNo > 0 AND @FieldName = 'PP_MainReportBody'  
    SET @FieldName = 'CASE WHEN ISNULL([Report Style],0) = 0 THEN PP_MainReportBody ELSE PP2_MainReportBody END'  
  ELSE IF @FieldName = 'PP_MainReportBody' AND @ProcedureId > 0 SET @FieldName = 'PR.Summary'    
  ELSE IF @FieldName = 'Resected colon no' AND @ProcedureId > 0 SET @FieldName = 'ResectedColonNo'   
  ELSE IF @FieldName = 'PP_RefConsName' AND @ProcedureId > 0 SET @FieldName = 'P.GPReferrer'
  ELSE  
   SET @FieldName = '[' + @FieldName + ']'  
   
  SET @SQLString = 'INSERT INTO #Summary ' +   
       ' SELECT ''' + @NodeName + ''', ' + @FieldName + ', ' + '''' + @Group + '''' + ', ' + CAST(@SummaryOrder AS NVARCHAR(10)) +  
       ' FROM ' + @TableName +   
       CASE WHEN @ProcedureId>0 THEN @Procedure_Reporting_TableJoinText ELSE '' END +  
       ' WHERE ' + @Condition;  
   
  --PP_Therapies (Therapeutic procedures) should be displayed for UGI old style report only, else should be part of the site  
  IF @TableName <> '[ERS_Procedures]' AND @EpisodeNo > 0   
  BEGIN  
   IF @FieldName IN ('[PP_Therapies]', '[PP_SpecimenTaken]' )  
    SET @SQLString = @SQLString + ' AND ISNULL([Report Style],0) = 0'  
   --PP2_SiteData (Site Data) should not be displayed for UGI old style report  
   ELSE IF @FieldName = '[PP2_SiteData]'  
    SET @SQLString = @SQLString + ' AND ISNULL([Report Style],0) = 1'  
  END   
  
  SET @ExecQuery =   
   CASE   
    WHEN @FieldName = '[PP_NPSAalert]' AND @TableName <> '[Upper GI Procedure]' THEN 0  
    WHEN @FieldName = '[PP_ResectedColon]' AND @EpisodeNo > 0 THEN 0  
    WHEN @FieldName = '[Resected colon no]' AND @TableName <> '[Colon Procedure]' THEN 0  
    WHEN @FieldName = '[PP_Coding]' AND @TableName <> '[ERS_Procedures]' THEN 0  
    WHEN @FieldName = '[Report style]' AND @TableName = '[ERS_Procedures]' THEN 0  
    WHEN LEFT(@FieldName,10) = '[PP2_Patho' AND @TableName = '[ERS_Procedures]' THEN 0  
    ELSE 1  
   END  
  
  --Select @ProcedureId, @EpisodeNo, @PatientComboId, @sqlstring  
  IF @ExecQuery = 1   
  BEGIN  
   EXEC sp_executesql @SQLString,  
    N'@ProcedureId INT, @EpisodeNo INT, @PatientComboId VARCHAR(30)',  
    @ProcedureId, @EpisodeNo, @PatientComboId  
  END  
  
  FETCH NEXT FROM report_cursor INTO @FieldName  
 END  
  
 CLOSE report_cursor  
 DEALLOCATE report_cursor  
  
 IF @EpisodeNo > 0 --UGI  
 BEGIN  
  UPDATE #Summary SET NodeSummary = REPLACE(NodeSummary,char(13),'<BR />') WHERE NodeName in ('Report', 'Indications', 'Advice/comments')   
  --UPDATE #Summary SET NodeSummary = REPLACE(NodeSummary,'<br><b>','<b>') WHERE NodeName in ('Site Data')  
  UPDATE #Summary SET NodeSummary = REPLACE(NodeSummary,'</b>','</b><BR />') WHERE NodeName in ('Site Data')   
  --UPDATE #Summary SET NodeSummary = REPLACE(NodeSummary,char(13),'<BR />&nbsp;&nbsp;') WHERE NodeName in ('Site Data')   
  --UPDATE #Summary SET NodeSummary = REPLACE(NodeSummary,'<BR />&nbsp;&nbsp;<b>','<BR /><b>') WHERE NodeName in ('Site Data')   
 END   
  
 IF EXISTS(SELECT TOP 1 NodeName FROM #Summary WHERE NodeName = 'InstForCare')  
 BEGIN   
  UPDATE #Summary SET NodeName = (SELECT TOP 1 NodeSummary FROM #Summary WHERE NodeName = 'InstForCareHeading')  
   ,NodeSummary = dbo.fnFirstLetterUpper(NodeSummary)  
  WHERE NodeName = 'InstForCare'  
  
  DELETE #Summary WHERE NodeName = 'InstForCareHeading'  
 END  
  
 --Append NPSA alert to end of report section  
 IF (SELECT COUNT(*) FROM #Summary WHERE NodeName = 'Report') > 0  
 BEGIN  
  DECLARE @NPSAalert NVARCHAR(MAX)   
  IF @EpisodeNo > 0  
   SELECT @NPSAalert=CONVERT(NVARCHAR(MAX),[PP_NPSAalert]) FROM  [Upper GI Procedure] WHERE [Patient No] = @PatientComboId AND [Episode No] = @EpisodeNo  
  ELSE IF @ProcedureId IS NOT NULL AND @ProcedureId > 0  
   SELECT @NPSAalert=CONVERT(NVARCHAR(MAX),[PP_NPSAalert]) FROM [ERS_ProceduresReporting] WHERE ProcedureId = @ProcedureId  
  
  IF ISNULL(@NPSAalert,'') <> ''  
   UPDATE #Summary  
   SET NodeSummary = NodeSummary + '<table style="border: 1px solid red;border-radius:10px;-moz-border-radius:10px;-webkit-border-radius:10px;width:95%;"><tr><td style="padding:10px;color:red;">' + @NPSAalert + '</td><td style="width:5%;padding:5px;"><img src="/images/icons/alert.png" style="vertical-align:middle; padding:0px 2px 0px 2px;" /></td></tr></table>'  
   WHERE NodeName = CASE WHEN @EpisodeNo > 0 THEN 'Site Data' ELSE 'Report' END  
 END  
  
	SELECT S.[NodeName], S.[NodeSummary], S.[Group]
	FROM #Summary S
	left outer join #xmlmap x on x.NodeName = S.NodeName
	WHERE S.NodeSummary IS NOT NULL
	order by S.SummaryOrder --x.OrderID 
  
 DROP TABLE #xmlmap  
 DROP TABLE #Summary
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	No TFS - Item 4071
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rezaul Karim
-- TFS#	3220
-- Description of change: Add in additional drop down for 'Risk Categories
------------------------------------------------------------------------------------------------------------------------
GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.COLUMNS
    WHERE TABLE_NAME = 'ERS_UpperGIFollowUp'
      AND COLUMN_NAME IN ('RiskCategoriesTypeId')
)
BEGIN
	alter table dbo.ERS_UpperGIFollowUp
	add RiskCategoriesTypeId int NULL
END
GO

EXEC dbo.DropIfExist 
    @ObjectName = 'ogd_followup_select', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[ogd_followup_select]
(
	@ProcedureId INT
)
AS

SET NOCOUNT ON

SELECT
	NoFurtherTestsRequired,
	AwaitingPathologyResults,
	EvidenceOfCancerIdentified,
    PatientInformed,
    PatientRemovedFromFastTrack,
    NotInformedReason,
    CnsMdtcInformed,
	ImagingRequested,
	FurtherProcedure,
	FurtherProcedureDueCount,
	FurtherProcedureDueType,
	FurtherProcedureText,
	ReturnTo,
	NoFurtherFollowUp,
	ReviewLocation,
	ReviewDueCount,
	ReviewDueType,
	ReviewText,
	Comments,
	PP_PFRFollowUp,
	ISNULL(CopyToPatient, 0) AS CopyToPatient,
	CopyToPatientText,
	PatientNotCopiedReason,
	ISNULL(CopyToRefCon, 0) AS CopyToRefCon,
	CopyToRefConText,
	ISNULL(CopyToOther, 0) AS CopyToOther,
	CopyToOtherText,
	Salutation,
	ReBleedPlanRepeatGastroscopy,
    ReBleedPlanRequestSurgicalReview,
    ReBleedPlanOtherOption,
    ReBleedPlanOtherText,
	ClinicalFindingsAlert,
	ISNULL(CopyToGPEmailAddress, 0) AS CopyToGPEmailAddress, --changed by mostafiz 3891
	UrgentTwoWeekReferral,
	CancerResultId,
	WhoStatusId,
	CancerNotDetected,
	RiskCategoriesTypeId
FROM
	ERS_UpperGIFollowUp
WHERE 
	ProcedureId = @ProcedureId

GO

EXEC dbo.DropIfExist 
    @ObjectName = 'ogd_followup_save', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[ogd_followup_save]
(
	@ProcedureId INT,
	@NoFurtherTestsRequired BIT = NULL,
	@AwaitingPathologyResults BIT = NULL,
	@EvidenceOfCancerIdentified TINYINT = NULL,
	@PatientInformed BIT = NULL,
	@PatientRemovedFromFastTrack BIT = NULL,
	@NotInformedReason NVARCHAR(255) = NULL,
	@CnsMdtcInformed BIT = NULL,
	@ImagingRequested BIT = NULL,
	@FurtherProcedure INT = NULL,
	@FurtherProcedureDueCount INT = NULL,
	@FurtherProcedureDueType TINYINT = NULL,
	@FurtherProcedureText NVARCHAR(MAX) = NULL,
	@ReturnTo SMALLINT = NULL,
	@NoFurtherFollowUp BIT = NULL,
	@ReviewLocation SMALLINT = NULL,
	@ReviewDueCount INT = NULL,
	@ReviewDueType TINYINT = NULL,
	@ReviewText NVARCHAR(MAX) = NULL,
	@Comments NVARCHAR(MAX) = NULL,
	@PP_PFRFollowUp NVARCHAR(MAX) = NULL,
	@LoggedInUserId INT,	
	@ReBleedPlanRepeatGastroscopy BIT = NULL,
    @ReBleedPlanRequestSurgicalReview BIT = NULL,
    @ReBleedPlanOtherOption BIT = NULL,
    @ReBleedPlanOtherText NVARCHAR(MAX) = NULL,
	@ClinicalFindingAlert BIT = NULL,
	@setComplete TINYINT = NULL,
	@UrgentTwoWeekReferral BIT = NULL,
	@CancerResultId INT = NULL,
	@WhoStatusId INT = NULL,
	@CancerNotDetected BIT = NULL,
	@RiskCategoriesTypeId int  = NULL
)
AS
BEGIN
declare @SaveSuccess as bit
Set @SaveSuccess = 0

SET NOCOUNT ON

BEGIN TRANSACTION

BEGIN TRY
			
	IF NOT EXISTS (SELECT 1 FROM ERS_UpperGIFollowUp WHERE ProcedureId = @ProcedureId)
	BEGIN
		INSERT INTO ERS_UpperGIFollowUp (
			ProcedureId,
			NoFurtherTestsRequired,
			AwaitingPathologyResults,
			EvidenceOfCancerIdentified,
			PatientInformed,
			PatientRemovedFromFastTrack,
			NotInformedReason,
			CnsMdtcInformed,
			ImagingRequested,
			FurtherProcedure,
			FurtherProcedureDueCount,
			FurtherProcedureDueType,
			FurtherProcedureText,
			ReturnTo,
			NoFurtherFollowUp,
			ReviewLocation,
			ReviewDueCount,
			ReviewDueType,
			ReviewText,
			Comments,
			PP_PFRFollowUp,
			WhoCreatedId,
			WhenCreated,
			ReBleedPlanRepeatGastroscopy,
			ReBleedPlanRequestSurgicalReview,
			ReBleedPlanOtherOption,
			ReBleedPlanOtherText,
			ClinicalFindingsAlert,
			UrgentTwoWeekReferral,
			CancerResultId,
			WHOStatusId,
			CancerNotDetected,
			RiskCategoriesTypeId) 
		VALUES (
			@ProcedureId,
			@NoFurtherTestsRequired,
			@AwaitingPathologyResults,
			@EvidenceOfCancerIdentified,
			@PatientInformed,
			@PatientRemovedFromFastTrack,
			@NotInformedReason,
			@CnsMdtcInformed,
			@ImagingRequested,
			@FurtherProcedure,
			@FurtherProcedureDueCount,
			@FurtherProcedureDueType,
			@FurtherProcedureText,
			@ReturnTo,
			@NoFurtherFollowUp,
			@ReviewLocation,
			@ReviewDueCount,
			@ReviewDueType,
			@ReviewText,
			@Comments,
			@PP_PFRFollowUp,
			@LoggedInUserId,
			GETDATE(),
			@ReBleedPlanRepeatGastroscopy,
			@ReBleedPlanRequestSurgicalReview,
			@ReBleedPlanOtherOption,
			@ReBleedPlanOtherText,
			@ClinicalFindingAlert,
			ISNULL(@UrgentTwoWeekReferral,0),
			CASE WHEN @UrgentTwoWeekReferral = 1 THEN @CancerResultId ELSE NULL END,
			CASE WHEN @UrgentTwoWeekReferral = 1 THEN @WHOStatusId ELSE NULL END,
			@CancerNotDetected, @RiskCategoriesTypeId)
	END
	
	ELSE
	BEGIN
		UPDATE 
			ERS_UpperGIFollowUp
		SET 
			NoFurtherTestsRequired =			ISNULL(@NoFurtherTestsRequired,NoFurtherTestsRequired),
			AwaitingPathologyResults =			ISNULL(@AwaitingPathologyResults,AwaitingPathologyResults),
			EvidenceOfCancerIdentified =		ISNULL(@EvidenceOfCancerIdentified,EvidenceOfCancerIdentified),
			PatientInformed =					ISNULL(@PatientInformed,PatientInformed),
			PatientRemovedFromFastTrack =		ISNULL(@PatientRemovedFromFastTrack,PatientRemovedFromFastTrack),
			NotInformedReason =					ISNULL(@NotInformedReason,NotInformedReason),
			CnsMdtcInformed =					ISNULL(@CnsMdtcInformed,CnsMdtcInformed),
			ImagingRequested =					ISNULL(@ImagingRequested,ImagingRequested),
			FurtherProcedure =					ISNULL(@FurtherProcedure,FurtherProcedure),
			FurtherProcedureDueCount =			ISNULL(@FurtherProcedureDueCount,FurtherProcedureDueCount),
			FurtherProcedureDueType =			ISNULL(@FurtherProcedureDueType,FurtherProcedureDueType),
			FurtherProcedureText =				ISNULL(@FurtherProcedureText,FurtherProcedureText),
			ReturnTo =							ISNULL(@ReturnTo,ReturnTo),
			NoFurtherFollowUp =					ISNULL(@NoFurtherFollowUp,NoFurtherFollowUp),
			ReviewLocation =					ISNULL(@ReviewLocation,ReviewLocation),
			ReviewDueCount =					ISNULL(@ReviewDueCount,ReviewDueCount),
			ReviewDueType =						ISNULL(@ReviewDueType,ReviewDueType),
			ReviewText =						ISNULL(@ReviewText,ReviewText),
			Comments =							ISNULL(@Comments,Comments),
			PP_PFRFollowUp =					ISNULL(@PP_PFRFollowUp,PP_PFRFollowUp),
			WhoUpdatedId =	@LoggedInUserId,
			WhenUpdated = GETDATE(),
			ReBleedPlanRepeatGastroscopy =		ISNULL(@ReBleedPlanRepeatGastroscopy,ReBleedPlanRepeatGastroscopy),
			ReBleedPlanRequestSurgicalReview =	ISNULL(@ReBleedPlanRequestSurgicalReview,ReBleedPlanRequestSurgicalReview),
			ReBleedPlanOtherOption =			ISNULL(@ReBleedPlanOtherOption,ReBleedPlanOtherOption),
			ReBleedPlanOtherText =				ISNULL(@ReBleedPlanOtherText,ReBleedPlanOtherText),
			ClinicalFindingsAlert =				ISNULL(@ClinicalFindingAlert,ClinicalFindingsAlert),
			UrgentTwoWeekReferral =				ISNULL(@UrgentTwoWeekReferral,UrgentTwoWeekReferral),
			CancerResultId = CASE WHEN ISNULL(@UrgentTwoWeekReferral,UrgentTwoWeekReferral) = 1 THEN ISNULL(@CancerResultId, CancerResultId) ELSE NULL END,
			WHOStatusId = CASE WHEN ISNULL(@UrgentTwoWeekReferral,UrgentTwoWeekReferral) = 1 THEN ISNULL(@WHOStatusId, WHOStatusId) ELSE NULL END,
			CancerNotDetected =					ISNULL(@CancerNotDetected, CancerNotDetected),
			RiskCategoriesTypeId = @RiskCategoriesTypeId
		WHERE 
			ProcedureId = @ProcedureId
	END

	IF @setComplete = 1 and NOT EXISTS(SELECT 1 FROM ERS_RecordCount WHERE ProcedureId = @ProcedureId AND [Identifier] = 'Follow Up')
	BEGIN
		INSERT INTO ERS_RecordCount (
			[ProcedureId],
			[SiteId],
			[Identifier],
			[RecordCount]
		)
		VALUES (
			@ProcedureId,
			NULL,
			'Follow Up',
			1)
	END
END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
	Set @SaveSuccess = 0
END CATCH


IF @@TRANCOUNT > 0 
Begin
	COMMIT TRANSACTION;
	Set @SaveSuccess = 1
End

If @SaveSuccess = 1 
Begin
	exec usp_SendOrderMessageByProcedureIdAndOrderEventId @ProcedureId, 18, @LoggedInUserId
End

END
 
GO

EXEC dbo.DropIfExist 
    @ObjectName = 'ogd_followup_summary_update', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[ogd_followup_summary_update]
(
	@ProcedureId INT
)
AS
	SET NOCOUNT ON

	DECLARE
		@summary NVARCHAR(MAX) = '',
		@NoFurtherTestsRequired BIT,
		@AwaitingPathologyResults BIT,
		@EvidenceOfCancerIdentified TINYINT,
		--@BleedRecordPresent INT,
		@ReBleed NVARCHAR(MAX),
		@PatientInformed BIT,
		@PatientRemovedFromFastTrack BIT,
		@NotInformedReason NVARCHAR(255) = '',
		@CnsMdtcInformed BIT,
		@ImagingRequested Bit,
		@FurtherProcedure BIT,
		@FurtherProcedureDueCount INT,
		@FurtherProcedureDueType TINYINT,
		@FurtherProcedureText NVARCHAR(MAX) = '',
		@ReturnTo SMALLINT,
		@NoFurtherFollowUp BIT,
		@ReviewLocation SMALLINT,
		@ReviewDueCount INT,
		@ReviewDueType TINYINT,
		@ReviewText NVARCHAR(MAX) = '',
		@Comments NVARCHAR(MAX) = '',
		@PP_PFRFollowUp NVARCHAR(MAX) = '',
		@CopyToPatient BIT,
		@CopyToPatientText NVARCHAR(MAX) = '',
		@PatientNotCopiedReason NVARCHAR(500),
		@CopyToRefCon BIT,
		@CopyToRefConText NVARCHAR(500) = '',
		@CopyToOther BIT,
		@CopyToOtherText NVARCHAR(500) ='',
		@Salutation NVARCHAR(200) = '',
		@AdviceComments NVARCHAR(MAX) = '',
		@ReBleedPlanRepeatGastroscopy BIT,
		@ReBleedPlanRequestSurgicalReview BIT,
		@ReBleedPlanOtherText NVARCHAR(MAX) = '',
		@ClinicalFindingAlert BIT,
		@UrgentTwoWeekReferral BIT,
		@CancerResultId INT,
		@WhoStatusId INT,
		@CancerNotDetected BIT,
		@RiskCategoriesTypeId INT

	SELECT 
		@NoFurtherTestsRequired=NoFurtherTestsRequired,
		@AwaitingPathologyResults=AwaitingPathologyResults,
		@EvidenceOfCancerIdentified=EvidenceOfCancerIdentified,
		@PatientInformed=PatientInformed,
		@PatientRemovedFromFastTrack=PatientRemovedFromFastTrack,
		@NotInformedReason=NotInformedReason,
		@CnsMdtcInformed=CnsMdtcInformed,
		@ImagingRequested = ImagingRequested,
		@FurtherProcedure=FurtherProcedure,
		@FurtherProcedureDueCount=FurtherProcedureDueCount,
		@FurtherProcedureDueType=FurtherProcedureDueType,
		@FurtherProcedureText=FurtherProcedureText,
		@ReturnTo=ReturnTo,
		@NoFurtherFollowUp=NoFurtherFollowUp,
		@ReviewLocation=ReviewLocation,
		@ReviewDueCount=ReviewDueCount,
		@ReviewDueType=ReviewDueType,
		@ReviewText=ReviewText,
		@Comments=Comments,
		@PP_PFRFollowUp=PP_PFRFollowUp,
		@CopyToPatient=CopyToPatient,
		@CopyToPatientText=CopyToPatientText,
		@PatientNotCopiedReason=PatientNotCopiedReason,
		@CopyToRefCon=CopyToRefCon,
		@CopyToRefConText=CopyToRefConText,
		@CopyToOther=CopyToOther,
		@CopyToOtherText=CopyToOtherText,
		@Salutation=Salutation,
		@ReBleedPlanRepeatGastroscopy=ISNULL(ReBleedPlanRepeatGastroscopy, 0),
		@ReBleedPlanRequestSurgicalReview=ISNULL(ReBleedPlanRequestSurgicalReview, 0),
		@ReBleedPlanOtherText=ReBleedPlanOtherText,
		@ClinicalFindingAlert=ClinicalFindingsAlert,
		@UrgentTwoWeekReferral = UrgentTwoWeekReferral,
		@CancerResultId = CancerResultId,
		@WhoStatusId = WhoStatusId,
		@CancerNotDetected = CancerNotDetected,
		@RiskCategoriesTypeId = RiskCategoriesTypeId
	FROM
		ERS_UpperGIFollowUp
	WHERE
		ProcedureId = @ProcedureId	

	SET @summary = ''

	IF @NoFurtherTestsRequired = 1
		--IF @summary = '' 
		SET @summary = 'No further tests required. <br/>'
		--ELSE
			--SET @summary = @summary + 'No further tests required. '
	
	IF ISNULL(@ReviewText,'') <> ''
		IF RIGHT(@ReviewText, 1) = '.'
			SET @summary = @summary + @ReviewText + ' <br/>'
		ELSE
			SET @summary = @summary + @ReviewText + '. <br/>'
	ELSE
	BEGIN
		DECLARE @tmpFollowUp VARCHAR(100) = ''

		IF @ReturnTo > 0
			SET @tmpFollowUp = ISNULL((SELECT 'Return to the ' + [ListItemText] FROM ERS_Lists WHERE ListDescription = 'Return or referred to' AND [ListItemNo] = @ReturnTo), '') 
	
		IF @NoFurtherFollowUp = 1 
			BEGIN
				IF ISNULL(@tmpFollowUp,'') <> '' 
					SET @tmpFollowUp = @tmpFollowUp + ' and no further follow up. '
				ELSE
					SET @tmpFollowUp = @tmpFollowUp + 'No further follow up. '
			END 
		ELSE
			BEGIN
				IF ISNULL(@tmpFollowUp,'') <> ''
					IF RIGHT(@FurtherProcedureText, 1) = '.'
						SET @tmpFollowUp = @tmpFollowUp + ' <br/>'
					ELSE
						SET @tmpFollowUp = @tmpFollowUp + '. <br/>'
			END

		IF @AwaitingPathologyResults = 1
			SET @tmpFollowUp = @tmpFollowUp + 'Awaiting pathology results. <br/>'

		
		SET @summary = CASE WHEN @summary + @tmpFollowUp = '' THEN '' ELSE @summary + @tmpFollowUp END
	END 
		
	IF ISNULL(@FurtherProcedureText,'') <> ''
		IF RIGHT(@FurtherProcedureText, 1) = '.'				
			SET @summary = @summary + 'Further procedure(s): ' + UPPER(LEFT(@FurtherProcedureText, 1)) + SUBSTRING(@FurtherProcedureText, 2, LEN(@FurtherProcedureText)) + ' '

		ELSE 
			SET @summary = @summary + 'Further procedure(s): ' + UPPER(LEFT(@FurtherProcedureText, 1)) + SUBSTRING(@FurtherProcedureText, 2, LEN(@FurtherProcedureText)) + '. '

	UPDATE ERS_UpperGIFollowUp
	SET Summary = @summary 
	WHERE ProcedureId = @ProcedureId


	--IF @Comments <> ''
		--IF @summary = '' SET @summary = 'Advice/comments: ' + @Comments
		--ELSE SET @summary = @summary + '. <br>Advice/comments: ' + @Comments

	--PRINT @summary

	--Update the summary column in diagnoses table and procedures tabler


	--IF @EvidenceOfCancerIdentified <> 3
	--BEGIN
	--	IF @EvidenceOfCancerIdentified = 1
	--		SET @AdviceComments = @AdviceComments + 'Evidence of cancer seen for this endoscopy - '
	--	ELSE IF @EvidenceOfCancerIdentified = 2 
	--		SET @AdviceComments = @AdviceComments + CASE WHEN ISNULL(@CancerNotDetected,0) = 1 THEN 'No cancer detected during this procedure - ' ELSE 'No evidence of cancer seen for this endoscopy - ' END
	--	ELSE IF @EvidenceOfCancerIdentified = 3 
	--		SET @AdviceComments = @AdviceComments + ''	

	--	IF @PatientInformed = 1	
	--		SET @AdviceComments = @AdviceComments + 'patient informed. <br/>'
	--	ELSE
	--	BEGIN
	--		SET @AdviceComments = @AdviceComments + 'patient not informed. <br/>'	

	--		IF @NotInformedReason <> ''
	--			IF RIGHT(@NotInformedReason, 1) = '.'
	--			BEGIN								
	--				SET @AdviceComments = @AdviceComments + 'Reason why patient not informed: ' + UPPER(LEFT(@NotInformedReason, 1)) + LOWER(SUBSTRING(@NotInformedReason, 2, LEN(@NotInformedReason))) + ' <br/>'
	--			END
	--			ELSE
	--				SET @AdviceComments = @AdviceComments + 'Reason why patient not informed: ' + UPPER(LEFT(@NotInformedReason, 1)) + LOWER(SUBSTRING(@NotInformedReason, 2, LEN(@NotInformedReason))) + '. <br/>'
	--	END	
	
	--	IF @PatientRemovedFromFastTrack = 1
	--		SET @AdviceComments = @AdviceComments + 'Patient removed from fast track. <br/>'
	--	--ELSE
	--	--	SET @AdviceComments = @AdviceComments + 'Patient not removed from fast track. <br>'
			
	--	IF @CnsMdtcInformed = 1
	--		SET @AdviceComments = @AdviceComments + 'CNS-MDTC informed. <br/>'
	--	--ELSE
	--	--	SET @AdviceComments = @AdviceComments + 'CNS-MDTC not informed. <br>'		
	--END	

	if @ImagingRequested = 1 Set @AdviceComments = @AdviceComments + 'Imaging has been requested. <br/>'
	
	SET @ReBleed = ''
	
	IF EXISTS (SELECT 1 FROM ERS_UpperGIBleeds WHERE ProcedureId = @ProcedureId) 
	BEGIN
		SET @ReBleed = 'Risk of Re-bleed - <b>' + ISNULL((SELECT [OverallRiskAssessment] FROM ERS_UpperGIBleeds WHERE ProcedureID = @ProcedureId),'') + '. </b><br/> '

		IF @ReBleedPlanRepeatGastroscopy = 1
			SET @ReBleed = @ReBleed + 'Repeat Gastroscopy. <br/> '

		IF @ReBleedPlanRequestSurgicalReview = 1
			SET @ReBleed = @ReBleed + 'Request surgical review. <br/> '

		IF @ReBleedPlanOtherText <> ''
			IF RIGHT(@ReBleedPlanOtherText, 1) = '.'
				SET @ReBleed = @ReBleed + @ReBleedPlanOtherText + ' '  
			ELSE
				SET @ReBleed = @ReBleed + @ReBleedPlanOtherText + '. '  
	END

	
	IF @UrgentTwoWeekReferral = 1
	SET @AdviceComments = @AdviceComments + 'Urgent 2 week referral. '
	
	IF @CancerResultId > 0 
	SET @AdviceComments	= @AdviceComments + 'Cancer ' + 
							CASE @CancerResultId 
								WHEN 1 THEN 'definate.' 
								WHEN 2 THEN 'suspected'
								WHEN 3 THEN 'excluded.'
								ELSE ''
							END
						
	IF @UrgentTwoWeekReferral = 1 
	SET @AdviceComments	= @AdviceComments + ' WHO status: ' + convert(varchar(10),@WhoStatusId) + '. <br />'
		
		
	IF @ClinicalFindingAlert = 1	
	SET @AdviceComments = @AdviceComments + '<br/><strong style="color:red;">Clinical Finding Alert</strong><br/>'

	-- Updated by	:	Siddikur Rahman
	-- TFS#	3902 Start

	--REPLACE cr (\r) and lf (\n) to preserve line breaks
	IF @Comments <> ''
	SET @Comments = REPLACE(REPLACE(@Comments, CHAR(13), '<br/>'), CHAR(10), '<br/>')

	-- TFS#	3902 End

	UPDATE ERS_ProceduresReporting
	SET PP_Followup = @summary, PP_ReBleed = @ReBleed, PP_AdviceAndComments = CASE WHEN @AdviceComments + @Comments = '' THEN '' ELSE @AdviceComments + @Comments END
	WHERE ProcedureId = @ProcedureId		

	IF @CopyToRefCon IS NOT NULL AND @CopyToRefCon=1    
		UPDATE ERS_ProceduresReporting  --edited bY MOSTAFIZ ISSUE 3891
		SET PP_CCRefCons= LTRIM(RTRIM((SELECT ISNULL(Title,'') + ' ' + ISNULL(Forename,'')+ ' '+ISNULL(Surname,'') 
										FROM ERS_Consultant 
										WHERE ConsultantID= @CopyToRefConText))) 
		WHERE ProcedureId = @ProcedureId
	ELSE 
		UPDATE ERS_ProceduresReporting SET PP_CCRefCons = NULL
		WHERE ProcedureId = @ProcedureId

	IF @CopyToPatient IS NOT NULL AND @CopyToPatient=1     
		UPDATE ERS_ProceduresReporting SET PP_CCPatient= @CopyToPatientText   
		WHERE ProcedureId = @ProcedureId
	ELSE 
		UPDATE ERS_ProceduresReporting SET PP_CCPatient= NULL
		WHERE ProcedureId = @ProcedureId
	
	IF @CopyToOther IS NOT NULL AND @CopyToOther=1             
		UPDATE ERS_ProceduresReporting 
		SET PP_CCOther = @CopyToOtherText     
		WHERE ProcedureId = @ProcedureId
	ELSE 
		UPDATE ERS_ProceduresReporting 
		SET PP_CCOther = NULL 
		WHERE ProcedureId = @ProcedureId
GO

------------------------------------------------------------------------------------------------------------------------
--END--OF--TFS#	3220
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rezaul Karim
-- TFS#	3219
-- Description of change: Further procedure drop down menu for cystroscopuy
------------------------------------------------------------------------------------------------------------------------
GO
	IF NOT EXISTS (SELECT 1 FROM ERS_ListsMain WHERE ListDescription = 'Further Cysto procedure')
		BEGIN
			INSERT INTO ERS_ListsMain (ListDescription, AllowAddNewItem,OrderByDesc, FirstItemText, WhoUpdatedId, WhoCreatedId,WhenCreated, WhenUpdated,ReferenceTable)
			Values('Further Cysto procedure',1,1,null,null,1,GETDATE(),GETDATE(), null)
		
			INSERT INTO ERS_Lists (ListDescription, ListItemNo,ListItemText, Suppressed, ReadOnly, ListMainId, WhoCreatedId,WhenCreated, WhenUpdated)
			Values('Further Cysto procedure',0,'',0,0,SCOPE_IDENTITY(),1,GETDATE(),GETDATE())
		END
GO
------------------------------------------------------------------------------------------------------------------------
-- TFS-END#	3219
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rezaul Karim
-- TFS#	3210
-- Description of change: Add number box to Pharyngeal Anaesthesia - Bronch/EBUS
-- TFS# 4100 :	Local Anaesthetic and O2 levels not showing on the report
-------------------------------------------------------------------------------------------------------------------------
GO
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.COLUMNS
    WHERE TABLE_NAME = 'ERS_BRT_BronchoDrugs'
      AND COLUMN_NAME IN ('LignocaineSprayTotal')
)
BEGIN
	alter table dbo.ERS_BRT_BronchoDrugs
	add LignocaineSprayTotal decimal(8,2) null
END

GO
dbo.DropIfExist
    @ObjectName = 'broncho_drugs_save',
    @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[broncho_drugs_save]
(
	@ProcedureId INT,
	@EffectOfSedation INT = NULL,
	@LignocaineSpray BIT,
	@LignocaineSprayTotal DECIMAL(8,2),
	@LignocaineGel BIT,
	@LignocaineViaScope1pc DECIMAL(8,2),
	@LignocaineViaScope2pc DECIMAL(8,2),
	@LignocaineViaScope4pc DECIMAL(8,2),
	@LignocaineNebuliser2pc DECIMAL(8,2),
	@LignocaineNebuliser4pc DECIMAL(8,2),
	@LignocaineTranscricoid2pc DECIMAL(8,2),
	@LignocaineTranscricoid4pc DECIMAL(8,2),
	@LignocaineBronchial1pc DECIMAL(8,2),
	@LignocaineBronchial2pc DECIMAL(8,2),
	@SupplyOxygen BIT,
	@SupplyOxygenPercentage DECIMAL(8,2),
	@Nasal DECIMAL(8,2),
	@SpO2Base DECIMAL(8,2),
	@SpO2Min DECIMAL(8,2),
	@LoggedInUserId INT

)
AS

SET NOCOUNT ON

BEGIN TRANSACTION

BEGIN TRY
			
	IF NOT EXISTS (SELECT 1 FROM ERS_BRT_BronchoDrugs WHERE ProcedureId = @ProcedureId)
	BEGIN
		INSERT INTO ERS_BRT_BronchoDrugs (
			ProcedureId,
			EffectOfSedation,
			LignocaineSpray,
			LignocaineSprayTotal,
			LignocaineGel,
			LignocaineViaScope1pc,
			LignocaineViaScope2pc,
			LignocaineViaScope4pc,
			LignocaineNebuliser2pc,
			LignocaineNebuliser4pc,
			LignocaineTranscricoid2pc,
			LignocaineTranscricoid4pc,
			LignocaineBronchial1pc,
			LignocaineBronchial2pc,
			SupplyOxygen,
			SupplyOxygenPercentage,
			Nasal,
			SpO2Base,
			SpO2Min,
			WhoCreatedId,
			WhenCreated) 
		VALUES (
			@ProcedureId,
			@EffectOfSedation,
			@LignocaineSpray,
			@LignocaineSprayTotal,
			@LignocaineGel,
			@LignocaineViaScope1pc,
			@LignocaineViaScope2pc,
			@LignocaineViaScope4pc,
			@LignocaineNebuliser2pc,
			@LignocaineNebuliser4pc,
			@LignocaineTranscricoid2pc,
			@LignocaineTranscricoid4pc,
			@LignocaineBronchial1pc,
			@LignocaineBronchial2pc,
			@SupplyOxygen,
			@SupplyOxygenPercentage,
			@Nasal,
			@SpO2Base,
			@SpO2Min,
			@LoggedInUserId,
			GETDATE())

		INSERT INTO ERS_RecordCount (
			[ProcedureId],
			[SiteId],
			[Identifier],
			[RecordCount]
		)
		VALUES (
			@ProcedureId,
			NULL,
			'Drugs',
			1)
	END
	
	ELSE
	BEGIN
		UPDATE 
			ERS_BRT_BronchoDrugs
		SET 
			EffectOfSedation = @EffectOfSedation,
			LignocaineSpray = @LignocaineSpray,
			LignocaineSprayTotal = @LignocaineSprayTotal,
			LignocaineGel = @LignocaineGel,
			LignocaineViaScope1pc = @LignocaineViaScope1pc,
			LignocaineViaScope2pc = @LignocaineViaScope2pc,
			LignocaineViaScope4pc = @LignocaineViaScope4pc,
			LignocaineNebuliser2pc = @LignocaineNebuliser2pc,
			LignocaineNebuliser4pc = @LignocaineNebuliser4pc,
			LignocaineTranscricoid2pc = @LignocaineTranscricoid2pc,
			LignocaineTranscricoid4pc = @LignocaineTranscricoid4pc,
			LignocaineBronchial1pc = @LignocaineBronchial1pc,
			LignocaineBronchial2pc = @LignocaineBronchial2pc,
			SupplyOxygen = @SupplyOxygen,
			SupplyOxygenPercentage = @SupplyOxygenPercentage,
			Nasal = @Nasal,
			SpO2Base = @SpO2Base,
			SpO2Min = @SpO2Min,
			WhoUpdatedId = @LoggedInUserId,
			WhenUpdated = GETDATE()
		WHERE 
			ProcedureId = @ProcedureId
	END
END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;

GO
dbo.DropIfExist
    @ObjectName = 'broncho_drugs_select',
    @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[broncho_drugs_select](
	@ProcedureId INT
)
AS

SET NOCOUNT ON

SELECT
	EffectOfSedation,
	LignocaineSpray,
	LignocaineSprayTotal,
	LignocaineGel,
	LignocaineViaScope1pc,
	LignocaineViaScope2pc,
	LignocaineViaScope4pc,
	LignocaineNebuliser2pc,
	LignocaineNebuliser4pc,
	LignocaineTranscricoid2pc,
	LignocaineTranscricoid4pc,
	LignocaineBronchial1pc,
	LignocaineBronchial2pc,
	SupplyOxygen,
	SupplyOxygenPercentage,
	Nasal,
	SpO2Base,
	SpO2Min
FROM
	ERS_BRT_BronchoDrugs
WHERE 
	ProcedureId = @ProcedureId
GO

dbo.DropIfExist
    @ObjectName = 'broncho_drugs_summary_update',
    @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[broncho_drugs_summary_update]
(
	@ProcedureId INT
)
AS
	SET NOCOUNT ON

	--FLOAT removes trailing zeroes
	DECLARE
		@summary VARCHAR(4000),
		@EffectOfSedation INT,
		@LignocaineSpray BIT,
		@LignocaineGel BIT,
		@LignocaineSprayTotal Float,
		@LignocaineViaScope1pc FLOAT,
		@LignocaineViaScope2pc FLOAT,
		@LignocaineViaScope4pc FLOAT,
		@LignocaineNebuliser2pc FLOAT,
		@LignocaineNebuliser4pc FLOAT,
		@LignocaineTranscricoid2pc FLOAT,
		@LignocaineTranscricoid4pc FLOAT,
		@LignocaineBronchial1pc FLOAT,
		@LignocaineBronchial2pc FLOAT,
		@SupplyOxygen BIT,
		@SupplyOxygenPercentage FLOAT,
		@Nasal FLOAT,
		@SpO2Base FLOAT,
		@SpO2Min FLOAT

	DECLARE @tempsummary VARCHAR(1320) = ''
	DECLARE @summaryitems TABLE (summary VARCHAR (300))
	declare @newsummary VARCHAR(1320) = ''
	SET @Summary  =  ''
	SET @tempsummary = ''

	SELECT
		@EffectOfSedation = EffectOfSedation,
		@LignocaineSpray = LignocaineSpray,
		@LignocaineGel = LignocaineGel,
		@LignocaineSprayTotal = LignocaineSprayTotal,
		@LignocaineViaScope1pc = LignocaineViaScope1pc,
		@LignocaineViaScope2pc = LignocaineViaScope2pc,
		@LignocaineViaScope4pc = LignocaineViaScope4pc,
		@LignocaineNebuliser2pc = LignocaineNebuliser2pc,
		@LignocaineNebuliser4pc = LignocaineNebuliser4pc,
		@LignocaineTranscricoid2pc = LignocaineTranscricoid2pc,
		@LignocaineTranscricoid4pc = LignocaineTranscricoid4pc,
		@LignocaineBronchial1pc = LignocaineBronchial1pc,
		@LignocaineBronchial2pc = LignocaineBronchial2pc,
		@SupplyOxygen = SupplyOxygen,
		@SupplyOxygenPercentage = SupplyOxygenPercentage,
		@Nasal = Nasal,
		@SpO2Base = SpO2Base,
		@SpO2Min = SpO2Min
	FROM 
		ERS_BRT_BronchoDrugs
	WHERE
		ProcedureId = @ProcedureId

	IF @LignocaineSpray = 1 
		INSERT INTO @summaryitems 
		VALUES ('Lido\Lignocaine ' + CONVERT(VARCHAR, isnull(@LignocaineSprayTotal,0)) + case when @LignocaineSprayTotal > 1 then ' spray(s) was used ' else ' spray was used' end) --TFS # 3210

	IF @LignocaineGel = 1
		INSERT INTO @summaryitems 
		VALUES ('Lido\Lignocaine gel was used')

	IF @LignocaineNebuliser2pc > 0
	BEGIN
		INSERT INTO @summaryitems 
		VALUES ('Lido\Lignocaine 2% by nebuliser ' + CONVERT(VARCHAR, @LignocaineNebuliser2pc) + ' mls')
	END

	IF @LignocaineNebuliser4pc > 0
	BEGIN
		INSERT INTO @summaryitems 
		VALUES ('Lido\Lignocaine 4% by nebuliser ' + CONVERT(VARCHAR, @LignocaineNebuliser4pc) + ' mls')
	END

	IF @LignocaineViaScope1pc > 0
	BEGIN
		INSERT INTO @summaryitems 
		VALUES ('Lido\Lignocaine 1% to larynx via scope ' + CONVERT(VARCHAR, @LignocaineViaScope1pc) + ' mls')
	END

	IF @LignocaineViaScope2pc > 0
	BEGIN
		INSERT INTO @summaryitems 
		VALUES ('Lido\Lignocaine 2% to larynx via scope ' + CONVERT(VARCHAR, @LignocaineViaScope2pc) + ' mls')
	END

	IF @LignocaineViaScope4pc > 0
	BEGIN
		INSERT INTO @summaryitems 
		VALUES ('Lido\Lignocaine 4% to larynx via scope ' + CONVERT(VARCHAR, @LignocaineViaScope4pc) + ' mls')
	END

	IF @LignocaineTranscricoid2pc > 0
	BEGIN
		INSERT INTO @summaryitems 
		VALUES ('Lido\Lignocaine 2% given transcricoid ' + CONVERT(VARCHAR, @LignocaineTranscricoid2pc) + ' mls')
	END

	IF @LignocaineTranscricoid4pc > 0
	BEGIN
		INSERT INTO @summaryitems 
		VALUES ('Lido\Lignocaine 4% given transcricoid ' + CONVERT(VARCHAR, @LignocaineTranscricoid4pc) + ' mls')
	END

	IF @LignocaineBronchial1pc > 0
	BEGIN
		INSERT INTO @summaryitems 
		VALUES ('Lido\Lignocaine 1% to bronchial tree ' + CONVERT(VARCHAR, @LignocaineBronchial1pc) + ' mls')
	END

	IF @LignocaineBronchial2pc > 0
	BEGIN
		INSERT INTO @summaryitems 
		VALUES ('Lido\Lignocaine 2% to bronchial tree ' + CONVERT(VARCHAR, @LignocaineBronchial2pc) + ' mls')
	END

		--TFS-4100--START
	IF EXISTS (SELECT 1 FROM @summaryitems)
	BEGIN
			set @newsummary = 'Local anaesthesia - Lidocaine / Lignocaine'
			SELECT @newsummary = @newsummary + '<br />' + summary
			FROM @summaryitems;
			DELETE FROM @summaryitems;
	END
		--TFS-4100--END

	IF @SupplyOxygen = 1
	BEGIN
		IF @SupplyOxygenPercentage > 0
		INSERT INTO @summaryitems 
		VALUES ('Supply oxygen mask ' + CONVERT(VARCHAR, @SupplyOxygenPercentage) + '%')
	END

	IF @Nasal > 0
	BEGIN
		INSERT INTO @summaryitems 
		VALUES ('Nasal cannulae ' + CONVERT(VARCHAR, @Nasal) + ' L min-1')
	END

	IF @SpO2Base > 0
	BEGIN
		INSERT INTO @summaryitems 
		VALUES ('Saturation (SPO2) Pre-procedure baseline ' + CONVERT(VARCHAR, @SpO2Base) + ' %')
	END

	IF @SpO2Min > 0
	BEGIN
		INSERT INTO @summaryitems 
		VALUES ('Saturation (SPO2) Minimum during procedure ' + CONVERT(VARCHAR, @SpO2Min) + ' %')
	END

		--TFS-4100--START
	IF EXISTS (SELECT 1 FROM @summaryitems)
	BEGIN
			set @tempsummary = 'Oxygen'
			SELECT @tempsummary = @tempsummary + '<br />' + summary
			FROM @summaryitems
			DELETE FROM @summaryitems;
	END
		--TFS-4100--END

	UPDATE ERS_BRT_BronchoDrugs
	SET Summary = @newsummary + '<br />' + @tempsummary
	WHERE ProcedureId = @ProcedureId
GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rezaul Karim
-- TFS#	3210,4100
-- END
------------------------------------------------------------------------------------------------------------------------


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Siddikur Rahman
-- TFS#	3824
-- Description of change: Added tumour Type to OGD Malignancy
-------------------------------------------------------------------------------------------------------------------------

IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ERS_UpperGIAbnoMalignancy' AND COLUMN_NAME = 'EarlyType')
BEGIN
    ALTER TABLE [dbo].[ERS_UpperGIAbnoMalignancy]
    ADD EarlyType INT;
END;

GO
IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ERS_UpperGIAbnoMalignancy' AND COLUMN_NAME = 'EarlyProbably')
BEGIN
    ALTER TABLE [dbo].[ERS_UpperGIAbnoMalignancy]
    ADD EarlyProbably BIT;
END;

GO
IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ERS_UpperGIAbnoMalignancy' AND COLUMN_NAME = 'SubEarlyType')
BEGIN
    ALTER TABLE [dbo].[ERS_UpperGIAbnoMalignancy]
    ADD SubEarlyType INT;
END;

GO
IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ERS_UpperGIAbnoMalignancy' AND COLUMN_NAME = 'EarlyBenignOrMalignantType')
BEGIN
    ALTER TABLE [dbo].[ERS_UpperGIAbnoMalignancy]
    ADD EarlyBenignOrMalignantType INT;
END;

GO
IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ERS_UpperGIAbnoMalignancy' AND COLUMN_NAME = 'EarlyOtherText')
BEGIN
    ALTER TABLE [dbo].[ERS_UpperGIAbnoMalignancy]
    ADD EarlyOtherText VARCHAR(200);
END;

GO
IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ERS_UpperGIAbnoMalignancy' AND COLUMN_NAME = 'GastricType')
BEGIN
    ALTER TABLE [dbo].[ERS_UpperGIAbnoMalignancy]
    ADD GastricType INT;
END;

GO
IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ERS_UpperGIAbnoMalignancy' AND COLUMN_NAME = 'GastricProbably')
BEGIN
    ALTER TABLE [dbo].[ERS_UpperGIAbnoMalignancy]
    ADD GastricProbably BIT;
END;

GO
IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ERS_UpperGIAbnoMalignancy' AND COLUMN_NAME = 'SubGastricType')
BEGIN
    ALTER TABLE [dbo].[ERS_UpperGIAbnoMalignancy]
    ADD SubGastricType INT;
END;

GO
IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ERS_UpperGIAbnoMalignancy' AND COLUMN_NAME = 'GastricBenignOrMalignantType')
BEGIN
    ALTER TABLE [dbo].[ERS_UpperGIAbnoMalignancy]
    ADD GastricBenignOrMalignantType INT;
END;

GO
IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ERS_UpperGIAbnoMalignancy' AND COLUMN_NAME = 'GastricOtherText')
BEGIN
    ALTER TABLE [dbo].[ERS_UpperGIAbnoMalignancy]
    ADD GastricOtherText VARCHAR(200);
END;

GO
IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ERS_UpperGIAbnoMalignancy' AND COLUMN_NAME = 'LymphomaType')
BEGIN
    ALTER TABLE [dbo].[ERS_UpperGIAbnoMalignancy]
    ADD LymphomaType INT;
END;

GO
IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ERS_UpperGIAbnoMalignancy' AND COLUMN_NAME = 'LymphomaProbably')
BEGIN
    ALTER TABLE [dbo].[ERS_UpperGIAbnoMalignancy]
    ADD LymphomaProbably BIT;
END;

GO
IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ERS_UpperGIAbnoMalignancy' AND COLUMN_NAME = 'SubLymphomaType')
BEGIN
    ALTER TABLE [dbo].[ERS_UpperGIAbnoMalignancy]
    ADD SubLymphomaType INT;
END;

GO
IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ERS_UpperGIAbnoMalignancy' AND COLUMN_NAME = 'LymphomaBenignOrMalignantType')
BEGIN
    ALTER TABLE [dbo].[ERS_UpperGIAbnoMalignancy]
    ADD LymphomaBenignOrMalignantType INT;
END;

GO
IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ERS_UpperGIAbnoMalignancy' AND COLUMN_NAME = 'LymphomaOtherText')
BEGIN
    ALTER TABLE [dbo].[ERS_UpperGIAbnoMalignancy]
    ADD LymphomaOtherText VARCHAR(200);
END;

GO
dbo.DropIfExist
    @ObjectName = 'abnormalities_malignancy_save',
    @ObjectTypePrefix = 'S'

GO
CREATE PROCEDURE [dbo].[abnormalities_malignancy_save]
(
	@SiteId INT,
	@None BIT,
	@EarlyCarcinoma BIT,
	@EarlycarcinomaLesion TINYINT,
	@EarlyCarcinomaStart INT,
	@EarlyCarcinomaEnd INT,
	@EarlyCarcinomaLargest DECIMAL(6,2),
	@EarlycarCinomaBleeding TINYINT,
	@AdvCarcinoma BIT,
	@AdvcarcinomaLesion TINYINT,
	@AdvCarcinomaStart INT,
	@AdvCarcinomaEnd INT,
	@AdvCarcinomaLargest DECIMAL(6,2),
	@AdvcarCinomaBleeding TINYINT,
	@Lymphoma BIT,
	@LymphomaLesion TINYINT,
	@LymphomaStart INT,
	@LymphomaEnd INT,
	@LymphomaLargest DECIMAL(6,2),
	@LymphomaBleeding TINYINT,
	@EarlyType INT,
	@EarlyProbably BIT,
	@SubEarlyType INT,
	@EarlyBenignOrMalignantType INT,
	@EarlyOtherText VARCHAR(200),
	@GastricType INT,
	@GastricProbably BIT,
	@SubGastricType INT,
	@GastricBenignOrMalignantType INT,
	@GastricOtherText VARCHAR(200),
	@LymphomaType INT,
	@LymphomaProbably BIT,
	@SubLymphomaType INT,
	@LymphomaBenignOrMalignantType INT,
	@LymphomaOtherText VARCHAR(200)
)
AS

SET NOCOUNT ON

DECLARE @proc_id INT
DECLARE @proc_type INT

BEGIN TRANSACTION

BEGIN TRY
	SELECT 
		@proc_id = p.ProcedureId,
		@proc_type = p.ProcedureType
	FROM 
		ERS_Sites s
	JOIN 
		ERS_Procedures p ON s.ProcedureId = p.ProcedureId
	WHERE 
		SiteId = @SiteId
			
	IF NOT EXISTS (SELECT 1 FROM ERS_UpperGIAbnoMalignancy WHERE SiteId = @SiteId)
	BEGIN
		INSERT INTO ERS_UpperGIAbnoMalignancy (
			SiteId,
			[None],
			EarlyCarcinoma,
			EarlycarcinomaLesion,
			EarlyCarcinomaStart,
			EarlyCarcinomaEnd,
			EarlyCarcinomaLargest,
			EarlycarCinomaBleeding,
			AdvCarcinoma,
			AdvcarcinomaLesion,
			AdvCarcinomaStart,
			AdvCarcinomaEnd,
			AdvCarcinomaLargest,
			AdvcarCinomaBleeding,
			Lymphoma,
			LymphomaLesion,
			LymphomaStart,
			LymphomaEnd,
			LymphomaLargest,
			LymphomaBleeding,
			EarlyType,
			EarlyProbably,
			SubEarlyType,
			EarlyBenignOrMalignantType,
			EarlyOtherText,
			GastricType,
			GastricProbably,
			SubGastricType,
			GastricBenignOrMalignantType,
			GastricOtherText,
			LymphomaType,
			LymphomaProbably,
			SubLymphomaType,
			LymphomaBenignOrMalignantType,
			LymphomaOtherText) 
		VALUES (
			@SiteId,
			@None,
			@EarlyCarcinoma,
			@EarlycarcinomaLesion,
			@EarlyCarcinomaStart,
			@EarlyCarcinomaEnd,
			@EarlyCarcinomaLargest,
			@EarlycarCinomaBleeding,
			@AdvCarcinoma,
			@AdvcarcinomaLesion,
			@AdvCarcinomaStart,
			@AdvCarcinomaEnd,
			@AdvCarcinomaLargest,
			@AdvcarCinomaBleeding,
			@Lymphoma,
			@LymphomaLesion,
			@LymphomaStart,
			@LymphomaEnd,
			@LymphomaLargest,
			@LymphomaBleeding,
			@EarlyType,
			@EarlyProbably,
			@SubEarlyType,
			@EarlyBenignOrMalignantType,
			@EarlyOtherText,
			@GastricType,
			@GastricProbably,
			@SubGastricType,
			@GastricBenignOrMalignantType,
			@GastricOtherText,
			@LymphomaType,
			@LymphomaProbably,
			@SubLymphomaType,
			@LymphomaBenignOrMalignantType,
			@LymphomaOtherText)

		INSERT INTO ERS_RecordCount (
			[ProcedureId],
			[SiteId],
			[Identifier],
			[RecordCount]
		)
		VALUES (
			@proc_id,
			@SiteId,
			'Malignancy',
			1)
	END

	ELSE IF (@None=0 AND @EarlyCarcinoma=0 AND @AdvCarcinoma=0 AND @Lymphoma=0)
	BEGIN
		DELETE FROM ERS_UpperGIAbnoMalignancy 
		WHERE SiteId = @SiteId

		DELETE FROM ERS_RecordCount 
		WHERE SiteId = @SiteId
		AND Identifier = 'Malignancy'
	END
	
	ELSE
	BEGIN
		UPDATE 
			ERS_UpperGIAbnoMalignancy
		SET 
			[None] = @None,
			EarlyCarcinoma = @EarlyCarcinoma,
			EarlycarcinomaLesion = @EarlycarcinomaLesion,
			EarlyCarcinomaStart = @EarlyCarcinomaStart,
			EarlyCarcinomaEnd = @EarlyCarcinomaEnd,
			EarlyCarcinomaLargest = @EarlyCarcinomaLargest,
			EarlycarCinomaBleeding = @EarlycarCinomaBleeding,
			AdvCarcinoma = @AdvCarcinoma,
			AdvcarcinomaLesion = @AdvcarcinomaLesion,
			AdvCarcinomaStart = @AdvCarcinomaStart,
			AdvCarcinomaEnd = @AdvCarcinomaEnd,
			AdvCarcinomaLargest = @AdvCarcinomaLargest,
			AdvcarCinomaBleeding = @AdvcarCinomaBleeding,
			Lymphoma = @Lymphoma,
			LymphomaLesion = @LymphomaLesion,
			LymphomaStart = @LymphomaStart,
			LymphomaEnd = @LymphomaEnd,
			LymphomaLargest = @LymphomaLargest,
			LymphomaBleeding = @LymphomaBleeding,
			EarlyType = @EarlyType,
			EarlyProbably = @EarlyProbably,
			SubEarlyType = @SubEarlyType,
			EarlyBenignOrMalignantType = @EarlyBenignOrMalignantType,
			EarlyOtherText = @EarlyOtherText,
			GastricType = @GastricType,
			GastricProbably	= @GastricProbably,
			SubGastricType = @SubGastricType,
			GastricBenignOrMalignantType = @GastricBenignOrMalignantType,
			GastricOtherText = @GastricOtherText,
			LymphomaType = @LymphomaType,
			LymphomaProbably = @LymphomaProbably,
			SubLymphomaType	= @SubLymphomaType,
			LymphomaBenignOrMalignantType = @LymphomaBenignOrMalignantType,
			LymphomaOtherText = @LymphomaOtherText
		WHERE 
			SiteId = @SiteId
	END
END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;

GO
dbo.DropIfExist
    @ObjectName = 'abnormalities_malignancy_select',
    @ObjectTypePrefix = 'S'

GO
CREATE PROCEDURE [dbo].[abnormalities_malignancy_select]
(
	@SiteId INT	
)
AS

SET NOCOUNT ON

SELECT
	SiteId,
	[None],
	EarlyCarcinoma,
	EarlycarcinomaLesion,
	EarlyCarcinomaStart,
	EarlyCarcinomaEnd,
	EarlyCarcinomaLargest,
	EarlycarCinomaBleeding,
	AdvCarcinoma,
	AdvcarcinomaLesion,
	AdvCarcinomaStart,
	AdvCarcinomaEnd,
	AdvCarcinomaLargest,
	AdvcarCinomaBleeding,
	Lymphoma,
	LymphomaLesion,
	LymphomaStart,
	LymphomaEnd,
	LymphomaLargest,
	LymphomaBleeding,
	EUSProcType,
	EarlyType,
	EarlyProbably,
	SubEarlyType,
	EarlyBenignOrMalignantType,
	EarlyOtherText,
	GastricType,
	GastricProbably,
	SubGastricType,
	GastricBenignOrMalignantType,
	GastricOtherText,
	LymphomaType,
	LymphomaProbably,
	SubLymphomaType,
	LymphomaBenignOrMalignantType,
	LymphomaOtherText
FROM
	ERS_UpperGIAbnoMalignancy
WHERE 
	SiteId = @SiteId
	
GO
dbo.DropIfExist
    @ObjectName = 'abnormalities_malignancy_summary_update',
    @ObjectTypePrefix = 'S'

GO
CREATE PROCEDURE [dbo].[abnormalities_malignancy_summary_update]
(
	@SiteId INT
)
AS
	SET NOCOUNT ON

	DECLARE
		@summary VARCHAR(4000),
		@none BIT,
		@earlyCarcinoma BIT,
		@earlycarcinomaLesion TINYINT,
		@earlyCarcinomaStart INT,
		@earlyCarcinomaEnd INT,
		@earlyCarcinomaLargest DECIMAL(6,2),
		@earlycarCinomaBleeding TINYINT,
		@advCarcinoma BIT,
		@advcarcinomaLesion TINYINT,
		@advCarcinomaStart INT,
		@advCarcinomaEnd INT,
		@advCarcinomaLargest DECIMAL(6,2),
		@advcarCinomaBleeding TINYINT,
		@lymphoma BIT,
		@lymphomaLesion TINYINT,
		@lymphomaStart INT,
		@lymphomaEnd INT,
		@lymphomaLargest DECIMAL(6,2),
		@lymphomaBleeding TINYINT,
		@EarlyType INT,
		@EarlyProbably BIT,
		@SubEarlyType INT,
		@EarlyBenignOrMalignantType INT,
		@EarlyOtherText VARCHAR(200) = NULL,
		@GastricType INT,
		@GastricProbably BIT,
		@SubGastricType INT,
		@GastricBenignOrMalignantType INT,
		@GastricOtherText VARCHAR(200) = NULL,
		@LymphomaType INT,
		@LymphomaProbably BIT,
		@SubLymphomaType INT,
		@LymphomaBenignOrMalignantType INT,
		@LymphomaOtherText VARCHAR(200) = NULL

	SELECT 
		@none=[None],
		@earlyCarcinoma=EarlyCarcinoma,
		@earlycarcinomaLesion=EarlycarcinomaLesion,
		@earlyCarcinomaStart=EarlyCarcinomaStart,
		@earlyCarcinomaEnd=EarlyCarcinomaEnd,
		@earlyCarcinomaLargest=EarlyCarcinomaLargest,
		@earlycarCinomaBleeding=EarlycarCinomaBleeding,
		@advCarcinoma=AdvCarcinoma,
		@advcarcinomaLesion=AdvcarcinomaLesion,
		@advCarcinomaStart=AdvCarcinomaStart,
		@advCarcinomaEnd=AdvCarcinomaEnd,
		@advCarcinomaLargest=AdvCarcinomaLargest,
		@advcarCinomaBleeding=AdvcarCinomaBleeding,
		@lymphoma=Lymphoma,
		@lymphomaLesion=LymphomaLesion,
		@lymphomaStart=LymphomaStart,
		@lymphomaEnd=LymphomaEnd,
		@lymphomaLargest=LymphomaLargest,
		@lymphomaBleeding=LymphomaBleeding,
		@EarlyType = EarlyType,
		@EarlyProbably = EarlyProbably,
		@SubEarlyType = SubEarlyType,
		@EarlyBenignOrMalignantType = EarlyBenignOrMalignantType,
		@EarlyOtherText = EarlyOtherText,
		@GastricType = GastricType,
		@GastricProbably = GastricProbably,
		@SubGastricType = SubGastricType,
		@GastricBenignOrMalignantType = GastricBenignOrMalignantType,
		@GastricOtherText = GastricOtherText,
		@LymphomaType = LymphomaType,
		@LymphomaProbably = LymphomaProbably,
		@SubLymphomaType = SubLymphomaType,
		@LymphomaBenignOrMalignantType = LymphomaBenignOrMalignantType,
		@LymphomaOtherText = LymphomaOtherText
	FROM
		ERS_UpperGIAbnoMalignancy
	WHERE
		SiteId = @SiteId

	SET @Summary = ''

	DECLARE @earlyMalignancyText VARCHAR(200) = ''
	DECLARE @gastricMalignancyText VARCHAR(200) = ''
	DECLARE @lymphomaMalignancyText VARCHAR(200) = ''
	DECLARE @earlyProb VARCHAR(100) = ''
	DECLARE @gastricProb VARCHAR(100) = ''
	DECLARE @lymphomaProb VARCHAR(100) = ''

	IF @none = 1
		SET @summary = @summary + 'No malignancy'
	
	ELSE 
	BEGIN
		IF @earlyCarcinoma = 1 
		BEGIN
		IF @EarlyType > 0
			BEGIN		
				SET @earlyMalignancyText = CASE @SubEarlyType
										WHEN 1 THEN 'Indeterminate'
										WHEN 2 THEN 'Submucosal'
										WHEN 3 THEN 'Exophytic'
										ELSE ''
									END

				SET @earlyMalignancyText = @earlyMalignancyText + ' Early Gastric Carcinoma'

				IF @EarlyProbably = 1 SET @earlyProb = 'probably '

				IF @EarlyType = 1
				BEGIN
					SET @earlyMalignancyText = CASE @EarlyBenignOrMalignantType
											WHEN 1 THEN @earlyMalignancyText + ', ' + @earlyProb +  'benign (type uncertain)'
											WHEN 2 THEN @earlyMalignancyText + ', ' + @earlyProb +  'leiomyoma'
											WHEN 3 THEN @earlyMalignancyText + ', ' + @earlyProb +  'lipoma'
											WHEN 4 THEN @earlyMalignancyText + ', ' + @earlyProb +  'granular cell tumour'
											WHEN 5 THEN 
												(CASE WHEN @EarlyOtherText <> '' THEN @earlyMalignancyText + ', ' + @earlyProb +  'benign (' + @EarlyOtherText + ') ' ELSE '' END)
											ELSE @earlyMalignancyText + ', ' + @earlyProb +  'benign'
											END
				END
				ELSE IF @EarlyType = 2
				BEGIN
					SET @earlyMalignancyText = CASE @EarlyBenignOrMalignantType
										WHEN 1 THEN @earlyMalignancyText + ', ' + @earlyProb +  'malignant (cell type uncertain)'
										WHEN 2 THEN @earlyMalignancyText + ', ' + @earlyProb +  'squamous carcinoma'
										WHEN 3 THEN @earlyMalignancyText + ', ' + @earlyProb +  'adenocarcinoma'
										WHEN 4 THEN 
											CASE WHEN @EarlyOtherText <> '' THEN @earlyMalignancyText + ', ' + @earlyProb +  'malignant (' + @EarlyOtherText + ') ' ELSE '' END
										ELSE @earlyMalignancyText + ', ' + @earlyProb +  'malignant'
									END
				END

				SET @summary = @summary + @earlyMalignancyText
			END
			ELSE
			BEGIN
				SET @summary = @summary + 'Early Gastric Carcinoma'
			END

			IF @earlycarcinomaLesion > 0
			BEGIN
				SET @summary = @summary + ' - '
				IF @earlycarcinomaLesion = 1
					SET @summary = @summary + 'small polypoidal mass'
				ELSE IF @EarlycarcinomaLesion = 2
					SET @summary = @summary + 'focal discolouration'
				ELSE IF @EarlycarcinomaLesion = 3
					SET @summary = @summary + 'gastric ulcer with focal discouloration'
			END
		
			IF (@earlyCarcinomaStart > 0 OR @earlyCarcinomaEnd > 0)
			BEGIN
				IF @earlyCarcinomaStart > 0
					SET @summary = @summary + ' starting at ' + CONVERT(VARCHAR(20), @EarlyCarcinomaStart) + ' cm'
				IF @earlyCarcinomaEnd > 0
					SET @summary = @summary + ' ending at ' + CONVERT(VARCHAR(20), @EarlyCarcinomaEnd) + ' cm'
				SET @summary = @summary + ' from incissors'
			END

			IF @earlyCarcinomaLargest > 0
				SET @summary = @summary + ' (' + dbo.fnRemoveDecTrailingZeroes(CONVERT(VARCHAR(20), @EarlyCarcinomaLargest)) + ' cm in greatest diameter)'

			IF @earlycarCinomaBleeding > 0
				IF @earlycarCinomaBleeding = 1
					SET @summary = @summary + ' with recent bleeding'
				ELSE IF @earlycarCinomaBleeding = 2
					SET @summary = @summary + ' with active bleeding'
		END

		IF @advCarcinoma = 1 
		BEGIN
			IF @GastricType > 0
			BEGIN		
				SET @gastricMalignancyText = CASE @SubGastricType
										WHEN 1 THEN 'Indeterminate'
										WHEN 2 THEN 'Submucosal'
										WHEN 3 THEN 'Exophytic'
										ELSE ''
									END

				SET @gastricMalignancyText = @gastricMalignancyText + ' Established Gastric Carcinoma'

				IF @GastricProbably = 1 SET @gastricProb = 'probably '

				IF @GastricType = 1
				BEGIN
					SET @gastricMalignancyText = CASE @GastricBenignOrMalignantType
											WHEN 1 THEN @gastricMalignancyText + ', ' + @gastricProb +  'benign (type uncertain)'
											WHEN 2 THEN @gastricMalignancyText + ', ' + @gastricProb +  'leiomyoma'
											WHEN 3 THEN @gastricMalignancyText + ', ' + @gastricProb +  'lipoma'
											WHEN 4 THEN @gastricMalignancyText + ', ' + @gastricProb +  'granular cell tumour'
											WHEN 5 THEN 
												(CASE WHEN @GastricOtherText <> '' THEN @gastricMalignancyText + ', ' + @gastricProb +  'benign (' + @GastricOtherText + ') ' ELSE '' END)
											ELSE @gastricMalignancyText + ', ' + @gastricProb +  'benign'
											END
				END
				ELSE IF @GastricType = 2
				BEGIN
					SET @gastricMalignancyText = CASE @GastricBenignOrMalignantType
										WHEN 1 THEN @gastricMalignancyText + ', ' + @gastricProb +  'malignant (cell type uncertain)'
										WHEN 2 THEN @gastricMalignancyText + ', ' + @gastricProb +  'squamous carcinoma'
										WHEN 3 THEN @gastricMalignancyText + ', ' + @gastricProb +  'adenocarcinoma'
										WHEN 4 THEN 
											CASE WHEN @GastricOtherText <> '' THEN @gastricMalignancyText + ', ' + @gastricProb +  'malignant (' + @GastricOtherText + ') ' ELSE '' END
										ELSE @gastricMalignancyText + ', ' + @gastricProb +  'malignant'
									END
				END

				IF @summary <> '' SET @summary = @summary + '. ' + @gastricMalignancyText
				ELSE SET @summary = @gastricMalignancyText
			END
			ELSE
			BEGIN
				IF @summary <> '' SET @summary = @summary + '. Established Gastric Carcinoma'
				ELSE SET @summary = 'Established Gastric Carcinoma'
			END

			IF @advcarcinomaLesion > 0
			BEGIN
				SET @summary = @summary + ' - '
				IF @advcarcinomaLesion = 1
					SET @summary = @summary + 'polypoidal'
				ELSE IF @advcarcinomaLesion = 2
					SET @summary = @summary + 'polypoid with central ulceration'
				ELSE IF @advcarcinomaLesion = 3
					SET @summary = @summary + 'infiltrating'
				ELSE IF @advcarcinomaLesion = 4
					SET @summary = @summary + 'infiltrating with central ulceration'
				ELSE IF @advcarcinomaLesion = 5
					SET @summary = @summary + 'linitis plastica (probable)'
			END
		
			IF (@advCarcinomaStart > 0 OR @advCarcinomaEnd > 0)
			BEGIN
				IF @advCarcinomaStart > 0
					SET @summary = @summary + ' starting at ' + CONVERT(VARCHAR(20), @advCarcinomaStart) + ' cm'
				IF @advCarcinomaEnd > 0
					SET @summary = @summary + ' ending at ' + CONVERT(VARCHAR(20), @advCarcinomaEnd) + ' cm'
				SET @summary = @summary + ' from incissors'
			END

			IF @advCarcinomaLargest > 0
				SET @summary = @summary + ' (' + dbo.fnRemoveDecTrailingZeroes(CONVERT(VARCHAR(20), @advCarcinomaLargest)) + ' cm in greatest diameter)'

			IF @advcarCinomaBleeding > 0
				IF @advcarCinomaBleeding = 1
					SET @summary = @summary + ' with recent bleeding'
				ELSE IF @advcarCinomaBleeding = 2
					SET @summary = @summary + ' with active bleeding'		
		END

		IF @lymphoma = 1 
		BEGIN
			IF @LymphomaType > 0
			BEGIN		
				SET @lymphomaMalignancyText = CASE @SubLymphomaType
										WHEN 1 THEN 'Indeterminate'
										WHEN 2 THEN 'Submucosal'
										WHEN 3 THEN 'Exophytic'
										ELSE ''
									END

				SET @lymphomaMalignancyText = @lymphomaMalignancyText + ' Gastric Lymphoma'

				IF @LymphomaProbably = 1 SET @lymphomaProb = 'probably '

				IF @LymphomaType = 1
				BEGIN
					SET @lymphomaMalignancyText = CASE @LymphomaBenignOrMalignantType
											WHEN 1 THEN @lymphomaMalignancyText + ', ' + @lymphomaProb +  'benign (type uncertain)'
											WHEN 2 THEN @lymphomaMalignancyText + ', ' + @lymphomaProb +  'leiomyoma'
											WHEN 3 THEN @lymphomaMalignancyText + ', ' + @lymphomaProb +  'lipoma'
											WHEN 4 THEN @lymphomaMalignancyText + ', ' + @lymphomaProb +  'granular cell tumour'
											WHEN 5 THEN 
												(CASE WHEN @LymphomaOtherText <> '' THEN @lymphomaMalignancyText + ', ' + @lymphomaProb +  'benign (' + @LymphomaOtherText + ') ' ELSE '' END)
											ELSE @lymphomaMalignancyText + ', ' + @lymphomaProb +  'benign'
											END
				END
				ELSE IF @LymphomaType = 2
				BEGIN
					SET @lymphomaMalignancyText = CASE @LymphomaBenignOrMalignantType
										WHEN 1 THEN @lymphomaMalignancyText + ', ' + @lymphomaProb +  'malignant (cell type uncertain)'
										WHEN 2 THEN @lymphomaMalignancyText + ', ' + @lymphomaProb +  'squamous carcinoma'
										WHEN 3 THEN @lymphomaMalignancyText + ', ' + @lymphomaProb +  'adenocarcinoma'
										WHEN 4 THEN 
											CASE WHEN @LymphomaOtherText <> '' THEN @lymphomaMalignancyText + ', ' + @lymphomaProb +  'malignant (' + @LymphomaOtherText + ') ' ELSE '' END
										ELSE @lymphomaMalignancyText + ', ' + @lymphomaProb +  'malignant'
									END
				END
				IF @summary <> '' SET @summary = @summary + '. ' + @lymphomaMalignancyText
				ELSE SET @summary = @lymphomaMalignancyText
			END		
			ELSE
			BEGIN
				IF @summary <> '' SET @summary = @summary + '. Gastric Lymphoma'
				ELSE SET @summary = 'Gastric Lymphoma'
			END

			IF @lymphomaLesion > 0
			BEGIN
				SET @summary = @summary + ' - '
				IF @lymphomaLesion = 1
					SET @summary = @summary + 'single polypoidal mass'
				ELSE IF @lymphomaLesion = 2
					SET @summary = @summary + 'multiple polypoid discrete masses'
				ELSE IF @lymphomaLesion = 3
					SET @summary = @summary + 'diffusely infiltrating'
				ELSE IF @lymphomaLesion = 4
					SET @summary = @summary + 'diffusely infiltrating with ulceration'
			END
		
			IF (@lymphomaStart > 0 OR @lymphomaEnd > 0)
			BEGIN
				IF @lymphomaStart > 0
					SET @summary = @summary + ' starting at ' + CONVERT(VARCHAR(20), @lymphomaStart) + ' cm'
				IF @lymphomaEnd > 0
					SET @summary = @summary + ' ending at ' + CONVERT(VARCHAR(20), @lymphomaEnd) + ' cm'
				SET @summary = @summary + ' from incissors'
			END

			IF @lymphomaLargest > 0
				SET @summary = @summary + ' (' + dbo.fnRemoveDecTrailingZeroes(CONVERT(VARCHAR(20), @lymphomaLargest)) + ' cm in greatest diameter)'

			IF @lymphomaBleeding > 0
				IF @lymphomaBleeding = 1
					SET @summary = @summary + ' with recent bleeding'
				ELSE IF @lymphomaBleeding = 2
					SET @summary = @summary + ' with active bleeding'
		END
	END

	-- Finally update the summary in abnormalities table	
	UPDATE ERS_UpperGIAbnoMalignancy
	SET Summary = @Summary 
	WHERE SiteId = @siteId

GO
------------------------------------------------------------------------------------------------------------------------
-- END	3824
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ahmed Shoud
-- TFS#	No TFS - Item 3741 
-- Description of change
-- Cystoscopy missing from drug list
------------------------------------------------------------------------------------------------------------------------

GO
EXEC dbo.DropIfExist @ObjectName = 'get_drug',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)

GO
CREATE PROCEDURE [dbo].[get_drug]
(
	@DrugNo int
)
AS
BEGIN
	SELECT [DrugNo] as DrugNo,[DrugName] as DrugName,[DrugType],[IsReversingAgent] as Isreversingagent,[Units] as Units, [DefaultDose] as Defaultdose,[DoseIncrement] as Doseincrement,[DeliveryMethod] as Deliverymethod ,[UsedinColonSig] as UsedinColonSig, [UsedinERCP] as UsedinERCP ,[UsedinUpperGI] as UsedinUpperGI,[UsedinEUS_OGD] as UsedinEUSOGD,[UsedinEUS_HPB] as UsedinEUSHPB,  ISNULL(DoseNotApplicable,0) as DoseNotApplicable, ISNULL([UsedInBroncho], 0) as UsedInBroncho,  ISNULL([UsedInAntegrade], 0) as UsedInAntegrade,  ISNULL([UsedInRetrograde], 0) as UsedInRetrograde,  ISNULL([UsedInEBUS], 0) as UsedInEBUS,  ISNULL([UsedInFlexiCystoscopy], 0) as UsedInFlexiCystoscopy
	FROM   [ERS_DrugList] 
	WHERE [DrugNo] = @DrugNo
END

GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	No TFS - Item 3741
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ahmed Shoud
-- TFS#	No TFS - Item 4070 
-- Description of change
-- change management heading name on post procedure page
------------------------------------------------------------------------------------------------------------------------

GO
EXEC dbo.DropIfExist @ObjectName = 'ogd_qa_summary_update',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)

GO
CREATE PROCEDURE [dbo].[ogd_qa_summary_update]
(
       @ProcedureId INT
)
AS
       SET NOCOUNT ON

       DECLARE
              @summary VARCHAR(4000),
              @summaryTemp VARCHAR(4000),
              @summaryTemp2 VARCHAR(500),
              @NoNotes BIT,
              @ReferralLetter BIT,
              @ManagementNone BIT,
              @PulseOximetry BIT,
              @IVAccess BIT,
              @IVAntibiotics BIT,
              @Oxygenation BIT,
              @OxygenationMethod TINYINT,
              @OxygenationFlowRate DECIMAL(6,2),
              @ContinuousECG BIT,
              @BP BIT,
              @BPSystolic DECIMAL(6,2),
              @BPDiastolic DECIMAL(6,2),
              @ManagementOther BIT,
              @ManagementOtherText NVARCHAR(1000),
              @PatSedation TINYINT,
              @PatSedationAsleepResponseState TINYINT,
              @PatDiscomfortNurse TINYINT,
			  @PatDiscomfortEndo TINYINT,
              @ComplicationsNone BIT,
              @PoorlyTolerated BIT,
              @PatientDiscomfort BIT,
              @PatientDistress BIT,
              @InjuryToMouth BIT,
              @FailedIntubation BIT,
              @DifficultIntubation BIT,
              @DamageToScope BIT,
              @DamageToScopeType TINYINT,
              @GastricContentsAspiration BIT,
              @ShockHypotension BIT,
              @Haemorrhage BIT,
              @SignificantHaemorrhage BIT,
              @Hypoxia BIT,
              @RespiratoryDepression BIT,
              @RespiratoryArrest BIT,
              @CardiacArrest BIT,
              @CardiacArrythmia BIT,
              @Death BIT,
              @TechnicalFailure NVARCHAR(1000),
              @Perforation BIT,
              @PerforationText NVARCHAR(500),
              @ComplicationsOther BIT,
              @ComplicationsOtherText NVARCHAR(1000),
			  @Bleeding BIT,
			  @BleedingSeverity TINYINT,
			  @BleedingAdrenalineUsed BIT,
			  @BleedingAdrenalineAmount DECIMAL(8,2),
			  @BleedingColdSalineUsed BIT,
			  @BleedingBlockingDeviceUsed BIT,
			  @Pneumothorax BIT,
			  @PneumothoraxAspirChestDrain BIT,
			  @Hospitalisation BIT,
			  @MyocardInfarction BIT,
			  @Oversedation BIT,
			  @AdmissionToICU BIT

       SELECT 
              @NoNotes=NoNotes,
              @ReferralLetter=ReferralLetter,
              @ManagementNone=ManagementNone,
              @PulseOximetry=PulseOximetry,
              @IVAccess=IVAccess,
              @IVAntibiotics=IVAntibiotics,
              @Oxygenation=Oxygenation,
              @OxygenationMethod=OxygenationMethod,
              @OxygenationFlowRate=OxygenationFlowRate,
              @ContinuousECG=ContinuousECG,
              @BP=BP,
              @BPSystolic=BPSystolic,
              @BPDiastolic=BPDiastolic,
              @ManagementOther=ManagementOther,
              @ManagementOtherText=ManagementOtherText,
              @PatSedation=PatSedation,
              @PatSedationAsleepResponseState=PatSedationAsleepResponseState,
              @PatDiscomfortNurse=PatDiscomfortNurse,
			  @PatDiscomfortEndo=PatDiscomfortEndo,
              @ComplicationsNone=ComplicationsNone,
              @PoorlyTolerated=PoorlyTolerated,
              @PatientDiscomfort=PatientDiscomfort,
              @PatientDistress=PatientDistress,
              @InjuryToMouth=InjuryToMouth,
              @FailedIntubation=FailedIntubation,
              @DifficultIntubation=DifficultIntubation,
              @DamageToScope=DamageToScope,
              @DamageToScopeType=DamageToScopeType,
              @GastricContentsAspiration=GastricContentsAspiration,
              @ShockHypotension=ShockHypotension,
              @Haemorrhage=Haemorrhage,
              @SignificantHaemorrhage=SignificantHaemorrhage,
              @Hypoxia=Hypoxia,
              @RespiratoryDepression=RespiratoryDepression,
              @RespiratoryArrest=RespiratoryArrest,
              @CardiacArrest=CardiacArrest,
              @CardiacArrythmia=CardiacArrythmia,
              @Death=Death,
              @TechnicalFailure=TechnicalFailure,
              @Perforation=Perforation,
              @PerforationText=PerforationText,
              @ComplicationsOther=ComplicationsOther,
              @ComplicationsOtherText=ComplicationsOtherText,
			  @Bleeding=Bleeding,
			  @BleedingSeverity=BleedingSeverity,
			  @BleedingAdrenalineUsed=BleedingAdrenalineUsed,
			  @BleedingAdrenalineAmount=BleedingAdrenalineAmount,
			  @BleedingColdSalineUsed=BleedingColdSalineUsed,
			  @BleedingBlockingDeviceUsed=BleedingBlockingDeviceUsed,
			  @Pneumothorax=Pneumothorax,
			  @PneumothoraxAspirChestDrain=PneumothoraxAspirChestDrain,
			  @Hospitalisation=Hospitalisation,
			  @MyocardInfarction=MyocardInfarction,
			  @Oversedation=Oversedation,
			  @AdmissionToICU=AdmissionToICU
       FROM
              ERS_UpperGIQA
       WHERE
              ProcedureId = @ProcedureId

       SET @summary = ''
       SET @summaryTemp = ''

       --IF @NoNotes = 1 AND @ReferralLetter = 1
       --       SET @summary = 'Patient notes NOT available but referral letter/documentation WAS available'
       --ELSE IF @NoNotes = 1 AND @ReferralLetter = 0
       --       SET @summary = 'Patient notes NOT available '
       --ELSE 
       --       SET @summary = 'Patient notes available'
       
       
       --------------------------------------------------
       ------------------- MANAGEMENT ------------------- 
       -------------------------------------------------- 
       SET @summaryTemp = ''
       IF @ManagementNone = 1 
       BEGIN
              IF @summary = '' SET @summary = 'Patient Management: None' --TFS 4070
              ELSE SET @summary = @summary + '. <br/>Patient Management: None' --TFS 4070
       END

       ELSE
       BEGIN
              SELECT 
                     ManagementItem,
                     CASE ManagementItem 
                           WHEN 'PulseOximetry' THEN 'Pulse oximetry' 
                           WHEN 'IVAccess' THEN 'IV access' 
                           WHEN 'IVAntibiotics' THEN 'IV antibiotics' 
                           WHEN 'ContinuousECG' THEN 'Continuous ECG' 
                           WHEN 'ManagementOther' THEN 'Other'
                           ELSE ManagementItem 
                     END AS ManagementItemDesc, 
                     Selected
                     INTO #Management
              FROM 
              (SELECT * FROM ERS_UpperGIQA WHERE ProcedureId = @ProcedureId) a
              UNPIVOT
              (      Selected 
                     FOR ManagementItem IN (PulseOximetry,IVAccess,IVAntibiotics,Oxygenation,ContinuousECG,BP,ManagementOther)
              ) b
              WHERE Selected = 1

              IF (SELECT COUNT(*) FROM #Management) > 0
              BEGIN
                     -- Get the concatenated string separated by a delimiter, say $$
                     SELECT @summaryTemp = COALESCE (
                                                       CASE WHEN @summaryTemp = '' THEN ManagementItemDesc
                                                       ELSE @summaryTemp + '$$' + ManagementItemDesc END
                                                ,'')
                     FROM #Management

                     IF @ManagementOtherText <> '' SET @summaryTemp = REPLACE(@summaryTemp, 'Other' , @ManagementOtherText)

                     IF @OxygenationMethod > 0 OR @OxygenationFlowRate > 0 
                     BEGIN
                           SET @summaryTemp2 = ''
                           IF @OxygenationMethod = 1 
                                  IF @OxygenationFlowRate > 0 SET @summaryTemp2 = '(Oxygen given via Cannulae at ' + CONVERT(VARCHAR(10), @OxygenationFlowRate) + ' l/min)'
                                  ELSE SET @summaryTemp2 = '(Cannulae)'
                           ELSE IF @OxygenationMethod = 2 
                                  IF @OxygenationFlowRate > 0 SET @summaryTemp2 = '(Oxygen given via Mask at ' + CONVERT(VARCHAR(10), @OxygenationFlowRate) + ' l/min)'
                                  ELSE SET @summaryTemp2 = '(Mask)'
                           SET @summaryTemp = REPLACE(@summaryTemp, 'Oxygenation' , @summaryTemp2)
                     END

                     IF @BPSystolic > 0 OR @BPDiastolic > 0
                     BEGIN
                           SET @summaryTemp2 = 'BP ('
                           IF @BPSystolic > 0
                                  SET @summaryTemp2 = @summaryTemp2 + 'Systolic ' + CONVERT(VARCHAR(10), @BPSystolic) + ' mm'
                           IF @BPDiastolic > 0
                                  IF @summaryTemp2 <> '' SET @summaryTemp2 = @summaryTemp2 + ', Diastolic ' + CONVERT(VARCHAR(10), @BPDiastolic) + ' mm'
                                  ELSE SET @summaryTemp2 = @summaryTemp2 + 'Diastolic ' + CONVERT(VARCHAR(10), @BPDiastolic) + ' mm'
                           SET @summaryTemp2 = @summaryTemp2  + ')'
                           SET @summaryTemp = REPLACE(@summaryTemp, 'BP' , @summaryTemp2)
                     END
                     
                     -- Set the last occurence of $$ to "and"
                     IF CHARINDEX('$$', @summaryTemp) > 0 SET @summaryTemp = STUFF(@summaryTemp, len(@summaryTemp) - charindex('$$', reverse(@summaryTemp)), 2, ' and ')
                     -- Replace all other occurences of $$ with commas
                     IF CHARINDEX('$$', @summaryTemp) > 0 SET @summaryTemp = REPLACE(@summaryTemp, '$$', ', ')
              END

              DROP TABLE #Management

              --finally, add to the main summary field
              IF @summaryTemp <> ''
              BEGIN
                     IF @summary = '' SET @summary = 'Patient Management: ' + @summaryTemp --TFS 4070
                     ELSE SET @summary = @summary + '. <br/>Patient Management: ' + @summaryTemp --TFS 4070
              END
       END


       --------------------------------------------------
       ------------------- Nurse Assessment -------------
       -------------------------------------------------- 
       SET @summaryTemp = ''
	   DECLARE @NurseSummary varchar(max) = '', @NurseSummary2 varchar(max) = ''
	   
       IF @PatSedation > 0
       BEGIN
              SET @NurseSummary = 'Patient Sedation'
              IF @PatSedation = 1 SET @NurseSummary = @NurseSummary + ' - Not recorded'
              ELSE IF @PatSedation = 2 SET @NurseSummary = @NurseSummary + ' - Awake'
              ELSE IF @PatSedation = 3 SET @NurseSummary = @NurseSummary + ' - Drowsy'
              ELSE IF @PatSedation = 4 
              BEGIN
                     SET @NurseSummary = @NurseSummary + ' - Asleep'
                     IF @PatSedationAsleepResponseState = 1 SET @NurseSummary = @NurseSummary + ' but responding to name'
                     ELSE IF @PatSedationAsleepResponseState = 2 SET @NurseSummary = @NurseSummary + ' but responding to touch'
                     ELSE IF @PatSedationAsleepResponseState = 3 SET @NurseSummary = @NurseSummary + ' but unresponsive'
              END
       END

       IF @PatDiscomfortNurse > 0
       BEGIN
              SET @NurseSummary2 = 'Patient Discomfort'
              IF @PatDiscomfortNurse = 1 SET @NurseSummary2 = @NurseSummary2 + ' - Not recorded'
              IF @PatDiscomfortNurse = 2 SET @NurseSummary2 = @NurseSummary2 + ' - None-resting comfortably throughout'
              IF @PatDiscomfortNurse = 3 SET @NurseSummary2 = @NurseSummary2 + ' - One or two episode of mild discomfort, well tolerated'
              IF @PatDiscomfortNurse = 4 SET @NurseSummary2 = @NurseSummary2 + ' - More than two episodes of discomfort, adequately tolerated'
              IF @PatDiscomfortNurse = 5 SET @NurseSummary2 = @NurseSummary2 + ' - Significant discomfort, experienced several times during procedure'
              IF @PatDiscomfortNurse = 6 SET @NurseSummary2 = @NurseSummary2 + ' - Extreme discomfort frequently during test'
              
              IF @NurseSummary = '' SET @NurseSummary = @NurseSummary2
              ELSE SET @NurseSummary = @NurseSummary + '. ' + @NurseSummary2
       END

       IF @NurseSummary <> '' 
	   BEGIN
		IF @summary = '' SET @summary = 'Nurse Assessment: ' + @NurseSummary
		ELSE SET @summary = @summary + '. <br/>Nurse Assessment: ' + @NurseSummary
	   END


       --------------------------------------------------
       ------------------- Complications ----------------
       -------------------------------------------------- 
       SET @summaryTemp = ''
       IF @ComplicationsNone = 1 
       BEGIN
              IF @summary = '' SET @summary = 'No complications'
              ELSE SET @summary = @summary + '. <br/>No complications'

			  UPDATE ERS_UpperGIQA SET ComplicationsSummary = 'No complications' WHERE ProcedureId = @ProcedureId
       END

       ELSE
       BEGIN
              SELECT 
                     ComplicationsItem,
                     CASE ComplicationsItem 
                           WHEN 'PoorlyTolerated' THEN 'poorly tolerated' 
                           WHEN 'PatientDiscomfort' THEN 'patient discomfort' 
                           WHEN 'PatientDistress' THEN 'patient distress' 
                           WHEN 'InjuryToMouth' THEN 'injury to mouth' 
                           WHEN 'FailedIntubation' THEN 'failed intubation'
                           WHEN 'DifficultIntubation' THEN 'difficult intubation'
                           WHEN 'DamageToScope' THEN 'damage to scope' + CASE @DamageToScopeType WHEN 1 THEN ' (mechanical)' WHEN 2 THEN ' (patient initiated)' WHEN 9 THEN ' (mechanical and patient initiated)' ELSE '' END
                           WHEN 'GastricContentsAspiration' THEN 'gastric contents aspiration'
                           WHEN 'ShockHypotension' THEN 'shock/hypotension'
						   WHEN 'Haemorrhage' THEN 'haemorrhage'
                           WHEN 'SignificantHaemorrhage' THEN 'significant haemorrhage'
						   WHEN 'Hypoxia' THEN 'hypoxia'
                           WHEN 'RespiratoryDepression' THEN 'respiratory depression'
                           WHEN 'RespiratoryArrest' THEN 'respiratory arrest'
                           WHEN 'CardiacArrest' THEN 'cardiac arrest'
						   WHEN 'CardiacArrythmia' THEN 'cardiac arrhythmia'
						   WHEN 'Death' THEN 'death'
						   WHEN 'Perforation' THEN 'perforation' + CASE WHEN @PerforationText <> '' THEN ' (site: ' + @PerforationText + ')' ELSE '' END
						   WHEN 'Pneumothorax' THEN 'pneumothorax' + CASE WHEN @PneumothoraxAspirChestDrain = 1 THEN ' (required aspiration/chest drain)' ELSE '' END
						   WHEN 'Hospitalisation' THEN 'hospitalisation'
						   WHEN 'MyocardInfarction' THEN 'myocardial infarction/pulmonary oedema'
						   WHEN 'Oversedation' THEN 'oversedation requiring ventilatory support or reversal'
						   WHEN 'AdmissionToICU' THEN 'admission to ICU'
                           WHEN 'ComplicationsOther' THEN CASE WHEN @ComplicationsOtherText <> '' THEN @ComplicationsOtherText ELSE 'other' END
                           ELSE ComplicationsItem 
                     END AS ComplicationsItemDesc, 
                     Selected
                     INTO #Complications
              FROM 
              (SELECT * FROM ERS_UpperGIQA WHERE ProcedureId = @ProcedureId) a
              UNPIVOT
              (      Selected 
                     FOR ComplicationsItem IN (PoorlyTolerated,PatientDiscomfort,PatientDistress,InjuryToMouth,FailedIntubation,DifficultIntubation,DamageToScope,
                                                              GastricContentsAspiration,ShockHypotension,Haemorrhage,SignificantHaemorrhage,Hypoxia,RespiratoryDepression,RespiratoryArrest,
                                                              CardiacArrest,CardiacArrythmia,Death,Perforation,
															  Pneumothorax,Hospitalisation,MyocardInfarction,Oversedation,AdmissionToICU,
															  ComplicationsOther)
              ) b
              WHERE Selected = 1
			  
			  IF @Bleeding = 1
			  BEGIN
				DECLARE @bleedingsummary VARCHAR(500) = '', @actiontakensummary VARCHAR(500) = ''
				IF @BleedingSeverity = 1 SET @bleedingsummary = 'mild bleeding'
				ELSE IF @BleedingSeverity = 2 SET @bleedingsummary = 'moderate bleeding'
				ELSE IF @BleedingSeverity = 3 SET @bleedingsummary = 'severe bleeding'
				ELSE SET @bleedingsummary = 'bleeding'

				IF @BleedingColdSalineUsed = 1 OR @BleedingBlockingDeviceUsed = 1 OR @BleedingAdrenalineUsed = 1
				BEGIN
					SET @actiontakensummary = ' (action taken: '

					IF @BleedingColdSalineUsed = 1 SET @actiontakensummary = @actiontakensummary + '$$cold saline'
					IF @BleedingBlockingDeviceUsed = 1 SET @actiontakensummary = @actiontakensummary + '$$blocking device used'
					IF @BleedingAdrenalineUsed = 1
					BEGIN
						SET @actiontakensummary = @actiontakensummary + '$$adrenaline used'
						IF @BleedingAdrenalineAmount > 0 SET @actiontakensummary = @actiontakensummary + ' ' + CONVERT(VARCHAR, @BleedingAdrenalineAmount) + ' ml'
					END
					SET @actiontakensummary = @actiontakensummary + ')'

					-- Remove the first occurence of $$
					IF CHARINDEX('$$', @actiontakensummary) > 0 SET @actiontakensummary = REPLACE(@actiontakensummary, ': $$', ': ')
					-- Set the last occurence of $$ to "and"
					IF CHARINDEX('$$', @actiontakensummary) > 0 SET @actiontakensummary = STUFF(@actiontakensummary, len(@actiontakensummary) - charindex('$$', reverse(@actiontakensummary)), 2, ' and ')
					-- Replace all other occurences of $$ with commas
					IF CHARINDEX('$$', @actiontakensummary) > 0 SET @actiontakensummary = REPLACE(@actiontakensummary, '$$', ', ')
				END
				INSERT INTO #Complications VALUES ('Bleeding', @bleedingsummary + @actiontakensummary, 1)
			  END

              IF (SELECT COUNT(*) FROM #Complications) > 0
              BEGIN
                     -- Get the concatenated string separated by a delimiter, say $$
                     SELECT @summaryTemp = COALESCE (
                                                       CASE WHEN @summaryTemp = '' THEN ComplicationsItemDesc
                                                       ELSE @summaryTemp + '$$' + ComplicationsItemDesc END
                                                ,'')
                     FROM #Complications

                     --IF @PerforationText <> '' SET @summaryTemp = REPLACE(@summaryTemp, 'Perforation' , 'perforation (site: ' + @PerforationText + ')')
                     --IF @ComplicationsOtherText <> '' SET @summaryTemp = REPLACE(@summaryTemp, 'Other' , @ComplicationsOtherText)
                     

                     --IF @DamageToScopeType > 0
                     --BEGIN
                     --      SET @summaryTemp2 = ''
                     --      IF @DamageToScopeType = 1 
                     --             SET @summaryTemp2 = 'Damage to scope (mechanical)'
                     --      ELSE IF @DamageToScopeType = 2 
                     --             SET @summaryTemp2 = 'Damage to scope (patient initiated)'
                     --      SET @summaryTemp = REPLACE(@summaryTemp, 'Damage to scope' , @summaryTemp2)
                     --END

              END
			  IF @TechnicalFailure <> '' 
				IF @summaryTemp = ''
					SET @summaryTemp = @summaryTemp + 'technical failure (' + @TechnicalFailure + ')'
				ELSE
					SET @summaryTemp = @summaryTemp + '$$technical failure (' + @TechnicalFailure + ')'

              -- Set the last occurence of $$ to "and"
              IF CHARINDEX('$$', @summaryTemp) > 0 SET @summaryTemp = STUFF(@summaryTemp, len(@summaryTemp) - charindex('$$', reverse(@summaryTemp)), 2, ' and ')
              -- Replace all other occurences of $$ with commas
              IF CHARINDEX('$$', @summaryTemp) > 0 SET @summaryTemp = REPLACE(@summaryTemp, '$$', ', ')

              DROP TABLE #Complications

              --finally, add to the main summary field
              IF @summaryTemp <> ''
              BEGIN
				  UPDATE ERS_UpperGIQA SET ComplicationsSummary = 'Complications: ' + @summaryTemp WHERE ProcedureId = @ProcedureId
				  IF @summary = '' SET @summary = 'Complications: ' + @summaryTemp
				  ELSE SET @summary = @summary + '. <br/>Complications: ' + @summaryTemp
              END
			  ELSE
			  BEGIN
				UPDATE ERS_UpperGIQA SET ComplicationsSummary = '' WHERE ProcedureId = @ProcedureId
			  END
       END

       --PRINT @summary

       --Update the summary column in diagnoses table and procedures table
       UPDATE ERS_UpperGIQA
       SET Summary = @summary 
       WHERE ProcedureId = @ProcedureId

       EXEC procedure_summary_update @procedureID

GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	No TFS - Item 4070
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ahmed Shoud
-- TFS#	No TFS - Item 3741 
-- Description of change
-- Cystoscopy missing from drug list
------------------------------------------------------------------------------------------------------------------------

GO
EXEC dbo.DropIfExist @ObjectName = 'get_pre_med_drug',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)

GO
CREATE PROCEDURE [dbo].[get_pre_med_drug]
(
    @ProcedureFieldName varchar(max)
)
AS
BEGIN
    DECLARE @sql nvarchar(max);

    SET @sql = N'
    SELECT row_number() OVER (ORDER BY Drugname) AS tdOrderBy, * 
    INTO #DrugList 
    FROM [ERS_DrugList] 
    WHERE ' + QUOTENAME(@ProcedureFieldName) + ' = 1 AND [Drugtype] = 0 
    ORDER BY [Drugname] ASC;

    UPDATE #DrugList 
    SET tdOrderBy = 1 
    WHERE tdOrderBy <= ((SELECT COUNT(*) FROM #DrugList) / 2);

    SELECT * 
    FROM #DrugList 
    ORDER BY tdOrderBy, DrugName;

    IF OBJECT_ID(''tempdb..#DrugList'') IS NOT NULL 
        DROP TABLE #DrugList;
    ';

    EXEC sp_executesql @sql;
END

GO

EXEC dbo.DropIfExist @ObjectName = 'get_reversal_agents_drug',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)

GO
CREATE PROCEDURE [dbo].[get_reversal_agents_drug]
(
    @ProcedureFieldName varchar(max)
)
AS
BEGIN
    DECLARE @sql nvarchar(max);

    SET @sql = N'
    SELECT row_number() OVER (ORDER BY Drugname) AS tdOrderBy, *  
    INTO #DrugList 
	FROM [ERS_DrugList]
    WHERE ' + QUOTENAME(@ProcedureFieldName) + ' = 1 AND [Drugtype] = 0 AND [IsReversingAgent] = 1
    ORDER BY [Drugname] ASC;

    UPDATE #DrugList 
    SET tdOrderBy = 1 
    WHERE tdOrderBy <= ((SELECT COUNT(*) FROM #DrugList) / 2);

    SELECT * 
    FROM #DrugList 
    ORDER BY tdOrderBy, DrugName;

    IF OBJECT_ID(''tempdb..#DrugList'') IS NOT NULL 
        DROP TABLE #DrugList;
    ';

    EXEC sp_executesql @sql;
END

GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	No TFS - Item 3741
------------------------------------------------------------------------------------------------------------------------


------------------------------------------------------------------------------------------------------------------------
-- Updated by	: Rezaul Karim
-- TFS#	No TFS - Item 2978
-- Description of change: Angiodysplasia diagnoses error
------------------------------------------------------------------------------------------------------------------------

GO
EXEC dbo.DropIfExist @ObjectName = 'TR_CommonAbnoVascularLesions',      -- varchar(100)
                     @ObjectTypePrefix = 'TR' -- varchar(5)

GO

CREATE TRIGGER [dbo].[TR_CommonAbnoVascularLesions]
ON [dbo].[ERS_CommonAbnoVascularLesions]
AFTER INSERT, UPDATE, DELETE
AS 
	DECLARE @site_id INT, @Telangiectasia VARCHAR(10) = 'False', @Angioma VARCHAR(10) = 'False', 
			@StomachTelangiectasia VARCHAR(10) = 'False', @PortalHypertensiveGastropathy VARCHAR(10) = 'False', 
			@TelangiectasiaAngioma VARCHAR(10) = 'False', @Angiodysplasia VARCHAR(10) = 'False', 
			@Action CHAR(1) = 'I' , @DieulafoyLesion VARCHAR(10) = 'False', @DuodenumVarices VARCHAR(10) = 'False',
			@WatermelonStomach VARCHAR(10) = 'False',
			@DuoTelangiectasia VARCHAR(10)

    IF EXISTS(SELECT * FROM DELETED) SET @Action = CASE WHEN EXISTS(SELECT * FROM INSERTED) THEN 'U' ELSE 'D' END

	-- INSERTED OR UPDATED
	IF @Action IN ('I', 'U') 
	BEGIN
		SELECT @site_id=SiteId,
				-- START TFS 2978
				@Telangiectasia = (CASE WHEN ([Type] = 1 AND [Area] = 'Oesophagus'  AND [Area] != 'Duodenum') THEN 'True' ELSE 'False' END),
				@DuoTelangiectasia = (CASE WHEN ([Type] = 1 AND [Area] = 'Duodenum') THEN 'True' ELSE 'False' END),
				@Angioma = (CASE WHEN (([Type] = 2 OR [Type] = 3 OR [Type] = 4) and Area='Stomach') THEN 'True' ELSE 'False' END),
				@StomachTelangiectasia = (CASE WHEN ([Type]=1 AND [Area]='Stomach') THEN 'True' ELSE 'False' END),
				@PortalHypertensiveGastropathy = (CASE WHEN (Area='Stomach' AND [Type]=5) THEN 'True' ELSE 'False' END),
				@DuodenumVarices = (CASE WHEN (Area='Duodenum' AND [Type]=5) THEN 'True' ELSE 'False' END),
				@TelangiectasiaAngioma = (CASE WHEN ( Area='Duodenum' AND [Type] in( 1 , 2 , 3 , 4)) THEN 'True' ELSE 'False' END),
				@Angiodysplasia = (CASE WHEN ([Type] BETWEEN 2 AND 5) THEN 'True' ELSE 'False' END),
				@DieulafoyLesion = (CASE WHEN [Type] = 7 AND [Area] = 'Stomach'  THEN 'True' ELSE 'False' END), --TFS--4190
				-- END TFS 2978
				@WatermelonStomach = (CASE WHEN ([Type] = 6 AND [Area] = 'Stomach') THEN 'True' ELSE 'False' END)
		FROM INSERTED

		EXEC abnormalities_vascular_lesions_summary_update @site_id
	END

	-- DELETED
	IF @Action = 'D'
	BEGIN
		SELECT @site_id=SiteId FROM DELETED
	END

	EXEC sites_summary_update @site_id

	IF ISNULL((SELECT p.ProcedureType FROM ers_sites s 
		INNER JOIN ers_procedures p ON s.ProcedureId = p.ProcedureId 
		WHERE SiteId = @site_id),0) IN (2, 7)   --Check If ERCP (2), else proceed with OGD
	BEGIN
		EXEC diagnoses_control_save @site_id, 'D64P2', @Angiodysplasia					-- 'Angiodysplasia'
		EXEC diagnoses_control_save @site_id, 'D396P2', @DuoTelangiectasia					-- 'Telangiectasia'

	END
	ELSE
	BEGIN
		EXEC diagnoses_control_save @site_id, 'D22P1', @Telangiectasia					-- 'Telangiectasia'
		EXEC diagnoses_control_save @site_id, 'D43P1', @Angioma							-- 'Angioma'
		EXEC diagnoses_control_save @site_id, 'D46P1', @StomachTelangiectasia			-- 'StomachTelangiectasia'
		EXEC diagnoses_control_save @site_id, 'D52P1', @PortalHypertensiveGastropathy	-- 'PortalHypertensiveGastropathy'
		EXEC diagnoses_control_save @site_id, 'D59P1', @TelangiectasiaAngioma			-- 'TelangiectasiaAngioma'
		EXEC diagnoses_control_save @site_id, 'D80P1', @DieulafoyLesion					-- 'Dieulafoy Lesion'
		EXEC diagnoses_control_save @site_id, 'D106P1', @DuodenumVarices
		EXEC diagnoses_control_save @site_id, 'D85P1', @WatermelonStomach				-- GAVE (Watermelon Stomach)
	END

GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	No TFS - Item 2978
------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Duncan
-- TFS#	XXXX
-- Description of change: Log Login Attempts
-------------------------------------------------------------------------------------------------------------------------
EXEC dbo.DropIfExist @ObjectName = 'LogLoginFail',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].LogLoginFail  
(  
 @UserId varchar(50),  
 @Reason varchar(max)
)
AS
	Insert into ERS_UserActivityAudit (UserId, UserName, [Action], ActionDetails, [When])
	Values (0, @UserId, 'LOGIN FAIL', @Reason, GetDate())
GO

EXEC dbo.DropIfExist @ObjectName = 'LogLoginSuccess',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].LogLoginSuccess  
(  
 @UserId varchar(50)
)
AS
	Insert into ERS_UserActivityAudit (UserId, UserName, [Action], ActionDetails, [When])
	Values (0, @UserId, 'LOGIN', NULL, GetDate())
GO
------------------------------------------------------------------------------------------------------------------------
-- TFS-END#	XXXX Duncan
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ferdowsi On 10 june 2024
-- TFS#	No TFS - Item 3867  
-- Description of change
--  
------------------------------------------------------------------------------------------------------------------------
GO
IF NOT EXISTS(SELECT 1 FROM ERS_AdverseEventsProcedureTypes WHERE ProcedureTypeId = 11 )
BEGIN  
    INSERT INTO ERS_AdverseEventsProcedureTypes (AdverseEventsId, ProcedureTypeId)
    SELECT AdverseEventsId, 11 
    FROM ERS_AdverseEventsProcedureTypes 
    WHERE ProcedureTypeId = 10;
END

GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	3867 by Ferdowsi
------------------------------------------------------------------------------------------------------------------------



------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Ferdowsi On 14 March 2024
-- TFS#	No TFS - Item 2333
-- Description of change
-- Set default 'yes' on scope guide for Colonoscopy and Sigmoidscopy procedures
------------------------------------------------------------------------------------------------------------------------

EXEC dbo.DropIfExist @ObjectName = 'TR_Procedure_Updated',      -- varchar(100)
                     @ObjectTypePrefix = 'TR' -- varchar(5)
GO

CREATE TRIGGER [dbo].[TR_Procedure_Updated]
   ON  [dbo].[ERS_Procedures]



   AFTER INSERT, UPDATE, DELETE
AS 
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    DECLARE @ReportUpdated bit, @ProcedureId int, @PatientId int, @ProcedureType tinyint, @pancreasDivisum VARCHAR(10) = 'False'
	SELECT @ReportUpdated = ReportUpdated, @ProcedureId = ProcedureId, 
			@PatientId = PatientId, @ProcedureType = ProcedureType,  
			@pancreasDivisum = (CASE WHEN pancreasDivisum = 1 THEN 'True' ELSE 'False' END)
	FROM INSERTED

	IF ISNULL(@ReportUpdated,0) <> 0
	BEGIN
		UPDATE ERS_Procedures SET ReportUpdated = 1 WHERE ProcedureID = @ProcedureID AND ISNULL(ReportUpdated, 0) <> 1
	END

	-- check expected patients for match on patientid, procedure type and date
	IF EXISTS(SELECT 1 FROM dbo.ERS_ExpectedPatients eep 
				WHERE PatientId = @PatientId 
					AND (eep.ProcedureType IS NULL OR eep.ProcedureType = @ProcedureType) 
					AND CONVERT(varchar(10),eep.ExpectedDateTime, 103) = CONVERT(varchar(10),GETDATE(), 103)
					AND ISNULL(eep.STATUS, 0) = 0)
	BEGIN
		UPDATE ERS_ExpectedPatients
		SET [Status] = 1
		WHERE PatientId = @PatientId 
				AND (ProcedureType IS NULL OR ProcedureType = @ProcedureType) 
				AND CONVERT(varchar(10),ExpectedDateTime, 103) = CONVERT(varchar(10),GETDATE(), 103)
	END

	IF @ProcedureType IN (2,7)
	BEGIN
		IF @pancreasDivisum = 'True'
		BEGIN
			IF NOT EXISTS (SELECT 1 FROM ERS_Diagnoses WHERE ProcedureId = @ProcedureId AND MatrixCode = 'D97P2' AND Value = 'True')
				INSERT INTO ERS_Diagnoses (ProcedureId, MatrixCode, Value, Region, IsOtherData) VALUES (@ProcedureId, 'D97P2', 'True', 'Pancreas',1)
			ELSE
				UPDATE ERS_Diagnoses SET Value = 'True', IsOtherData = 1 WHERE MatrixCode = 'D97P2' --incase code exists  but with a value of false

			exec ercp_diagnoses_summary_update @Procedureid
		END
		ELSE
		BEGIN
			IF EXISTS (SELECT 1 FROM ERS_Diagnoses WHERE ProcedureId = @ProcedureId AND MatrixCode = 'D97P2')
			BEGIN
				DELETE FROM ERS_Diagnoses WHERE MatrixCode = 'D97P2' --incase code exists  but with a value of false
				exec ercp_diagnoses_summary_update @Procedureid
			END

		END
	END

IF NOT EXISTS (SELECT 1 FROM deleted)
  BEGIN  
    IF @ProcedureType IN (3,4)
	BEGIN
	Update ERS_Procedures set ScopeGuide = 1 where ProcedureId =  @ProcedureId
	END
  END 
	
END


------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	No TFS - Item 2333 by Ferdowsi
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Siddikur Rahman
-- TFS#	3909
-- Description of change: Updated to patient pathway
-------------------------------------------------------------------------------------------------------------------------
GO

DECLARE @ListDescriptions VARCHAR(MAX) = 'Evidence of cancer yes*Evidence of cancer no*Evidence of cancer unknown'
DECLARE @itemDescription VARCHAR(100)
DECLARE @tempDescription TABLE (ListDescription VARCHAR(100));

DECLARE main_cursor CURSOR FOR
	SELECT Item FROM fnSplitString(@ListDescriptions, '*');

OPEN main_cursor
FETCH NEXT FROM main_cursor INTO @itemDescription
WHILE @@FETCH_STATUS = 0
BEGIN
	DELETE FROM @tempDescription;
	INSERT INTO dbo.ERS_ListsMain (ListDescription, AllowAddNewItem, OrderByDesc)
	OUTPUT inserted.ListDescription INTO @tempDescription
	SELECT @itemDescription, 0, 0
	WHERE NOT EXISTS (
		SELECT 1 FROM dbo.ERS_ListsMain WHERE ListDescription = @itemDescription
	);

	IF EXISTS (SELECT 1 FROM @tempDescription)
	BEGIN
		DECLARE @listDescription VARCHAR(100);
		SELECT @listDescription = ListDescription FROM @tempDescription;
    
		DECLARE @CancerItemsYes VARCHAR(MAX) = 'Cancer diagnosed, patient informed, click stop 28 day pathway*Cancer diagnosed, patient not informed, continue on 28 day pathway*Cancer suspected, continue on 28 day pathway'
		DECLARE @CancerItemsNo VARCHAR(MAX) = 'Cancer ruled out, patient information, click stop 28 day pathway*Cancer ruled out, patient not informed, continue on 28 day pathway*Findings inconclusive, continue on 28 days pathway'
		DECLARE @CancerItemsUnknown VARCHAR(MAX) = 'Findings inconclusive, continue on 28 days pathway*N/A not on 28 day pathway'
		DECLARE @itemName VARCHAR(100);
		
		IF @listDescription = 'Evidence of cancer yes'
		BEGIN
			DECLARE db_cursor CURSOR FOR
				SELECT Item FROM fnSplitString(@CancerItemsYes, '*');
		END
		ELSE IF @listDescription = 'Evidence of cancer no'
		BEGIN
			DECLARE db_cursor CURSOR FOR
				SELECT Item FROM fnSplitString(@CancerItemsNo, '*');
		END
		ELSE
		BEGIN
			DECLARE db_cursor CURSOR FOR
				SELECT Item FROM fnSplitString(@CancerItemsUnknown, '*');
		END

		OPEN db_cursor;
		FETCH NEXT FROM db_cursor INTO @itemName;
    
		WHILE @@FETCH_STATUS = 0
		BEGIN
			DECLARE @ListItemNo INT;
			SET @ListItemNo = (SELECT ISNULL(MAX(ListItemNo), 0) + 1 FROM ERS_Lists WHERE ListDescription = @listDescription);
        
			IF NOT EXISTS (SELECT 1 FROM ERS_Lists WHERE ListDescription = @listDescription AND ListItemText = @itemName)
			BEGIN
				INSERT INTO dbo.ERS_Lists (ListDescription, ListItemNo, ListItemText, Suppressed, ListMainId, WhoCreatedId, WhenCreated)
				SELECT @listDescription, @ListItemNo, @itemName, 0, elm.ListMainId, 0, GETDATE()
				FROM dbo.ERS_ListsMain elm WHERE elm.ListDescription = @listDescription;
			END
        
			FETCH NEXT FROM db_cursor INTO @itemName;
		END
    
		CLOSE db_cursor;
		DEALLOCATE db_cursor;
	END

	FETCH NEXT FROM main_cursor INTO @itemDescription;
END

CLOSE main_cursor;
DEALLOCATE main_cursor;
GO

EXEC dbo.DropIfExist 
    @ObjectName = 'pathway_plan_questions_save', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[pathway_plan_questions_save]
(
	@Question varchar(max),
	@Optional bit,
	@FreeText bit,
	@Mandatory bit,
	@ProcedureType INT,
	@OperatingHospitalId INT,
	@QuestionId int = NULL,
	@Suppressed bit = NULL
)
AS
BEGIN
	DECLARE @MaxCount INT;
	SET @MaxCount =  (SELECT COUNT(QuestionId) FROM ERS_PathwayPlanQuestions WHERE ProcedureType = @ProcedureType AND Suppressed = 0 AND OperatingHospital = @OperatingHospitalId);
	IF @QuestionId IS NULL AND @MaxCount < 10
	BEGIN
		INSERT INTO dbo.ERS_PathwayPlanQuestions
		(
			Question,
			Optional,
			CanFreeText,
			Mandatory,
			ProcedureType,
			OperatingHospital,
			OrderById
		)
		VALUES
		(
			@Question,
			@Optional,
			@FreeText,
			@Mandatory,
			@ProcedureType,
			@OperatingHospitalId,
			(SELECT ISNULL(MAX(OrderById), 0) + 1 FROM ERS_PathwayPlanQuestions WHERE ProcedureType = @ProcedureType AND OperatingHospital = @OperatingHospitalId AND Suppressed = 0)
		)
	END
	ELSE
	BEGIN
		IF @Suppressed IS NULL
		BEGIN
			UPDATE ERS_PathwayPlanQuestions
			SET Question = @Question,
				Optional = @Optional,
				CanFreeText = @FreeText,
				Mandatory = @Mandatory,
				ProcedureType = @ProcedureType,
				OperatingHospital = @OperatingHospitalId
			WHERE QuestionId = @QuestionId
		END
		ELSE
		BEGIN
			IF @Suppressed = 1
			BEGIN
				UPDATE ERS_PathwayPlanQuestions 
				SET Suppressed = 1 
				/*, OrderById = NULL do not change this. we want to keep the order incase we want to unsuppress it*/ 
				WHERE QuestionId = @QuestionId
				
				--reorder the questions
				DECLARE @tbl TABLE (RowId int, QuestionId int, OrderById int)

				INSERT INTO @tbl 
				SELECT ROW_NUMBER() OVER (ORDER BY OrderById), QuestionId, OrderById
				FROM ERS_PathwayPlanQuestions WHERE Suppressed = 0 ORDER BY OrderById

				UPDATE p
				SET p.OrderById = t.RowId
				FROM ERS_PathwayPlanQuestions p
				INNER JOIN @tbl t ON t.OrderById = p.OrderById
			END
			ELSE IF @Suppressed	= 0
			BEGIN
				UPDATE ERS_PathwayPlanQuestions SET Suppressed = 0, OrderById = NULL WHERE QuestionId = @QuestionId
				
				--reorder the questions
				DECLARE @tblu TABLE (RowId int, QuestionId int, OrderById int)

				INSERT INTO @tbl 
				SELECT ROW_NUMBER() OVER (ORDER BY OrderById), QuestionId, OrderById
				FROM ERS_PathwayPlanQuestions WHERE Suppressed = 0 OR QuestionId = @QuestionId ORDER BY OrderById

				UPDATE p
				SET p.OrderById = t.RowId
				FROM ERS_PathwayPlanQuestions p
				INNER JOIN @tblu t ON t.OrderById = p.OrderById

			END
		END

	END
END

GO

EXEC dbo.DropIfExist 
    @ObjectName = 'pathway_plan_questions_select', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[pathway_plan_questions_select]
(
	@Suppressed bit = NULL,
	@OperatingHospitalId INT,
	@ProcedureType INT
)
AS
BEGIN
	SELECT
		QuestionId,
		Question,
		Optional,
		CanFreeText,
		Mandatory,
		Suppressed,
		OrderById,
		IsSystem,
		UnknownOption
	FROM ERS_PathwayPlanQuestions
	WHERE Suppressed = ISNULL(@Suppressed, Suppressed)
	AND ProcedureType = @ProcedureType
	AND OperatingHospital = @OperatingHospitalId
	ORDER BY OrderById
END

GO

EXEC dbo.DropIfExist 
    @ObjectName = 'pathway_plan_questions_reorder', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[pathway_plan_questions_reorder]
(
	@QuestionId int,
	@Direction char(1)
)
AS
BEGIN
	DECLARE @CurrentOrder INT = (SELECT OrderById FROM ERS_PathwayPlanQuestions WHERE QuestionId = @QuestionId)
	DECLARE @ProcedureType INT = (SELECT ProcedureType FROM ERS_PathwayPlanQuestions WHERE QuestionId = @QuestionId)
	DECLARE @OperatingHospital INT = (SELECT OperatingHospital FROM ERS_PathwayPlanQuestions WHERE QuestionId = @QuestionId)
	
	IF @Direction = 'u'
	BEGIN
		IF @CurrentOrder > 1
		BEGIN	
			UPDATE ERS_PathwayPlanQuestions SET OrderById = OrderById + 1 WHERE OrderById = @CurrentOrder - 1 AND ProcedureType = @ProcedureType AND OperatingHospital = @OperatingHospital
			UPDATE ERS_PathwayPlanQuestions SET OrderById = @CurrentOrder - 1 WHERE QuestionId = @QuestionId
		END 
	END
	ELSE
	IF @Direction = 'd'
	BEGIN
		IF @CurrentOrder < (SELECT MAX(OrderById) FROM ERS_PathwayPlanQuestions WHERE ProcedureType = @ProcedureType AND OperatingHospital = @OperatingHospital AND Suppressed = 0)
		BEGIN
			--change the old one
			UPDATE ERS_PathwayPlanQuestions SET OrderById = OrderById -1 WHERE OrderById = @CurrentOrder+1 AND ProcedureType = @ProcedureType AND OperatingHospital = @OperatingHospital

			--change the current one
			UPDATE ERS_PathwayPlanQuestions SET OrderById = @CurrentOrder +1 WHERE QuestionId = @QuestionId
		END
	END
END

GO

EXEC dbo.DropIfExist 
    @ObjectName = 'pathway_plan_questions_suppress', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[pathway_plan_questions_suppress]
(
	@QuestionId int,
	@Suppress bit,
	@OperatingHospitalId INT
)
AS
SET NOCOUNT OFF;
BEGIN
	DECLARE @ProcedureType INT = (SELECT ProcedureType FROM ERS_PathwayPlanQuestions WHERE QuestionId = @QuestionId)
	IF @Suppress = 1
	BEGIN
		UPDATE ERS_PathwayPlanQuestions
		SET Suppressed = 1,
		OrderById = 9999
		WHERE QuestionId = @QuestionId
		
		--reorder the questions
		DECLARE @tbl TABLE (RowId int, QuestionId int, OrderById int)

		INSERT INTO @tbl 
		SELECT ROW_NUMBER() OVER (ORDER BY OrderById), QuestionId, OrderById
		FROM ERS_PathwayPlanQuestions WHERE ProcedureType = @ProcedureType AND OperatingHospital = @OperatingHospitalId AND Suppressed = 0 ORDER BY OrderById

		UPDATE p
		SET p.OrderById = t.RowId
		FROM ERS_PathwayPlanQuestions p
		INNER JOIN @tbl t ON t.OrderById = p.OrderById
		AND p.ProcedureType = @ProcedureType AND p.OperatingHospital = @OperatingHospitalId
	END
	ELSE IF @Suppress = 0
	BEGIN
		DECLARE @MaxCount Int
		SET @MaxCount = (SELECT COUNT(QuestionId) FROM ERS_PathwayPlanQuestions WHERE ProcedureType = @ProcedureType AND Suppressed = 0 AND OperatingHospital = @OperatingHospitalId)
		IF @MaxCount < 10
		BEGIN
			UPDATE ERS_PathwayPlanQuestions 
			SET Suppressed = 0, 
				OrderById = (SELECT ISNULL(MAX(OrderById), 0) + 1 FROM ERS_PathWayPlanQuestions WHERE ProcedureType = @ProcedureType AND OperatingHospital = @OperatingHospitalId AND Suppressed = 0)
			WHERE QuestionId = @QuestionId
		END
	END
END

GO 

EXEC dbo.DropIfExist 
    @ObjectName = 'pathway_plan_question_select', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[pathway_plan_question_select]
(
	@QuestionId int,
	@OperatingHospitalId int
)
AS
BEGIN
	SELECT  Question,
			Optional,
			CanFreeText,
			Mandatory,
			OrderById,
			ProcedureType
	FROM ERS_PathwayPlanQuestions
	WHERE QuestionId = @QuestionId
	AND OperatingHospital = @OperatingHospitalId
END
GO

EXEC dbo.DropIfExist 
    @ObjectName = 'procedure_pathway_plan_answers_select', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[procedure_pathway_plan_answers_select]
(
	@ProcedureId int
)
AS
BEGIN
	SELECT efuq.QuestionId, efuq.Question, OptionAnswer, FreeTextAnswer, Mandatory, EvidenceOfCancer
	FROM dbo.ERS_PathwayPlanQuestions efuq
		INNER JOIN ERS_ProcedurePathwayPlanAnswers epfuqa ON efuq.QuestionId = epfuqa.QuestionId
	WHERE ProcedureId = @ProcedureId
END

GO

EXEC dbo.DropIfExist 
    @ObjectName = 'procedure_pathway_plan_evidence_save', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[procedure_pathway_plan_evidence_save]
(
	@ProcedureId int,
	@EvidenceId int
)
AS
BEGIN
	DECLARE @QuestionId INT = (select QuestionId from ERS_PathwayPlanQuestions where Question='Evidence of cancer?')

	UPDATE ERS_ProcedurePathwayPlanAnswers 
	SET EvidenceOfCancer = CASE WHEN @EvidenceId <> 0 THEN @EvidenceId ELSE NULL END 
	WHERE ProcedureId = @ProcedureId AND QuestionId = @QuestionId;

	DECLARE @EvidenceText VARCHAR(200) = ''
	IF @EvidenceId <> 0
	BEGIN 
		SET @EvidenceText = (SELECT ListItemText FROM ers_lists WHERE ListId = @EvidenceId)
	END

	DECLARE @PathwayPlan varchar(max) = 
	(SELECT efuq.Question + ' ' + ISNULL(CASE OptionAnswer WHEN 1 THEN 'Yes' WHEN 0 THEN 'No' WHEN -1 THEN 'Unknown' END, '') + 
			CASE WHEN OptionAnswer IS NOT NULL AND NULLIF(FreeTextAnswer,'') IS NOT NULL THEN ', ' ELSE '' END 
	+ ISNULL(FreeTextAnswer, '') + ' ' + CASE WHEN efuq.Question IN ('Evidence of cancer?') AND @EvidenceText <> ''
	THEN '(' + @EvidenceText + ')' ELSE '' END + ' ** ' AS [text()]
	FROM dbo.ERS_PathwayPlanQuestions efuq
	INNER JOIN ERS_ProcedurePathwayPlanAnswers epfuqa ON efuq.QuestionId = epfuqa.QuestionId
	WHERE ProcedureId = @ProcedureId
	FOR XML PATH (''))

	UPDATE ERS_ProceduresReporting SET PP_PathwayPlan = REPLACE(@PathwayPlan, '**', '<br />') WHERE ProcedureId = @ProcedureId
END

GO

EXEC dbo.DropIfExist 
    @ObjectName = 'get_list_procedure', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[get_list_procedure]
    @ListDescription VARCHAR(200),
    @LoggedInUserId INT,
    @OrderByDesc BIT
AS
BEGIN
	SELECT lm.*, l.*, 
		CASE WHEN u.caneditdropdowns = 1 THEN lm.allowaddnewitem ELSE 0 END AS allowaddnewitemusersetting 
	FROM ers_lists l 
	LEFT JOIN ers_listsmain lm ON l.listdescription = lm.listdescription 
	CROSS JOIN ers_users u 
	WHERE lm.listdescription IN (@listDescription) 
		AND ISNULL(l.suppressed, 0) = 0 
		AND u.userid = @LoggedInUserId 
	ORDER BY 
		CASE WHEN ISNULL(@OrderByDesc, 0) = 0 THEN l.listitemno END ASC, 
		CASE WHEN ISNULL(@OrderByDesc, 0) = 1 THEN l.listitemtext END ASC
END

GO

EXEC dbo.DropIfExist 
    @ObjectName = 'auditPatientPathway', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[auditPatientPathway]
(
    @UserId INT
)
AS
BEGIN
    DECLARE @FromDate DATE,
            @ToDate DATE,
            @TrustId INT,
            @columns NVARCHAR(MAX) = '',
            @sql NVARCHAR(MAX) = '';

    SELECT @FromDate = FromDate,
           @ToDate = ToDate,
           @TrustId = TrustId
    FROM ERS_ReportFilter
    WHERE UserID = @UserId;

	CREATE TABLE #PatientData (
		[Patient Name] NVARCHAR(255),
		[Hospital Number] NVARCHAR(50),
		[Age] INT,
		[Endoscopist 1] NVARCHAR(255),
		[Endoscopist 2] NVARCHAR(255),
		[Procedure Type] NVARCHAR(255),
		[Indications] NVARCHAR(MAX),
		[Diagnoses] NVARCHAR(MAX),
		[Specimens Taken] NVARCHAR(MAX),
		[Comments] NVARCHAR(MAX),
		[Question] NVARCHAR(255),
		[Answer] NVARCHAR(255)
	);

	SELECT procedureid, Summary 
	INTO #tbl_specimens 
	FROM ERS_Sites es 
	JOIN ERS_UpperGISpecimens up ON es.SiteId = up.SiteId;

	SELECT t1.procedureid, 
		STUFF((SELECT ', ' + t2.summary 
			   FROM #tbl_specimens t2 
			   WHERE t2.procedureid = t1.procedureid 
			   FOR XML PATH('')), 1, 1, '') AS Summaries 
	INTO #tbl_specimens_summary 
	FROM #tbl_specimens t1 
	GROUP BY t1.procedureid

	INSERT INTO #PatientData ([Patient Name], [Hospital Number], [Age], [Endoscopist 1], [Endoscopist 2], [Procedure Type], [Indications], [Diagnoses], [Specimens Taken], [Comments], [Question], [Answer])
	SELECT 
		epat.Surname + ' ' + epat.Forename1 AS [Patient Name], 
		epat.HospitalNumber AS [Hospital Number],
		DATEDIFF(YEAR, epat.DateOfBirth, GETDATE()) - IIF(GETDATE() < DATEADD(YEAR, DATEDIFF(YEAR, epat.DateOfBirth, GETDATE()), epat.DateOfBirth), 1, 0) AS [Age],
		eu.Title + ' ' + eu.Forename + ' ' + eu.Surname AS [Endoscopist 1],
		eu2.Title + ' ' + eu2.Forename + ' ' + eu2.Surname AS [Endoscopist 2],
		ept.ProcedureType AS [Procedure Type],
		STUFF((SELECT ', ' + Description FROM ERS_Indications WHERE UniqueId IN (SELECT IndicationId FROM ERS_ProcedureIndications WHERE ProcedureId = eproc.ProcedureId) FOR XML PATH(''), TYPE).value('.', 'NVARCHAR(MAX)'), 1, 2, '')  AS [Indications],
		epr.PP_Diagnoses AS [Diagnoses],
		esum.Summaries AS [Specimens Taken],
		eugif.Comments AS [Comments],
		epq.Question AS [Question],
		CASE epa.OptionAnswer WHEN 1 THEN 'Yes' WHEN 0 THEN 'No' WHEN -1 THEN 'Unknown' ELSE '' END +
		CASE WHEN ISNULL(epa.FreeTextAnswer, '') = '' OR epa.OptionAnswer IS NULL THEN '' ELSE ', ' END +
		ISNULL(epa.FreeTextAnswer, '')
		AS [Answer]

	FROM ERS_Procedures eproc
	JOIN ERS_Patients epat ON epat.PatientId = eproc.PatientId
	JOIN ERS_Users eu ON eu.UserID = eproc.Endoscopist1
	LEFT JOIN ERS_Users eu2 ON eu2.UserID = eproc.Endoscopist2
	JOIN ERS_ProcedureTypes ept ON ept.ProcedureTypeId = eproc.ProcedureType
	LEFT JOIN ERS_ProceduresReporting epr ON epr.ProcedureId = eproc.ProcedureId
	LEFT JOIN #tbl_specimens_summary esum ON esum.ProcedureId = eproc.ProcedureId
	LEFT JOIN ERS_UpperGIFollowUp eugif ON eugif.ProcedureId = eproc.ProcedureId
	LEFT JOIN ERS_ProcedurePathwayPlanAnswers epa ON epa.ProcedureId = eproc.ProcedureId
	LEFT JOIN ERS_PathwayPlanQuestions epq ON epq.QuestionId = epa.QuestionId
	JOIN ERS_ReportConsultants erc ON eu.UserID = erc.ConsultantID
	WHERE eproc.CreatedOn >= @FromDate AND eproc.CreatedOn <= @ToDate
	AND erc.UserID = @UserId
	ORDER BY eproc.CreatedOn

	SELECT @columns = STUFF((
		SELECT DISTINCT ', ' + QUOTENAME(Question)
		FROM #PatientData
		FOR XML PATH(''), TYPE
	).value('.', 'NVARCHAR(MAX)'), 1, 2, '');

	SET @sql = '
	SELECT [Patient Name], [Hospital Number], [Age], [Endoscopist 1], [Endoscopist 2], [Procedure Type], [Indications], [Diagnoses], [Specimens Taken], [Comments], ' + @columns + '
	FROM (
		SELECT 
			[Patient Name], 
			[Hospital Number], 
			[Age], 
			[Endoscopist 1], 
			[Endoscopist 2], 
			[Procedure Type], 
			[Indications], 
			[Diagnoses], 
			[Specimens Taken], 
			[Comments], 
			[Question], 
			[Answer]
		FROM #PatientData
	) AS SourceTable
	PIVOT (
		MAX([Answer]) 
		FOR [Question] IN (' + @columns + ')
	) AS PivotTable;
	';

	EXEC sp_executesql @sql;

	DROP TABLE #tbl_specimens;
	DROP TABLE #tbl_specimens_summary;
	DROP TABLE #PatientData;
END

GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	3909 Ended
------------------------------------------------------------------------------------------------------------------------
GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	During Testing we notice There are only 10 Characters in OperatingHospitalList field 
--           But tester is testing report with 10 Hospital so added that field 
------------------------------------------------------------------------------------------------------------------------

alter table dbo.ERS_ReportFilter
alter column OperatingHospitalList varchar(100)
------------------------------------------------------------------------------------------------------------------------
-- TFS#	3909 Ended
------------------------------------------------------------------------------------------------------------------------
GO
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	MOSTAFIZUR RAHMAN
-- TFS#	4069
-- Description of change
-- Lession section improvement 
------------------------------------------------------------------------------------------------------------------------
GO 
IF NOT EXISTS (
    SELECT 1
    FROM INFORMATION_SCHEMA.COLUMNS
    WHERE TABLE_NAME = 'ERS_CommonAbnoPolypDetails'
    AND COLUMN_NAME IN ('SubmucosalLargest','SubmucosalQuantity','FocalQuantity','FocalLargest','FundicGlandPolypQuantity','FundicGlandPolypLargest','Discarded')
)
BEGIN
    
   ALTER TABLE ERS_CommonAbnoPolypDetails
    ADD SubmucosalQuantity INT NULL,
        SubmucosalLargest INT NULL,
        FocalQuantity INT NULL,
        FocalLargest INT NULL,
        FundicGlandPolypQuantity INT NULL,
        FundicGlandPolypLargest DECIMAL(18, 6) NULL,
        Discarded BIT NULL;
END


GO

EXEC dbo.DropIfExist 
    @ObjectName = 'abnormalities_common_polyp_details_save', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[abnormalities_common_polyp_details_save]
(
		@SiteId int,
		@Size int,
		@Excised bit,
		@Retreived BIT,
		@Discarded BIT,--newly added for 4069
		@Successful bit,
		@Labs bit,
		@Removal int,
		@RemovalMethod int,
		@Probably bit,
		@TumorTypeId int,
		@ParisClass int,
		@PitPattern int, 
		@Infammatory bit,
		@PostInflammatory bit,
		@TattooedId int,
		@TattooMarkingTypeId int,
		@PolypConditionIds varchar(500),
		@PolypTypeId int,
		@TattooLocationDistal bit,
		@TattooLocationProximal bit,
		@SubmucosalQuantity int, --newly added for 4069
		@SubmucosalLargest int, 
		@FocalQuantity int,
		@FocalLargest int,
		@FundicGlandPolypQuantity int,
		@FundicGlandPolypLargest decimal(18,6), --newly added for 4069
		@LoggedInUserId int
)
AS

BEGIN TRANSACTION

BEGIN TRY
	DECLARE @PolypDetailsId int
	
	INSERT INTO ERS_CommonAbnoPolypDetails (
		SiteId,
		Size,
		Excised,
		Retreived,
		Discarded, --newly added for 4069
		Successful,
		Labs,
		Removal,
		RemovalMethod,
		Probably,
		Type,
		ParisClass,
		PitPattern, 
		Infammatory,
		PostInflammatory,
		TattooedId,
		TattooedMarkingTypeId,
		PolypTypeId,
		TattooLocationDistal,
		TattooLocationProximal,
		SubmucosalQuantity, --newly added for 4069
		SubmucosalLargest, 
		FocalQuantity,
		FocalLargest,
		FundicGlandPolypQuantity,
		FundicGlandPolypLargest ) --newly added for 4069
	VALUES(
		@SiteId,
		@Size,
		@Excised,
		@Retreived,
		@Discarded, --newly added for 4069
		@Successful,
		@Labs,
		@Removal,
		@RemovalMethod,
		@Probably,
		@TumorTypeId,
		@ParisClass,
		@PitPattern, 
		@Infammatory,
		@PostInflammatory,
		@TattooedId,
		@TattooMarkingTypeId,
		@PolypTypeId,
		@TattooLocationDistal,
		@TattooLocationProximal, 
		@SubmucosalQuantity, --newly added for 4069
		@SubmucosalLargest, 
		@FocalQuantity,
		@FocalLargest,
		@FundicGlandPolypQuantity,
		@FundicGlandPolypLargest) --newly added for 4069

	SELECT @PolypDetailsId = Scope_Identity()

	DELETE FROM ERS_CommonAbnoPolypConditions WHERE PolypDetailId = @PolypDetailsId

	INSERT INTO ERS_CommonAbnoPolypConditions (PolypDetailId, PolypConditionId)
	SELECT @PolypDetailsId, Item FROM fnSplitString(@PolypConditionIds,',')

	--summary
	UPDATE ERS_CommonAbnoPolypDetails SET Summary =REPLACE(dbo.common_polpydetails_summary(@SiteId, @PolypDetailsId),'#','' ) WHERE PolypDetailId = @PolypDetailsId --newly added for 4069

END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;

GO
EXEC dbo.DropIfExist 
    @ObjectName = 'abnormalities_common_polyp_details_update', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[abnormalities_common_polyp_details_update] --newly added for 4069
(
    @PolypDetailId INT,
    @SiteId INT,
    @Size INT,
    @Excised BIT,
    @Retreived Bit,
	@Discarded bit,
    @Successful BIT,
    @Labs BIT,
    @Removal INT,
    @RemovalMethod INT,
    @Probably bit,
    @Type INT,
    @ParisClass INT,
    @PitPattern INT,
    @Infammatory BIT,
    @PostInflammatory BIT,
	@PolypConditionIds varchar(500),--new added
    @TattooedId INT,
    @TattooMarkingTypeId INT,
    @TattooLocationDistal BIT,
    @TattooLocationProximal BIT,
    @SubmucosalQuantity INT,
    @SubmucosalLargest INT,
    @FocalQuantity INT,
    @FocalLargest INT,
    @FundicGlandPolypQuantity INT,
    @FundicGlandPolypLargest  decimal(18,6),
    @PolypTypeId INT
)
AS
BEGIN
    UPDATE ERS_CommonAbnoPolypDetails
    SET
        Size = @Size,
        Excised = @Excised,
        Retreived = @Retreived,
		Discarded=@Discarded,
        Successful = @Successful,
        Labs = @Labs,
        Removal = @Removal,
        RemovalMethod = @RemovalMethod,
        Probably = @Probably,
        Type = @Type,
        ParisClass = @ParisClass,
        PitPattern = @PitPattern,
        Infammatory = @Infammatory,
        PostInflammatory = @PostInflammatory,
        TattooedId = @TattooedId,
        TattooedMarkingTypeId = @TattooMarkingTypeId,
        TattooLocationDistal = @TattooLocationDistal,
        TattooLocationProximal = @TattooLocationProximal,
        SubmucosalQuantity = @SubmucosalQuantity,
        SubmucosalLargest = @SubmucosalLargest,
        FocalQuantity = @FocalQuantity,
        FocalLargest = @FocalLargest,
        FundicGlandPolypQuantity = @FundicGlandPolypQuantity,
        FundicGlandPolypLargest = @FundicGlandPolypLargest,
        PolypTypeId = @PolypTypeId
    WHERE PolypDetailId = @PolypDetailId AND SiteId = @SiteId

	--new added 
	DELETE FROM ERS_CommonAbnoPolypConditions WHERE PolypDetailId = @PolypDetailId

	INSERT INTO ERS_CommonAbnoPolypConditions (PolypDetailId, PolypConditionId)
	SELECT @PolypDetailId, Item FROM fnSplitString(@PolypConditionIds,',')

	--summary
	UPDATE ERS_CommonAbnoPolypDetails SET Summary = REPLACE(dbo.common_polpydetails_summary(@SiteId, @PolypDetailId),'#','' )  WHERE PolypDetailId = @PolypDetailId
	--new added 
END


GO
EXEC dbo.DropIfExist 
    @ObjectName = 'abnormalities_common_polyp_details_select', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[abnormalities_common_polyp_details_select]
(
	@SiteId INT
)
AS
BEGIN
	SELECT 
		PolypDetailId,
		PolypType=isnull(t.Description ,''),
		d.SiteId,
		Size,
		Excised,
		Retrieved=isnull(Retreived,0), --newly added for 4069
		Discarded=isnull(Discarded,0), --newly added for 4069
		Successful,
		Labs,
		Removal,
		RemovalDescription=isnull(Pm.Description,''),
		RemovalMethod,
		RemovalMethodDescription=isnull(Pt.Description,''),
		Probably,
		Type,
		TypeDescription=isnull(Tu.Description,''),
		ParisClass,
		PitPattern, 
		Infammatory,
		PostInflammatory,
		TattooedId,
		TattooedMarkingTypeId,
		TattooedMarkingTypeDescription=isnull(TM.description,''),
		TattooLocationDistal,
		TattooLocationProximal,
		TattoDescription=iif(Size>20 and TattooedId>0,'' +iif(lower(Ta.Description)='no','',iif(lower(Ta.Description)='yes','Tattooed','')),''),
		SubmucosalQuantity, --newly added for 4069
		SubmucosalLargest, 
		FocalQuantity,
		FocalLargest,
		FundicGlandPolypQuantity,
		FundicGlandPolypLargest, --newly added for 4069
		PolypTypeId,

		--newly added for 4069
		(SELECT STUFF((SELECT ',' + convert(varchar(10), c.PolypConditionId) as [text()] FROM ERS_CommonAbnoPolypConditions c WHERE c.PolypDetailId = d.PolypDetailId FOR XML PATH('')),1,1,'')) as PolypConditionIds
	FROM ERS_CommonAbnoPolypDetails d
		left JOIN ERS_PolypTypes t on  d.PolypTypeId=t.UniqueId 
		left join ERS_TumourTypes Tu on d.type=Tu.uniqueid
		left join ERS_PolypRemovalMethods Pm on d.removal=Pm.UniqueId
		left join ERS_PolypRemovalTypes Pt on d.RemovalMethod=Pt.UniqueId
		left join ERS_TattooOptions Ta on d.TattooedId=Ta.UniqueId
		left join ERS_MarkingTypes TM ON d.TattooedMarkingTypeId =TM.UniqueId
	WHERE d.SiteId = @SiteId
	--newly added for 4069
END


GO
EXEC dbo.DropIfExist 
    @ObjectName = 'sites_summary_update', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[sites_summary_update]
(
	@SiteId INT,
	@RefreshReport BIT = 1
)
AS
/*
-- Update History:
-- 10 Nov 2023		MH		replaced table reference ERS_ColonAbnoLesions with ERS_CommonAbnoLesions	TFS #3556
-- 15 Nov 2023		MH/Andrea		after finding the sp could updated from older version - the script has been taken from release 2_23_05_03 and then added some required refreshsummary works done by Steve, Polyp details are fixed here for Colon,Gastro etc
--							
*/
SET NOCOUNT ON

DECLARE @TrustId int
SELECT @TrustId = oh.TrustId
FROM ERS_Procedures p
JOIN ERS_Sites s ON s.ProcedureId = p.ProcedureId AND s.SiteId = @SiteId
JOIN ERS_OperatingHospitals oh ON oh.OperatingHospitalId = p.OperatingHospitalID

DECLARE @ReportSummaryRefresh int
SELECT @ReportSummaryRefresh = CAST([dbo].[fn_ShouldRefreshSummary](@TrustId) AS INT)

IF (@ReportSummaryRefresh + CAST(@RefreshReport AS INT) > 0)
BEGIN
	DECLARE @summaryAbnormalities VARCHAR(MAX)
			,@summarySpecimens VARCHAR(MAX)
			,@summaryTherapeutics VARCHAR(MAX)
			,@summaryWhole VARCHAR(MAX)
			,@summaryAbnormalitiesWithHyperLinks VARCHAR(MAX)
			,@summarySpecimensWithHyperLinks VARCHAR(MAX)
			,@summaryTherapeuticsWithHyperLinks VARCHAR(MAX)
			,@procType INT
			,@procId INT
			,@none TINYINT
			,@region VARCHAR(500)
			,@htmlAnchorCode VARCHAR(500)
			,@siteIdStr VARCHAR(15)
			,@indent VARCHAR(15) 
			,@br VARCHAR(10)
			,@opDiv VARCHAR(150)
			,@clDiv VARCHAR(50)
			,@opBold VARCHAR(5)
			,@clBold VARCHAR(5)
			,@fullStop VARCHAR(1)
			,@colon VARCHAR(2)
			,@fldNone VARCHAR(20)
			,@emptyStr VARCHAR(1)
			,@abnoTheraPresent BIT = 0
			,@tmpSummaryAbno VARCHAR(MAX)
			,@tmpSummaryAbnoLinks VARCHAR(MAX)
			,@SiteNo INT
			,@regionID INT
			,@AreaNo INT
			,@AbnormalProcedure BIT = 0


	BEGIN TRANSACTION

	BEGIN TRY

		SET	@summaryAbnormalities = ''
		SET	@summarySpecimens = ''
		SET	@summaryTherapeutics = ''
		SET	@summaryAbnormalitiesWithHyperLinks = ''
		SET	@summarySpecimensWithHyperLinks = ''
		SET	@summaryTherapeuticsWithHyperLinks = ''
		SET @siteIdStr = CONVERT(VARCHAR(10),@SiteId)
		SET @AbnormalProcedure = 0

		DECLARE @IsLymphNode VARCHAR(10) = 'False'

		SELECT @procId = p.ProcedureId,@procType = p.ProcedureType, @regionID = s.RegionId, @SiteNo = s.SiteNo, @AreaNo = ISNULL(AreaNo,0),
				@region = CASE WHEN s.SiteNo = -77 THEN						--SiteNo is set to -77 for sites By Distance (Col & Sig only)
							CONVERT(VARCHAR,XCoordinate) +  
								CASE WHEN YCoordinate IS NULL OR YCoordinate=0 THEN ' cm' 
								ELSE (' to ' + CONVERT(VARCHAR,YCoordinate) + ' cm' ) 
								END
						ELSE (SELECT r.Region FROM ERS_Regions r WHERE r.RegionId = s.RegionId)
						END
				,@IsLymphNode = CASE WHEN s.IsLymphNode = 1 THEN 'True' ELSE 'False' END
		FROM ERS_Sites s
		JOIN ERS_Procedures p ON s.ProcedureId = p.ProcedureId
		--JOIN ERS_Regions r ON s.RegionId = r.RegionId
		WHERE SiteId = @SiteId
		--SELECT @region = Region FROM ERS_Regions WHERE RegionId = @regionID

		SET @htmlAnchorCode = '<a href="#" class="sitesummary" onclick="OpenSiteDetails(''''' + @region + ''''',' + @siteIdStr + ',''''{0}'''',''''' + CONVERT(VARCHAR,@AreaNo) + ''''');">{1}</a>'
		--{0} is the name of the menu and {1} is the summary text

	
		DECLARE @SQLString NVARCHAR(MAX), @QryString NVARCHAR(MAX), @AbnoCheck BIT
		DECLARE @ProcedureType INT, @TableName VARCHAR(50), @AbnoNodeName VARCHAR(50), @Identifier VARCHAR(50)

		CREATE TABLE #QueryDetails (ProcType INT, TableName VARCHAR(50), AbnoNodeName VARCHAR(50), Identifier VARCHAR(50));

		--Notes to appear on the report just after the Site X heading, before the abnormalities.
		INSERT INTO #QueryDetails SELECT @procType,	'ERS_Sites',		'',		'Additional notes'
		IF @procType IN (1,6) --Gastroscopy / EUS(OGD)
		BEGIN
			INSERT INTO #QueryDetails VALUES 
			(@procType,	'ERS_CommonAbnoAtrophic',			'Atrophic duodenum','Atrophic Duodenum')
			,(@procType,	'ERS_UpperGIAbnoAchalasia',		'Achalasia',		'Achalasia')
			,(@procType,	'ERS_UpperGIAbnoBarrett',		'',					'Barretts Epithelium')
			,(@procType,	'ERS_UpperGIAbnoDeformity',		'Deformity',		'Deformity')
			,(@procType,	'ERS_CommonAbnoDiverticulum',	'Diverticulum',		'Diverticulum/Other')
			,(@procType,	'ERS_CommonAbnoDuodenalUlcer',	'',					CASE WHEN @region = 'Jejunum' THEN 'Jejunal Ulcer' WHEN @region = 'Ileum' THEN 'Ileal Ulcer' ELSE 'Duodenal Ulcer' END)
			,(@procType,	'ERS_CommonAbnoDuodenitis',		'',					CASE WHEN @region = 'Jejunum' THEN 'Jejunitis' WHEN @region = 'Ileum' THEN 'Ileitis' ELSE 'Duodenitis' END)
			,(@procType,	'ERS_UpperGIAbnoGastricUlcer',	'Gastric ulcer',	'Gastric Ulcer')
			,(@procType,	'ERS_UpperGIAbnoGastritis',		'Gastritis',		'Gastritis')
			,(@procType,	'ERS_UpperGIAbnoHiatusHernia',	'Hiatus hernia',	'Hiatus Hernia')
			,(@procType,	'ERS_UpperGIAbnoLumen',			'Lumen',			'Lumen')
			,(@procType,	'ERS_UpperGIAbnoMalignancy',	'Malignancy',		'Malignancy')
			,(@procType,	'ERS_UpperGIAbnoMiscellaneous',	'',					'Miscellaneous')
			,(@procType,	'ERS_UpperGIAbnoOesophagitis',	'Oesophagitis',		'Oesophagitis')
			,(@procType,	'ERS_CommonAbnoLesions',		'Lesions',			'Lesions')
			,(@procType,	'ERS_CommonAbnoPolypDetails',		'Polyp',			'Lesions')--ERS_CommonAbnoPolypDetails --newly added for 4069
			,(@procType,	'ERS_UpperGIAbnoPostSurgery',	'Post surgery',		'Post Surgery')
			,(@procType,	'ERS_CommonAbnoScaring',		'',					'Scarring/Stenosis')
			,(@procType,	'ERS_CommonAbnoTumour',			'',					'Tumour')
			,(@procType,	'ERS_UpperGIAbnoVarices',		CASE WHEN (Select isnull(Quantity, 0) from ERS_UpperGIAbnoVarices where SiteId = @SiteId) = 1 then 'Varix' ELSE 'Varices' END ,			'Varices')
			,(@procType,	'ERS_CommonAbnoVascularLesions','Vascular lesions',	'Vascular Lesions')
			,(@procType,	'ERS_EUSAbnoMediastinal',		'Mediastinal',		'Mediastinal')
			,(@procType,	'ERS_UpperGITherapeutics',		'Therapeutic procedure(s)',	'Therapeutic Procedures')
			,(@procType,	'ERS_UpperGISpecimens',			'Specimens taken',	'Specimens Taken')
		END
		ELSE IF @procType IN (2,7) --ERCP / / EUS(HPB)
		BEGIN
			INSERT INTO #QueryDetails VALUES 
			(@procType,		'ERS_ERCPAbnoAppearance',		'Appearance',		'Appearance')
			,(@procType,	'ERS_CommonAbnoAtrophic',		'Atrophic duodenum','Atrophic Duodenum')
			,(@procType,	'ERS_CommonAbnoDiverticulum',	'Diverticulum',		'Diverticulum/Other')
			,(@procType,	'ERS_ERCPAbnoDiverticulum',		'Diverticulum',		CASE WHEN @region IN ('Major Papilla', 'Minor Papilla') THEN 'Diverticulum' ELSE 'Diverticulum/Other' END)
			,(@procType,	'ERS_ERCPAbnoDuct',				'Duct',				CASE WHEN @region = 'Gall Bladder' THEN 'Gall Bladder' ELSE 'Duct' END)
			,(@procType,	'ERS_CommonAbnoDuodenalUlcer',	'',					CASE WHEN @region = 'Jejunum' THEN 'Jejunal Ulcer' WHEN @region = 'Ileum' THEN 'Ileal Ulcer' ELSE 'Duodenal Ulcer' END)
			,(@procType,	'ERS_CommonAbnoDuodenitis',		'',					CASE WHEN @region = 'Jejunum' THEN 'Jejunitis' WHEN @region = 'Ileum' THEN 'Ileitis' ELSE 'Duodenitis' END)
			,(@procType,	'ERS_ERCPAbnoParenchyma',		'Parenchyma',		'Parenchyma')
			,(@procType,	'ERS_CommonAbnoScaring',		'',					'Scarring/Stenosis')
			,(@procType,	'ERS_UpperGIAbnoMiscellaneous',	'',					'Miscellaneous')
			,(@procType,	'ERS_CommonAbnoTumour',			'',					'Tumour')
			,(@procType,	'ERS_ERCPAbnoTumour',			'Tumour',			'Tumour')
			,(@procType,	'ERS_ERCPAbnoIntrahepatic',		'Intrahepatic',		'Intrahepatic')
			,(@procType,	'ERS_CommonAbnoVascularLesions','Vascular lesions',	'Vascular Lesions')
			,(@procType,	'ERS_EUSAbnoMediastinal',		'Mediastinal',		'Mediastinal')
			,(@procType,	'ERS_CommonAbnoLesions',		'Lesions',			'Lesions')
			,(@procType,	'ERS_CommonAbnoPolypDetails',		'Polyp',			'Lesions')--ERS_CommonAbnoPolypDetails --newly added for 4069
			,(@procType,	'ERS_UpperGIAbnoVarices',		CASE WHEN (Select isnull(Quantity, 0) from ERS_UpperGIAbnoVarices where SiteId = @SiteId) = 1 then 'Varix' ELSE 'Varices' END ,			'Varices')
			,(@procType,	'ERS_ERCPTherapeutics',			'Therapeutic procedure(s)',	'Therapeutic Procedures')
			,(@procType,	'ERS_UpperGISpecimens',			'Specimens taken',	'Specimens Taken')
		END
		ELSE IF @procType IN (3,4,5) --Colon/Sigmo/Procto
		BEGIN
			INSERT INTO #QueryDetails VALUES
			(@procType,		'ERS_ColonAbnoCalibre',			'Calibre',			'Calibre')
			,(@procType,	'ERS_ColonAbnoDiverticulum',	'Diverticulum',		'Diverticulum')
			,(@procType,	'ERS_ColonAbnoHaemorrhage',		'Haemorrhage',		'Haemorrhage')
			,(@procType,	'ERS_CommonAbnoLesions',			'Lesions',			'Lesions')
			,(@procType,	'ERS_CommonAbnoPolypDetails',		'Polyp',			'Lesions')--ERS_CommonAbnoPolypDetails --newly added for 4069
			,(@procType,	'ERS_ColonAbnoTumour',			'Tumour',			'Tumour')
			,(@procType,	'ERS_ColonAbnoMiscellaneous',	'',					'Miscellaneous')
			,(@procType,	'ERS_ColonAbnoMucosa',			'Mucosa & Colitides',			'Mucosa')
			,(@procType,	'ERS_ColonAbnoperianallesions',	'Perianal lesions',	'Perianal Lesions')
			,(@procType,	'ERS_ColonAbnoVascularity',		'Vascularity',		'Vascularity')
			,(@procType,	'ERS_UpperGIAbnoVarices',		CASE WHEN (Select isnull(Quantity, 0) from ERS_UpperGIAbnoVarices where SiteId = @SiteId) = 1 then 'Varix' ELSE 'Varices' END ,			'Varices')
			,(@procType,	'ERS_UpperGITherapeutics',		'Therapeutic procedure(s)',	'Therapeutic Procedures')
			,(@procType,	'ERS_UpperGISpecimens',			'Specimens taken',	'Specimens Taken')
		END
		ELSE IF @procType IN (8) --Antegrade
		BEGIN
			INSERT INTO #QueryDetails VALUES 
			(@procType,		'ERS_UpperGIAbnoAchalasia',		'Achalasia',		'Achalasia')
			,(@procType,	'ERS_UpperGIAbnoBarrett',		'',					'Barretts Epithelium')
			,(@procType,	'ERS_UpperGIAbnoDeformity',		'Deformity',		'Deformity')
			,(@procType,	'ERS_CommonAbnoAtrophic',		'Atrophic duodenum','Atrophic Duodenum')
			,(@procType,	'ERS_CommonAbnoDiverticulum',	'Diverticulum',		'Diverticulum/Other')
			,(@procType,	'ERS_ColonAbnoDiverticulum',	'Diverticulum',		'Diverticulum')
			,(@procType,	'ERS_CommonAbnoDuodenalUlcer',	'',					CASE WHEN @region = 'Jejunum' THEN 'Jejunal Ulcer' WHEN @region = 'Ileum' THEN 'Ileal Ulcer' ELSE 'Duodenal Ulcer' END)
			,(@procType,	'ERS_CommonAbnoDuodenitis',		'',					CASE WHEN @region = 'Jejunum' THEN 'Jejunitis' WHEN @region = 'Ileum' THEN 'Ileitis' ELSE 'Duodenitis' END)
			,(@procType,	'ERS_ColonAbnoLesions',			'Lesions',			'Lesions')
			,(@procType,	'ERS_CommonAbnoScaring',		'',					'Scarring/Stenosis')
			,(@procType,	'ERS_CommonAbnoTumour',			'',					'Tumour')
			,(@procType,	'ERS_CommonAbnoVascularLesions','Vascular lesions',	'Vascular Lesions')
			,(@procType,	'ERS_UpperGIAbnoGastricUlcer',	'Gastric ulcer',	'Gastric Ulcer')
			,(@procType,	'ERS_UpperGIAbnoGastritis',		'Gastritis',		'Gastritis')
			,(@procType,	'ERS_UpperGIAbnoHiatusHernia',	'Hiatus hernia',	'Hiatus Hernia')
			,(@procType,	'ERS_UpperGIAbnoLumen',			'Lumen',			'Lumen')
			,(@procType,	'ERS_UpperGIAbnoMalignancy',	'Malignancy',		'Malignancy')
			,(@procType,	'ERS_UpperGIAbnoMiscellaneous',	'',					'Miscellaneous')
			,(@procType,	'ERS_UpperGIAbnoOesophagitis',	'Oesophagitis',		'Oesophagitis')
			,(@procType,	'ERS_UpperGIAbnoPostSurgery',	'Post surgery',		'Post Surgery')
			,(@procType,	'ERS_CommonAbnoLesions',		'Lesions',			'Lesions')			
			,(@procType,	'ERS_CommonAbnoPolypDetails',		'Polyp',			'Lesions')--ERS_CommonAbnoPolypDetails --newly added for 4069
			,(@procType,	'ERS_UpperGIAbnoVarices',		CASE WHEN (Select isnull(Quantity, 0) from ERS_UpperGIAbnoVarices where SiteId = @SiteId) = 1 then 'Varix' ELSE 'Varices' END ,			'Varices')
			,(@procType,	'ERS_UpperGITherapeutics',		'Therapeutic procedure(s)',	'Therapeutic Procedures')
			,(@procType,	'ERS_UpperGISpecimens',			'Specimens taken',	'Specimens Taken')
		END
		ELSE IF @procType IN (9) --Retrograde
		BEGIN
			INSERT INTO #QueryDetails VALUES
			(@procType,		'ERS_ColonAbnoCalibre',			'Calibre',			'Calibre')
			,(@procType,	'ERS_ColonAbnoDiverticulum',	'Diverticulum',		'Diverticulum')
			,(@procType,	'ERS_ColonAbnoHaemorrhage',		'Haemorrhage',		'Haemorrhage')
			,(@procType,	'ERS_CommonAbnoLesions',			'Lesions',			'Lesions')	
			,(@procType,	'ERS_CommonAbnoPolypDetails',		'Polyp',			'Lesions')--ERS_CommonAbnoPolypDetails --newly added for 4069
			,(@procType,	'ERS_ColonAbnoTumour',			'Tumour',			'Tumour')
			,(@procType,	'ERS_ColonAbnoMiscellaneous',	'',					'Miscellaneous')
			,(@procType,	'ERS_ColonAbnoMucosa',			'Mucosa & Colitides',			'Mucosa')
			,(@procType,	'ERS_ColonAbnoperianallesions',	'Perianal lesions',	'Perianal Lesions')
			,(@procType,	'ERS_ColonAbnoVascularity',		'Vascularity',		'Vascularity')
			,(@procType,	'ERS_CommonAbnoDuodenalUlcer',	'',					CASE WHEN @region = 'Jejunum' THEN 'Jejunal Ulcer' WHEN @region = 'Ileum' THEN 'Ileal Ulcer' ELSE 'Duodenal Ulcer' END)
			,(@procType,	'ERS_CommonAbnoDuodenitis',		'',					CASE WHEN @region = 'Jejunum' THEN 'Jejunitis' WHEN @region = 'Ileum' THEN 'Ileitis' ELSE 'Duodenitis' END)
			,(@procType,	'ERS_CommonAbnoScaring',		'',					'Scarring/Stenosis')
			,(@procType,	'ERS_UpperGIAbnoVarices',		CASE WHEN (Select isnull(Quantity, 0) from ERS_UpperGIAbnoVarices where SiteId = @SiteId) = 1 then 'Varix' ELSE 'Varices' END ,			'Varices')
			,(@procType,	'ERS_UpperGITherapeutics',			'Therapeutic procedure(s)',	'Therapeutic Procedures')
			,(@procType,	'ERS_UpperGISpecimens',			'Specimens taken',	'Specimens Taken')
		END
		ELSE IF @procType IN (13) --Cystoscopy
		BEGIN
			INSERT INTO #QueryDetails VALUES
			(@procType,		'ERS_CystoscopyAbnoBladder',	'Bladder',			'Bladder')
			,(@procType,	'ERS_CystoscopyAbnoProstate',	'Prostate',		    'Prostate')
			,(@procType,	'ERS_CystoscopyAbnoUrethra',	'Urethra',		    'Urethra')
			,(@procType,	'ERS_CystoscopyTherapeutics',	'Therapeutic procedure(s)',	'Therapeutic Procedures')
			,(@procType,	'ERS_CystoscopySpecimens',		'Specimens taken',	'Specimens Taken')
		END
		ELSE IF @procType IN (10,12) --Bronchoscopy, Thoracoscopy
		BEGIN
			INSERT INTO #QueryDetails
			VALUES (
				@procType
				,'ERS_BRTSpecimens'
				,'Specimens taken'
				,'Specimens Taken'
				),
				(
				@procType
				,'ERS_UpperGITherapeutics'
				,'Therapeutic procedure(s)'
				,'Therapeutic Procedures'
				),
				(
				@procType
				,'ERS_BRTAbnoDescriptions'
				,'<strong>Abnormalities</strong>'			
				,''
				)

		END	
		ELSE IF @procType IN (
				11
				) --EBUS			
				BEGIN
					INSERT INTO #QueryDetails
					VALUES (
						@procType
						,'ERS_BRTSpecimens'
						,'Specimens taken'
						,'Specimens Taken'
						),
						(
						@procType
						,'ERS_UpperGITherapeutics'
						,'Therapeutic procedure(s)'
						,'Therapeutic Procedures'
						)
			
					IF @IsLymphNode = 'True'
					BEGIN
						INSERT INTO #QueryDetails
						VALUES 
							(
							@procType
							,'ERS_EBUSAbnoDescriptions'
							,'<strong>Abnormalities</strong>'
							,'EBUS Abnormality Descriptions'
							)
					END
					ELSE
					BEGIN
						INSERT INTO #QueryDetails
						VALUES 
							(
							@procType
							,'ERS_BRTAbnoDescriptions'
							,'<strong>Abnormalities</strong>'
							,''
							)
					END
				END


		DECLARE qry_cursor CURSOR FOR 
		SELECT ProcType, TableName, AbnoNodeName, Identifier FROM #QueryDetails

		OPEN qry_cursor 
		FETCH NEXT FROM qry_cursor INTO @ProcType, @TableName, @AbnoNodeName, @Identifier

		WHILE @@FETCH_STATUS = 0
		BEGIN
			SET @summaryWhole = ''
			SET @none = NULL
			SET @opDiv = '''<table><tr><td style="padding-left:25px;padding-right:50px; font-size:12px;"><span>'' + ' 
			SET @clDiv = ' + ''</span></td></tr></table>'''
			SET @indent = '&nbsp;- ';		SET @br = '<br />'
			SET @opBold = '<b>';			SET @clBold = '</b>'
			SET @fullStop = '.';			SET @colon = ': '
			SET @fldNone = 'None';			SET @emptyStr = ''
		
			IF @TableName = 'ERS_UpperGIAbnoLumen' SET @fldNone = 'NoBlood'
			ELSE IF @TableName = 'ERS_ERCPAbnoIntrahepatic' SET @fldNone = 'NormalIntraheptic'
			ELSE IF @TableName IN ('ERS_ERCPAbnoDuct', 'ERS_ERCPAbnoParenchyma', 'ERS_ERCPAbnoAppearance', 'ERS_ERCPAbnoDiverticulum','ERS_CystoscopyAbnoBladder','ERS_CystoscopyAbnoProstate','ERS_CystoscopyAbnoUrethra','ERS_EBUSAbnoDescriptions') SET @fldNone = 'Normal'
			ELSE SET @fldNone = 'None'
			--Get Summary from respective table
			IF @TableName = 'ERS_Sites'
				BEGIN
					SET @SQLString = 'SELECT @summaryWhole = AdditionalNotes FROM ' + @TableName + '  
								WHERE SiteId =  ' + CONVERT(VARCHAR,@SiteId) + ' AND ISNULL(AdditionalNotes,'''') <> '''' '
					SET @fullStop = @emptyStr
				END
			else if @TableName = 'ERS_CommonAbnoPolypDetails'  --newly added for 4069
				begin
					SET @SQLString='
                 SELECT @summaryWhole=(SELECT '+CHAR(13)+' t2.summary
                                             FROM '+@TableName+' t2
                                             WHERE t2.SiteId = t1.SiteId
                                             FOR XML PATH(''''), TYPE).value(''.'', ''NVARCHAR(MAX)''), 
                        @none = 0 
                 FROM '+@TableName+' t1 
                 where t1.SiteId='+CONVERT(VARCHAR,@SiteId)+' 
                 group by t1.SiteId; 
                 '

					--SET @SQLString = 'SELECT @summaryWhole = Summary, @none = 0 FROM ' + @TableName + '  
					--			WHERE SiteId =  ' + CONVERT(VARCHAR,@SiteId) + ' AND ISNULL(Summary,'''') <> '''' '
				end --newly added for 4069
			ELSE
				BEGIN
					SET @SQLString = 'SELECT @summaryWhole = Summary, @none = [' + @fldNone + '] FROM ' + @TableName + '  
								WHERE SiteId =  ' + CONVERT(VARCHAR,@SiteId) + ' AND ISNULL(Summary,'''') <> '''' '
				END
			EXECUTE sp_executesql @SQLString, N'@summaryWhole VARCHAR(MAX) OUTPUT, @none TINYINT OUTPUT', @summaryWhole OUTPUT, @none OUTPUT

			IF @Identifier = 'Therapeutic Procedures' 
			BEGIN
				IF ISNULL(@none,0) = 0 AND LEN(@summaryWhole) > 0
				BEGIN
					SET @fullStop = @emptyStr
					SET @abnoTheraPresent = 1
			END
			ELSE 
			BEGIN
					SET @opDiv = @emptyStr;		SET @clDiv = @emptyStr
					SET @opBold = @emptyStr;	SET @clBold = @emptyStr
			END
			END
			ELSE 
			BEGIN
				IF @Identifier = 'Specimens Taken' 
				BEGIN
					--IF therapeutics present, remove line before specimens
					IF @abnoTheraPresent = 1 SET @br = @emptyStr
				END
				ELSE 
				BEGIN
					SET @opBold = @emptyStr;	SET @clBold = @emptyStr
				END
				SET @opDiv = @emptyStr ;		SET @clDiv = @emptyStr
			END

			IF ISNULL(@summaryWhole,'') <> ''
			BEGIN
				SET @summaryWhole = REPLACE(@summaryWhole,'''','''''')

				--If None is clicked, prefix not required (e.g "Oesophagitis : No Oesophagitis." should be "No Oesophagitis.")
				--Prefix (@AbnoNodeName) is required for Lumen even if None (Blood free) is selected
				IF (ISNULL(@none,0) = 1 OR @AbnoNodeName = '') AND @TableName <> 'ERS_UpperGIAbnoLumen'
				BEGIN	
					SET @AbnoNodeName = '';		SET @colon = ''
				END
				ELSE
				BEGIN
					SET @colon = ': '
				END
		
				SET @tmpSummaryAbno = ' CASE WHEN ''' + @summaryWhole + ''' IN ('''', ''' + @AbnoNodeName + ''') THEN ''' +  @indent + @AbnoNodeName + '' + @fullStop + '''' +
										' ELSE  ''' + @indent + @opBold + @AbnoNodeName + @clBold + @colon + ''' + ' + @opDiv + '''' + @summaryWhole + @fullStop + '''' + @clDiv +
									' END'

				--TFS#	3776
				SET @tmpSummaryAbnoLinks = 'CASE WHEN ''' + @summaryWhole + ''' IN ('''', ''' + @AbnoNodeName + ''') THEN ''' +  @indent + @AbnoNodeName + ''' + REPLACE(REPLACE(''' + @htmlAnchorCode + ''',''{0}'',''' + @Identifier + '''),''{1}'',''' + @AbnoNodeName + ''') + ''' + @fullStop + '''' +
											' ELSE  ''' +  @indent + @opBold + @AbnoNodeName + @clBold + @colon + ''' + REPLACE(REPLACE(''' + @htmlAnchorCode + ''',''{0}'',''' + @Identifier + '''),''{1}'',' +  @opDiv + '''' + @summaryWhole  + '''' +	 @clDiv +')  ' +
										' END'
				--TFS#	3776

			SET @SQLString = 'SELECT ' +
								CASE WHEN @Identifier = 'Specimens Taken'			THEN '@summarySpecimens = @summarySpecimens '
									 WHEN @Identifier = 'Therapeutic Procedures'	THEN '@summaryTherapeutics = @summaryTherapeutics '
									 ELSE '@summaryAbnormalities = @summaryAbnormalities ' END +
											' + ''' + @br  + ''' + '  + @tmpSummaryAbno + ', ' +

								CASE WHEN @Identifier = 'Specimens Taken'			THEN '@summarySpecimensWithHyperLinks = @summarySpecimensWithHyperLinks '
									 WHEN @Identifier = 'Therapeutic Procedures'	THEN '@summaryTherapeuticsWithHyperLinks = @summaryTherapeuticsWithHyperLinks '
									 ELSE '@summaryAbnormalitiesWithHyperLinks = @summaryAbnormalitiesWithHyperLinks ' END +
												' + ''' + @br  + ''' + '  + @tmpSummaryAbnoLinks 						
			--Perform abno check to determine normal procedure
			IF @none = 0  and @TableName <> 'ERS_UpperGISpecimens' AND @AbnormalProcedure <> 1  SET @AbnormalProcedure = 1

			IF @Identifier = 'Specimens Taken'
				EXECUTE sp_executesql @SQLString, N'@summarySpecimens VARCHAR(MAX) OUTPUT,@summarySpecimensWithHyperLinks VARCHAR(MAX) OUTPUT', 
							@summarySpecimens = @summarySpecimens OUTPUT, @summarySpecimensWithHyperLinks=@summarySpecimensWithHyperLinks OUTPUT
			ELSE IF @Identifier = 'Therapeutic Procedures'
				EXECUTE sp_executesql @SQLString, N'@summaryTherapeutics VARCHAR(MAX) OUTPUT,@summaryTherapeuticsWithHyperLinks VARCHAR(MAX) OUTPUT', 
							@summaryTherapeutics = @summaryTherapeutics OUTPUT, @summaryTherapeuticsWithHyperLinks=@summaryTherapeuticsWithHyperLinks OUTPUT
			ELSE
				EXECUTE sp_executesql @SQLString, N'@summaryAbnormalities VARCHAR(MAX) OUTPUT,@summaryAbnormalitiesWithHyperLinks VARCHAR(MAX) OUTPUT', 
							@summaryAbnormalities = @summaryAbnormalities OUTPUT, @summaryAbnormalitiesWithHyperLinks=@summaryAbnormalitiesWithHyperLinks OUTPUT
			END

			FETCH NEXT FROM qry_cursor INTO @ProcType, @TableName, @AbnoNodeName, @Identifier
		END

		CLOSE qry_cursor
		DEALLOCATE qry_cursor

		DROP TABLE #QueryDetails

		if exists(select 1 from ERS_CommonAbnoOther where SiteId = @SiteId)
		BEGIN
			SELECT @summaryAbnormalities = isnull(@summaryAbnormalities, '') + (SELECT STUFF((
																					SELECT ', ' + OA.Summary 
																					FROM ERS_OtherAbnormalities OA
																					JOIN ERS_CommonAbnoOther CAO ON OA.OtherId = CAO.OtherId
																					WHERE CAO.SiteId = @SiteId
																					FOR XML PATH('')), 1, 1, '') Code ),
				 @summaryAbnormalitiesWithHyperLinks = isnull(@summaryAbnormalitiesWithHyperLinks, '') + '<table><tr><td style="padding-right:50px;">- Other:' +
				 REPLACE(REPLACE(REPLACE(@htmlAnchorCode,'''{0}''','Other'),'{1}',
																					(SELECT STUFF((
																					SELECT ', ' + OA.Summary 
																					FROM ERS_OtherAbnormalities OA
																					JOIN ERS_CommonAbnoOther CAO ON OA.OtherId = CAO.OtherId
																					WHERE CAO.SiteId = @SiteId
																					FOR XML PATH('')), 1, 1, '') Code )), '''''', '''')
														+ '</td></tr></table>'
		END
		-- Update the current site's summary
		UPDATE ERS_Sites 
		SET	
			SiteSummary = @summaryAbnormalities,
			SiteSummarySpecimens = @summarySpecimens,
			SiteSummaryTherapeutics = @summaryTherapeutics,
			SiteSummaryWithLinks = @summaryAbnormalitiesWithHyperLinks,
			SiteSummarySpecimensWithLinks = @summarySpecimensWithHyperLinks,
			SiteSummaryTherapeuticsWithLinks = @summaryTherapeuticsWithHyperLinks,
			HasAbnormalities = @AbnormalProcedure
		WHERE 
			SiteId = @siteId

		-- Update the summary of the procedure (all the sites)
		EXEC procedure_summary_update @procId

	END TRY

	BEGIN CATCH
		DECLARE @ErrorMessage NVARCHAR(4000);
		DECLARE @ErrorSeverity INT;
		DECLARE @ErrorState INT;

		SELECT @ErrorMessage = ERROR_MESSAGE(),
			   @ErrorSeverity = ERROR_SEVERITY(),
			   @ErrorState = ERROR_STATE();
    
		RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

		IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
	END CATCH


	IF @@TRANCOUNT > 0 COMMIT TRANSACTION;
END

GO
EXEC dbo.DropIfExist 
    @ObjectName = 'common_polpydetails_summary', 
    @ObjectTypePrefix = 'F' 
GO


CREATE FUNCTION [dbo].[common_polpydetails_summary]
(
	@SiteId int,
	@PolypDetailId int = NULL
)
RETURNS VARCHAR(max)
AS
BEGIN
	DECLARE 
	@PolypType varchar(100),
	@TumourType varchar(100),
	@PolypCondition varchar(100), 
	@Tattooed varchar(100),
	@TattooMarkingType varchar(100),
	--@PolypDetailId int,
	@Quantity int,
	@summary varchar(max) = '',
	@Probably bit,
	@TumourTypeId int,
	@Size int,
	@ParisClass int,
	@PitPattern int,
	@Excised int,
	@Retrieved int,
	@ToLabs int,
	@Removal int,
	@RemovalType varchar(10) = '',
	@RemovalMethod int,
	@RemovalBy varchar(500) = '',
	@Inflam bit,
	@PostInflam bit,
	@TattooedId int,
	@TattooMarkingTypeId int,
	@Count int,
	@Submucosal BIT,
	@SubmucosalQuantity INT,
	@SubmucosalLargest INT,
	@SubmucosalProbably BIT,
	@SubmucosalTypeId TINYINT,
	@Focal BIT,
	@FocalQuantity INT,
	@FocalLargest INT,
	@FocalProbably BIT,
	@FocalTypeId TINYINT,
	@FundicGlandPolyp BIT,
	@FundicGlandPolypQuantity INT,
	@FundicGlandPolypLargest Numeric(18,2)
	
	--saves calling the table multiple times :)
	DECLARE @TumourTypes TABLE (TypeId int, [Description] varchar(100))
	INSERT INTO @TumourTypes
	SELECT UniqueId, [Description] 
	FROM ERS_TumourTypes 
	WHERE Suppressed = 0

	SELECT 
	@Submucosal =iif(b.description='Submucosal',1,0),
	@SubmucosalTypeId = a.type,
	@SubmucosalLargest = a.SubmucosalLargest,
	@SubmucosalProbably = a.Probably,
	@SubmucosalQuantity = a.SubmucosalQuantity,
	@Focal = iif(b.description='Focal lesions',1,0),
	@FocalTypeId = a.type,
	@FocalLargest = a.FocalLargest,
	@FocalProbably = a.Probably,
	@FocalQuantity = a.FocalQuantity,
	@FundicGlandPolyp = iif(b.description='Fundic Gland Polyp',1,0),
	@FundicGlandPolypQuantity = FundicGlandPolypQuantity,
	@FundicGlandPolypLargest = FundicGlandPolypLargest
FROM
	ERS_CommonAbnoPolypDetails a left join ERS_PolypTypes b on a.PolypTypeId=b.uniqueid
WHERE
	SiteId = @SiteId and PolypDetailId = ISNULL(@PolypDetailId, PolypDetailId)


	SELECT @Quantity = count(*)
	FROM ERS_CommonAbnoPolypDetails WHERE SiteId = @SiteId AND PolypDetailId = ISNULL(@PolypDetailId, PolypDetailId)

	SELECT @PolypType = LOWER([Description])
	FROM ERS_PolypTypes pt
		INNER JOIN ERS_CommonAbnoPolypDetails l ON pt.UniqueId = l.PolypTypeId
	WHERE SiteId = @SiteId


	DECLARE cur CURSOR FOR
	SELECT ecapd.PolypDetailId, ecapd.Size, ecapd.Excised, ecapd.Retreived, ecapd.Successful, ecapd.Removal, ecapd.RemovalMethod, ecapd.Probably, ecapd.Type, ecapd.ParisClass, ecapd.PitPattern, 
		ecapd.Infammatory, ecapd.PostInflammatory, ecapd.TattooedId, ecapd.TattooedMarkingTypeId
	FROM dbo.ERS_CommonAbnoPolypDetails ecapd
	WHERE SiteId = @SiteId AND PolypDetailId = ISNULL(@PolypDetailId, PolypDetailId)

	SET @summary = CASE WHEN @PolypDetailId IS NULL THEN CONVERT(VARCHAR(10), @Quantity) + ' ' + @PolypType + CASE WHEN @Quantity = 1 THEN ' polyp' ELSE ' polyps' END ELSE '' END



	------------------------------------------------------------------------------------------
	-------	SUBMUCOSAL LESION -------
	------------------------------------------------------------------------------------------
	IF @Submucosal > 0
	BEGIN
		IF @summary <> '' SET @summary = @summary + '##'

		IF @SubmucosalQuantity > 1 SET @summary = @summary + CONVERT(VARCHAR(20), @SubmucosalQuantity) + ' '
		ELSE SET @summary = @summary + 'A '
		
		IF @SubmucosalProbably = 1 SET @summary = @summary + 'probably '

		SELECT @summary = @summary + LOWER([Description]) + ' ' FROM @TumourTypes WHERE TypeId = @SubmucosalTypeId

		IF @SubmucosalQuantity > 1 SET @summary = @summary + 'submucosal lesions ' ELSE SET @summary = @summary + 'submucosal lesion ' 

		IF (@SubmucosalQuantity > 0 AND @SubmucosalLargest > 0) 
		BEGIN
			IF @SubmucosalQuantity > 1
				SET @summary = @summary + '(largest ' + CONVERT(VARCHAR(20), @SubmucosalLargest) + 'mm) '
			ELSE
				SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @SubmucosalLargest) + 'mm) '
		END
	END

	------------------------------------------------------------------------------------------
	-------	FOCAL LESIONS -------
	------------------------------------------------------------------------------------------
	IF @Focal > 0
	BEGIN
		IF @summary <> '' SET @summary = @summary + '##'

		IF @FocalQuantity > 1 SET @summary = @summary + CONVERT(VARCHAR(20), @FocalQuantity) + ' '
		ELSE SET @summary = @summary + 'A '
		
		IF @FocalProbably = 1 SET @summary = @summary + 'probably '

		SELECT @summary = @summary + LOWER([Description]) + ' ' FROM @TumourTypes WHERE TypeId = @FocalTypeId

		IF @FocalQuantity > 1 SET @summary = @summary + 'focal lesions ' ELSE SET @summary = @summary + 'submucosal lesion ' 

		IF (@FocalQuantity > 0 AND @FocalLargest > 0) 
		BEGIN
			IF @FocalQuantity > 1
				SET @summary = @summary + '(largest ' + CONVERT(VARCHAR(20), @FocalLargest) + 'mm) '
			ELSE
				SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @FocalLargest) + 'mm) '
		END
	END
	-------------------------------------------------------------------------------------------
	-------	Fundic Gland Polyp -------
	------------------------------------------------------------------------------------------
	IF @FundicGlandPolyp > 0
	BEGIN
		IF @summary <> '' SET @summary = @summary + '##'

		IF @FundicGlandPolypQuantity > 1 SET @summary = @summary + CONVERT(VARCHAR(20), @FundicGlandPolypQuantity) + ' '
		ELSE SET @summary = @summary + 'A '
		
		IF @FundicGlandPolypQuantity > 1 SET @summary = @summary + 'Fundic Gland Polyp found ' ELSE SET @summary = @summary + 'Fundic Gland Polyp found ' --TFS-2958---

		IF (@FundicGlandPolypQuantity > 0 AND @FundicGlandPolypLargest > 0) 
		BEGIN
			IF @FundicGlandPolypQuantity > 1
				SET @summary = @summary + '(largest ' + CONVERT(VARCHAR(20), @FundicGlandPolypLargest) + ' mm) '
			ELSE
				SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @FundicGlandPolypLargest) + ' mm) '
		END
	END


	SET @Count = 1
	--loop through records
	OPEN cur
	FETCH NEXT FROM cur INTO @PolypDetailId, @Size, @Excised, @Retrieved, @ToLabs, @Removal, @RemovalMethod, @Probably, @TumourTypeId, @ParisClass, @PitPattern, @Inflam, @PostInflam, @TattooedId, @TattooMarkingTypeId

	WHILE @@FETCH_STATUS = 0 
	BEGIN
		SET  @Tattooed = NULL
		SET @TumourType = ''
		SET @TattooMarkingType = NULL

		--build up summary report
		SELECT @TumourType = LOWER(ISNULL([Description],''))
		FROM ERS_TumourTypes
		WHERE UniqueId = @TumourTypeId

		SELECT @Tattooed = LOWER([Description])
		FROM ERS_TattooOptions
		WHERE UniqueId = @TattooedId

		SELECT @TattooMarkingType = LOWER(ISNULL([Description],''))
		FROM ERS_MarkingTypes
		WHERE UniqueId = @TattooMarkingTypeId

		SELECT @PolypCondition = (
			SELECT STUFF((SELECT ', ' + LOWER(ISNULL([SummaryTerm],''))as [text()] 
		    FROM ERS_CommonAbnoPolypConditions cc
				INNER JOIN ERS_PolypConditions pd on cc.PolypConditionId = pd.UniqueId
			WHERE PolypDetailId = @PolypDetailId AND [Description] <> 'Hyperplastic'
			ORDER BY ISNULL(ListOrderBy,9999)
		    FOR XML PATH('')),1,1,''))
		
		SELECT @RemovalType = LOWER([Description])
		FROM ERS_PolypRemovalMethods
		WHERE UniqueId = @Removal

		SELECT @RemovalBy = Description
		FROM ERS_PolypRemovalTypes
		WHERE UniqueId = @RemovalMethod

		SELECT @PolypCondition = dbo.fnStringToSentance(@PolypCondition)

		DECLARE @IsHyperplastic BIT = (SELECT 1 FROM ERS_CommonAbnoPolypConditions cc
				INNER JOIN ERS_PolypConditions pd on cc.PolypConditionId = pd.UniqueId
			WHERE PolypDetailId = @PolypDetailId AND [Description] = 'Hyperplastic')

		IF @Quantity > 1 SET @summary = @summary + '<br/>Polyp ' + convert(varchar(10), @Count) + '- '
		IF ISNULL(@PolypCondition,'') <> '' OR ISNULL(@IsHyperPlastic,0) = 1
		BEGIN
		 SET @summary = @summary + CASE WHEN ISNULL(@IsHyperPlastic,0) = 1 THEN 'Hyperplastic ' ELSE '' END +  CASE WHEN ISNULL(@PolypCondition,'') <> '' THEN 'with' + @PolypCondition ELSE '' END + ': ' --ELSE SET @summary = @summary + '<br/>'
		END

		IF @PolypType = 'sessile'
			BEGIN
				IF @Probably = 1 SET @summary = @summary + 'probably '

				SET @summary = @summary + ' ' + @TumourType + ' '

				IF (@Quantity > 0 AND @Size > 0) 
				BEGIN
					SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @Size) + 'mm) '
				END

				IF @ParisClass > 0 OR @PitPattern > 0
				BEGIN
					SET @summary = @summary + '('

					IF @ParisClass > 0 
					SET @summary = @summary +
							 CASE @ParisClass
								   WHEN  1 THEN 'Paris Is'
								   WHEN  2 THEN 'Paris IIa'
								   WHEN  3 THEN 'Paris IIa + IIc'
								   WHEN  4 THEN 'Paris IIb'
								   WHEN  5 THEN 'Paris IIc'
								   WHEN  6 THEN 'Paris IIc + IIa'
								   WHEN  7 THEN 'Paris Ip'
								   WHEN  8 THEN 'Paris Isp'
								   WHEN  10 THEN 'Paris LST-G'
								   WHEN  11 THEN 'Paris LST-NG'
								   WHEN  12 THEN 'Paris LST-D'
								   WHEN  13 THEN 'Paris LST-M'
								   ELSE ''
					END

					IF @PitPattern > 0 
					BEGIN
						IF @ParisClass > 0 SET @summary = @summary + ', '
				
						SET @summary = @summary +
								   CASE @PitPattern
										  WHEN  1 THEN 'pit type I'
										  WHEN 2 THEN 'pit type II'
										  WHEN  3 THEN 'pit type IIIs'
										  WHEN  4 THEN 'pit type IIIL'
										  WHEN  5 THEN 'pit type IV'
										  WHEN  6 THEN 'pit type V'
							ELSE ''
						END
					END

					SET @summary = @summary + ')'
				END

				IF @Excised = 1 
				BEGIN
					SET @summary = @summary + '$$ '
					SET @summary = @summary + 'excised '

					IF @Removal > 0 OR @RemovalMethod > 0
					BEGIN
						SET @summary = @summary + '(removed '
				
						IF @Removal > 0 SET @summary = @summary + @RemovalBy + ' '
						IF @RemovalMethod > 0 SET @summary = @summary + @RemovalType
						
						SET @summary = @summary + ')'
					END
				END

				IF @Retrieved = 1 
				BEGIN
					SET @summary = @summary + '$$ '
					SET @summary = @summary + 'retrieved '
				END

				IF @ToLabs = 1  
				BEGIN
					SET @summary = @summary + '$$ '
					SET @summary = @summary + 'sent to labs '
				END
						

				-- Set the last occurence of $$ to "and"
				IF CHARINDEX('$$', @summary) > 0 SET @summary = STUFF(@summary, len(@summary) - charindex('$$', reverse(@summary)), 3, ' and ')
				-- Replace all other occurences of $$ with commas
				SET @summary = REPLACE(@summary, '$$', ',')
			END

			------------------------------------------------------------------------------------------
			-------	PEDUNCULATED -------
			------------------------------------------------------------------------------------------
			ELSE IF @PolypType = 'pedunculated'
			BEGIN
				--IF @Quantity > 0 SET @summary = @summary + CONVERT(VARCHAR(20), @Quantity) + ' '
		
				IF @Probably = 1 SET @summary = @summary + 'probably '

				IF @TumourTypeId = 1 SET @summary = @summary + 'benign '
				ELSE IF @TumourTypeId = 2 SET @summary = @summary + 'malignant '

				IF @ParisClass = 2 
					SET @summary = @summary + 'sub pedunculated ' 
				--ELSE
				--	SET @summary = @summary + 'polyp ' 

				IF (@Quantity > 0 AND @Size > 0) 
				BEGIN
					SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @Size) + 'mm) '
				END

				IF @ParisClass > 0 OR @PitPattern > 0
				BEGIN
					SET @summary = @summary + '('

					IF @ParisClass > 0 
					SET @summary = @summary +
					CASE 
						 WHEN  @ParisClass = 7 THEN 'Paris IP'
						 WHEN  @ParisClass = 8 THEN 'Paris Isp'
						ELSE ''
					END

					IF @PitPattern > 0 
					BEGIN
						IF @ParisClass > 0 SET @summary = @summary + ', '
				
						SET @summary = @summary +
						CASE 
							WHEN @PitPattern = 1 THEN 'pit type I'
							WHEN @PitPattern = 2 THEN 'pit type II'
							WHEN @PitPattern = 3 THEN 'pit type IIIs'
							WHEN @PitPattern = 4 THEN 'pit type IIIL'
							WHEN @PitPattern = 5 THEN 'pit type IV'
							WHEN @PitPattern = 6 THEN 'pit type V'
							ELSE ''
						END
					END

					SET @summary = @summary + ')'
				END

				IF @Excised =1
				BEGIN
					SET @summary = @summary + '$$ '
					SET @summary = @summary + ' excised '

					IF @Removal > 0 OR @RemovalMethod > 0
					BEGIN
						SET @summary = @summary + '(removed '
				
						IF @Removal > 0 SET @summary = @summary + @RemovalBy + ' '
						IF @RemovalMethod = 1 SET @summary = @summary + @RemovalType
				
						SET @summary = @summary + ')'
					END
				END

				IF @Retrieved =1 
				BEGIN
					SET @summary = @summary + '$$ '
					SET @summary = @summary + 'retrieved '
				END

				IF @ToLabs =1 
				BEGIN
					SET @summary = @summary + '$$ '
					SET @summary = @summary + 'sent to labs '
				END

				SET @summary = @summary + ')'
				-- Set the last occurence of $$ to "and"
				IF CHARINDEX('$$', @summary) > 0 SET @summary = STUFF(@summary, len(@summary) - charindex('$$', reverse(@summary)), 3, ' and ')
				-- Replace all other occurences of $$ with commas
				SET @summary = REPLACE(@summary, '$$', ',')
			END

			------------------------------------------------------------------------------------------
			-------	PSEUDOPOLYPS -------
			------------------------------------------------------------------------------------------
			ELSE IF @PolypType = 'pseudo'
			BEGIN
				--IF @Quantity > 0 SET @summary = @summary + CONVERT(VARCHAR(20), @Quantity) + ' '

				IF @Inflam = 1 AND @PostInflam = 0 SET @summary = @summary + 'inflammatory '
				ELSE IF @Inflam = 0 AND @PostInflam = 1 SET @summary = @summary + 'post-inflammatory '
				ELSE IF @Inflam = 1 AND @PostInflam = 1 SET @summary = @summary + 'inflammatory and post-inflammatory '
		
				--SET @summary = @summary + 'pseudopolyp ' 

				IF (@Quantity > 0 AND @Size > 0) 
				BEGIN
					SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @Size) + 'mm) '
				END

				IF @ParisClass > 0 OR @PitPattern > 0
				BEGIN
					SET @summary = @summary + '('

					IF @ParisClass > 0 
					SET @summary = @summary +
					 CASE @ParisClass
						WHEN  1 THEN 'Paris Is'
						WHEN  2 THEN 'Paris IIa'
						WHEN  3 THEN 'Paris IIa + IIc'
						WHEN  4 THEN 'Paris IIb'
						WHEN  5 THEN 'Paris IIc'
						WHEN  6 THEN 'Paris IIc + IIa'
						WHEN  7 THEN 'Paris Ip'
						WHEN  8 THEN 'Paris Isp'
						WHEN  10 THEN 'Paris LST-G'
						WHEN  11 THEN 'Paris LST-NG'
						WHEN  12 THEN 'Paris LST-D'
						WHEN  13 THEN 'Paris LST-M'
						ELSE ''
					END

					IF @PitPattern > 0 
					BEGIN
						IF @ParisClass > 0 SET @summary = @summary + ', '
				
						SET @summary = @summary +
						CASE 
							WHEN @PitPattern = 1 THEN 'pit type I'
							WHEN @PitPattern = 2 THEN 'pit type II'
							WHEN @PitPattern = 3 THEN 'pit type IIIs'
							WHEN @PitPattern = 4 THEN 'pit type IIIL'
							WHEN @PitPattern = 5 THEN 'pit type IV'
							WHEN @PitPattern = 6 THEN 'pit type V'
							ELSE ''
						END
					END

					SET @summary = @summary + ')'
				END

				IF @Excised =1 
				BEGIN
					SET @summary = @summary + '$$ '
					SET @summary = @summary + 'excised '

					IF @Removal > 0 OR @RemovalMethod > 0
					BEGIN
						SET @summary = @summary + '(removed '
				
						IF @Removal > 0 SET @summary = @summary + @RemovalBy + ' '
						IF @RemovalMethod = 1 SET @summary = @summary + @RemovalType

						
					END
				END

				IF @Retrieved =1 
				BEGIN
					SET @summary = @summary + '$$ '
					SET @summary = @summary + 'retrieved '
				END

				IF @ToLabs =1 
				BEGIN
					SET @summary = @summary + '$$ '
					SET @summary = @summary + 'sent to labs '
				END

				SET @summary = @summary + ')'

				-- Set the last occurence of $$ to "and"
				IF CHARINDEX('$$', @summary) > 0 SET @summary = STUFF(@summary, len(@summary) - charindex('$$', reverse(@summary)), 3, ' and ')
				-- Replace all other occurences of $$ with commas
				SET @summary = REPLACE(@summary, '$$', ',')
			END
			------------------------------------------------------------------------------------------
			-------	SUBMUCOSAL -------
			------------------------------------------------------------------------------------------
			ELSE IF @PolypType = 'submucosal'
			BEGIN
				IF (@Quantity > 0 AND @Size > 0) 
				BEGIN
					SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @Size) + 'mm) '
				END


				-- Set the last occurence of $$ to "and"
				IF CHARINDEX('$$', @summary) > 0 SET @summary = STUFF(@summary, len(@summary) - charindex('$$', reverse(@summary)), 3, ' and')
				-- Replace all other occurences of $$ with commas
				SET @summary = REPLACE(@summary, '$$', ',')
			END

			IF ISNULL(@Tattooed,'no') <> 'no'
			BEGIN
				SET @summary = @summary + '. Polyp ' + CASE WHEN @Tattooed = 'yes' THEN 'tattooed' ELSE ISNULL(@Tattooed, 'previously tattooed') END + CASE WHEN ISNULL(@TattooMarkingType,'') <> '' THEN ' using ' + @TattooMarkingType ELSE '' END
			END
		SET @Count = @Count + 1
		FETCH NEXT FROM cur INTO @PolypDetailId, @Size, @Excised, @Retrieved, @ToLabs, @Removal, @RemovalMethod, @Probably, @TumourTypeId, @ParisClass, @PitPattern, @Inflam, @PostInflam, @TattooedId, @TattooMarkingTypeId

	END

	CLOSE cur
	DEALLOCATE cur

	RETURN @summary + '##'
END

GO

------------------------------------------------------------------------------------------------------------------------
-- TFS#	4069 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Muhammad Nasim
-- TFS#	3851 & 3911 & 4078
-- Description of change: the system will allow you to move forward without a further value in indications other than FIT & Patient DNA Reprot -  Follow up section not needed & Validation for Other sub indications free text box
-------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 14.6.24
-- TFS#	
-- Description of change
-- Removed FIT validation, Set to DNA exempt so will get excluded from the check when procedure is DNA
------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 25.6.24
-- TFS#	(Spreadsheet item 16)
-- Description of change
-- Start and end time validation fails if both are the same time
------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 25.6.24
-- TFS#	(Spreadsheet item )
-- Description of change
-- Extent checked for both endoscopists for training lists
------------------------------------------------------------------------------------------------------------------------
GO
dbo.DropIfExist
    @ObjectName = 'check_requiredfields',      -- varchar(100)
    @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[check_requiredfields]
(
	@ProcedureId INT,
	@PageId INT,
	@LoggedInUserId INT,
	@OperatingHospitalId INT
)
AS
BEGIN
	DECLARE @ProcedureTypeId INT,@NEDEnabled int, @ProcedureDNA INT, @UISectionId INT, @SectionName VARCHAR(50), @SectionPageId INT, @SectionControl VARCHAR(50), @IncompleteSections VARCHAR(MAX) = '', @ProcedureModifiedDate DATETIME, @ProcedureCompleted BIT, @FITValue int,@ReportUpdated BIT
	SELECT @ProcedureTypeId = ProcedureType, @ProcedureDNA = ISNULL(DNA,0), @ProcedureModifiedDate = ModifiedOn, @ProcedureCompleted = ISNULL(ProcedureCompleted,0),@ReportUpdated = ReportUpdated FROM ERS_Procedures WHERE ProcedureId = @ProcedureId
	
	DECLARE @ProcedureEndoCount INT
	IF EXISTS (SELECT 1 FROM ERS_Procedures WHERE ProcedureId = @ProcedureId AND Endoscopist2 IS NOT NULL)
		SET @ProcedureEndoCount = 2
	ELSE
		SET @ProcedureEndoCount = 1

	IF @ReportUpdated = 1 AND @ProcedureModifiedDate >= (SELECT TOP 1 InstallDate
																FROM DBVersion
																WHERE SUBSTRING(VersionNum,1,1) = '2'
																ORDER BY InstallDate ASC)
	

	BEGIN
	IF @ProcedureTypeId NOT IN (10,11,13) 
		BEGIN
		
	
			DECLARE cur CURSOR FOR (SELECT DISTINCT us.UISectionId, SectionName, PageId, SectionControl
									FROM UI_sections us
										LEFT JOIN UI_SectionProcedureTypes spt ON spt.UISectionId = us.UISectionId
									WHERE NEDRequired = 1 
									AND ISNULL(ProcedureTypeId,0) IN (0,@ProcedureTypeId) 
									AND DNAExempt = CASE WHEN @ProcedureDNA > 0 THEN 0 ELSE DNAExempt END 
									AND (PageId = @PageId OR @PageId = 0))
								
			SET @IncompleteSections = ''
			OPEN cur
			FETCH NEXT FROM cur INTO @UISectionId, @SectionName, @SectionPageId, @SectionControl

			WHILE @@FETCH_STATUS = 0
			BEGIN
				IF NOT EXISTS (SELECT 1 FROM dbo.ERS_ProcedureSummary WHERE ProcedureId = @ProcedureId AND SectionId = @UISectionId)
				BEGIN
					SET @IncompleteSections =@IncompleteSections + '&bull;' + @SectionName + '<br />'
				END
		
				IF LOWER(@SectionName) = 'extent' AND CHARINDEX('extent',@IncompleteSections) = 0 /*no point validating if its not complete*/
				BEGIN
					IF (SELECT COUNT(*) FROM dbo.ERS_ProcedureSummary WHERE ProcedureId = @ProcedureId AND SectionId = @UISectionId) < @ProcedureEndoCount
					BEGIN
						SET @IncompleteSections = @IncompleteSections + '&bull;' + @SectionName + ' is incomplete. Both ensocopists must record their result<br />'
					END
				END
		
				IF LOWER(@SectionName) = 'jmanoevre' AND CHARINDEX('jmanoevre',@IncompleteSections) = 0 /*no point validating if its not complete*/
				BEGIN
					IF (SELECT COUNT(*) FROM dbo.ERS_ProcedureSummary WHERE ProcedureId = @ProcedureId AND SectionId = @UISectionId) < @ProcedureEndoCount
					BEGIN
						SET @IncompleteSections = @IncompleteSections + '&bull;' + @SectionName + ' is incomplete. Both ensocopists must record their result<br />'
					END
				END

				IF LOWER(@SectionName) = 'procedure timing' AND CHARINDEX('',@IncompleteSections) = 0 /*no point validating if its not complete*/
				BEGIN
					DECLARE @StartTime DATETIME, @EndTime DATETIME
					SELECT @StartTime= StartDateTime, @EndTime = EndDateTime FROM ERS_Procedures WHERE ProcedureId= @ProcedureId
					IF @StartTime > @EndTime OR @StartTime = @EndTime
					BEGIN
						SET @IncompleteSections = @IncompleteSections + '&bull;' + @SectionName + ' is incorrect. Check start is not after end date/time<br />'
					END
				END

				IF LOWER(@SectionName) = 'indications'
				BEGIN
					--'check sub indications'
					IF (SELECT COUNT(*) 
					FROM 
						(SELECT CASE WHEN ei.SubIndicationParent = 0 THEN 1 WHEN ei.SubIndicationParent = 1 AND EXISTS (SELECT 1 FROM dbo.ERS_ProcedureSubIndications epsi WHERE epsi.ProcedureId = ep.ProcedureId) THEN 1 ELSE 0 END AS 'Complete'
						FROM dbo.ERS_ProcedureIndications ep
							INNER JOIN dbo.ERS_Indications ei ON ei.UniqueId = ep.IndicationId
						WHERE procedureid = @ProcedureId) inds
						WHERE inds.Complete = 0) > 0
					BEGIN
						SET @IncompleteSections = @IncompleteSections + '&bull;Subindications<br />'
					END
					else if exists (select 1 from ERS_ProcedureSubIndications where procedureid=@ProcedureId and SubIndicationId=(select UniqueId from ERS_SubIndications where [Description]='Other') and len(AdditionalInfo)=0)--TFS 4078
					begin
						SET @IncompleteSections = @IncompleteSections + '&bull;Subindications<br />'
					end
				END

				IF LOWER(@SectionName) = 'rx'
				BEGIN
					--check if anti coag has been marked as yes.. if so perform checks 
					DECLARE @AntiCoagDrugs BIT
					SELECT @AntiCoagDrugs = AntiCoagDrugs FROM ERS_Procedures WHERE ProcedureId = @ProcedureId
					IF @AntiCoagDrugs = 1 
					BEGIN
						IF NOT EXISTS (SELECT 1 FROM ERS_ProcedureSummary WHERE ProcedureId = @ProcedureId AND SectionId = @UISectionId)
						BEGIN
							SET @IncompleteSections = REVERSE(SUBSTRING(REVERSE(@IncompleteSections), CHARINDEX('<br />', REVERSE(@IncompleteSections)) + 7, LEN(@IncompleteSections))) + '<small><em> - RX drugs must be complete for patients that are taking Anti-coag or Anti-platelet Medication</em></small><br />'
							SELECT @IncompleteSections
						END
					END
				END

				FETCH NEXT FROM cur INTO @UISectionId, @SectionName, @SectionPageId, @SectionControl
			END

			CLOSE cur
			DEALLOCATE cur

			--edited by siddik #TFS 3779
			DECLARE @PacemakerId INT = (SELECT UniqueId FROM ERS_Comorbidity WHERE Description = 'Pacemaker')
			DECLARE @DiabetesMellitusId INT = (SELECT UniqueId FROM ERS_Comorbidity WHERE Description = 'Diabetes Mellitus')
			IF @PageId IN (0, 1)
			BEGIN
				IF EXISTS (SELECT 1 FROM ERS_ProcedureComorbidity WHERE ProcedureId = @ProcedureId AND ChildComorbidityId = 0 AND ComorbidityId IN (@PacemakerId, @DiabetesMellitusId))
				BEGIN
					SET @IncompleteSections = @IncompleteSections + '&bull;Comorbidity<br />'
				END
			END
	
			IF EXISTS (SELECT 1 FROM ERS_UrgencyTypes c LEFT JOIN ERS_Procedures p ON c.UniqueId = p.CategoryListId WHERE p.ProcedureId = @ProcedureId AND c.Description = 'Urgent (suspected cancer pathway)')
				AND @PageId IN (0,3)
				AND @ProcedureDNA = 0
			BEGIN
				DECLARE @QuestionId INT = (SELECT QuestionId FROM ERS_PathwayPlanQuestions WHERE Question='Evidence of cancer?' AND ProcedureType = @ProcedureTypeId AND OperatingHospital = @OperatingHospitalId)
				IF @QuestionId > 0 AND NOT EXISTS (SELECT 1 FROM ERS_ProcedurePathwayPlanAnswers WHERE ProcedureId = @ProcedureId AND QuestionId = @QuestionId)
				BEGIN
					INSERT INTO ERS_ProcedurePathwayPlanAnswers (ProcedureId, QuestionId, OptionAnswer, WhoCreatedId, WhenCreated)
					VALUES (@ProcedureId, @QuestionId, 1, @LoggedInUserId, getdate())
				END
			
				IF NOT EXISTS (SELECT 1 FROM ERS_PathwayPlanQuestions q LEFT JOIN ERS_ProcedurePathwayPlanAnswers a ON q.QuestionId = a.QuestionId WHERE a.ProcedureId = @ProcedureId AND q.Question = 'Evidence of cancer?' AND a.OptionAnswer = 0)
				BEGIN
					SET @IncompleteSections = @IncompleteSections + '&bull;Pathway Plan<br />'
				END
			END
		END
		--Updated by	:	Muhammad Nasim
		--Add Anicoag validation for Cystoscopy
		IF @ProcedureTypeId=13
			begin
				IF (SELECT AntiCoagDrugs FROM ERS_Procedures WHERE ProcedureId = @ProcedureId)=1
				BEGIN
					IF NOT EXISTS (SELECT 1 FROM ERS_ProcedureSummary WHERE ProcedureId = @ProcedureId AND SectionId = @UISectionId)
					BEGIN
						SET @IncompleteSections = REVERSE(SUBSTRING(REVERSE(@IncompleteSections), CHARINDEX('<br />', REVERSE(@IncompleteSections)) + 7, LEN(@IncompleteSections))) + '<small><em> - RX drugs must be complete for patients that are taking Anti-coag or Anti-platelet Medication</em></small><br />'						
					END
				END
			end
		--End of Anicoag validation
		--All required fields entered, update flag ProcedureCompleted
		IF @PageId = 0 AND @IncompleteSections	 = ''
		BEGIN
			IF (SELECT ISNULL(ProcedureCompleted,0) FROM ERS_Procedures WHERE ProcedureId = @ProcedureId)  = 0
			BEGIN
				UPDATE ERS_Procedures SET ProcedureCompleted = 1 WHERE ProcedureId = @ProcedureId
			END
		END
		ELSE IF @IncompleteSections <> ''
		BEGIN
				UPDATE ERS_Procedures SET ProcedureCompleted = 0 WHERE ProcedureId = @ProcedureId
		END

		SELECT @IncompleteSections
	END
END
GO


dbo.DropIfExist
    @ObjectName = 'usp_ProcedureNotCarriedOut_Reset',      -- varchar(100)
    @ObjectTypePrefix = 'S' -- varchar(5)
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[usp_ProcedureNotCarriedOut_Reset]
(
	  @ProcedureId	AS INT
)
AS
BEGIN
	SET NOCOUNT ON;
	update ERS_Procedures set DNA=null,NEDEnabled=null WHERE ProcedureId = @ProcedureId;
	update ERS_ProceduresReporting set PP_DNA=null,PP_DNADate=null where ProcedureId=@ProcedureId;
	EXEC procedure_summary_update @ProcedureID;
END
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS# 3851 & 3911 & 4078	(the system will allow you to move forward without a further value in indications other than FIT & Patient DNA Reprot -  Follow up section not needed and & Validation for Other sub indications free text box)
------------------------------------------------------------------------------------------------------------------------
GO


UPDATE UI_Sections SET DNAExempt = 1 WHERE SectionName = 'FIT results'
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 17.06.24
-- TFS#	
-- Description of change
-- new column to be returned
------------------------------------------------------------------------------------------------------------------------
GO



EXEC dbo.DropIfExist @ObjectName = 'get_user',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[get_user]
(
	@UserId INT,
	@TrustId INT
)
AS

BEGIN

	--Gather users Roles for user and current trust into temporary table
	DECLARE @RoleId VARCHAR(max)
	SELECT @RoleID = RoleID FROM ERS_Users where UserID = @UserId
	SELECT [item] AS RoleId, r.RoleName INTO #tmpRoles FROM dbo.fnSplitString(@RoleId,','), ERS_Roles r WHERE [item] = r.RoleId  AND (r.TrustId = @TrustId OR r.TrustId IS NULL)

	--Get User and Comma seperated list of role names
	SELECT [UserID]
      ,[ExpiresOn]
      ,[Username]
      ,[Title]
      ,[Forename]
      ,[Surname]
      ,[Initials]
      ,[Qualifications]
      ,u.[JobTitleID]
      ,[RoleID]
      ,CanRunAK
      ,[IsListConsultant]
      ,[IsEndoscopist1]
      ,[IsEndoscopist2]
      ,[IsAssistantOrTrainee]
      ,[IsNurse1]
      ,[IsNurse2]
      ,[ResetPassword]
      ,u.[Suppressed] 
      ,[ShowTooltips]     
      ,[GMCCode]
      ,[CanEditDropdowns]
      ,[CanViewAllUserAudits]
      ,ISNULL([GeneralLibrary],0) AS GeneralLibrary,
	  jt.Description AS JobTitle,
	(select substring((select ',' + convert(varchar(12),RoleName)
				  from #tmpRoles
				  order by CAST(RoleId AS NUMERIC(4,0)) asc
				  for xml path('')),2,70)) AS Permissions
	  ,CanOverBookLists
	  ,ISNULL(CanOverrideSchedule,0) CanOverrideSchedule
	FROM ERS_Users u
	LEFT JOIN ERS_JobTitles jt ON u.JobTitleID = jt.JobTitleID
	WHERE UserId = @UserId
END
GO


------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO

-----------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea
-- TFS#	
-- Description of change
-- additional scripts
------------------------------------------------------------------------------------------------------------------------
GO

EXEC dbo.DropIfExist @ObjectName = 'update_user',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[update_user]
(
	@TrustId INT,
	@UserId INT,
	@Username VARCHAR(100),
	@Title VARCHAR(10),
	@Forename VARCHAR(100),
	@Surname VARCHAR(100),
	@Qualifications VARCHAR(30),
	@IsGI BIT,
	@JobTitleId INT,
	@RoleID VARCHAR(70),
	@CanRunAK BIT,
	@CanViewAllUserAudits BIT,
	@IsListConsultant BIT,
	@IsEndoscopist1 BIT,
	@IsEndoscopist2 BIT,
	@IsAssistantOrTrainee BIT,
	@IsNurse1 BIT,
	@IsNurse2 BIT,
	@Suppressed BIT,
	@ExpiresOn DATETIME,
	@ShowTooltips BIT,
	@GMCCode VARCHAR(50),
	@CanEditDropdowns BIT,
	@UpdateUserId INT,
	@CanOverbookLists BIT,
	@GeneralLibrary BIT,
	@CanOverrideSchedule BIT
)
AS

SET NOCOUNT ON

BEGIN TRANSACTION

BEGIN TRY
	UPDATE ERS_Users 
        SET Username=@Username, 
            LastUpdated=getdate(), 
            Title=@Title, 
			Forename=@Forename, 
			Surname=@Surname, 
            Qualifications = @Qualifications, 
            IsGIConsultant = @IsGI, 
            JobTitleID = @JobTitleId, 
            CanRunAK=@CanRunAK,
            CanViewAllUserAudits=@CanViewAllUserAudits,
            IsListConsultant=@IsListConsultant, 
			IsEndoscopist1=@IsEndoscopist1, 
			IsEndoscopist2=@IsEndoscopist2, 
            IsAssistantOrTrainee=@IsAssistantOrTrainee, 
			IsNurse1=@IsNurse1, 
			IsNurse2=@IsNurse2, 
            Suppressed=@Suppressed, 
			ExpiresOn=@ExpiresOn, 
			ShowTooltips=@ShowTooltips, 
			GMCCode=@GMCCode, 
			CanEditDropdowns = @CanEditDropdowns, 
		    GeneralLibrary = @GeneralLibrary, 
			CanOverbookLists = @CanOverbookLists,
			CanOverrideSchedule = @CanOverrideSchedule,
			WhoUpdatedId = ISNULL(@UpdateUserId, WhoUpdatedId), 
			WhenUpdated = GETDATE() 
        WHERE UserId=@UserId

		EXEC update_user_roles @UserId=@UserId, @TrustId=@TrustId,@TrustRolesToAdd=@RoleId

END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
	DECLARE @ErrorSeverity INT;
	DECLARE @ErrorState INT;

	SELECT	@ErrorMessage = ERROR_MESSAGE(),
			@ErrorSeverity = ERROR_SEVERITY(),
			@ErrorState = ERROR_STATE();
    
	RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;
GO


EXEC dbo.DropIfExist @ObjectName = 'get_user',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[get_user]
(
	@UserId INT,
	@TrustId INT
)
AS

BEGIN

	--Gather users Roles for user and current trust into temporary table
	DECLARE @RoleId VARCHAR(MAX)
	SELECT @RoleID = RoleID FROM ERS_Users WHERE UserID = @UserId
	SELECT [item] AS RoleId, r.RoleName INTO #tmpRoles FROM dbo.fnSplitString(@RoleId,','), ERS_Roles r WHERE [item] = r.RoleId  AND (r.TrustId = @TrustId OR r.TrustId IS NULL)

	--Get User and Comma seperated list of role names
	SELECT [UserID]
      ,[ExpiresOn]
      ,[Username]
      ,[Title]
      ,[Forename]
      ,[Surname]
      ,[Initials]
      ,[Qualifications]
      ,u.[JobTitleID]
      ,[RoleID]
      ,CanRunAK
      ,[IsListConsultant]
      ,[IsEndoscopist1]
      ,[IsEndoscopist2]
      ,[IsAssistantOrTrainee]
      ,[IsNurse1]
      ,[IsNurse2]
      ,[ResetPassword]
      ,u.[Suppressed] 
      ,[ShowTooltips]     
      ,[GMCCode]
      ,[CanEditDropdowns]
      ,[CanViewAllUserAudits]
      ,ISNULL([GeneralLibrary],0) AS GeneralLibrary,
	  jt.Description AS JobTitle,
	(SELECT SUBSTRING((SELECT ',' + CONVERT(VARCHAR(12),RoleName)
				  FROM #tmpRoles
				  ORDER BY CAST(RoleId AS NUMERIC(4,0)) ASC
				  for xml path('')),2,70)) AS Permissions
	  ,CanOverBookLists
	  ,ISNULL(CanOverrideSchedule,0) CanOverrideSchedule
	FROM ERS_Users u
	LEFT JOIN ERS_JobTitles jt ON u.JobTitleID = jt.JobTitleID
	WHERE UserId = @UserId
END
GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Adrian Schaal
-- TFS#			:	3208
-- Description of change
-- Tumours available on all Gastro procedure types
------------------------------------------------------------------------------------------------------------------------
GO
UPDATE dbo.ERS_AbnormalitiesMatrixERCP SET Tumour = 1 WHERE ProcedureType IN (2, 7)
UPDATE dbo.ERS_AbnormalitiesMatrixERCP SET TumourCommon = 1 WHERE AbnormalitiesMatrixERCPId IN (10, 39)

UPDATE dbo.ERS_AbnormalitiesMatrixAntegrade SET Tumour = 1 WHERE ProcedureType = 8
UPDATE dbo.ERS_AbnormalitiesMatrixRetrograde SET Tumour = 1 WHERE ProcedureType = 9
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	:	3208
------------------------------------------------------------------------------------------------------------------------
GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Chris Gammage 29/02/2024
-- TFS#	3551
-- Description of change
-- update GI schedlering therapeutics - EOA
------------------------------------------------------------------------------------------------------------------------
GO
INSERT INTO ERS_TherapeuticTypes (Description, NedName, SchedulerTherapeutic, Colon, Flexi)
SELECT 'EOA', 'None', 1, 1, 1
WHERE NOT EXISTS (
    SELECT 1
    FROM ERS_TherapeuticTypes
    WHERE Description = 'EOA'
	)

GO
	ALTER PROCEDURE [dbo].[GetTherapeuticTypes]
@procedureId AS int
AS

BEGIN

DECLARE @sqlString NVARCHAR(1000)

SELECT @sqlString =
'SELECT
[Id],
[Description],
[NedName],
[OGD],
[ERCP],
[Colon],
[Flexi],
[SchedulerTherapeutic],
[WhoUpdatedId],
[WhoCreatedId],
[WhenCreated],
[WhenUpdated],
[Proct],
[EUS],
[EUS_HPB],
[Antegrade],
[Retrograde],
[Bronchs],
[Cysto],
[Bronch_Flexi],
[Bronch_Rigid]
FROM
dbo.ERS_TherapeuticTypes
WHERE
[Id] NOT IN (1, 2) AND
[SchedulerTherapeutic] = 1'

IF @procedureId = 1
SELECT @sqlString = @sqlString + ' AND [OGD] = 1'
ELSE IF @procedureId = 2
SELECT @sqlString = @sqlString + ' AND [ERCP] = 1'
ELSE IF @procedureId = 3
SELECT @sqlString = @sqlString + ' AND [COLON] = 1'
ELSE IF @procedureId = 4
SELECT @sqlString = @sqlString + ' AND [FLEXI] = 1'
ELSE IF @procedureId = 5
SELECT @sqlString = @sqlString + ' AND [PROCT] = 1'
ELSE IF @procedureId = 6
SELECT @sqlString = @sqlString + ' AND [EUS] = 1'
ELSE IF @procedureId = 7
SELECT @sqlString = @sqlString + ' AND [EUS_HPB] = 1'
ELSE IF @procedureId = 8
SELECT @sqlString = @sqlString + ' AND [Antegrade] = 1'
ELSE IF @procedureId = 9
SELECT @sqlString = @sqlString + ' AND [Retrograde] = 1'
ELSE IF @procedureId IN (10, 11)
SELECT @sqlString = @sqlString + ' AND [Bronchs] = 1'
ELSE IF @procedureId IN (13,14)
SELECT @sqlString = @sqlString + ' AND [Cysto] = 1'


SELECT @sqlString = @sqlString + ' ORDER BY [Description]'

EXEC sp_executesql @sqlString

END
GO
 ------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea
-- TFS#	4082
-- Description of change
-- FIT Results toggle FIT indication
------------------------------------------------------------------------------------------------------------------------
GO

EXEC dbo.DropIfExist @ObjectName = 'procedure_fit_save',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO


CREATE PROCEDURE [dbo].[procedure_fit_save]
(
	@FITValue VARCHAR(50),
	@FITNotKnownId INT,
	@ProcedureId INT,
	@LoggedInUserId INT,
	@Selected BIT	
)
AS
BEGIN

	DECLARE @ReportSummaryText VARCHAR(MAX)

	IF @Selected = 1
	BEGIN
	    IF NOT EXISTS (SELECT 1 FROM ERS_ProcedureFitValue WHERE ProcedureId = @ProcedureId)
		BEGIN
			INSERT INTO ERS_ProcedureFitValue (FITValue, FITNotKnownId, ProcedureId, WhoCreatedId, WhenCreated)
			VALUES (@FITValue, NULLIF(@FITNotKnownId,0), @ProcedureId, @LoggedInUserId, GETDATE())
		END
		ELSE
		BEGIN
			UPDATE ERS_ProcedureFitValue	    
			SET FITValue = @FITValue,
				FITNotKnownId = NULLIF(@FITNotKnownId,0),
				WhoUpdatedId = @LoggedInUserId,
				WhenUpdated = GETDATE()
			WHERE ProcedureId = @ProcedureId
		END	

		EXEC dbo.UI_update_procedure_summary @ProcedureId = @ProcedureId,  -- int
		                                     @Section = 'FIT results',     -- varchar(200)
		                                     @Summary = 'FIT Result:',     -- varchar(max)
		                                     @ResultId = 1,     -- int
		                                     @EndoscopistId = NULL -- int
		
		SET @ReportSummaryText = 'FIT value ' + CASE WHEN @FITValue = '' THEN 'unknown because ' + (SELECT Description FROM ERS_FITNotKnownReasons WHERE UniqueId = @FITNotKnownId) + '.' ELSE (SELECT @FITValue for XML PATH ('')) END	
		DECLARE @AddIndication BIT, @FITIndicationId INT = (SELECT UniqueId FROM dbo.ERS_Indications WHERE NEDTerm = 'FIT positive')
	
		IF @FITValue = '' 
		BEGIN	
			IF @FITNotKnownId = (SELECT UniqueId FROM dbo.ERS_FitNotKnownReasons WHERE NEDTerm IN ('FIT (qualitative) positive', 'FIT carried out through Bowel Cancer Screening Program'))
            BEGIN
				SET @AddIndication = 1
            END
			ELSE
            BEGIN	
				SET @AddIndication = 0
			END
		END
		ELSE
		BEGIN
		    --check if fit contains < or > and remove if so
			IF CHARINDEX('<', @FITValue, 0) > 0 OR CHARINDEX('>', @FITValue, 0) > 0
			BEGIN
			    SET @FITValue = RIGHT(@FITValue,LEN(@FITValue)-1)
			END

			IF CONVERT(DECIMAL,@FITValue) > 0
			BEGIN
				SET @AddIndication = 1
			END
			ELSE
			BEGIN
				SET @AddIndication = 0
			END

		END
	END
	ELSE
	BEGIN	
		DELETE FROM ERS_ProcedureFitValue WHERE ProcedureId = @ProcedureId
		SET @AddIndication = 0

		SET @ReportSummaryText = NULL
	END

	IF @AddIndication = 1
	BEGIN
	    INSERT INTO dbo.ERS_ProcedureIndications
                (
                    ProcedureId,
                    IndicationId,
                    ChildIndicationId,
                    AdditionalInformation,
                    WhoCreatedId,
                    WhenCreated
                )
                VALUES
                (   @ProcedureId,       -- ProcedureId - int
                    @FITIndicationId,    
                    NULL,    
                    NULL,    
                    @LoggedInUserId,
                    GETDATE()
                )

				
		EXEC dbo.UI_update_procedure_summary @ProcedureId = @ProcedureId,  -- int
				                                @Section = 'Indications',     -- varchar(200)
				                                @Summary = 'Indications',     -- varchar(max)
				                                @ResultId = 1,     -- int
				                                @EndoscopistId = 0 -- int
	END
	ELSE 
	BEGIN
	    DELETE FROM dbo.ERS_ProcedureIndications WHERE @ProcedureId = @ProcedureId AND IndicationId = @FITIndicationId
		EXEC dbo.UI_update_procedure_summary @ProcedureId = @ProcedureId,  -- int
				                                @Section = 'Indications',     -- varchar(200)
				                                @Summary = 'Indications',     -- varchar(max)
				                                @ResultId = 0,     -- int
				                                @EndoscopistId = 0 -- int
	END

	IF EXISTS (SELECT 1 FROM dbo.ERS_ProceduresReporting WHERE ProcedureId = @ProcedureId)
	BEGIN
		UPDATE dbo.ERS_ProceduresReporting SET PP_FITResult = @ReportSummaryText WHERE ProcedureID = @ProcedureId
	END

	
	
END
GO



------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 20.06.24
-- TFS#	3198
-- Description of change
-- Edit multiple lists at once
------------------------------------------------------------------------------------------------------------------------
GO

SET QUOTED_IDENTIFIER ON
SET ANSI_NULLS ON
GO
ALTER PROCEDURE [dbo].[sch_diary_page_save]
(
	@DiaryIds VARCHAR(500),
	@Subject VARCHAR(500), 
	@DiaryStart datetime, 
	@DiaryEnd datetime, 
	@RoomID int, 
	@UserID int, 
	@RecurrenceFrequency varchar(500) = NULL, 
	@RecurrenceCount int = NULL, 
	@RecurrenceDay varchar(500) = NULL, 
	@RecurrencePeriod int = NULL, 
	@RecurrenceParentID int = NULL, 
	@ListRulesId int = NULL,
	@Description varchar(500) = NULL,
	@OperatingHospitalId INT = NULL,
	@LoggedInUserId int,
	@Training bit,
	@ListConsultant INT = NULL,
	@ListGenderId int,
	@IsGI bit = 1
)
AS
SET NOCOUNT ON

BEGIN TRANSACTION

BEGIN TRY
	if ISNULL(@DiaryIds,'') = ''
	begin
		INSERT INTO [ERS_SCH_DiaryPages] 
		([Subject], [DiaryStart], [DiaryEnd], [RoomID], [UserID], [ListRulesId], [OperatingHospitalId], [RecurrenceFrequency], [RecurrenceCount], [RecurrenceDay], [RecurrencePeriod], [RecurrenceParentID], [WhoCreatedId], [WhenCreated], [Training], [ListConsultantId], ListGenderId, IsGI) 
		SELECT @Subject, @DiaryStart, @DiaryEnd, @RoomId, @UserID, @ListRulesId, (SELECT r.HospitalId FROM ERS_SCH_Rooms r WHERE r.RoomId = @RoomID), @RecurrenceFrequency, @RecurrenceCount, @RecurrenceDay, @RecurrencePeriod, @RecurrenceParentID, @LoggedInUserId, GETDATE(), Training, NULLIF(@ListConsultant, 0), @ListGenderId, @IsGI  FROM ERS_SCH_ListRules WHERE ListRulesId = @ListRulesId
		
		SELECT SCOPE_IDENTITY ()
	end
	else
	begin
		update ERS_SCH_DiaryPages
		set [Subject] = @Subject,
			ListGenderId = @ListGenderId,
			UserID = @UserID,
			ListConsultantId = NULLIF(@ListConsultant,0),
			DiaryStart = CONVERT(VARCHAR(10), DiaryStart, 111) + ' ' + CONVERT(VARCHAR(8), @DiaryStart, 108),
			DiaryEnd = CONVERT(VARCHAR(10), DiaryEnd, 111) + ' ' + CONVERT(VARCHAR(8), dbo.fnSCH_DiaryEnd(ListRulesId, @DiaryStart), 108),
			Training = @Training,
			WhoUpdatedId = @LoggedInUserId,
			WhenUpdated = getdate()
		where DiaryId IN (SELECT Item FROM dbo.fnSplitString(@DiaryIds, ','))

		
		IF EXISTS (SELECT 1 FROM ERS_Appointments WHERE DiaryId IN (SELECT Item FROM dbo.fnSplitString(@DiaryIds, ',')))
			UPDATE dbo.ERS_Appointments SET EndoscopistId = @UserID WHERE DiaryId IN (SELECT Item FROM dbo.fnSplitString(@DiaryIds, ','))

		SELECT 0
	end
END TRY

BEGIN CATCH
       DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

       IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH

IF @@TRANCOUNT > 0 COMMIT TRANSACTION;

GO

EXEC dbo.DropIfExist @ObjectName = 'sch_get_diary_details',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[sch_get_diary_details]
(
	@DiaryId INT
)
AS
	--TFS 3198 Andrea 20.06.24 RecurrenceParentId returned
	
	SELECT DISTINCT
		d.DiaryId,
		d.DiaryStart, 
		d.[DiaryEnd],
		d.[UserID], 
		d.ListConsultantId,
		d.[RoomID], 
		d.ListRulesId, 
		d.suppressed,
		d.Training,
		d.Subject,
		d.UserId EndoscopistId,
		d.ListConsultantId,
		d.OperatingHospitalId,
		(CASE WHEN  ISNULL(u.Title,'') <> '' THEN u.Title + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(u.Forename,'') <> '' THEN u.Forename + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(u.Surname,'') <> '' THEN u.Surname + ' ' ELSE '' END) as EndoscopistName,
	  (CASE WHEN  ISNULL(c.Title,'') <> '' THEN c.Title + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(c.Forename,'') <> '' THEN c.Forename + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(c.Surname,'') <> '' THEN c.Surname + ' ' ELSE '' END) as ListConsultant,
	  ls.TotalMinutes,
	  ls.TotalPoints,
	  ls.OverBookedPoints,
	  ISNULL(d.Notes,'') Notes,
	  d.ListGenderId,
	  ISNULL(g.Title,'') ListGender,
	  IsGI,
	  d.Locked,
	  CASE WHEN (SELECT count(a.AppointmentId) FROM ERS_Appointments a LEFT JOIN dbo.ERS_AppointmentStatus s ON s.UniqueId = a.AppointmentStatusId WHERE DiaryId = @DiaryId AND ISNULL(s.HDCKEY,'') NOT IN ('C', 'BS','E','H')) > 0 THEN convert(bit,1) ELSE convert(bit,0) END Appointments,
	  ISNULL((SELECT sum(pt.points) FROM ERS_AppointmentProcedureTypes pt INNER JOIN ERS_Appointments a ON a.AppointmentId = pt.AppointmentID LEFT JOIN dbo.ERS_AppointmentStatus s ON s.UniqueId = a.AppointmentStatusId WHERE DiaryId = @DiaryId AND ISNULL(s.HDCKEY,'') NOT IN ('C','BS','E','H')),0) AppointmentPoints,
	  ISNULL((SELECT sum(pt.Minutes) FROM ERS_AppointmentProcedureTypes pt INNER JOIN ERS_Appointments a ON a.AppointmentId = pt.AppointmentID LEFT JOIN dbo.ERS_AppointmentStatus s ON s.UniqueId = a.AppointmentStatusId WHERE DiaryId = @DiaryId AND ISNULL(s.HDCKEY,'') NOT IN ('C','E','H')),0) TotalUsedMinutes,
	  ISNULL((SELECT sum(pt.points) FROM ERS_AppointmentProcedureTypes pt INNER JOIN ERS_Appointments a ON a.AppointmentId = pt.AppointmentID LEFT JOIN dbo.ERS_AppointmentStatus s ON s.UniqueId = a.AppointmentStatusId WHERE DiaryId = @DiaryId AND ISNULL(s.HDCKEY,'') = 'BS'),0) BlockedPoints,
	  CASE WHEN (SELECT count(a.AppointmentId) FROM ERS_Appointments a LEFT JOIN dbo.ERS_AppointmentStatus s ON s.UniqueId = a.AppointmentStatusId WHERE DiaryId = @DiaryId AND ISNULL(s.HDCKEY,'') = 'C') > 0 THEN convert(bit,1) ELSE convert(bit,0) END CancelledAppointments,
	  CASE WHEN ISNULL(RecurrenceParentID, 0) > 0 THEN convert(bit,1) ELSE convert(bit,0) END Recurring,
	  CASE WHEN ISNULL(RecurrenceParentID, 0) > 0 THEN 
		CASE RecurrenceFrequency WHEN 'd' THEN 'daily for ' + convert(varchar(10), RecurrenceCount) + ' day(s)'
							     WHEN 'w' THEN 'weekly for ' + convert(varchar(10), RecurrenceCount) + ' week(s)' 
								 when 'm' THEN 'montly for ' + convert(varchar(10), RecurrenceCount) + ' month(s)' 
		END 
	  END RecurrancePattern,
	  ISNULL(RecurrenceParentID,0) RecurrenceParentID,
	  DATEDIFF(MINUTE, d.DiaryStart, d.DiaryEnd) ListMinutes
	FROM ERS_SCH_DiaryPages d
		INNER JOIN ERS_Users u ON u.UserID = d.UserId
		LEFT JOIN ERS_Users c ON c.UserID = d.ListConsultantId
		INNER JOIN (SELECT ls.ListRulesId, (SUM(Points) - SUM(CONVERT(DECIMAL, IsOverBookedSlot))) TotalPoints, SUM(CONVERT(DECIMAL, IsOverBookedSlot)) OverBookedPoints, SUM(SlotMinutes) TotalMinutes FROM ERS_SCH_ListSlots ls WHERE ls.Active = 1 GROUP BY ListRulesId) ls ON ls.ListRulesId = d.ListRulesId
		LEFT JOIN ERS_GenderTypes g on g.GenderId = d.ListGenderId
	WHERE d.DiaryId = @DiaryId
GO

SET QUOTED_IDENTIFIER ON
SET ANSI_NULLS ON
GO

EXEC dbo.DropIfExist @ObjectName = 'sch_get_endoscopists_diaries',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE dbo.sch_get_endoscopists_diaries
(
	@EndoscopistId INT,
	@StartDate DATETIME,
	@EndDate DATETIME
)
AS
BEGIN
	SELECT 
		dp.DiaryId, 
		dp.Subject, 
		dp.DiaryStart, 
		dp.DiaryEnd, 
		dp.UserID, 
		dp.RoomID, 
		r.RoomName,
		dp.ListRulesId, 
		dp.OperatingHospitalId, 
		dp.Training, 
		dp.ListConsultantId, 
		dp.ListGenderId, 
		dp.Notes, 
		dp.IsGI, 
		dp.Locked, 
		dp.RecurrenceParentID, 
		dp.RecurrenceFrequency, 
		dp.RecurrenceCount, 
		dp.RecurrenceDay, 
		dp.RecurrencePeriod 
	FROM dbo.ERS_SCH_DiaryPages dp 
		INNER JOIN dbo.ERS_SCH_Rooms r ON r.RoomId = dp.RoomID
	WHERE dp.UserID = @EndoscopistId 
	  AND dp.DiaryStart>= @StartDate 
	  AND dp.DiaryStart < @EndDate
	  AND dp.Suppressed = 0
END
GO



SET QUOTED_IDENTIFIER ON
SET ANSI_NULLS ON
GO
EXEC dbo.DropIfExist @ObjectName = 'sch_get_recurring_lists',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO


CREATE PROCEDURE [dbo].[sch_get_recurring_lists]
(
	@DiaryId INT,
	@DiaryDate DATETIME
)
AS

	SELECT DISTINCT
		d.DiaryId,
		d.DiaryStart, 
		d.[DiaryEnd],
		d.[UserID], 
		d.ListConsultantId,
		d.[RoomID], 
		d.ListRulesId, 
		d.Training,
		d.Subject,
		d.UserId EndoscopistId,
		d.ListConsultantId,
		(CASE WHEN  ISNULL(u.Title,'') <> '' THEN u.Title + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(u.Forename,'') <> '' THEN u.Forename + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(u.Surname,'') <> '' THEN u.Surname + ' ' ELSE '' END) AS EndoscopistName,
	  (CASE WHEN  ISNULL(c.Title,'') <> '' THEN c.Title + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(c.Forename,'') <> '' THEN c.Forename + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(c.Surname,'') <> '' THEN c.Surname + ' ' ELSE '' END) as ListConsultant,
	  ISNULL(d.Notes,'') Notes,
	  d.ListGenderId,
	  ISNULL(g.Title,'') ListGender,
	  IsGI,
	  d.Locked,
	  CASE WHEN (SELECT count(a.AppointmentId) FROM ERS_Appointments a LEFT JOIN dbo.ERS_AppointmentStatus s ON s.UniqueId = a.AppointmentStatusId WHERE DiaryId = d.DiaryId AND ISNULL(s.HDCKEY,'') NOT IN ('C', 'BS','E','H')) > 0 THEN convert(bit,1) ELSE convert(bit,0) END Appointments
	FROM ERS_SCH_DiaryPages d
		INNER JOIN ERS_Users u ON u.UserID = d.UserId
		LEFT JOIN ERS_Users c ON c.UserID = d.ListConsultantId
		LEFT JOIN ERS_GenderTypes g on g.GenderId = d.ListGenderId

	WHERE d.RecurrenceParentID = @DiaryId
		AND ISNULL(RecurrenceFrequency,'') <> '' AND d.DiaryStart > @DiaryDate
GO


SET QUOTED_IDENTIFIER ON
SET ANSI_NULLS ON
GO

EXEC dbo.DropIfExist @ObjectName = 'sch_get_diaries_by_dates',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE [dbo].[sch_get_diaries_by_dates]
(
	@OperatingHospitalID INT,
	@DiaryDates VARCHAR(MAX)
)
AS
	SELECT DISTINCT
		d.DiaryId,
		d.DiaryStart,
		CASE WHEN (SELECT MAX(DATEADD(MINUTE, CONVERT(int, ersa.AppointmentDuration), StartDateTime)) FROM ERS_Appointments ersa WHERE ersa.DiaryId = d.DiaryId) > d.DiaryEnd THEN (SELECT MAX(DATEADD(MINUTE, CONVERT(int, ersa.AppointmentDuration), StartDateTime)) FROM ERS_Appointments ersa WHERE ersa.DiaryId = d.DiaryId) ELSE d.DiaryEnd END AS DiaryEnd,
		d.[DiaryEnd] ActualDiaryEnd,
		d.[UserID], 
		d.[RoomID], 
		d.ListRulesId, 
		s.SlotMinutes AS [Minutes],
		CASE WHEN ept.ProcedureType IS NULL THEN ss.Description 
		ELSE 'Reserved for ' + ss.Description + ' '+ ept.ProcedureType END AS [Subject],
		ss.Description,
		ISNULL(s.ProcedureTypeID,0) AS ProcedureTypeID,
		s.ListSlotId,
		ss.ForeColor,
		ss.StatusId,
		ISNULL(s.Points, 1) AS Points,
		ISNULL(l.Endoscopist,0) AS EndoscopistId,
		(CASE WHEN  ISNULL(u.Title,'') <> '' THEN u.Title + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(u.Forename,'') <> '' THEN u.Forename + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(u.Surname,'') <> '' THEN u.Surname + ' ' ELSE '' END) as EndoscopistName,
	  (CASE WHEN  ISNULL(c.Title,'') <> '' THEN c.Title + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(c.Forename,'') <> '' THEN c.Forename + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(c.Surname,'') <> '' THEN c.Surname + ' ' ELSE '' END) as ListConsultant,
		l.ListName,
		(CASE WHEN  ISNULL(u.Title,'') <> '' THEN u.Title + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(u.Forename,'') <> '' THEN u.Forename + ' ' ELSE '' END +
	  CASE WHEN  ISNULL(u.Surname,'') <> '' THEN u.Surname + ' ' ELSE '' END) +
	  '  [' + CONVERT(VARCHAR(5),cast(d.DiaryStart as time)) + '-' + CONVERT(VARCHAR(5),cast(d.[DiaryEnd] as time)) + ']' +
	  CASE WHEN  ISNULL(l.Points,0) <> 0 THEN '  [' + CONVERT(VARCHAR, l.Points) + ' slots]' ELSE '' END  AS ListDescription
		,d.suppressed
		,d.SuppressedFromDate
		,d.Training
		,l.GIProcedure
		,ISNULL(apt.AppointmentId, 0) AppointmentId
		,apt.StartDateTime AppointmentStart
		,ISNULL(apt.TotalPoints,0) AppointmentPoints
		,ISNULL(apt.AppointmentDuration,0) AppointmentDuration
		,DATEADD(minute, convert(int, apt.AppointmentDuration), apt.StartDateTime) AppointmentEnd
		,ISNULL(apt.StatusCode,'') AppointmentStatusCode
		,ISNULL(apt.Notes,'') AppointmentNotes
		,p.HospitalNumber + ' - ' + p.Forename1 + ' ' + p.Surname + '<br />' + apt.Description AS [AppointmentSubject]
		,STUFF(REPLACE(apt.Procs, CHAR(10), '+'), LEN(apt.procs),1,'') AS [AppointmentProcedures]
		,ISNULL(apt.GeneralInformation, '') GeneralInformation
		,CASE WHEN apt.AppointmentId IS NULL THEN s.Locked ELSE CASE WHEN ISNULL(apt.StatusCode,'') = 'BS' THEN 1 ELSE 0 END END AS Locked
		,d.OperatingHospitalId
		,ISNULL(d.RecurrenceParentID,0)RecurrenceParentID
		,ISNULL(d.locked,0) LockedDiary
		,r.RoomName
		,apt.StaffBooked
		,apt.DateBooked
		,d.RoomID
	FROM ERS_SCH_DiaryPages d
		INNER JOIN dbo.ERS_SCH_Rooms r ON r.RoomId = d.RoomID
		INNER JOIN ERS_SCH_ListRules l ON l.ListRulesId = d.ListRulesId
		INNER JOIN ERS_SCH_ListSlots s ON d.ListRulesId = s.ListRulesId AND s.Active = 1
		INNER JOIN dbo.ERS_SCH_SlotStatus ss ON ss.StatusId = s.SlotId
		LEFT JOIN dbo.ERS_ProcedureTypes ept ON s.ProceduretypeId = ept.ProcedureTypeId
		LEFT JOIN ERS_Users u ON u.UserID = d.UserId
		LEFT JOIN ERS_Users c ON c.UserID = d.ListConsultantId
		LEFT JOIN (SELECT ea.AppointmentId, SUM(eapt.Points) AS TotalPoints, SUM(eapt.Minutes) AS TotalMinutes, ea.ListSlotId, ea.DiaryId, 
					MAX(aps.HDCKEY) StatusCode, ass.Description, ea.PatientId, ea.GeneralInformation, ea.Notes, ea.AppointmentDuration,ea.StartDateTime,
					ISNULL(usr.Forename + ' ' + usr.Surname, '') AS StaffBooked, DateEntered as DateBooked,
						(SELECT
							AppointmentProcedures + char(10) AS [text()] 
						FROM dbo.SCH_AppointmentProcedures(ea.AppointmentId)
						WHERE AppointmentId = ea.AppointmentId
						FOR XML PATH('')) AS procs
					FROM dbo.ERS_Appointments ea
						INNER JOIN dbo.ERS_AppointmentProcedureTypes eapt ON ea.AppointmentId = eapt.AppointmentID
						INNER JOIN dbo.ERS_SCH_SlotStatus ass ON ea.SlotStatusID = ass.StatusId
						LEFT JOIN ERS_AppointmentStatus aps on aps.UniqueId = ea.AppointmentStatusId
						LEFT JOIN dbo.ERS_Users usr ON usr.UserID = ea.StaffBookedId
					 WHERE ISNULL(aps.HDCKEY,'') NOT IN ('C')
					GROUP BY ea.AppointmentId, ea.ListSlotId, ea.DiaryId, ass.Description, ea.PatientId,ea.GeneralInformation, ea.Notes, ea.AppointmentDuration,ea.StartDateTime, usr.Forename,usr.Surname, DateEntered) AS apt 
											ON apt.DiaryId = d.DiaryId and  apt.ListSlotId = s.ListSlotId
		LEFT JOIN ERS_Patients p ON p.patientId = apt.PatientId
	WHERE d.OperatingHospitalId = @OperatingHospitalID AND 
		  CONVERT(varchar(10), DiaryStart, 103) IN (SELECT Item FROM dbo.fnSplitString(@DiaryDates, ','))
	ORDER BY d.DiaryId, apt.StartDateTime, s.ListSlotId

GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Steve 20/06/24
-- TFS#	
-- 2.24.02 Issues Spreadsheet Row 19
-- Description of change
--	Lesion, diagnoses is not showing
--	
--  Created new Stored Procedure to update polyp diagnosies - common_polyp_diagnosis_update
--	Removed polyp diagnosis updates from abnormalities_common_lesions_save
--	Removed polyp diagnosis updates from TR_CommonAbnoLesions
------------------------------------------------------------------------------------------------------------------------
GO
EXEC dbo.DropIfExist 
    @ObjectName = 'common_polyp_diagnosis_update', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].common_polyp_diagnosis_update
(
	@SiteId int
)
AS

DECLARE @Polyp VARCHAR(10) = 'False',
		@Region VARCHAR(20), 
		@ProcedureTypeId INT = (SELECT TOP 1 p.ProcedureType FROM ERS_Sites s INNER JOIN ERS_Procedures p ON p.ProcedureId = s.ProcedureId WHERE s.SiteId = @SiteId), 
		@FocalLesions VARCHAR(10) = 'False',
		@SubmucoaslLesion VARCHAR(10) = 'False',
		@FundicGlandPolyp VARCHAR(10) = 'False',
		@MatrixCode VARCHAR(50)

BEGIN TRANSACTION

BEGIN TRY
	SELECT	@Polyp = (CASE WHEN ISNULL(COUNT(PolypTypeId),0) > 0 THEN 'True' ELSE 'False' END),
			@FocalLesions = (CASE WHEN (ISNULL(MAX(FocalQuantity),0) = 1) THEN 'True' ELSE 'False' END),
			@SubmucoaslLesion = (CASE WHEN (ISNULL(MAX(SubmucosalQuantity),0) = 1) THEN 'True' ELSE 'False' END),
			@FundicGlandPolyp = (CASE WHEN (ISNULL(MAX(FundicGlandPolypQuantity),0) = 1) THEN 'True' ELSE 'False' END),
			@Region = dbo.fnSiteRegion(@SiteId)
	FROM ERS_CommonAbnoPolypDetails
	WHERE SiteId = @SiteId
	GROUP BY SiteId
		
	IF (@Polyp = 'True')
	BEGIN
		IF @ProcedureTypeId IN (1,6,8)
		BEGIN
			IF LOWER(@Region) = 'stomach'
				SET @MatrixCode = 'D40P1'
			ELSE IF LOWER(@Region) = 'oesophagus'
				SET @MatrixCode = 'N2013'
			ELSE IF LOWER(@Region) = 'duodenum'
				SET @MatrixCode = 'D58P1'
			ELSE IF LOWER(@Region) = 'colon'
				SET @MatrixCode = 'D58P1'				
		END
		ELSE IF @ProcedureTypeId IN (3,4,9)
		BEGIN
			IF @Region IN ('Rectum', 'Anal Margin')
				SET @MatrixCode = 'D4P3'
			ELSE IF @Region IN ('Terminal Ileum', 'Neo-Terminal Ileum')
				SET @MatrixCode = 'DIPOLYPP3'
			ELSE
				SET @MatrixCode = 'D12P3'
		END
	END


	IF @SiteId IS NOT NULL AND @ProcedureTypeId IN (1,3,4,6,8,9)
	BEGIN
		EXEC sites_summary_update @SiteId

		EXEC diagnoses_control_save @SiteId, @MatrixCode, @Polyp
			
		EXEC diagnoses_control_save @SiteId, 'N2001', @FocalLesions
		EXEC diagnoses_control_save @SiteId, 'N2002', @SubmucoaslLesion
		EXEC diagnoses_control_save @SiteId, 'N2019', @FundicGlandPolyp
	END

	EXEC abnormalities_common_lesions_summary_update @SiteId
END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;


GO
EXEC dbo.DropIfExist 
    @ObjectName = 'abnormalities_common_lesions_save', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[abnormalities_common_lesions_save]
(
	@SiteId int,
	@None bit,
	@Polyp bit,
	@PolypTypeId int,
	@Tattooed bit,
	@PreviouslyTattooed bit,
	@TattooType int,
	@TattooedQuantity int,
	@TattooedBy int,
	@Submucosal bit,
	@SubmucosalQuantity int,
	@SubmucosalLargest int,
	@SubmucosalProbably bit,
	@SubmucosalTumourTypeId int,
	@Focal bit,
	@FocalQuantity int,
	@FocalLargest int,
	@FocalProbably bit,
	@FocalTumourTypeId int,
	@FundicGlandPolyp BIT,
	@FundicGlandPolypQuantity INT,
	@FundicGlandPolypLargest numeric(18,2),
	@PreviousESDScar BIT,
	@LoggedInUserId int
)
AS

SET NOCOUNT ON

DECLARE @proc_id INT
DECLARE @proc_type INT
DECLARE @Insert BIT = 0

BEGIN TRANSACTION

BEGIN TRY
	SELECT 
		@proc_id = p.ProcedureId,
		@proc_type = p.ProcedureType
	FROM 
		ERS_Sites s
	JOIN 
		ERS_Procedures p ON s.ProcedureId = p.ProcedureId
	WHERE 
		SiteId = @SiteId
	

	IF (@PreviousESDScar = 0)
	BEGIN
		IF EXISTS (SELECT 1 FROM [ERS_CommonAbnoLesions] WHERE SiteId = @SiteId)
		BEGIN
			DELETE FROM [ERS_CommonAbnoLesions] 
			WHERE SiteId = @SiteId

			DELETE FROM ERS_RecordCount 
			WHERE SiteId = @SiteId
			AND Identifier = 'Lesions'

			EXEC abnormalities_common_lesions_summary_update @SiteId

			IF @SiteId IS NOT NULL AND @proc_type IN (1,2,3,4,6,7,8,9)
			BEGIN
				EXEC sites_summary_update @SiteId

				IF @proc_type IN (1,6,8)
				BEGIN
					EXEC diagnoses_control_save @SiteId, 'DSESDSCARP1', @PreviousESDScar		
				END
				ELSE IF @proc_type IN (2,7)
				BEGIN
					EXEC diagnoses_control_save @SiteId, 'DDESDSCARP2', @PreviousESDScar
				END
				ELSE IF @proc_type IN (3,9)
				BEGIN
					EXEC diagnoses_control_save @SiteId, 'DESDSCARP3', @PreviousESDScar
				END
				ELSE IF @proc_type = 4
				BEGIN
					EXEC diagnoses_control_save @SiteId, 'SESDSCARP3', @PreviousESDScar
				END
			END
		END
	END

	ELSE IF NOT EXISTS (SELECT 1 FROM [ERS_CommonAbnoLesions] WHERE SiteId = @SiteId)
	BEGIN
		INSERT INTO [ERS_CommonAbnoLesions] (
			[SiteId],
			[None],
			[Polyp],
			[PolypTypeId],
			[Tattooed],
			[PreviouslyTattooed],
			[TattooType],
			[TattooedQuantity],
			[TattooedBy],
			[Submucosal],
			[SubmucosalQuantity],
			[SubmucosalLargest],
			[SubmucosalProbably],
			[SubmucosalTumourTypeId],
			[Focal],
			[FocalQuantity],
			[FocalLargest],
			[FocalProbably],
			[FocalTumourTypeId],
			[Granuloma],
			[Dysplastic],
			[PneumatosisColi],
			FundicGlandPolyp,
			FundicGlandPolypQuantity,
			FundicGlandPolypLargest,
			PreviousESDScar,
			[WhoCreatedId],
			[WhenCreated]) 
		VALUES (
			@SiteId,
			@None,
			@Polyp,
			@PolypTypeId,
			@Tattooed,
			@PreviouslyTattooed,
			@TattooType,
			@TattooedQuantity,
			@TattooedBy,
			@Submucosal,
			@SubmucosalQuantity,
			@SubmucosalLargest,
			@SubmucosalProbably,
			@SubmucosalTumourTypeId,
			@Focal,
			@FocalQuantity,
			@FocalLargest,
			@FocalProbably,
			@FocalTumourTypeId,
			0,
			0,
			0,
			@FundicGlandPolyp,
			@FundicGlandPolypQuantity,
			@FundicGlandPolypLargest,
			@PreviousESDScar,
			@LoggedInUserId,
			GETDATE())

		INSERT INTO ERS_RecordCount (
			[ProcedureId],
			[SiteId],
			[Identifier],
			[RecordCount]
		)
		VALUES (
			@proc_id,
			@SiteId,
			'Lesions',
			1)

			SET @Insert = 1
	END

	ELSE
	BEGIN
		UPDATE 
			[ERS_CommonAbnoLesions]
		SET 
			[None]=@None,
			Polyp=@Polyp,
			PolypTypeId = @PolypTypeId,
			Tattooed=@Tattooed,
			PreviouslyTattooed=@PreviouslyTattooed,
			TattooType=@TattooType,
			TattooedQuantity=@TattooedQuantity,
			TattooedBy=@TattooedBy,
			Submucosal=@Submucosal,
			SubmucosalQuantity=@SubmucosalQuantity,
			SubmucosalLargest=@SubmucosalLargest,
			SubmucosalProbably=@SubmucosalProbably,
			SubmucosalTumourTypeId=@SubmucosalTumourTypeId,
			Focal=@Focal,
			FocalQuantity=@FocalQuantity,
			FocalLargest=@FocalLargest,
			FocalProbably=@FocalProbably,
			FocalTumourTypeId=@FocalTumourTypeId,
			FundicGlandPolyp = @FundicGlandPolyp,
			FundicGlandPolypQuantity = @FundicGlandPolypQuantity,
			FundicGlandPolypLargest = @FundicGlandPolypLargest,
			PreviousESDScar = @PreviousESDScar,
			WhoUpdatedId = @LoggedInUserId,
			WhenUpdated = GETDATE()
		WHERE 
			SiteId = @SiteId
	END

END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;

GO
EXEC dbo.DropIfExist 
    @ObjectName = 'TR_CommonAbnoLesions', 
    @ObjectTypePrefix = 'TR' 
GO

CREATE TRIGGER [dbo].[TR_CommonAbnoLesions]
	ON [dbo].[ERS_CommonAbnoLesions]
	AFTER INSERT, UPDATE, DELETE
	AS 
		DECLARE @site_id INT,
				@PreviousESDScar VARCHAR(10) = 'False',
				@ProcedureTypeId INT
	
		IF EXISTS(SELECT * FROM INSERTED)


		BEGIN
		
			SELECT @site_id = SiteId,
				   @PreviousESDScar = (CASE WHEN (ISNULL(PreviousESDScar,0) = 1) THEN 'True' ELSE 'False' END)
				
			FROM INSERTED

			SELECT TOP 1 @ProcedureTypeId =  p.ProcedureType FROM ERS_Sites s INNER JOIN ERS_Procedures p ON p.ProcedureId = s.ProcedureId WHERE s.SiteId = @site_id

		END
		ELSE
		BEGIN
			SELECT @site_id=SiteId FROM DELETED
		END

		EXEC abnormalities_common_lesions_summary_update @site_id

		IF @site_id IS NOT NULL AND @ProcedureTypeId IN (1,2,3,4,6,7,8,9)
		BEGIN
			EXEC sites_summary_update @site_id

			IF @ProcedureTypeId IN (1,6,8)
			BEGIN
			    EXEC diagnoses_control_save @site_id, 'DSESDSCARP1', @PreviousESDScar		
			END
			ELSE IF @ProcedureTypeId IN (2,7)
			BEGIN
				EXEC diagnoses_control_save @site_id, 'DDESDSCARP2', @PreviousESDScar
			END
			ELSE IF @ProcedureTypeId IN (3,9)
			BEGIN
				EXEC diagnoses_control_save @site_id, 'DESDSCARP3', @PreviousESDScar
			END
			ELSE IF @ProcedureTypeId = 4
			BEGIN
				EXEC diagnoses_control_save @site_id, 'SESDSCARP3', @PreviousESDScar
			END
		END

GO

EXEC dbo.DropIfExist 
    @ObjectName = 'abnormalities_common_polyp_details_save', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[abnormalities_common_polyp_details_save]
(
		@SiteId int,
		@Size int,
		@Excised bit,
		@Retreived BIT,
		@Discarded BIT,--newly added for 4069
		@Successful bit,
		@Labs bit,
		@Removal int,
		@RemovalMethod int,
		@Probably bit,
		@TumorTypeId int,
		@ParisClass int,
		@PitPattern int, 
		@Infammatory bit,
		@PostInflammatory bit,
		@TattooedId int,
		@TattooMarkingTypeId int,
		@PolypConditionIds varchar(500),
		@PolypTypeId int,
		@TattooLocationDistal bit,
		@TattooLocationProximal bit,
		@SubmucosalQuantity int, --newly added for 4069
		@SubmucosalLargest int, 
		@FocalQuantity int,
		@FocalLargest int,
		@FundicGlandPolypQuantity int,
		@FundicGlandPolypLargest decimal(18,6), --newly added for 4069
		@LoggedInUserId int
)
AS

BEGIN TRANSACTION

BEGIN TRY
	DECLARE @PolypDetailsId int
	
	INSERT INTO ERS_CommonAbnoPolypDetails (
		SiteId,
		Size,
		Excised,
		Retreived,
		Discarded, --newly added for 4069
		Successful,
		Labs,
		Removal,
		RemovalMethod,
		Probably,
		Type,
		ParisClass,
		PitPattern, 
		Infammatory,
		PostInflammatory,
		TattooedId,
		TattooedMarkingTypeId,
		PolypTypeId,
		TattooLocationDistal,
		TattooLocationProximal,
		SubmucosalQuantity, --newly added for 4069
		SubmucosalLargest, 
		FocalQuantity,
		FocalLargest,
		FundicGlandPolypQuantity,
		FundicGlandPolypLargest ) --newly added for 4069
	VALUES(
		@SiteId,
		@Size,
		@Excised,
		@Retreived,
		@Discarded, --newly added for 4069
		@Successful,
		@Labs,
		@Removal,
		@RemovalMethod,
		@Probably,
		@TumorTypeId,
		@ParisClass,
		@PitPattern, 
		@Infammatory,
		@PostInflammatory,
		@TattooedId,
		@TattooMarkingTypeId,
		@PolypTypeId,
		@TattooLocationDistal,
		@TattooLocationProximal, 
		@SubmucosalQuantity, --newly added for 4069
		@SubmucosalLargest, 
		@FocalQuantity,
		@FocalLargest,
		@FundicGlandPolypQuantity,
		@FundicGlandPolypLargest) --newly added for 4069

	SELECT @PolypDetailsId = Scope_Identity()

	DELETE FROM ERS_CommonAbnoPolypConditions WHERE PolypDetailId = @PolypDetailsId

	INSERT INTO ERS_CommonAbnoPolypConditions (PolypDetailId, PolypConditionId)
	SELECT @PolypDetailsId, Item FROM fnSplitString(@PolypConditionIds,',')

	--Update Diagnosis
	EXEC common_polyp_diagnosis_update @SiteId

	--summary
	UPDATE ERS_CommonAbnoPolypDetails SET Summary =REPLACE(dbo.common_polpydetails_summary(@SiteId, @PolypDetailsId),'#','' ) WHERE PolypDetailId = @PolypDetailsId --newly added for 4069

END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;


GO
EXEC dbo.DropIfExist 
    @ObjectName = 'abnormalities_common_polyp_details_update', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[abnormalities_common_polyp_details_update] --newly added for 4069
(
    @PolypDetailId INT,
    @SiteId INT,
    @Size INT,
    @Excised BIT,
    @Retreived Bit,
	@Discarded bit,
    @Successful BIT,
    @Labs BIT,
    @Removal INT,
    @RemovalMethod INT,
    @Probably bit,
    @Type INT,
    @ParisClass INT,
    @PitPattern INT,
    @Infammatory BIT,
    @PostInflammatory BIT,
	@PolypConditionIds varchar(500),--new added
    @TattooedId INT,
    @TattooMarkingTypeId INT,
    @TattooLocationDistal BIT,
    @TattooLocationProximal BIT,
    @SubmucosalQuantity INT,
    @SubmucosalLargest INT,
    @FocalQuantity INT,
    @FocalLargest INT,
    @FundicGlandPolypQuantity INT,
    @FundicGlandPolypLargest  decimal(18,6),
    @PolypTypeId INT
)
AS
BEGIN
    UPDATE ERS_CommonAbnoPolypDetails
    SET
        Size = @Size,
        Excised = @Excised,
        Retreived = @Retreived,
		Discarded=@Discarded,
        Successful = @Successful,
        Labs = @Labs,
        Removal = @Removal,
        RemovalMethod = @RemovalMethod,
        Probably = @Probably,
        Type = @Type,
        ParisClass = @ParisClass,
        PitPattern = @PitPattern,
        Infammatory = @Infammatory,
        PostInflammatory = @PostInflammatory,
        TattooedId = @TattooedId,
        TattooedMarkingTypeId = @TattooMarkingTypeId,
        TattooLocationDistal = @TattooLocationDistal,
        TattooLocationProximal = @TattooLocationProximal,
        SubmucosalQuantity = @SubmucosalQuantity,
        SubmucosalLargest = @SubmucosalLargest,
        FocalQuantity = @FocalQuantity,
        FocalLargest = @FocalLargest,
        FundicGlandPolypQuantity = @FundicGlandPolypQuantity,
        FundicGlandPolypLargest = @FundicGlandPolypLargest,
        PolypTypeId = @PolypTypeId
    WHERE PolypDetailId = @PolypDetailId AND SiteId = @SiteId

	--new added 
	DELETE FROM ERS_CommonAbnoPolypConditions WHERE PolypDetailId = @PolypDetailId

	INSERT INTO ERS_CommonAbnoPolypConditions (PolypDetailId, PolypConditionId)
	SELECT @PolypDetailId, Item FROM fnSplitString(@PolypConditionIds,',')

	--Update Diagnosis
	EXEC common_polyp_diagnosis_update @SiteId

	--summary
	UPDATE ERS_CommonAbnoPolypDetails SET Summary = REPLACE(dbo.common_polpydetails_summary(@SiteId, @PolypDetailId),'#','' )  WHERE PolypDetailId = @PolypDetailId
	--new added 
END

GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
-- 2.24.02 Issues Spreadsheet Row 19
------------------------------------------------------------------------------------------------------------------------
GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Steve 20/06/24
-- TFS#	3597
-- Description of change
--  Updated to check Polyp Size is 20 or greater for tattoo Description to be shown in Polyp details.
------------------------------------------------------------------------------------------------------------------------
GO
EXEC dbo.DropIfExist 
    @ObjectName = 'abnormalities_common_polyp_details_select', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[abnormalities_common_polyp_details_select]
(
	@SiteId INT
)
AS
BEGIN
	SELECT 
		PolypDetailId,
		ISNULL(t.Description ,'') AS PolypType,
		d.SiteId,
		Size,
		Excised,
		ISNULL(Retreived,0) AS Retrieved, --newly added for 4069
		ISNULL(Discarded,0) AS Discarded, --newly added for 4069
		Successful,
		Labs,
		Removal,
		ISNULL(Pm.Description,'') AS RemovalDescription,
		RemovalMethod,
		ISNULL(Pt.Description,'') AS RemovalMethodDescription,
		Probably,
		Type,
		ISNULL(Tu.Description,'') AS TypeDescription,
		ParisClass,
		PitPattern, 
		Infammatory,
		PostInflammatory,
		TattooedId,
		TattooedMarkingTypeId,
		ISNULL(TM.description,'') AS TattooedMarkingTypeDescription,
		ISNULL(TattooLocationDistal,0) AS TattooLocationDistal,
		ISNULL(TattooLocationProximal,0) AS TattooLocationProximal,
		TattoDescription=iif(Size>=20 and TattooedId>0,'' +iif(lower(Ta.Description)='no','',iif(lower(Ta.Description)='yes','Tattooed','')),''),
		ISNULL(SubmucosalQuantity,0) AS SubmucosalQuantity, --newly added for 4069
		ISNULL(SubmucosalLargest,0) AS SubmucosalLargest, 
		ISNULL(FocalQuantity,0) AS FocalQuantity,
		ISNULL(FocalLargest,0) AS FocalLargest,
		ISNULL(FundicGlandPolypQuantity,0) AS FundicGlandPolypQuantity,
		ISNULL(FundicGlandPolypLargest,0) AS FundicGlandPolypLargest, --newly added for 4069
		PolypTypeId,

		--newly added for 4069
		(SELECT STUFF((SELECT ',' + convert(varchar(10), c.PolypConditionId) as [text()] FROM ERS_CommonAbnoPolypConditions c WHERE c.PolypDetailId = d.PolypDetailId FOR XML PATH('')),1,1,'')) as PolypConditionIds
	FROM ERS_CommonAbnoPolypDetails d
		left JOIN ERS_PolypTypes t on  d.PolypTypeId=t.UniqueId 
		left join ERS_TumourTypes Tu on d.type=Tu.uniqueid
		left join ERS_PolypRemovalMethods Pm on d.removal=Pm.UniqueId
		left join ERS_PolypRemovalTypes Pt on d.RemovalMethod=Pt.UniqueId
		left join ERS_TattooOptions Ta on d.TattooedId=Ta.UniqueId
		left join ERS_MarkingTypes TM ON d.TattooedMarkingTypeId =TM.UniqueId
	WHERE d.SiteId = @SiteId
	--newly added for 4069
END

GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	3597
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Muhammad Nasim
-- TFS#	3155
-- Description of change: Image sub indications
-------------------------------------------------------------------------------------------------------------------------
update ERS_SubIndications set additionalinfo=1 where IndicationId=5

GO
------------------------------------------------------------------------------------------------------------------------
-- Updated by				:	Adrian Schaal 
-- Updated on				:	25th June, 2024
-- TFS#						:	3208
-- Description of change	:	Tumours to be available on all gastros
-- Table/SP/Views etc...	:	Various
------------------------------------------------------------------------------------------------------------------------
GO

UPDATE dbo.ERS_AbnormalitiesMatrixColon
SET Tumour = 1
WHERE Tumour = 0

GO

EXEC dbo.DropIfExist 
    @ObjectName = 'abnormalities_colon_tumour_select', 
    @ObjectTypePrefix = 'S' 

GO

CREATE PROCEDURE [dbo].[abnormalities_colon_tumour_select]
(
	@SiteId INT	
)
AS
BEGIN

SET NOCOUNT ON

BEGIN TRY

    SELECT 
	  [SiteId]
      ,[None]
      ,[Summary]
	  ,[Submucosal]
      ,[SubmucosalQuantity]
      ,[SubmucosalLargest]
      ,[SubmucosalProbably]
      ,[SubmucosalType]
      ,[Villous]
      ,[VillousQuantity]
      ,[VillousLargest]
      ,[VillousProbably]
      ,[VillousType]
      ,[Ulcerative]
      ,[UlcerativeQuantity]
      ,[UlcerativeLargest]
      ,[UlcerativeProbably]
      ,[UlcerativeType]
      ,[Stricturing]
      ,[StricturingQuantity]
      ,[StricturingLargest]
      ,[StricturingProbably]
      ,[StricturingType]
      ,[Polypoidal]
      ,[PolypoidalQuantity]
      ,[PolypoidalLargest]
      ,[PolypoidalProbably]
      ,[PolypoidalType]
      ,[Granuloma]
      ,[GranulomaQuantity]
      ,[GranulomaLargest]
      ,[Dysplastic]
      ,[DysplasticQuantity]
      ,[DysplasticLargest]
      ,[PneumatosisColi]
	  ,[TattooedId]
	  ,[TattooedQuantity]
	  ,[TattooMarkingTypeId]
	  ,[Tumour]
	FROM 
		[dbo].[ERS_ColonAbnoTumour]
	WHERE 
		SiteId = @SiteId
END TRY
BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	PRINT @ErrorMessage + ', ' + @ErrorSeverity + ', ' + @ErrorState
END CATCH
END

GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS# 3208
------------------------------------------------------------------------------------------------------------------------
GO


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 26.6.24
-- TFS#	
-- Description of change
-- Update diary end when list slot is edited
------------------------------------------------------------------------------------------------------------------------
GO

EXEC dbo.DropIfExist 
    @ObjectName = 'sch_list_slot_update', 
    @ObjectTypePrefix = 'S' 

GO

CREATE PROCEDURE [dbo].[sch_list_slot_update]
(
	@ListSlotId int,
	@SlotStatusId int,
	@ProcedureTypeId int,
	@Points decimal(18,2),
	@SlotLength int,
	@LoggedInUserId int
)
AS
BEGIN
	UPDATE ERS_SCH_ListSlots
	SET SlotId = @SlotStatusId,
		ProcedureTypeId = @ProcedureTypeId,
		Points = @Points,
		SlotMinutes = @SlotLength,
		WhenUpdated = getdate(),
		WhoUpdatedId = @LoggedInUserId
	WHERE ListSlotId = @ListSlotId

	IF @SlotLength > 0 
	BEGIN
	    DECLARE @ListRulesId INT = (SELECT TOP 1 ListRulesId FROM dbo.ERS_SCH_ListSlots WHERE ListSlotId = @ListSlotId)
		DECLARE @DiaryId INT = (SELECT TOP 1 DiaryId FROM dbo.ERS_SCH_DiaryPages d WHERE d.ListRulesId = @ListRulesId)
	    UPDATE dbo.ERS_SCH_DiaryPages SET DiaryEnd = dbo.fnSCH_DiaryEnd(@ListRulesId, DiaryStart) WHERE DiaryId = @DiaryId
	END
END
GO



------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Muhammad Nasim
-- TFS#	3240
-- Description of change: Patient Friendly Report layout update
-------------------------------------------------------------------------------------------------------------------------
dbo.DropIfExist
    @ObjectName = 'Get_PatientReport_Info',      -- varchar(100)
    @ObjectTypePrefix = 'S' -- varchar(5)
go
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Get_PatientReport_Info]
	@ProcedureId int,
	@OperatingHospitalId int
AS
BEGIN
	Declare @PP_PFRFollowUp nvarchar(max),@LimitationId int,@ProcedureUpperExtent int,@ProcedureLowerExtent bit,@ProcedureTypeID int,@NEDEnabled int,@procedureComplete nvarchar(100)
	Declare @Results as Table(includeText nvarchar(200) ,includes bit,result nvarchar(max))

	select @ProcedureUpperExtent=ExtentId from ERS_ProcedureUpperExtent where ProcedureId=@ProcedureId and ExtentId=(select UniqueId from ERS_Extent where Description='Abandoned')
	select @ProcedureLowerExtent=isnull(Abandoned,0) from ERS_ProcedureLowerExtent where ProcedureId=@ProcedureId	
	select @LimitationId=LimitationId from ERS_ProcedureUpperExtent where ProcedureId=@ProcedureId

	select @ProcedureTypeID= ProcedureType,@NEDEnabled=ISNULL(NEDEnabled,1) from ers_procedures where ProcedureId=@ProcedureId
	if @NEDEnabled<>1 or (@ProcedureTypeID in (3,4,5,9) and @ProcedureLowerExtent=1) or (@ProcedureTypeID in (1,6,7,8,2) and @ProcedureUpperExtent is not null)
	begin
		set @procedureComplete='No'
	end
	else if @LimitationId is not null
	begin
		set @procedureComplete='Yes (limited)'
	end
	else
	begin
		set @procedureComplete='Yes'
	end

	select Biopsy,Urease,Polypectomy into #tmpPatientReport from ERS_UpperGISpecimens where SiteId in (SELECT SiteId FROM ERS_Sites where ProcedureId=@ProcedureId)
	select @PP_PFRFollowUp=ISNULL(LTRIM(RTRIM(PP_PFRFollowUp)), '') from ERS_UpperGIFollowUp where procedureid=@ProcedureId

	insert into @Results(includeText,includes,result)
	select 'Urease',IncludeUreaseText,'<strong>&#8226;</strong>&nbsp;&nbsp;'+UreaseText from ERS_PrintOptionsPatientFriendlyReport where OperatingHospitalId=1 and (select Urease from #tmpPatientReport)=1 union all
	select 'Polypectomy',IncludePolypectomyText,'<strong>&#8226;</strong>&nbsp;&nbsp;'+PolypectomyText from ERS_PrintOptionsPatientFriendlyReport where OperatingHospitalId=1 and (select Polypectomy from #tmpPatientReport)=1 union all
	select 'OtherBiopsy',IncludeOtherBiopsyText,'<strong>&#8226;</strong>&nbsp;&nbsp;'+OtherBiopsyText from ERS_PrintOptionsPatientFriendlyReport where OperatingHospitalId=1 and (select Biopsy from #tmpPatientReport)=1 union all
	select 'IncludeAnyOtherBiopsyText',IncludeOtherBiopsyText,'<strong>&#8226;</strong>&nbsp;&nbsp;'+AnyOtherBiopsyText from ERS_PrintOptionsPatientFriendlyReport where OperatingHospitalId=1 and (select Biopsy from #tmpPatientReport)=1 union all
	select 'PreceedAdviceComments',IncludePreceedAdviceComments,'<strong>&#8226;</strong>&nbsp;&nbsp;'+PreceedAdviceComments+' '+@PP_PFRFollowUp from ERS_PrintOptionsPatientFriendlyReport where OperatingHospitalId=1 and @PP_PFRFollowUp<>''


	select procedureComplete=@procedureComplete,ProcedureType=isnull(b.ProcedureType,''),ProcedureTypeId=b.ProcedureTypeId,MedicationText=ISNULL( c.Summary,''),
	d.NoFurtherTestsRequired,d.AwaitingPathologyResults,NoFurtherFollowUp=isnull(d.NoFurtherFollowUp,0),
	ListItemText=(SELECT isnull(ListItemText,'') FROM ERS_Lists WHERE ListDescription = 'Return or referred to' AND ListItemNo=d.ReturnTo),
	ReviewText=isnull(d.ReviewText,''),d.Summary
	from ERS_Procedures a left join ERS_ProcedureTypes b on a.ProcedureType=b.ProcedureTypeId
	left join ERS_UpperGIRx c on a.ProcedureId=c.ProcedureId
	left join ERS_UpperGIFollowUp d on a.ProcedureId=d.ProcedureId
	where a.ProcedureId=@ProcedureId

	select result from @Results where includes=1
	return
END
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#3240 	(Patient Friendly Report layout update)
------------------------------------------------------------------------------------------------------------------------
go

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	REZAUL kARIM
-- TFS#	4049
-- Description of change
-- RX Comment box free text
------------------------------------------------------------------------------------------------------------------------
 
 IF NOT EXISTS (
        SELECT 1
        FROM INFORMATION_SCHEMA.COLUMNS
        WHERE TABLE_NAME = 'ERS_UpperGIRx' AND
              COLUMN_NAME IN ('IsUserModified')
    )
    BEGIN
		ALTER TABLE ERS_UpperGIRx
		ADD IsUserModified BIT NULL
    END

GO
dbo.DropIfExist
    @ObjectName = 'ogd_rx_save',      -- varchar(100)
    @ObjectTypePrefix = 'S' -- varchar(5)
go
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[ogd_rx_save]
(
	@ProcedureId INT,
    @ContMedication BIT,
    @ContMedicationByGP BIT,
    @ContPrescribeMedication BIT,
    @SuggestPrescribe BIT,
    @MedicationText NVARCHAR(1000),
	@IsUserModified BIT,
	@LoggedInUserId INT,
	@setComplete TINYINT

)
AS

SET NOCOUNT ON

BEGIN TRANSACTION

BEGIN TRY
			
	IF NOT EXISTS (SELECT 1 FROM ERS_UpperGIRx WHERE ProcedureId = @ProcedureId)
	BEGIN
		INSERT INTO ERS_UpperGIRx (
			ProcedureId,
			ContMedication,
			ContMedicationByGP,
			ContPrescribeMedication,
			SuggestPrescribe,
			MedicationText,
			Summary,
			WhoCreatedId,
			WhenCreated,
			IsUserModified)
		VALUES (
			@ProcedureId,
			@ContMedication,
			@ContMedicationByGP,
			@ContPrescribeMedication,
			@SuggestPrescribe,
			@MedicationText,
			@MedicationText,
			@LoggedInUserId,
			GETDATE(),
			@IsUserModified)

	END

	ELSE IF (@ContMedication=0 AND @ContMedicationByGP=0 AND @ContPrescribeMedication=0 AND @SuggestPrescribe=0)
	BEGIN
		IF @IsUserModified = 0 OR @IsUserModified IS NULL
			BEGIN
				SELECT @IsUserModified = ISNULL(IsUserModified, 0) FROM ERS_UpperGIRx WHERE ProcedureId = @ProcedureId
			END
		if @IsUserModified = 0
			BEGIN
				DELETE FROM ERS_UpperGIRx 
				WHERE ProcedureId = @ProcedureId 

				UPDATE ERS_ProceduresReporting
				SET PP_Rx = NULL
				WHERE ProcedureId = @ProcedureId
			END
		 Else
			Begin
				UPDATE 
				ERS_UpperGIRx
				SET 
					ContMedication = @ContMedication
					,ContMedicationByGP = @ContMedicationByGP
					,ContPrescribeMedication = @ContPrescribeMedication
					,SuggestPrescribe = @SuggestPrescribe
					,MedicationText = @MedicationText
					,Summary = @MedicationText
					,WhoUpdatedId = @LoggedInUserId
					,WhenUpdated = GETDATE()
					,IsUserModified = @IsUserModified
				WHERE 
					ProcedureId = @ProcedureId
			 END 
	END

	ELSE
	BEGIN
		IF @IsUserModified = 0 OR @IsUserModified IS NULL
			BEGIN
				SELECT @IsUserModified = ISNULL(IsUserModified, 0) FROM ERS_UpperGIRx WHERE ProcedureId = @ProcedureId
			END
		UPDATE 
			ERS_UpperGIRx
		SET 
			ContMedication = @ContMedication
			,ContMedicationByGP = @ContMedicationByGP
			,ContPrescribeMedication = @ContPrescribeMedication
			,SuggestPrescribe = @SuggestPrescribe
			,MedicationText = @MedicationText
			,Summary = @MedicationText
			,WhoUpdatedId = @LoggedInUserId
			,WhenUpdated = GETDATE()
			,IsUserModified = @IsUserModified
		WHERE 
			ProcedureId = @ProcedureId
	END

	--check for anti-coag vs damaging drug vs RX result and set complete if conditions met
	DECLARE @AntiCoagDrugs BIT = (SELECT AntiCoagDrugs FROM ERS_Procedures WHERE ProcedureId = @ProcedureId)
	DECLARE  @SectionId int = (SELECT UISectionId FROM UI_Sections WHERE SectionName = 'Anti-coag drugs')
	    
	IF @AntiCoagDrugs = 1 AND 
	    	((SELECT count(*) FROM ERS_ProcedureDamagingDrugs WHERE ProcedureId = @ProcedureId AND DamagingDrugId IN (SELECT UniqueId FROM ERS_PotentialDamagingDrugs WHERE AntiCoag = 1)) > 0 
	    AND (SELECT count(*) FROM ERS_UpperGIRx WHERE ProcedureId = @ProcedureId AND Summary <> '') > 0)
	BEGIN
	    exec UI_update_procedure_summary @ProcedureId, 'RX', 'RX', 1
	END
	ELSE IF @AntiCoagDrugs = 1 AND 
	    	((SELECT count(*) FROM ERS_ProcedureDamagingDrugs WHERE ProcedureId = @ProcedureId AND DamagingDrugId IN (SELECT UniqueId FROM ERS_PotentialDamagingDrugs WHERE AntiCoag = 1)) = 0 
	    OR (SELECT count(*) FROM ERS_UpperGIRx WHERE ProcedureId = @ProcedureId AND Summary <> '') =0)
	BEGIN
	    exec UI_update_procedure_summary @ProcedureId, 'RX', 'RX', 0
	END
	ELSE IF @AntiCoagDrugs = 0
	BEGIN
		exec UI_update_procedure_summary @ProcedureId, 'RX', 'RX', 1
	END

	IF @setComplete = 1 and NOT EXISTS(SELECT 1 FROM ERS_RecordCount WHERE ProcedureId = @ProcedureId AND [Identifier] = 'Rx')
	BEGIN
		INSERT INTO ERS_RecordCount (
			[ProcedureId],
			[SiteId],
			[Identifier],
			[RecordCount]
		)
		VALUES (
			@ProcedureId,
			NULL,
			'Rx',
			1)
	END

END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;
GO
dbo.DropIfExist
    @ObjectName = 'ogd_rx_summary_update',      -- varchar(100)
    @ObjectTypePrefix = 'S' -- varchar(5)
go
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[ogd_rx_summary_update]
(
	@ProcedureId INT
)
AS
	SET NOCOUNT ON

	DECLARE
		@summary VARCHAR(MAX),
		@MedicationText NVARCHAR(MAX),
		@PrescriptionText NVARCHAR(4000) = '',
		@ContMedication bit,
		@ContMedicationByGP bit,
		@ContPrescribeMedication bit,
		@SuggestPrescribe bit,
		@IsUserModified BIT

	SELECT 
		@MedicationText=MedicationText, @IsUserModified = IsNull(IsUserModified,0)
	FROM
		ERS_UpperGIRx
	WHERE
		ProcedureId = @ProcedureId

	
	SELECT @ContMedication = ContMedication, @ContMedicationByGP = ContMedicationByGP, @ContPrescribeMedication = ContPrescribeMedication, @SuggestPrescribe = SuggestPrescribe
	FROM dbo.ERS_UpperGIRx eug WHERE eug.ProcedureId=@ProcedureId


 
	IF @ContMedication = 1
	BEGIN
		SET @PrescriptionText = @PrescriptionText + ISNULL((SELECT TOP 1 PrescriptionText FROM ERS_PatientMedication m WHERE ProcedureNo = @ProcedureId AND m.WhoPrescribed = 'C'),'Continue medication') + '. '
	END
	IF @ContMedicationByGP = 1 
	BEGIN
		SET @PrescriptionText = @PrescriptionText + ISNULL((SELECT TOP 1 PrescriptionText FROM ERS_PatientMedication m WHERE ProcedureNo = @ProcedureId AND m.WhoPrescribed = 'G')  + '. ','')
	END
	IF @ContPrescribeMedication = 1 
	BEGIN
		SET @PrescriptionText = @PrescriptionText + ISNULL((SELECT TOP 1 PrescriptionText FROM ERS_PatientMedication m WHERE ProcedureNo = @ProcedureId AND m.WhoPrescribed = 'H')  + '. ','')
	END
	IF @SuggestPrescribe = 1 
	BEGIN
		SET @PrescriptionText = @PrescriptionText + ISNULL((SELECT TOP 1 PrescriptionText FROM ERS_PatientMedication m WHERE ProcedureNo = @ProcedureId AND m.WhoPrescribed = 'S') + '. ','')
	END

	IF @IsUserModified = 0
		BEGIN
			SET @Summary = ISNULL(NULLIF(@PrescriptionText,''),@MedicationText)
		END
	ELSE
		BEGIN
			SET @Summary = @MedicationText
		END

	IF ISNULL(@summary,'') <> ''
	BEGIN
		exec UI_update_procedure_summary @ProcedureId, 'RX', 'RX', 1
	END
	ELSE
	BEGIN
		exec UI_update_procedure_summary @ProcedureId, 'RX', 'RX', 0
	END

	--Update the summary column in rx table
	UPDATE ERS_UpperGIRx
	SET Summary = @summary 
	WHERE ProcedureId = @ProcedureId

	UPDATE ERS_ProceduresReporting
	SET PP_Rx = @summary
	WHERE ProcedureId = @ProcedureId
	GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	4049 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Partha Kundu
-- TFS#	4192,4193
-- Description of change: Make Report Modular based on Schedular And Jag
-------------------------------------------------------------------------------------------------------------------------
--Adding ReportModule column in ERS_AuditReports table
IF Not EXISTS(SELECT * FROM sys.columns WHERE Name = N'ReportModule' AND Object_ID = Object_ID(N'ERS_AuditReports'))
Begin
ALTER TABLE [dbo].[ERS_AuditReports]
   Add  ReportModule  varchar(1) null 
End
GO


update  ERS_AuditReports
set ReportModule='S'
where  AuditReportStoredProcedure in ('AuditAppointmentTherapeutic','auditNumberOfBookingsByDay','auditNumberOfBookings')
GO
update  ERS_AuditReports
set ReportModule='R'
where ReportModule is null

GO

ALTER Procedure [dbo].[GetOtherAuditReports]
(@ReportModule as varchar(1))
as

Select AuditReportId, AuditReportDescription
from ERS_AuditReports
where case when OBJECT_ID(AuditReportStoredProcedure, 'P') IS NOT NULL then 1 else 0 end = 1
and isnull(ReportModule,'R')= @ReportModule
order by AuditReportDescription
GO

------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	4192,4193
------------------------------------------------------------------------------------------------------------------------

IF NOT EXISTS (SELECT 1 FROM ERS_PolypTypes WHERE Description = 'Focal lesions')
BEGIN
    INSERT INTO ERS_PolypTypes
        (Description, NEDTerm, ListOrderBy, Suppressed, WhoUpdatedId, WhoCreatedId, whenCreated, whenUpdated)
    VALUES
        ('Focal lesions', NULL, NULL, 0, NULL, NULL, NULL, NULL);
END

IF NOT EXISTS (SELECT 1 FROM ERS_PolypTypes WHERE Description = 'Fundic Gland Polyp')
BEGIN
    INSERT INTO ERS_PolypTypes
        (Description, NEDTerm, ListOrderBy, Suppressed, WhoUpdatedId, WhoCreatedId, whenCreated, whenUpdated)
    VALUES
        ('Fundic Gland Polyp', NULL, NULL, 0, NULL, NULL, NULL, NULL);
END

GO
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rezaul Karim 01/07/24
-- TFS#	4190
-- Description: Dieulafoy lesions for Gastroscopy
--------------------------------------------------------------------------------------------------------------------------

EXEC dbo.DropIfExist 
    @ObjectName = 'abnormalities_vascular_lesions_summary_update', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[abnormalities_vascular_lesions_summary_update]
(
	@SiteId INT
)
AS
	SET NOCOUNT ON

	DECLARE
		@summary VARCHAR(200),
		@temp VARCHAR(120),
		@None BIT,
		@Type TINYINT,
		@Multiple BIT,
		@Quantity INT,
		@Bleeding TINYINT,
		@Area  VARCHAR(50)

	SELECT 
		@None=[None],
		@Type=[Type],
		@Multiple=Multiple,
		@Quantity=Quantity,
		@Bleeding=Bleeding,
		@Area=Area
	FROM
		ERS_CommonAbnoVascularLesions
	WHERE
		SiteId = @SiteId

	SET @Summary = ''

	IF @None = 1
		SET @summary = @summary + 'No vascular lesions'
	
	ELSE IF @Type > 0
	BEGIN
		IF @Multiple > 0 SET @summary = @summary + 'multiple'
		ELSE IF @Quantity > 1 SET @summary = @summary + CONVERT(VARCHAR(20), @Quantity)

		IF RIGHT(LOWER(@Area),5) = ' part' SET @Area = 'Duodenum' --For ERCP, the variable @Area has region name instead of Area and all the region in duodenum ends with ' part', so use this to generate @Summary text

		IF @Area = 'Oesophagus'
		BEGIN
			SET @temp = CASE @Type
						WHEN 1 THEN 'Telangiectasia'
						WHEN 2 THEN 'Angiodysplasia (<5mm)'
						WHEN 3 THEN 'Angiodysplasia (>5mm)'
						WHEN 4 THEN 'Angiodysplasia (large and small lesions)'
						WHEN 5 THEN 'Portal hypertensive gastropathy'
						WHEN 6 THEN 'Watermelon stomach'
					END
		END
		ELSE IF @Area = 'Stomach'
		BEGIN
			SET @temp = CASE @Type
						WHEN 1 THEN 'Telangiectasia'
						WHEN 2 THEN 'Angiodysplasia (<5mm)'
						WHEN 3 THEN 'Angiodysplasia (>5mm)'
						WHEN 4 THEN 'Angiodysplasia (large and small lesions)'
						WHEN 5 THEN 'Portal hypertensive gastropathy'
						WHEN 6 THEN 'Watermelon stomach'
						WHEN 7 THEN 'Dieulafoy lesion'
					END
		END
		ELSE IF @Area = 'Duodenum'
		BEGIN
			SET @temp = CASE @Type
						WHEN 1 THEN 'Telangiectasia'
						WHEN 2 THEN 'Angiodysplasia (<5mm)'
						WHEN 3 THEN 'Angiodysplasia (>5mm)'
						WHEN 4 THEN 'Angiodysplasia (large and small lesions)'
						WHEN 5 THEN 'Varices'
					END
		END

		IF @summary <> '' SET @summary = @summary + ' ' + LOWER(@temp)
		ELSE SET @summary = @temp

		IF @Bleeding > 0 
		BEGIN
			SET @summary = @summary + ' with '


			IF @Area = 'Stomach'
			BEGIN
				SET @summary =  @summary + 
					CASE @Bleeding
						WHEN 1 THEN 'no bleeding'
						WHEN 2 THEN 'fresh clot'
						WHEN 3 THEN 'altered blood'
						WHEN 4 THEN 'active bleeding'
					END
			END
			ELSE IF @Area = 'Duodenum'
			BEGIN
				SET @summary =  @summary + 
					CASE @Bleeding
						WHEN 1 THEN 'no bleeding'
						WHEN 2 THEN 'fibrin plug'
						WHEN 3 THEN 'fresh clot'
						WHEN 4 THEN 'red sign'
						WHEN 5 THEN 'active bleeding'
					END
			END
			ELSE IF @Area = 'Oesophagus'
			BEGIN
				SET @summary =  @summary + 
					CASE @Bleeding
						WHEN 1 THEN 'no bleeding'
						WHEN 2 THEN 'fibrin plug'
						WHEN 3 THEN 'fresh clot'
						WHEN 4 THEN 'red sign'
						WHEN 5 THEN 'active bleeding'
					END
			END



		END
	END
	--PRINT @summary

	-- Finally update the summary in abnormalities table
	UPDATE ERS_CommonAbnoVascularLesions
	SET Summary = (SELECT isnull(@summary, '') as [text()] FOR XML PATH(''))  
	WHERE SiteId = @siteId

GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#4190
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Rezaul Karim
-- TFS#	4189
-- Description of change: eosinophilic oesophagitis on gastroscopy
-------------------------------------------------------------------------------------------------------------------------
update ERS_DiagnosesMatrix set DisplayName = 'Eosinophilic oesophagitis' where Code = 'D65P1'

GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS# 4189
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	MOSTAFIZUR RAHMAN
-- TFS#	3903
-- Description of change
-- Solved Role Configuration 
------------------------------------------------------------------------------------------------------------------------

IF EXISTS (
    SELECT 1
    FROM sys.columns c
    JOIN sys.tables t ON c.object_id = t.object_id
    JOIN sys.schemas s ON t.schema_id = s.schema_id
    WHERE s.name = 'ERSAudit'
    AND t.name = 'ERS_PagesByRole_Audit'
    AND c.name = 'RoleId'
)
BEGIN

    ALTER TABLE ERSAudit.ERS_PagesByRole_Audit
    ALTER COLUMN RoleId INT NOT NULL;
END
GO

IF EXISTS (
    SELECT 1 
    FROM sys.columns c
    JOIN sys.tables t ON c.object_id = t.object_id
    JOIN sys.schemas s ON t.schema_id = s.schema_id
    WHERE s.name = 'dbo'
    AND t.name = 'ERS_PagesByRole'
    AND c.name = 'RoleId'
)
BEGIN

    DROP INDEX IX_ERS_PagesByRole ON dbo.ERS_PagesByRole;

    ALTER TABLE dbo.ERS_PagesByRole
    ALTER COLUMN RoleId INT NOT NULL;

    CREATE INDEX IX_ERS_PagesByRole ON dbo.ERS_PagesByRole (RoleId);
END

GO

------------------------------------------------------------------------------------------------------------------------
-- TFS#	3903 Ended
------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Muhammad Nasim
-- TFS#	3155
-- Description of change: The free text boxes show below subindications but the text on the report is showing above indications and is not pulling through capital letters. 
-------------------------------------------------------------------------------------------------------------------------
Go
update ERS_XMLMap set OrderID=-1 where FieldName='PP_Indic' and NodeName='Indications'
GO

EXEC dbo.DropIfExist @ObjectName = 'ProcedureSubIndicationsSummary',      
                     @ObjectTypePrefix = 'F' 
GO
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE FUNCTION [dbo].[ProcedureSubIndicationsSummary]
(
	@ProcedureId int
)
RETURNS varchar(max)
AS
BEGIN

DECLARE @SubIndicationsString  varchar(max), @RetVal varchar(max)
SELECT @SubIndicationsString =
	LTRIM(STUFF((SELECT ', ' + CASE WHEN i.AdditionalInfo = 0 THEN [Description] ELSE Concat([Description],': ',epi.AdditionalInfo) END AS [text()] --epi.AdditionalInfo
	FROM ers_proceduresubindications epi 
		INNER JOIN ers_subindications i on i.uniqueid = epi.subindicationid
	WHERE procedureid=@ProcedureId order by i.uniqueid
	FOR XML PATH('')),1,1,''))


SELECT @SubIndicationsString = dbo.fnAddFullStop(@SubIndicationsString) --dbo.fnCapitalise(dbo.fnAddFullStop(@SubIndicationsString)) 

IF charindex(',', reverse(@SubIndicationsString)) > 0
	SELECT @RetVal = STUFF(@SubIndicationsString, len(@SubIndicationsString) - charindex(' ,', reverse(@SubIndicationsString)), 2, ' and ')
ELSE
	SELECT @RetVal = @SubIndicationsString

RETURN @RetVal
END
GO
dbo.DropIfExist
    @ObjectName = 'procedure_subindications_save',      -- varchar(100)
    @ObjectTypePrefix = 'S' -- varchar(5)
GO
CREATE PROCEDURE [dbo].[procedure_subindications_save]
(
	@ProcedureId int, 
	@SubIndicationId int, 
	@Selected bit,
	@AdditionalInfo varchar(max),
	@LoggedInUserId int
)
AS
BEGIN
	IF @Selected = 1 and (SELECT AdditionalInfo FROM ERS_SubIndications WHERE UniqueId=@SubIndicationId)=1 and len(@AdditionalInfo)=0
	begin
		delete from ERS_ProcedureSubIndications where ProcedureId=@ProcedureId and SubIndicationId=@SubIndicationId
	end
	else IF @Selected = 1 
	BEGIN
		IF NOT EXISTS (SELECT 1 FROM ERS_ProcedureSubIndications WHERE SubIndicationId = @SubIndicationId AND ProcedureId = @ProcedureId)
		BEGIN
			INSERT INTO [dbo].[ERS_ProcedureSubIndications] (ProcedureId, SubIndicationId, AdditionalInfo, WhoCreatedId, WhenCreated)
			VALUES (@ProcedureId, @SubIndicationId, @AdditionalInfo, @LoggedInUserId, getdate())
		END
		ELSE
		BEGIN IF EXISTS (SELECT 1 FROM ERS_ProcedureSubIndications WHERE SubIndicationId = @SubIndicationId AND ProcedureId = @ProcedureId AND AdditionalInfo <> @AdditionalInfo)
			UPDATE ERS_ProcedureSubIndications
			SET AdditionalInfo = @AdditionalInfo,
			    WhoUpdatedId = @LoggedInUserId,
				WhenUpdated = GETDATE()
			WHERE 
				ProcedureId = @ProcedureId AND
				SubIndicationId = @SubIndicationId
		END
	END
	ELSE
	BEGIN
		DELETE FROM ERS_ProcedureSubIndications WHERE ProcedureId = @ProcedureId AND SubIndicationId = @SubIndicationId
	END
	--if (SELECT AdditionalInfo FROM ERS_SubIndications WHERE UniqueId=@SubIndicationId)=1 and len(@AdditionalInfo)=0
	--begin
	--	delete from ERS_ProcedureSubIndications where ProcedureId=@ProcedureId and SubIndicationId=@SubIndicationId
	--end
	UPDATE ERS_ProceduresReporting
	SET PP_SubIndications = dbo.ProcedureSubIndicationsSummary(@ProcedureId)
	WHERE ProcedureId = @ProcedureId
END
GO
------------------------------------------------------------------------------------------------------------------------
-- TFS#	3155 Ended
------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	MOSTAFIZUR RAHMAN
-- TFS#	4184
-- Description of change
-- Referring consultant on printed report
------------------------------------------------------------------------------------------------------------------------
GO 
EXEC dbo.DropIfExist 
    @ObjectName = 'usp_UpdateProcedureStaff', 
    @ObjectTypePrefix = 'S' 
GO

CREATE PROCEDURE [dbo].[usp_UpdateProcedureStaff]
(
	@ProcedureID					AS INT,
	@ListType						AS INT,
	@ListConsultant					AS VARCHAR(24),
	@Endoscopist1					AS VARCHAR(24),
	@Endoscopist1Role				AS INT, 
	@Endoscopist2					AS VARCHAR(24),
	@Endoscopist2Role				AS INT,
	@Nurse1							AS VARCHAR(24),
	@Nurse2							AS VARCHAR(24),
	@Nurse3							AS VARCHAR(24),
	@Nurse4							AS VARCHAR(24),
	@OperatingHospitalId			AS INT,
	@LoggedInUserId					AS INT,
	@ImagePortId					AS INT,
	@ProviderTypeId					AS INT,
	@OtherProviderText				AS VARCHAR(24),
	@ReferrerType					AS INT,
	@OtherReferrerText				AS VARCHAR(24),
	@ReferralHospitalNo				AS INT,
	@ReferralConsultantNo			AS INT,
	@ReferralConsultantSpeciality	AS INT,
	@PatientStatus					AS INT,
	@Ward							AS INT,
	@PatientType					AS INT,
	@CategoryListId					AS INT

)
AS
BEGIN TRANSACTION
BEGIN TRY
	DECLARE @ppEndos VARCHAR(2000), @GPName varchar(255), @GPAddress varchar(max), @Endo1 varchar(500), @Endo2 varchar(500), @RefCons varchar(50), @RefHosp varchar(50)

	UPDATE ERS_Procedures 
		SET 
			  ListType						= @ListType
			, ListConsultant				= @ListConsultant
			, Endoscopist1					= @Endoscopist1
			, Endo1Role						= @Endoscopist1Role
			, Endoscopist2					= @Endoscopist2
			, Endo2Role						= @Endoscopist2Role
			, Nurse1						= @Nurse1
			, Nurse2						= @Nurse2
			, Nurse3						= @Nurse3 
			, Nurse4						= @Nurse4 
			, WhoUpdatedId					= @LoggedInUserId
			, WhenUpdated					= GETDATE()
			, ImagePortId					= @ImagePortId
			, ProviderTypeId				= @ProviderTypeId
			, ProviderOther					= @OtherProviderText
			, ReferrerType					= @ReferrerType
			, ReferrerTypeOther				= @OtherReferrerText
			, ReferralHospitalNo			= @ReferralHospitalNo
			, ReferralConsultantNo			= @ReferralConsultantNo
			, ReferralConsultantSpeciality	= @ReferralConsultantSpeciality
			, PatientStatus					= @PatientStatus
			, Ward							= @Ward
			, PatientType					= @PatientType
			, CategoryListId				= @CategoryListId
	WHERE ProcedureId = @ProcedureId;

	SET @ppEndos = ''
       IF @ListConsultant > 0 SELECT @ppEndos = @ppEndos + '$$List Consultant: ' + Title + ' ' + Forename + ' ' + Surname FROM tvfUsersByOperatingHospital(@OperatingHospitalId) WHERE UserID = @ListConsultant
       IF @Endoscopist1 > 0 
       BEGIN
			SELECT @Endo1 = Title + ' ' + Forename + ' ' + Surname FROM tvfUsersByOperatingHospital(@OperatingHospitalId) WHERE UserID = @Endoscopist1
			SELECT @ppEndos = @ppEndos + '$$Endoscopist No1: ' + @Endo1
			SELECT  @Endo1 = Title + ' ' + Forename + ' ' + Surname + 
					CASE WHEN isnull(Qualifications, '') != '' THEN ', ' + Qualifications else '' END + 
					CASE WHEN isnull(u.JobTitleID, 0) > 0 THEN CHAR(13)+CHAR(10) + jt.Description ELSE '' END  
			FROM ERS_Users u
			LEFT JOIN ERS_JobTitles jt on u.JobTitleID = jt.JobTitleID 
			WHERE UserID = @Endoscopist1
	   END
	   IF @Endoscopist2 > 0 
		BEGIN
			SELECT @Endo2 = Title + ' ' + Forename + ' ' + Surname FROM tvfUsersByOperatingHospital(@OperatingHospitalId) WHERE UserID = @Endoscopist2
			SELECT @ppEndos = @ppEndos + '$$Endoscopist No2: ' + @Endo2
			SELECT  @Endo2 = Title + ' ' + Forename + ' ' + Surname + 
					CASE WHEN isnull(Qualifications, '') != '' THEN ', ' + Qualifications else '' END + 
					CASE WHEN isnull(u.JobTitleID, 0) > 0 THEN CHAR(13)+CHAR(10) + jt.Description ELSE '' END  
			FROM ERS_Users u
			LEFT JOIN ERS_JobTitles jt on u.JobTitleID = jt.JobTitleID 		
			WHERE UserID = @Endoscopist2
		END
       IF @Nurse1 > 0 OR @Nurse2 > 0 OR @Nurse3 > 0 OR @Nurse4 > 0  
       BEGIN
              SELECT @ppEndos = @ppEndos + '$$' + 'Nurses: '
              IF @Nurse1 > 0 SELECT @ppEndos = @ppEndos + '##' + Title + ' ' + Forename + ' ' + Surname FROM tvfUsersByOperatingHospital(@OperatingHospitalId) WHERE UserID = @Nurse1
              IF @Nurse2 > 0 SELECT @ppEndos = @ppEndos + '##' + Title + ' ' + Forename + ' ' + Surname FROM tvfUsersByOperatingHospital(@OperatingHospitalId) WHERE UserID = @Nurse2
              IF @Nurse3 > 0 SELECT @ppEndos =  @ppEndos + '##' + Title + ' ' + Forename + ' ' + Surname FROM tvfUsersByOperatingHospital(@OperatingHospitalId) WHERE UserID = @Nurse3
              IF @Nurse4 > 0 SELECT @ppEndos =  @ppEndos + '##' + Title + ' ' + Forename + ' ' + Surname FROM tvfUsersByOperatingHospital(@OperatingHospitalId) WHERE UserID = @Nurse4
       END
       IF CHARINDEX('$$', @ppEndos) > 0 SET @ppEndos = REPLACE(STUFF(@ppEndos, charindex('$$', @ppEndos), 2, ''), '$$', '<br/>')
       IF CHARINDEX('##', @ppEndos) > 0 SET @ppEndos = REPLACE(STUFF(@ppEndos, charindex('##', @ppEndos), 2, ''), '##', '<br/>')
       
       SELECT @GPName = ISNULL(p.GPName,''), @GPAddress = ISNULL(p.GPAddress,'')
	   FROM ERS_VW_PatientswithGP p 
			LEFT JOIN  ERS_Procedures pr ON p.PatientId= pr.PatientId 
	   WHERE pr.ProcedureId = @ProcedureId;

	   SET @RefCons=''
		IF @ReferrerType = 1
		BEGIN
			SET @RefCons = 'GP'
		END
		ELSE IF @ReferrerType = 5
		BEGIN
			SET @RefCons = @OtherReferrerText
		END
		ELSE
		BEGIN
			SELECT @RefCons = Upper(ec.Forename) FROM dbo.ERS_Consultant ec WHERE ec.ConsultantID = @ReferralConsultantNo --ADDED BY MOSTAFIZ 4184
		END

		SET @RefHosp = ''
		SELECT @RefHosp = rh.HospitalName FROM dbo.ERS_ReferralHospitals rh WHERE rh.HospitalID = @ReferralHospitalNo

       UPDATE ERS_ProceduresReporting SET PP_Endos = @ppEndos, PP_Endo1 = @Endo1, PP_Endo2 = @Endo2, PP_GPName = @GPName, PP_GPAddress = @GPAddress, PP_RefCons = @RefCons, PP_RefHosp = @RefHosp WHERE ProcedureId = @ProcedureId;

END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;

GO

------------------------------------------------------------------------------------------------------------------------
-- TFS#	4184 Ended
------------------------------------------------------------------------------------------------------------------------


------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Duncan
-- Spreadsheet #11
-- Description of change
-- Remove therapeutics from all non GI procedure types and change Transnasel to Transnasal
------------------------------------------------------------------------------------------------------------------------

If (Select count(1) from ERS_ProcedureTypes where ProcedureType in ('Transnasal', 'Transnasel')) > 1
BEGIN
	Delete from ERS_ProcedureTypes where ProcedureType = 'Transnasel'
END
ELSE
BEGIN
	Update ERS_ProcedureTypes set ProcedureType = 'Transnasal' where ProcedureType = 'Transnasel'
END
Update ERS_ProcedureTypes set SchedulerTherapeutic = 0 where ProductTypeId = 0
GO
------------------------------------------------------------------------------------------------------------------------
-- Spreadsheet #11 End
------------------------------------------------------------------------------------------------------------------------
GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea 05.07.24
-- TFS#	Issue 40
-- Description of change
-- 
------------------------------------------------------------------------------------------------------------------------
GO

EXEC dbo.DropIfExist @ObjectName = 'sch_get_overlapped_diaries',      -- varchar(100)
                     @ObjectTypePrefix = 'S' -- varchar(5)
GO

CREATE PROCEDURE dbo.sch_get_overlapped_diaries
(
	@UserId INT,
	@DiaryStart DATETIME,
	@DiaryEnd DATETIME
)
AS
BEGIN
	SELECT DiaryId, Subject, DiaryStart, DiaryEnd, RecurrenceRule,RoomID
	FROM dbo.ERS_SCH_DiaryPages 
	WHERE UserId = @UserId   AND (
		(@DiaryStart >= DiaryStart AND @DiaryStart < DiaryEnd) --start date is between appointment time
	OR	(@DiaryEnd > DiaryEnd AND @DiaryEnd < DiaryEnd) --end date is between appointment time
	OR	(DiaryStart >= @DiaryStart AND DiaryEnd <= @DiaryEnd) --appointment is in between start and end times
	) AND Suppressed = 0
END
GO



------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
GO
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Duncan
-- Spreadsheet #108
-- Description of change
-- Set patient to InRecovery if the Procedure End Time is entered
------------------------------------------------------------------------------------------------------------------------
GO
ALTER PROCEDURE [dbo].[procedure_timings_save]
(	
	@ProcedureId int,
	@StartDateTime datetime = null,
	@EndDateTime datetime = NULL,
	@LoggedInUserId int
)
AS
BEGIN
	UPDATE ERS_Procedures
	SET StartDateTime = @StartDateTime, EndDateTime = @EndDateTime
	WHERE ProcedureId = @ProcedureId

	DECLARE @CompleteCount int = (SELECT CASE WHEN StartDateTime IS NOT NULL AND EndDateTime IS NOT NULL THEN 1 ELSE 0 END FROM ERS_Procedures WHERE ProcedureId = @ProcedureId)
	DECLARE @Summary VARCHAR(max) = 'Procedure timing:'
	EXEC UI_update_procedure_summary @ProcedureId, 'Procedure timing', @Summary, @CompleteCount
	

	IF EXISTS (SELECT 1 FROM ERS_PatientJourney WHERE ProcedureId = @ProcedureId)
	BEGIN
		IF @StartDateTime IS NOT NULL
		BEGIN
			UPDATE dbo.ERS_PatientJourney
			SET ProcedureStartTime = @StartDateTime,
				WhoUpdatedId = @LoggedInUserId,
				WhenUpdated = GETDATE()
			WHERE ProcedureId = @ProcedureId
		END
	
		IF @EndDateTime IS NOT NULL
		BEGIN
			UPDATE dbo.ERS_PatientJourney
			SET ProcedureEndTime = @EndDateTime,
				WhoUpdatedId = @LoggedInUserId,
				WhenUpdated = GETDATE()
			WHERE ProcedureId = @ProcedureId
			-- We have an end time, so we can mark the patient as in recovery if there is a matching appointment
			Declare @AppointmentId as int = -1
			Select top 1 @AppointmentId = AppointmentId 
			from ERS_PatientJourney where ProcedureId = @ProcedureId

			Update ERS_Appointments 
			set AppointmentStatusId = (Select UniqueId from ERS_AppointmentStatus Where HDCKEY = 'RC')
			where AppointmentId = @AppointmentId

		END
	END
	ELSE
	BEGIN
		DECLARE @JourneyStart DATETIME, @JourneyEnd DATETIME
		SELECT @JourneyStart = StartDateTime, @JourneyEnd = EndDateTime FROM ERS_Procedures WHERE ProcedureId = @ProcedureId

		INSERT INTO dbo.ERS_PatientJourney
		(
		    ProcedureId,
		    PatientAdmissionTime,
		    ProcedureStartTime,
		    ProcedureEndTime,
		    PatientDischargeTime,
		    WhoCreatedId,
		    WhenCreated,
		    WhoUpdatedId,
		    WhenUpdated,
		    PatientId,
		    AppointmentId
		)
		VALUES
		(   @ProcedureId,    -- ProcedureId - int
		    NULL,    -- PatientAdmissionTime - datetime
		    @JourneyStart,    -- ProcedureStartTime - datetime
		    @JourneyEnd,    -- ProcedureEndTime - datetime
		    NULL,    -- PatientDischargeTime - datetime
		    @LoggedInUserId,    -- WhoCreatedId - int
		    getdate(), -- WhenCreated - datetime
		    NULL,    -- WhoUpdatedId - int
		    NULL,    -- WhenUpdated - datetime
		    (SELECT PatientId FROM ERS_Procedures WHERE ProcedureId = @ProcedureId),       -- PatientId - int
		    NULL     -- AppointmentId - int
		    )
	END
	
END
GO
------------------------------------------------------------------------------------------------------------------------
-- Spreadsheet #108 End
------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Duncan
-- Spreadsheet #15
-- Description of change
-- Spelling of diverticula/Diverticulum
------------------------------------------------------------------------------------------------------------------------
GO
ALTER PROCEDURE [dbo].[abnormalities_miscellaneous_summary_update]
(
	@SiteId INT
)
AS
	SET NOCOUNT ON

	DECLARE
		@Summary VARCHAR(1200),
		@temp VARCHAR(50),
		@OesoUlcer BIT,
		@None BIT,
		@Web BIT,
		@Mallory BIT,
		@SchatzkiRing BIT,
		@FoodResidue BIT,
		@Foreignbody BIT,
		@ExtrinsicCompression BIT,
		@Diverticulum BIT,
		@DivertMultiple BIT,
		@DivertQty SMALLINT,
		@Pharyngeal BIT,
		@DiffuseIntramural BIT,
		@TractionType BIT,
		@PulsionType BIT,
		@MotilityDisorder BIT,
		@ProbableAchalasia BIT,
		@ConfirmedAchalasia BIT,
		@Presbyoesophagus BIT,
		@MarkedTertiaryContractions BIT,
		@LaxLowerOesoSphincter BIT,
		@TortuousOesophagus BIT,
		@DilatedOesophagus BIT,
		@MotilityPoor BIT,
		@Ulceration BIT,
		@UlcerationType BIT,
		@UlcerationMultiple BIT,
		@UlcerationQty SMALLINT,
		@UlcerationLength SMALLINT,
		@UlcerationClotInBase BIT,
		@UlcerationReflux BIT,
		@UlcerationPostSclero BIT,
		@UlcerationPostBanding BIT,
		@Stricture BIT,
		@StrictureCompression TINYINT,
		@StrictureScopeNotPass BIT,
		@StrictureSeverity TINYINT,
		@StrictureType SMALLINT,
		@StrictureProbably BIT,
		@StrictureBenignType TINYINT,
		@StrictureBeginning SMALLINT,
		@StrictureLength SMALLINT,
		@StricturePerforation TINYINT,
		@Tumour BIT,
		@TumourType TINYINT,
		@TumourProbably BIT,
		@TumourExophytic TINYINT,
		@TumourBenignType TINYINT,
		@TumourBenignTypeOther NVARCHAR(100),
		@TumourBeginning SMALLINT,
		@TumourLength SMALLINT,
		@MiscOther NVARCHAR(150),
		@IsLAClassification BIT,
		@InletPatch BIT,
		@InletPatchMultiple BIT,
		@InletPatchQty SMALLINT,
		@Fitsula BIT,
		@InletPouch BIT,		
		@InletPouchQty SMALLINT,
		@ZLine BIT,
		@ZLineSize INT,
		@Volvulus BIT,
		@AmpullaryAdenoma BIT,
		@StentOcclusion BIT,
		@StentInSitu BIT,
		@PEGInSitu BIT

	SELECT 
		@None				=	[None],
		@Web				=	Web,
		@Mallory			=	Mallory,
		@SchatzkiRing		=	SchatzkiRing,
		@FoodResidue		=	FoodResidue,
		@Foreignbody 		= 	Foreignbody,
		@ExtrinsicCompression	=	ExtrinsicCompression,
		@Diverticulum		=	Diverticulum,
		@DivertMultiple		=	DivertMultiple,
		@DivertQty			=	DivertQty,
		@Pharyngeal			=	Pharyngeal,
		@DiffuseIntramural	=	DiffuseIntramural,
		@TractionType		=	TractionType,
		@PulsionType		=	PulsionType,
		@MotilityDisorder	=	MotilityDisorder,
		@ProbableAchalasia	=	ProbableAchalasia,
		@ConfirmedAchalasia	=	ConfirmedAchalasia,
		@Presbyoesophagus	=	Presbyoesophagus,
		@MarkedTertiaryContractions	=	MarkedTertiaryContractions,
		@LaxLowerOesoSphincter		=	LaxLowerOesoSphincter,
		@TortuousOesophagus		=	TortuousOesophagus,
		@DilatedOesophagus		=	DilatedOesophagus,
		@MotilityPoor			=	MotilityPoor,
		@Ulceration				=	Ulceration,
		@UlcerationType			=	UlcerationType,
		@UlcerationMultiple		=	UlcerationMultiple,
		@UlcerationQty			=	UlcerationQty,
		@UlcerationLength		=	UlcerationLength,
		@UlcerationClotInBase	=	UlcerationClotInBase,
		@UlcerationReflux		=	UlcerationReflux,
		@UlcerationPostSclero	=	UlcerationPostSclero,
		@UlcerationPostBanding	=	UlcerationPostBanding,
		@Stricture				=	Stricture,
		@StrictureCompression	=	StrictureCompression,
		@StrictureScopeNotPass	=	StrictureScopeNotPass,
		@StrictureSeverity		=	StrictureSeverity,
		@StrictureType			=	StrictureType,
		@StrictureProbably		=	StrictureProbably,
		@StrictureBenignType	=	StrictureBenignType,
		@StrictureBeginning		=	StrictureBeginning,
		@StrictureLength		=	StrictureLength,
		@StricturePerforation	=	StricturePerforation,
		@Tumour					=	Tumour,
		@TumourType				=	TumourType,
		@TumourProbably			=	TumourProbably,
		@TumourExophytic		=	TumourExophytic,
		@TumourBenignType		=	TumourBenignType,
		@TumourBenignTypeOther	=	(SELECT isnull(TumourBenignTypeOther, '') as [text()] FOR XML PATH('')),
		@TumourBeginning		=	TumourBeginning,
		@TumourLength			=	TumourLength,
		@MiscOther				=	MiscOther,
		@IsLAClassification		=	ISNULL(IsLAClassification,0),
		@InletPatch				=	InletPatch,
		@InletPatchMultiple		=	InletPatchMultiple,
		@InletPatchQty			=	InletPatchQty,
		@Fitsula				=	Fitsula,
		@InletPouch				=	InletPouch,		
		@InletPouchQty			=	InletPouchQty,
		@ZLine					=	ZLine,
		@ZLineSize				=	ZLineSize,
		@Volvulus				=	Volvulus,
		@AmpullaryAdenoma		=	AmpullaryAdenoma,
		@StentOcclusion			=	StentOcclusion,
		@StentInSitu			=	StentInSitu,
		@PEGInSitu				=	PEGInSitu

	FROM
		ERS_UpperGIAbnoMiscellaneous
	WHERE
		SiteId = @SiteId

	SET @Summary = ''

	IF @None = 1
		SET @Summary = '' --@Summary + 'No varices'
	ELSE 
	BEGIN

		DECLARE @tmpMisc	TABLE(Val VARCHAR(MAX))
		DECLARE @tmpMiscTAR TABLE(Val VARCHAR(MAX))
		DECLARE @UlcerText VARCHAR(500)
		DECLARE @StrictText VARCHAR(500)
		DECLARE @TumourText VARCHAR(500)
		DECLARE @a VARCHAR(500) = ''
		DECLARE @XMLlist XML
		DECLARE @br VARCHAR(7) = '<br />'
		DECLARE @indent VARCHAR(10) = '&nbsp;- ';

		--This line will be ignored in funtion dbo.fnBuildString at the end
		INSERT INTO @tmpMisc (Val) VALUES('~~NoCommas~~')

		IF ISNULL(@Ulceration,0) = 1
		BEGIN
			IF @Ulceration = 1 SET @UlcerText = dbo.fnRepOesoUlcer(@SiteId)
			IF @UlcerText <> '' INSERT INTO @tmpMisc (Val) VALUES(@indent + dbo.fnFirstLetterUpper(RTRIM(LTRIM(@UlcerText))) + '.' + @br)
		END

		IF ISNULL(@Tumour,0) = 1
		BEGIN
			SET @TumourText = dbo.fnRepOesoTumour(@SiteId)
			IF @TumourText <> '' INSERT INTO @tmpMisc (Val) VALUES(@indent + dbo.fnFirstLetterUpper(RTRIM(LTRIM(@TumourText))) + '.' + @br)
		END

		IF ISNULL(@Stricture,0) = 1
		BEGIN
			SET @StrictText = dbo.fnRepOesoStricture(@SiteId)
			IF @StrictText <> '' INSERT INTO @tmpMisc (Val) VALUES(@indent + dbo.fnFirstLetterUpper(RTRIM(LTRIM(@StrictText))) + '.' + @br)
		END

		--IF ISNULL(@TumourText,'') <> '' AND ISNULL(@StrictText,'') <> '' 
		--	SET @a = @TumourText + '. <br />' + @StrictText
		--ELSE
		--SET @a = RTRIM(LTRIM(ISNULL(@TumourText,'') + ISNULL(@StrictText,'')))

		--IF @a <> '' INSERT INTO @tmpMisc (Val) VALUES(@a)

		IF @Web = 1				INSERT INTO @tmpMiscTAR (Val) VALUES('web')
		IF @Mallory = 1			INSERT INTO @tmpMiscTAR (Val) VALUES('Mallory-Weiss tear')
		IF @SchatzkiRing = 1	INSERT INTO @tmpMiscTAR (Val) VALUES('Schatzki ring')
		--IF @ExtrinsicCompression = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('extrinsic compression')
		IF @FoodResidue = 1		INSERT INTO @tmpMiscTAR (Val) VALUES('food residue')
		IF @Foreignbody = 1		INSERT INTO @tmpMiscTAR (Val) VALUES('foreign body')
		IF @Fitsula = 1		INSERT INTO @tmpMiscTAR (Val) VALUES('fitsula')
		IF @AmpullaryAdenoma = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('ampullary adenoma')
		IF @StentOcclusion = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('stent occlusion')
		IF @StentInSitu = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('stent in situ')
		IF @PEGInSitu = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('PEG in situ')
		IF @InletPatch = 1 
		BEGIN
			SET @a = 'inlet patch '
			IF @InletPatchMultiple = 1
				SET @a = @a + 'multiple: '
			ELSE
				SET @a = @a + ': '
			
			IF ISNULL(@InletPatchQty,0) > 0
			BEGIN
				SET @a= @a + CONVERT(VARCHAR, @InletPatchQty) + ' mm'
			END

			INSERT INTO @tmpMiscTAR(Val) VALUES	(@a)
		END

		IF @InletPouch = 1 
		BEGIN
			SET @a = ''
			IF ISNULL(@InletPouchQty,0) > 0
			BEGIN
				IF ISNULL(@InletPouchQty,0) = 1 SET @a='inlet pouch is one mm'
				ELSE SET @a='inlet pouch: ' + CONVERT(VARCHAR, @InletPouchQty) + 'mm '
			END

			INSERT INTO @tmpMiscTAR(Val) VALUES	(@a)
		END

		SET @a = ''

		IF @ZLine = 1 
		BEGIN
			SET @a = 'squamocolumnar (Z Line)'
			IF ISNULL(@ZLineSize,0) > 0
			BEGIN
				SET @a='squamocolumnar (Z Line): ' + CONVERT(VARCHAR, @ZLineSize) + 'cm '
			END

			INSERT INTO @tmpMiscTAR (Val) VALUES(@a)
		END

		SET @a = ''

		IF @Volvulus = 1	INSERT INTO @tmpMiscTAR (Val) VALUES('Volvulus')

		IF (SELECT COUNT(Val) FROM @tmpMiscTAR) > 0 
		BEGIN
			SET @XMLlist = (SELECT Val FROM @tmpMiscTAR FOR XML  RAW, ELEMENTS, TYPE)
			INSERT INTO @tmpMisc (Val) VALUES(@indent + dbo.fnFirstLetterUpper(dbo.fnBuildString(@XMLlist)) + '.' + @br)
			DELETE FROM @tmpMiscTAR
		END

		IF @MotilityDisorder = 1
		BEGIN
			IF @ProbableAchalasia = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('probable achalasia')
			IF @ConfirmedAchalasia = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('confirmed achalasia')
			IF @MarkedTertiaryContractions = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('marked tertiary contractions')
			IF @Presbyoesophagus = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('presbyoesophagus')
			IF @LaxLowerOesoSphincter = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('lax lower oesophageal sphincter')
			IF @TortuousOesophagus = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('tortuous oesophagus')
			IF @DilatedOesophagus = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('dilated oesophagus')
			IF @MotilityPoor = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('poor motility')

			IF (SELECT COUNT(Val) FROM @tmpMiscTAR) > 0 
			BEGIN
				SET @XMLlist = (SELECT Val FROM @tmpMiscTAR FOR XML  RAW, ELEMENTS, TYPE)
				INSERT INTO @tmpMisc (Val) VALUES(@indent + dbo.fnFirstLetterUpper(dbo.fnBuildString(@XMLlist)) + '.' + @br)
				DELETE FROM @tmpMiscTAR
			END
			ELSE --None selected
				INSERT INTO @tmpMisc (Val) VALUES(@indent + dbo.fnFirstLetterUpper('motility disorder') + '.' + @br)
		END


		SET @a = ''

		IF @Diverticulum = 1
		BEGIN
			IF @Pharyngeal = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('pharyngeal (Zenker''s)')
			IF @TractionType = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('traction type')
			IF @PulsionType = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('pulsion type')
			IF @DiffuseIntramural = 1 INSERT INTO @tmpMiscTAR (Val) VALUES('diffuse intramural')

			IF @DivertMultiple = 1 
				SET @a = 'diverticula: Multiple '
			ELSE IF ISNULL(@DivertQty,0) > 0
			BEGIN
				IF ISNULL(@DivertQty,0) = 1 SET @a = 'one diverticulum'
				ELSE SET @a = 'diverticula: ' + CONVERT(VARCHAR, @DivertQty) + ' '
			END
			ELSE 
				SET @a = 'diverticulum: '
			
			IF (SELECT COUNT(Val) FROM @tmpMiscTAR) > 0
			BEGIN
				IF LEFT(@a,3) = 'one' SET @a = @a + ', '
				SET @XMLlist = (SELECT Val FROM @tmpMiscTAR FOR XML  RAW, ELEMENTS, TYPE)
				SET @a =  @a + dbo.fnBuildString(@XMLlist)
			END

			IF LEN(@a) > 0 
			BEGIN
				SET @a = RTRIM(LTRIM(@a))
				IF RIGHT(@a,1) = ':' SET @a = LEFT(@a, LEN(@a) - 1)
				INSERT INTO @tmpMisc (Val) VALUES(@indent + dbo.fnFirstLetterUpper(@a) + '.' + @br)
				DELETE FROM @tmpMiscTAR
			END
		END

		
		IF ISNULL(@MiscOther,'') <> '' 
			INSERT INTO @tmpMisc (Val) VALUES(@indent + dbo.fnFirstLetterUpper(RTRIM(@MiscOther)) + @br)

		SET @XMLlist = (SELECT Val FROM @tmpMisc FOR XML  RAW, ELEMENTS, TYPE)
		SET @Summary = dbo.fnBuildString(@XMLlist)

		IF @Summary <> '' 
		BEGIN
			SET @Summary = LTRIM(RTRIM(@Summary))
			--Remove the first indent as this will be done in SP sites_summary_update
			IF LEFT(@Summary,8) = @indent SET @Summary = RIGHT(@Summary, LEN(@Summary) - 8)
			IF RIGHT(@Summary,6) = @br SET @Summary = LEFT(@Summary, LEN(@Summary) - 6)
			IF RIGHT(@Summary,1) = '.' SET @Summary = LEFT(@Summary, LEN(@Summary) - 1)
		END
	END

	-- Finally update the summary in abnormalities table
	UPDATE ERS_UpperGIAbnoMiscellaneous
	SET Summary = @Summary 
	WHERE SiteId = @siteId
GO

GO
------------------------------------------------------------------------------------------------------------------------
-- Spreadsheet #15 End
------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Chris Gammage 12/12/2023
-- TFS#	3674
-- Description of change; update to ERCP Planned Procedure
-- 
------------------------------------------------------------------------------------------------------------------------
GO
PRINT 'update to ERCP Planned Procedure'
DECLARE @IndicationId INT,
		@PlannedProceduresSectionId INT

SELECT @PlannedProceduresSectionId = IndicationSectionId
FROM ERS_IndicationSections
WHERE SectionName = 'Planned procedures'


If NOT EXISTS ( SELECT 1
				FROM ERS_Indications
				WHERE Description = 'Ampullectomy'
				AND NEDTerm = 'Other'
				AND IndicationSectionId = @PlannedProceduresSectionId)
BEGIN
	PRINT '   Inserting Ampullectomy'

	INSERT INTO ERS_Indications (Description, NEDTerm, IndicationSectionId)
	VALUES ('Ampullectomy', 'Other', @PlannedProceduresSectionId);

	SET @IndicationId = SCOPE_IDENTITY()

	INSERT INTO ERS_IndicationsProcedureTypes (IndicationId, ProcedureTypeId)
	VALUES (@IndicationId, 2);
END

If NOT EXISTS ( SELECT 1
				FROM ERS_Indications
				WHERE Description = 'Stent (Re)Placement'
				AND NEDTerm = 'Other'
				AND IndicationSectionId = @PlannedProceduresSectionId)
BEGIN
	PRINT '   Inserting Stent (Re)Placement'

	INSERT INTO ERS_Indications (Description, NEDTerm, IndicationSectionId)
	VALUES ('Stent (Re)Placement', 'Other', @PlannedProceduresSectionId);

	SET @IndicationId = SCOPE_IDENTITY()

	INSERT INTO ERS_IndicationsProcedureTypes (IndicationId, ProcedureTypeId)
	VALUES (@IndicationId, 2);
END

If NOT EXISTS ( SELECT 1
				FROM ERS_Indications
				WHERE Description = 'Stent Removal/Extracting'
				AND NEDTerm = 'Other'
				AND IndicationSectionId = @PlannedProceduresSectionId)
BEGIN
	PRINT '   Inserting Stent Removal/Extracting'

	INSERT INTO ERS_Indications (Description, NEDTerm, IndicationSectionId)
	VALUES ('Stent Removal/Extracting', 'Other', @PlannedProceduresSectionId);

	SET @IndicationId = SCOPE_IDENTITY()

	INSERT INTO ERS_IndicationsProcedureTypes (IndicationId, ProcedureTypeId)
	VALUES (@IndicationId, 2);
END

GO


 ------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Duncan
-- TFS#	XXXX
-- Added ExistingHospitalId to creation of new operating hospital when adding a new trust
-- 
------------------------------------------------------------------------------------------------------------------------
GO
ALTER PROCEDURE [dbo].[trust_insert] (@trustId int, @TrustName varchar(150))
as
BEGIN
	If exists (Select 1 from ERS_Trusts where TrustId = @trustId)
		update ERS_Trusts
		set	TrustName = @TrustName
		where TrustId = @trustId
	else
	BEGIN
		insert into ERS_Trusts (TrustName)
		values (@TrustName)

		DECLARE @NewTrustId INT 
		SELECT @NewTrustId = TrustId FROM ERS_Trusts WHERE TrustName = @TrustName
		EXEC create_default_roles @TrustId=@NewTrustId
		EXEC add_new_operating_hospital @ExistingHospitalID = 0, @InternalHospitalID='',@NHSHospitalID='',@TrustId=@NewTrustId, @HospitalName='Default Hospital',@ContactNumber='',@ReportExportPath='',@ReportHeading='Default Hospital',@ReportTrustType='NHS Trust',@ReportSubHeading='',@ReportFooter='',@DepartmentName='',@NEDExportPath='',@NEDODSCode='',@LoggedInUserId=1,@CopyPrintSettings=1,@CopyPhraseLibrary=0,@ImportPatientByWebservice=0,@AddExportFileForMirth=1,@ExportDocumentFilePrefix='',@TrustName=''
	END
END
GO

------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Duncan
-- TFS#	XXXX
-- Add Tumour to stomach
-- 
------------------------------------------------------------------------------------------------------------------------
GO

If (Select count(1) from ERS_DiagnosesMatrix where Code = 'D93P1') > 1
Delete from ERS_DiagnosesMatrix where DiagnosesMatrixID = (
	Select top 1 DiagnosesMatrixID
	from ERS_DiagnosesMatrix 
	where Code = 'D93P1'
	and ProcedureTypeId = 1
	and Section = 'Duodenum'
	order by DiagnosesMatrixID desc)

GO


ALTER TRIGGER [dbo].[TR_CommonAbnoTumour]
ON [dbo].[ERS_CommonAbnoTumour]
AFTER INSERT, UPDATE, DELETE
AS 
	DECLARE @site_id INT, @DuoPolyp VARCHAR(10) = 'False', @Tumour VARCHAR(10) = 'False', @TumourComplex VARCHAR(10) = 'False', @TumourType VARCHAR(10),
			@ERCPTumour VARCHAR(10) = 'False', @ProbableCarcinoma VARCHAR(10) = 'False', 
			@ProbableLymphoma VARCHAR(10) = 'False',
			@Action CHAR(1) = 'I',
			@DuoTumourBenign VARCHAR(10) = 'False', @DuoTumourMalignant VARCHAR(10) = 'False',
			@Region VARCHAR(100), @ProcedureType INT,
			--@BenignTumour VARCHAR(10) = 'False', @MalignantTumour VARCHAR(10) = 'False'
			@TumourComplexDetails VARCHAR(10) = 'False', @TumourProbably VARCHAR(10) = 'False', @TumourExophytic VARCHAR(10) = 'False', @TumourBenignType INT, @AdeTest BIT

    IF EXISTS(SELECT * FROM DELETED) SET @Action = CASE WHEN EXISTS(SELECT * FROM INSERTED) THEN 'U' ELSE 'D' END
		
	--INSERT INTO ADE_Diagnoses_Control_Save_SP_Debug_Table ([Action], ActionValue) SELECT 'Table Action', '@Table Value: ' + @Action

	-- INSERTED OR UPDATED
	IF @Action IN ('I', 'U') 
	BEGIN

		SELECT	
			@site_id = SiteId,			
			@TumourComplex = CASE WHEN Inserted.Tumour = 1 THEN 'True' ELSE 'False' END,

			--Complex Tumour Details
			@TumourType = CASE WHEN Inserted.[Type] = 1 THEN 'Benign' WHEN Inserted.[Type] = 2 THEN 'Malignant' ELSE 'Nothing' END,
			@TumourComplexDetails = CASE WHEN Inserted.TumourComplexDetails = 1 THEN 'True' ELSE 'False' END,
			@TumourProbably = CASE WHEN Inserted.TumourProbably = 1 THEN 'True' ELSE 'False' END,
			@TumourExophytic = CASE WHEN Inserted.TumourExophytic = 1 THEN 'True' ELSE 'False' END,
			@TumourBenignType = Inserted.TumourBenignType,
			@AdeTest = Inserted.TumourComplexDetails,

			--Simple Tumour Details
			@DuoPolyp = (CASE WHEN ([Type] = 1) THEN 'True' ELSE 'False' END),
			@Tumour = CASE WHEN @DuoPolyp = 'False' AND Inserted.Type = 2 THEN 'True' ELSE 'False' END,
			--@ERCPTumour = (CASE WHEN ([Type] IN (2,3)) THEN 'True' ELSE 'False' END),
			--@DuoTumourBenign = (CASE WHEN ([Type] = 1) THEN 'True' ELSE 'False' END),
			@ProbableLymphoma = (CASE WHEN [Type] = 2 THEN 'True' ELSE 'False' END),
			@ProbableCarcinoma = (CASE WHEN [Type] = 3 THEN 'True' ELSE 'False' END),
			@DuoTumourMalignant = (CASE WHEN ([Type] = 4) THEN 'True' ELSE 'False' END)			
		FROM 
			INSERTED		

		SELECT
			DISTINCT @Region = eamug.Area
		FROM 
			dbo.ERS_Sites AS es
			INNER JOIN dbo.ERS_Regions AS er ON er.RegionId = es.RegionId
			INNER JOIN dbo.ERS_AbnormalitiesMatrixUpperGI AS eamug ON eamug.Region = er.Region
		WHERE 
			es.SiteId = @site_Id

		EXEC abnormalities_tumour_summary_update @site_id
	END

	-- DELETED
	IF @Action = 'D'
	BEGIN
		SELECT @site_id = SiteId, @TumourComplexDetails = 'True' FROM DELETED
		SELECT
			DISTINCT @Region = eamug.Area
		FROM 
			dbo.ERS_Sites AS es
			INNER JOIN dbo.ERS_Regions AS er ON er.RegionId = es.RegionId
			INNER JOIN dbo.ERS_AbnormalitiesMatrixUpperGI AS eamug ON eamug.Region = er.Region
		WHERE 
			es.SiteId = @site_Id
	END

	EXEC sites_summary_update @site_id

	--INSERT INTO ADE_Diagnoses_Control_Save_SP_Debug_Table ([Action], ActionValue) SELECT 'TR_CommonAbnoTumour', '@TumourComplexDetails: ' + @TumourComplexDetails
	--INSERT INTO ADE_Diagnoses_Control_Save_SP_Debug_Table ([Action], ActionValue) SELECT 'TR_CommonAbnoTumour', '@Region: ' + @Region

	IF @TumourComplexDetails = 'False'
	BEGIN
		IF @Region = 'Oesophagus'
		BEGIN
			EXEC diagnoses_control_save @site_id, 'D74P1', @Tumour					-- 'Tumour'		
			EXEC diagnoses_control_save @site_id, 'D74P1', @ProbableLymphoma		-- 'Probable lymphoma'
			--EXEC diagnoses_control_save @site_id, 'D58P1', @DuoPolyp				-- 'DuoPolyp'
			EXEC diagnoses_control_save @site_id, 'D34P1', @DuoTumourMalignant		-- 'Confirmed carcinoma'
			EXEC diagnoses_control_save @site_id, 'D74P1', @ProbableCarcinoma		-- 'Probable carcinoma'
			--EXEC diagnoses_control_save @site_id, 'D55P2', @ERCPTumour			-- 'ERCP tumour'
			--EXEC diagnoses_control_save @site_id, 'D92P1', @DuoTumourBenign		-- 'Tumour benign'
		END
		ELSE IF @Region = 'Duodenum'
		BEGIN
			EXEC diagnoses_control_save @site_id, 'D55P1', @Tumour					-- 'Tumour'		
			EXEC diagnoses_control_save @site_id, 'D55P1', @ProbableLymphoma		-- 'Probable lymphoma'
			EXEC diagnoses_control_save @site_id, 'D58P1', @DuoPolyp				-- 'DuoPolyp'
			EXEC diagnoses_control_save @site_id, 'D93P1', @DuoTumourMalignant		-- 'Confirmed carcinoma'
			EXEC diagnoses_control_save @site_id, 'D74P1', @ProbableCarcinoma		-- 'Probable carcinoma'
		END
	END
	ELSE IF @TumourComplexDetails = 'True'
	BEGIN
		IF @Region = 'Oesophagus'
		BEGIN
			IF @TumourComplex = 'True' AND @TumourType = 'Nothing'
			BEGIN
				EXEC diagnoses_control_save @site_id, 'D74P1', 'True'						
				EXEC diagnoses_control_save @site_id, 'D25P1', 'False'
				EXEC diagnoses_control_save @site_id, 'D34P1', 'False'
				EXEC diagnoses_control_save @site_id, 'D29P1', 'False'	
				EXEC diagnoses_control_save @site_id, 'D37P1', 'False'
			END
			ELSE IF @TumourComplex = 'True' AND @TumourType = 'Benign' AND @TumourProbably = 'False'
			BEGIN
				EXEC diagnoses_control_save @site_id, 'D74P1', 'False'						
				EXEC diagnoses_control_save @site_id, 'D25P1', 'True'
				EXEC diagnoses_control_save @site_id, 'D34P1', 'False'
				EXEC diagnoses_control_save @site_id, 'D29P1', 'False'	
				EXEC diagnoses_control_save @site_id, 'D37P1', 'False'
			END
			ELSE IF @TumourComplex = 'True' AND @TumourType = 'Malignant' AND @TumourProbably = 'False'
			BEGIN
				EXEC diagnoses_control_save @site_id, 'D74P1', 'False'						
				EXEC diagnoses_control_save @site_id, 'D25P1', 'False'
				EXEC diagnoses_control_save @site_id, 'D34P1', 'True'
				EXEC diagnoses_control_save @site_id, 'D29P1', 'False'	
				EXEC diagnoses_control_save @site_id, 'D37P1', 'False'
			END
			ELSE IF @TumourComplex = 'True' AND @TumourType = 'Benign' AND @TumourProbably != 'False'
			BEGIN
				EXEC diagnoses_control_save @site_id, 'D74P1', 'False'						
				EXEC diagnoses_control_save @site_id, 'D25P1', 'False'
				EXEC diagnoses_control_save @site_id, 'D34P1', 'False'
				EXEC diagnoses_control_save @site_id, 'D29P1', 'True'	
				EXEC diagnoses_control_save @site_id, 'D37P1', 'False'
			END
			ELSE IF @TumourComplex = 'True' AND @TumourType = 'Malignant' AND @TumourProbably != 'False'
			BEGIN
				EXEC diagnoses_control_save @site_id, 'D74P1', 'False'						
				EXEC diagnoses_control_save @site_id, 'D25P1', 'False'
				EXEC diagnoses_control_save @site_id, 'D34P1', 'False'
				EXEC diagnoses_control_save @site_id, 'D29P1', 'False'	
				EXEC diagnoses_control_save @site_id, 'D37P1', 'True'
			END
			ELSE
			BEGIN
				EXEC diagnoses_control_save @site_id, 'D74P1', 'False'						
				EXEC diagnoses_control_save @site_id, 'D25P1', 'False'
				EXEC diagnoses_control_save @site_id, 'D34P1', 'False'
				EXEC diagnoses_control_save @site_id, 'D29P1', 'False'	
				EXEC diagnoses_control_save @site_id, 'D37P1', 'False'
			END
		END
		ELSE IF @Region = 'Duodenum'
		BEGIN
			IF @TumourComplex = 'True' AND @TumourType = 'Nothing'
			BEGIN
				EXEC diagnoses_control_save @site_id, 'D55P1', 'True'						-- 'Tumour'
				EXEC diagnoses_control_save @site_id, 'D92P1', 'False'						-- 'Tumour, benign'
				EXEC diagnoses_control_save @site_id, 'D93P1', 'False'						-- 'Tumour, malignant'			
				EXEC diagnoses_control_save @site_id, 'DP92P1', 'False'						-- 'Tumour, probably benign'
				EXEC diagnoses_control_save @site_id, 'DP93P1', 'False'						-- 'Tumour, probably malignant'
			END
			ELSE IF @TumourComplex = 'True' AND @TumourType = 'Benign' AND @TumourProbably = 'False'
			BEGIN
				EXEC diagnoses_control_save @site_id, 'D55P1', 'False'						-- 'Tumour'
				EXEC diagnoses_control_save @site_id, 'D92P1', 'True'						-- 'Tumour, benign'
				EXEC diagnoses_control_save @site_id, 'D93P1', 'False'						-- 'Tumour, malignant'			
				EXEC diagnoses_control_save @site_id, 'DP92P1', 'False'						-- 'Tumour, probably benign'
				EXEC diagnoses_control_save @site_id, 'DP93P1', 'False'						-- 'Tumour, probably malignant'
			END
			ELSE IF @TumourComplex = 'True' AND @TumourType = 'Malignant' AND @TumourProbably = 'False'
			BEGIN
				EXEC diagnoses_control_save @site_id, 'D55P1', 'False'						-- 'Tumour'
				EXEC diagnoses_control_save @site_id, 'D92P1', 'False'						-- 'Tumour, benign'
				EXEC diagnoses_control_save @site_id, 'D93P1', 'True'						-- 'Tumour, malignant'			
				EXEC diagnoses_control_save @site_id, 'DP92P1', 'False'						-- 'Tumour, probably benign'
				EXEC diagnoses_control_save @site_id, 'DP93P1', 'False'						-- 'Tumour, probably malignant'
			END		
			ELSE IF @TumourComplex = 'True' AND @TumourType = 'Benign' AND @TumourProbably != 'False'
			BEGIN
				EXEC diagnoses_control_save @site_id, 'D55P1', 'False'						-- 'Tumour'
				EXEC diagnoses_control_save @site_id, 'D92P1', 'False'						-- 'Tumour, benign'
				EXEC diagnoses_control_save @site_id, 'D93P1', 'False'						-- 'Tumour, malignant'			
				EXEC diagnoses_control_save @site_id, 'DP92P1', 'True'						-- 'Tumour, probably benign'
				EXEC diagnoses_control_save @site_id, 'DP93P1', 'False'						-- 'Tumour, probably malignant'
			END
			ELSE IF @TumourComplex = 'True' AND @TumourType = 'Malignant' AND @TumourProbably != 'False'
			BEGIN
				EXEC diagnoses_control_save @site_id, 'D55P1', 'False'						-- 'Tumour'
				EXEC diagnoses_control_save @site_id, 'D92P1', 'False'						-- 'Tumour, benign'
				EXEC diagnoses_control_save @site_id, 'D93P1', 'False'						-- 'Tumour, malignant'			
				EXEC diagnoses_control_save @site_id, 'DP92P1', 'False'						-- 'Tumour, probably benign'
				EXEC diagnoses_control_save @site_id, 'DP93P1', 'True'						-- 'Tumour, probably malignant'
			END
			ELSE
			BEGIN
				EXEC diagnoses_control_save @site_id, 'D55P1', 'False'						-- 'Tumour'
				EXEC diagnoses_control_save @site_id, 'D92P1', 'False'						-- 'Tumour, benign'
				EXEC diagnoses_control_save @site_id, 'D93P1', 'False'						-- 'Tumour, malignant'			
				EXEC diagnoses_control_save @site_id, 'DP92P1', 'False'						-- 'Tumour, probably benign'
				EXEC diagnoses_control_save @site_id, 'DP93P1', 'False'						-- 'Tumour, probably malignant'
			END
		END	
		ELSE IF @Region = 'Stomach'
		BEGIN
			IF @TumourComplex = 'True' AND @TumourType = 'Nothing'
			BEGIN
				EXEC diagnoses_control_save @site_id, 'DS85P1', 'True'						-- 'Tumour'
				EXEC diagnoses_control_save @site_id, 'D86P1', 'False'						-- 'Tumour, benign'
				EXEC diagnoses_control_save @site_id, 'D87P1', 'False'						-- 'Tumour, malignant'			
				EXEC diagnoses_control_save @site_id, 'DS86P1', 'False'						-- 'Tumour, probably benign'
				EXEC diagnoses_control_save @site_id, 'DS87P1', 'False'						-- 'Tumour, probably malignant'
			END
			ELSE IF @TumourComplex = 'True' AND @TumourType = 'Benign' AND @TumourProbably = 'False'
			BEGIN
				EXEC diagnoses_control_save @site_id, 'DS85P1', 'False'						-- 'Tumour'
				EXEC diagnoses_control_save @site_id, 'D86P1', 'True'						-- 'Tumour, benign'
				EXEC diagnoses_control_save @site_id, 'D87P1', 'False'						-- 'Tumour, malignant'			
				EXEC diagnoses_control_save @site_id, 'DS86P1', 'False'						-- 'Tumour, probably benign'
				EXEC diagnoses_control_save @site_id, 'DS87P1', 'False'						-- 'Tumour, probably malignant'
			END
			ELSE IF @TumourComplex = 'True' AND @TumourType = 'Malignant' AND @TumourProbably = 'False'
			BEGIN
				EXEC diagnoses_control_save @site_id, 'DS85P1', 'False'						-- 'Tumour'
				EXEC diagnoses_control_save @site_id, 'D86P1', 'False'						-- 'Tumour, benign'
				EXEC diagnoses_control_save @site_id, 'D87P1', 'True'						-- 'Tumour, malignant'			
				EXEC diagnoses_control_save @site_id, 'DS86P1', 'False'						-- 'Tumour, probably benign'
				EXEC diagnoses_control_save @site_id, 'DS87P1', 'False'						-- 'Tumour, probably malignant'
			END		
			ELSE IF @TumourComplex = 'True' AND @TumourType = 'Benign' AND @TumourProbably != 'False'
			BEGIN
				EXEC diagnoses_control_save @site_id, 'DS85P1', 'False'						-- 'Tumour'
				EXEC diagnoses_control_save @site_id, 'D86P1', 'False'						-- 'Tumour, benign'
				EXEC diagnoses_control_save @site_id, 'D87P1', 'False'						-- 'Tumour, malignant'			
				EXEC diagnoses_control_save @site_id, 'DS86P1', 'True'						-- 'Tumour, probably benign'
				EXEC diagnoses_control_save @site_id, 'DS87P1', 'False'						-- 'Tumour, probably malignant'
			END
			ELSE IF @TumourComplex = 'True' AND @TumourType = 'Malignant' AND @TumourProbably != 'False'
			BEGIN
				EXEC diagnoses_control_save @site_id, 'DS85P1', 'False'						-- 'Tumour'
				EXEC diagnoses_control_save @site_id, 'D86P1', 'False'						-- 'Tumour, benign'
				EXEC diagnoses_control_save @site_id, 'D87P1', 'False'						-- 'Tumour, malignant'			
				EXEC diagnoses_control_save @site_id, 'DS86P1', 'False'						-- 'Tumour, probably benign'
				EXEC diagnoses_control_save @site_id, 'DS87P1', 'True'						-- 'Tumour, probably malignant'
			END
			ELSE
			BEGIN
				EXEC diagnoses_control_save @site_id, 'DS85P1', 'False'						-- 'Tumour'
				EXEC diagnoses_control_save @site_id, 'D86P1', 'False'						-- 'Tumour, benign'
				EXEC diagnoses_control_save @site_id, 'D87P1', 'False'						-- 'Tumour, malignant'			
				EXEC diagnoses_control_save @site_id, 'DS86P1', 'False'						-- 'Tumour, probably benign'
				EXEC diagnoses_control_save @site_id, 'DS87P1', 'False'						-- 'Tumour, probably malignant'
			END
		END	


	--EXEC diagnoses_control_save @site_id, 'D74P1', @Tumour	
	--		EXEC diagnoses_control_save @site_id, '', @TumourType,
	--		@TumourComplexDetails = CASE WHEN Inserted.TumourComplexDetails = 1 THEN 'True' ELSE 'False' END,
	--		@TumourProbably = CASE WHEN Inserted.TumourProbably = 1 THEN 'True' ELSE 'False' END,
	--		@TumourExophytic = CASE WHEN Inserted.TumourExophytic = 1 THEN 'True' ELSE 'False' END,
	--		@TumourBenignType-- 'Tumour'



	END
GO
------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	XXXX
------------------------------------------------------------------------------------------------------------------------


------------------------------------------------------------------------------------------------------------------------
-- Updated by	:	Andrea
-- TFS#	
-- Description of change
-- Submucosal, focal leasions and fundic glad polyps to produce their own diagnoses
------------------------------------------------------------------------------------------------------------------------
GO


SET QUOTED_IDENTIFIER ON
SET ANSI_NULLS ON
GO

ALTER PROCEDURE [dbo].common_polyp_diagnosis_update
(
	@SiteId int
)
AS

DECLARE @Polyp VARCHAR(10) = 'False',
		@Region VARCHAR(20), 
		@ProcedureTypeId INT = (SELECT TOP 1 p.ProcedureType FROM ERS_Sites s INNER JOIN ERS_Procedures p ON p.ProcedureId = s.ProcedureId WHERE s.SiteId = @SiteId), 
		@FocalLesions VARCHAR(10) = 'False',
		@FocalLesionsTypeId INT,
		@SubmucoaslLesion VARCHAR(10) = 'False',
		@SubmucoaslLesionTypeId INT,
		@FundicGlandPolyp VARCHAR(10) = 'False',
		@FundicGlandPolypId INT,
		@MatrixCode VARCHAR(50)

BEGIN TRANSACTION

BEGIN TRY
	SELECT * INTO #PolypTypes FROM dbo.ERS_PolypTypes

	SELECT	@Polyp = (CASE WHEN ISNULL(COUNT(PolypTypeId),0) > 0 AND PolypTypeId NOT IN (SELECT UniqueId FROM #PolypTypes WHERE Description IN ('Focal lesions','Submucosal','Fundic Gland Polyp')) THEN 'True' ELSE 'False' END),
			@FocalLesions = (CASE WHEN PolypTypeId = (SELECT UniqueId FROM #PolypTypes WHERE Description = 'Focal lesions') THEN 'True' ELSE 'False' END),
			@SubmucoaslLesion = (CASE WHEN PolypTypeId = (SELECT UniqueId FROM #PolypTypes WHERE Description = 'Submucosal') THEN 'True' ELSE 'False' END),
			@FundicGlandPolyp = (CASE WHEN PolypTypeId = (SELECT UniqueId FROM #PolypTypes WHERE Description = 'Fundic Gland Polyp') THEN 'True' ELSE 'False' END),
			@Region = dbo.fnSiteRegion(@SiteId)
	FROM ERS_CommonAbnoPolypDetails
	WHERE SiteId = @SiteId
	GROUP BY SiteId, PolypTypeId
		
	IF (@Polyp = 'True')
	BEGIN
		IF @ProcedureTypeId IN (1,6,8)
		BEGIN
			IF LOWER(@Region) = 'stomach'
				SET @MatrixCode = 'D40P1'
			ELSE IF LOWER(@Region) = 'oesophagus'
				SET @MatrixCode = 'N2013'
			ELSE IF LOWER(@Region) = 'duodenum'
				SET @MatrixCode = 'D58P1'
			ELSE IF LOWER(@Region) = 'colon'
				SET @MatrixCode = 'D58P1'				
		END
		ELSE IF @ProcedureTypeId IN (3,4,9)
		BEGIN
			IF @Region IN ('Rectum', 'Anal Margin')
				SET @MatrixCode = 'D4P3'
			ELSE IF @Region IN ('Terminal Ileum', 'Neo-Terminal Ileum')
				SET @MatrixCode = 'DIPOLYPP3'
			ELSE
				SET @MatrixCode = 'D12P3'
		END
	END


	IF @SiteId IS NOT NULL AND @ProcedureTypeId IN (1,3,4,6,8,9)
	BEGIN
		EXEC sites_summary_update @SiteId

		EXEC diagnoses_control_save @SiteId, @MatrixCode, @Polyp
			
		EXEC diagnoses_control_save @SiteId, 'N2001', @FocalLesions
		EXEC diagnoses_control_save @SiteId, 'N2002', @SubmucoaslLesion
		EXEC diagnoses_control_save @SiteId, 'N2019', @FundicGlandPolyp
	END

	EXEC abnormalities_common_lesions_summary_update @SiteId
END TRY

BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE();
    
    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);

	IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
END CATCH


IF @@TRANCOUNT > 0 COMMIT TRANSACTION;


GO



------------------------------------------------------------------------------------------------------------------------
-- END OF TFS#	
------------------------------------------------------------------------------------------------------------------------

EXEC dbo.DropIfExist 
    @ObjectName = 'common_polpydetails_summary', 
    @ObjectTypePrefix = 'F' 
GO


CREATE FUNCTION [dbo].[common_polpydetails_summary]
(
	@SiteId int,
	@PolypDetailId int = NULL
)
RETURNS VARCHAR(max)
AS
BEGIN
	DECLARE 
	@PolypType varchar(100),
	@TumourType varchar(100),
	@PolypCondition varchar(100), 
	@Tattooed varchar(100),
	@TattooMarkingType varchar(100),
	--@PolypDetailId int,
	@Quantity int,
	@summary varchar(max) = '',
	@Probably bit,
	@TumourTypeId int,
	@Size int,
	@ParisClass int,
	@PitPattern int,
	@Excised int,
	@Retrieved int,
	@ToLabs int,
	@Removal int,
	@RemovalType varchar(10) = '',
	@RemovalMethod int,
	@RemovalBy varchar(500) = '',
	@Inflam bit,
	@PostInflam bit,
	@TattooedId int,
	@TattooMarkingTypeId int,
	@Count int,
	@Submucosal BIT,
	@SubmucosalQuantity INT,
	@SubmucosalLargest INT,
	@SubmucosalProbably BIT,
	@SubmucosalTypeId TINYINT,
	@Focal BIT,
	@FocalQuantity INT,
	@FocalLargest INT,
	@FocalProbably BIT,
	@FocalTypeId TINYINT,
	@FundicGlandPolyp BIT,
	@FundicGlandPolypQuantity INT,
	@FundicGlandPolypLargest Numeric(18,2)
	
	--saves calling the table multiple times :)
	DECLARE @TumourTypes TABLE (TypeId int, [Description] varchar(100))
	INSERT INTO @TumourTypes
	SELECT UniqueId, [Description] 
	FROM ERS_TumourTypes 
	WHERE Suppressed = 0

	SELECT 
	@Submucosal =iif(b.description='Submucosal',1,0),
	@SubmucosalTypeId = a.type,
	@SubmucosalLargest = a.SubmucosalLargest,
	@SubmucosalProbably = a.Probably,
	@SubmucosalQuantity = a.SubmucosalQuantity,
	@Focal = iif(b.description='Focal lesions',1,0),
	@FocalTypeId = a.type,
	@FocalLargest = a.FocalLargest,
	@FocalProbably = a.Probably,
	@FocalQuantity = a.FocalQuantity,
	@FundicGlandPolyp = iif(b.description='Fundic Gland Polyp',1,0),
	@FundicGlandPolypQuantity = FundicGlandPolypQuantity,
	@FundicGlandPolypLargest = FundicGlandPolypLargest
FROM
	ERS_CommonAbnoPolypDetails a left join ERS_PolypTypes b on a.PolypTypeId=b.uniqueid
WHERE
	SiteId = @SiteId and PolypDetailId = ISNULL(@PolypDetailId, PolypDetailId)


	SELECT @Quantity = count(*)
	FROM ERS_CommonAbnoPolypDetails WHERE SiteId = @SiteId AND PolypDetailId = ISNULL(@PolypDetailId, PolypDetailId)

	SELECT @PolypType = LOWER([Description])
	FROM ERS_PolypTypes pt
		INNER JOIN ERS_CommonAbnoPolypDetails l ON pt.UniqueId = l.PolypTypeId
	WHERE SiteId = @SiteId


	DECLARE cur CURSOR FOR
	SELECT ecapd.PolypDetailId, ecapd.Size, ecapd.Excised, ecapd.Retreived, ecapd.Successful, ecapd.Removal, ecapd.RemovalMethod, ecapd.Probably, ecapd.Type, ecapd.ParisClass, ecapd.PitPattern, 
		ecapd.Infammatory, ecapd.PostInflammatory, ecapd.TattooedId, ecapd.TattooedMarkingTypeId
	FROM dbo.ERS_CommonAbnoPolypDetails ecapd
	WHERE SiteId = @SiteId AND PolypDetailId = ISNULL(@PolypDetailId, PolypDetailId)

	SET @summary = CASE WHEN @PolypDetailId IS NULL THEN CONVERT(VARCHAR(10), @Quantity) + ' ' + @PolypType + CASE WHEN @Quantity = 1 THEN ' polyp' ELSE ' polyps' END ELSE '' END



	------------------------------------------------------------------------------------------
	-------	SUBMUCOSAL LESION -------
	------------------------------------------------------------------------------------------
	IF @Submucosal > 0
	BEGIN
		IF @summary <> '' SET @summary = @summary + '##'

		IF @SubmucosalQuantity > 1 SET @summary = @summary + CONVERT(VARCHAR(20), @SubmucosalQuantity) + ' '
		ELSE SET @summary = @summary + 'A '
		
		IF @SubmucosalProbably = 1 SET @summary = @summary + 'probably '

		SELECT @summary = @summary + LOWER([Description]) + ' ' FROM @TumourTypes WHERE TypeId = @SubmucosalTypeId

		IF @SubmucosalQuantity > 1 SET @summary = @summary + 'submucosal lesions ' ELSE SET @summary = @summary + 'submucosal lesion ' 

		IF (@SubmucosalQuantity > 0 AND @SubmucosalLargest > 0) 
		BEGIN
			IF @SubmucosalQuantity > 1
				SET @summary = @summary + '(largest ' + CONVERT(VARCHAR(20), @SubmucosalLargest) + 'mm) '
			ELSE
				SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @SubmucosalLargest) + 'mm) '
		END
	END

	------------------------------------------------------------------------------------------
	-------	FOCAL LESIONS -------
	------------------------------------------------------------------------------------------
	IF @Focal > 0
	BEGIN
		IF @summary <> '' SET @summary = @summary + '##'

		IF @FocalQuantity > 1 SET @summary = @summary + CONVERT(VARCHAR(20), @FocalQuantity) + ' '
		ELSE SET @summary = @summary + 'A '
		
		IF @FocalProbably = 1 SET @summary = @summary + 'probably '

		SELECT @summary = @summary + LOWER([Description]) + ' ' FROM @TumourTypes WHERE TypeId = @FocalTypeId

		IF @FocalQuantity > 1 SET @summary = @summary + 'focal lesions ' ELSE SET @summary = @summary + 'submucosal lesion ' 

		IF (@FocalQuantity > 0 AND @FocalLargest > 0) 
		BEGIN
			IF @FocalQuantity > 1
				SET @summary = @summary + '(largest ' + CONVERT(VARCHAR(20), @FocalLargest) + 'mm) '
			ELSE
				SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @FocalLargest) + 'mm) '
		END
	END
	-------------------------------------------------------------------------------------------
	-------	Fundic Gland Polyp -------
	------------------------------------------------------------------------------------------
	IF @FundicGlandPolyp > 0
	BEGIN
		IF @summary <> '' SET @summary = @summary + '##'

		IF @FundicGlandPolypQuantity > 1 SET @summary = @summary + CONVERT(VARCHAR(20), @FundicGlandPolypQuantity) + ' '
		ELSE SET @summary = @summary + 'A '
		
		IF @FundicGlandPolypQuantity > 1 SET @summary = @summary + 'Fundic Gland Polyp found ' ELSE SET @summary = @summary + 'Fundic Gland Polyp found ' --TFS-2958---

		IF (@FundicGlandPolypQuantity > 0 AND @FundicGlandPolypLargest > 0) 
		BEGIN
			IF @FundicGlandPolypQuantity > 1
				SET @summary = @summary + '(largest ' + CONVERT(VARCHAR(20), @FundicGlandPolypLargest) + ' mm) '
			ELSE
				SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @FundicGlandPolypLargest) + ' mm) '
		END
	END


	SET @Count = 1
	--loop through records
	OPEN cur
	FETCH NEXT FROM cur INTO @PolypDetailId, @Size, @Excised, @Retrieved, @ToLabs, @Removal, @RemovalMethod, @Probably, @TumourTypeId, @ParisClass, @PitPattern, @Inflam, @PostInflam, @TattooedId, @TattooMarkingTypeId

	WHILE @@FETCH_STATUS = 0 
	BEGIN
		SET  @Tattooed = NULL
		SET @TumourType = ''
		SET @TattooMarkingType = NULL

		--build up summary report
		SELECT @TumourType = LOWER(ISNULL([Description],''))
		FROM ERS_TumourTypes
		WHERE UniqueId = @TumourTypeId

		SELECT @Tattooed = LOWER([Description])
		FROM ERS_TattooOptions
		WHERE UniqueId = @TattooedId

		SELECT @TattooMarkingType = LOWER(ISNULL([Description],''))
		FROM ERS_MarkingTypes
		WHERE UniqueId = @TattooMarkingTypeId

		SELECT @PolypCondition = (
			SELECT STUFF((SELECT ', ' + LOWER(ISNULL([SummaryTerm],''))as [text()] 
		    FROM ERS_CommonAbnoPolypConditions cc
				INNER JOIN ERS_PolypConditions pd on cc.PolypConditionId = pd.UniqueId
			WHERE PolypDetailId = @PolypDetailId AND [Description] <> 'Hyperplastic'
			ORDER BY ISNULL(ListOrderBy,9999)
		    FOR XML PATH('')),1,1,''))
		
		SELECT @RemovalType = LOWER([Description])
		FROM ERS_PolypRemovalMethods
		WHERE UniqueId = @Removal

		SELECT @RemovalBy = Description
		FROM ERS_PolypRemovalTypes
		WHERE UniqueId = @RemovalMethod

		SELECT @PolypCondition = dbo.fnStringToSentance(@PolypCondition)

		DECLARE @IsHyperplastic BIT = (SELECT 1 FROM ERS_CommonAbnoPolypConditions cc
				INNER JOIN ERS_PolypConditions pd on cc.PolypConditionId = pd.UniqueId
			WHERE PolypDetailId = @PolypDetailId AND [Description] = 'Hyperplastic')

		IF @Quantity > 1 SET @summary = @summary + '<br/>Polyp ' + convert(varchar(10), @Count) + '- '
		IF ISNULL(@PolypCondition,'') <> '' OR ISNULL(@IsHyperPlastic,0) = 1
		BEGIN
		 SET @summary = @summary + CASE WHEN ISNULL(@IsHyperPlastic,0) = 1 THEN 'Hyperplastic ' ELSE '' END +  CASE WHEN ISNULL(@PolypCondition,'') <> '' THEN 'with' + @PolypCondition ELSE '' END + ': ' --ELSE SET @summary = @summary + '<br/>'
		END

		IF @PolypType = 'sessile'
			BEGIN
				IF @Probably = 1 SET @summary = @summary + 'probably '

				SET @summary = @summary + ' ' + @TumourType + ' '

				IF (@Quantity > 0 AND @Size > 0) 
				BEGIN
					SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @Size) + 'mm) '
				END
			END

			------------------------------------------------------------------------------------------
			-------	PEDUNCULATED -------
			------------------------------------------------------------------------------------------
			ELSE IF @PolypType = 'pedunculated'
			BEGIN
				--IF @Quantity > 0 SET @summary = @summary + CONVERT(VARCHAR(20), @Quantity) + ' '
		
				IF @Probably = 1 SET @summary = @summary + 'probably '

				IF @TumourTypeId = 1 SET @summary = @summary + 'benign '
				ELSE IF @TumourTypeId = 2 SET @summary = @summary + 'malignant '

				IF @ParisClass = 2 
					SET @summary = @summary + 'sub pedunculated ' 
				--ELSE
				--	SET @summary = @summary + 'polyp ' 

				IF (@Quantity > 0 AND @Size > 0) 
				BEGIN
					SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @Size) + 'mm) '
				END
			END

			------------------------------------------------------------------------------------------
			-------	PSEUDOPOLYPS -------
			------------------------------------------------------------------------------------------
			ELSE IF @PolypType = 'pseudo'
			BEGIN
				--IF @Quantity > 0 SET @summary = @summary + CONVERT(VARCHAR(20), @Quantity) + ' '

				IF @Inflam = 1 AND @PostInflam = 0 SET @summary = @summary + 'inflammatory '
				ELSE IF @Inflam = 0 AND @PostInflam = 1 SET @summary = @summary + 'post-inflammatory '
				ELSE IF @Inflam = 1 AND @PostInflam = 1 SET @summary = @summary + 'inflammatory and post-inflammatory '
		
				--SET @summary = @summary + 'pseudopolyp ' 

				IF (@Quantity > 0 AND @Size > 0) 
				BEGIN
					SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @Size) + 'mm) '
				END
			END
			------------------------------------------------------------------------------------------
			-------	SUBMUCOSAL -------
			------------------------------------------------------------------------------------------
			ELSE IF @PolypType = 'submucosal'
			BEGIN
				IF (@Quantity > 0 AND @Size > 0) 
				BEGIN
					SET @summary = @summary + '(' + CONVERT(VARCHAR(20), @Size) + 'mm) '
				END


				-- Set the last occurence of $$ to "and"
				IF CHARINDEX('$$', @summary) > 0 SET @summary = STUFF(@summary, len(@summary) - charindex('$$', reverse(@summary)), 3, ' and')
				-- Replace all other occurences of $$ with commas
				SET @summary = REPLACE(@summary, '$$', ',')
			END

			IF ISNULL(@Tattooed,'no') <> 'no'
			BEGIN
				SET @summary = @summary + '. Polyp ' + CASE WHEN @Tattooed = 'yes' THEN 'tattooed' ELSE ISNULL(@Tattooed, 'previously tattooed') END + CASE WHEN ISNULL(@TattooMarkingType,'') <> '' THEN ' using ' + @TattooMarkingType ELSE '' END
			END

			IF @ParisClass > 0 OR @PitPattern > 0
				BEGIN
					SET @summary = @summary + '('

					IF @ParisClass > 0 
					SET @summary = @summary +
							 CASE @ParisClass
								   WHEN  1 THEN 'Paris Is'
								   WHEN  2 THEN 'Paris IIa'
								   WHEN  3 THEN 'Paris IIa + IIc'
								   WHEN  4 THEN 'Paris IIb'
								   WHEN  5 THEN 'Paris IIc'
								   WHEN  6 THEN 'Paris IIc + IIa'
								   WHEN  7 THEN 'Paris Ip'
								   WHEN  8 THEN 'Paris Isp'
								   WHEN  10 THEN 'Paris LST-G'
								   WHEN  11 THEN 'Paris LST-NG'
								   WHEN  12 THEN 'Paris LST-D'
								   WHEN  13 THEN 'Paris LST-M'
								   ELSE ''
					END

					IF @PitPattern > 0 
					BEGIN
						IF @ParisClass > 0 SET @summary = @summary + ', '
				
						SET @summary = @summary +
								   CASE @PitPattern
										  WHEN  1 THEN 'pit type I'
										  WHEN  2 THEN 'pit type II'
										  WHEN  3 THEN 'pit type IIIs'
										  WHEN  4 THEN 'pit type IIIL'
										  WHEN  5 THEN 'pit type IV'
										  WHEN  6 THEN 'pit type V'
							ELSE ''
						END
					END

					SET @summary = @summary + ')'
				END

				IF @Excised = 1 
				BEGIN
					SET @summary = @summary + '$$ '
					SET @summary = @summary + 'excised '

					IF @Removal > 0 OR @RemovalMethod > 0
					BEGIN
						SET @summary = @summary + '(removed '
				
						IF @Removal > 0 SET @summary = @summary + @RemovalBy + ' '
						IF @RemovalMethod > 0 SET @summary = @summary + @RemovalType
						
						SET @summary = @summary + ')'
					END
				END

				IF @Retrieved = 1 
				BEGIN
					SET @summary = @summary + '$$ '
					SET @summary = @summary + 'retrieved '
				END

				IF @ToLabs = 1  
				BEGIN
					SET @summary = @summary + '$$ '
					SET @summary = @summary + 'sent to labs '
				END

				-- Set the last occurence of $$ to "and"
				IF CHARINDEX('$$', @summary) > 0 SET @summary = STUFF(@summary, len(@summary) - charindex('$$', reverse(@summary)), 3, ' and ')
				-- Replace all other occurences of $$ with commas
				SET @summary = REPLACE(@summary, '$$', ',')

		SET @Count = @Count + 1
		FETCH NEXT FROM cur INTO @PolypDetailId, @Size, @Excised, @Retrieved, @ToLabs, @Removal, @RemovalMethod, @Probably, @TumourTypeId, @ParisClass, @PitPattern, @Inflam, @PostInflam, @TattooedId, @TattooMarkingTypeId

	END

	CLOSE cur
	DEALLOCATE cur

	RETURN @summary + '##'
END

GO





